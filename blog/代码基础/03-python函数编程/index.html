<!doctype html><html lang=zh-cn class=h-full><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-XXXXXXX")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XXXXXXXXXX")</script><title>代码基础第3讲：Python函数编程 | 烧烤量化</title>
<meta name=description content="深入学习Python函数编程的高级特性，包含函数定义、参数传递、lambda函数、装饰器、生成器等，构建可复用的量化分析函数库"><meta name=author content="Ryan"><meta name=robots content="index, follow"><meta property="og:title" content="代码基础第3讲：Python函数编程 | 烧烤量化"><meta property="og:description" content="深入学习Python函数编程的高级特性，包含函数定义、参数传递、lambda函数、装饰器、生成器等，构建可复用的量化分析函数库"><meta property="og:type" content="article"><meta property="og:url" content="https://sk-quant.github.io/blog/%E4%BB%A3%E7%A0%81%E5%9F%BA%E7%A1%80/03-python%E5%87%BD%E6%95%B0%E7%BC%96%E7%A8%8B/"><meta property="og:site_name" content="烧烤量化"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="代码基础第3讲：Python函数编程 | 烧烤量化"><meta name=twitter:description content="深入学习Python函数编程的高级特性，包含函数定义、参数传递、lambda函数、装饰器、生成器等，构建可复用的量化分析函数库"><link rel=icon type=image/x-icon href=/images/favicon.ico><link rel=canonical href=https://sk-quant.github.io/blog/%E4%BB%A3%E7%A0%81%E5%9F%BA%E7%A1%80/03-python%E5%87%BD%E6%95%B0%E7%BC%96%E7%A8%8B/><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel=stylesheet><link rel=stylesheet href="/css/main.min.9a3c970d7feebe1317992d10ced98f226635b831a963ee601e5901734ff0da21.css"></head><body class="min-h-screen flex flex-col"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-XXXXXXX" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class="fixed top-0 left-0 right-0 z-50"><div class=mobile-menu-wrapper><input type=checkbox id=nav-toggle class=nav-toggle><header class="fixed w-full top-0 z-50 bg-white/80 backdrop-blur-sm border-b border-gray-100"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><nav class="flex items-center justify-between h-20"><a href=https://sk-quant.github.io/ class="flex items-center space-x-4"><img src=/images/logo.svg alt=烧烤量化 class=h-12>
<span class="text-3xl font-semibold text-gray-800">烧烤量化</span></a><div class="hidden md:flex items-center space-x-8"><a href=/path class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">学习路线</a><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化基础<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">回测平台</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化进阶<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">综合实战</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化高手<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股指期货</a></div></div></div><a href=/pricing class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">服务套餐</a></div><div class="hidden md:flex items-center space-x-4"><a href=/contact class="inline-flex items-center justify-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div><div class=md:hidden><label for=nav-toggle class="p-2 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-offset-2 transition-colors cursor-pointer"><svg class="w-6 h-6" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></label></div></nav></div><div class="nav-content md:hidden w-full fixed left-0 right-0 top-20 bg-white border-t border-gray-100 shadow-lg"><div class="w-full px-6 py-4"><a href=/path class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">学习路线</a><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化基础</div><div class=pl-4><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block text-gray-700 hover:text-primary-600 py-2">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block text-gray-700 hover:text-primary-600 py-2">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block text-gray-700 hover:text-primary-600 py-2">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block text-gray-700 hover:text-primary-600 py-2">回测平台</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化进阶</div><div class=pl-4><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block text-gray-700 hover:text-primary-600 py-2">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block text-gray-700 hover:text-primary-600 py-2">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block text-gray-700 hover:text-primary-600 py-2">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block text-gray-700 hover:text-primary-600 py-2">综合实战</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化高手</div><div class=pl-4><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block text-gray-700 hover:text-primary-600 py-2">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block text-gray-700 hover:text-primary-600 py-2">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block text-gray-700 hover:text-primary-600 py-2">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block text-gray-700 hover:text-primary-600 py-2">股指期货</a></div></div><a href=/pricing class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">服务套餐</a><div class="pt-4 space-y-4"><a href=/contact class="block text-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div></div></div></header><style>.mobile-menu-wrapper{position:relative}.nav-toggle{display:none}.nav-content{display:none}.nav-toggle:checked~header .nav-content{display:block}</style></div></div><div class=pt-20><div class="container mx-auto px-4 py-12"><div class="flex flex-col lg:flex-row gap-8 mb-12"><article class=flex-1><header class=mb-8><div class=mb-4><a href=/categories/%E4%BB%A3%E7%A0%81%E5%9F%BA%E7%A1%80 class="inline-block px-3 py-1 text-sm font-medium text-primary-600 bg-primary-50 rounded-full hover:bg-primary-100 mr-2">代码基础</a></div><h1 class="text-4xl font-bold mb-4">代码基础第3讲：Python函数编程</h1><div class="flex flex-col space-y-4"><div class="flex items-center justify-between text-sm text-gray-500"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7A4 4 0 118 7a4 4 0 018 0zm-4 7a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
<span>Ryan</span></div><div class="flex items-center space-x-6"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747.0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746.0-3.332.477-4.5 1.253"/></svg>
<span>35 分钟</span></div><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5A2 2 0 003 7v12a2 2 0 002 2z"/></svg>
<time datetime=2025-09-03>September 3, 2025</time></div></div></div><div class="flex items-center flex-wrap gap-2"><a href=/tags/2025 class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors duration-200">#2025</a></div></div></header><div class=mb-8><img src=/images/blog/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80.jpg alt=代码基础第3讲：Python函数编程 class="w-full h-auto rounded-lg" loading=lazy></div><div class="prose prose-lg max-w-none"><div class="bg-gray-50 p-6 rounded-lg mb-8"><h2 class="text-xl font-semibold mb-4">目录</h2><nav id=TableOfContents><ul><li><a href=#函数编程在量化交易中的重要性>函数编程在量化交易中的重要性</a></li><li><a href=#函数基础量化函数的构建块>函数基础：量化函数的构建块</a><ul><li><a href=#函数定义与调用>函数定义与调用</a></li><li><a href=#参数传递与默认值>参数传递与默认值</a></li><li><a href=#可变参数与量化应用>可变参数与量化应用</a></li></ul></li><li><a href=#高阶函数量化分析的函数式编程>高阶函数：量化分析的函数式编程</a><ul><li><a href=#map函数与批量数据处理>map函数与批量数据处理</a></li><li><a href=#filter函数与数据筛选>filter函数与数据筛选</a></li><li><a href=#reduce函数与累积计算>reduce函数与累积计算</a></li></ul></li><li><a href=#lambda函数快速定义量化逻辑>Lambda函数：快速定义量化逻辑</a><ul><li><a href=#lambda函数基础>Lambda函数基础</a></li><li><a href=#lambda在股票筛选中的应用>Lambda在股票筛选中的应用</a></li></ul></li><li><a href=#装饰器量化函数的增强器>装饰器：量化函数的增强器</a><ul><li><a href=#装饰器基础>装饰器基础</a></li><li><a href=#参数化装饰器>参数化装饰器</a></li></ul></li><li><a href=#生成器高效处理大规模数据>生成器：高效处理大规模数据</a><ul><li><a href=#生成器基础>生成器基础</a></li><li><a href=#生成器表达式与内存优化>生成器表达式与内存优化</a></li></ul></li><li><a href=#实践练习构建量化函数库>实践练习：构建量化函数库</a><ul><li><a href=#练习1技术指标函数库>练习1：技术指标函数库</a></li><li><a href=#练习2策略回测函数库>练习2：策略回测函数库</a></li></ul></li></ul></nav></div><h2 id=函数编程在量化交易中的重要性>函数编程在量化交易中的重要性</h2><p>函数是Python编程的核心概念，也是构建可维护、可复用量化交易系统的基石。在A股量化交易中，我们需要处理大量的数据分析、策略计算、风险管理等任务，这些任务往往具有相似的模式和逻辑。通过合理地设计和使用函数，我们可以将复杂的量化分析过程分解为可管理的小模块，提高代码的可读性、可维护性和复用性。</p><p>量化交易中的函数编程不仅仅是简单的代码封装，更涉及到高阶函数、函数式编程范式、装饰器模式等高级特性。这些特性使我们能够构建灵活的策略框架、高效的数据处理管道，以及优雅的性能监控和日志记录系统。例如，我们可以使用装饰器来自动记录策略执行时间，使用生成器来处理大规模的股票数据流，使用lambda函数来快速定义简单的技术指标计算逻辑。</p><p>本讲将系统介绍Python函数编程的核心概念和高级特性，通过丰富的量化交易实例，展示如何构建专业级的函数库和工具集。我们将从基础函数定义开始，逐步深入到高阶函数、装饰器、生成器等高级主题，最终构建一个完整的量化分析函数工具箱。</p><h2 id=函数基础量化函数的构建块>函数基础：量化函数的构建块</h2><h3 id=函数定义与调用>函数定义与调用</h3><p>在量化交易中，函数是我们封装分析逻辑的基本单元。让我们从最简单的函数开始：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_return</span><span class=p>(</span><span class=n>price_start</span><span class=p>,</span> <span class=n>price_end</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算股票收益率
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        price_start: 期初价格
</span></span></span><span class=line><span class=cl><span class=s2>        price_end: 期末价格
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        float: 收益率（小数形式）
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>price_start</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;起始价格必须大于0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>price_end</span> <span class=o>-</span> <span class=n>price_start</span><span class=p>)</span> <span class=o>/</span> <span class=n>price_start</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用函数</span>
</span></span><span class=line><span class=cl><span class=n>ping_an_start</span> <span class=o>=</span> <span class=mf>15.68</span>
</span></span><span class=line><span class=cl><span class=n>ping_an_end</span> <span class=o>=</span> <span class=mf>16.20</span>
</span></span><span class=line><span class=cl><span class=n>return_rate</span> <span class=o>=</span> <span class=n>calculate_return</span><span class=p>(</span><span class=n>ping_an_start</span><span class=p>,</span> <span class=n>ping_an_end</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;平安银行收益率: </span><span class=si>{</span><span class=n>return_rate</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>  <span class=c1># 输出: 平安银行收益率: 3.32%</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=参数传递与默认值>参数传递与默认值</h3><p>量化函数通常需要处理多种参数情况，合理使用默认参数可以提高函数的灵活性：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_moving_average</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=n>window</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s2>&#34;simple&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算移动平均
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        prices: 价格列表
</span></span></span><span class=line><span class=cl><span class=s2>        window: 移动窗口大小，默认5
</span></span></span><span class=line><span class=cl><span class=s2>        method: 计算方法，&#34;simple&#34;或&#34;exponential&#34;，默认&#34;simple&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        list: 移动平均值列表
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>method</span> <span class=o>==</span> <span class=s2>&#34;simple&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 简单移动平均</span>
</span></span><span class=line><span class=cl>        <span class=n>ma</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>window</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>ma_value</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>prices</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>window</span><span class=o>+</span><span class=mi>1</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=n>window</span>
</span></span><span class=line><span class=cl>            <span class=n>ma</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ma_value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ma</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s2>&#34;exponential&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 指数移动平均</span>
</span></span><span class=line><span class=cl>        <span class=n>alpha</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>/</span> <span class=p>(</span><span class=n>window</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ema</span> <span class=o>=</span> <span class=p>[</span><span class=n>prices</span><span class=p>[</span><span class=mi>0</span><span class=p>]]</span>  <span class=c1># 初始值</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>ema_value</span> <span class=o>=</span> <span class=n>alpha</span> <span class=o>*</span> <span class=n>prices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>alpha</span><span class=p>)</span> <span class=o>*</span> <span class=n>ema</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>ema</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ema_value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ema</span><span class=p>[</span><span class=n>window</span><span class=o>-</span><span class=mi>1</span><span class=p>:]</span>  <span class=c1># 返回从第window个开始的值</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;method参数必须是&#39;simple&#39;或&#39;exponential&#39;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试不同参数</span>
</span></span><span class=line><span class=cl><span class=n>prices</span> <span class=o>=</span> <span class=p>[</span><span class=mf>15.68</span><span class=p>,</span> <span class=mf>15.89</span><span class=p>,</span> <span class=mf>15.45</span><span class=p>,</span> <span class=mf>16.20</span><span class=p>,</span> <span class=mf>16.35</span><span class=p>,</span> <span class=mf>16.12</span><span class=p>,</span> <span class=mf>16.48</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 默认参数（5日简单移动平均）</span>
</span></span><span class=line><span class=cl><span class=n>ma5_simple</span> <span class=o>=</span> <span class=n>calculate_moving_average</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;5日简单移动平均: </span><span class=si>{</span><span class=n>ma5_simple</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 指定窗口大小</span>
</span></span><span class=line><span class=cl><span class=n>ma10_simple</span> <span class=o>=</span> <span class=n>calculate_moving_average</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=n>window</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;10日移动平均: </span><span class=si>{</span><span class=n>ma10_simple</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用指数移动平均</span>
</span></span><span class=line><span class=cl><span class=n>ma5_ema</span> <span class=o>=</span> <span class=n>calculate_moving_average</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s2>&#34;exponential&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;5日指数移动平均: </span><span class=si>{</span><span class=n>ma5_ema</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=可变参数与量化应用>可变参数与量化应用</h3><p>在量化分析中，我们经常需要处理不定数量的参数，*args和**kwargs提供了强大的灵活性：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_portfolio_return</span><span class=p>(</span><span class=o>*</span><span class=n>stock_returns</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算投资组合收益率
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        *stock_returns: 可变数量的股票收益率
</span></span></span><span class=line><span class=cl><span class=s2>        **kwargs: 关键字参数，可包含weights（权重列表）
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        float: 组合收益率
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>stock_returns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>weights</span> <span class=o>=</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;weights&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>weights</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 等权重</span>
</span></span><span class=line><span class=cl>        <span class=n>weights</span> <span class=o>=</span> <span class=p>[</span><span class=mf>1.0</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>stock_returns</span><span class=p>)]</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>stock_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 归一化权重</span>
</span></span><span class=line><span class=cl>        <span class=n>total_weight</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>weights</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>weights</span> <span class=o>=</span> <span class=p>[</span><span class=n>w</span> <span class=o>/</span> <span class=n>total_weight</span> <span class=k>for</span> <span class=n>w</span> <span class=ow>in</span> <span class=n>weights</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算加权收益率</span>
</span></span><span class=line><span class=cl>    <span class=n>portfolio_return</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>return_rate</span> <span class=o>*</span> <span class=n>weight</span> 
</span></span><span class=line><span class=cl>                          <span class=k>for</span> <span class=n>return_rate</span><span class=p>,</span> <span class=n>weight</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>stock_returns</span><span class=p>,</span> <span class=n>weights</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>portfolio_return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 不同调用方式</span>
</span></span><span class=line><span class=cl><span class=n>return1</span> <span class=o>=</span> <span class=mf>0.025</span>  <span class=c1># 2.5%</span>
</span></span><span class=line><span class=cl><span class=n>return2</span> <span class=o>=</span> <span class=o>-</span><span class=mf>0.012</span>  <span class=c1># -1.2%</span>
</span></span><span class=line><span class=cl><span class=n>return3</span> <span class=o>=</span> <span class=mf>0.038</span>  <span class=c1># 3.8%</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 等权重组合</span>
</span></span><span class=line><span class=cl><span class=n>portfolio_return1</span> <span class=o>=</span> <span class=n>calculate_portfolio_return</span><span class=p>(</span><span class=n>return1</span><span class=p>,</span> <span class=n>return2</span><span class=p>,</span> <span class=n>return3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;等权重组合收益率: </span><span class=si>{</span><span class=n>portfolio_return1</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 指定权重组合</span>
</span></span><span class=line><span class=cl><span class=n>weights</span> <span class=o>=</span> <span class=p>[</span><span class=mf>0.4</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>portfolio_return2</span> <span class=o>=</span> <span class=n>calculate_portfolio_return</span><span class=p>(</span><span class=n>return1</span><span class=p>,</span> <span class=n>return2</span><span class=p>,</span> <span class=n>return3</span><span class=p>,</span> <span class=n>weights</span><span class=o>=</span><span class=n>weights</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;加权组合收益率: </span><span class=si>{</span><span class=n>portfolio_return2</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=高阶函数量化分析的函数式编程>高阶函数：量化分析的函数式编程</h2><h3 id=map函数与批量数据处理>map函数与批量数据处理</h3><p>map函数可以对数据进行批量转换，在量化分析中非常有用：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>normalize_price</span><span class=p>(</span><span class=n>price</span><span class=p>,</span> <span class=n>base_price</span><span class=o>=</span><span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;价格标准化处理&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>price</span> <span class=o>/</span> <span class=n>base_price</span><span class=p>)</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_log_return</span><span class=p>(</span><span class=n>price_current</span><span class=p>,</span> <span class=n>price_previous</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算对数收益率&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>math</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>math</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>price_current</span> <span class=o>/</span> <span class=n>price_previous</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 股票价格数据</span>
</span></span><span class=line><span class=cl><span class=n>stock_prices</span> <span class=o>=</span> <span class=p>[</span><span class=mf>15.68</span><span class=p>,</span> <span class=mf>15.89</span><span class=p>,</span> <span class=mf>15.45</span><span class=p>,</span> <span class=mf>16.20</span><span class=p>,</span> <span class=mf>16.35</span><span class=p>,</span> <span class=mf>16.12</span><span class=p>,</span> <span class=mf>16.48</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用map进行价格标准化</span>
</span></span><span class=line><span class=cl><span class=n>base_price</span> <span class=o>=</span> <span class=n>stock_prices</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>normalized_prices</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>normalize_price</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>base_price</span><span class=p>),</span> <span class=n>stock_prices</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;标准化价格: </span><span class=si>{</span><span class=n>normalized_prices</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用map计算对数收益率</span>
</span></span><span class=line><span class=cl><span class=n>log_returns</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=n>calculate_log_return</span><span class=p>,</span> <span class=n>stock_prices</span><span class=p>[</span><span class=mi>1</span><span class=p>:],</span> <span class=n>stock_prices</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;对数收益率: </span><span class=si>{</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>r</span><span class=si>:</span><span class=s1>.4f</span><span class=si>}</span><span class=s1>&#39;</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>log_returns</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 更复杂的map应用：多股票收益率计算</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_returns_for_stock</span><span class=p>(</span><span class=n>prices</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算单只股票的所有日收益率&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>:</span> <span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>y</span><span class=p>)</span> <span class=o>/</span> <span class=n>y</span><span class=p>,</span> <span class=n>prices</span><span class=p>[</span><span class=mi>1</span><span class=p>:],</span> <span class=n>prices</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 多股票价格数据</span>
</span></span><span class=line><span class=cl><span class=n>multi_stock_prices</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;000001.SZ&#34;</span><span class=p>:</span> <span class=p>[</span><span class=mf>15.68</span><span class=p>,</span> <span class=mf>15.89</span><span class=p>,</span> <span class=mf>15.45</span><span class=p>,</span> <span class=mf>16.20</span><span class=p>,</span> <span class=mf>16.35</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;000002.SZ&#34;</span><span class=p>:</span> <span class=p>[</span><span class=mf>23.45</span><span class=p>,</span> <span class=mf>23.89</span><span class=p>,</span> <span class=mf>23.12</span><span class=p>,</span> <span class=mf>24.20</span><span class=p>,</span> <span class=mf>24.35</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;600000.SH&#34;</span><span class=p>:</span> <span class=p>[</span><span class=mf>18.92</span><span class=p>,</span> <span class=mf>19.20</span><span class=p>,</span> <span class=mf>18.75</span><span class=p>,</span> <span class=mf>19.45</span><span class=p>,</span> <span class=mf>19.68</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 批量计算所有股票的收益率</span>
</span></span><span class=line><span class=cl><span class=n>stock_returns</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>code</span><span class=p>:</span> <span class=n>calculate_returns_for_stock</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>code</span><span class=p>,</span> <span class=n>prices</span> <span class=ow>in</span> <span class=n>multi_stock_prices</span><span class=o>.</span><span class=n>items</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>code</span><span class=p>,</span> <span class=n>returns</span> <span class=ow>in</span> <span class=n>stock_returns</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>code</span><span class=si>}</span><span class=s2> 收益率: </span><span class=si>{</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>r</span><span class=si>:</span><span class=s1>.2%</span><span class=si>}</span><span class=s1>&#39;</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>returns</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=filter函数与数据筛选>filter函数与数据筛选</h3><p>filter函数在股票筛选中非常有用：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>is_high_volume</span><span class=p>(</span><span class=n>volume</span><span class=p>,</span> <span class=n>threshold</span><span class=o>=</span><span class=mi>100000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;判断是否为高成交量&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>volume</span> <span class=o>&gt;</span> <span class=n>threshold</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>is_price_increase</span><span class=p>(</span><span class=n>return_rate</span><span class=p>,</span> <span class=n>threshold</span><span class=o>=</span><span class=mf>0.02</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;判断是否为显著上涨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>return_rate</span> <span class=o>&gt;</span> <span class=n>threshold</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>has_strong_momentum</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;判断是否有强势动能&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>period</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>recent_prices</span> <span class=o>=</span> <span class=n>prices</span><span class=p>[</span><span class=o>-</span><span class=n>period</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>all</span><span class=p>(</span><span class=n>recent_prices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>recent_prices</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>period</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 股票数据</span>
</span></span><span class=line><span class=cl><span class=n>stock_data</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=s2>&#34;000001.SZ&#34;</span><span class=p>,</span> <span class=s2>&#34;price&#34;</span><span class=p>:</span> <span class=mf>15.68</span><span class=p>,</span> <span class=s2>&#34;volume&#34;</span><span class=p>:</span> <span class=mi>125000</span><span class=p>,</span> <span class=s2>&#34;return&#34;</span><span class=p>:</span> <span class=mf>0.025</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=s2>&#34;000002.SZ&#34;</span><span class=p>,</span> <span class=s2>&#34;price&#34;</span><span class=p>:</span> <span class=mf>23.45</span><span class=p>,</span> <span class=s2>&#34;volume&#34;</span><span class=p>:</span> <span class=mi>89000</span><span class=p>,</span> <span class=s2>&#34;return&#34;</span><span class=p>:</span> <span class=o>-</span><span class=mf>0.012</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=s2>&#34;600000.SH&#34;</span><span class=p>,</span> <span class=s2>&#34;price&#34;</span><span class=p>:</span> <span class=mf>18.92</span><span class=p>,</span> <span class=s2>&#34;volume&#34;</span><span class=p>:</span> <span class=mi>156000</span><span class=p>,</span> <span class=s2>&#34;return&#34;</span><span class=p>:</span> <span class=mf>0.038</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=s2>&#34;600036.SH&#34;</span><span class=p>,</span> <span class=s2>&#34;price&#34;</span><span class=p>:</span> <span class=mf>42.15</span><span class=p>,</span> <span class=s2>&#34;volume&#34;</span><span class=p>:</span> <span class=mi>201000</span><span class=p>,</span> <span class=s2>&#34;return&#34;</span><span class=p>:</span> <span class=mf>0.015</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 筛选高成交量股票</span>
</span></span><span class=line><span class=cl><span class=n>high_volume_stocks</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>filter</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>is_high_volume</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=s2>&#34;volume&#34;</span><span class=p>]),</span> <span class=n>stock_data</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;高成交量股票:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>high_volume_stocks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>stock</span><span class=p>[</span><span class=s1>&#39;code&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>: 成交量</span><span class=si>{</span><span class=n>stock</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 筛选上涨股票</span>
</span></span><span class=line><span class=cl><span class=n>rising_stocks</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>filter</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>is_price_increase</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=s2>&#34;return&#34;</span><span class=p>]),</span> <span class=n>stock_data</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>上涨股票: </span><span class=si>{</span><span class=p>[</span><span class=n>s</span><span class=p>[</span><span class=s1>&#39;code&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>rising_stocks</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 复合筛选：高成交量且上涨的股票</span>
</span></span><span class=line><span class=cl><span class=n>strong_stocks</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>filter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>is_high_volume</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=s2>&#34;volume&#34;</span><span class=p>])</span> <span class=ow>and</span> <span class=n>is_price_increase</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=s2>&#34;return&#34;</span><span class=p>]),</span> 
</span></span><span class=line><span class=cl>    <span class=n>stock_data</span>
</span></span><span class=line><span class=cl><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;强势股票: </span><span class=si>{</span><span class=p>[</span><span class=n>s</span><span class=p>[</span><span class=s1>&#39;code&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>strong_stocks</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=reduce函数与累积计算>reduce函数与累积计算</h3><p>reduce函数在累积计算中特别有用，如计算累积收益率：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>reduce</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_cumulative_return</span><span class=p>(</span><span class=n>returns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算累积收益率&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># (1 + r1) * (1 + r2) * ... * (1 + rn) - 1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>reduce</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>:</span> <span class=n>x</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>y</span><span class=p>),</span> <span class=n>returns</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_max_drawdown</span><span class=p>(</span><span class=n>prices</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算最大回撤&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>prices</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>max_price</span> <span class=o>=</span> <span class=n>prices</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>max_drawdown</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>price</span> <span class=ow>in</span> <span class=n>prices</span><span class=p>[</span><span class=mi>1</span><span class=p>:]:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>price</span> <span class=o>&gt;</span> <span class=n>max_price</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>max_price</span> <span class=o>=</span> <span class=n>price</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>drawdown</span> <span class=o>=</span> <span class=p>(</span><span class=n>max_price</span> <span class=o>-</span> <span class=n>price</span><span class=p>)</span> <span class=o>/</span> <span class=n>max_price</span>
</span></span><span class=line><span class=cl>            <span class=n>max_drawdown</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>max_drawdown</span><span class=p>,</span> <span class=n>drawdown</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>max_drawdown</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_sharpe_ratio</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>risk_free_rate</span><span class=o>=</span><span class=mf>0.03</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算夏普比率&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>returns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>avg_return</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>variance</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>((</span><span class=n>r</span> <span class=o>-</span> <span class=n>avg_return</span><span class=p>)</span> <span class=o>**</span> <span class=mi>2</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>returns</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>std_dev</span> <span class=o>=</span> <span class=n>variance</span> <span class=o>**</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>std_dev</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>avg_return</span> <span class=o>-</span> <span class=n>risk_free_rate</span><span class=p>)</span> <span class=o>/</span> <span class=n>std_dev</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试数据</span>
</span></span><span class=line><span class=cl><span class=n>returns</span> <span class=o>=</span> <span class=p>[</span><span class=mf>0.025</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.012</span><span class=p>,</span> <span class=mf>0.038</span><span class=p>,</span> <span class=mf>0.015</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.008</span><span class=p>,</span> <span class=mf>0.022</span><span class=p>,</span> <span class=mf>0.031</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>prices</span> <span class=o>=</span> <span class=p>[</span><span class=mi>100</span><span class=p>,</span> <span class=mf>102.5</span><span class=p>,</span> <span class=mf>101.27</span><span class=p>,</span> <span class=mf>105.12</span><span class=p>,</span> <span class=mf>106.7</span><span class=p>,</span> <span class=mf>105.85</span><span class=p>,</span> <span class=mf>108.18</span><span class=p>,</span> <span class=mf>111.53</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 累积收益率</span>
</span></span><span class=line><span class=cl><span class=n>cum_return</span> <span class=o>=</span> <span class=n>calculate_cumulative_return</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;累积收益率: </span><span class=si>{</span><span class=n>cum_return</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 最大回撤</span>
</span></span><span class=line><span class=cl><span class=n>max_dd</span> <span class=o>=</span> <span class=n>calculate_max_drawdown</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最大回撤: </span><span class=si>{</span><span class=n>max_dd</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 夏普比率</span>
</span></span><span class=line><span class=cl><span class=n>sharpe</span> <span class=o>=</span> <span class=n>calculate_sharpe_ratio</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;夏普比率: </span><span class=si>{</span><span class=n>sharpe</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=lambda函数快速定义量化逻辑>Lambda函数：快速定义量化逻辑</h2><h3 id=lambda函数基础>Lambda函数基础</h3><p>Lambda函数允许我们快速定义简单的函数，在量化分析中非常实用：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 简单的价格转换</span>
</span></span><span class=line><span class=cl><span class=n>prices</span> <span class=o>=</span> <span class=p>[</span><span class=mf>15.68</span><span class=p>,</span> <span class=mf>15.89</span><span class=p>,</span> <span class=mf>15.45</span><span class=p>,</span> <span class=mf>16.20</span><span class=p>,</span> <span class=mf>16.35</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 价格转换为整数（向下取整）</span>
</span></span><span class=line><span class=cl><span class=n>int_prices</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=p>),</span> <span class=n>prices</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;整数价格: </span><span class=si>{</span><span class=n>int_prices</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 价格四舍五入</span>
</span></span><span class=line><span class=cl><span class=n>rounded_prices</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=nb>round</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=n>prices</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;四舍五入价格: </span><span class=si>{</span><span class=n>rounded_prices</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 计算价格变化率</span>
</span></span><span class=line><span class=cl><span class=n>price_changes</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>:</span> <span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>y</span><span class=p>)</span> <span class=o>/</span> <span class=n>y</span> <span class=o>*</span> <span class=mi>100</span><span class=p>,</span> <span class=n>prices</span><span class=p>[</span><span class=mi>1</span><span class=p>:],</span> <span class=n>prices</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;价格变化率: </span><span class=si>{</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>c</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>%&#39;</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>price_changes</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=lambda在股票筛选中的应用>Lambda在股票筛选中的应用</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 股票数据列表</span>
</span></span><span class=line><span class=cl><span class=n>stocks</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=s2>&#34;000001.SZ&#34;</span><span class=p>,</span> <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;平安银行&#34;</span><span class=p>,</span> <span class=s2>&#34;price&#34;</span><span class=p>:</span> <span class=mf>15.68</span><span class=p>,</span> <span class=s2>&#34;pe&#34;</span><span class=p>:</span> <span class=mf>8.5</span><span class=p>,</span> <span class=s2>&#34;volume&#34;</span><span class=p>:</span> <span class=mi>125000</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=s2>&#34;000002.SZ&#34;</span><span class=p>,</span> <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;万科A&#34;</span><span class=p>,</span> <span class=s2>&#34;price&#34;</span><span class=p>:</span> <span class=mf>23.45</span><span class=p>,</span> <span class=s2>&#34;pe&#34;</span><span class=p>:</span> <span class=mf>12.3</span><span class=p>,</span> <span class=s2>&#34;volume&#34;</span><span class=p>:</span> <span class=mi>89000</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=s2>&#34;600000.SH&#34;</span><span class=p>,</span> <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;浦发银行&#34;</span><span class=p>,</span> <span class=s2>&#34;price&#34;</span><span class=p>:</span> <span class=mf>18.92</span><span class=p>,</span> <span class=s2>&#34;pe&#34;</span><span class=p>:</span> <span class=mf>7.8</span><span class=p>,</span> <span class=s2>&#34;volume&#34;</span><span class=p>:</span> <span class=mi>156000</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=s2>&#34;600036.SH&#34;</span><span class=p>,</span> <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;招商银行&#34;</span><span class=p>,</span> <span class=s2>&#34;price&#34;</span><span class=p>:</span> <span class=mf>42.15</span><span class=p>,</span> <span class=s2>&#34;pe&#34;</span><span class=p>:</span> <span class=mf>9.2</span><span class=p>,</span> <span class=s2>&#34;volume&#34;</span><span class=p>:</span> <span class=mi>201000</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用lambda进行多条件筛选</span>
</span></span><span class=line><span class=cl><span class=c1># 筛选低市盈率且高成交量的股票</span>
</span></span><span class=line><span class=cl><span class=n>low_pe_high_volume</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>filter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=s2>&#34;pe&#34;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>10</span> <span class=ow>and</span> <span class=n>x</span><span class=p>[</span><span class=s2>&#34;volume&#34;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>100000</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>stocks</span>
</span></span><span class=line><span class=cl><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;低市盈率高成交量股票:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>low_pe_high_volume</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>stock</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>(</span><span class=si>{</span><span class=n>stock</span><span class=p>[</span><span class=s1>&#39;code&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>): PE=</span><span class=si>{</span><span class=n>stock</span><span class=p>[</span><span class=s1>&#39;pe&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>, 成交量=</span><span class=si>{</span><span class=n>stock</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 按价格排序</span>
</span></span><span class=line><span class=cl><span class=n>sorted_by_price</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>stocks</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=s2>&#34;price&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>按价格排序: </span><span class=si>{</span><span class=p>[</span><span class=n>s</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>sorted_by_price</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 按市盈率排序（从低到高）</span>
</span></span><span class=line><span class=cl><span class=n>sorted_by_pe</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>stocks</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=s2>&#34;pe&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;按市盈率排序: </span><span class=si>{</span><span class=p>[</span><span class=n>s</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>sorted_by_pe</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取最高价和最低价股票</span>
</span></span><span class=line><span class=cl><span class=n>highest_price</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>stocks</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=s2>&#34;price&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>lowest_price</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>stocks</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=s2>&#34;price&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最高价股票: </span><span class=si>{</span><span class=n>highest_price</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> - ¥</span><span class=si>{</span><span class=n>highest_price</span><span class=p>[</span><span class=s1>&#39;price&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最低价股票: </span><span class=si>{</span><span class=n>lowest_price</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> - ¥</span><span class=si>{</span><span class=n>lowest_price</span><span class=p>[</span><span class=s1>&#39;price&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=装饰器量化函数的增强器>装饰器：量化函数的增强器</h2><h3 id=装饰器基础>装饰器基础</h3><p>装饰器是Python的强大特性，可以用来增强函数的功能而不修改函数本身：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>functools</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>timing_decorator</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算函数执行时间的装饰器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nd>@functools.wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>end_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2> 执行时间: </span><span class=si>{</span><span class=n>end_time</span> <span class=o>-</span> <span class=n>start_time</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>秒&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>logging_decorator</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;记录函数调用信息的装饰器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nd>@functools.wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;调用函数: </span><span class=si>{</span><span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;参数: args=</span><span class=si>{</span><span class=n>args</span><span class=si>}</span><span class=s2>, kwargs=</span><span class=si>{</span><span class=n>kwargs</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;返回结果: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>cache_decorator</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;简单的缓存装饰器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>cache</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@functools.wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>args</span> <span class=ow>in</span> <span class=n>cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;从缓存获取: </span><span class=si>{</span><span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}{</span><span class=n>args</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>cache</span><span class=p>[</span><span class=n>args</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cache</span><span class=p>[</span><span class=n>args</span><span class=p>]</span> <span class=o>=</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 应用装饰器</span>
</span></span><span class=line><span class=cl><span class=nd>@timing_decorator</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_volatility</span><span class=p>(</span><span class=n>prices</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算价格波动率&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>returns</span> <span class=o>=</span> <span class=p>[(</span><span class=n>prices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>prices</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=n>prices</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>))]</span>
</span></span><span class=line><span class=cl>    <span class=n>avg_return</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>variance</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>((</span><span class=n>r</span> <span class=o>-</span> <span class=n>avg_return</span><span class=p>)</span> <span class=o>**</span> <span class=mi>2</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>returns</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>variance</span> <span class=o>**</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@logging_decorator</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_beta</span><span class=p>(</span><span class=n>stock_returns</span><span class=p>,</span> <span class=n>market_returns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算贝塔系数&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>stock_returns</span><span class=p>)</span> <span class=o>!=</span> <span class=nb>len</span><span class=p>(</span><span class=n>market_returns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;收益率序列长度必须相同&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算协方差和方差</span>
</span></span><span class=line><span class=cl>    <span class=n>avg_stock</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>stock_returns</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>stock_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>avg_market</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>market_returns</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>market_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>covariance</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>((</span><span class=n>s</span> <span class=o>-</span> <span class=n>avg_stock</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=n>m</span> <span class=o>-</span> <span class=n>avg_market</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>                     <span class=k>for</span> <span class=n>s</span><span class=p>,</span> <span class=n>m</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>stock_returns</span><span class=p>,</span> <span class=n>market_returns</span><span class=p>))</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>stock_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>market_variance</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>((</span><span class=n>m</span> <span class=o>-</span> <span class=n>avg_market</span><span class=p>)</span> <span class=o>**</span> <span class=mi>2</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>market_returns</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>market_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>covariance</span> <span class=o>/</span> <span class=n>market_variance</span> <span class=k>if</span> <span class=n>market_variance</span> <span class=o>!=</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@cache_decorator</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_fibonacci</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算斐波那契数列（用于演示缓存）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>n</span> <span class=o>&lt;=</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>calculate_fibonacci</span><span class=p>(</span><span class=n>n</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=n>calculate_fibonacci</span><span class=p>(</span><span class=n>n</span><span class=o>-</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试装饰器功能</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 测试波动率计算 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prices</span> <span class=o>=</span> <span class=p>[</span><span class=mf>15.68</span><span class=p>,</span> <span class=mf>15.89</span><span class=p>,</span> <span class=mf>15.45</span><span class=p>,</span> <span class=mf>16.20</span><span class=p>,</span> <span class=mf>16.35</span><span class=p>,</span> <span class=mf>16.12</span><span class=p>,</span> <span class=mf>16.48</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>volatility</span> <span class=o>=</span> <span class=n>calculate_volatility</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;波动率: </span><span class=si>{</span><span class=n>volatility</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 测试贝塔系数计算 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>stock_returns</span> <span class=o>=</span> <span class=p>[</span><span class=mf>0.025</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.012</span><span class=p>,</span> <span class=mf>0.038</span><span class=p>,</span> <span class=mf>0.015</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.008</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>market_returns</span> <span class=o>=</span> <span class=p>[</span><span class=mf>0.020</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.015</span><span class=p>,</span> <span class=mf>0.030</span><span class=p>,</span> <span class=mf>0.018</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.005</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>beta</span> <span class=o>=</span> <span class=n>calculate_beta</span><span class=p>(</span><span class=n>stock_returns</span><span class=p>,</span> <span class=n>market_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;贝塔系数: </span><span class=si>{</span><span class=n>beta</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 测试缓存功能 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;斐波那契数列第10项: </span><span class=si>{</span><span class=n>calculate_fibonacci</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;斐波那契数列第10项（再次调用）: </span><span class=si>{</span><span class=n>calculate_fibonacci</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=参数化装饰器>参数化装饰器</h3><p>更高级的装饰器可以接受参数，提供更大的灵活性：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>retry_decorator</span><span class=p>(</span><span class=n>max_attempts</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>delay</span><span class=o>=</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;重试装饰器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>decorator</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nd>@functools.wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>attempt</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_attempts</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>attempt</span> <span class=o>&lt;</span> <span class=n>max_attempts</span> <span class=o>-</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;尝试 </span><span class=si>{</span><span class=n>attempt</span> <span class=o>+</span> <span class=mi>1</span><span class=si>}</span><span class=s2> 失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>，</span><span class=si>{</span><span class=n>delay</span><span class=si>}</span><span class=s2>秒后重试...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>delay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;所有尝试均失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=k>raise</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>decorator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>validate_decorator</span><span class=p>(</span><span class=o>*</span><span class=n>arg_types</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs_types</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;参数类型验证装饰器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>decorator</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nd>@functools.wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 验证位置参数</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=p>(</span><span class=n>arg</span><span class=p>,</span> <span class=n>expected_type</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>args</span><span class=p>,</span> <span class=n>arg_types</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>arg</span><span class=p>,</span> <span class=n>expected_type</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=k>raise</span> <span class=ne>TypeError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;参数</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>类型错误，期望</span><span class=si>{</span><span class=n>expected_type</span><span class=si>}</span><span class=s2>，得到</span><span class=si>{</span><span class=nb>type</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 验证关键字参数</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>kwargs_types</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>expected_type</span> <span class=o>=</span> <span class=n>kwargs_types</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>expected_type</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=k>raise</span> <span class=ne>TypeError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;参数</span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s2>类型错误，期望</span><span class=si>{</span><span class=n>expected_type</span><span class=si>}</span><span class=s2>，得到</span><span class=si>{</span><span class=nb>type</span><span class=p>(</span><span class=n>value</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>decorator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 应用参数化装饰器</span>
</span></span><span class=line><span class=cl><span class=nd>@retry_decorator</span><span class=p>(</span><span class=n>max_attempts</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>delay</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fetch_stock_data</span><span class=p>(</span><span class=n>stock_code</span><span class=p>,</span> <span class=n>start_date</span><span class=p>,</span> <span class=n>end_date</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;获取股票数据（模拟网络请求）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 模拟网络不稳定</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>random</span><span class=o>.</span><span class=n>random</span><span class=p>()</span> <span class=o>&lt;</span> <span class=mf>0.7</span><span class=p>:</span>  <span class=c1># 70%概率失败</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ConnectionError</span><span class=p>(</span><span class=s2>&#34;网络连接失败&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 模拟返回数据</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=n>stock_code</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;data&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>50</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>)],</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;数据获取成功&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@validate_decorator</span><span class=p>(</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>analyze_stock</span><span class=p>(</span><span class=n>code</span><span class=p>,</span> <span class=n>start_date</span><span class=p>,</span> <span class=n>end_date</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;分析股票（带参数验证）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;分析股票 </span><span class=si>{</span><span class=n>code</span><span class=si>}</span><span class=s2> 从 </span><span class=si>{</span><span class=n>start_date</span><span class=si>}</span><span class=s2> 到 </span><span class=si>{</span><span class=n>end_date</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试参数化装饰器</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 测试重试装饰器 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>fetch_stock_data</span><span class=p>(</span><span class=s2>&#34;000001.SZ&#34;</span><span class=p>,</span> <span class=s2>&#34;2025-09-01&#34;</span><span class=p>,</span> <span class=s2>&#34;2025-09-05&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;数据获取成功: </span><span class=si>{</span><span class=n>data</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最终失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 测试参数验证装饰器 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>analyze_stock</span><span class=p>(</span><span class=s2>&#34;000001.SZ&#34;</span><span class=p>,</span> <span class=s2>&#34;2025-09-01&#34;</span><span class=p>,</span> <span class=s2>&#34;2025-09-05&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 测试类型错误</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>analyze_stock</span><span class=p>(</span><span class=mi>123</span><span class=p>,</span> <span class=s2>&#34;2025-09-01&#34;</span><span class=p>,</span> <span class=s2>&#34;2025-09-05&#34;</span><span class=p>)</span>  <span class=c1># 应该抛出类型错误</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>TypeError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;类型验证错误: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=生成器高效处理大规模数据>生成器：高效处理大规模数据</h2><h3 id=生成器基础>生成器基础</h3><p>生成器提供了一种高效处理大规模数据的方式，特别适合处理股票数据流：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>price_generator</span><span class=p>(</span><span class=n>start_price</span><span class=p>,</span> <span class=n>volatility</span><span class=o>=</span><span class=mf>0.02</span><span class=p>,</span> <span class=n>count</span><span class=o>=</span><span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;生成模拟股票价格序列&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>price</span> <span class=o>=</span> <span class=n>start_price</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 随机价格变动</span>
</span></span><span class=line><span class=cl>        <span class=n>change</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>gauss</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>volatility</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>price</span> <span class=o>=</span> <span class=n>price</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>change</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=nb>max</span><span class=p>(</span><span class=n>price</span><span class=p>,</span> <span class=mf>0.01</span><span class=p>)</span>  <span class=c1># 确保价格不为负</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>stock_data_generator</span><span class=p>(</span><span class=n>stock_codes</span><span class=p>,</span> <span class=n>days</span><span class=o>=</span><span class=mi>252</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;生成多股票数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>start_date</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span> <span class=o>-</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=n>days</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>code</span> <span class=ow>in</span> <span class=n>stock_codes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>base_price</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>day</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>days</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>current_date</span> <span class=o>=</span> <span class=n>start_date</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=n>day</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 生成价格（简单的随机游走）</span>
</span></span><span class=line><span class=cl>            <span class=n>price_change</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>gauss</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mf>0.02</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>current_price</span> <span class=o>=</span> <span class=n>base_price</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>price_change</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 生成其他数据</span>
</span></span><span class=line><span class=cl>            <span class=n>volume</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>50000</span><span class=p>,</span> <span class=mi>500000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>high</span> <span class=o>=</span> <span class=n>current_price</span> <span class=o>*</span> <span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>1.00</span><span class=p>,</span> <span class=mf>1.05</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>low</span> <span class=o>=</span> <span class=n>current_price</span> <span class=o>*</span> <span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.95</span><span class=p>,</span> <span class=mf>1.00</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>open_price</span> <span class=o>=</span> <span class=n>current_price</span> <span class=o>*</span> <span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.98</span><span class=p>,</span> <span class=mf>1.02</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=n>code</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;date&#34;</span><span class=p>:</span> <span class=n>current_date</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&#34;%Y-%m-</span><span class=si>%d</span><span class=s2>&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;open&#34;</span><span class=p>:</span> <span class=nb>round</span><span class=p>(</span><span class=n>open_price</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;high&#34;</span><span class=p>:</span> <span class=nb>round</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;low&#34;</span><span class=p>:</span> <span class=nb>round</span><span class=p>(</span><span class=n>low</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;close&#34;</span><span class=p>:</span> <span class=nb>round</span><span class=p>(</span><span class=n>current_price</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;volume&#34;</span><span class=p>:</span> <span class=n>volume</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>base_price</span> <span class=o>=</span> <span class=n>current_price</span>  <span class=c1># 更新基准价格</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用生成器</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 价格生成器测试 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>price_gen</span> <span class=o>=</span> <span class=n>price_generator</span><span class=p>(</span><span class=mi>50</span><span class=p>,</span> <span class=n>volatility</span><span class=o>=</span><span class=mf>0.01</span><span class=p>,</span> <span class=n>count</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>price</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>price_gen</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;第</span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>天价格: ¥</span><span class=si>{</span><span class=n>price</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 股票数据生成器测试 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>stock_codes</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;000001.SZ&#34;</span><span class=p>,</span> <span class=s2>&#34;000002.SZ&#34;</span><span class=p>,</span> <span class=s2>&#34;600000.SH&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>stock_gen</span> <span class=o>=</span> <span class=n>stock_data_generator</span><span class=p>(</span><span class=n>stock_codes</span><span class=p>,</span> <span class=n>days</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>data</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>stock_gen</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=mi>6</span><span class=p>:</span>  <span class=c1># 只显示前6条数据</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;code&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;date&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>: 开盘</span><span class=si>{</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>, 收盘</span><span class=si>{</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>, 交易量</span><span class=si>{</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=生成器表达式与内存优化>生成器表达式与内存优化</h3><p>生成器表达式提供了一种内存高效的数据处理方式：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_large_stock_data</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;处理大规模股票数据的示例&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 模拟大规模数据</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_large_dataset</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成大规模数据集&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1000000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;stock_</span><span class=si>{</span><span class=n>i</span> <span class=o>%</span> <span class=mi>1000</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;price&#34;</span><span class=p>:</span> <span class=mi>10</span> <span class=o>+</span> <span class=p>(</span><span class=n>i</span> <span class=o>%</span> <span class=mi>100</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;volume&#34;</span><span class=p>:</span> <span class=mi>100000</span> <span class=o>+</span> <span class=n>i</span> <span class=o>%</span> <span class=mi>50000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;return&#34;</span><span class=p>:</span> <span class=p>(</span><span class=n>i</span> <span class=o>%</span> <span class=mi>20</span> <span class=o>-</span> <span class=mi>10</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.001</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 使用生成器表达式进行内存高效的计算</span>
</span></span><span class=line><span class=cl>    <span class=n>data_gen</span> <span class=o>=</span> <span class=n>generate_large_dataset</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算平均价格（不需要存储所有数据）</span>
</span></span><span class=line><span class=cl>    <span class=n>price_sum</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>data</span> <span class=ow>in</span> <span class=n>data_gen</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>price_sum</span> <span class=o>+=</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;price&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>count</span> <span class=o>&gt;=</span> <span class=mi>10000</span><span class=p>:</span>  <span class=c1># 处理前10000条数据</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>avg_price</span> <span class=o>=</span> <span class=n>price_sum</span> <span class=o>/</span> <span class=n>count</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;平均价格: </span><span class=si>{</span><span class=n>avg_price</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 使用生成器表达式进行筛选</span>
</span></span><span class=line><span class=cl>    <span class=n>data_gen</span> <span class=o>=</span> <span class=n>generate_large_dataset</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 筛选高收益率股票（不创建中间列表）</span>
</span></span><span class=line><span class=cl>    <span class=n>high_return_stocks</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=k>for</span> <span class=n>data</span> <span class=ow>in</span> <span class=n>data_gen</span> 
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;return&#34;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mf>0.005</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算筛选后的平均值</span>
</span></span><span class=line><span class=cl>    <span class=n>filtered_prices</span> <span class=o>=</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;price&#34;</span><span class=p>]</span> <span class=k>for</span> <span class=n>data</span> <span class=ow>in</span> <span class=n>high_return_stocks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 只取前100个</span>
</span></span><span class=line><span class=cl>    <span class=n>first_100_prices</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>price</span> <span class=ow>in</span> <span class=n>filtered_prices</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>first_100_prices</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>price</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>first_100_prices</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>100</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>first_100_prices</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>avg_filtered_price</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>first_100_prices</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>first_100_prices</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;高收益率股票的平均价格: </span><span class=si>{</span><span class=n>avg_filtered_price</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;没有找到符合条件的数据&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>efficient_data_processing</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;高效数据处理示例&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 模拟股票数据</span>
</span></span><span class=line><span class=cl>    <span class=n>stock_data</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;stock_</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;price&#34;</span><span class=p>:</span> <span class=mi>20</span> <span class=o>+</span> <span class=n>i</span> <span class=o>*</span> <span class=mf>0.1</span><span class=p>,</span> <span class=s2>&#34;volume&#34;</span><span class=p>:</span> <span class=mi>100000</span> <span class=o>+</span> <span class=n>i</span> <span class=o>*</span> <span class=mi>100</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 传统方法（创建中间列表）</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>traditional_method</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 多步处理，每步都创建新列表</span>
</span></span><span class=line><span class=cl>        <span class=n>high_volume</span> <span class=o>=</span> <span class=p>[</span><span class=n>d</span> <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=n>stock_data</span> <span class=k>if</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;volume&#34;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>150000</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>high_price</span> <span class=o>=</span> <span class=p>[</span><span class=n>d</span> <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=n>high_volume</span> <span class=k>if</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;price&#34;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>50</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=p>[</span><span class=n>d</span><span class=p>[</span><span class=s2>&#34;code&#34;</span><span class=p>]</span> <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=n>high_price</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>end_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=p>,</span> <span class=n>end_time</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 生成器方法（内存高效）</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generator_method</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 使用生成器表达式，不创建中间列表</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>d</span><span class=p>[</span><span class=s2>&#34;code&#34;</span><span class=p>]</span> <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=n>stock_data</span> 
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;volume&#34;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>150000</span> <span class=ow>and</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;price&#34;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>50</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 转换为列表以便比较</span>
</span></span><span class=line><span class=cl>        <span class=n>result_list</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>end_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result_list</span><span class=p>,</span> <span class=n>end_time</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 比较两种方法</span>
</span></span><span class=line><span class=cl>    <span class=n>trad_result</span><span class=p>,</span> <span class=n>trad_time</span> <span class=o>=</span> <span class=n>traditional_method</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gen_result</span><span class=p>,</span> <span class=n>gen_time</span> <span class=o>=</span> <span class=n>generator_method</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;传统方法结果数量: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>trad_result</span><span class=p>)</span><span class=si>}</span><span class=s2>, 时间: </span><span class=si>{</span><span class=n>trad_time</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>秒&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;生成器方法结果数量: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>gen_result</span><span class=p>)</span><span class=si>}</span><span class=s2>, 时间: </span><span class=si>{</span><span class=n>gen_time</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>秒&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;结果一致性: </span><span class=si>{</span><span class=n>trad_result</span> <span class=o>==</span> <span class=n>gen_result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行示例</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 大规模数据处理测试 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>process_large_stock_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 效率对比测试 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>efficient_data_processing</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=实践练习构建量化函数库>实践练习：构建量化函数库</h2><h3 id=练习1技术指标函数库>练习1：技术指标函数库</h3><p>创建一个完整的技术指标计算函数库：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># technical_indicators.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>math</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>reduce</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Union</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TechnicalIndicators</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;技术指标计算函数库&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>sma</span><span class=p>(</span><span class=n>prices</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>],</span> <span class=n>period</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;简单移动平均&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>period</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=nb>sum</span><span class=p>(</span><span class=n>prices</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>period</span><span class=p>:</span><span class=n>i</span><span class=p>])</span> <span class=o>/</span> <span class=n>period</span> 
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>period</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>ema</span><span class=p>(</span><span class=n>prices</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>],</span> <span class=n>period</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;指数移动平均&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>period</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>alpha</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>/</span> <span class=p>(</span><span class=n>period</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ema_values</span> <span class=o>=</span> <span class=p>[</span><span class=nb>sum</span><span class=p>(</span><span class=n>prices</span><span class=p>[:</span><span class=n>period</span><span class=p>])</span> <span class=o>/</span> <span class=n>period</span><span class=p>]</span>  <span class=c1># 初始值</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>price</span> <span class=ow>in</span> <span class=n>prices</span><span class=p>[</span><span class=n>period</span><span class=p>:]:</span>
</span></span><span class=line><span class=cl>            <span class=n>ema_values</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>alpha</span> <span class=o>*</span> <span class=n>price</span> <span class=o>+</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>alpha</span><span class=p>)</span> <span class=o>*</span> <span class=n>ema_values</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ema_values</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>rsi</span><span class=p>(</span><span class=n>prices</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>],</span> <span class=n>period</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>14</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;相对强弱指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>period</span> <span class=o>+</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算价格变化</span>
</span></span><span class=line><span class=cl>        <span class=n>changes</span> <span class=o>=</span> <span class=p>[</span><span class=n>prices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>prices</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>))]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>rsi_values</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 初始RSI计算</span>
</span></span><span class=line><span class=cl>        <span class=n>gains</span> <span class=o>=</span> <span class=p>[</span><span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>change</span><span class=p>)</span> <span class=k>for</span> <span class=n>change</span> <span class=ow>in</span> <span class=n>changes</span><span class=p>[:</span><span class=n>period</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>        <span class=n>losses</span> <span class=o>=</span> <span class=p>[</span><span class=nb>abs</span><span class=p>(</span><span class=nb>min</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>change</span><span class=p>))</span> <span class=k>for</span> <span class=n>change</span> <span class=ow>in</span> <span class=n>changes</span><span class=p>[:</span><span class=n>period</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>avg_gain</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>gains</span><span class=p>)</span> <span class=o>/</span> <span class=n>period</span>
</span></span><span class=line><span class=cl>        <span class=n>avg_loss</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>losses</span><span class=p>)</span> <span class=o>/</span> <span class=n>period</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>avg_loss</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>rsi_values</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>rs</span> <span class=o>=</span> <span class=n>avg_gain</span> <span class=o>/</span> <span class=n>avg_loss</span>
</span></span><span class=line><span class=cl>            <span class=n>rsi_values</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>100</span> <span class=o>-</span> <span class=p>(</span><span class=mi>100</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>rs</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 后续RSI计算（使用平滑方法）</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>period</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>changes</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>gain</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>changes</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>loss</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=nb>min</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>changes</span><span class=p>[</span><span class=n>i</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>avg_gain</span> <span class=o>=</span> <span class=p>(</span><span class=n>avg_gain</span> <span class=o>*</span> <span class=p>(</span><span class=n>period</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=n>gain</span><span class=p>)</span> <span class=o>/</span> <span class=n>period</span>
</span></span><span class=line><span class=cl>            <span class=n>avg_loss</span> <span class=o>=</span> <span class=p>(</span><span class=n>avg_loss</span> <span class=o>*</span> <span class=p>(</span><span class=n>period</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=n>loss</span><span class=p>)</span> <span class=o>/</span> <span class=n>period</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>avg_loss</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>rsi_values</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>rs</span> <span class=o>=</span> <span class=n>avg_gain</span> <span class=o>/</span> <span class=n>avg_loss</span>
</span></span><span class=line><span class=cl>                <span class=n>rsi_values</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>100</span> <span class=o>-</span> <span class=p>(</span><span class=mi>100</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>rs</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>rsi_values</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>macd</span><span class=p>(</span><span class=n>prices</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>],</span> <span class=n>fast</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>12</span><span class=p>,</span> <span class=n>slow</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>26</span><span class=p>,</span> <span class=n>signal</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>9</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;MACD指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>slow</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;macd&#34;</span><span class=p>:</span> <span class=p>[],</span> <span class=s2>&#34;signal&#34;</span><span class=p>:</span> <span class=p>[],</span> <span class=s2>&#34;histogram&#34;</span><span class=p>:</span> <span class=p>[]}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算EMA</span>
</span></span><span class=line><span class=cl>        <span class=n>fast_ema</span> <span class=o>=</span> <span class=n>TechnicalIndicators</span><span class=o>.</span><span class=n>ema</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=n>fast</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>slow_ema</span> <span class=o>=</span> <span class=n>TechnicalIndicators</span><span class=o>.</span><span class=n>ema</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=n>slow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 确保两个EMA序列长度相同</span>
</span></span><span class=line><span class=cl>        <span class=n>min_len</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>fast_ema</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>slow_ema</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>fast_ema</span> <span class=o>=</span> <span class=n>fast_ema</span><span class=p>[</span><span class=o>-</span><span class=n>min_len</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>        <span class=n>slow_ema</span> <span class=o>=</span> <span class=n>slow_ema</span><span class=p>[</span><span class=o>-</span><span class=n>min_len</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算MACD线</span>
</span></span><span class=line><span class=cl>        <span class=n>macd_line</span> <span class=o>=</span> <span class=p>[</span><span class=n>fast</span> <span class=o>-</span> <span class=n>slow</span> <span class=k>for</span> <span class=n>fast</span><span class=p>,</span> <span class=n>slow</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>fast_ema</span><span class=p>,</span> <span class=n>slow_ema</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算信号线</span>
</span></span><span class=line><span class=cl>        <span class=n>signal_line</span> <span class=o>=</span> <span class=n>TechnicalIndicators</span><span class=o>.</span><span class=n>ema</span><span class=p>(</span><span class=n>macd_line</span><span class=p>,</span> <span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算柱状图</span>
</span></span><span class=line><span class=cl>        <span class=n>histogram</span> <span class=o>=</span> <span class=p>[</span><span class=n>macd</span> <span class=o>-</span> <span class=n>sig</span> <span class=k>for</span> <span class=n>macd</span><span class=p>,</span> <span class=n>sig</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>macd_line</span><span class=p>[</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>signal_line</span><span class=p>):],</span> <span class=n>signal_line</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;macd&#34;</span><span class=p>:</span> <span class=n>macd_line</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;signal&#34;</span><span class=p>:</span> <span class=n>signal_line</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;histogram&#34;</span><span class=p>:</span> <span class=n>histogram</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>bollinger_bands</span><span class=p>(</span><span class=n>prices</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>],</span> <span class=n>period</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>20</span><span class=p>,</span> <span class=n>std_dev</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>2</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;布林带&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>period</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;upper&#34;</span><span class=p>:</span> <span class=p>[],</span> <span class=s2>&#34;middle&#34;</span><span class=p>:</span> <span class=p>[],</span> <span class=s2>&#34;lower&#34;</span><span class=p>:</span> <span class=p>[]}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算中轨（SMA）</span>
</span></span><span class=line><span class=cl>        <span class=n>middle</span> <span class=o>=</span> <span class=n>TechnicalIndicators</span><span class=o>.</span><span class=n>sma</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=n>period</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算标准差</span>
</span></span><span class=line><span class=cl>        <span class=n>upper</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>lower</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>period</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>period_prices</span> <span class=o>=</span> <span class=n>prices</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>period</span><span class=o>+</span><span class=mi>1</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>mean_price</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>period_prices</span><span class=p>)</span> <span class=o>/</span> <span class=n>period</span>
</span></span><span class=line><span class=cl>            <span class=n>variance</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>((</span><span class=n>p</span> <span class=o>-</span> <span class=n>mean_price</span><span class=p>)</span> <span class=o>**</span> <span class=mi>2</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>period_prices</span><span class=p>)</span> <span class=o>/</span> <span class=n>period</span>
</span></span><span class=line><span class=cl>            <span class=n>std</span> <span class=o>=</span> <span class=n>math</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>variance</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>upper</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>mean_price</span> <span class=o>+</span> <span class=n>std_dev</span> <span class=o>*</span> <span class=n>std</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>lower</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>mean_price</span> <span class=o>-</span> <span class=n>std_dev</span> <span class=o>*</span> <span class=n>std</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;upper&#34;</span><span class=p>:</span> <span class=n>upper</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;middle&#34;</span><span class=p>:</span> <span class=n>middle</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;lower&#34;</span><span class=p>:</span> <span class=n>lower</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_indicators</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;测试技术指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 测试数据</span>
</span></span><span class=line><span class=cl>    <span class=n>prices</span> <span class=o>=</span> <span class=p>[</span><span class=mf>15.68</span><span class=p>,</span> <span class=mf>15.89</span><span class=p>,</span> <span class=mf>15.45</span><span class=p>,</span> <span class=mf>16.20</span><span class=p>,</span> <span class=mf>16.35</span><span class=p>,</span> <span class=mf>16.12</span><span class=p>,</span> <span class=mf>16.48</span><span class=p>,</span> <span class=mf>16.25</span><span class=p>,</span> <span class=mf>16.67</span><span class=p>,</span> <span class=mf>16.89</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 技术指标测试 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 简单移动平均</span>
</span></span><span class=line><span class=cl>    <span class=n>sma5</span> <span class=o>=</span> <span class=n>TechnicalIndicators</span><span class=o>.</span><span class=n>sma</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;5日SMA: </span><span class=si>{</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>x</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>&#39;</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>sma5</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 指数移动平均</span>
</span></span><span class=line><span class=cl>    <span class=n>ema5</span> <span class=o>=</span> <span class=n>TechnicalIndicators</span><span class=o>.</span><span class=n>ema</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;5日EMA: </span><span class=si>{</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>x</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>&#39;</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>ema5</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># RSI</span>
</span></span><span class=line><span class=cl>    <span class=n>rsi</span> <span class=o>=</span> <span class=n>TechnicalIndicators</span><span class=o>.</span><span class=n>rsi</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;RSI(5): </span><span class=si>{</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>x</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>&#39;</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>rsi</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># MACD</span>
</span></span><span class=line><span class=cl>    <span class=n>macd_result</span> <span class=o>=</span> <span class=n>TechnicalIndicators</span><span class=o>.</span><span class=n>macd</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=n>fast</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>slow</span><span class=o>=</span><span class=mi>6</span><span class=p>,</span> <span class=n>signal</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;MACD: </span><span class=si>{</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>x</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>&#39;</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>macd_result</span><span class=p>[</span><span class=s1>&#39;macd&#39;</span><span class=p>]]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Signal: </span><span class=si>{</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>x</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>&#39;</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>macd_result</span><span class=p>[</span><span class=s1>&#39;signal&#39;</span><span class=p>]]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 布林带</span>
</span></span><span class=line><span class=cl>    <span class=n>bb</span> <span class=o>=</span> <span class=n>TechnicalIndicators</span><span class=o>.</span><span class=n>bollinger_bands</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;布林带Upper: </span><span class=si>{</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>x</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>&#39;</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>bb</span><span class=p>[</span><span class=s1>&#39;upper&#39;</span><span class=p>]]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;布林带Middle: </span><span class=si>{</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>x</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>&#39;</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>bb</span><span class=p>[</span><span class=s1>&#39;middle&#39;</span><span class=p>]]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;布林带Lower: </span><span class=si>{</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>x</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>&#39;</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>bb</span><span class=p>[</span><span class=s1>&#39;lower&#39;</span><span class=p>]]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>test_indicators</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=练习2策略回测函数库>练习2：策略回测函数库</h3><p>创建一个策略回测函数库：&lt;|tool_calls_section_begin|>&lt;|tool_call_begin|>functions.write_to_file:3&lt;|tool_call_argument_begin|>{&ldquo;file_path&rdquo;:"/Users/ruanyangyang/Desktop/sk-quant/hugo/sk-quant-protal/content/blog/代码基础/03-Python函数编程-策略回测.md",&ldquo;rewrite&rdquo;:true,&ldquo;explanation&rdquo;:&ldquo;创建策略回测函数库，包含回测引擎、性能评估、风险管理等功能&rdquo;,&ldquo;content&rdquo;:</p></div></article><aside class="lg:w-80 xl:w-96"><div class=space-y-8></div></aside></div><nav class="border-t border-gray-200 mt-12 pt-8"><div class="flex justify-between items-center"><a href=/blog/%E6%8A%95%E8%B5%84%E7%90%86%E8%AE%BA/%E5%AE%8F%E8%A7%82%E5%88%86%E6%9E%90/03-%E7%89%A9%E4%BB%B7%E5%AF%B9%E8%82%A1%E5%B8%82%E7%9A%84%E5%BD%B1%E5%93%8D/ class="group flex items-center"><svg class="w-5 h-5 mr-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0 7-7m-7 7h18"/></svg><div><div class="text-sm text-gray-600">上一篇</div><div class="font-medium group-hover:text-primary-600">宏观分析第3讲：物价对股市的影响</div></div></a><a href=/blog/%E6%8A%95%E8%B5%84%E7%90%86%E8%AE%BA/%E5%AE%8F%E8%A7%82%E5%88%86%E6%9E%90/04-%E6%B1%87%E7%8E%87%E5%AF%B9%E8%82%A1%E5%B8%82%E7%9A%84%E5%BD%B1%E5%93%8D/ class="group flex items-center text-right"><div><div class="text-sm text-gray-600">Next Post</div><div class="font-medium group-hover:text-primary-600">宏观分析第4讲：汇率对股市的影响机制</div></div><svg class="w-5 h-5 ml-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0-7 7m7-7H3"/></svg></a></div></nav></div></div><footer class="bg-gray-50 py-12 border-t border-gray-200"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><div class="flex flex-col md:flex-row justify-between space-y-4 md:space-y-0"><div class=flex-1><div class="flex items-center space-x-3 mb-4"><a href=https://sk-quant.github.io/ class=inline-block><img src=/images/logo.svg alt=烧烤量化 class=h-6>
</a><span class="text-xl font-bold text-gray-900">烧烤量化</span></div><div class="flex space-x-3 p-2"></div></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div></div><div class="mt-12 pt-8 border-t border-gray-200"><div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0"><p class="text-gray-600 text-sm">© 2025 烧烤量化. All rights reserved.</p><a href=https://chaoming.li class="text-sm text-gray-600 hover:text-primary-600" target=_blank rel="noopener noreferrer">Powered by sk-quant</a></div></div></div></footer><script>const mobileMenuButton=document.getElementById("mobile-menu-button");mobileMenuButton&&mobileMenuButton.addEventListener("click",function(){const e=document.getElementById("mobile-menu");e&&e.classList.toggle("hidden")})</script></body></html>