<!doctype html><html lang=zh-cn class=h-full><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-XXXXXXX")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XXXXXXXXXX")</script><title>代码基础第7讲：数据获取与处理 | 烧烤量化</title>
<meta name=description content="学习如何获取股票数据、进行数据预处理和特征工程，掌握数据清洗、标准化、特征提取等关键技能，为量化策略提供高质量的数据基础"><meta name=author content="Ryan"><meta name=robots content="index, follow"><meta property="og:title" content="代码基础第7讲：数据获取与处理 | 烧烤量化"><meta property="og:description" content="学习如何获取股票数据、进行数据预处理和特征工程，掌握数据清洗、标准化、特征提取等关键技能，为量化策略提供高质量的数据基础"><meta property="og:type" content="article"><meta property="og:url" content="https://sk-quant.github.io/blog/%E4%BB%A3%E7%A0%81%E5%9F%BA%E7%A1%80/07-%E6%95%B0%E6%8D%AE%E8%8E%B7%E5%8F%96%E4%B8%8E%E5%A4%84%E7%90%86/"><meta property="og:site_name" content="烧烤量化"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="代码基础第7讲：数据获取与处理 | 烧烤量化"><meta name=twitter:description content="学习如何获取股票数据、进行数据预处理和特征工程，掌握数据清洗、标准化、特征提取等关键技能，为量化策略提供高质量的数据基础"><link rel=icon type=image/x-icon href=/images/favicon.ico><link rel=canonical href=https://sk-quant.github.io/blog/%E4%BB%A3%E7%A0%81%E5%9F%BA%E7%A1%80/07-%E6%95%B0%E6%8D%AE%E8%8E%B7%E5%8F%96%E4%B8%8E%E5%A4%84%E7%90%86/><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel=stylesheet><link rel=stylesheet href="/css/main.min.1255c60f0805e580d846a005c9da456febfe5426dbcd39f66ba0ae2958126a2d.css"></head><body class="min-h-screen flex flex-col"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-XXXXXXX" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class="fixed top-0 left-0 right-0 z-50"><div class=mobile-menu-wrapper><input type=checkbox id=nav-toggle class=nav-toggle><header class="fixed w-full top-0 z-50 bg-white/80 backdrop-blur-sm border-b border-gray-100"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><nav class="flex items-center justify-between h-20"><a href=https://sk-quant.github.io/ class="flex items-center space-x-4"><img src=/images/logo.svg alt=烧烤量化 class=h-12>
<span class="text-3xl font-semibold text-gray-800">烧烤量化</span></a><div class="hidden md:flex items-center space-x-8"><a href=/path class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">学习路线</a><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化基础<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">回测平台</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化进阶<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">综合实战</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化高手<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股指期货</a></div></div></div><a href=/pricing class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">服务套餐</a></div><div class="hidden md:flex items-center space-x-4"><a href=/contact class="inline-flex items-center justify-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div><div class=md:hidden><label for=nav-toggle class="p-2 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-offset-2 transition-colors cursor-pointer"><svg class="w-6 h-6" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></label></div></nav></div><div class="nav-content md:hidden w-full fixed left-0 right-0 top-20 bg-white border-t border-gray-100 shadow-lg"><div class="w-full px-6 py-4"><a href=/path class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">学习路线</a><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化基础</div><div class=pl-4><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block text-gray-700 hover:text-primary-600 py-2">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block text-gray-700 hover:text-primary-600 py-2">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block text-gray-700 hover:text-primary-600 py-2">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block text-gray-700 hover:text-primary-600 py-2">回测平台</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化进阶</div><div class=pl-4><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block text-gray-700 hover:text-primary-600 py-2">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block text-gray-700 hover:text-primary-600 py-2">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block text-gray-700 hover:text-primary-600 py-2">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block text-gray-700 hover:text-primary-600 py-2">综合实战</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化高手</div><div class=pl-4><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block text-gray-700 hover:text-primary-600 py-2">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block text-gray-700 hover:text-primary-600 py-2">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block text-gray-700 hover:text-primary-600 py-2">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block text-gray-700 hover:text-primary-600 py-2">股指期货</a></div></div><a href=/pricing class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">服务套餐</a><div class="pt-4 space-y-4"><a href=/contact class="block text-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div></div></div></header><style>.mobile-menu-wrapper{position:relative}.nav-toggle{display:none}.nav-content{display:none}.nav-toggle:checked~header .nav-content{display:block}</style></div></div><div class=pt-20><div class="container mx-auto px-4 py-12"><div class="flex flex-col lg:flex-row gap-8 mb-12"><article class=flex-1><header class=mb-8><div class=mb-4><a href=/categories/%E4%BB%A3%E7%A0%81%E5%9F%BA%E7%A1%80 class="inline-block px-3 py-1 text-sm font-medium text-primary-600 bg-primary-50 rounded-full hover:bg-primary-100 mr-2">代码基础</a></div><h1 class="text-4xl font-bold mb-4">代码基础第7讲：数据获取与处理</h1><div class="flex flex-col space-y-4"><div class="flex items-center justify-between text-sm text-gray-500"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7A4 4 0 118 7a4 4 0 018 0zm-4 7a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
<span>Ryan</span></div><div class="flex items-center space-x-6"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747.0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746.0-3.332.477-4.5 1.253"/></svg>
<span>35 分钟</span></div><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5A2 2 0 003 7v12a2 2 0 002 2z"/></svg>
<time datetime=2025-09-07>September 7, 2025</time></div></div></div><div class="flex items-center flex-wrap gap-2"><a href=/tags/2025 class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors duration-200">#2025</a></div></div></header><div class=mb-8><img src=/images/blog/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80.jpg alt=代码基础第7讲：数据获取与处理 class="w-full h-auto rounded-lg" loading=lazy></div><div class="prose prose-lg max-w-none"><h1 id=代码基础第7讲数据获取与处理>代码基础第7讲：数据获取与处理</h1><h2 id=前言>前言</h2><p>数据是量化交易的基础，高质量的数据是构建有效策略的前提。本讲将介绍如何获取股票数据、进行数据预处理和特征工程。我们将学习从各种数据源获取数据，进行数据清洗、标准化、特征提取等操作，为后续的量化策略开发提供可靠的数据支撑。</p><h2 id=目录>目录</h2><ol><li><a href=#%E6%95%B0%E6%8D%AE%E6%BA%90%E4%BB%8B%E7%BB%8D>数据源介绍</a></li><li><a href=#%E6%95%B0%E6%8D%AE%E8%8E%B7%E5%8F%96%E6%96%B9%E6%B3%95>数据获取方法</a></li><li><a href=#%E6%95%B0%E6%8D%AE%E9%A2%84%E5%A4%84%E7%90%86>数据预处理</a></li><li><a href=#%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97%E4%B8%8E%E9%AA%8C%E8%AF%81>数据清洗与验证</a></li><li><a href=#%E7%89%B9%E5%BE%81%E5%B7%A5%E7%A8%8B>特征工程</a></li><li><a href=#%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E5%A4%84%E7%90%86>时间序列处理</a></li><li><a href=#%E6%95%B0%E6%8D%AE%E6%A0%87%E5%87%86%E5%8C%96%E4%B8%8E%E5%BD%92%E4%B8%80%E5%8C%96>数据标准化与归一化</a></li><li><a href=#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E4%B8%8E%E7%AE%A1%E7%90%86>数据存储与管理</a></li><li><a href=#%E9%87%8F%E5%8C%96%E4%BA%A4%E6%98%93%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86>量化交易中的数据处理</a></li><li><a href=#%E5%AE%9E%E8%B7%B5%E7%BB%83%E4%B9%A0>实践练习</a></li></ol><h2 id=数据源介绍>数据源介绍</h2><h3 id=常见股票数据源>常见股票数据源</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>yfinance</span> <span class=k>as</span> <span class=nn>yf</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. Yahoo Finance (免费，国际数据)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_yahoo_data</span><span class=p>(</span><span class=n>symbol</span><span class=p>,</span> <span class=n>start_date</span><span class=p>,</span> <span class=n>end_date</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;从Yahoo Finance获取数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ticker</span> <span class=o>=</span> <span class=n>yf</span><span class=o>.</span><span class=n>Ticker</span><span class=p>(</span><span class=n>symbol</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>ticker</span><span class=o>.</span><span class=n>history</span><span class=p>(</span><span class=n>start</span><span class=o>=</span><span class=n>start_date</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=n>end_date</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 重命名列以符合标准格式</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=n>columns</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Open&#39;</span><span class=p>:</span> <span class=s1>&#39;open&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;High&#39;</span><span class=p>:</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Low&#39;</span><span class=p>:</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Close&#39;</span><span class=p>:</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Volume&#39;</span><span class=p>:</span> <span class=s1>&#39;volume&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 添加股票代码</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>symbol</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;获取Yahoo数据失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试Yahoo Finance</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== Yahoo Finance数据获取测试 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>yahoo_data</span> <span class=o>=</span> <span class=n>get_yahoo_data</span><span class=p>(</span><span class=s2>&#34;AAPL&#34;</span><span class=p>,</span> <span class=s2>&#34;2023-01-01&#34;</span><span class=p>,</span> <span class=s2>&#34;2023-12-31&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=ow>not</span> <span class=n>yahoo_data</span><span class=o>.</span><span class=n>empty</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;获取到 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>yahoo_data</span><span class=p>)</span><span class=si>}</span><span class=s2> 条AAPL数据&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>yahoo_data</span><span class=o>.</span><span class=n>head</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;数据列: </span><span class=si>{</span><span class=n>yahoo_data</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. Tushare (免费，A股数据，需要注册获取token)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_tushare_data</span><span class=p>(</span><span class=n>symbol</span><span class=p>,</span> <span class=n>start_date</span><span class=p>,</span> <span class=n>end_date</span><span class=p>,</span> <span class=n>token</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;从Tushare获取A股数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>tushare</span> <span class=k>as</span> <span class=nn>ts</span>
</span></span><span class=line><span class=cl>        <span class=n>ts</span><span class=o>.</span><span class=n>set_token</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>pro</span> <span class=o>=</span> <span class=n>ts</span><span class=o>.</span><span class=n>pro_api</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 获取日线数据</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span> <span class=o>=</span> <span class=n>pro</span><span class=o>.</span><span class=n>daily</span><span class=p>(</span><span class=n>ts_code</span><span class=o>=</span><span class=n>symbol</span><span class=p>,</span> <span class=n>start_date</span><span class=o>=</span><span class=n>start_date</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;-&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>),</span> 
</span></span><span class=line><span class=cl>                      <span class=n>end_date</span><span class=o>=</span><span class=n>end_date</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;-&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>df</span><span class=o>.</span><span class=n>empty</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 转换日期格式</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=p>[</span><span class=s1>&#39;trade_date&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>to_datetime</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;trade_date&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>set_index</span><span class=p>(</span><span class=s1>&#39;trade_date&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>sort_index</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 重命名列</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=n>columns</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;open&#39;</span><span class=p>:</span> <span class=s1>&#39;open&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;high&#39;</span><span class=p>:</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=s1>&#39;low&#39;</span><span class=p>:</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;close&#39;</span><span class=p>:</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;vol&#39;</span><span class=p>:</span> <span class=s1>&#39;volume&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;amount&#39;</span><span class=p>:</span> <span class=s1>&#39;amount&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 添加股票代码</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>symbol</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 选择需要的列</span>
</span></span><span class=line><span class=cl>        <span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>,</span> <span class=s1>&#39;amount&#39;</span><span class=p>,</span> <span class=s1>&#39;symbol&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>df</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>ImportError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;未安装tushare，跳过Tushare数据获取&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;获取Tushare数据失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 模拟A股数据生成器（用于演示）</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_a_share_data</span><span class=p>(</span><span class=n>symbol</span><span class=p>,</span> <span class=n>start_date</span><span class=p>,</span> <span class=n>end_date</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;生成模拟A股数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=nb>hash</span><span class=p>(</span><span class=n>symbol</span><span class=p>)</span> <span class=o>%</span> <span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 生成日期序列</span>
</span></span><span class=line><span class=cl>    <span class=n>dates</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>date_range</span><span class=p>(</span><span class=n>start_date</span><span class=p>,</span> <span class=n>end_date</span><span class=p>,</span> <span class=n>freq</span><span class=o>=</span><span class=s1>&#39;D&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>dates</span> <span class=o>=</span> <span class=n>dates</span><span class=p>[</span><span class=n>dates</span><span class=o>.</span><span class=n>weekday</span> <span class=o>&lt;</span> <span class=mi>5</span><span class=p>]</span>  <span class=c1># 只保留工作日</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 生成价格数据</span>
</span></span><span class=line><span class=cl>    <span class=n>n_days</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>base_return</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randn</span><span class=p>(</span><span class=n>n_days</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.02</span> <span class=o>+</span> <span class=mf>0.0005</span>  <span class=c1># 基础收益率</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 生成OHLCV数据</span>
</span></span><span class=line><span class=cl>    <span class=n>close</span> <span class=o>=</span> <span class=mi>100</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>exp</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>cumsum</span><span class=p>(</span><span class=n>base_return</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>open_price</span> <span class=o>=</span> <span class=n>close</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randn</span><span class=p>(</span><span class=n>n_days</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.005</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>high</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>maximum</span><span class=p>(</span><span class=n>open_price</span><span class=p>,</span> <span class=n>close</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randn</span><span class=p>(</span><span class=n>n_days</span><span class=p>))</span> <span class=o>*</span> <span class=mf>0.01</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>low</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>minimum</span><span class=p>(</span><span class=n>open_price</span><span class=p>,</span> <span class=n>close</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randn</span><span class=p>(</span><span class=n>n_days</span><span class=p>))</span> <span class=o>*</span> <span class=mf>0.01</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>volume</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>100000</span><span class=p>,</span> <span class=mi>1000000</span><span class=p>,</span> <span class=n>n_days</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>amount</span> <span class=o>=</span> <span class=n>volume</span> <span class=o>*</span> <span class=n>close</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.9</span><span class=p>,</span> <span class=mf>1.1</span><span class=p>,</span> <span class=n>n_days</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 确保价格逻辑正确</span>
</span></span><span class=line><span class=cl>    <span class=n>high</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>maximum</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>maximum</span><span class=p>(</span><span class=n>open_price</span><span class=p>,</span> <span class=n>close</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>low</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>minimum</span><span class=p>(</span><span class=n>low</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>minimum</span><span class=p>(</span><span class=n>open_price</span><span class=p>,</span> <span class=n>close</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 创建DataFrame</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;open&#39;</span><span class=p>:</span> <span class=n>open_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;high&#39;</span><span class=p>:</span> <span class=n>high</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;low&#39;</span><span class=p>:</span> <span class=n>low</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;close&#39;</span><span class=p>:</span> <span class=n>close</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;volume&#39;</span><span class=p>:</span> <span class=n>volume</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;amount&#39;</span><span class=p>:</span> <span class=n>amount</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;symbol&#39;</span><span class=p>:</span> <span class=n>symbol</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=n>index</span><span class=o>=</span><span class=n>dates</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>df</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 生成模拟A股数据</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 模拟A股数据生成 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>a_share_data</span> <span class=o>=</span> <span class=n>generate_a_share_data</span><span class=p>(</span><span class=s2>&#34;000001.SZ&#34;</span><span class=p>,</span> <span class=s2>&#34;2023-01-01&#34;</span><span class=p>,</span> <span class=s2>&#34;2023-12-31&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;生成了 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>a_share_data</span><span class=p>)</span><span class=si>}</span><span class=s2> 条模拟A股数据&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>a_share_data</span><span class=o>.</span><span class=n>head</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=财务数据获取>财务数据获取</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_financial_data</span><span class=p>(</span><span class=n>symbol</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;获取财务数据（模拟）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 这里模拟获取财务数据的过程</span>
</span></span><span class=line><span class=cl>    <span class=n>financial_data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;symbol&#39;</span><span class=p>:</span> <span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;pe_ratio&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mi>30</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;pb_ratio&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>5</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;roe&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.05</span><span class=p>,</span> <span class=mf>0.25</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;debt_to_equity&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.2</span><span class=p>,</span> <span class=mf>1.5</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;current_ratio&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;quick_ratio&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.8</span><span class=p>,</span> <span class=mf>2.5</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;gross_margin&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.6</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;operating_margin&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;net_margin&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.05</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;revenue_growth&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=o>-</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;earnings_growth&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=o>-</span><span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.4</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;dividend_yield&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.05</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>([</span><span class=n>financial_data</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_market_data</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;获取市场数据（模拟）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 模拟市场指标数据</span>
</span></span><span class=line><span class=cl>    <span class=n>market_data</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>date_range</span><span class=p>(</span><span class=s1>&#39;2023-01-01&#39;</span><span class=p>,</span> <span class=n>periods</span><span class=o>=</span><span class=mi>252</span><span class=p>,</span> <span class=n>freq</span><span class=o>=</span><span class=s1>&#39;D&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;shanghai_index&#39;</span><span class=p>:</span> <span class=mi>3000</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>cumsum</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randn</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span> <span class=o>*</span> <span class=mi>20</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;shenzhen_index&#39;</span><span class=p>:</span> <span class=mi>1000</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>cumsum</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randn</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span> <span class=o>*</span> <span class=mi>15</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;market_pe&#39;</span><span class=p>:</span> <span class=mi>15</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>cumsum</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randn</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.5</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;market_pb&#39;</span><span class=p>:</span> <span class=mf>1.8</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>cumsum</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randn</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;volatility_index&#39;</span><span class=p>:</span> <span class=mi>20</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>cumsum</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randn</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span> <span class=o>*</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>market_data</span> <span class=o>=</span> <span class=n>market_data</span><span class=o>.</span><span class=n>set_index</span><span class=p>(</span><span class=s1>&#39;date&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>market_data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取财务数据</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 财务数据获取 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>financial_df</span> <span class=o>=</span> <span class=n>get_financial_data</span><span class=p>(</span><span class=s2>&#34;000001.SZ&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;财务数据:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>financial_df</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取市场数据</span>
</span></span><span class=line><span class=cl><span class=n>market_df</span> <span class=o>=</span> <span class=n>get_market_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>市场数据（前5行）:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>market_df</span><span class=o>.</span><span class=n>head</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=数据获取方法>数据获取方法</h2><h3 id=实时数据获取>实时数据获取</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RealTimeDataFeed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;实时数据获取器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_running</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data_buffer</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>callbacks</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add_callback</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>callback</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;添加数据回调函数&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>callbacks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>callback</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_realtime_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>symbol</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成模拟实时数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>base_price</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>        <span class=n>last_price</span> <span class=o>=</span> <span class=n>base_price</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_running</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 生成价格变动</span>
</span></span><span class=line><span class=cl>            <span class=n>price_change</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randn</span><span class=p>()</span> <span class=o>*</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>            <span class=n>current_price</span> <span class=o>=</span> <span class=n>last_price</span> <span class=o>+</span> <span class=n>price_change</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 生成其他数据</span>
</span></span><span class=line><span class=cl>            <span class=n>high</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>current_price</span><span class=p>,</span> <span class=n>last_price</span><span class=p>)</span> <span class=o>+</span> <span class=nb>abs</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randn</span><span class=p>())</span> <span class=o>*</span> <span class=mf>0.2</span>
</span></span><span class=line><span class=cl>            <span class=n>low</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>current_price</span><span class=p>,</span> <span class=n>last_price</span><span class=p>)</span> <span class=o>-</span> <span class=nb>abs</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randn</span><span class=p>())</span> <span class=o>*</span> <span class=mf>0.2</span>
</span></span><span class=line><span class=cl>            <span class=n>volume</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>1000</span><span class=p>,</span> <span class=mi>10000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 创建数据点</span>
</span></span><span class=line><span class=cl>            <span class=n>data_point</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;symbol&#39;</span><span class=p>:</span> <span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>current_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;high&#39;</span><span class=p>:</span> <span class=n>high</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;low&#39;</span><span class=p>:</span> <span class=n>low</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;volume&#39;</span><span class=p>:</span> <span class=n>volume</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;change&#39;</span><span class=p>:</span> <span class=n>price_change</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;change_pct&#39;</span><span class=p>:</span> <span class=n>price_change</span> <span class=o>/</span> <span class=n>last_price</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 触发回调</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>callback</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>callbacks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>callback</span><span class=p>(</span><span class=n>data_point</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>data_buffer</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>data_point</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 更新最后价格</span>
</span></span><span class=line><span class=cl>            <span class=n>last_price</span> <span class=o>=</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 等待一段时间（模拟实时数据间隔）</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>start_feed</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>symbol</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;开始实时数据流&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_running</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;开始获取 </span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2> 的实时数据...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl>        <span class=n>feed_thread</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>generate_realtime_data</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>symbol</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>        <span class=n>feed_thread</span><span class=o>.</span><span class=n>daemon</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=n>feed_thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>stop_feed</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;停止实时数据流&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_running</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;停止实时数据流&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_buffer_data</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取缓冲区数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>data_buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>clear_buffer</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;清空缓冲区&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data_buffer</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 回调函数示例</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>price_alert</span><span class=p>(</span><span class=n>data_point</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;价格预警回调&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=n>data_point</span><span class=p>[</span><span class=s1>&#39;change_pct&#39;</span><span class=p>])</span> <span class=o>&gt;</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;价格预警: </span><span class=si>{</span><span class=n>data_point</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> 价格变动 </span><span class=si>{</span><span class=n>data_point</span><span class=p>[</span><span class=s1>&#39;change_pct&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>volume_alert</span><span class=p>(</span><span class=n>data_point</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;成交量预警回调&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>data_point</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>8000</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;成交量预警: </span><span class=si>{</span><span class=n>data_point</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> 成交量 </span><span class=si>{</span><span class=n>data_point</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试实时数据获取</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 实时数据获取测试 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>realtime_feed</span> <span class=o>=</span> <span class=n>RealTimeDataFeed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加回调函数</span>
</span></span><span class=line><span class=cl><span class=n>realtime_feed</span><span class=o>.</span><span class=n>add_callback</span><span class=p>(</span><span class=n>price_alert</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>realtime_feed</span><span class=o>.</span><span class=n>add_callback</span><span class=p>(</span><span class=n>volume_alert</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 开始获取数据（运行5秒后停止）</span>
</span></span><span class=line><span class=cl><span class=n>realtime_feed</span><span class=o>.</span><span class=n>start_feed</span><span class=p>(</span><span class=s2>&#34;TEST&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>realtime_feed</span><span class=o>.</span><span class=n>stop_feed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取缓冲区数据</span>
</span></span><span class=line><span class=cl><span class=n>buffer_data</span> <span class=o>=</span> <span class=n>realtime_feed</span><span class=o>.</span><span class=n>get_buffer_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>获取到 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>buffer_data</span><span class=p>)</span><span class=si>}</span><span class=s2> 条实时数据&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=ow>not</span> <span class=n>buffer_data</span><span class=o>.</span><span class=n>empty</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>buffer_data</span><span class=o>.</span><span class=n>head</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=数据预处理>数据预处理</h2><h3 id=数据格式标准化>数据格式标准化</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DataPreprocessor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;数据预处理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>processing_steps</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>standardize_columns</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;标准化列名&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 定义标准列名映射</span>
</span></span><span class=line><span class=cl>        <span class=n>column_mapping</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1># 价格相关</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Open&#39;</span><span class=p>:</span> <span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;OPEN&#39;</span><span class=p>:</span> <span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;开盘价&#39;</span><span class=p>:</span> <span class=s1>&#39;open&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;High&#39;</span><span class=p>:</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;HIGH&#39;</span><span class=p>:</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;最高价&#39;</span><span class=p>:</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Low&#39;</span><span class=p>:</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;LOW&#39;</span><span class=p>:</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;最低价&#39;</span><span class=p>:</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Close&#39;</span><span class=p>:</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;CLOSE&#39;</span><span class=p>:</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;收盘价&#39;</span><span class=p>:</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Adj Close&#39;</span><span class=p>:</span> <span class=s1>&#39;adj_close&#39;</span><span class=p>,</span> <span class=s1>&#39;ADJ_CLOSE&#39;</span><span class=p>:</span> <span class=s1>&#39;adj_close&#39;</span><span class=p>,</span> <span class=s1>&#39;调整后收盘价&#39;</span><span class=p>:</span> <span class=s1>&#39;adj_close&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 成交量相关</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Volume&#39;</span><span class=p>:</span> <span class=s1>&#39;volume&#39;</span><span class=p>,</span> <span class=s1>&#39;VOLUME&#39;</span><span class=p>:</span> <span class=s1>&#39;volume&#39;</span><span class=p>,</span> <span class=s1>&#39;成交量&#39;</span><span class=p>:</span> <span class=s1>&#39;volume&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Amount&#39;</span><span class=p>:</span> <span class=s1>&#39;amount&#39;</span><span class=p>,</span> <span class=s1>&#39;AMOUNT&#39;</span><span class=p>:</span> <span class=s1>&#39;amount&#39;</span><span class=p>,</span> <span class=s1>&#39;成交额&#39;</span><span class=p>:</span> <span class=s1>&#39;amount&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 时间相关</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Date&#39;</span><span class=p>:</span> <span class=s1>&#39;date&#39;</span><span class=p>,</span> <span class=s1>&#39;DATE&#39;</span><span class=p>:</span> <span class=s1>&#39;date&#39;</span><span class=p>,</span> <span class=s1>&#39;日期&#39;</span><span class=p>:</span> <span class=s1>&#39;date&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Time&#39;</span><span class=p>:</span> <span class=s1>&#39;time&#39;</span><span class=p>,</span> <span class=s1>&#39;TIME&#39;</span><span class=p>:</span> <span class=s1>&#39;time&#39;</span><span class=p>,</span> <span class=s1>&#39;时间&#39;</span><span class=p>:</span> <span class=s1>&#39;time&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Timestamp&#39;</span><span class=p>:</span> <span class=s1>&#39;timestamp&#39;</span><span class=p>,</span> <span class=s1>&#39;TIMESTAMP&#39;</span><span class=p>:</span> <span class=s1>&#39;timestamp&#39;</span><span class=p>,</span> <span class=s1>&#39;时间戳&#39;</span><span class=p>:</span> <span class=s1>&#39;timestamp&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 股票代码</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Symbol&#39;</span><span class=p>:</span> <span class=s1>&#39;symbol&#39;</span><span class=p>,</span> <span class=s1>&#39;SYMBOL&#39;</span><span class=p>:</span> <span class=s1>&#39;symbol&#39;</span><span class=p>,</span> <span class=s1>&#39;股票代码&#39;</span><span class=p>:</span> <span class=s1>&#39;symbol&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Code&#39;</span><span class=p>:</span> <span class=s1>&#39;symbol&#39;</span><span class=p>,</span> <span class=s1>&#39;CODE&#39;</span><span class=p>:</span> <span class=s1>&#39;symbol&#39;</span><span class=p>,</span> <span class=s1>&#39;代码&#39;</span><span class=p>:</span> <span class=s1>&#39;symbol&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 重命名列</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=n>columns</span><span class=o>=</span><span class=n>column_mapping</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>standardize_data_types</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;标准化数据类型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 确保日期索引是datetime类型</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>,</span> <span class=n>pd</span><span class=o>.</span><span class=n>DatetimeIndex</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;date&#39;</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span><span class=p>[</span><span class=s1>&#39;date&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>to_datetime</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;date&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>set_index</span><span class=p>(</span><span class=s1>&#39;date&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=s1>&#39;timestamp&#39;</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>to_datetime</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>set_index</span><span class=p>(</span><span class=s1>&#39;timestamp&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 标准化数值列</span>
</span></span><span class=line><span class=cl>        <span class=n>numeric_columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>,</span> <span class=s1>&#39;amount&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>numeric_columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>to_numeric</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>col</span><span class=p>],</span> <span class=n>errors</span><span class=o>=</span><span class=s1>&#39;coerce&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 标准化股票代码</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;symbol&#39;</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>str</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_missing_values</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;forward_fill&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理缺失值&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;forward_fill&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=n>method</span><span class=o>=</span><span class=s1>&#39;ffill&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;backward_fill&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=n>method</span><span class=o>=</span><span class=s1>&#39;bfill&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;interpolate&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>interpolate</span><span class=p>(</span><span class=n>method</span><span class=o>=</span><span class=s1>&#39;linear&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;drop&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;mean&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>mean</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;median&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>median</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>remove_duplicates</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>subset</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;去除重复数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>subset</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>drop_duplicates</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>drop_duplicates</span><span class=p>(</span><span class=n>subset</span><span class=o>=</span><span class=n>subset</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>validate_price_logic</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;验证价格逻辑&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>required_columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 检查是否有所需列</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>all</span><span class=p>(</span><span class=n>col</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>required_columns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;警告: 缺少必要的价格列&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 修复价格逻辑错误</span>
</span></span><span class=line><span class=cl>        <span class=c1># 确保 high &gt;= max(open, close, low)</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;high&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 确保 low &lt;= min(open, close, high)</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;low&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>min</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add_calculated_fields</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;添加计算字段&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 计算收益率</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;close&#39;</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=p>[</span><span class=s1>&#39;return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=p>[</span><span class=s1>&#39;log_return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算价格范围</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>all</span><span class=p>(</span><span class=n>col</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=p>[</span><span class=s1>&#39;price_range&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;high&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;low&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=p>[</span><span class=s1>&#39;price_range_pct&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;high&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;low&#39;</span><span class=p>])</span> <span class=o>/</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算成交量变化率</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;volume&#39;</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume_change&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 添加时间特征</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;year&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>year</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;month&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>month</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;day&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>day</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;weekday&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>dayofweek</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;quarter&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>quarter</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试数据预处理</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 数据预处理测试 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>preprocessor</span> <span class=o>=</span> <span class=n>DataPreprocessor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用前面下载的数据进行测试</span>
</span></span><span class=line><span class=cl><span class=n>test_data</span> <span class=o>=</span> <span class=n>stock_data</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;原始数据:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>test_data</span><span class=o>.</span><span class=n>head</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;原始列名: </span><span class=si>{</span><span class=n>test_data</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 标准化处理</span>
</span></span><span class=line><span class=cl><span class=n>processed_data</span> <span class=o>=</span> <span class=n>test_data</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>processed_data</span> <span class=o>=</span> <span class=n>preprocessor</span><span class=o>.</span><span class=n>standardize_columns</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>processed_data</span> <span class=o>=</span> <span class=n>preprocessor</span><span class=o>.</span><span class=n>standardize_data_types</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>processed_data</span> <span class=o>=</span> <span class=n>preprocessor</span><span class=o>.</span><span class=n>validate_price_logic</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>processed_data</span> <span class=o>=</span> <span class=n>preprocessor</span><span class=o>.</span><span class=n>add_calculated_fields</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>processed_data</span> <span class=o>=</span> <span class=n>preprocessor</span><span class=o>.</span><span class=n>handle_missing_values</span><span class=p>(</span><span class=n>processed_data</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;forward_fill&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>processed_data</span> <span class=o>=</span> <span class=n>preprocessor</span><span class=o>.</span><span class=n>remove_duplicates</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>处理后数据:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>processed_data</span><span class=o>.</span><span class=n>head</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;处理后列名: </span><span class=si>{</span><span class=n>processed_data</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=数据预处理-1>数据预处理</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DataPreprocessor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;数据预处理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>processing_steps</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>standardize_columns</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;标准化列名&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 定义标准列名映射</span>
</span></span><span class=line><span class=cl>        <span class=n>column_mapping</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1># 价格相关</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Open&#39;</span><span class=p>:</span> <span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;OPEN&#39;</span><span class=p>:</span> <span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;开盘价&#39;</span><span class=p>:</span> <span class=s1>&#39;open&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;High&#39;</span><span class=p>:</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;HIGH&#39;</span><span class=p>:</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;最高价&#39;</span><span class=p>:</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Low&#39;</span><span class=p>:</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;LOW&#39;</span><span class=p>:</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;最低价&#39;</span><span class=p>:</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Close&#39;</span><span class=p>:</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;CLOSE&#39;</span><span class=p>:</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;收盘价&#39;</span><span class=p>:</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Adj Close&#39;</span><span class=p>:</span> <span class=s1>&#39;adj_close&#39;</span><span class=p>,</span> <span class=s1>&#39;ADJ_CLOSE&#39;</span><span class=p>:</span> <span class=s1>&#39;adj_close&#39;</span><span class=p>,</span> <span class=s1>&#39;调整后收盘价&#39;</span><span class=p>:</span> <span class=s1>&#39;adj_close&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 成交量相关</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Volume&#39;</span><span class=p>:</span> <span class=s1>&#39;volume&#39;</span><span class=p>,</span> <span class=s1>&#39;VOLUME&#39;</span><span class=p>:</span> <span class=s1>&#39;volume&#39;</span><span class=p>,</span> <span class=s1>&#39;成交量&#39;</span><span class=p>:</span> <span class=s1>&#39;volume&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Amount&#39;</span><span class=p>:</span> <span class=s1>&#39;amount&#39;</span><span class=p>,</span> <span class=s1>&#39;AMOUNT&#39;</span><span class=p>:</span> <span class=s1>&#39;amount&#39;</span><span class=p>,</span> <span class=s1>&#39;成交额&#39;</span><span class=p>:</span> <span class=s1>&#39;amount&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 时间相关</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Date&#39;</span><span class=p>:</span> <span class=s1>&#39;date&#39;</span><span class=p>,</span> <span class=s1>&#39;DATE&#39;</span><span class=p>:</span> <span class=s1>&#39;date&#39;</span><span class=p>,</span> <span class=s1>&#39;日期&#39;</span><span class=p>:</span> <span class=s1>&#39;date&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Time&#39;</span><span class=p>:</span> <span class=s1>&#39;time&#39;</span><span class=p>,</span> <span class=s1>&#39;TIME&#39;</span><span class=p>:</span> <span class=s1>&#39;time&#39;</span><span class=p>,</span> <span class=s1>&#39;时间&#39;</span><span class=p>:</span> <span class=s1>&#39;time&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Timestamp&#39;</span><span class=p>:</span> <span class=s1>&#39;timestamp&#39;</span><span class=p>,</span> <span class=s1>&#39;TIMESTAMP&#39;</span><span class=p>:</span> <span class=s1>&#39;timestamp&#39;</span><span class=p>,</span> <span class=s1>&#39;时间戳&#39;</span><span class=p>:</span> <span class=s1>&#39;timestamp&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 股票代码</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Symbol&#39;</span><span class=p>:</span> <span class=s1>&#39;symbol&#39;</span><span class=p>,</span> <span class=s1>&#39;SYMBOL&#39;</span><span class=p>:</span> <span class=s1>&#39;symbol&#39;</span><span class=p>,</span> <span class=s1>&#39;股票代码&#39;</span><span class=p>:</span> <span class=s1>&#39;symbol&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Code&#39;</span><span class=p>:</span> <span class=s1>&#39;symbol&#39;</span><span class=p>,</span> <span class=s1>&#39;CODE&#39;</span><span class=p>:</span> <span class=s1>&#39;symbol&#39;</span><span class=p>,</span> <span class=s1>&#39;代码&#39;</span><span class=p>:</span> <span class=s1>&#39;symbol&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 重命名列</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=n>columns</span><span class=o>=</span><span class=n>column_mapping</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>standardize_data_types</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;标准化数据类型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 确保日期索引是datetime类型</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>,</span> <span class=n>pd</span><span class=o>.</span><span class=n>DatetimeIndex</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;date&#39;</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span><span class=p>[</span><span class=s1>&#39;date&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>to_datetime</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;date&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>set_index</span><span class=p>(</span><span class=s1>&#39;date&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=s1>&#39;timestamp&#39;</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>to_datetime</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>set_index</span><span class=p>(</span><span class=s1>&#39;timestamp&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 标准化数值列</span>
</span></span><span class=line><span class=cl>        <span class=n>numeric_columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>,</span> <span class=s1>&#39;amount&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>numeric_columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>to_numeric</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>col</span><span class=p>],</span> <span class=n>errors</span><span class=o>=</span><span class=s1>&#39;coerce&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 标准化股票代码</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;symbol&#39;</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>str</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_missing_values</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;forward_fill&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理缺失值&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;forward_fill&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=n>method</span><span class=o>=</span><span class=s1>&#39;ffill&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;backward_fill&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=n>method</span><span class=o>=</span><span class=s1>&#39;bfill&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;interpolate&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>interpolate</span><span class=p>(</span><span class=n>method</span><span class=o>=</span><span class=s1>&#39;linear&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;drop&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;mean&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>mean</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;median&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>median</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>remove_duplicates</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>subset</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;去除重复数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>subset</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>drop_duplicates</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>drop_duplicates</span><span class=p>(</span><span class=n>subset</span><span class=o>=</span><span class=n>subset</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>validate_price_logic</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;验证价格逻辑&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>required_columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 检查是否有所需列</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>all</span><span class=p>(</span><span class=n>col</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>required_columns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;警告: 缺少必要的价格列&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 修复价格逻辑错误</span>
</span></span><span class=line><span class=cl>        <span class=c1># 确保 high &gt;= max(open, close, low)</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;high&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 确保 low &lt;= min(open, close, high)</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;low&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>min</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add_calculated_fields</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;添加计算字段&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 计算收益率</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;close&#39;</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=p>[</span><span class=s1>&#39;return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=p>[</span><span class=s1>&#39;log_return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算价格范围</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>all</span><span class=p>(</span><span class=n>col</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=p>[</span><span class=s1>&#39;price_range&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;high&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;low&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=p>[</span><span class=s1>&#39;price_range_pct&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;high&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;low&#39;</span><span class=p>])</span> <span class=o>/</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算成交量变化率</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;volume&#39;</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume_change&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 添加时间特征</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;year&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>year</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;month&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>month</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;day&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>day</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;weekday&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>dayofweek</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;quarter&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>quarter</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试数据预处理</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 数据预处理测试 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>preprocessor</span> <span class=o>=</span> <span class=n>DataPreprocessor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用前面下载的数据进行测试</span>
</span></span><span class=line><span class=cl><span class=n>test_data</span> <span class=o>=</span> <span class=n>stock_data</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;原始数据:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>test_data</span><span class=o>.</span><span class=n>head</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;原始列名: </span><span class=si>{</span><span class=n>test_data</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 标准化处理</span>
</span></span><span class=line><span class=cl><span class=n>processed_data</span> <span class=o>=</span> <span class=n>test_data</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>processed_data</span> <span class=o>=</span> <span class=n>preprocessor</span><span class=o>.</span><span class=n>standardize_columns</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>processed_data</span> <span class=o>=</span> <span class=n>preprocessor</span><span class=o>.</span><span class=n>standardize_data_types</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>processed_data</span> <span class=o>=</span> <span class=n>preprocessor</span><span class=o>.</span><span class=n>validate_price_logic</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>processed_data</span> <span class=o>=</span> <span class=n>preprocessor</span><span class=o>.</span><span class=n>add_calculated_fields</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>processed_data</span> <span class=o>=</span> <span class=n>preprocessor</span><span class=o>.</span><span class=n>handle_missing_values</span><span class=p>(</span><span class=n>processed_data</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;forward_fill&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>processed_data</span> <span class=o>=</span> <span class=n>preprocessor</span><span class=o>.</span><span class=n>remove_duplicates</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>处理后数据:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>processed_data</span><span class=o>.</span><span class=n>head</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;处理后列名: </span><span class=si>{</span><span class=n>processed_data</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=异常值检测与处理>异常值检测与处理</h2><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OutlierDetector</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;异常值检测器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>outlier_info</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>detect_outliers_iqr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>column</span><span class=p>,</span> <span class=n>multiplier</span><span class=o>=</span><span class=mf>1.5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;使用IQR方法检测异常值&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>Q1</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>quantile</span><span class=p>(</span><span class=mf>0.25</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>Q3</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>quantile</span><span class=p>(</span><span class=mf>0.75</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>IQR</span> <span class=o>=</span> <span class=n>Q3</span> <span class=o>-</span> <span class=n>Q1</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>lower_bound</span> <span class=o>=</span> <span class=n>Q1</span> <span class=o>-</span> <span class=n>multiplier</span> <span class=o>*</span> <span class=n>IQR</span>
</span></span><span class=line><span class=cl>        <span class=n>upper_bound</span> <span class=o>=</span> <span class=n>Q3</span> <span class=o>+</span> <span class=n>multiplier</span> <span class=o>*</span> <span class=n>IQR</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>outliers</span> <span class=o>=</span> <span class=n>data</span><span class=p>[(</span><span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>lower_bound</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>upper_bound</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;outliers&#39;</span><span class=p>:</span> <span class=n>outliers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;bounds&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>lower_bound</span><span class=p>,</span> <span class=n>upper_bound</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;count&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>outliers</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;percentage&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>outliers</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>detect_outliers_zscore</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>column</span><span class=p>,</span> <span class=n>threshold</span><span class=o>=</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;使用Z-score方法检测异常值&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>mean</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>z_scores</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>((</span><span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span> <span class=o>-</span> <span class=n>mean</span><span class=p>)</span> <span class=o>/</span> <span class=n>std</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>outliers</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>z_scores</span> <span class=o>&gt;</span> <span class=n>threshold</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;outliers&#39;</span><span class=p>:</span> <span class=n>outliers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;threshold&#39;</span><span class=p>:</span> <span class=n>threshold</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;count&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>outliers</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;percentage&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>outliers</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>detect_outliers_mad</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>column</span><span class=p>,</span> <span class=n>threshold</span><span class=o>=</span><span class=mf>3.5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;使用MAD（中位数绝对偏差）方法检测异常值&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>median</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>median</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>mad</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>median</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span> <span class=o>-</span> <span class=n>median</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>modified_z_scores</span> <span class=o>=</span> <span class=mf>0.6745</span> <span class=o>*</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span> <span class=o>-</span> <span class=n>median</span><span class=p>)</span> <span class=o>/</span> <span class=n>mad</span>
</span></span><span class=line><span class=cl>        <span class=n>outliers</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>modified_z_scores</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>threshold</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;outliers&#39;</span><span class=p>:</span> <span class=n>outliers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;threshold&#39;</span><span class=p>:</span> <span class=n>threshold</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;count&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>outliers</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;percentage&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>outliers</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_outliers</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>column</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;winsorize&#39;</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理异常值&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;winsorize&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 缩尾处理</span>
</span></span><span class=line><span class=cl>            <span class=n>lower_percentile</span> <span class=o>=</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;lower_percentile&#39;</span><span class=p>,</span> <span class=mf>0.01</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>upper_percentile</span> <span class=o>=</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;upper_percentile&#39;</span><span class=p>,</span> <span class=mf>0.99</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>lower_bound</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>quantile</span><span class=p>(</span><span class=n>lower_percentile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>upper_bound</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>quantile</span><span class=p>(</span><span class=n>upper_percentile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>data_cleaned</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>data_cleaned</span><span class=p>[</span><span class=n>column</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>data_cleaned</span><span class=p>[</span><span class=n>column</span><span class=p>],</span> <span class=n>lower_bound</span><span class=p>,</span> <span class=n>upper_bound</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>data_cleaned</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;remove&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 移除异常值</span>
</span></span><span class=line><span class=cl>            <span class=n>outlier_info</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>detect_outliers_iqr</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>column</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>clean_data</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=o>~</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>isin</span><span class=p>(</span><span class=n>outlier_info</span><span class=p>[</span><span class=s1>&#39;outliers&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>index</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>clean_data</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;replace_with_nan&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 替换为NaN</span>
</span></span><span class=line><span class=cl>            <span class=n>outlier_info</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>detect_outliers_iqr</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>column</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>data_cleaned</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>data_cleaned</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>outlier_info</span><span class=p>[</span><span class=s1>&#39;outliers&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>index</span><span class=p>,</span> <span class=n>column</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>data_cleaned</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试异常值检测</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 异常值检测测试 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>detector</span> <span class=o>=</span> <span class=n>OutlierDetector</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建包含异常值的测试数据</span>
</span></span><span class=line><span class=cl><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>test_data_with_outliers</span> <span class=o>=</span> <span class=n>processed_data</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加一些异常值</span>
</span></span><span class=line><span class=cl><span class=n>outlier_indices</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>test_data_with_outliers</span><span class=o>.</span><span class=n>index</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span> <span class=n>replace</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>test_data_with_outliers</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>outlier_indices</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>]</span> <span class=o>*=</span> <span class=mi>2</span>  <span class=c1># 价格异常值</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 检测异常值</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;使用IQR方法检测收盘价异常值:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>iqr_result</span> <span class=o>=</span> <span class=n>detector</span><span class=o>.</span><span class=n>detect_outliers_iqr</span><span class=p>(</span><span class=n>test_data_with_outliers</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;检测到 </span><span class=si>{</span><span class=n>iqr_result</span><span class=p>[</span><span class=s1>&#39;count&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> 个异常值 (</span><span class=si>{</span><span class=n>iqr_result</span><span class=p>[</span><span class=s1>&#39;percentage&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用不同方法检测</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>使用Z-score方法检测:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>zscore_result</span> <span class=o>=</span> <span class=n>detector</span><span class=o>.</span><span class=n>detect_outliers_zscore</span><span class=p>(</span><span class=n>test_data_with_outliers</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;检测到 </span><span class=si>{</span><span class=n>zscore_result</span><span class=p>[</span><span class=s1>&#39;count&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> 个异常值 (</span><span class=si>{</span><span class=n>zscore_result</span><span class=p>[</span><span class=s1>&#39;percentage&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 处理异常值</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>处理异常值（缩尾处理）:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cleaned_data</span> <span class=o>=</span> <span class=n>detector</span><span class=o>.</span><span class=n>handle_outliers</span><span class=p>(</span><span class=n>test_data_with_outliers</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;winsorize&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;处理前收盘价范围: [</span><span class=si>{</span><span class=n>test_data_with_outliers</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>min</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>test_data_with_outliers</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>max</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>]&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;处理后收盘价范围: [</span><span class=si>{</span><span class=n>cleaned_data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>min</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>cleaned_data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>max</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>]&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=特征工程>特征工程</h2><h3 id=技术指标计算>技术指标计算</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TechnicalIndicators</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;技术指标计算器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>indicators</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_moving_average</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>window</span><span class=p>,</span> <span class=n>column</span><span class=o>=</span><span class=s1>&#39;close&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算移动平均线&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_ema</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>window</span><span class=p>,</span> <span class=n>column</span><span class=o>=</span><span class=s1>&#39;close&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算指数移动平均线&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>ewm</span><span class=p>(</span><span class=n>span</span><span class=o>=</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_rsi</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>window</span><span class=o>=</span><span class=mi>14</span><span class=p>,</span> <span class=n>column</span><span class=o>=</span><span class=s1>&#39;close&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算相对强弱指标(RSI)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>delta</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>diff</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>gain</span> <span class=o>=</span> <span class=p>(</span><span class=n>delta</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>delta</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>loss</span> <span class=o>=</span> <span class=p>(</span><span class=o>-</span><span class=n>delta</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>delta</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>rs</span> <span class=o>=</span> <span class=n>gain</span> <span class=o>/</span> <span class=n>loss</span>
</span></span><span class=line><span class=cl>        <span class=n>rsi</span> <span class=o>=</span> <span class=mi>100</span> <span class=o>-</span> <span class=p>(</span><span class=mi>100</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>rs</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>rsi</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_macd</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>fast</span><span class=o>=</span><span class=mi>12</span><span class=p>,</span> <span class=n>slow</span><span class=o>=</span><span class=mi>26</span><span class=p>,</span> <span class=n>signal</span><span class=o>=</span><span class=mi>9</span><span class=p>,</span> <span class=n>column</span><span class=o>=</span><span class=s1>&#39;close&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算MACD指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>ema_fast</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>ewm</span><span class=p>(</span><span class=n>span</span><span class=o>=</span><span class=n>fast</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>ema_slow</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>ewm</span><span class=p>(</span><span class=n>span</span><span class=o>=</span><span class=n>slow</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>macd_line</span> <span class=o>=</span> <span class=n>ema_fast</span> <span class=o>-</span> <span class=n>ema_slow</span>
</span></span><span class=line><span class=cl>        <span class=n>signal_line</span> <span class=o>=</span> <span class=n>macd_line</span><span class=o>.</span><span class=n>ewm</span><span class=p>(</span><span class=n>span</span><span class=o>=</span><span class=n>signal</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>histogram</span> <span class=o>=</span> <span class=n>macd_line</span> <span class=o>-</span> <span class=n>signal_line</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;macd&#39;</span><span class=p>:</span> <span class=n>macd_line</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;signal&#39;</span><span class=p>:</span> <span class=n>signal_line</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;histogram&#39;</span><span class=p>:</span> <span class=n>histogram</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_bollinger_bands</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>window</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span> <span class=n>num_std</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>column</span><span class=o>=</span><span class=s1>&#39;close&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算布林带&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>rolling_mean</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>rolling_std</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>upper_band</span> <span class=o>=</span> <span class=n>rolling_mean</span> <span class=o>+</span> <span class=p>(</span><span class=n>rolling_std</span> <span class=o>*</span> <span class=n>num_std</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>lower_band</span> <span class=o>=</span> <span class=n>rolling_mean</span> <span class=o>-</span> <span class=p>(</span><span class=n>rolling_std</span> <span class=o>*</span> <span class=n>num_std</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;upper&#39;</span><span class=p>:</span> <span class=n>upper_band</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;middle&#39;</span><span class=p>:</span> <span class=n>rolling_mean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;lower&#39;</span><span class=p>:</span> <span class=n>lower_band</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;band_width&#39;</span><span class=p>:</span> <span class=n>upper_band</span> <span class=o>-</span> <span class=n>lower_band</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_stochastic</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>window</span><span class=o>=</span><span class=mi>14</span><span class=p>,</span> <span class=n>smooth_window</span><span class=o>=</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算随机指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>low_min</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;low&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>min</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>high_max</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;high&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>max</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>k_percent</span> <span class=o>=</span> <span class=mi>100</span> <span class=o>*</span> <span class=p>((</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>low_min</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>high_max</span> <span class=o>-</span> <span class=n>low_min</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>d_percent</span> <span class=o>=</span> <span class=n>k_percent</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=n>smooth_window</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;k&#39;</span><span class=p>:</span> <span class=n>k_percent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;d&#39;</span><span class=p>:</span> <span class=n>d_percent</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_volume_indicators</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>window</span><span class=o>=</span><span class=mi>20</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算成交量指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>volume_ma</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>volume_ratio</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=n>volume_ma</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 成交量价格趋势(VPT)</span>
</span></span><span class=line><span class=cl>        <span class=n>vpt</span> <span class=o>=</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>())</span><span class=o>.</span><span class=n>cumsum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;volume_ma&#39;</span><span class=p>:</span> <span class=n>volume_ma</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;volume_ratio&#39;</span><span class=p>:</span> <span class=n>volume_ratio</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;vpt&#39;</span><span class=p>:</span> <span class=n>vpt</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_all_indicators</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算所有技术指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 移动平均线</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;ma_5&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_moving_average</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;ma_10&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_moving_average</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;ma_20&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_moving_average</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;ma_60&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_moving_average</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 指数移动平均线</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;ema_12&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_ema</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=mi>12</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;ema_26&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_ema</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=mi>26</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># RSI</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;rsi_14&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_rsi</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=mi>14</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># MACD</span>
</span></span><span class=line><span class=cl>        <span class=n>macd_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_macd</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;macd&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>macd_data</span><span class=p>[</span><span class=s1>&#39;macd&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;macd_signal&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>macd_data</span><span class=p>[</span><span class=s1>&#39;signal&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;macd_histogram&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>macd_data</span><span class=p>[</span><span class=s1>&#39;histogram&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 布林带</span>
</span></span><span class=line><span class=cl>        <span class=n>bb_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_bollinger_bands</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;bb_upper&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>bb_data</span><span class=p>[</span><span class=s1>&#39;upper&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;bb_middle&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>bb_data</span><span class=p>[</span><span class=s1>&#39;middle&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;bb_lower&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>bb_data</span><span class=p>[</span><span class=s1>&#39;lower&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;bb_width&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>bb_data</span><span class=p>[</span><span class=s1>&#39;band_width&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 随机指标</span>
</span></span><span class=line><span class=cl>        <span class=n>stoch_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_stochastic</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;stoch_k&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>stoch_data</span><span class=p>[</span><span class=s1>&#39;k&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;stoch_d&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>stoch_data</span><span class=p>[</span><span class=s1>&#39;d&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 成交量指标</span>
</span></span><span class=line><span class=cl>        <span class=n>volume_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_volume_indicators</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;volume_ma&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>volume_data</span><span class=p>[</span><span class=s1>&#39;volume_ma&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;volume_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>volume_data</span><span class=p>[</span><span class=s1>&#39;volume_ratio&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;vpt&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>volume_data</span><span class=p>[</span><span class=s1>&#39;vpt&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>indicators</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试技术指标计算</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 技术指标计算测试 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>indicator_calculator</span> <span class=o>=</span> <span class=n>TechnicalIndicators</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 选择一个股票的数据进行测试</span>
</span></span><span class=line><span class=cl><span class=n>sample_stock</span> <span class=o>=</span> <span class=n>processed_data</span><span class=p>[</span><span class=n>processed_data</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;AAPL&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 计算技术指标</span>
</span></span><span class=line><span class=cl><span class=n>tech_indicators</span> <span class=o>=</span> <span class=n>indicator_calculator</span><span class=o>.</span><span class=n>calculate_all_indicators</span><span class=p>(</span><span class=n>sample_stock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;技术指标计算完成&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;计算了 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>tech_indicators</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span><span class=si>}</span><span class=s2> 个技术指标&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;技术指标样本:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>tech_indicators</span><span class=o>.</span><span class=n>tail</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 合并原始数据和技术指标</span>
</span></span><span class=line><span class=cl><span class=n>enhanced_data</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>sample_stock</span><span class=p>,</span> <span class=n>tech_indicators</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>增强数据维度: </span><span class=si>{</span><span class=n>enhanced_data</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=特征构造>特征构造</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>FeatureEngineer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;特征工程器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>feature_info</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_lag_features</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>column</span><span class=p>,</span> <span class=n>lags</span><span class=o>=</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>10</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;创建滞后特征&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>lag_features</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>lag</span> <span class=ow>in</span> <span class=n>lags</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>lag_features</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>column</span><span class=si>}</span><span class=s1>_lag_</span><span class=si>{</span><span class=n>lag</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>lag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>lag_features</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_rolling_features</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>column</span><span class=p>,</span> <span class=n>windows</span><span class=o>=</span><span class=p>[</span><span class=mi>5</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>60</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;创建滚动窗口特征&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>rolling_features</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>window</span> <span class=ow>in</span> <span class=n>windows</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>rolling_features</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>column</span><span class=si>}</span><span class=s1>_rolling_mean_</span><span class=si>{</span><span class=n>window</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>rolling_features</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>column</span><span class=si>}</span><span class=s1>_rolling_std_</span><span class=si>{</span><span class=n>window</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>rolling_features</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>column</span><span class=si>}</span><span class=s1>_rolling_min_</span><span class=si>{</span><span class=n>window</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>min</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>rolling_features</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>column</span><span class=si>}</span><span class=s1>_rolling_max_</span><span class=si>{</span><span class=n>window</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>max</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>rolling_features</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>column</span><span class=si>}</span><span class=s1>_rolling_skew_</span><span class=si>{</span><span class=n>window</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>skew</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>rolling_features</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>column</span><span class=si>}</span><span class=s1>_rolling_kurt_</span><span class=si>{</span><span class=n>window</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>kurt</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>rolling_features</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_price_features</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;创建价格相关特征&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>price_features</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 价格变化特征</span>
</span></span><span class=line><span class=cl>        <span class=n>price_features</span><span class=p>[</span><span class=s1>&#39;price_change&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>diff</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>price_features</span><span class=p>[</span><span class=s1>&#39;price_change_pct&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 价格位置特征</span>
</span></span><span class=line><span class=cl>        <span class=n>price_features</span><span class=p>[</span><span class=s1>&#39;price_position&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;low&#39;</span><span class=p>])</span> <span class=o>/</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;high&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;low&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 价格动量特征</span>
</span></span><span class=line><span class=cl>        <span class=n>price_features</span><span class=p>[</span><span class=s1>&#39;price_momentum_5&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>price_features</span><span class=p>[</span><span class=s1>&#39;price_momentum_10&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>price_features</span><span class=p>[</span><span class=s1>&#39;price_momentum_20&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 价格趋势特征</span>
</span></span><span class=line><span class=cl>        <span class=n>price_features</span><span class=p>[</span><span class=s1>&#39;price_trend&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>price_features</span><span class=p>[</span><span class=s1>&#39;price_trend_5&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>price_features</span><span class=p>[</span><span class=s1>&#39;price_trend&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>price_features</span><span class=p>[</span><span class=s1>&#39;price_trend_10&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>price_features</span><span class=p>[</span><span class=s1>&#39;price_trend&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>price_features</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_volume_features</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;创建成交量特征&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>volume_features</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 成交量变化特征</span>
</span></span><span class=line><span class=cl>        <span class=n>volume_features</span><span class=p>[</span><span class=s1>&#39;volume_change&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>diff</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>volume_features</span><span class=p>[</span><span class=s1>&#39;volume_change_pct&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 成交量强度特征</span>
</span></span><span class=line><span class=cl>        <span class=n>volume_features</span><span class=p>[</span><span class=s1>&#39;volume_intensity&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 价格-成交量关系特征</span>
</span></span><span class=line><span class=cl>        <span class=n>volume_features</span><span class=p>[</span><span class=s1>&#39;price_volume_correlation&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>corr</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 成交量异常检测</span>
</span></span><span class=line><span class=cl>        <span class=n>volume_mean</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>volume_std</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>volume_features</span><span class=p>[</span><span class=s1>&#39;volume_anomaly&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>volume_mean</span><span class=p>)</span> <span class=o>/</span> <span class=n>volume_std</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>volume_features</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_time_features</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;创建时间特征&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>time_features</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 基本时间特征</span>
</span></span><span class=line><span class=cl>        <span class=n>time_features</span><span class=p>[</span><span class=s1>&#39;day_of_week&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>dayofweek</span>
</span></span><span class=line><span class=cl>        <span class=n>time_features</span><span class=p>[</span><span class=s1>&#39;day_of_month&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>day</span>
</span></span><span class=line><span class=cl>        <span class=n>time_features</span><span class=p>[</span><span class=s1>&#39;month&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>month</span>
</span></span><span class=line><span class=cl>        <span class=n>time_features</span><span class=p>[</span><span class=s1>&#39;quarter&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>quarter</span>
</span></span><span class=line><span class=cl>        <span class=n>time_features</span><span class=p>[</span><span class=s1>&#39;year&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>year</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 周期性时间特征</span>
</span></span><span class=line><span class=cl>        <span class=n>time_features</span><span class=p>[</span><span class=s1>&#39;day_sin&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sin</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>pi</span> <span class=o>*</span> <span class=n>time_features</span><span class=p>[</span><span class=s1>&#39;day_of_week&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=mi>7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time_features</span><span class=p>[</span><span class=s1>&#39;day_cos&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>cos</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>pi</span> <span class=o>*</span> <span class=n>time_features</span><span class=p>[</span><span class=s1>&#39;day_of_week&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=mi>7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time_features</span><span class=p>[</span><span class=s1>&#39;month_sin&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sin</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>pi</span> <span class=o>*</span> <span class=n>time_features</span><span class=p>[</span><span class=s1>&#39;month&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=mi>12</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time_features</span><span class=p>[</span><span class=s1>&#39;month_cos&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>cos</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>pi</span> <span class=o>*</span> <span class=n>time_features</span><span class=p>[</span><span class=s1>&#39;month&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=mi>12</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 交易日特征</span>
</span></span><span class=line><span class=cl>        <span class=n>time_features</span><span class=p>[</span><span class=s1>&#39;is_monday&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>time_features</span><span class=p>[</span><span class=s1>&#39;day_of_week&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time_features</span><span class=p>[</span><span class=s1>&#39;is_friday&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>time_features</span><span class=p>[</span><span class=s1>&#39;day_of_week&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>4</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>time_features</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_risk_features</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;创建风险特征&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>risk_features</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 波动率特征</span>
</span></span><span class=line><span class=cl>        <span class=n>risk_features</span><span class=p>[</span><span class=s1>&#39;volatility_5&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>risk_features</span><span class=p>[</span><span class=s1>&#39;volatility_10&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>risk_features</span><span class=p>[</span><span class=s1>&#39;volatility_20&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 最大回撤特征</span>
</span></span><span class=line><span class=cl>        <span class=n>rolling_max</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>max</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>risk_features</span><span class=p>[</span><span class=s1>&#39;drawdown&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>rolling_max</span><span class=p>)</span> <span class=o>/</span> <span class=n>rolling_max</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># VaR特征（历史模拟法）</span>
</span></span><span class=line><span class=cl>        <span class=n>returns</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>risk_features</span><span class=p>[</span><span class=s1>&#39;var_5&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>quantile</span><span class=p>(</span><span class=mf>0.05</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>risk_features</span><span class=p>[</span><span class=s1>&#39;var_1&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>quantile</span><span class=p>(</span><span class=mf>0.01</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>risk_features</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_all_features</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;创建所有特征&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>all_features</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 滞后特征</span>
</span></span><span class=line><span class=cl>        <span class=n>lag_features</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_lag_features</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>all_features</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>all_features</span><span class=p>,</span> <span class=n>lag_features</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 滚动窗口特征</span>
</span></span><span class=line><span class=cl>        <span class=n>rolling_features</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_rolling_features</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>all_features</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>all_features</span><span class=p>,</span> <span class=n>rolling_features</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 价格特征</span>
</span></span><span class=line><span class=cl>        <span class=n>price_features</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_price_features</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>all_features</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>all_features</span><span class=p>,</span> <span class=n>price_features</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 成交量特征</span>
</span></span><span class=line><span class=cl>        <span class=n>volume_features</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_volume_features</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>all_features</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>all_features</span><span class=p>,</span> <span class=n>volume_features</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 时间特征</span>
</span></span><span class=line><span class=cl>        <span class=n>time_features</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_time_features</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>all_features</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>all_features</span><span class=p>,</span> <span class=n>time_features</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 风险特征</span>
</span></span><span class=line><span class=cl>        <span class=n>risk_features</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_risk_features</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>all_features</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>all_features</span><span class=p>,</span> <span class=n>risk_features</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>all_features</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试特征工程</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 特征工程测试 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>feature_engineer</span> <span class=o>=</span> <span class=n>FeatureEngineer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建特征</span>
</span></span><span class=line><span class=cl><span class=n>all_features</span> <span class=o>=</span> <span class=n>feature_engineer</span><span class=o>.</span><span class=n>create_all_features</span><span class=p>(</span><span class=n>sample_stock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;创建了 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>all_features</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span><span class=si>}</span><span class=s2> 个特征&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;特征样本:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>all_features</span><span class=o>.</span><span class=n>tail</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 合并所有数据</span>
</span></span><span class=line><span class=cl><span class=n>final_data</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>enhanced_data</span><span class=p>,</span> <span class=n>all_features</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>最终数据维度: </span><span class=si>{</span><span class=n>final_data</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=时间序列处理>时间序列处理</h2><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TimeSeriesProcessor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;时间序列处理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ts_info</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>detect_seasonality</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>column</span><span class=o>=</span><span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=mi>252</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检测季节性&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>scipy</span> <span class=kn>import</span> <span class=n>signal</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算自相关系数</span>
</span></span><span class=line><span class=cl>        <span class=n>autocorr</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>autocorr</span><span class=p>(</span><span class=n>lag</span><span class=o>=</span><span class=n>period</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 使用傅里叶变换检测周期性</span>
</span></span><span class=line><span class=cl>        <span class=n>fft</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>fft</span><span class=o>.</span><span class=n>fft</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>dropna</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>power</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>fft</span><span class=p>)</span> <span class=o>**</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=n>freqs</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>fft</span><span class=o>.</span><span class=n>fftfreq</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>power</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 找到主要周期</span>
</span></span><span class=line><span class=cl>        <span class=n>positive_freqs</span> <span class=o>=</span> <span class=n>freqs</span><span class=p>[</span><span class=n>freqs</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>positive_power</span> <span class=o>=</span> <span class=n>power</span><span class=p>[</span><span class=n>freqs</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>main_period</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>positive_freqs</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>positive_power</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;autocorrelation&#39;</span><span class=p>:</span> <span class=n>autocorr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;main_period&#39;</span><span class=p>:</span> <span class=n>main_period</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;seasonality_strength&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>positive_power</span><span class=p>)</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>positive_power</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>decompose_time_series</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>column</span><span class=o>=</span><span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=mi>252</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;时间序列分解&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>statsmodels.tsa.seasonal</span> <span class=kn>import</span> <span class=n>seasonal_decompose</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>decomposition</span> <span class=o>=</span> <span class=n>seasonal_decompose</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>dropna</span><span class=p>(),</span> 
</span></span><span class=line><span class=cl>                <span class=n>model</span><span class=o>=</span><span class=s1>&#39;additive&#39;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>period</span><span class=o>=</span><span class=n>period</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;trend&#39;</span><span class=p>:</span> <span class=n>decomposition</span><span class=o>.</span><span class=n>trend</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;seasonal&#39;</span><span class=p>:</span> <span class=n>decomposition</span><span class=o>.</span><span class=n>seasonal</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;residual&#39;</span><span class=p>:</span> <span class=n>decomposition</span><span class=o>.</span><span class=n>resid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;observed&#39;</span><span class=p>:</span> <span class=n>decomposition</span><span class=o>.</span><span class=n>observed</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>ImportError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;未安装statsmodels，使用简单分解方法&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 简单趋势分解</span>
</span></span><span class=line><span class=cl>            <span class=n>trend</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=n>period</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>detrended</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span> <span class=o>-</span> <span class=n>trend</span>
</span></span><span class=line><span class=cl>            <span class=n>seasonal</span> <span class=o>=</span> <span class=n>detrended</span><span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=n>detrended</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>dayofyear</span><span class=p>)</span><span class=o>.</span><span class=n>transform</span><span class=p>(</span><span class=s1>&#39;mean&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>residual</span> <span class=o>=</span> <span class=n>detrended</span> <span class=o>-</span> <span class=n>seasonal</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;trend&#39;</span><span class=p>:</span> <span class=n>trend</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;seasonal&#39;</span><span class=p>:</span> <span class=n>seasonal</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;residual&#39;</span><span class=p>:</span> <span class=n>residual</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;observed&#39;</span><span class=p>:</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_stationarity</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>column</span><span class=o>=</span><span class=s1>&#39;close&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算平稳性&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=kn>from</span> <span class=nn>statsmodels.tsa.stattools</span> <span class=kn>import</span> <span class=n>adfuller</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>adfuller</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>dropna</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;adf_statistic&#39;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;p_value&#39;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;critical_values&#39;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=mi>4</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;is_stationary&#39;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mf>0.05</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>ImportError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;未安装statsmodels，使用简单平稳性检验&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 简单方差比检验</span>
</span></span><span class=line><span class=cl>            <span class=n>returns</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>var_ratio</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>returns</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>1</span><span class=p>::</span><span class=mi>2</span><span class=p>])</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>returns</span><span class=o>.</span><span class=n>iloc</span><span class=p>[::</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;variance_ratio&#39;</span><span class=p>:</span> <span class=n>var_ratio</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;is_stationary&#39;</span><span class=p>:</span> <span class=nb>abs</span><span class=p>(</span><span class=n>var_ratio</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试时间序列处理</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 时间序列处理测试 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ts_processor</span> <span class=o>=</span> <span class=n>TimeSeriesProcessor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 检测季节性</span>
</span></span><span class=line><span class=cl><span class=n>seasonality_info</span> <span class=o>=</span> <span class=n>ts_processor</span><span class=o>.</span><span class=n>detect_seasonality</span><span class=p>(</span><span class=n>sample_stock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;季节性检测结果:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;自相关系数: </span><span class=si>{</span><span class=n>seasonality_info</span><span class=p>[</span><span class=s1>&#39;autocorrelation&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;主要周期: </span><span class=si>{</span><span class=n>seasonality_info</span><span class=p>[</span><span class=s1>&#39;main_period&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2> 天&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 时间序列分解</span>
</span></span><span class=line><span class=cl><span class=n>decomposition</span> <span class=o>=</span> <span class=n>ts_processor</span><span class=o>.</span><span class=n>decompose_time_series</span><span class=p>(</span><span class=n>sample_stock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>时间序列分解完成&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;分解组件:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>decomposition</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>decomposition</span><span class=p>[</span><span class=n>key</span><span class=p>]</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 平稳性检验</span>
</span></span><span class=line><span class=cl><span class=n>stationarity</span> <span class=o>=</span> <span class=n>ts_processor</span><span class=o>.</span><span class=n>calculate_stationarity</span><span class=p>(</span><span class=n>sample_stock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>平稳性检验结果:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=s1>&#39;adf_statistic&#39;</span> <span class=ow>in</span> <span class=n>stationarity</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;ADF统计量: </span><span class=si>{</span><span class=n>stationarity</span><span class=p>[</span><span class=s1>&#39;adf_statistic&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;p值: </span><span class=si>{</span><span class=n>stationarity</span><span class=p>[</span><span class=s1>&#39;p_value&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;是否平稳: </span><span class=si>{</span><span class=n>stationarity</span><span class=p>[</span><span class=s1>&#39;is_stationary&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;方差比: </span><span class=si>{</span><span class=n>stationarity</span><span class=p>[</span><span class=s1>&#39;variance_ratio&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;是否平稳: </span><span class=si>{</span><span class=n>stationarity</span><span class=p>[</span><span class=s1>&#39;is_stationary&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=数据标准化与归一化>数据标准化与归一化</h2><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DataNormalizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;数据标准化器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>scalers</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>standardize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>columns</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;zscore&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;标准化数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;zscore&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Z-score标准化</span>
</span></span><span class=line><span class=cl>            <span class=n>mean</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>std</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>standardized</span> <span class=o>=</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span> <span class=o>-</span> <span class=n>mean</span><span class=p>)</span> <span class=o>/</span> <span class=n>std</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>scalers</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;standard_</span><span class=si>{</span><span class=n>method</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;mean&#39;</span><span class=p>:</span> <span class=n>mean</span><span class=p>,</span> <span class=s1>&#39;std&#39;</span><span class=p>:</span> <span class=n>std</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;minmax&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Min-Max归一化</span>
</span></span><span class=line><span class=cl>            <span class=n>min_val</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>min</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>max_val</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>max</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>standardized</span> <span class=o>=</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span> <span class=o>-</span> <span class=n>min_val</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>max_val</span> <span class=o>-</span> <span class=n>min_val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>scalers</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;standard_</span><span class=si>{</span><span class=n>method</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;min&#39;</span><span class=p>:</span> <span class=n>min_val</span><span class=p>,</span> <span class=s1>&#39;max&#39;</span><span class=p>:</span> <span class=n>max_val</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;robust&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 鲁棒标准化（使用中位数和四分位数）</span>
</span></span><span class=line><span class=cl>            <span class=n>median</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>median</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>q1</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>quantile</span><span class=p>(</span><span class=mf>0.25</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>q3</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>quantile</span><span class=p>(</span><span class=mf>0.75</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>iqr</span> <span class=o>=</span> <span class=n>q3</span> <span class=o>-</span> <span class=n>q1</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>standardized</span> <span class=o>=</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span> <span class=o>-</span> <span class=n>median</span><span class=p>)</span> <span class=o>/</span> <span class=n>iqr</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>scalers</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;standard_</span><span class=si>{</span><span class=n>method</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;median&#39;</span><span class=p>:</span> <span class=n>median</span><span class=p>,</span> <span class=s1>&#39;iqr&#39;</span><span class=p>:</span> <span class=n>iqr</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>standardized</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>inverse_transform</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>standardized_data</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;zscore&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;逆变换&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>scaler_info</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>scalers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;standard_</span><span class=si>{</span><span class=n>method</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;zscore&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>standardized_data</span> <span class=o>*</span> <span class=n>scaler_info</span><span class=p>[</span><span class=s1>&#39;std&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=n>scaler_info</span><span class=p>[</span><span class=s1>&#39;mean&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;minmax&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>standardized_data</span> <span class=o>*</span> <span class=p>(</span><span class=n>scaler_info</span><span class=p>[</span><span class=s1>&#39;max&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>scaler_info</span><span class=p>[</span><span class=s1>&#39;min&#39;</span><span class=p>])</span> <span class=o>+</span> <span class=n>scaler_info</span><span class=p>[</span><span class=s1>&#39;min&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;robust&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>standardized_data</span> <span class=o>*</span> <span class=n>scaler_info</span><span class=p>[</span><span class=s1>&#39;iqr&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=n>scaler_info</span><span class=p>[</span><span class=s1>&#39;median&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试数据标准化</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 数据标准化测试 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>normalizer</span> <span class=o>=</span> <span class=n>DataNormalizer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 选择数值列进行标准化</span>
</span></span><span class=line><span class=cl><span class=n>numeric_columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>,</span> <span class=s1>&#39;price_range&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>sample_numeric</span> <span class=o>=</span> <span class=n>final_data</span><span class=p>[</span><span class=n>numeric_columns</span><span class=p>]</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Z-score标准化</span>
</span></span><span class=line><span class=cl><span class=n>zscore_data</span> <span class=o>=</span> <span class=n>normalizer</span><span class=o>.</span><span class=n>standardize</span><span class=p>(</span><span class=n>sample_numeric</span><span class=p>,</span> <span class=n>numeric_columns</span><span class=p>,</span> <span class=s1>&#39;zscore&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Z-score标准化结果:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;均值: </span><span class=si>{</span><span class=n>zscore_data</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=o>.</span><span class=n>round</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;标准差: </span><span class=si>{</span><span class=n>zscore_data</span><span class=o>.</span><span class=n>std</span><span class=p>()</span><span class=o>.</span><span class=n>round</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Min-Max归一化</span>
</span></span><span class=line><span class=cl><span class=n>minmax_data</span> <span class=o>=</span> <span class=n>normalizer</span><span class=o>.</span><span class=n>standardize</span><span class=p>(</span><span class=n>sample_numeric</span><span class=p>,</span> <span class=n>numeric_columns</span><span class=p>,</span> <span class=s1>&#39;minmax&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>Min-Max归一化结果:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最小值: </span><span class=si>{</span><span class=n>minmax_data</span><span class=o>.</span><span class=n>min</span><span class=p>()</span><span class=o>.</span><span class=n>round</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最大值: </span><span class=si>{</span><span class=n>minmax_data</span><span class=o>.</span><span class=n>max</span><span class=p>()</span><span class=o>.</span><span class=n>round</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=数据存储与管理>数据存储与管理</h2><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DataManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;数据管理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>base_path</span><span class=o>=</span><span class=s1>&#39;data&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>base_path</span> <span class=o>=</span> <span class=n>base_path</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metadata</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 创建数据目录</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>base_path</span><span class=si>}</span><span class=s2>/raw&#34;</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>base_path</span><span class=si>}</span><span class=s2>/processed&#34;</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>base_path</span><span class=si>}</span><span class=s2>/features&#34;</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>save_raw_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>symbol</span><span class=p>,</span> <span class=n>date_range</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;保存原始数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>filename</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>base_path</span><span class=si>}</span><span class=s2>/raw/</span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=n>date_range</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=n>date_range</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s2>.csv&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metadata</span><span class=p>[</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2>_raw&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;filename&#39;</span><span class=p>:</span> <span class=n>filename</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;symbol&#39;</span><span class=p>:</span> <span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;date_range&#39;</span><span class=p>:</span> <span class=n>date_range</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;shape&#39;</span><span class=p>:</span> <span class=n>data</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;columns&#39;</span><span class=p>:</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>save_processed_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>symbol</span><span class=p>,</span> <span class=n>processing_steps</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;保存处理后的数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>filename</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>base_path</span><span class=si>}</span><span class=s2>/processed/</span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2>_processed.csv&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metadata</span><span class=p>[</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2>_processed&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;filename&#39;</span><span class=p>:</span> <span class=n>filename</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;symbol&#39;</span><span class=p>:</span> <span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;processing_steps&#39;</span><span class=p>:</span> <span class=n>processing_steps</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;shape&#39;</span><span class=p>:</span> <span class=n>data</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;columns&#39;</span><span class=p>:</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>save_feature_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>symbol</span><span class=p>,</span> <span class=n>feature_types</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;保存特征数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>filename</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>base_path</span><span class=si>}</span><span class=s2>/features/</span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2>_features.csv&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metadata</span><span class=p>[</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2>_features&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;filename&#39;</span><span class=p>:</span> <span class=n>filename</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;symbol&#39;</span><span class=p>:</span> <span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;feature_types&#39;</span><span class=p>:</span> <span class=n>feature_types</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;shape&#39;</span><span class=p>:</span> <span class=n>data</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;columns&#39;</span><span class=p>:</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>load_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>symbol</span><span class=p>,</span> <span class=n>data_type</span><span class=o>=</span><span class=s1>&#39;raw&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;加载数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=n>data_type</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>metadata</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>filename</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>metadata</span><span class=p>[</span><span class=n>key</span><span class=p>][</span><span class=s1>&#39;filename&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_csv</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>parse_dates</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>index_col</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;未找到 </span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2> 的 </span><span class=si>{</span><span class=n>data_type</span><span class=si>}</span><span class=s2> 数据&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_data_info</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>symbol</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取数据信息&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>symbol</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>metadata</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>symbol_metadata</span> <span class=o>=</span> <span class=p>{</span><span class=n>k</span><span class=p>:</span> <span class=n>v</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>items</span><span class=p>()</span> <span class=k>if</span> <span class=n>k</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>symbol</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>symbol_metadata</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>save_metadata</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>filename</span><span class=o>=</span><span class=s1>&#39;data_metadata.json&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;保存元数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>metadata</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=nb>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>load_metadata</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>filename</span><span class=o>=</span><span class=s1>&#39;data_metadata.json&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;加载元数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>metadata</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>FileNotFoundError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;元数据文件不存在&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试数据管理</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 数据管理测试 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>data_manager</span> <span class=o>=</span> <span class=n>DataManager</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 保存不同类型的数据</span>
</span></span><span class=line><span class=cl><span class=n>data_manager</span><span class=o>.</span><span class=n>save_raw_data</span><span class=p>(</span><span class=n>sample_stock</span><span class=p>,</span> <span class=s1>&#39;AAPL&#39;</span><span class=p>,</span> <span class=p>(</span><span class=s1>&#39;2023-01-01&#39;</span><span class=p>,</span> <span class=s1>&#39;2023-12-31&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>data_manager</span><span class=o>.</span><span class=n>save_processed_data</span><span class=p>(</span><span class=n>enhanced_data</span><span class=p>,</span> <span class=s1>&#39;AAPL&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;standardization&#39;</span><span class=p>,</span> <span class=s1>&#39;outlier_removal&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>data_manager</span><span class=o>.</span><span class=n>save_feature_data</span><span class=p>(</span><span class=n>all_features</span><span class=p>,</span> <span class=s1>&#39;AAPL&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;technical&#39;</span><span class=p>,</span> <span class=s1>&#39;time_series&#39;</span><span class=p>,</span> <span class=s1>&#39;risk&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看数据信息</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;数据管理信息:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>info</span> <span class=ow>in</span> <span class=n>data_manager</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>info</span><span class=p>[</span><span class=s1>&#39;shape&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 保存元数据</span>
</span></span><span class=line><span class=cl><span class=n>data_manager</span><span class=o>.</span><span class=n>save_metadata</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>元数据已保存&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=量化交易中的数据处理>量化交易中的数据处理</h2><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>QuantDataProcessor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;量化数据处理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data_pipeline</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_training_dataset</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>target_column</span><span class=p>,</span> <span class=n>lookback_window</span><span class=o>=</span><span class=mi>60</span><span class=p>,</span> <span class=n>prediction_horizon</span><span class=o>=</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;创建训练数据集&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>X</span><span class=p>,</span> <span class=n>y</span> <span class=o>=</span> <span class=p>[],</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>lookback_window</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=o>-</span> <span class=n>prediction_horizon</span> <span class=o>+</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 特征数据（回顾窗口）</span>
</span></span><span class=line><span class=cl>            <span class=n>X</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>lookback_window</span><span class=p>:</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 目标数据（预测未来）</span>
</span></span><span class=line><span class=cl>            <span class=n>future_return</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>target_column</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=n>prediction_horizon</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>/</span> <span class=n>data</span><span class=p>[</span><span class=n>target_column</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>y</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>future_return</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>X</span><span class=p>),</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_classification_dataset</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>target_column</span><span class=p>,</span> <span class=n>lookback_window</span><span class=o>=</span><span class=mi>60</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;创建分类数据集&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>X</span><span class=p>,</span> <span class=n>y</span> <span class=o>=</span> <span class=p>[],</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>lookback_window</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 特征数据</span>
</span></span><span class=line><span class=cl>            <span class=n>X</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>lookback_window</span><span class=p>:</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 分类标签（上涨为1，下跌为0）</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>data</span><span class=p>[</span><span class=n>target_column</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>data</span><span class=p>[</span><span class=n>target_column</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>y</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>y</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>X</span><span class=p>),</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>split_time_series_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>train_ratio</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span> <span class=n>val_ratio</span><span class=o>=</span><span class=mf>0.15</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;时间序列数据分割&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>n_samples</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>train_size</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>n_samples</span> <span class=o>*</span> <span class=n>train_ratio</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>val_size</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>n_samples</span> <span class=o>*</span> <span class=n>val_ratio</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>X_train</span> <span class=o>=</span> <span class=n>X</span><span class=p>[:</span><span class=n>train_size</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>y_train</span> <span class=o>=</span> <span class=n>y</span><span class=p>[:</span><span class=n>train_size</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>X_val</span> <span class=o>=</span> <span class=n>X</span><span class=p>[</span><span class=n>train_size</span><span class=p>:</span><span class=n>train_size</span> <span class=o>+</span> <span class=n>val_size</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>y_val</span> <span class=o>=</span> <span class=n>y</span><span class=p>[</span><span class=n>train_size</span><span class=p>:</span><span class=n>train_size</span> <span class=o>+</span> <span class=n>val_size</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>X_test</span> <span class=o>=</span> <span class=n>X</span><span class=p>[</span><span class=n>train_size</span> <span class=o>+</span> <span class=n>val_size</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>        <span class=n>y_test</span> <span class=o>=</span> <span class=n>y</span><span class=p>[</span><span class=n>train_size</span> <span class=o>+</span> <span class=n>val_size</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>X_train</span><span class=p>,</span> <span class=n>X_val</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>y_val</span><span class=p>,</span> <span class=n>y_test</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_label_weights</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>y</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算标签权重（用于处理类别不平衡）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>unique</span><span class=p>,</span> <span class=n>counts</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>unique</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>return_counts</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>total</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>weights</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>label</span><span class=p>,</span> <span class=n>count</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>unique</span><span class=p>,</span> <span class=n>counts</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>weights</span><span class=p>[</span><span class=n>label</span><span class=p>]</span> <span class=o>=</span> <span class=n>total</span> <span class=o>/</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>unique</span><span class=p>)</span> <span class=o>*</span> <span class=n>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>weights</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_factor_dataset</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>factors</span><span class=p>,</span> <span class=n>target_return_period</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;创建因子数据集&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_data</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>factors</span><span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算未来收益率作为目标</span>
</span></span><span class=line><span class=cl>        <span class=n>future_returns</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>(</span><span class=n>target_return_period</span><span class=p>)</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=o>-</span><span class=n>target_return_period</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 合并因子和目标</span>
</span></span><span class=line><span class=cl>        <span class=n>dataset</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>factor_data</span><span class=p>,</span> <span class=n>future_returns</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=s1>&#39;target_return&#39;</span><span class=p>)],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 删除缺失值</span>
</span></span><span class=line><span class=cl>        <span class=n>dataset</span> <span class=o>=</span> <span class=n>dataset</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>X</span> <span class=o>=</span> <span class=n>dataset</span><span class=p>[</span><span class=n>factors</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>=</span> <span class=n>dataset</span><span class=p>[</span><span class=s1>&#39;target_return&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>dataset</span><span class=o>.</span><span class=n>index</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试量化数据处理</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 量化数据处理测试 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>quant_processor</span> <span class=o>=</span> <span class=n>QuantDataProcessor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 准备数据（使用前面处理好的数据）</span>
</span></span><span class=line><span class=cl><span class=n>feature_columns</span> <span class=o>=</span> <span class=p>[</span><span class=n>col</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>final_data</span><span class=o>.</span><span class=n>columns</span> <span class=k>if</span> <span class=n>col</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>,</span> <span class=s1>&#39;amount&#39;</span><span class=p>,</span> <span class=s1>&#39;symbol&#39;</span><span class=p>]]</span>
</span></span><span class=line><span class=cl><span class=n>sample_features</span> <span class=o>=</span> <span class=n>final_data</span><span class=p>[</span><span class=n>feature_columns</span><span class=p>]</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建训练数据集</span>
</span></span><span class=line><span class=cl><span class=n>X</span><span class=p>,</span> <span class=n>y</span> <span class=o>=</span> <span class=n>quant_processor</span><span class=o>.</span><span class=n>create_training_dataset</span><span class=p>(</span><span class=n>sample_features</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=n>lookback_window</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span> <span class=n>prediction_horizon</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;训练数据集: X shape = </span><span class=si>{</span><span class=n>X</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>, y shape = </span><span class=si>{</span><span class=n>y</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建分类数据集</span>
</span></span><span class=line><span class=cl><span class=n>X_class</span><span class=p>,</span> <span class=n>y_class</span> <span class=o>=</span> <span class=n>quant_processor</span><span class=o>.</span><span class=n>create_classification_dataset</span><span class=p>(</span><span class=n>sample_features</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=n>lookback_window</span><span class=o>=</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;分类数据集: X shape = </span><span class=si>{</span><span class=n>X_class</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>, y shape = </span><span class=si>{</span><span class=n>y_class</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 数据分割</span>
</span></span><span class=line><span class=cl><span class=n>X_train</span><span class=p>,</span> <span class=n>X_val</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>y_val</span><span class=p>,</span> <span class=n>y_test</span> <span class=o>=</span> <span class=n>quant_processor</span><span class=o>.</span><span class=n>split_time_series_data</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;数据分割完成:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  训练集: </span><span class=si>{</span><span class=n>X_train</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> 样本&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  验证集: </span><span class=si>{</span><span class=n>X_val</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> 样本&#34;</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  测试集: </span><span class=si>{</span><span class=n>X_test</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> 样本&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 计算标签权重</span>
</span></span><span class=line><span class=cl><span class=n>class_weights</span> <span class=o>=</span> <span class=n>quant_processor</span><span class=o>.</span><span class=n>calculate_label_weights</span><span class=p>(</span><span class=n>y_class</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>类别权重: </span><span class=si>{</span><span class=n>class_weights</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=实践练习>实践练习</h2><h3 id=练习1构建完整的数据处理管道>练习1：构建完整的数据处理管道</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>build_complete_data_pipeline</span><span class=p>(</span><span class=n>symbol</span><span class=p>,</span> <span class=n>start_date</span><span class=p>,</span> <span class=n>end_date</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;构建完整的数据处理管道&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;=== 构建 </span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2> 的完整数据处理管道 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 1. 数据获取</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;1. 数据获取...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>raw_data</span> <span class=o>=</span> <span class=n>get_yahoo_data</span><span class=p>(</span><span class=n>symbol</span><span class=p>,</span> <span class=n>start_date</span><span class=p>,</span> <span class=n>end_date</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>raw_data</span><span class=o>.</span><span class=n>empty</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;数据获取失败&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 2. 数据预处理</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;2. 数据预处理...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>preprocessor</span> <span class=o>=</span> <span class=n>DataPreprocessor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>processed_data</span> <span class=o>=</span> <span class=n>preprocessor</span><span class=o>.</span><span class=n>standardize_columns</span><span class=p>(</span><span class=n>raw_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>processed_data</span> <span class=o>=</span> <span class=n>preprocessor</span><span class=o>.</span><span class=n>standardize_data_types</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>processed_data</span> <span class=o>=</span> <span class=n>preprocessor</span><span class=o>.</span><span class=n>validate_price_logic</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>processed_data</span> <span class=o>=</span> <span class=n>preprocessor</span><span class=o>.</span><span class=n>add_calculated_fields</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 3. 异常值检测与处理</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;3. 异常值处理...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>detector</span> <span class=o>=</span> <span class=n>OutlierDetector</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>processed_data</span> <span class=o>=</span> <span class=n>detector</span><span class=o>.</span><span class=n>handle_outliers</span><span class=p>(</span><span class=n>processed_data</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;winsorize&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>processed_data</span> <span class=o>=</span> <span class=n>processed_data</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 4. 技术指标计算</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;4. 技术指标计算...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>indicator_calculator</span> <span class=o>=</span> <span class=n>TechnicalIndicators</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>tech_indicators</span> <span class=o>=</span> <span class=n>indicator_calculator</span><span class=o>.</span><span class=n>calculate_all_indicators</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>enhanced_data</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>processed_data</span><span class=p>,</span> <span class=n>tech_indicators</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 5. 特征工程</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;5. 特征工程...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>feature_engineer</span> <span class=o>=</span> <span class=n>FeatureEngineer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>all_features</span> <span class=o>=</span> <span class=n>feature_engineer</span><span class=o>.</span><span class=n>create_all_features</span><span class=p>(</span><span class=n>enhanced_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>final_data</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>enhanced_data</span><span class=p>,</span> <span class=n>all_features</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 6. 数据清洗</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;6. 数据清洗...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>final_data</span> <span class=o>=</span> <span class=n>final_data</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>final_data</span> <span class=o>=</span> <span class=n>final_data</span><span class=o>.</span><span class=n>replace</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> <span class=o>-</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;数据处理完成！&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;原始数据维度: </span><span class=si>{</span><span class=n>raw_data</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最终数据维度: </span><span class=si>{</span><span class=n>final_data</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;特征数量: </span><span class=si>{</span><span class=n>final_data</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>raw_data</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>final_data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行完整的数据处理管道</span>
</span></span><span class=line><span class=cl><span class=n>complete_data</span> <span class=o>=</span> <span class=n>build_complete_data_pipeline</span><span class=p>(</span><span class=s2>&#34;AAPL&#34;</span><span class=p>,</span> <span class=s2>&#34;2022-01-01&#34;</span><span class=p>,</span> <span class=s2>&#34;2023-12-31&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>complete_data</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>完整数据处理管道结果:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>complete_data</span><span class=o>.</span><span class=n>tail</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>数据列: </span><span class=si>{</span><span class=n>complete_data</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=练习2多股票数据处理与比较>练习2：多股票数据处理与比较</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_multiple_stocks</span><span class=p>(</span><span class=n>symbols</span><span class=p>,</span> <span class=n>start_date</span><span class=p>,</span> <span class=n>end_date</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;处理多只股票数据并进行比较&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;=== 处理多只股票数据 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>symbol</span> <span class=ow>in</span> <span class=n>symbols</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>处理 </span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 构建数据处理管道</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>build_complete_data_pipeline</span><span class=p>(</span><span class=n>symbol</span><span class=p>,</span> <span class=n>start_date</span><span class=p>,</span> <span class=n>end_date</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>data</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;data&#39;</span><span class=p>:</span> <span class=n>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;shape&#39;</span><span class=p>:</span> <span class=n>data</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;features&#39;</span><span class=p>:</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;basic_stats&#39;</span><span class=p>:</span> <span class=n>data</span><span class=o>.</span><span class=n>describe</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 比较分析</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 多股票数据比较 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 数据维度比较</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;数据维度比较:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>symbol</span><span class=p>,</span> <span class=n>result</span> <span class=ow>in</span> <span class=n>results</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;shape&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> 行 × </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;shape&#39;</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s2> 列&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 收益率比较</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>收益率统计比较:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>symbol</span><span class=p>,</span> <span class=n>result</span> <span class=ow>in</span> <span class=n>results</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;return&#39;</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;data&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>returns</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;data&#39;</span><span class=p>][</span><span class=s1>&#39;return&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2>:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;    平均日收益率: </span><span class=si>{</span><span class=n>returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;    收益率标准差: </span><span class=si>{</span><span class=n>returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;    夏普比率: </span><span class=si>{</span><span class=n>returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>/</span> <span class=n>returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试多股票处理</span>
</span></span><span class=line><span class=cl><span class=n>multi_stock_results</span> <span class=o>=</span> <span class=n>process_multiple_stocks</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=s1>&#39;AAPL&#39;</span><span class=p>,</span> <span class=s1>&#39;MSFT&#39;</span><span class=p>,</span> <span class=s1>&#39;GOOGL&#39;</span><span class=p>,</span> <span class=s1>&#39;AMZN&#39;</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;2022-01-01&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;2023-12-31&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=练习3数据质量评估报告>练习3：数据质量评估报告</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_data_quality_report</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>symbol</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;生成数据质量评估报告&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;=== </span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2> 数据质量评估报告 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>report</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;symbol&#39;</span><span class=p>:</span> <span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;basic_info&#39;</span><span class=p>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;missing_values&#39;</span><span class=p>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;outliers&#39;</span><span class=p>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;statistical_tests&#39;</span><span class=p>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;recommendations&#39;</span><span class=p>:</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 基本信息</span>
</span></span><span class=line><span class=cl>    <span class=n>report</span><span class=p>[</span><span class=s1>&#39;basic_info&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;total_rows&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;total_columns&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;date_range&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>min</span><span class=p>()</span><span class=si>}</span><span class=s2> to </span><span class=si>{</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>max</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;trading_days&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;基本信息:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  总行数: </span><span class=si>{</span><span class=n>report</span><span class=p>[</span><span class=s1>&#39;basic_info&#39;</span><span class=p>][</span><span class=s1>&#39;total_rows&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  总列数: </span><span class=si>{</span><span class=n>report</span><span class=p>[</span><span class=s1>&#39;basic_info&#39;</span><span class=p>][</span><span class=s1>&#39;total_columns&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  日期范围: </span><span class=si>{</span><span class=n>report</span><span class=p>[</span><span class=s1>&#39;basic_info&#39;</span><span class=p>][</span><span class=s1>&#39;date_range&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 缺失值分析</span>
</span></span><span class=line><span class=cl>    <span class=n>missing_counts</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>isnull</span><span class=p>()</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>missing_percentages</span> <span class=o>=</span> <span class=p>(</span><span class=n>missing_counts</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>))</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>report</span><span class=p>[</span><span class=s1>&#39;missing_values&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;total_missing&#39;</span><span class=p>:</span> <span class=n>missing_counts</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;columns_with_missing&#39;</span><span class=p>:</span> <span class=n>missing_counts</span><span class=p>[</span><span class=n>missing_counts</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>to_dict</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;missing_percentages&#39;</span><span class=p>:</span> <span class=n>missing_percentages</span><span class=p>[</span><span class=n>missing_percentages</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>to_dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>缺失值分析:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>report</span><span class=p>[</span><span class=s1>&#39;missing_values&#39;</span><span class=p>][</span><span class=s1>&#39;columns_with_missing&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>col</span><span class=p>,</span> <span class=n>count</span> <span class=ow>in</span> <span class=n>report</span><span class=p>[</span><span class=s1>&#39;missing_values&#39;</span><span class=p>][</span><span class=s1>&#39;columns_with_missing&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>pct</span> <span class=o>=</span> <span class=n>report</span><span class=p>[</span><span class=s1>&#39;missing_values&#39;</span><span class=p>][</span><span class=s1>&#39;missing_percentages&#39;</span><span class=p>][</span><span class=n>col</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>col</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>count</span><span class=si>}</span><span class=s2> 缺失 (</span><span class=si>{</span><span class=n>pct</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;  无缺失值&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 异常值检测</span>
</span></span><span class=line><span class=cl>    <span class=n>numeric_columns</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>select_dtypes</span><span class=p>(</span><span class=n>include</span><span class=o>=</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>number</span><span class=p>])</span><span class=o>.</span><span class=n>columns</span>
</span></span><span class=line><span class=cl>    <span class=n>detector</span> <span class=o>=</span> <span class=n>OutlierDetector</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>,</span> <span class=s1>&#39;return&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>numeric_columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>outlier_result</span> <span class=o>=</span> <span class=n>detector</span><span class=o>.</span><span class=n>detect_outliers_iqr</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>col</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>report</span><span class=p>[</span><span class=s1>&#39;outliers&#39;</span><span class=p>][</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;count&#39;</span><span class=p>:</span> <span class=n>outlier_result</span><span class=p>[</span><span class=s1>&#39;count&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;percentage&#39;</span><span class=p>:</span> <span class=n>outlier_result</span><span class=p>[</span><span class=s1>&#39;percentage&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;bounds&#39;</span><span class=p>:</span> <span class=n>outlier_result</span><span class=p>[</span><span class=s1>&#39;bounds&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=n>col</span><span class=si>}</span><span class=s2> 异常值检测:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  异常值数量: </span><span class=si>{</span><span class=n>outlier_result</span><span class=p>[</span><span class=s1>&#39;count&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  异常值比例: </span><span class=si>{</span><span class=n>outlier_result</span><span class=p>[</span><span class=s1>&#39;percentage&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  异常值边界: </span><span class=si>{</span><span class=n>outlier_result</span><span class=p>[</span><span class=s1>&#39;bounds&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 统计检验</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;return&#39;</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>returns</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;return&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 正态性检验</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>scipy</span> <span class=kn>import</span> <span class=n>stats</span>
</span></span><span class=line><span class=cl>        <span class=n>_</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>jarque_bera</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>report</span><span class=p>[</span><span class=s1>&#39;statistical_tests&#39;</span><span class=p>][</span><span class=s1>&#39;normality_test&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;p_value&#39;</span><span class=p>:</span> <span class=n>p_value</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;is_normal&#39;</span><span class=p>:</span> <span class=n>p_value</span> <span class=o>&gt;</span> <span class=mf>0.05</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>统计检验:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  收益率正态性检验 p值: </span><span class=si>{</span><span class=n>p_value</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  是否服从正态分布: </span><span class=si>{</span><span class=n>p_value</span> <span class=o>&gt;</span> <span class=mf>0.05</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 建议</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>report</span><span class=p>[</span><span class=s1>&#39;missing_values&#39;</span><span class=p>][</span><span class=s1>&#39;total_missing&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>report</span><span class=p>[</span><span class=s1>&#39;recommendations&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;建议处理缺失值，可使用前向填充或插值方法&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>col</span><span class=p>,</span> <span class=n>outlier_info</span> <span class=ow>in</span> <span class=n>report</span><span class=p>[</span><span class=s1>&#39;outliers&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>outlier_info</span><span class=p>[</span><span class=s1>&#39;percentage&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>report</span><span class=p>[</span><span class=s1>&#39;recommendations&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>col</span><span class=si>}</span><span class=s2> 异常值比例较高(</span><span class=si>{</span><span class=n>outlier_info</span><span class=p>[</span><span class=s1>&#39;percentage&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%)，建议进行异常值处理&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>report</span><span class=p>[</span><span class=s1>&#39;statistical_tests&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;normality_test&#39;</span><span class=p>,</span> <span class=p>{})</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;is_normal&#39;</span><span class=p>,</span> <span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>report</span><span class=p>[</span><span class=s1>&#39;recommendations&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;收益率不服从正态分布，在建模时需考虑使用稳健方法&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>建议:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>recommendation</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>report</span><span class=p>[</span><span class=s1>&#39;recommendations&#39;</span><span class=p>],</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>. </span><span class=si>{</span><span class=n>recommendation</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>report</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 生成数据质量报告</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>complete_data</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>quality_report</span> <span class=o>=</span> <span class=n>generate_data_quality_report</span><span class=p>(</span><span class=n>complete_data</span><span class=p>,</span> <span class=s2>&#34;AAPL&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=总结>总结</h2><p>本讲我们全面学习了数据获取与处理的核心技能，包括：</p><h3 id=核心知识点>核心知识点</h3><ol><li><p><strong>数据获取</strong>：学习了多种数据源（Yahoo Finance、Tushare、模拟数据）的获取方法，包括批量获取、实时数据获取和重试机制</p></li><li><p><strong>数据预处理</strong>：掌握了数据格式标准化、缺失值处理、重复值去除、价格逻辑验证等关键技术</p></li><li><p><strong>异常值检测</strong>：学习了IQR、Z-score、MAD等多种异常值检测方法，以及缩尾处理、移除等处理策略</p></li><li><p><strong>特征工程</strong>：深入学习了技术指标计算、滞后特征、滚动窗口特征、时间特征、风险特征等的构造方法</p></li><li><p><strong>时间序列处理</strong>：掌握了季节性检测、时间序列分解、平稳性检验等时间序列分析方法</p></li><li><p><strong>数据标准化</strong>：学习了Z-score、Min-Max、鲁棒标准化等多种标准化方法</p></li><li><p><strong>数据管理</strong>：建立了完整的数据存储和管理体系，包括元数据管理</p></li><li><p><strong>量化数据处理</strong>：专门学习了量化交易中的数据处理方法，如训练数据集创建、时间序列分割等</p></li></ol><h3 id=实践应用>实践应用</h3><p>通过三个实践练习，我们：</p><ul><li>构建了完整的数据处理管道</li><li>实现了多股票数据的批量处理与比较</li><li>开发了数据质量评估报告生成工具</li></ul><h3 id=最佳实践建议>最佳实践建议</h3><ol><li><strong>数据质量优先</strong>：始终优先确保数据质量，再进行后续分析</li><li><strong>建立标准化流程</strong>：建立统一的数据处理标准和流程</li><li><strong>完整的元数据管理</strong>：详细记录数据处理过程和参数</li><li><strong>异常值合理处理</strong>：根据业务场景选择合适的异常值处理方法</li><li><strong>特征工程系统化</strong>：建立特征库，便于策略开发和优化</li></ol><p>高质量的数据处理是量化策略成功的基础。掌握这些技能后，我们就能够为后续的量化策略开发提供可靠的数据支撑。</p><h2 id=扩展阅读>扩展阅读</h2><ul><li>《Python金融大数据分析》- Yves Hilpisch</li><li>《量化交易：如何建立自己的算法交易事业》- Ernest P. Chan</li><li>Pandas官方文档：https://pandas.pydata.org/docs/</li><li>NumPy官方文档：https://numpy.org/doc/</li><li>scikit-learn预处理模块：https://scikit-learn.org/stable/modules/preprocessing.html</li></ul></div></article><aside class="lg:w-80 xl:w-96"><div class=space-y-8></div></aside></div><nav class="border-t border-gray-200 mt-12 pt-8"><div class="flex justify-between items-center"><a href=/blog/%E6%8A%95%E8%B5%84%E7%90%86%E8%AE%BA/%E5%AE%8F%E8%A7%82%E5%88%86%E6%9E%90/07-%E7%BB%8F%E6%B5%8E%E5%91%A8%E6%9C%9F%E5%AF%B9%E8%82%A1%E5%B8%82%E7%9A%84%E5%BD%B1%E5%93%8D/ class="group flex items-center"><svg class="w-5 h-5 mr-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0 7-7m-7 7h18"/></svg><div><div class="text-sm text-gray-600">上一篇</div><div class="font-medium group-hover:text-primary-600">宏观分析第7讲：经济周期对股市的影响</div></div></a><a href=/blog/%E6%8A%95%E8%B5%84%E7%90%86%E8%AE%BA/%E5%AE%8F%E8%A7%82%E5%88%86%E6%9E%90/08-%E9%80%9A%E8%B4%A7%E8%86%A8%E8%83%80%E5%AF%B9%E8%82%A1%E5%B8%82%E7%9A%84%E5%BD%B1%E5%93%8D/ class="group flex items-center text-right"><div><div class="text-sm text-gray-600">Next Post</div><div class="font-medium group-hover:text-primary-600">宏观分析第8讲：通胀对股市的双重影响</div></div><svg class="w-5 h-5 ml-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0-7 7m7-7H3"/></svg></a></div></nav></div></div><footer class="bg-gray-50 py-12 border-t border-gray-200"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><div class="flex flex-col md:flex-row justify-between space-y-4 md:space-y-0"><div class=flex-1><div class="flex items-center space-x-3 mb-4"><a href=https://sk-quant.github.io/ class=inline-block><img src=/images/logo.svg alt=烧烤量化 class=h-6>
</a><span class="text-xl font-bold text-gray-900">烧烤量化</span></div><div class="flex space-x-3 p-2"><a href=https://linkedin.com/in/yourusername class="text-gray-600 hover:text-gray-900" target=_blank rel="noopener noreferrer"><span class=sr-only>LinkedIn</span>
<img src=/images/social/linkedin.svg alt=LinkedIn class="h-5 w-5">
</a><a href=https://bsky.app/profile/yourblueskyhandle class="text-gray-600 hover:text-gray-900" target=_blank rel="noopener noreferrer"><span class=sr-only>Bluesky</span>
<img src=/images/social/bluesky.svg alt=Bluesky class="h-5 w-5">
</a><a href=https://twitter.com/yourusername class="text-gray-600 hover:text-gray-900" target=_blank rel="noopener noreferrer"><span class=sr-only>Twitter (X)</span>
<img src=/images/social/twitter.svg alt=Twitter class="h-5 w-5">
</a><a href=https://github.com/yourusername class="text-gray-600 hover:text-gray-900" target=_blank rel="noopener noreferrer"><span class=sr-only>GitHub</span>
<img src=/images/social/github.svg alt=GitHub class="h-5 w-5"></a></div></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div></div><div class="mt-12 pt-8 border-t border-gray-200"><div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0"><p class="text-gray-600 text-sm">© 2025 烧烤量化. All rights reserved.</p><a href=https://chaoming.li class="text-sm text-gray-600 hover:text-primary-600" target=_blank rel="noopener noreferrer">Powered by sk-quant</a></div></div></div></footer><script>const mobileMenuButton=document.getElementById("mobile-menu-button");mobileMenuButton&&mobileMenuButton.addEventListener("click",function(){const e=document.getElementById("mobile-menu");e&&e.classList.toggle("hidden")})</script></body></html>