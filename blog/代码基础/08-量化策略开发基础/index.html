<!doctype html><html lang=zh-cn class=h-full><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-XXXXXXX")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XXXXXXXXXX")</script><title>代码基础第8讲：量化策略开发基础 | 烧烤量化</title>
<meta name=description content="从零开始学习量化策略开发，包括策略框架设计、技术指标实现、交易信号生成、风险管理等核心内容，为构建完整的量化交易系统奠定基础。"><meta name=author content="Ryan"><meta name=robots content="index, follow"><meta property="og:title" content="代码基础第8讲：量化策略开发基础 | 烧烤量化"><meta property="og:description" content="从零开始学习量化策略开发，包括策略框架设计、技术指标实现、交易信号生成、风险管理等核心内容，为构建完整的量化交易系统奠定基础。"><meta property="og:type" content="article"><meta property="og:url" content="https://sk-quant.github.io/blog/%E4%BB%A3%E7%A0%81%E5%9F%BA%E7%A1%80/08-%E9%87%8F%E5%8C%96%E7%AD%96%E7%95%A5%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/"><meta property="og:site_name" content="烧烤量化"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="代码基础第8讲：量化策略开发基础 | 烧烤量化"><meta name=twitter:description content="从零开始学习量化策略开发，包括策略框架设计、技术指标实现、交易信号生成、风险管理等核心内容，为构建完整的量化交易系统奠定基础。"><link rel=icon type=image/x-icon href=/images/favicon.ico><link rel=canonical href=https://sk-quant.github.io/blog/%E4%BB%A3%E7%A0%81%E5%9F%BA%E7%A1%80/08-%E9%87%8F%E5%8C%96%E7%AD%96%E7%95%A5%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel=stylesheet><link rel=stylesheet href="/css/main.min.1255c60f0805e580d846a005c9da456febfe5426dbcd39f66ba0ae2958126a2d.css"></head><body class="min-h-screen flex flex-col"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-XXXXXXX" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class="fixed top-0 left-0 right-0 z-50"><div class=mobile-menu-wrapper><input type=checkbox id=nav-toggle class=nav-toggle><header class="fixed w-full top-0 z-50 bg-white/80 backdrop-blur-sm border-b border-gray-100"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><nav class="flex items-center justify-between h-20"><a href=https://sk-quant.github.io/ class="flex items-center space-x-4"><img src=/images/logo.svg alt=烧烤量化 class=h-12>
<span class="text-3xl font-semibold text-gray-800">烧烤量化</span></a><div class="hidden md:flex items-center space-x-8"><a href=/path class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">学习路线</a><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化基础<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">回测平台</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化进阶<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">综合实战</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化高手<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股指期货</a></div></div></div><a href=/pricing class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">服务套餐</a></div><div class="hidden md:flex items-center space-x-4"><a href=/contact class="inline-flex items-center justify-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div><div class=md:hidden><label for=nav-toggle class="p-2 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-offset-2 transition-colors cursor-pointer"><svg class="w-6 h-6" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></label></div></nav></div><div class="nav-content md:hidden w-full fixed left-0 right-0 top-20 bg-white border-t border-gray-100 shadow-lg"><div class="w-full px-6 py-4"><a href=/path class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">学习路线</a><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化基础</div><div class=pl-4><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block text-gray-700 hover:text-primary-600 py-2">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block text-gray-700 hover:text-primary-600 py-2">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block text-gray-700 hover:text-primary-600 py-2">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block text-gray-700 hover:text-primary-600 py-2">回测平台</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化进阶</div><div class=pl-4><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block text-gray-700 hover:text-primary-600 py-2">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block text-gray-700 hover:text-primary-600 py-2">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block text-gray-700 hover:text-primary-600 py-2">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block text-gray-700 hover:text-primary-600 py-2">综合实战</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化高手</div><div class=pl-4><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block text-gray-700 hover:text-primary-600 py-2">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block text-gray-700 hover:text-primary-600 py-2">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block text-gray-700 hover:text-primary-600 py-2">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block text-gray-700 hover:text-primary-600 py-2">股指期货</a></div></div><a href=/pricing class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">服务套餐</a><div class="pt-4 space-y-4"><a href=/contact class="block text-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div></div></div></header><style>.mobile-menu-wrapper{position:relative}.nav-toggle{display:none}.nav-content{display:none}.nav-toggle:checked~header .nav-content{display:block}</style></div></div><div class=pt-20><div class="container mx-auto px-4 py-12"><div class="flex flex-col lg:flex-row gap-8 mb-12"><article class=flex-1><header class=mb-8><div class=mb-4><a href=/categories/%E4%BB%A3%E7%A0%81%E5%9F%BA%E7%A1%80 class="inline-block px-3 py-1 text-sm font-medium text-primary-600 bg-primary-50 rounded-full hover:bg-primary-100 mr-2">代码基础</a></div><h1 class="text-4xl font-bold mb-4">代码基础第8讲：量化策略开发基础</h1><div class="flex flex-col space-y-4"><div class="flex items-center justify-between text-sm text-gray-500"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7A4 4 0 118 7a4 4 0 018 0zm-4 7a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
<span>Ryan</span></div><div class="flex items-center space-x-6"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747.0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746.0-3.332.477-4.5 1.253"/></svg>
<span>35 分钟</span></div><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5A2 2 0 003 7v12a2 2 0 002 2z"/></svg>
<time datetime=2025-09-08>September 8, 2025</time></div></div></div><div class="flex items-center flex-wrap gap-2"><a href=/tags/2025 class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors duration-200">#2025</a></div></div></header><div class=mb-8><img src=/images/blog/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80.jpg alt=代码基础第8讲：量化策略开发基础 class="w-full h-auto rounded-lg" loading=lazy></div><div class="prose prose-lg max-w-none"><h2 id=学习目标>学习目标</h2><p>通过本讲的学习，你将掌握：</p><ul><li>量化策略的基本框架和开发流程</li><li>常用技术指标的Python实现</li><li>交易信号生成与优化方法</li><li>风险管理与仓位控制</li><li>策略评估与性能分析</li><li>多因子策略开发</li><li>事件驱动策略设计</li></ul><h2 id=目录>目录</h2><ol><li><a href=#%E9%87%8F%E5%8C%96%E7%AD%96%E7%95%A5%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5>量化策略基础概念</a></li><li><a href=#%E7%AD%96%E7%95%A5%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1>策略框架设计</a></li><li><a href=#%E6%8A%80%E6%9C%AF%E6%8C%87%E6%A0%87%E5%AE%9E%E7%8E%B0>技术指标实现</a></li><li><a href=#%E4%BA%A4%E6%98%93%E4%BF%A1%E5%8F%B7%E7%94%9F%E6%88%90>交易信号生成</a></li><li><a href=#%E9%A3%8E%E9%99%A9%E7%AE%A1%E7%90%86%E4%B8%8E%E4%BB%93%E4%BD%8D%E6%8E%A7%E5%88%B6>风险管理与仓位控制</a></li><li><a href=#%E7%AD%96%E7%95%A5%E5%9B%9E%E6%B5%8B%E6%A1%86%E6%9E%B6>策略回测框架</a></li><li><a href=#%E5%A4%9A%E5%9B%A0%E5%AD%90%E7%AD%96%E7%95%A5%E5%BC%80%E5%8F%91>多因子策略开发</a></li><li><a href=#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E7%AD%96%E7%95%A5>事件驱动策略</a></li><li><a href=#%E5%AE%9E%E8%B7%B5%E7%BB%83%E4%B9%A0>实践练习</a></li><li><a href=#%E6%80%BB%E7%BB%93%E4%B8%8E%E6%89%A9%E5%B1%95%E9%98%85%E8%AF%BB>总结与扩展阅读</a></li></ol><h2 id=量化策略基础概念>量化策略基础概念</h2><h3 id=什么是量化策略>什么是量化策略</h3><p>量化策略是利用数学模型和计算机算法进行投资决策的方法。它将交易逻辑转化为可量化的规则，通过历史数据回测验证策略有效性，并在实盘中自动执行。</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>QuantStrategy</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;量化策略基类&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>name</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>description</span> <span class=o>=</span> <span class=n>description</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>signals</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>positions</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_signals</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成交易信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>NotImplementedError</span><span class=p>(</span><span class=s2>&#34;子类必须实现此方法&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_position_size</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>signal</span><span class=p>,</span> <span class=n>portfolio_value</span><span class=p>,</span> <span class=n>risk_per_trade</span><span class=o>=</span><span class=mf>0.02</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算仓位大小&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>NotImplementedError</span><span class=p>(</span><span class=s2>&#34;子类必须实现此方法&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>backtest</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>initial_capital</span><span class=o>=</span><span class=mi>100000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;策略回测&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>NotImplementedError</span><span class=p>(</span><span class=s2>&#34;子类必须实现此方法&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>evaluate_performance</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>returns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;评估策略表现&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>NotImplementedError</span><span class=p>(</span><span class=s2>&#34;子类必须实现此方法&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=策略开发流程>策略开发流程</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>StrategyDevelopmentPipeline</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;策略开发管道&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>steps</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;idea_generation&#39;</span><span class=p>,</span>      <span class=c1># 策略想法生成</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;data_preparation&#39;</span><span class=p>,</span>   <span class=c1># 数据准备</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;signal_generation&#39;</span><span class=p>,</span>  <span class=c1># 信号生成</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;risk_management&#39;</span><span class=p>,</span>    <span class=c1># 风险管理</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;backtesting&#39;</span><span class=p>,</span>        <span class=c1># 回测</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;optimization&#39;</span><span class=p>,</span>       <span class=c1># 优化</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;validation&#39;</span><span class=p>,</span>         <span class=c1># 验证</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;deployment&#39;</span>          <span class=c1># 部署</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>current_step</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>results</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run_step</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>step_name</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;运行指定步骤&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>step_name</span> <span class=o>==</span> <span class=s1>&#39;idea_generation&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_ideas</span><span class=p>(</span><span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>step_name</span> <span class=o>==</span> <span class=s1>&#39;data_preparation&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>prepare_data</span><span class=p>(</span><span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>step_name</span> <span class=o>==</span> <span class=s1>&#39;signal_generation&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_signals</span><span class=p>(</span><span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># ... 其他步骤</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_ideas</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>market_analysis</span><span class=p>,</span> <span class=n>technical_factors</span><span class=p>,</span> <span class=n>fundamental_factors</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成策略想法&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>ideas</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 基于技术分析的想法</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>factor</span> <span class=ow>in</span> <span class=n>technical_factors</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>ideas</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;technical&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;factor&#39;</span><span class=p>:</span> <span class=n>factor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;logic&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;当</span><span class=si>{</span><span class=n>factor</span><span class=si>}</span><span class=s2>显示超买时卖出，超卖时买入&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 基于基本面分析的想法</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>factor</span> <span class=ow>in</span> <span class=n>fundamental_factors</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>ideas</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;fundamental&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;factor&#39;</span><span class=p>:</span> <span class=n>factor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;logic&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;基于</span><span class=si>{</span><span class=n>factor</span><span class=si>}</span><span class=s2>的估值策略&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ideas</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=策略框架设计>策略框架设计</h2><h3 id=事件驱动策略框架>事件驱动策略框架</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>abc</span> <span class=kn>import</span> <span class=n>ABC</span><span class=p>,</span> <span class=n>abstractmethod</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MarketData</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;市场数据结构&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>symbol</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span><span class=p>:</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>    <span class=nb>open</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>high</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>low</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>close</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>volume</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Signal</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;交易信号结构&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>symbol</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span><span class=p>:</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>    <span class=n>signal_type</span><span class=p>:</span> <span class=nb>str</span>  <span class=c1># &#39;BUY&#39;, &#39;SELL&#39;, &#39;HOLD&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>strength</span><span class=p>:</span> <span class=nb>float</span>  <span class=c1># 信号强度</span>
</span></span><span class=line><span class=cl>    <span class=n>price</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>quantity</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>metadata</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>StrategyBase</span><span class=p>(</span><span class=n>ABC</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;策略基类&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>symbols</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>name</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>symbols</span> <span class=o>=</span> <span class=n>symbols</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>signals</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Signal</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>positions</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=n>symbol</span><span class=p>:</span> <span class=mi>0</span> <span class=k>for</span> <span class=n>symbol</span> <span class=ow>in</span> <span class=n>symbols</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cash</span> <span class=o>=</span> <span class=mi>100000</span>  <span class=c1># 初始资金</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>portfolio_value</span> <span class=o>=</span> <span class=mi>100000</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_active</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>on_market_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>MarketData</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理市场数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_signal</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>MarketData</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Signal</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成交易信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>on_signal</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>signal</span><span class=p>:</span> <span class=n>Signal</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理交易信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>signals</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 执行交易逻辑</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>signal</span><span class=o>.</span><span class=n>signal_type</span> <span class=o>==</span> <span class=s1>&#39;BUY&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>execute_buy</span><span class=p>(</span><span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>signal</span><span class=o>.</span><span class=n>signal_type</span> <span class=o>==</span> <span class=s1>&#39;SELL&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>execute_sell</span><span class=p>(</span><span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>execute_buy</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>signal</span><span class=p>:</span> <span class=n>Signal</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行买入&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>max_quantity</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>cash</span> <span class=o>/</span> <span class=n>signal</span><span class=o>.</span><span class=n>price</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>max_quantity</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>quantity</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>signal</span><span class=o>.</span><span class=n>quantity</span><span class=p>,</span> <span class=n>max_quantity</span><span class=p>)</span> <span class=k>if</span> <span class=n>signal</span><span class=o>.</span><span class=n>quantity</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=n>max_quantity</span>
</span></span><span class=line><span class=cl>            <span class=n>cost</span> <span class=o>=</span> <span class=n>quantity</span> <span class=o>*</span> <span class=n>signal</span><span class=o>.</span><span class=n>price</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>cash</span> <span class=o>-=</span> <span class=n>cost</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>positions</span><span class=p>[</span><span class=n>signal</span><span class=o>.</span><span class=n>symbol</span><span class=p>]</span> <span class=o>+=</span> <span class=n>quantity</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;买入 </span><span class=si>{</span><span class=n>signal</span><span class=o>.</span><span class=n>symbol</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>quantity</span><span class=si>}</span><span class=s2> 股 @ </span><span class=si>{</span><span class=n>signal</span><span class=o>.</span><span class=n>price</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>execute_sell</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>signal</span><span class=p>:</span> <span class=n>Signal</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行卖出&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>current_position</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>positions</span><span class=p>[</span><span class=n>signal</span><span class=o>.</span><span class=n>symbol</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>current_position</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>quantity</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>signal</span><span class=o>.</span><span class=n>quantity</span><span class=p>,</span> <span class=n>current_position</span><span class=p>)</span> <span class=k>if</span> <span class=n>signal</span><span class=o>.</span><span class=n>quantity</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=n>current_position</span>
</span></span><span class=line><span class=cl>            <span class=n>revenue</span> <span class=o>=</span> <span class=n>quantity</span> <span class=o>*</span> <span class=n>signal</span><span class=o>.</span><span class=n>price</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>cash</span> <span class=o>+=</span> <span class=n>revenue</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>positions</span><span class=p>[</span><span class=n>signal</span><span class=o>.</span><span class=n>symbol</span><span class=p>]</span> <span class=o>-=</span> <span class=n>quantity</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;卖出 </span><span class=si>{</span><span class=n>signal</span><span class=o>.</span><span class=n>symbol</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>quantity</span><span class=si>}</span><span class=s2> 股 @ </span><span class=si>{</span><span class=n>signal</span><span class=o>.</span><span class=n>price</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>update_portfolio_value</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>current_prices</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>float</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;更新组合价值&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>total_value</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cash</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>symbol</span><span class=p>,</span> <span class=n>position</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>positions</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>position</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>symbol</span> <span class=ow>in</span> <span class=n>current_prices</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>total_value</span> <span class=o>+=</span> <span class=n>position</span> <span class=o>*</span> <span class=n>current_prices</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>portfolio_value</span> <span class=o>=</span> <span class=n>total_value</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>total_value</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=技术指标策略框架>技术指标策略框架</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TechnicalStrategy</span><span class=p>(</span><span class=n>StrategyBase</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;基于技术指标的策略&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>symbols</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>symbols</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>indicators</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>lookback_period</span> <span class=o>=</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;rsi_period&#39;</span><span class=p>:</span> <span class=mi>14</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;rsi_overbought&#39;</span><span class=p>:</span> <span class=mi>70</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;rsi_oversold&#39;</span><span class=p>:</span> <span class=mi>30</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;ma_short&#39;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;ma_long&#39;</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;volume_threshold&#39;</span><span class=p>:</span> <span class=mf>1.5</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>on_market_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>MarketData</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理市场数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 更新技术指标</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>update_indicators</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 生成交易信号</span>
</span></span><span class=line><span class=cl>        <span class=n>signal</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_signal</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 如果信号有效，执行交易</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>signal</span> <span class=ow>and</span> <span class=n>signal</span><span class=o>.</span><span class=n>signal_type</span> <span class=o>!=</span> <span class=s1>&#39;HOLD&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>on_signal</span><span class=p>(</span><span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>update_indicators</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>MarketData</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;更新技术指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>symbol</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>symbol</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>symbol</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>indicators</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;prices&#39;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;volumes&#39;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;timestamps&#39;</span><span class=p>:</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 存储历史数据</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>symbol</span><span class=p>][</span><span class=s1>&#39;prices&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>symbol</span><span class=p>][</span><span class=s1>&#39;volumes&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>volume</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>symbol</span><span class=p>][</span><span class=s1>&#39;timestamps&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>timestamp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 保持数据长度</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>symbol</span><span class=p>][</span><span class=s1>&#39;prices&#39;</span><span class=p>])</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>lookback_period</span> <span class=o>*</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>symbol</span><span class=p>][</span><span class=s1>&#39;prices&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>symbol</span><span class=p>][</span><span class=s1>&#39;volumes&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>symbol</span><span class=p>][</span><span class=s1>&#39;timestamps&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_rsi</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>prices</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>],</span> <span class=n>period</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>14</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算RSI指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>period</span> <span class=o>+</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=mf>50.0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>deltas</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>prices</span><span class=p>[</span><span class=o>-</span><span class=p>(</span><span class=n>period</span> <span class=o>+</span> <span class=mi>1</span><span class=p>):])</span>
</span></span><span class=line><span class=cl>        <span class=n>gains</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>deltas</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span> <span class=n>deltas</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>losses</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>deltas</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=n>deltas</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>avg_gain</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>gains</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>avg_loss</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>losses</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>avg_loss</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=mf>100.0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>rs</span> <span class=o>=</span> <span class=n>avg_gain</span> <span class=o>/</span> <span class=n>avg_loss</span>
</span></span><span class=line><span class=cl>        <span class=n>rsi</span> <span class=o>=</span> <span class=mi>100</span> <span class=o>-</span> <span class=p>(</span><span class=mi>100</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>rs</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>rsi</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_moving_average</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>prices</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>],</span> <span class=n>window</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算移动平均线&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>window</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>prices</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>prices</span><span class=p>[</span><span class=o>-</span><span class=n>window</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_bollinger_bands</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>prices</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>],</span> <span class=n>window</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>20</span><span class=p>,</span> <span class=n>num_std</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算布林带&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>window</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>prices</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span> <span class=n>prices</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span> <span class=n>prices</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>ma</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>prices</span><span class=p>[</span><span class=o>-</span><span class=n>window</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>prices</span><span class=p>[</span><span class=o>-</span><span class=n>window</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>upper_band</span> <span class=o>=</span> <span class=n>ma</span> <span class=o>+</span> <span class=p>(</span><span class=n>std</span> <span class=o>*</span> <span class=n>num_std</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>lower_band</span> <span class=o>=</span> <span class=n>ma</span> <span class=o>-</span> <span class=p>(</span><span class=n>std</span> <span class=o>*</span> <span class=n>num_std</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>upper_band</span><span class=p>,</span> <span class=n>ma</span><span class=p>,</span> <span class=n>lower_band</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_signal</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>MarketData</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Signal</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成交易信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>symbol</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>symbol</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>symbol</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>indicators</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Signal</span><span class=p>(</span><span class=n>symbol</span><span class=p>,</span> <span class=n>data</span><span class=o>.</span><span class=n>timestamp</span><span class=p>,</span> <span class=s1>&#39;HOLD&#39;</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>prices</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>symbol</span><span class=p>][</span><span class=s1>&#39;prices&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>volumes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>symbol</span><span class=p>][</span><span class=s1>&#39;volumes&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span> <span class=o>&lt;</span> <span class=nb>max</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;ma_long&#39;</span><span class=p>],</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;rsi_period&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Signal</span><span class=p>(</span><span class=n>symbol</span><span class=p>,</span> <span class=n>data</span><span class=o>.</span><span class=n>timestamp</span><span class=p>,</span> <span class=s1>&#39;HOLD&#39;</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算技术指标</span>
</span></span><span class=line><span class=cl>        <span class=n>rsi</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_rsi</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;rsi_period&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>ma_short</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_moving_average</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;ma_short&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>ma_long</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_moving_average</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;ma_long&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>upper_band</span><span class=p>,</span> <span class=n>middle_band</span><span class=p>,</span> <span class=n>lower_band</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_bollinger_bands</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 成交量分析</span>
</span></span><span class=line><span class=cl>        <span class=n>avg_volume</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>volumes</span><span class=p>[</span><span class=o>-</span><span class=mi>10</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>        <span class=n>volume_ratio</span> <span class=o>=</span> <span class=n>volumes</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>/</span> <span class=n>avg_volume</span> <span class=k>if</span> <span class=n>avg_volume</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mf>1.0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 生成信号</span>
</span></span><span class=line><span class=cl>        <span class=n>signal_type</span> <span class=o>=</span> <span class=s1>&#39;HOLD&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>strength</span> <span class=o>=</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>        <span class=n>metadata</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;rsi&#39;</span><span class=p>:</span> <span class=n>rsi</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;ma_short&#39;</span><span class=p>:</span> <span class=n>ma_short</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;ma_long&#39;</span><span class=p>:</span> <span class=n>ma_long</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;bb_upper&#39;</span><span class=p>:</span> <span class=n>upper_band</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;bb_lower&#39;</span><span class=p>:</span> <span class=n>lower_band</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;volume_ratio&#39;</span><span class=p>:</span> <span class=n>volume_ratio</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># RSI策略</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>rsi</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;rsi_oversold&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>signal_type</span> <span class=o>=</span> <span class=s1>&#39;BUY&#39;</span>
</span></span><span class=line><span class=cl>            <span class=n>strength</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;rsi_oversold&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>rsi</span><span class=p>)</span> <span class=o>/</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;rsi_oversold&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>rsi</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;rsi_overbought&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>signal_type</span> <span class=o>=</span> <span class=s1>&#39;SELL&#39;</span>
</span></span><span class=line><span class=cl>            <span class=n>strength</span> <span class=o>=</span> <span class=p>(</span><span class=n>rsi</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;rsi_overbought&#39;</span><span class=p>])</span> <span class=o>/</span> <span class=p>(</span><span class=mi>100</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;rsi_overbought&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 均线策略</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>ma_short</span> <span class=o>&gt;</span> <span class=n>ma_long</span> <span class=ow>and</span> <span class=n>prices</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>ma_short</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>signal_type</span> <span class=o>==</span> <span class=s1>&#39;HOLD&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>signal_type</span> <span class=o>=</span> <span class=s1>&#39;BUY&#39;</span>
</span></span><span class=line><span class=cl>                <span class=n>strength</span> <span class=o>=</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>strength</span> <span class=o>+=</span> <span class=mf>0.3</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>ma_short</span> <span class=o>&lt;</span> <span class=n>ma_long</span> <span class=ow>and</span> <span class=n>prices</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>ma_short</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>signal_type</span> <span class=o>==</span> <span class=s1>&#39;HOLD&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>signal_type</span> <span class=o>=</span> <span class=s1>&#39;SELL&#39;</span>
</span></span><span class=line><span class=cl>                <span class=n>strength</span> <span class=o>=</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>strength</span> <span class=o>+=</span> <span class=mf>0.3</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 布林带策略</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>prices</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>lower_band</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>signal_type</span> <span class=o>==</span> <span class=s1>&#39;HOLD&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>signal_type</span> <span class=o>=</span> <span class=s1>&#39;BUY&#39;</span>
</span></span><span class=line><span class=cl>                <span class=n>strength</span> <span class=o>=</span> <span class=mf>0.7</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>strength</span> <span class=o>+=</span> <span class=mf>0.2</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>prices</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>upper_band</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>signal_type</span> <span class=o>==</span> <span class=s1>&#39;HOLD&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>signal_type</span> <span class=o>=</span> <span class=s1>&#39;SELL&#39;</span>
</span></span><span class=line><span class=cl>                <span class=n>strength</span> <span class=o>=</span> <span class=mf>0.7</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>strength</span> <span class=o>+=</span> <span class=mf>0.2</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 成交量确认</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>volume_ratio</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;volume_threshold&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>strength</span> <span class=o>*=</span> <span class=mf>1.2</span>  <span class=c1># 增强信号强度</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Signal</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>symbol</span><span class=o>=</span><span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>timestamp</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>timestamp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>signal_type</span><span class=o>=</span><span class=n>signal_type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>strength</span><span class=o>=</span><span class=nb>min</span><span class=p>(</span><span class=n>strength</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>price</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>metadata</span><span class=o>=</span><span class=n>metadata</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=技术指标实现>技术指标实现</h2><h3 id=趋势指标>趋势指标</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TrendIndicators</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;趋势指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>sma</span><span class=p>(</span><span class=n>prices</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>window</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;简单移动平均线&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>convolve</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>/</span><span class=n>window</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;valid&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>ema</span><span class=p>(</span><span class=n>prices</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>window</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;指数移动平均线&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>alpha</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>/</span> <span class=p>(</span><span class=n>window</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ema_values</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros_like</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ema_values</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>prices</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>ema_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>alpha</span> <span class=o>*</span> <span class=n>prices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>alpha</span><span class=p>)</span> <span class=o>*</span> <span class=n>ema_values</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ema_values</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>macd</span><span class=p>(</span><span class=n>prices</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>fast</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>12</span><span class=p>,</span> <span class=n>slow</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>26</span><span class=p>,</span> <span class=n>signal</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>9</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;MACD指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>ema_fast</span> <span class=o>=</span> <span class=n>TrendIndicators</span><span class=o>.</span><span class=n>ema</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=n>fast</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ema_slow</span> <span class=o>=</span> <span class=n>TrendIndicators</span><span class=o>.</span><span class=n>ema</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=n>slow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 确保数组长度一致</span>
</span></span><span class=line><span class=cl>        <span class=n>min_len</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>ema_fast</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>ema_slow</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>ema_fast</span> <span class=o>=</span> <span class=n>ema_fast</span><span class=p>[</span><span class=o>-</span><span class=n>min_len</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>        <span class=n>ema_slow</span> <span class=o>=</span> <span class=n>ema_slow</span><span class=p>[</span><span class=o>-</span><span class=n>min_len</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>macd_line</span> <span class=o>=</span> <span class=n>ema_fast</span> <span class=o>-</span> <span class=n>ema_slow</span>
</span></span><span class=line><span class=cl>        <span class=n>signal_line</span> <span class=o>=</span> <span class=n>TrendIndicators</span><span class=o>.</span><span class=n>ema</span><span class=p>(</span><span class=n>macd_line</span><span class=p>,</span> <span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>histogram</span> <span class=o>=</span> <span class=n>macd_line</span><span class=p>[</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>signal_line</span><span class=p>):]</span> <span class=o>-</span> <span class=n>signal_line</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;macd&#39;</span><span class=p>:</span> <span class=n>macd_line</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;signal&#39;</span><span class=p>:</span> <span class=n>signal_line</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;histogram&#39;</span><span class=p>:</span> <span class=n>histogram</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>adx</span><span class=p>(</span><span class=n>high</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>low</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>close</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>window</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>14</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;平均趋向指数&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 计算真实波幅(TR)</span>
</span></span><span class=line><span class=cl>        <span class=n>tr1</span> <span class=o>=</span> <span class=n>high</span> <span class=o>-</span> <span class=n>low</span>
</span></span><span class=line><span class=cl>        <span class=n>tr2</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>high</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>roll</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>tr3</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>low</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>roll</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>tr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>maximum</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>maximum</span><span class=p>(</span><span class=n>tr1</span><span class=p>,</span> <span class=n>tr2</span><span class=p>),</span> <span class=n>tr3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算方向运动(DM)</span>
</span></span><span class=line><span class=cl>        <span class=n>up_move</span> <span class=o>=</span> <span class=n>high</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>roll</span><span class=p>(</span><span class=n>high</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>down_move</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>roll</span><span class=p>(</span><span class=n>low</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>-</span> <span class=n>low</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>plus_dm</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>((</span><span class=n>up_move</span> <span class=o>&gt;</span> <span class=n>down_move</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>up_move</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>),</span> <span class=n>up_move</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>minus_dm</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>((</span><span class=n>down_move</span> <span class=o>&gt;</span> <span class=n>up_move</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>down_move</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>),</span> <span class=n>down_move</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算平滑值</span>
</span></span><span class=line><span class=cl>        <span class=n>tr_smooth</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>convolve</span><span class=p>(</span><span class=n>tr</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>/</span><span class=n>window</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;valid&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>plus_dm_smooth</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>convolve</span><span class=p>(</span><span class=n>plus_dm</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>/</span><span class=n>window</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;valid&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>minus_dm_smooth</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>convolve</span><span class=p>(</span><span class=n>minus_dm</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>/</span><span class=n>window</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;valid&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算方向指标</span>
</span></span><span class=line><span class=cl>        <span class=n>plus_di</span> <span class=o>=</span> <span class=mi>100</span> <span class=o>*</span> <span class=n>plus_dm_smooth</span> <span class=o>/</span> <span class=n>tr_smooth</span>
</span></span><span class=line><span class=cl>        <span class=n>minus_di</span> <span class=o>=</span> <span class=mi>100</span> <span class=o>*</span> <span class=n>minus_dm_smooth</span> <span class=o>/</span> <span class=n>tr_smooth</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算ADX</span>
</span></span><span class=line><span class=cl>        <span class=n>dx</span> <span class=o>=</span> <span class=mi>100</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>plus_di</span> <span class=o>-</span> <span class=n>minus_di</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>plus_di</span> <span class=o>+</span> <span class=n>minus_di</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>adx</span> <span class=o>=</span> <span class=n>TrendIndicators</span><span class=o>.</span><span class=n>ema</span><span class=p>(</span><span class=n>dx</span><span class=p>,</span> <span class=n>window</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>adx</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=动量指标>动量指标</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MomentumIndicators</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;动量指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>rsi</span><span class=p>(</span><span class=n>prices</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>window</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>14</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;相对强弱指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>deltas</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>gains</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>deltas</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span> <span class=n>deltas</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>losses</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>deltas</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=n>deltas</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算平均收益和损失</span>
</span></span><span class=line><span class=cl>        <span class=n>avg_gains</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>convolve</span><span class=p>(</span><span class=n>gains</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>/</span><span class=n>window</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;valid&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>avg_losses</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>convolve</span><span class=p>(</span><span class=n>losses</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>/</span><span class=n>window</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;valid&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算RSI</span>
</span></span><span class=line><span class=cl>        <span class=n>rs</span> <span class=o>=</span> <span class=n>avg_gains</span> <span class=o>/</span> <span class=p>(</span><span class=n>avg_losses</span> <span class=o>+</span> <span class=mf>1e-10</span><span class=p>)</span>  <span class=c1># 避免除零</span>
</span></span><span class=line><span class=cl>        <span class=n>rsi</span> <span class=o>=</span> <span class=mi>100</span> <span class=o>-</span> <span class=p>(</span><span class=mi>100</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>rs</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>rsi</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>stochastic</span><span class=p>(</span><span class=n>high</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>low</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>close</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                   <span class=n>window</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>14</span><span class=p>,</span> <span class=n>smooth_window</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;随机指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 计算最近window期间的最低点和最高点</span>
</span></span><span class=line><span class=cl>        <span class=n>lowest_low</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>min</span><span class=p>(</span><span class=n>low</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>window</span><span class=o>+</span><span class=mi>1</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>])</span> <span class=k>if</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=n>window</span><span class=o>-</span><span class=mi>1</span> <span class=k>else</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span> 
</span></span><span class=line><span class=cl>                              <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>low</span><span class=p>))])</span>
</span></span><span class=line><span class=cl>        <span class=n>highest_high</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>high</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>window</span><span class=o>+</span><span class=mi>1</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>])</span> <span class=k>if</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=n>window</span><span class=o>-</span><span class=mi>1</span> <span class=k>else</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span> 
</span></span><span class=line><span class=cl>                                <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>high</span><span class=p>))])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算%K</span>
</span></span><span class=line><span class=cl>        <span class=n>k_percent</span> <span class=o>=</span> <span class=mi>100</span> <span class=o>*</span> <span class=p>((</span><span class=n>close</span> <span class=o>-</span> <span class=n>lowest_low</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>highest_high</span> <span class=o>-</span> <span class=n>lowest_low</span> <span class=o>+</span> <span class=mf>1e-10</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算%D（%K的移动平均线）</span>
</span></span><span class=line><span class=cl>        <span class=n>d_percent</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>convolve</span><span class=p>(</span><span class=n>k_percent</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=n>smooth_window</span><span class=p>)</span><span class=o>/</span><span class=n>smooth_window</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;valid&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;k&#39;</span><span class=p>:</span> <span class=n>k_percent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;d&#39;</span><span class=p>:</span> <span class=n>d_percent</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>williams_r</span><span class=p>(</span><span class=n>high</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>low</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>close</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>window</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>14</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;威廉指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>highest_high</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>high</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>window</span><span class=o>+</span><span class=mi>1</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>])</span> <span class=k>if</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=n>window</span><span class=o>-</span><span class=mi>1</span> <span class=k>else</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span> 
</span></span><span class=line><span class=cl>                                <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>high</span><span class=p>))])</span>
</span></span><span class=line><span class=cl>        <span class=n>lowest_low</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>min</span><span class=p>(</span><span class=n>low</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>window</span><span class=o>+</span><span class=mi>1</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>])</span> <span class=k>if</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=n>window</span><span class=o>-</span><span class=mi>1</span> <span class=k>else</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span> 
</span></span><span class=line><span class=cl>                              <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>low</span><span class=p>))])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>williams_r</span> <span class=o>=</span> <span class=o>-</span><span class=mi>100</span> <span class=o>*</span> <span class=p>((</span><span class=n>highest_high</span> <span class=o>-</span> <span class=n>close</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>highest_high</span> <span class=o>-</span> <span class=n>lowest_low</span> <span class=o>+</span> <span class=mf>1e-10</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>williams_r</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>cci</span><span class=p>(</span><span class=n>high</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>low</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>close</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>window</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>20</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;商品通道指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 典型价格</span>
</span></span><span class=line><span class=cl>        <span class=n>typical_price</span> <span class=o>=</span> <span class=p>(</span><span class=n>high</span> <span class=o>+</span> <span class=n>low</span> <span class=o>+</span> <span class=n>close</span><span class=p>)</span> <span class=o>/</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 移动平均</span>
</span></span><span class=line><span class=cl>        <span class=n>ma</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>convolve</span><span class=p>(</span><span class=n>typical_price</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>/</span><span class=n>window</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;valid&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 平均绝对偏差</span>
</span></span><span class=line><span class=cl>        <span class=n>abs_dev</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>typical_price</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>window</span><span class=o>+</span><span class=mi>1</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>ma</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>window</span><span class=o>+</span><span class=mi>1</span><span class=p>])</span> <span class=k>if</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=n>window</span><span class=o>-</span><span class=mi>1</span> <span class=k>else</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span> 
</span></span><span class=line><span class=cl>                           <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>typical_price</span><span class=p>))])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># CCI计算</span>
</span></span><span class=line><span class=cl>        <span class=n>cci</span> <span class=o>=</span> <span class=p>(</span><span class=n>typical_price</span><span class=p>[</span><span class=n>window</span><span class=o>-</span><span class=mi>1</span><span class=p>:]</span> <span class=o>-</span> <span class=n>ma</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=mf>0.015</span> <span class=o>*</span> <span class=n>abs_dev</span><span class=p>[</span><span class=n>window</span><span class=o>-</span><span class=mi>1</span><span class=p>:]</span> <span class=o>+</span> <span class=mf>1e-10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>cci</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=波动率指标>波动率指标</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>VolatilityIndicators</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;波动率指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>bollinger_bands</span><span class=p>(</span><span class=n>prices</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>window</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>20</span><span class=p>,</span> <span class=n>num_std</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;布林带&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>ma</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>convolve</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>/</span><span class=n>window</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;valid&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>prices</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>window</span><span class=o>+</span><span class=mi>1</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>])</span> <span class=k>if</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=n>window</span><span class=o>-</span><span class=mi>1</span> <span class=k>else</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span> 
</span></span><span class=line><span class=cl>                       <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>))])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>upper_band</span> <span class=o>=</span> <span class=n>ma</span> <span class=o>+</span> <span class=p>(</span><span class=n>std</span><span class=p>[</span><span class=n>window</span><span class=o>-</span><span class=mi>1</span><span class=p>:]</span> <span class=o>*</span> <span class=n>num_std</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>lower_band</span> <span class=o>=</span> <span class=n>ma</span> <span class=o>-</span> <span class=p>(</span><span class=n>std</span><span class=p>[</span><span class=n>window</span><span class=o>-</span><span class=mi>1</span><span class=p>:]</span> <span class=o>*</span> <span class=n>num_std</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;upper&#39;</span><span class=p>:</span> <span class=n>upper_band</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;middle&#39;</span><span class=p>:</span> <span class=n>ma</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;lower&#39;</span><span class=p>:</span> <span class=n>lower_band</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;bandwidth&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>upper_band</span> <span class=o>-</span> <span class=n>lower_band</span><span class=p>)</span> <span class=o>/</span> <span class=n>ma</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>atr</span><span class=p>(</span><span class=n>high</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>low</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>close</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>window</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>14</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;平均真实波幅&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 计算真实波幅</span>
</span></span><span class=line><span class=cl>        <span class=n>tr1</span> <span class=o>=</span> <span class=n>high</span> <span class=o>-</span> <span class=n>low</span>
</span></span><span class=line><span class=cl>        <span class=n>tr2</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>high</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>roll</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>tr3</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>low</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>roll</span><span class=p>(</span><span class=n>close</span><span class=p>,</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>tr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>maximum</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>maximum</span><span class=p>(</span><span class=n>tr1</span><span class=p>,</span> <span class=n>tr2</span><span class=p>),</span> <span class=n>tr3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算ATR（使用指数移动平均）</span>
</span></span><span class=line><span class=cl>        <span class=n>atr_values</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros_like</span><span class=p>(</span><span class=n>tr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>atr_values</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>tr</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>alpha</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>window</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>tr</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>atr_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>alpha</span> <span class=o>*</span> <span class=n>tr</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>alpha</span><span class=p>)</span> <span class=o>*</span> <span class=n>atr_values</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>atr_values</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>volatility</span><span class=p>(</span><span class=n>prices</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>window</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>20</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;历史波动率&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>returns</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>prices</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>volatility</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>returns</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>window</span><span class=o>+</span><span class=mi>1</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>])</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span> <span class=k>if</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=n>window</span><span class=o>-</span><span class=mi>1</span> <span class=k>else</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span> 
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>returns</span><span class=p>))])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>volatility</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=成交量指标>成交量指标</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>VolumeIndicators</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;成交量指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>obv</span><span class=p>(</span><span class=n>close</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>volume</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;能量潮指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>obv</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros_like</span><span class=p>(</span><span class=n>close</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>obv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>volume</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>close</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>close</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>close</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>obv</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>obv</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>volume</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>close</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>close</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>obv</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>obv</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>volume</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>obv</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>obv</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>obv</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>vwap</span><span class=p>(</span><span class=n>high</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>low</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>close</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>volume</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;成交量加权平均价格&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>typical_price</span> <span class=o>=</span> <span class=p>(</span><span class=n>high</span> <span class=o>+</span> <span class=n>low</span> <span class=o>+</span> <span class=n>close</span><span class=p>)</span> <span class=o>/</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>        <span class=n>cumulative_tp_volume</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>cumsum</span><span class=p>(</span><span class=n>typical_price</span> <span class=o>*</span> <span class=n>volume</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cumulative_volume</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>cumsum</span><span class=p>(</span><span class=n>volume</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>vwap</span> <span class=o>=</span> <span class=n>cumulative_tp_volume</span> <span class=o>/</span> <span class=p>(</span><span class=n>cumulative_volume</span> <span class=o>+</span> <span class=mf>1e-10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>vwap</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>volume_rate_of_change</span><span class=p>(</span><span class=n>volume</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>window</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>12</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;成交量变化率&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>roc</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros_like</span><span class=p>(</span><span class=n>volume</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=nb>float</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>window</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>volume</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>volume</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>window</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>roc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>volume</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>volume</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>window</span><span class=p>])</span> <span class=o>/</span> <span class=n>volume</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>window</span><span class=p>]</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>roc</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=交易信号生成>交易信号生成</h2><h3 id=信号生成器>信号生成器</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SignalGenerator</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;信号生成器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>signals</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>signal_rules</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add_rule</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>condition_func</span><span class=p>,</span> <span class=n>action_func</span><span class=p>,</span> <span class=n>priority</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;添加信号规则&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>signal_rules</span><span class=p>[</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;condition&#39;</span><span class=p>:</span> <span class=n>condition_func</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=n>action_func</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;priority&#39;</span><span class=p>:</span> <span class=n>priority</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;enabled&#39;</span><span class=p>:</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_signals</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> <span class=n>current_position</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Signal</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成交易信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>signals</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>rule_name</span><span class=p>,</span> <span class=n>rule</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>signal_rules</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>rule</span><span class=p>[</span><span class=s1>&#39;enabled&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 检查条件</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>rule</span><span class=p>[</span><span class=s1>&#39;condition&#39;</span><span class=p>](</span><span class=n>data</span><span class=p>,</span> <span class=n>current_position</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># 执行动作</span>
</span></span><span class=line><span class=cl>                <span class=n>signal</span> <span class=o>=</span> <span class=n>rule</span><span class=p>[</span><span class=s1>&#39;action&#39;</span><span class=p>](</span><span class=n>data</span><span class=p>,</span> <span class=n>current_position</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>signal</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signal</span><span class=o>.</span><span class=n>metadata</span> <span class=o>=</span> <span class=n>signal</span><span class=o>.</span><span class=n>metadata</span> <span class=ow>or</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>                    <span class=n>signal</span><span class=o>.</span><span class=n>metadata</span><span class=p>[</span><span class=s1>&#39;rule_name&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>rule_name</span>
</span></span><span class=line><span class=cl>                    <span class=n>signal</span><span class=o>.</span><span class=n>metadata</span><span class=p>[</span><span class=s1>&#39;priority&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>rule</span><span class=p>[</span><span class=s1>&#39;priority&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 按优先级排序</span>
</span></span><span class=line><span class=cl>        <span class=n>signals</span><span class=o>.</span><span class=n>sort</span><span class=p>(</span><span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;priority&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>signals</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_momentum_signals</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;创建动量信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># RSI信号</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>rsi_condition</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>position</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;rsi&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=n>current_rsi</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;rsi&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>current_rsi</span> <span class=o>&lt;</span> <span class=mi>30</span> <span class=ow>and</span> <span class=n>position</span> <span class=o>==</span> <span class=mi>0</span>  <span class=c1># 超卖且空仓</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>rsi_action</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>position</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Signal</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>symbol</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>timestamp</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Timestamp</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                <span class=n>signal_type</span><span class=o>=</span><span class=s1>&#39;BUY&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>strength</span><span class=o>=</span><span class=mf>0.8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>price</span><span class=o>=</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>quantity</span><span class=o>=</span><span class=mi>100</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>add_rule</span><span class=p>(</span><span class=s1>&#39;rsi_oversold&#39;</span><span class=p>,</span> <span class=n>rsi_condition</span><span class=p>,</span> <span class=n>rsi_action</span><span class=p>,</span> <span class=n>priority</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># MACD信号</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>macd_condition</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>position</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;macd&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span> <span class=ow>or</span> <span class=s1>&#39;macd_signal&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>macd</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;macd&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>signal</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;macd_signal&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>macd_prev</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;macd&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>signal_prev</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;macd_signal&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># MACD金叉</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>(</span><span class=n>macd</span> <span class=o>&gt;</span> <span class=n>signal</span> <span class=ow>and</span> <span class=n>macd_prev</span> <span class=o>&lt;=</span> <span class=n>signal_prev</span> <span class=ow>and</span> <span class=n>position</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>macd_action</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>position</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Signal</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>symbol</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>timestamp</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Timestamp</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                <span class=n>signal_type</span><span class=o>=</span><span class=s1>&#39;BUY&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>strength</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>price</span><span class=o>=</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>quantity</span><span class=o>=</span><span class=mi>100</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>add_rule</span><span class=p>(</span><span class=s1>&#39;macd_golden_cross&#39;</span><span class=p>,</span> <span class=n>macd_condition</span><span class=p>,</span> <span class=n>macd_action</span><span class=p>,</span> <span class=n>priority</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=多时间框架信号>多时间框架信号</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MultiTimeframeSignalGenerator</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;多时间框架信号生成器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>timeframes</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;1min&#39;</span><span class=p>,</span> <span class=s1>&#39;5min&#39;</span><span class=p>,</span> <span class=s1>&#39;15min&#39;</span><span class=p>,</span> <span class=s1>&#39;1h&#39;</span><span class=p>,</span> <span class=s1>&#39;1d&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>signals_by_timeframe</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>combined_signals</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_multi_timeframe_signals</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data_dict</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成多时间框架信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>timeframe</span><span class=p>,</span> <span class=n>data</span> <span class=ow>in</span> <span class=n>data_dict</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>signal_gen</span> <span class=o>=</span> <span class=n>SignalGenerator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 为不同时间框架设置不同的参数</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>timeframe</span> <span class=o>==</span> <span class=s1>&#39;1min&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 高频交易信号</span>
</span></span><span class=line><span class=cl>                <span class=n>signal_gen</span><span class=o>.</span><span class=n>add_rule</span><span class=p>(</span><span class=s1>&#39;price_spike&#39;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                    <span class=k>lambda</span> <span class=n>d</span><span class=p>,</span> <span class=n>p</span><span class=p>:</span> <span class=nb>abs</span><span class=p>(</span><span class=n>d</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span> <span class=o>&gt;</span> <span class=mf>0.002</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=k>lambda</span> <span class=n>d</span><span class=p>,</span> <span class=n>p</span><span class=p>:</span> <span class=n>Signal</span><span class=p>(</span><span class=n>d</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span> <span class=n>pd</span><span class=o>.</span><span class=n>Timestamp</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span> <span class=s1>&#39;BUY&#39;</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=n>d</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span> <span class=mi>10</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>priority</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>timeframe</span> <span class=o>==</span> <span class=s1>&#39;1d&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 日线信号</span>
</span></span><span class=line><span class=cl>                <span class=n>signal_gen</span><span class=o>.</span><span class=n>add_rule</span><span class=p>(</span><span class=s1>&#39;trend_following&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=k>lambda</span> <span class=n>d</span><span class=p>,</span> <span class=n>p</span><span class=p>:</span> <span class=n>d</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>d</span><span class=p>[</span><span class=s1>&#39;sma_20&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=ow>and</span> <span class=n>p</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=k>lambda</span> <span class=n>d</span><span class=p>,</span> <span class=n>p</span><span class=p>:</span> <span class=n>Signal</span><span class=p>(</span><span class=n>d</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span> <span class=n>pd</span><span class=o>.</span><span class=n>Timestamp</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span> <span class=s1>&#39;BUY&#39;</span><span class=p>,</span> <span class=mf>0.8</span><span class=p>,</span> <span class=n>d</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span> <span class=mi>100</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>priority</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 生成信号</span>
</span></span><span class=line><span class=cl>            <span class=n>signals</span> <span class=o>=</span> <span class=n>signal_gen</span><span class=o>.</span><span class=n>generate_signals</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>signals_by_timeframe</span><span class=p>[</span><span class=n>timeframe</span><span class=p>]</span> <span class=o>=</span> <span class=n>signals</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 合并信号</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>combined_signals</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>combine_signals</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>combined_signals</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>combine_signals</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Signal</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;合并不同时间框架的信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>combined</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 简单多数投票</span>
</span></span><span class=line><span class=cl>        <span class=n>buy_votes</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=n>sell_votes</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=n>total_signals</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>timeframe</span><span class=p>,</span> <span class=n>signals</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>signals_by_timeframe</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>signal</span> <span class=ow>in</span> <span class=n>signals</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>total_signals</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>signal</span><span class=o>.</span><span class=n>signal_type</span> <span class=o>==</span> <span class=s1>&#39;BUY&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>buy_votes</span> <span class=o>+=</span> <span class=n>signal</span><span class=o>.</span><span class=n>strength</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>signal</span><span class=o>.</span><span class=n>signal_type</span> <span class=o>==</span> <span class=s1>&#39;SELL&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>sell_votes</span> <span class=o>+=</span> <span class=n>signal</span><span class=o>.</span><span class=n>strength</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 生成最终信号</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>buy_votes</span> <span class=o>&gt;</span> <span class=n>sell_votes</span> <span class=ow>and</span> <span class=n>buy_votes</span> <span class=o>&gt;</span> <span class=mf>0.5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>final_signal</span> <span class=o>=</span> <span class=n>Signal</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>symbol</span><span class=o>=</span><span class=s1>&#39;PORTFOLIO&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>timestamp</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Timestamp</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                <span class=n>signal_type</span><span class=o>=</span><span class=s1>&#39;BUY&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>strength</span><span class=o>=</span><span class=n>buy_votes</span> <span class=o>/</span> <span class=n>total_signals</span> <span class=k>if</span> <span class=n>total_signals</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>price</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>quantity</span><span class=o>=</span><span class=mi>100</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>combined</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>final_signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>sell_votes</span> <span class=o>&gt;</span> <span class=n>buy_votes</span> <span class=ow>and</span> <span class=n>sell_votes</span> <span class=o>&gt;</span> <span class=mf>0.5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>final_signal</span> <span class=o>=</span> <span class=n>Signal</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>symbol</span><span class=o>=</span><span class=s1>&#39;PORTFOLIO&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>timestamp</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Timestamp</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                <span class=n>signal_type</span><span class=o>=</span><span class=s1>&#39;SELL&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>strength</span><span class=o>=</span><span class=n>sell_votes</span> <span class=o>/</span> <span class=n>total_signals</span> <span class=k>if</span> <span class=n>total_signals</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>price</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>quantity</span><span class=o>=</span><span class=mi>100</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>combined</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>final_signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>combined</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=风险管理与仓位控制>风险管理与仓位控制</h2><h3 id=风险管理框架>风险管理框架</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RiskManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;风险管理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>max_position_size</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.1</span><span class=p>,</span> <span class=n>max_portfolio_risk</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.02</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_position_size</span> <span class=o>=</span> <span class=n>max_position_size</span>  <span class=c1># 最大仓位比例</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_portfolio_risk</span> <span class=o>=</span> <span class=n>max_portfolio_risk</span>  <span class=c1># 最大组合风险</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>current_exposure</span> <span class=o>=</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>stop_losses</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>position_limits</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_position_size</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>signal</span><span class=p>:</span> <span class=n>Signal</span><span class=p>,</span> <span class=n>portfolio_value</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                               <span class=n>current_price</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>volatility</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算仓位大小&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 基于风险的资金管理</span>
</span></span><span class=line><span class=cl>        <span class=n>risk_per_trade</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_portfolio_risk</span> <span class=o>*</span> <span class=n>portfolio_value</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 如果没有波动率数据，使用固定止损</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>volatility</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>stop_loss_pct</span> <span class=o>=</span> <span class=mf>0.02</span>  <span class=c1># 2%止损</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 基于波动率的动态止损</span>
</span></span><span class=line><span class=cl>            <span class=n>stop_loss_pct</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=mf>0.01</span><span class=p>,</span> <span class=nb>min</span><span class=p>(</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>volatility</span> <span class=o>*</span> <span class=mf>0.5</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算止损距离</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>signal</span><span class=o>.</span><span class=n>signal_type</span> <span class=o>==</span> <span class=s1>&#39;BUY&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>stop_loss_price</span> <span class=o>=</span> <span class=n>current_price</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>stop_loss_pct</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>  <span class=c1># SELL</span>
</span></span><span class=line><span class=cl>            <span class=n>stop_loss_price</span> <span class=o>=</span> <span class=n>current_price</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>stop_loss_pct</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算仓位大小</span>
</span></span><span class=line><span class=cl>        <span class=n>risk_amount</span> <span class=o>=</span> <span class=n>risk_per_trade</span>
</span></span><span class=line><span class=cl>        <span class=n>price_risk</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>current_price</span> <span class=o>-</span> <span class=n>stop_loss_price</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>price_risk</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>position_size</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>risk_amount</span> <span class=o>/</span> <span class=n>price_risk</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>position_size</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 应用最大仓位限制</span>
</span></span><span class=line><span class=cl>        <span class=n>max_position_value</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_position_size</span> <span class=o>*</span> <span class=n>portfolio_value</span>
</span></span><span class=line><span class=cl>        <span class=n>max_shares</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>max_position_value</span> <span class=o>/</span> <span class=n>current_price</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>position_size</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>position_size</span><span class=p>,</span> <span class=n>max_shares</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 存储止损价格</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>stop_losses</span><span class=p>[</span><span class=n>signal</span><span class=o>.</span><span class=n>symbol</span><span class=p>]</span> <span class=o>=</span> <span class=n>stop_loss_price</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>position_size</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_risk_limits</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>proposed_position</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>current_position</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                         <span class=n>current_price</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>portfolio_value</span><span class=p>:</span> <span class=nb>float</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检查风险限制&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算新仓位的价值</span>
</span></span><span class=line><span class=cl>        <span class=n>new_position_value</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>proposed_position</span><span class=p>)</span> <span class=o>*</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 检查仓位大小限制</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>new_position_value</span> <span class=o>/</span> <span class=n>portfolio_value</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_position_size</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;仓位超过限制: </span><span class=si>{</span><span class=n>new_position_value</span> <span class=o>/</span> <span class=n>portfolio_value</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2> &gt; </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>max_position_size</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 检查组合总风险</span>
</span></span><span class=line><span class=cl>        <span class=n>total_exposure</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_total_exposure</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>total_exposure</span> <span class=o>&gt;</span> <span class=mf>0.8</span><span class=p>:</span>  <span class=c1># 最大80%暴露</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;组合风险过高: </span><span class=si>{</span><span class=n>total_exposure</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_total_exposure</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算总风险暴露&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>current_exposure</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>update_stop_loss</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>symbol</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>current_price</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>atr</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;更新止损价格&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>symbol</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>stop_losses</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>atr</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 使用ATR进行移动止损</span>
</span></span><span class=line><span class=cl>                <span class=n>new_stop</span> <span class=o>=</span> <span class=n>current_price</span> <span class=o>-</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>atr</span> <span class=k>if</span> <span class=n>current_price</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>stop_losses</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span> <span class=k>else</span> <span class=bp>self</span><span class=o>.</span><span class=n>stop_losses</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>stop_losses</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_stop</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>should_exit_position</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>symbol</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>current_price</span><span class=p>:</span> <span class=nb>float</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;判断是否应该退出仓位&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>symbol</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>stop_losses</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>stop_price</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>stop_losses</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 检查止损</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_price</span> <span class=o>&lt;=</span> <span class=n>stop_price</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;触发止损: </span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2> @ </span><span class=si>{</span><span class=n>current_price</span><span class=si>}</span><span class=s2> &lt;= </span><span class=si>{</span><span class=n>stop_price</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=资金管理策略>资金管理策略</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PositionSizing</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;仓位大小计算器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>fixed_ratio</span><span class=p>(</span><span class=n>portfolio_value</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>ratio</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.1</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;固定比例仓位&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>portfolio_value</span> <span class=o>*</span> <span class=n>ratio</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>kelly_criterion</span><span class=p>(</span><span class=n>win_rate</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>avg_win</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>avg_loss</span><span class=p>:</span> <span class=nb>float</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;凯利公式&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>avg_loss</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>b</span> <span class=o>=</span> <span class=n>avg_win</span> <span class=o>/</span> <span class=n>avg_loss</span>  <span class=c1># 盈亏比</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span> <span class=o>=</span> <span class=n>win_rate</span>  <span class=c1># 胜率</span>
</span></span><span class=line><span class=cl>        <span class=n>q</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>p</span>  <span class=c1># 败率</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 凯利公式: f = (bp - q) / b</span>
</span></span><span class=line><span class=cl>        <span class=n>kelly</span> <span class=o>=</span> <span class=p>(</span><span class=n>b</span> <span class=o>*</span> <span class=n>p</span> <span class=o>-</span> <span class=n>q</span><span class=p>)</span> <span class=o>/</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 使用半凯利以降低风险</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>min</span><span class=p>(</span><span class=n>kelly</span><span class=p>,</span> <span class=mf>0.25</span><span class=p>))</span>  <span class=c1># 限制最大仓位25%</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>volatility_targeting</span><span class=p>(</span><span class=n>portfolio_value</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>target_volatility</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                           <span class=n>current_volatility</span><span class=p>:</span> <span class=nb>float</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;基于波动率目标的仓位&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>current_volatility</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 根据目标波动率调整仓位</span>
</span></span><span class=line><span class=cl>        <span class=n>volatility_ratio</span> <span class=o>=</span> <span class=n>target_volatility</span> <span class=o>/</span> <span class=n>current_volatility</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 限制仓位在合理范围内</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>min</span><span class=p>(</span><span class=n>volatility_ratio</span><span class=p>,</span> <span class=mf>2.0</span><span class=p>))</span> <span class=o>*</span> <span class=n>portfolio_value</span> <span class=o>*</span> <span class=mf>0.1</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>risk_parity</span><span class=p>(</span><span class=n>portfolio_value</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>asset_volatility</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                   <span class=n>portfolio_volatility</span><span class=p>:</span> <span class=nb>float</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;风险平价&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>asset_volatility</span> <span class=o>==</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>portfolio_volatility</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算风险贡献</span>
</span></span><span class=line><span class=cl>        <span class=n>risk_contribution</span> <span class=o>=</span> <span class=n>asset_volatility</span> <span class=o>/</span> <span class=n>portfolio_volatility</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 基于风险贡献分配资金</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>portfolio_value</span> <span class=o>*</span> <span class=n>risk_contribution</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>([</span><span class=n>asset_volatility</span><span class=p>])</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=策略回测框架>策略回测框架</h2><h3 id=回测引擎>回测引擎</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BacktestEngine</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;回测引擎&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>initial_capital</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mi>100000</span><span class=p>,</span> <span class=n>commission</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.001</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>initial_capital</span> <span class=o>=</span> <span class=n>initial_capital</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>commission</span> <span class=o>=</span> <span class=n>commission</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;cash&#39;</span><span class=p>:</span> <span class=n>initial_capital</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;positions&#39;</span><span class=p>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;value&#39;</span><span class=p>:</span> <span class=n>initial_capital</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>trades</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>equity_curve</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run_backtest</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>strategy</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;运行回测&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;开始回测策略: </span><span class=si>{</span><span class=n>strategy</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 重置组合</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;cash&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>initial_capital</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;positions&#39;</span><span class=p>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;value&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>initial_capital</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>trades</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>equity_curve</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 按时间顺序处理数据</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>current_data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>iloc</span><span class=p>[:</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>current_bar</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 生成信号</span>
</span></span><span class=line><span class=cl>            <span class=n>signal</span> <span class=o>=</span> <span class=n>strategy</span><span class=o>.</span><span class=n>generate_signal</span><span class=p>(</span><span class=n>current_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>signal</span> <span class=ow>and</span> <span class=n>signal</span><span class=o>.</span><span class=n>signal_type</span> <span class=o>!=</span> <span class=s1>&#39;HOLD&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 执行交易</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>execute_trade</span><span class=p>(</span><span class=n>signal</span><span class=p>,</span> <span class=n>current_bar</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 更新组合价值</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>update_portfolio_value</span><span class=p>(</span><span class=n>current_bar</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 记录权益曲线</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>equity_curve</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>current_bar</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;portfolio_value&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=p>[</span><span class=s1>&#39;value&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;cash&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=p>[</span><span class=s1>&#39;cash&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算性能指标</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>calculate_performance_metrics</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;trades&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>trades</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;equity_curve&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>equity_curve</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;performance_metrics&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>execute_trade</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>signal</span><span class=p>:</span> <span class=n>Signal</span><span class=p>,</span> <span class=n>current_bar</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行交易&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>symbol</span> <span class=o>=</span> <span class=n>signal</span><span class=o>.</span><span class=n>symbol</span>
</span></span><span class=line><span class=cl>        <span class=n>price</span> <span class=o>=</span> <span class=n>signal</span><span class=o>.</span><span class=n>price</span>
</span></span><span class=line><span class=cl>        <span class=n>quantity</span> <span class=o>=</span> <span class=n>signal</span><span class=o>.</span><span class=n>quantity</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算交易成本</span>
</span></span><span class=line><span class=cl>        <span class=n>transaction_cost</span> <span class=o>=</span> <span class=n>quantity</span> <span class=o>*</span> <span class=n>price</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>commission</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>signal</span><span class=o>.</span><span class=n>signal_type</span> <span class=o>==</span> <span class=s1>&#39;BUY&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>total_cost</span> <span class=o>=</span> <span class=n>quantity</span> <span class=o>*</span> <span class=n>price</span> <span class=o>+</span> <span class=n>transaction_cost</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=p>[</span><span class=s1>&#39;cash&#39;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>total_cost</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 执行买入</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=p>[</span><span class=s1>&#39;cash&#39;</span><span class=p>]</span> <span class=o>-=</span> <span class=n>total_cost</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>symbol</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=p>[</span><span class=s1>&#39;positions&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=p>[</span><span class=s1>&#39;positions&#39;</span><span class=p>][</span><span class=n>symbol</span><span class=p>]</span> <span class=o>+=</span> <span class=n>quantity</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=p>[</span><span class=s1>&#39;positions&#39;</span><span class=p>][</span><span class=n>symbol</span><span class=p>]</span> <span class=o>=</span> <span class=n>quantity</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>trade</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>current_bar</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;symbol&#39;</span><span class=p>:</span> <span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=s1>&#39;BUY&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;quantity&#39;</span><span class=p>:</span> <span class=n>quantity</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;cost&#39;</span><span class=p>:</span> <span class=n>transaction_cost</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;total_value&#39;</span><span class=p>:</span> <span class=n>total_cost</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>trades</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>trade</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;买入: </span><span class=si>{</span><span class=n>quantity</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2> @ </span><span class=si>{</span><span class=n>price</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>signal</span><span class=o>.</span><span class=n>signal_type</span> <span class=o>==</span> <span class=s1>&#39;SELL&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>symbol</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=p>[</span><span class=s1>&#39;positions&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=p>[</span><span class=s1>&#39;positions&#39;</span><span class=p>][</span><span class=n>symbol</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>quantity</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 执行卖出</span>
</span></span><span class=line><span class=cl>                <span class=n>total_revenue</span> <span class=o>=</span> <span class=n>quantity</span> <span class=o>*</span> <span class=n>price</span> <span class=o>-</span> <span class=n>transaction_cost</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=p>[</span><span class=s1>&#39;cash&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=n>total_revenue</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=p>[</span><span class=s1>&#39;positions&#39;</span><span class=p>][</span><span class=n>symbol</span><span class=p>]</span> <span class=o>-=</span> <span class=n>quantity</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=p>[</span><span class=s1>&#39;positions&#39;</span><span class=p>][</span><span class=n>symbol</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>del</span> <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=p>[</span><span class=s1>&#39;positions&#39;</span><span class=p>][</span><span class=n>symbol</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>trade</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>current_bar</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;symbol&#39;</span><span class=p>:</span> <span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=s1>&#39;SELL&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;quantity&#39;</span><span class=p>:</span> <span class=n>quantity</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;cost&#39;</span><span class=p>:</span> <span class=n>transaction_cost</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;total_value&#39;</span><span class=p>:</span> <span class=n>total_revenue</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>trades</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>trade</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;卖出: </span><span class=si>{</span><span class=n>quantity</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2> @ </span><span class=si>{</span><span class=n>price</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>update_portfolio_value</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>current_bar</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;更新组合价值&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>total_value</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=p>[</span><span class=s1>&#39;cash&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>symbol</span><span class=p>,</span> <span class=n>position</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=p>[</span><span class=s1>&#39;positions&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>symbol</span> <span class=o>==</span> <span class=n>current_bar</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;symbol&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>current_price</span> <span class=o>=</span> <span class=n>current_bar</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>total_value</span> <span class=o>+=</span> <span class=n>position</span> <span class=o>*</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=p>[</span><span class=s1>&#39;value&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>total_value</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_performance_metrics</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算性能指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>equity_curve</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 转换为DataFrame</span>
</span></span><span class=line><span class=cl>        <span class=n>equity_df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>equity_curve</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>equity_df</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>equity_df</span><span class=p>[</span><span class=s1>&#39;portfolio_value&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 基本指标</span>
</span></span><span class=line><span class=cl>        <span class=n>total_return</span> <span class=o>=</span> <span class=p>(</span><span class=n>equity_df</span><span class=p>[</span><span class=s1>&#39;portfolio_value&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>initial_capital</span><span class=p>)</span> <span class=o>/</span> <span class=bp>self</span><span class=o>.</span><span class=n>initial_capital</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 年化收益率</span>
</span></span><span class=line><span class=cl>        <span class=n>days</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>equity_df</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>annual_return</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>total_return</span><span class=p>)</span> <span class=o>**</span> <span class=p>(</span><span class=mi>252</span> <span class=o>/</span> <span class=n>days</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 波动率</span>
</span></span><span class=line><span class=cl>        <span class=n>volatility</span> <span class=o>=</span> <span class=n>equity_df</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 夏普比率</span>
</span></span><span class=line><span class=cl>        <span class=n>risk_free_rate</span> <span class=o>=</span> <span class=mf>0.03</span>
</span></span><span class=line><span class=cl>        <span class=n>sharpe_ratio</span> <span class=o>=</span> <span class=p>(</span><span class=n>annual_return</span> <span class=o>-</span> <span class=n>risk_free_rate</span><span class=p>)</span> <span class=o>/</span> <span class=n>volatility</span> <span class=k>if</span> <span class=n>volatility</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 最大回撤</span>
</span></span><span class=line><span class=cl>        <span class=n>cumulative</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>equity_df</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>])</span><span class=o>.</span><span class=n>cumprod</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>running_max</span> <span class=o>=</span> <span class=n>cumulative</span><span class=o>.</span><span class=n>expanding</span><span class=p>()</span><span class=o>.</span><span class=n>max</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>drawdown</span> <span class=o>=</span> <span class=p>(</span><span class=n>cumulative</span> <span class=o>-</span> <span class=n>running_max</span><span class=p>)</span> <span class=o>/</span> <span class=n>running_max</span>
</span></span><span class=line><span class=cl>        <span class=n>max_drawdown</span> <span class=o>=</span> <span class=n>drawdown</span><span class=o>.</span><span class=n>min</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 胜率</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>trades</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>winning_trades</span> <span class=o>=</span> <span class=p>[</span><span class=n>t</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>trades</span> <span class=k>if</span> <span class=n>t</span><span class=p>[</span><span class=s1>&#39;action&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;SELL&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>win_rate</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>winning_trades</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>trades</span><span class=p>)</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>trades</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>win_rate</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_return&#39;</span><span class=p>:</span> <span class=n>total_return</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;annual_return&#39;</span><span class=p>:</span> <span class=n>annual_return</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;volatility&#39;</span><span class=p>:</span> <span class=n>volatility</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>:</span> <span class=n>sharpe_ratio</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max_drawdown&#39;</span><span class=p>:</span> <span class=n>max_drawdown</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;win_rate&#39;</span><span class=p>:</span> <span class=n>win_rate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_trades&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>trades</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;final_value&#39;</span><span class=p>:</span> <span class=n>equity_df</span><span class=p>[</span><span class=s1>&#39;portfolio_value&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=性能分析>性能分析</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PerformanceAnalyzer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;性能分析器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>benchmark_returns</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_metrics</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>returns</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>,</span> <span class=n>benchmark_returns</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算性能指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 基本统计</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;total_return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>returns</span><span class=p>)</span><span class=o>.</span><span class=n>prod</span><span class=p>()</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;annual_return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>*</span> <span class=mi>252</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;volatility&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;annual_return&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mf>0.03</span><span class=p>)</span> <span class=o>/</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;volatility&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 最大回撤</span>
</span></span><span class=line><span class=cl>        <span class=n>cumulative</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>returns</span><span class=p>)</span><span class=o>.</span><span class=n>cumprod</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>running_max</span> <span class=o>=</span> <span class=n>cumulative</span><span class=o>.</span><span class=n>expanding</span><span class=p>()</span><span class=o>.</span><span class=n>max</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>drawdown</span> <span class=o>=</span> <span class=p>(</span><span class=n>cumulative</span> <span class=o>-</span> <span class=n>running_max</span><span class=p>)</span> <span class=o>/</span> <span class=n>running_max</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>drawdown</span><span class=o>.</span><span class=n>min</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 卡尔马比率</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>])</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;calmar_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;annual_return&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=nb>abs</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;calmar_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 索提诺比率</span>
</span></span><span class=line><span class=cl>        <span class=n>downside_returns</span> <span class=o>=</span> <span class=n>returns</span><span class=p>[</span><span class=n>returns</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>downside_returns</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>downside_std</span> <span class=o>=</span> <span class=n>downside_returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;sortino_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;annual_return&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mf>0.03</span><span class=p>)</span> <span class=o>/</span> <span class=n>downside_std</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;sortino_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 与基准比较</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>benchmark_returns</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>calculate_benchmark_metrics</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>benchmark_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_benchmark_metrics</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>strategy_returns</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>,</span> <span class=n>benchmark_returns</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算与基准相关的指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 对齐时间序列</span>
</span></span><span class=line><span class=cl>        <span class=n>aligned_data</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>strategy_returns</span><span class=p>,</span> <span class=n>benchmark_returns</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>strategy_aligned</span> <span class=o>=</span> <span class=n>aligned_data</span><span class=o>.</span><span class=n>iloc</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>benchmark_aligned</span> <span class=o>=</span> <span class=n>aligned_data</span><span class=o>.</span><span class=n>iloc</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># Beta值</span>
</span></span><span class=line><span class=cl>        <span class=n>covariance</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>cov</span><span class=p>(</span><span class=n>strategy_aligned</span><span class=p>,</span> <span class=n>benchmark_aligned</span><span class=p>)[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>benchmark_variance</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>benchmark_aligned</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>beta</span> <span class=o>=</span> <span class=n>covariance</span> <span class=o>/</span> <span class=n>benchmark_variance</span> <span class=k>if</span> <span class=n>benchmark_variance</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># Alpha值</span>
</span></span><span class=line><span class=cl>        <span class=n>strategy_return</span> <span class=o>=</span> <span class=n>strategy_aligned</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>*</span> <span class=mi>252</span>
</span></span><span class=line><span class=cl>        <span class=n>benchmark_return</span> <span class=o>=</span> <span class=n>benchmark_aligned</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>*</span> <span class=mi>252</span>
</span></span><span class=line><span class=cl>        <span class=n>alpha</span> <span class=o>=</span> <span class=n>strategy_return</span> <span class=o>-</span> <span class=p>(</span><span class=mf>0.03</span> <span class=o>+</span> <span class=n>beta</span> <span class=o>*</span> <span class=p>(</span><span class=n>benchmark_return</span> <span class=o>-</span> <span class=mf>0.03</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 信息比率</span>
</span></span><span class=line><span class=cl>        <span class=n>active_returns</span> <span class=o>=</span> <span class=n>strategy_aligned</span> <span class=o>-</span> <span class=n>benchmark_aligned</span>
</span></span><span class=line><span class=cl>        <span class=n>tracking_error</span> <span class=o>=</span> <span class=n>active_returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>information_ratio</span> <span class=o>=</span> <span class=p>(</span><span class=n>strategy_return</span> <span class=o>-</span> <span class=n>benchmark_return</span><span class=p>)</span> <span class=o>/</span> <span class=n>tracking_error</span> <span class=k>if</span> <span class=n>tracking_error</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>update</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;beta&#39;</span><span class=p>:</span> <span class=n>beta</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;alpha&#39;</span><span class=p>:</span> <span class=n>alpha</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;information_ratio&#39;</span><span class=p>:</span> <span class=n>information_ratio</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;tracking_error&#39;</span><span class=p>:</span> <span class=n>tracking_error</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_report</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成性能报告&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>report</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>策略性能分析报告
</span></span></span><span class=line><span class=cl><span class=s2>==================
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>基本指标:
</span></span></span><span class=line><span class=cl><span class=s2>---------
</span></span></span><span class=line><span class=cl><span class=s2>总收益率: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;total_return&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>年化收益率: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;annual_return&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>年化波动率: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;volatility&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>夏普比率: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>最大回撤: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>风险调整指标:
</span></span></span><span class=line><span class=cl><span class=s2>-------------
</span></span></span><span class=line><span class=cl><span class=s2>卡尔马比率: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;calmar_ratio&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>索提诺比率: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;sortino_ratio&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>基准比较:
</span></span></span><span class=line><span class=cl><span class=s2>---------
</span></span></span><span class=line><span class=cl><span class=s2>Beta值: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;beta&#39;</span><span class=p>,</span> <span class=s1>&#39;N/A&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Alpha值: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;alpha&#39;</span><span class=p>,</span> <span class=s1>&#39;N/A&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>信息比率: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;information_ratio&#39;</span><span class=p>,</span> <span class=s1>&#39;N/A&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>跟踪误差: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;tracking_error&#39;</span><span class=p>,</span> <span class=s1>&#39;N/A&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>report</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=多因子策略开发>多因子策略开发</h2><h3 id=因子构建>因子构建</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>FactorBuilder</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;因子构建器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>factors</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>factor_weights</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>build_momentum_factors</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;构建动量因子&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>factors</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 价格动量</span>
</span></span><span class=line><span class=cl>        <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;price_momentum_1m&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;price_momentum_3m&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>(</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;price_momentum_6m&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>(</span><span class=mi>120</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 相对强度</span>
</span></span><span class=line><span class=cl>        <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;rsi_14&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>MomentumIndicators</span><span class=o>.</span><span class=n>rsi</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 移动平均斜率</span>
</span></span><span class=line><span class=cl>        <span class=n>ma_20</span> <span class=o>=</span> <span class=n>TrendIndicators</span><span class=o>.</span><span class=n>sma</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> <span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;ma_slope&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>gradient</span><span class=p>(</span><span class=n>ma_20</span><span class=p>)</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>ma_20</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span> <span class=k>else</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>factors</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>build_value_factors</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> <span class=n>fundamental_data</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;构建价值因子&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>factors</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>fundamental_data</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 市盈率</span>
</span></span><span class=line><span class=cl>            <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;pe_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>fundamental_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;pe_ratio&#39;</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 市净率</span>
</span></span><span class=line><span class=cl>            <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;pb_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>fundamental_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;pb_ratio&#39;</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 股息率</span>
</span></span><span class=line><span class=cl>            <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;dividend_yield&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>fundamental_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;dividend_yield&#39;</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 价值综合评分（越低越好）</span>
</span></span><span class=line><span class=cl>            <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;value_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;pe_ratio&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rank</span><span class=p>(</span><span class=n>pct</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.4</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;pb_ratio&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rank</span><span class=p>(</span><span class=n>pct</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.4</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;dividend_yield&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rank</span><span class=p>(</span><span class=n>pct</span><span class=o>=</span><span class=kc>True</span><span class=p>))</span> <span class=o>*</span> <span class=mf>0.2</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>factors</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>build_quality_factors</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> <span class=n>fundamental_data</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;构建质量因子&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>factors</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>fundamental_data</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># ROE</span>
</span></span><span class=line><span class=cl>            <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;roe&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>fundamental_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;roe&#39;</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># ROA</span>
</span></span><span class=line><span class=cl>            <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;roa&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>fundamental_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;roa&#39;</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 负债率</span>
</span></span><span class=line><span class=cl>            <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;debt_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>fundamental_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;debt_ratio&#39;</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 盈利稳定性</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;net_income&#39;</span> <span class=ow>in</span> <span class=n>fundamental_data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;earnings_stability&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>fundamental_data</span><span class=p>[</span><span class=s1>&#39;net_income&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 质量综合评分</span>
</span></span><span class=line><span class=cl>            <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;quality_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;roe&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rank</span><span class=p>(</span><span class=n>pct</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.4</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;roa&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rank</span><span class=p>(</span><span class=n>pct</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.3</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;debt_ratio&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rank</span><span class=p>(</span><span class=n>pct</span><span class=o>=</span><span class=kc>True</span><span class=p>))</span> <span class=o>*</span> <span class=mf>0.3</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>factors</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>build_volatility_factors</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;构建波动率因子&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>factors</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 历史波动率</span>
</span></span><span class=line><span class=cl>        <span class=n>returns</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;volatility_20d&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;volatility_60d&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>60</span><span class=p>)</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 最大回撤</span>
</span></span><span class=line><span class=cl>        <span class=n>cumulative</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>returns</span><span class=p>)</span><span class=o>.</span><span class=n>cumprod</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>running_max</span> <span class=o>=</span> <span class=n>cumulative</span><span class=o>.</span><span class=n>expanding</span><span class=p>()</span><span class=o>.</span><span class=n>max</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>drawdown</span> <span class=o>=</span> <span class=p>(</span><span class=n>cumulative</span> <span class=o>-</span> <span class=n>running_max</span><span class=p>)</span> <span class=o>/</span> <span class=n>running_max</span>
</span></span><span class=line><span class=cl>        <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;max_drawdown_6m&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>drawdown</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>120</span><span class=p>)</span><span class=o>.</span><span class=n>min</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>factors</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=多因子组合>多因子组合</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MultiFactorStrategy</span><span class=p>(</span><span class=n>StrategyBase</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;多因子策略&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>symbols</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>symbols</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>factor_builder</span> <span class=o>=</span> <span class=n>FactorBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>factor_weights</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;momentum&#39;</span><span class=p>:</span> <span class=mf>0.3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;value&#39;</span><span class=p>:</span> <span class=mf>0.3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;quality&#39;</span><span class=p>:</span> <span class=mf>0.2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;volatility&#39;</span><span class=p>:</span> <span class=mf>0.2</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>factor_scores</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>selected_stocks</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_factor_scores</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data_dict</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                                <span class=n>fundamental_data_dict</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算因子得分&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>symbol</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>symbols</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>symbol</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>data_dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data_dict</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>fundamental_data</span> <span class=o>=</span> <span class=n>fundamental_data_dict</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>symbol</span><span class=p>)</span> <span class=k>if</span> <span class=n>fundamental_data_dict</span> <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 构建各类因子</span>
</span></span><span class=line><span class=cl>            <span class=n>momentum_factors</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>factor_builder</span><span class=o>.</span><span class=n>build_momentum_factors</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>value_factors</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>factor_builder</span><span class=o>.</span><span class=n>build_value_factors</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>fundamental_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>quality_factors</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>factor_builder</span><span class=o>.</span><span class=n>build_quality_factors</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>fundamental_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>volatility_factors</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>factor_builder</span><span class=o>.</span><span class=n>build_volatility_factors</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 合并所有因子</span>
</span></span><span class=line><span class=cl>            <span class=n>all_factors</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>momentum_factors</span><span class=p>,</span> <span class=n>value_factors</span><span class=p>,</span> <span class=n>quality_factors</span><span class=p>,</span> <span class=n>volatility_factors</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 计算综合得分</span>
</span></span><span class=line><span class=cl>            <span class=n>total_score</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>factor_type</span><span class=p>,</span> <span class=n>weight</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>factor_weights</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>factor_type</span> <span class=o>==</span> <span class=s1>&#39;momentum&#39;</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>momentum_factors</span><span class=o>.</span><span class=n>empty</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>score</span> <span class=o>=</span> <span class=n>momentum_factors</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>momentum_factors</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>factor_type</span> <span class=o>==</span> <span class=s1>&#39;value&#39;</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>value_factors</span><span class=o>.</span><span class=n>empty</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>score</span> <span class=o>=</span> <span class=n>value_factors</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>value_factors</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>factor_type</span> <span class=o>==</span> <span class=s1>&#39;quality&#39;</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>quality_factors</span><span class=o>.</span><span class=n>empty</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>score</span> <span class=o>=</span> <span class=n>quality_factors</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>quality_factors</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>factor_type</span> <span class=o>==</span> <span class=s1>&#39;volatility&#39;</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>volatility_factors</span><span class=o>.</span><span class=n>empty</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>score</span> <span class=o>=</span> <span class=n>volatility_factors</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>volatility_factors</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>score</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>total_score</span> <span class=o>+=</span> <span class=n>score</span> <span class=o>*</span> <span class=n>weight</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>factor_scores</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span> <span class=o>=</span> <span class=n>total_score</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>select_stocks</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>top_n</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;选择得分最高的股票&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 按得分排序</span>
</span></span><span class=line><span class=cl>        <span class=n>sorted_stocks</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>factor_scores</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 选择前N只股票</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>selected_stocks</span> <span class=o>=</span> <span class=p>[</span><span class=n>stock</span> <span class=k>for</span> <span class=n>stock</span><span class=p>,</span> <span class=n>score</span> <span class=ow>in</span> <span class=n>sorted_stocks</span><span class=p>[:</span><span class=n>top_n</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>selected_stocks</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_portfolio_weights</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>method</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;equal_weight&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>float</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成组合权重&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>weights</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;equal_weight&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>weight</span> <span class=o>=</span> <span class=mf>1.0</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>selected_stocks</span><span class=p>)</span> <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>selected_stocks</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=n>weights</span> <span class=o>=</span> <span class=p>{</span><span class=n>stock</span><span class=p>:</span> <span class=n>weight</span> <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>selected_stocks</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;score_weighted&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>total_score</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>factor_scores</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span> <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>selected_stocks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>total_score</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>weights</span> <span class=o>=</span> <span class=p>{</span><span class=n>stock</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>factor_scores</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span> <span class=o>/</span> <span class=n>total_score</span> 
</span></span><span class=line><span class=cl>                          <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>selected_stocks</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;risk_parity&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 基于波动率的权重分配</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>selected_stocks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 这里简化处理，实际应该计算每只股票的波动率</span>
</span></span><span class=line><span class=cl>                <span class=n>weights</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span> <span class=o>=</span> <span class=mf>1.0</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>selected_stocks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>weights</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>rebalance_portfolio</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data_dict</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                          <span class=n>fundamental_data_dict</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;再平衡组合&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算因子得分</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>calculate_factor_scores</span><span class=p>(</span><span class=n>data_dict</span><span class=p>,</span> <span class=n>fundamental_data_dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 选择股票</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>select_stocks</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 生成权重</span>
</span></span><span class=line><span class=cl>        <span class=n>weights</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_portfolio_weights</span><span class=p>(</span><span class=s1>&#39;score_weighted&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 生成调仓信号</span>
</span></span><span class=line><span class=cl>        <span class=n>signals</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>stock</span><span class=p>,</span> <span class=n>target_weight</span> <span class=ow>in</span> <span class=n>weights</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>data_dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>current_data</span> <span class=o>=</span> <span class=n>data_dict</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>current_price</span> <span class=o>=</span> <span class=n>current_data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 计算目标仓位</span>
</span></span><span class=line><span class=cl>                <span class=n>target_position_value</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>portfolio_value</span> <span class=o>*</span> <span class=n>target_weight</span>
</span></span><span class=line><span class=cl>                <span class=n>target_quantity</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>target_position_value</span> <span class=o>/</span> <span class=n>current_price</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 获取当前仓位</span>
</span></span><span class=line><span class=cl>                <span class=n>current_quantity</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>positions</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 生成调仓信号</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>target_quantity</span> <span class=o>&gt;</span> <span class=n>current_quantity</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 买入</span>
</span></span><span class=line><span class=cl>                    <span class=n>buy_quantity</span> <span class=o>=</span> <span class=n>target_quantity</span> <span class=o>-</span> <span class=n>current_quantity</span>
</span></span><span class=line><span class=cl>                    <span class=n>signal</span> <span class=o>=</span> <span class=n>Signal</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>symbol</span><span class=o>=</span><span class=n>stock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>timestamp</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Timestamp</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                        <span class=n>signal_type</span><span class=o>=</span><span class=s1>&#39;BUY&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>strength</span><span class=o>=</span><span class=n>target_weight</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>price</span><span class=o>=</span><span class=n>current_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>quantity</span><span class=o>=</span><span class=n>buy_quantity</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>target_quantity</span> <span class=o>&lt;</span> <span class=n>current_quantity</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 卖出</span>
</span></span><span class=line><span class=cl>                    <span class=n>sell_quantity</span> <span class=o>=</span> <span class=n>current_quantity</span> <span class=o>-</span> <span class=n>target_quantity</span>
</span></span><span class=line><span class=cl>                    <span class=n>signal</span> <span class=o>=</span> <span class=n>Signal</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>symbol</span><span class=o>=</span><span class=n>stock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>timestamp</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>Timestamp</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                        <span class=n>signal_type</span><span class=o>=</span><span class=s1>&#39;SELL&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>strength</span><span class=o>=</span><span class=mi>1</span> <span class=o>-</span> <span class=n>target_weight</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>price</span><span class=o>=</span><span class=n>current_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>quantity</span><span class=o>=</span><span class=n>sell_quantity</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>signals</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=事件驱动策略>事件驱动策略</h2><h3 id=事件处理框架>事件处理框架</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Event</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;事件基类&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_type</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>timestamp</span><span class=p>:</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_type</span> <span class=o>=</span> <span class=n>event_type</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>=</span> <span class=n>timestamp</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data</span> <span class=o>=</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EventHandler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;事件处理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>handlers</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>register_handler</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_type</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>handler_func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;注册事件处理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>event_type</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>handlers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>handlers</span><span class=p>[</span><span class=n>event_type</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>handlers</span><span class=p>[</span><span class=n>event_type</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>handler_func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process_event</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>Event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理事件&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>event</span><span class=o>.</span><span class=n>event_type</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>handlers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>handler</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>handlers</span><span class=p>[</span><span class=n>event</span><span class=o>.</span><span class=n>event_type</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>handler</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EventDrivenStrategy</span><span class=p>(</span><span class=n>StrategyBase</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;事件驱动策略&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>symbols</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>symbols</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_handler</span> <span class=o>=</span> <span class=n>EventHandler</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_queue</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_history</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 注册事件处理器</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>setup_event_handlers</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>setup_event_handlers</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;设置事件处理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 价格突破事件</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>handle_breakout</span><span class=p>(</span><span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>symbol</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>price</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;price&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>resistance</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;resistance&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>price</span> <span class=o>&gt;</span> <span class=n>resistance</span> <span class=o>*</span> <span class=mf>1.02</span><span class=p>:</span>  <span class=c1># 突破阻力位2%</span>
</span></span><span class=line><span class=cl>                <span class=n>signal</span> <span class=o>=</span> <span class=n>Signal</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>symbol</span><span class=o>=</span><span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>timestamp</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>timestamp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>signal_type</span><span class=o>=</span><span class=s1>&#39;BUY&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>strength</span><span class=o>=</span><span class=mf>0.8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>price</span><span class=o>=</span><span class=n>price</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>on_signal</span><span class=p>(</span><span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 成交量异常事件</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>handle_volume_spike</span><span class=p>(</span><span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>symbol</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>volume</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>avg_volume</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;avg_volume&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>volume</span> <span class=o>&gt;</span> <span class=n>avg_volume</span> <span class=o>*</span> <span class=mi>3</span><span class=p>:</span>  <span class=c1># 成交量异常放大</span>
</span></span><span class=line><span class=cl>                <span class=n>signal</span> <span class=o>=</span> <span class=n>Signal</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>symbol</span><span class=o>=</span><span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>timestamp</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>timestamp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>signal_type</span><span class=o>=</span><span class=s1>&#39;HOLD&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>strength</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>price</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;price&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=c1># 这里可以添加特殊处理逻辑</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;成交量异常: </span><span class=si>{</span><span class=n>symbol</span><span class=si>}</span><span class=s2> 成交量 </span><span class=si>{</span><span class=n>volume</span><span class=si>}</span><span class=s2> 是平均 </span><span class=si>{</span><span class=n>avg_volume</span><span class=si>}</span><span class=s2> 的 </span><span class=si>{</span><span class=n>volume</span><span class=o>/</span><span class=n>avg_volume</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2> 倍&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 新闻事件</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>handle_news_event</span><span class=p>(</span><span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>symbol</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>sentiment</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;sentiment&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>sentiment</span> <span class=o>&gt;</span> <span class=mf>0.7</span><span class=p>:</span>  <span class=c1># 正面新闻</span>
</span></span><span class=line><span class=cl>                <span class=n>signal</span> <span class=o>=</span> <span class=n>Signal</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>symbol</span><span class=o>=</span><span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>timestamp</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>timestamp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>signal_type</span><span class=o>=</span><span class=s1>&#39;BUY&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>strength</span><span class=o>=</span><span class=n>sentiment</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>price</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;price&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>on_signal</span><span class=p>(</span><span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>sentiment</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mf>0.7</span><span class=p>:</span>  <span class=c1># 负面新闻</span>
</span></span><span class=line><span class=cl>                <span class=n>signal</span> <span class=o>=</span> <span class=n>Signal</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>symbol</span><span class=o>=</span><span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>timestamp</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>timestamp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>signal_type</span><span class=o>=</span><span class=s1>&#39;SELL&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>strength</span><span class=o>=</span><span class=nb>abs</span><span class=p>(</span><span class=n>sentiment</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>price</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;price&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>on_signal</span><span class=p>(</span><span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 注册处理器</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_handler</span><span class=o>.</span><span class=n>register_handler</span><span class=p>(</span><span class=s1>&#39;BREAKOUT&#39;</span><span class=p>,</span> <span class=n>handle_breakout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_handler</span><span class=o>.</span><span class=n>register_handler</span><span class=p>(</span><span class=s1>&#39;VOLUME_SPIKE&#39;</span><span class=p>,</span> <span class=n>handle_volume_spike</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_handler</span><span class=o>.</span><span class=n>register_handler</span><span class=p>(</span><span class=s1>&#39;NEWS&#39;</span><span class=p>,</span> <span class=n>handle_news_event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>detect_events</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检测事件&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>events</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 价格突破检测</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>20</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>current_price</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>recent_high</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;high&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>20</span><span class=p>:]</span><span class=o>.</span><span class=n>max</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_price</span> <span class=o>&gt;</span> <span class=n>recent_high</span> <span class=o>*</span> <span class=mf>1.02</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>event</span> <span class=o>=</span> <span class=n>Event</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>event_type</span><span class=o>=</span><span class=s1>&#39;BREAKOUT&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>timestamp</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=n>data</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s1>&#39;symbol&#39;</span><span class=p>:</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>current_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s1>&#39;resistance&#39;</span><span class=p>:</span> <span class=n>recent_high</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s1>&#39;breakout_strength&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>current_price</span> <span class=o>-</span> <span class=n>recent_high</span><span class=p>)</span> <span class=o>/</span> <span class=n>recent_high</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 成交量异常检测</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>20</span> <span class=ow>and</span> <span class=s1>&#39;volume&#39;</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>current_volume</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>avg_volume</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>20</span><span class=p>:]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_volume</span> <span class=o>&gt;</span> <span class=n>avg_volume</span> <span class=o>*</span> <span class=mf>2.5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>event</span> <span class=o>=</span> <span class=n>Event</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>event_type</span><span class=o>=</span><span class=s1>&#39;VOLUME_SPIKE&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>timestamp</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=n>data</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s1>&#39;symbol&#39;</span><span class=p>:</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s1>&#39;volume&#39;</span><span class=p>:</span> <span class=n>current_volume</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s1>&#39;avg_volume&#39;</span><span class=p>:</span> <span class=n>avg_volume</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>events</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>on_market_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>MarketData</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理市场数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 更新技术指标</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>update_indicators</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 检测事件</span>
</span></span><span class=line><span class=cl>        <span class=n>events</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>detect_events</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 处理事件</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>event_handler</span><span class=o>.</span><span class=n>process_event</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>event_history</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 限制历史记录长度</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>event_history</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1000</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>event_history</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>event_history</span><span class=p>[</span><span class=o>-</span><span class=mi>1000</span><span class=p>:]</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=实践练习>实践练习</h2><h3 id=练习1构建完整的趋势跟踪策略>练习1：构建完整的趋势跟踪策略</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TrendFollowingStrategy</span><span class=p>(</span><span class=n>TechnicalStrategy</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;趋势跟踪策略&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>symbols</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>symbols</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=o>.</span><span class=n>update</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;trend_window&#39;</span><span class=p>:</span> <span class=mi>50</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;entry_threshold&#39;</span><span class=p>:</span> <span class=mf>0.02</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;exit_threshold&#39;</span><span class=p>:</span> <span class=mf>0.01</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;stop_loss_atr&#39;</span><span class=p>:</span> <span class=mf>2.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;position_size_pct&#39;</span><span class=p>:</span> <span class=mf>0.1</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_signal</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>MarketData</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Signal</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成趋势跟踪信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>symbol</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>symbol</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>symbol</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>indicators</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Signal</span><span class=p>(</span><span class=n>symbol</span><span class=p>,</span> <span class=n>data</span><span class=o>.</span><span class=n>timestamp</span><span class=p>,</span> <span class=s1>&#39;HOLD&#39;</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>prices</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>symbol</span><span class=p>][</span><span class=s1>&#39;prices&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;trend_window&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Signal</span><span class=p>(</span><span class=n>symbol</span><span class=p>,</span> <span class=n>data</span><span class=o>.</span><span class=n>timestamp</span><span class=p>,</span> <span class=s1>&#39;HOLD&#39;</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算趋势指标</span>
</span></span><span class=line><span class=cl>        <span class=n>current_price</span> <span class=o>=</span> <span class=n>prices</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>trend_ma</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_moving_average</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;trend_window&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算ATR用于止损</span>
</span></span><span class=line><span class=cl>        <span class=n>highs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;highs&#39;</span><span class=p>,</span> <span class=p>[</span><span class=n>data</span><span class=o>.</span><span class=n>high</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>lows</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;lows&#39;</span><span class=p>,</span> <span class=p>[</span><span class=n>data</span><span class=o>.</span><span class=n>low</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>closes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;closes&#39;</span><span class=p>,</span> <span class=p>[</span><span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>highs</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>14</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>lows</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>14</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>closes</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>14</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>atr</span> <span class=o>=</span> <span class=n>VolatilityIndicators</span><span class=o>.</span><span class=n>atr</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>highs</span><span class=p>[</span><span class=o>-</span><span class=mi>14</span><span class=p>:]),</span> 
</span></span><span class=line><span class=cl>                <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>lows</span><span class=p>[</span><span class=o>-</span><span class=mi>14</span><span class=p>:]),</span> 
</span></span><span class=line><span class=cl>                <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>closes</span><span class=p>[</span><span class=o>-</span><span class=mi>14</span><span class=p>:]),</span> 
</span></span><span class=line><span class=cl>                <span class=mi>14</span>
</span></span><span class=line><span class=cl>            <span class=p>)[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>atr</span> <span class=o>=</span> <span class=n>current_price</span> <span class=o>*</span> <span class=mf>0.02</span>  <span class=c1># 默认2%的ATR</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 获取当前仓位</span>
</span></span><span class=line><span class=cl>        <span class=n>current_position</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>positions</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>symbol</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 生成信号</span>
</span></span><span class=line><span class=cl>        <span class=n>signal_type</span> <span class=o>=</span> <span class=s1>&#39;HOLD&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>strength</span> <span class=o>=</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 入场条件：价格突破趋势均线</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>current_position</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_price</span> <span class=o>&gt;</span> <span class=n>trend_ma</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;entry_threshold&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                <span class=n>signal_type</span> <span class=o>=</span> <span class=s1>&#39;BUY&#39;</span>
</span></span><span class=line><span class=cl>                <span class=n>strength</span> <span class=o>=</span> <span class=mf>0.8</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 出场条件：价格跌破趋势均线或止损</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>current_position</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 止损检查</span>
</span></span><span class=line><span class=cl>            <span class=n>stop_loss_price</span> <span class=o>=</span> <span class=n>current_price</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;stop_loss_atr&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=n>atr</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>data</span><span class=o>.</span><span class=n>close</span> <span class=o>&lt;=</span> <span class=n>stop_loss_price</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>signal_type</span> <span class=o>=</span> <span class=s1>&#39;SELL&#39;</span>
</span></span><span class=line><span class=cl>                <span class=n>strength</span> <span class=o>=</span> <span class=mf>1.0</span>
</span></span><span class=line><span class=cl>            <span class=c1># 趋势反转</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>current_price</span> <span class=o>&lt;</span> <span class=n>trend_ma</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;exit_threshold&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                <span class=n>signal_type</span> <span class=o>=</span> <span class=s1>&#39;SELL&#39;</span>
</span></span><span class=line><span class=cl>                <span class=n>strength</span> <span class=o>=</span> <span class=mf>0.7</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Signal</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>symbol</span><span class=o>=</span><span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>timestamp</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>timestamp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>signal_type</span><span class=o>=</span><span class=n>signal_type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>strength</span><span class=o>=</span><span class=n>strength</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>price</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>quantity</span><span class=o>=</span><span class=nb>int</span><span class=p>(</span><span class=n>portfolio_value</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;position_size_pct&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=n>data</span><span class=o>.</span><span class=n>close</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试趋势跟踪策略</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_trend_following_strategy</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;测试趋势跟踪策略&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 创建模拟数据</span>
</span></span><span class=line><span class=cl>    <span class=n>dates</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>date_range</span><span class=p>(</span><span class=s1>&#39;2023-01-01&#39;</span><span class=p>,</span> <span class=s1>&#39;2023-12-31&#39;</span><span class=p>,</span> <span class=n>freq</span><span class=o>=</span><span class=s1>&#39;D&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 生成趋势数据</span>
</span></span><span class=line><span class=cl>    <span class=n>trend</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>120</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>noise</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>prices</span> <span class=o>=</span> <span class=n>trend</span> <span class=o>+</span> <span class=n>noise</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 创建OHLC数据</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;open&#39;</span><span class=p>:</span> <span class=n>prices</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;high&#39;</span><span class=p>:</span> <span class=n>prices</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>))),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;low&#39;</span><span class=p>:</span> <span class=n>prices</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>))),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;close&#39;</span><span class=p>:</span> <span class=n>prices</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;volume&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>1000000</span><span class=p>,</span> <span class=mi>5000000</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=n>index</span><span class=o>=</span><span class=n>dates</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 创建策略实例</span>
</span></span><span class=line><span class=cl>    <span class=n>strategy</span> <span class=o>=</span> <span class=n>TrendFollowingStrategy</span><span class=p>(</span><span class=s2>&#34;趋势跟踪策略&#34;</span><span class=p>,</span> <span class=p>[</span><span class=s2>&#34;TEST&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 创建回测引擎</span>
</span></span><span class=line><span class=cl>    <span class=n>backtest</span> <span class=o>=</span> <span class=n>BacktestEngine</span><span class=p>(</span><span class=n>initial_capital</span><span class=o>=</span><span class=mi>100000</span><span class=p>,</span> <span class=n>commission</span><span class=o>=</span><span class=mf>0.001</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 运行回测</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=n>backtest</span><span class=o>.</span><span class=n>run_backtest</span><span class=p>(</span><span class=n>strategy</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 分析结果</span>
</span></span><span class=line><span class=cl>    <span class=n>analyzer</span> <span class=o>=</span> <span class=n>PerformanceAnalyzer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>returns</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>curve</span><span class=p>[</span><span class=s1>&#39;portfolio_value&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>curve</span> <span class=ow>in</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;equity_curve&#39;</span><span class=p>]])</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>calculate_metrics</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;趋势跟踪策略回测结果:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;总收益率: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;total_return&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;年化收益率: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;annual_return&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;夏普比率: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最大回撤: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;交易次数: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;performance_metrics&#39;</span><span class=p>][</span><span class=s1>&#39;total_trades&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>results</span><span class=p>,</span> <span class=n>metrics</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行测试</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span><span class=p>,</span> <span class=n>metrics</span> <span class=o>=</span> <span class=n>test_trend_following_strategy</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=练习2构建多因子选股策略>练习2：构建多因子选股策略</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ChinaAMultiFactorStrategy</span><span class=p>(</span><span class=n>MultiFactorStrategy</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;A股多因子选股策略&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>symbols</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>symbols</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># A股特定的因子权重</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>factor_weights</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;momentum&#39;</span><span class=p>:</span> <span class=mf>0.25</span><span class=p>,</span>      <span class=c1># 动量因子</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;value&#39;</span><span class=p>:</span> <span class=mf>0.30</span><span class=p>,</span>         <span class=c1># 价值因子（A股价值效应明显）</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;quality&#39;</span><span class=p>:</span> <span class=mf>0.25</span><span class=p>,</span>       <span class=c1># 质量因子</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;volatility&#39;</span><span class=p>:</span> <span class=mf>0.20</span>     <span class=c1># 波动率因子</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># A股特定的参数</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;lookback_period&#39;</span><span class=p>:</span> <span class=mi>60</span><span class=p>,</span>     <span class=c1># 回看期60天</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;rebalance_frequency&#39;</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span> <span class=c1># 每月调仓</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max_positions&#39;</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span>       <span class=c1># 最大持仓数</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;min_market_cap&#39;</span><span class=p>:</span> <span class=mf>5e8</span><span class=p>,</span>     <span class=c1># 最小市值5亿</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max_pe_ratio&#39;</span><span class=p>:</span> <span class=mi>30</span><span class=p>,</span>        <span class=c1># 最大市盈率30倍</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;min_roe&#39;</span><span class=p>:</span> <span class=mf>0.1</span>            <span class=c1># 最小ROE 10%</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>filter_stocks</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data_dict</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                     <span class=n>fundamental_data_dict</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;A股股票筛选&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>filtered_stocks</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>symbol</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>symbols</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>symbol</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>data_dict</span> <span class=ow>or</span> <span class=n>symbol</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>fundamental_data_dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data_dict</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>fundamental</span> <span class=o>=</span> <span class=n>fundamental_data_dict</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 流动性筛选</span>
</span></span><span class=line><span class=cl>            <span class=n>avg_volume</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>20</span><span class=p>:]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>avg_volume</span> <span class=o>&lt;</span> <span class=mi>1000000</span><span class=p>:</span>  <span class=c1># 日均成交量小于100万</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 市值筛选</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;market_cap&#39;</span> <span class=ow>in</span> <span class=n>fundamental</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>market_cap</span> <span class=o>=</span> <span class=n>fundamental</span><span class=p>[</span><span class=s1>&#39;market_cap&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>market_cap</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;min_market_cap&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 基本面筛选</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;pe_ratio&#39;</span> <span class=ow>in</span> <span class=n>fundamental</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>pe_ratio</span> <span class=o>=</span> <span class=n>fundamental</span><span class=p>[</span><span class=s1>&#39;pe_ratio&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>pe_ratio</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;max_pe_ratio&#39;</span><span class=p>]</span> <span class=ow>or</span> <span class=n>pe_ratio</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;roe&#39;</span> <span class=ow>in</span> <span class=n>fundamental</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>roe</span> <span class=o>=</span> <span class=n>fundamental</span><span class=p>[</span><span class=s1>&#39;roe&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>roe</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>[</span><span class=s1>&#39;min_roe&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>filtered_stocks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>symbol</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>filtered_stocks</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_a_share_factors</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                                <span class=n>fundamental_data</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算A股特定因子&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>factors</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>data</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 市值因子（小市值效应）</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;market_cap&#39;</span> <span class=ow>in</span> <span class=n>fundamental_data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;market_cap&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>fundamental_data</span><span class=p>[</span><span class=s1>&#39;market_cap&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=c1># 小市值得分（市值越小得分越高）</span>
</span></span><span class=line><span class=cl>            <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;size_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;market_cap&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rank</span><span class=p>(</span><span class=n>pct</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 估值因子</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;pe_ratio&#39;</span> <span class=ow>in</span> <span class=n>fundamental_data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;pe_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>fundamental_data</span><span class=p>[</span><span class=s1>&#39;pe_ratio&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=c1># 低估值得分</span>
</span></span><span class=line><span class=cl>            <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;value_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;pe_ratio&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rank</span><span class=p>(</span><span class=n>pct</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;pb_ratio&#39;</span> <span class=ow>in</span> <span class=n>fundamental_data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;pb_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>fundamental_data</span><span class=p>[</span><span class=s1>&#39;pb_ratio&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;pb_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;pb_ratio&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rank</span><span class=p>(</span><span class=n>pct</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 盈利因子</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;roe&#39;</span> <span class=ow>in</span> <span class=n>fundamental_data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;roe&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>fundamental_data</span><span class=p>[</span><span class=s1>&#39;roe&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;profit_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;roe&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rank</span><span class=p>(</span><span class=n>pct</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 成长因子</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;revenue_growth&#39;</span> <span class=ow>in</span> <span class=n>fundamental_data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;revenue_growth&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>fundamental_data</span><span class=p>[</span><span class=s1>&#39;revenue_growth&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;growth_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;revenue_growth&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rank</span><span class=p>(</span><span class=n>pct</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 技术因子</span>
</span></span><span class=line><span class=cl>        <span class=c1># 动量因子</span>
</span></span><span class=line><span class=cl>        <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;momentum_1m&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;momentum_3m&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>(</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 反转因子（A股反转效应明显）</span>
</span></span><span class=line><span class=cl>        <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;reversal_1m&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>factors</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>select_a_share_stocks</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data_dict</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                            <span class=n>fundamental_data_dict</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                            <span class=n>top_n</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;A股股票选择&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 股票筛选</span>
</span></span><span class=line><span class=cl>        <span class=n>filtered_stocks</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>filter_stocks</span><span class=p>(</span><span class=n>data_dict</span><span class=p>,</span> <span class=n>fundamental_data_dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算因子得分</span>
</span></span><span class=line><span class=cl>        <span class=n>stock_scores</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>symbol</span> <span class=ow>in</span> <span class=n>filtered_stocks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>symbol</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>data_dict</span> <span class=ow>or</span> <span class=n>symbol</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>fundamental_data_dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data_dict</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>fundamental</span> <span class=o>=</span> <span class=n>fundamental_data_dict</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 计算A股特定因子</span>
</span></span><span class=line><span class=cl>            <span class=n>factors</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_a_share_factors</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>fundamental</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 计算综合得分</span>
</span></span><span class=line><span class=cl>            <span class=n>score</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 小市值因子（20%）</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;size_score&#39;</span> <span class=ow>in</span> <span class=n>factors</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>score</span> <span class=o>+=</span> <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;size_score&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.2</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 估值因子（30%）</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;value_score&#39;</span> <span class=ow>in</span> <span class=n>factors</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>score</span> <span class=o>+=</span> <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;value_score&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.3</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;pb_score&#39;</span> <span class=ow>in</span> <span class=n>factors</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>score</span> <span class=o>+=</span> <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;pb_score&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.1</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 盈利因子（20%）</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;profit_score&#39;</span> <span class=ow>in</span> <span class=n>factors</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>score</span> <span class=o>+=</span> <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;profit_score&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.2</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 成长因子（10%）</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;growth_score&#39;</span> <span class=ow>in</span> <span class=n>factors</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>score</span> <span class=o>+=</span> <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;growth_score&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.1</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 技术因子（10%）</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;momentum_1m&#39;</span> <span class=ow>in</span> <span class=n>factors</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>momentum_score</span> <span class=o>=</span> <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;momentum_1m&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=c1># 标准化动量得分</span>
</span></span><span class=line><span class=cl>                <span class=n>score</span> <span class=o>+=</span> <span class=p>(</span><span class=n>momentum_score</span> <span class=o>-</span> <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;momentum_1m&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>())</span> <span class=o>/</span> <span class=p>(</span><span class=n>factors</span><span class=p>[</span><span class=s1>&#39;momentum_1m&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>+</span> <span class=mf>1e-10</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.05</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;reversal_1m&#39;</span> <span class=ow>in</span> <span class=n>factors</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>reversal_score</span> <span class=o>=</span> <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;reversal_1m&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>score</span> <span class=o>+=</span> <span class=p>(</span><span class=n>reversal_score</span> <span class=o>-</span> <span class=n>factors</span><span class=p>[</span><span class=s1>&#39;reversal_1m&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>())</span> <span class=o>/</span> <span class=p>(</span><span class=n>factors</span><span class=p>[</span><span class=s1>&#39;reversal_1m&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>+</span> <span class=mf>1e-10</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.05</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>stock_scores</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span> <span class=o>=</span> <span class=n>score</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 选择得分最高的股票</span>
</span></span><span class=line><span class=cl>        <span class=n>sorted_stocks</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>stock_scores</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>selected_stocks</span> <span class=o>=</span> <span class=p>[</span><span class=n>stock</span> <span class=k>for</span> <span class=n>stock</span><span class=p>,</span> <span class=n>score</span> <span class=ow>in</span> <span class=n>sorted_stocks</span><span class=p>[:</span><span class=n>top_n</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>factor_scores</span> <span class=o>=</span> <span class=n>stock_scores</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>selected_stocks</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试A股多因子策略</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_a_share_multi_factor_strategy</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;测试A股多因子策略&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 创建模拟股票数据</span>
</span></span><span class=line><span class=cl>    <span class=n>symbols</span> <span class=o>=</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&#34;STOCK_</span><span class=si>{</span><span class=n>i</span><span class=si>:</span><span class=s2>03d</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>50</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>data_dict</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=n>fundamental_dict</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>symbol</span> <span class=ow>in</span> <span class=n>symbols</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 创建价格数据</span>
</span></span><span class=line><span class=cl>        <span class=n>dates</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>date_range</span><span class=p>(</span><span class=s1>&#39;2023-01-01&#39;</span><span class=p>,</span> <span class=s1>&#39;2023-12-31&#39;</span><span class=p>,</span> <span class=n>freq</span><span class=o>=</span><span class=s1>&#39;D&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>base_price</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>returns</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mf>0.001</span><span class=p>,</span> <span class=mf>0.02</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>prices</span> <span class=o>=</span> <span class=n>base_price</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>returns</span><span class=p>)</span><span class=o>.</span><span class=n>cumprod</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;open&#39;</span><span class=p>:</span> <span class=n>prices</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.99</span><span class=p>,</span> <span class=mf>1.01</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;high&#39;</span><span class=p>:</span> <span class=n>prices</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>1.00</span><span class=p>,</span> <span class=mf>1.02</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;low&#39;</span><span class=p>:</span> <span class=n>prices</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.98</span><span class=p>,</span> <span class=mf>1.00</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;close&#39;</span><span class=p>:</span> <span class=n>prices</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;volume&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>1000000</span><span class=p>,</span> <span class=mi>10000000</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=n>index</span><span class=o>=</span><span class=n>dates</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>data_dict</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 创建基本面数据</span>
</span></span><span class=line><span class=cl>        <span class=n>fundamental</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;market_cap&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>5e8</span><span class=p>,</span> <span class=mf>1e11</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;pe_ratio&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mi>50</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;pb_ratio&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.5</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;roe&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.05</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;revenue_growth&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=o>-</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=n>index</span><span class=o>=</span><span class=n>dates</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>fundamental_dict</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span> <span class=o>=</span> <span class=n>fundamental</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 创建策略实例</span>
</span></span><span class=line><span class=cl>    <span class=n>strategy</span> <span class=o>=</span> <span class=n>ChinaAMultiFactorStrategy</span><span class=p>(</span><span class=s2>&#34;A股多因子策略&#34;</span><span class=p>,</span> <span class=n>symbols</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 选择股票</span>
</span></span><span class=line><span class=cl>    <span class=n>selected_stocks</span> <span class=o>=</span> <span class=n>strategy</span><span class=o>.</span><span class=n>select_a_share_stocks</span><span class=p>(</span><span class=n>data_dict</span><span class=p>,</span> <span class=n>fundamental_dict</span><span class=p>,</span> <span class=n>top_n</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;A股多因子策略选股结果:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;选中股票数量: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>selected_stocks</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;选中股票列表:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>stock</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>selected_stocks</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>score</span> <span class=o>=</span> <span class=n>strategy</span><span class=o>.</span><span class=n>factor_scores</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>i</span><span class=si>:</span><span class=s2>2d</span><span class=si>}</span><span class=s2>. </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2> (得分: </span><span class=si>{</span><span class=n>score</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>selected_stocks</span><span class=p>,</span> <span class=n>strategy</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>selected_stocks</span><span class=p>,</span> <span class=n>strategy</span> <span class=o>=</span> <span class=n>test_a_share_multi_factor_strategy</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=总结与扩展阅读>总结与扩展阅读</h2><h3 id=核心知识点总结>核心知识点总结</h3><p>本讲我们系统学习了量化策略开发的核心内容：</p><ol><li><p><strong>策略框架设计</strong></p><ul><li>事件驱动策略框架</li><li>技术指标策略框架</li><li>策略基类的设计模式</li></ul></li><li><p><strong>技术指标实现</strong></p><ul><li>趋势指标：SMA、EMA、MACD、ADX</li><li>动量指标：RSI、Stochastic、Williams %R、CCI</li><li>波动率指标：Bollinger Bands、ATR、历史波动率</li><li>成交量指标：OBV、VWAP、成交量变化率</li></ul></li><li><p><strong>交易信号生成</strong></p><ul><li>信号生成器的设计</li><li>多时间框架信号</li><li>信号强度计算</li></ul></li><li><p><strong>风险管理与仓位控制</strong></p><ul><li>风险管理框架</li><li>资金管理策略：固定比例、凯利公式、波动率目标</li><li>止损和止盈机制</li></ul></li><li><p><strong>策略回测框架</strong></p><ul><li>回测引擎实现</li><li>交易执行逻辑</li><li>性能指标计算</li></ul></li><li><p><strong>多因子策略开发</strong></p><ul><li>因子构建：动量、价值、质量、波动率</li><li>因子组合方法</li><li>A股多因子策略</li></ul></li><li><p><strong>事件驱动策略</strong></p><ul><li>事件处理框架</li><li>价格突破、成交量异常、新闻事件处理</li></ul></li></ol><h3 id=最佳实践建议>最佳实践建议</h3><ol><li><p><strong>策略开发流程</strong></p><ul><li>从简单的策略开始，逐步增加复杂性</li><li>每个策略都要有明确的投资逻辑</li><li>充分的历史数据回测验证</li><li>实盘前的模拟交易测试</li></ul></li><li><p><strong>风险管理原则</strong></p><ul><li>始终设置止损机制</li><li>控制单笔交易风险（不超过2%）</li><li>分散投资，避免过度集中</li><li>定期评估和调整风险参数</li></ul></li><li><p><strong>性能优化建议</strong></p><ul><li>使用向量化计算提高性能</li><li>避免过度拟合，使用样本外测试</li><li>考虑交易成本和滑点</li><li>多策略组合降低风险</li></ul></li></ol><h3 id=扩展阅读推荐>扩展阅读推荐</h3><ol><li><p><strong>经典书籍</strong></p><ul><li>《量化投资策略》Robert Kissell</li><li>《Algorithmic Trading》Ernie Chan</li><li>《Quantitative Trading Strategies》Lars Kestner</li><li>《Advances in Financial Machine Learning》Marcos López de Prado</li></ul></li><li><p><strong>在线资源</strong></p><ul><li>QuantConnect: 量化交易平台和社区</li><li>Backtrader: Python回测框架</li><li>Zipline: Quantopian的开源回测引擎</li><li>聚宽(JoinQuant): 国内量化交易平台</li></ul></li><li><p><strong>学术论文</strong></p><ul><li>Fama-French三因子模型</li><li>Carhart四因子模型</li><li>动量效应研究（Jegadeesh & Titman）</li><li>价值效应研究（Lakonishok et al.）</li></ul></li><li><p><strong>进阶主题</strong></p><ul><li>机器学习在量化交易中的应用</li><li>高频交易策略开发</li><li>期权策略定价</li><li>加密货币量化交易</li></ul></li></ol><h3 id=下一讲预告>下一讲预告</h3><p>在下一讲《策略回测与优化》中，我们将深入学习：</p><ul><li>回测系统的详细实现</li><li>参数优化方法</li><li>过拟合检测与防范</li><li>策略性能评估</li><li>实盘前的准备工作</li></ul><p>通过系统学习策略开发、回测优化和实盘部署，你将具备构建完整量化交易系统的能力。继续加油！</p><hr><p><strong>练习建议</strong>：</p><ol><li>实现一个基于MACD和RSI的双因子策略</li><li>构建一个事件驱动的突破策略</li><li>开发一个适合A股市场的价值+动量策略</li><li>尝试优化现有策略的参数</li></ol><p><strong>注意事项</strong>：</p><ul><li>本教程仅供学习参考，不构成投资建议</li><li>实盘交易需谨慎，建议充分测试后再投入实盘</li><li>量化交易存在风险，请根据自身风险承受能力谨慎操作</li></ul></div></article><aside class="lg:w-80 xl:w-96"><div class=space-y-8></div></aside></div><nav class="border-t border-gray-200 mt-12 pt-8"><div class="flex justify-between items-center"><a href=/blog/%E6%8A%95%E8%B5%84%E7%90%86%E8%AE%BA/%E5%AE%8F%E8%A7%82%E5%88%86%E6%9E%90/08-%E9%80%9A%E8%B4%A7%E8%86%A8%E8%83%80%E5%AF%B9%E8%82%A1%E5%B8%82%E7%9A%84%E5%BD%B1%E5%93%8D/ class="group flex items-center"><svg class="w-5 h-5 mr-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0 7-7m-7 7h18"/></svg><div><div class="text-sm text-gray-600">上一篇</div><div class="font-medium group-hover:text-primary-600">宏观分析第8讲：通胀对股市的双重影响</div></div></a><a href=/blog/%E6%8A%95%E8%B5%84%E7%90%86%E8%AE%BA/%E5%AE%8F%E8%A7%82%E5%88%86%E6%9E%90/09-%E6%94%BF%E6%B2%BB%E5%9B%A0%E7%B4%A0%E5%AF%B9%E8%82%A1%E5%B8%82%E7%9A%84%E5%BD%B1%E5%93%8D/ class="group flex items-center text-right"><div><div class="text-sm text-gray-600">Next Post</div><div class="font-medium group-hover:text-primary-600">宏观分析第9讲：政治因素对股市的影响</div></div><svg class="w-5 h-5 ml-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0-7 7m7-7H3"/></svg></a></div></nav></div></div><footer class="bg-gray-50 py-12 border-t border-gray-200"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><div class="flex flex-col md:flex-row justify-between space-y-4 md:space-y-0"><div class=flex-1><div class="flex items-center space-x-3 mb-4"><a href=https://sk-quant.github.io/ class=inline-block><img src=/images/logo.svg alt=烧烤量化 class=h-6>
</a><span class="text-xl font-bold text-gray-900">烧烤量化</span></div><div class="flex space-x-3 p-2"><a href=https://linkedin.com/in/yourusername class="text-gray-600 hover:text-gray-900" target=_blank rel="noopener noreferrer"><span class=sr-only>LinkedIn</span>
<img src=/images/social/linkedin.svg alt=LinkedIn class="h-5 w-5">
</a><a href=https://bsky.app/profile/yourblueskyhandle class="text-gray-600 hover:text-gray-900" target=_blank rel="noopener noreferrer"><span class=sr-only>Bluesky</span>
<img src=/images/social/bluesky.svg alt=Bluesky class="h-5 w-5">
</a><a href=https://twitter.com/yourusername class="text-gray-600 hover:text-gray-900" target=_blank rel="noopener noreferrer"><span class=sr-only>Twitter (X)</span>
<img src=/images/social/twitter.svg alt=Twitter class="h-5 w-5">
</a><a href=https://github.com/yourusername class="text-gray-600 hover:text-gray-900" target=_blank rel="noopener noreferrer"><span class=sr-only>GitHub</span>
<img src=/images/social/github.svg alt=GitHub class="h-5 w-5"></a></div></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div></div><div class="mt-12 pt-8 border-t border-gray-200"><div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0"><p class="text-gray-600 text-sm">© 2025 烧烤量化. All rights reserved.</p><a href=https://chaoming.li class="text-sm text-gray-600 hover:text-primary-600" target=_blank rel="noopener noreferrer">Powered by sk-quant</a></div></div></div></footer><script>const mobileMenuButton=document.getElementById("mobile-menu-button");mobileMenuButton&&mobileMenuButton.addEventListener("click",function(){const e=document.getElementById("mobile-menu");e&&e.classList.toggle("hidden")})</script></body></html>