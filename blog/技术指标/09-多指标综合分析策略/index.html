<!doctype html><html lang=zh-cn class=h-full><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-XXXXXXX")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XXXXXXXXXX")</script><title>技术指标第9讲：多指标综合分析策略 | 烧烤量化</title>
<meta name=description content="构建基于MA、MACD、RSI、Bollinger Bands、KDJ、OBV、ADX、SAR八大技术指标的协同分析体系，通过多维度信号验证与权重评分机制，打造高胜率、低风险的量化交易策略框架"><meta name=author content="Ryan"><meta name=robots content="index, follow"><meta property="og:title" content="技术指标第9讲：多指标综合分析策略 | 烧烤量化"><meta property="og:description" content="构建基于MA、MACD、RSI、Bollinger Bands、KDJ、OBV、ADX、SAR八大技术指标的协同分析体系，通过多维度信号验证与权重评分机制，打造高胜率、低风险的量化交易策略框架"><meta property="og:type" content="article"><meta property="og:url" content="https://sk-quant.github.io/blog/%E6%8A%80%E6%9C%AF%E6%8C%87%E6%A0%87/09-%E5%A4%9A%E6%8C%87%E6%A0%87%E7%BB%BC%E5%90%88%E5%88%86%E6%9E%90%E7%AD%96%E7%95%A5/"><meta property="og:site_name" content="烧烤量化"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="技术指标第9讲：多指标综合分析策略 | 烧烤量化"><meta name=twitter:description content="构建基于MA、MACD、RSI、Bollinger Bands、KDJ、OBV、ADX、SAR八大技术指标的协同分析体系，通过多维度信号验证与权重评分机制，打造高胜率、低风险的量化交易策略框架"><link rel=icon type=image/x-icon href=/images/favicon.ico><link rel=canonical href=https://sk-quant.github.io/blog/%E6%8A%80%E6%9C%AF%E6%8C%87%E6%A0%87/09-%E5%A4%9A%E6%8C%87%E6%A0%87%E7%BB%BC%E5%90%88%E5%88%86%E6%9E%90%E7%AD%96%E7%95%A5/><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel=stylesheet><link rel=stylesheet href="/css/main.min.0ec21c03b9f63a8c5e37663a4d2dc1608de61fd749fcfef42ffda7dc5bf34cc4.css"></head><body class="min-h-screen flex flex-col"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-XXXXXXX" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class="fixed top-0 left-0 right-0 z-50"><div class=mobile-menu-wrapper><input type=checkbox id=nav-toggle class=nav-toggle><header class="fixed w-full top-0 z-50 bg-white/80 backdrop-blur-sm border-b border-gray-100"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><nav class="flex items-center justify-between h-20"><a href=https://sk-quant.github.io/ class="flex items-center space-x-4"><img src=/images/logo.svg alt=烧烤量化 class=h-12>
<span class="text-3xl font-semibold text-gray-800">烧烤量化</span></a><div class="hidden md:flex items-center space-x-8"><a href=/path class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">学习路线</a><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化基础<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">回测平台</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化进阶<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">综合实战</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化高手<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股指期货</a></div></div></div><a href=/pricing class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">服务套餐</a></div><div class="hidden md:flex items-center space-x-4"><a href=/contact class="inline-flex items-center justify-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div><div class=md:hidden><label for=nav-toggle class="p-2 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-offset-2 transition-colors cursor-pointer"><svg class="w-6 h-6" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></label></div></nav></div><div class="nav-content md:hidden w-full fixed left-0 right-0 top-20 bg-white border-t border-gray-100 shadow-lg"><div class="w-full px-6 py-4"><a href=/path class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">学习路线</a><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化基础</div><div class=pl-4><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block text-gray-700 hover:text-primary-600 py-2">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block text-gray-700 hover:text-primary-600 py-2">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block text-gray-700 hover:text-primary-600 py-2">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block text-gray-700 hover:text-primary-600 py-2">回测平台</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化进阶</div><div class=pl-4><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block text-gray-700 hover:text-primary-600 py-2">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block text-gray-700 hover:text-primary-600 py-2">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block text-gray-700 hover:text-primary-600 py-2">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block text-gray-700 hover:text-primary-600 py-2">综合实战</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化高手</div><div class=pl-4><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block text-gray-700 hover:text-primary-600 py-2">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block text-gray-700 hover:text-primary-600 py-2">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block text-gray-700 hover:text-primary-600 py-2">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block text-gray-700 hover:text-primary-600 py-2">股指期货</a></div></div><a href=/pricing class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">服务套餐</a><div class="pt-4 space-y-4"><a href=/contact class="block text-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div></div></div></header><style>.mobile-menu-wrapper{position:relative}.nav-toggle{display:none}.nav-content{display:none}.nav-toggle:checked~header .nav-content{display:block}</style></div></div><div class=pt-20><div class="container mx-auto px-4 py-12"><div class="flex flex-col lg:flex-row gap-8 mb-12"><article class=flex-1><header class=mb-8><div class=mb-4><a href=/categories/%E6%8A%80%E6%9C%AF%E6%8C%87%E6%A0%87 class="inline-block px-3 py-1 text-sm font-medium text-primary-600 bg-primary-50 rounded-full hover:bg-primary-100 mr-2">技术指标</a></div><h1 class="text-4xl font-bold mb-4">技术指标第9讲：多指标综合分析策略</h1><div class="flex flex-col space-y-4"><div class="flex items-center justify-between text-sm text-gray-500"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7A4 4 0 118 7a4 4 0 018 0zm-4 7a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
<span>Ryan</span></div><div class="flex items-center space-x-6"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747.0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746.0-3.332.477-4.5 1.253"/></svg>
<span>18 分钟</span></div><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5A2 2 0 003 7v12a2 2 0 002 2z"/></svg>
<time datetime=2025-09-19>September 19, 2025</time></div></div></div><div class="flex items-center flex-wrap gap-2"><a href=/tags/2025 class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors duration-200">#2025</a></div></div></header><div class=mb-8><img src=/images/blog/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87.jpg alt=技术指标第9讲：多指标综合分析策略 class="w-full h-auto rounded-lg" loading=lazy></div><div class="prose prose-lg max-w-none"><div class="bg-gray-50 p-6 rounded-lg mb-8"><h2 class="text-xl font-semibold mb-4">目录</h2><nav id=TableOfContents><ul><li><a href=#多指标综合分析量化交易的系统论思维>多指标综合分析：量化交易的系统论思维</a></li><li><a href=#八大技术指标协同分析框架>八大技术指标协同分析框架</a><ul><li><a href=#指标分类与功能定位>指标分类与功能定位</a></li><li><a href=#信号权重分配机制>信号权重分配机制</a></li><li><a href=#多时间框架验证体系>多时间框架验证体系</a></li></ul></li><li><a href=#基于talib的多指标python实现>基于talib的多指标Python实现</a><ul><li><a href=#环境配置与数据准备>环境配置与数据准备</a></li><li><a href=#多指标信号生成与评分系统>多指标信号生成与评分系统</a></li><li><a href=#多指标信号可视化与策略回测>多指标信号可视化与策略回测</a></li><li><a href=#高级策略优化与风险控制>高级策略优化与风险控制</a></li><li><a href=#多指标策略的实战应用指南>多指标策略的实战应用指南</a></li></ul></li></ul></nav></div><h2 id=多指标综合分析量化交易的系统论思维>多指标综合分析：量化交易的系统论思维</h2><p>在金融市场的复杂生态系统中，单一技术指标如同盲人摸象，只能触及市场真相的局部维度。多指标综合分析策略基于系统论的整体性原理，通过构建多维度、多层次的信号验证体系，实现对市场价格行为的立体化认知。这种分析方法不仅能够有效过滤假信号，提高交易胜率，更能在不同市场环境下动态调整策略权重，实现风险调整后的收益最大化。</p><p>现代量化交易的发展证明，成功的交易策略必须建立在严谨的多因子分析基础之上。通过将趋势类指标、震荡类指标、成交量指标、波动性指标进行有机整合，我们能够构建一个具有自适应能力的智能交易决策系统。这个系统不仅能够识别市场趋势的强度和方向，更能准确判断市场的风险水平和交易时机，为投资者提供科学、系统的交易指导。</p><p>多指标综合分析的核心价值在于其"信号验证"机制。当多个不同类型的指标同时发出同向信号时，该信号的可靠性呈指数级增长；当指标间出现分歧时，系统会自动降低仓位或暂停交易，有效规避不确定风险。这种基于概率统计的风险控制方法，是传统单指标策略无法比拟的显著优势。</p><h2 id=八大技术指标协同分析框架>八大技术指标协同分析框架</h2><h3 id=指标分类与功能定位>指标分类与功能定位</h3><p><strong>趋势类指标</strong>：包括MA移动平均线、MACD指数平滑异同移动平均线、ADX平均趋向指数。这类指标主要用于识别市场趋势的方向和强度，是多指标系统的"方向舵"。MA提供基础趋势判断，MACD捕捉趋势转折点，ADX量化趋势强度，三者形成完整的趋势分析体系。</p><p><strong>震荡类指标</strong>：包括RSI相对强弱指标、KDJ随机指标。这类指标用于判断市场的超买超卖状态和短期反转时机，是多指标系统的"节拍器"。RSI侧重价格动量分析，KDJ强调价格在波动区间中的相对位置，两者互补提供精准的入场时机信号。</p><p><strong>成交量指标</strong>：主要是OBV能量潮指标。这类指标通过分析成交量与价格的关系，验证价格走势的真实性，是多指标系统的"验证器"。OBV能够有效识别主力资金流向，验证价格突破的有效性，为趋势判断提供重要的辅助确认。</p><p><strong>波动性指标</strong>：包括Bollinger Bands布林带、SAR抛物线转向指标。这类指标用于衡量市场波动性和风险水平，是多指标系统的"风控仪"。布林带通过价格通道反映市场波动区间，SAR提供动态止损价位，共同构成完整的风险管理体系。</p><h3 id=信号权重分配机制>信号权重分配机制</h3><p><strong>基础权重设置</strong>：趋势类指标占总权重的40%（MA:15%，MACD:15%，ADX:10%），震荡类指标占25%（RSI:15%，KDJ:10%），成交量指标占15%（OBV:15%），波动性指标占20%（Bollinger Bands:10%，SAR:10%）。这种权重分配反映了不同指标在交易决策中的相对重要性。</p><p><strong>动态权重调整</strong>：根据市场环境动态调整指标权重。在趋势明显的市场中，提高趋势类指标权重至50%；在震荡市场中，提高震荡类指标权重至35%；在高波动市场中，提高波动性指标权重至30%。这种动态调整机制确保系统在不同市场条件下都能保持最优性能。</p><p><strong>信号强度量化</strong>：将每个指标的信号强度量化为-3到+3的整数，其中-3表示极强的卖出信号，+3表示极强的买入信号，0表示中性或无明显信号。通过加权平均计算综合信号强度，得到-3到+3的综合评分。</p><h3 id=多时间框架验证体系>多时间框架验证体系</h3><p><strong>时间框架选择</strong>：采用三重时间框架验证体系，包括长期（周线）、中期（日线）、短期（60分钟线）三个级别。长期时间框架确定主要趋势方向，中期时间框架识别交易机会，短期时间框架确定具体入场时机。</p><p><strong>信号一致性验证</strong>：要求至少两个时间框架的信号方向一致才能执行交易。当三个时间框架信号完全共振时，增加仓位配置；当只有两个时间框架信号一致时，采用标准仓位；当信号分歧较大时，降低仓位或观望等待。</p><p><strong>时间框架权重分配</strong>：长期时间框架权重占50%，中期占30%，短期占20%。这种权重分配确保交易决策主要基于长期趋势，同时兼顾中期机会和短期时机，实现"看长做短"的交易理念。</p><h2 id=基于talib的多指标python实现>基于talib的多指标Python实现</h2><h3 id=环境配置与数据准备>环境配置与数据准备</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>talib</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>yfinance</span> <span class=k>as</span> <span class=nn>yf</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>warnings</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.preprocessing</span> <span class=kn>import</span> <span class=n>StandardScaler</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.ensemble</span> <span class=kn>import</span> <span class=n>RandomForestClassifier</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.model_selection</span> <span class=kn>import</span> <span class=n>train_test_split</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.metrics</span> <span class=kn>import</span> <span class=n>accuracy_score</span><span class=p>,</span> <span class=n>classification_report</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>seaborn</span> <span class=k>as</span> <span class=nn>sns</span>
</span></span><span class=line><span class=cl><span class=n>warnings</span><span class=o>.</span><span class=n>filterwarnings</span><span class=p>(</span><span class=s1>&#39;ignore&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置中文字体</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>rcParams</span><span class=p>[</span><span class=s1>&#39;font.sans-serif&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;SimHei&#39;</span><span class=p>,</span> <span class=s1>&#39;DejaVu Sans&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>rcParams</span><span class=p>[</span><span class=s1>&#39;axes.unicode_minus&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取股票数据</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_stock_data</span><span class=p>(</span><span class=n>symbol</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=s2>&#34;3y&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;获取股票历史数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>stock</span> <span class=o>=</span> <span class=n>yf</span><span class=o>.</span><span class=n>download</span><span class=p>(</span><span class=n>symbol</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=n>period</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>stock</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;获取数据失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取沪深300指数数据</span>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=n>get_stock_data</span><span class=p>(</span><span class=s2>&#34;000300.SS&#34;</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=s2>&#34;3y&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>high_prices</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;High&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl><span class=n>low_prices</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Low&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl><span class=n>close_prices</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl><span class=n>volume</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Volume&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建日期索引</span>
</span></span><span class=line><span class=cl><span class=n>dates</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;=== 多指标综合分析系统 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;数据获取完成，共</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span><span class=si>}</span><span class=s2>个交易日&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;数据时间范围: </span><span class=si>{</span><span class=n>dates</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1>&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2> 至 </span><span class=si>{</span><span class=n>dates</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1>&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;价格区间: </span><span class=si>{</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>min</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> - </span><span class=si>{</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>max</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 基础市场统计分析</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>analyze_market_conditions</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;分析市场基础状况&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>returns</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>volatility</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算价格位置</span>
</span></span><span class=line><span class=cl>    <span class=n>current_price</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>price_20d_high</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;High&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>tail</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>max</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>price_20d_low</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Low&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>tail</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>min</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>price_position</span> <span class=o>=</span> <span class=p>(</span><span class=n>current_price</span> <span class=o>-</span> <span class=n>price_20d_low</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>price_20d_high</span> <span class=o>-</span> <span class=n>price_20d_low</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算趋势强度</span>
</span></span><span class=line><span class=cl>    <span class=n>ma_20</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>SMA</span><span class=p>(</span><span class=n>close_prices</span><span class=p>,</span> <span class=n>timeperiod</span><span class=o>=</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ma_60</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>SMA</span><span class=p>(</span><span class=n>close_prices</span><span class=p>,</span> <span class=n>timeperiod</span><span class=o>=</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>trend_strength</span> <span class=o>=</span> <span class=p>(</span><span class=n>ma_20</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>ma_60</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=n>ma_60</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;current_price&#39;</span><span class=p>:</span> <span class=n>current_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;volatility&#39;</span><span class=p>:</span> <span class=n>volatility</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;price_position&#39;</span><span class=p>:</span> <span class=n>price_position</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;trend_strength&#39;</span><span class=p>:</span> <span class=n>trend_strength</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;price_20d_high&#39;</span><span class=p>:</span> <span class=n>price_20d_high</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;price_20d_low&#39;</span><span class=p>:</span> <span class=n>price_20d_low</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>market_conditions</span> <span class=o>=</span> <span class=n>analyze_market_conditions</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 当前市场状况分析 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;当前价格: </span><span class=si>{</span><span class=n>market_conditions</span><span class=p>[</span><span class=s1>&#39;current_price&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;年化波动率: </span><span class=si>{</span><span class=n>market_conditions</span><span class=p>[</span><span class=s1>&#39;volatility&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;20日价格位置: </span><span class=si>{</span><span class=n>market_conditions</span><span class=p>[</span><span class=s1>&#39;price_position&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;趋势强度: </span><span class=si>{</span><span class=n>market_conditions</span><span class=p>[</span><span class=s1>&#39;trend_strength&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;20日最高价: </span><span class=si>{</span><span class=n>market_conditions</span><span class=p>[</span><span class=s1>&#39;price_20d_high&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;20日最低价: </span><span class=si>{</span><span class=n>market_conditions</span><span class=p>[</span><span class=s1>&#39;price_20d_low&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 市场环境分类</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>classify_market_environment</span><span class=p>(</span><span class=n>volatility</span><span class=p>,</span> <span class=n>trend_strength</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;分类市场环境&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>volatility</span> <span class=o>&gt;</span> <span class=mf>0.3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>volatility_level</span> <span class=o>=</span> <span class=s2>&#34;高波动&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>volatility</span> <span class=o>&gt;</span> <span class=mf>0.2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>volatility_level</span> <span class=o>=</span> <span class=s2>&#34;中波动&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>volatility_level</span> <span class=o>=</span> <span class=s2>&#34;低波动&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=n>trend_strength</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>trend_level</span> <span class=o>=</span> <span class=s2>&#34;强趋势&#34;</span> <span class=k>if</span> <span class=n>trend_strength</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=s2>&#34;强下跌&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=nb>abs</span><span class=p>(</span><span class=n>trend_strength</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>trend_level</span> <span class=o>=</span> <span class=s2>&#34;弱趋势&#34;</span> <span class=k>if</span> <span class=n>trend_strength</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=s2>&#34;弱下跌&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>trend_level</span> <span class=o>=</span> <span class=s2>&#34;震荡&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>volatility_level</span><span class=si>}</span><span class=s2>-</span><span class=si>{</span><span class=n>trend_level</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>current_environment</span> <span class=o>=</span> <span class=n>classify_market_environment</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>market_conditions</span><span class=p>[</span><span class=s1>&#39;volatility&#39;</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>    <span class=n>market_conditions</span><span class=p>[</span><span class=s1>&#39;trend_strength&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;市场环境分类: </span><span class=si>{</span><span class=n>current_environment</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 基础技术指标计算</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_basic_indicators</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算基础技术指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>high_prices</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;High&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>    <span class=n>low_prices</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Low&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>    <span class=n>close_prices</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>    <span class=n>volume</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Volume&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 趋势指标</span>
</span></span><span class=line><span class=cl>    <span class=n>ma_20</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>SMA</span><span class=p>(</span><span class=n>close_prices</span><span class=p>,</span> <span class=n>timeperiod</span><span class=o>=</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ma_60</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>SMA</span><span class=p>(</span><span class=n>close_prices</span><span class=p>,</span> <span class=n>timeperiod</span><span class=o>=</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>macd</span><span class=p>,</span> <span class=n>macdsignal</span><span class=p>,</span> <span class=n>macdhist</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>MACD</span><span class=p>(</span><span class=n>close_prices</span><span class=p>,</span> <span class=n>fastperiod</span><span class=o>=</span><span class=mi>12</span><span class=p>,</span> <span class=n>slowperiod</span><span class=o>=</span><span class=mi>26</span><span class=p>,</span> <span class=n>signalperiod</span><span class=o>=</span><span class=mi>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>adx</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>ADX</span><span class=p>(</span><span class=n>high_prices</span><span class=p>,</span> <span class=n>low_prices</span><span class=p>,</span> <span class=n>close_prices</span><span class=p>,</span> <span class=n>timeperiod</span><span class=o>=</span><span class=mi>14</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 震荡指标</span>
</span></span><span class=line><span class=cl>    <span class=n>rsi</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>RSI</span><span class=p>(</span><span class=n>close_prices</span><span class=p>,</span> <span class=n>timeperiod</span><span class=o>=</span><span class=mi>14</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>k</span><span class=p>,</span> <span class=n>d</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>STOCH</span><span class=p>(</span><span class=n>high_prices</span><span class=p>,</span> <span class=n>low_prices</span><span class=p>,</span> <span class=n>close_prices</span><span class=p>,</span> <span class=n>fastk_period</span><span class=o>=</span><span class=mi>9</span><span class=p>,</span> <span class=n>slowk_period</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>slowd_period</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 成交量指标</span>
</span></span><span class=line><span class=cl>    <span class=n>obv</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>OBV</span><span class=p>(</span><span class=n>close_prices</span><span class=p>,</span> <span class=n>volume</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 波动性指标</span>
</span></span><span class=line><span class=cl>    <span class=n>upperband</span><span class=p>,</span> <span class=n>middleband</span><span class=p>,</span> <span class=n>lowerband</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>BBANDS</span><span class=p>(</span><span class=n>close_prices</span><span class=p>,</span> <span class=n>timeperiod</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span> <span class=n>nbdevup</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>nbdevdn</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sar</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>SAR</span><span class=p>(</span><span class=n>high_prices</span><span class=p>,</span> <span class=n>low_prices</span><span class=p>,</span> <span class=n>acceleration</span><span class=o>=</span><span class=mf>0.02</span><span class=p>,</span> <span class=n>maximum</span><span class=o>=</span><span class=mf>0.2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;ma_20&#39;</span><span class=p>:</span> <span class=n>ma_20</span><span class=p>,</span> <span class=s1>&#39;ma_60&#39;</span><span class=p>:</span> <span class=n>ma_60</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;macd&#39;</span><span class=p>:</span> <span class=n>macd</span><span class=p>,</span> <span class=s1>&#39;macdsignal&#39;</span><span class=p>:</span> <span class=n>macdsignal</span><span class=p>,</span> <span class=s1>&#39;macdhist&#39;</span><span class=p>:</span> <span class=n>macdhist</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;adx&#39;</span><span class=p>:</span> <span class=n>adx</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;rsi&#39;</span><span class=p>:</span> <span class=n>rsi</span><span class=p>,</span> <span class=s1>&#39;k&#39;</span><span class=p>:</span> <span class=n>k</span><span class=p>,</span> <span class=s1>&#39;d&#39;</span><span class=p>:</span> <span class=n>d</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;obv&#39;</span><span class=p>:</span> <span class=n>obv</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;upperband&#39;</span><span class=p>:</span> <span class=n>upperband</span><span class=p>,</span> <span class=s1>&#39;middleband&#39;</span><span class=p>:</span> <span class=n>middleband</span><span class=p>,</span> <span class=s1>&#39;lowerband&#39;</span><span class=p>:</span> <span class=n>lowerband</span><span class=p>,</span> <span class=s1>&#39;sar&#39;</span><span class=p>:</span> <span class=n>sar</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>indicators</span> <span class=o>=</span> <span class=n>calculate_basic_indicators</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 技术指标计算完成 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;共计算</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>indicators</span><span class=p>)</span><span class=si>}</span><span class=s2>个技术指标&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 数据完整性检查</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_data_completeness</span><span class=p>(</span><span class=n>indicators</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;检查数据完整性&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>completeness</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>values</span> <span class=ow>in</span> <span class=n>indicators</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>values</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>valid_count</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=o>~</span><span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>values</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>total_count</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>completeness</span><span class=p>[</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;valid_count&#39;</span><span class=p>:</span> <span class=n>valid_count</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;total_count&#39;</span><span class=p>:</span> <span class=n>total_count</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;completeness_rate&#39;</span><span class=p>:</span> <span class=n>valid_count</span> <span class=o>/</span> <span class=n>total_count</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>completeness</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>data_completeness</span> <span class=o>=</span> <span class=n>check_data_completeness</span><span class=p>(</span><span class=n>indicators</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 数据完整性检查 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>stats</span> <span class=ow>in</span> <span class=n>data_completeness</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;completeness_rate&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>% (</span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;valid_count&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;total_count&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=多指标信号生成与评分系统>多指标信号生成与评分系统</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 多指标信号生成系统</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MultiIndicatorSignalSystem</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;多指标信号生成系统&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 基础权重设置</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>base_weights</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;ma&#39;</span><span class=p>:</span> <span class=mf>0.15</span><span class=p>,</span> <span class=s1>&#39;macd&#39;</span><span class=p>:</span> <span class=mf>0.15</span><span class=p>,</span> <span class=s1>&#39;adx&#39;</span><span class=p>:</span> <span class=mf>0.10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;rsi&#39;</span><span class=p>:</span> <span class=mf>0.15</span><span class=p>,</span> <span class=s1>&#39;kdj&#39;</span><span class=p>:</span> <span class=mf>0.10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;obv&#39;</span><span class=p>:</span> <span class=mf>0.15</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;bb&#39;</span><span class=p>:</span> <span class=mf>0.10</span><span class=p>,</span> <span class=s1>&#39;sar&#39;</span><span class=p>:</span> <span class=mf>0.10</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 动态权重调整规则</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>dynamic_weights</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;trend_market&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;ma&#39;</span><span class=p>:</span> <span class=mf>0.20</span><span class=p>,</span> <span class=s1>&#39;macd&#39;</span><span class=p>:</span> <span class=mf>0.20</span><span class=p>,</span> <span class=s1>&#39;adx&#39;</span><span class=p>:</span> <span class=mf>0.15</span><span class=p>,</span> <span class=s1>&#39;rsi&#39;</span><span class=p>:</span> <span class=mf>0.10</span><span class=p>,</span> <span class=s1>&#39;kdj&#39;</span><span class=p>:</span> <span class=mf>0.05</span><span class=p>,</span> <span class=s1>&#39;obv&#39;</span><span class=p>:</span> <span class=mf>0.10</span><span class=p>,</span> <span class=s1>&#39;bb&#39;</span><span class=p>:</span> <span class=mf>0.10</span><span class=p>,</span> <span class=s1>&#39;sar&#39;</span><span class=p>:</span> <span class=mf>0.10</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;volatile_market&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;ma&#39;</span><span class=p>:</span> <span class=mf>0.10</span><span class=p>,</span> <span class=s1>&#39;macd&#39;</span><span class=p>:</span> <span class=mf>0.10</span><span class=p>,</span> <span class=s1>&#39;adx&#39;</span><span class=p>:</span> <span class=mf>0.05</span><span class=p>,</span> <span class=s1>&#39;rsi&#39;</span><span class=p>:</span> <span class=mf>0.20</span><span class=p>,</span> <span class=s1>&#39;kdj&#39;</span><span class=p>:</span> <span class=mf>0.15</span><span class=p>,</span> <span class=s1>&#39;obv&#39;</span><span class=p>:</span> <span class=mf>0.10</span><span class=p>,</span> <span class=s1>&#39;bb&#39;</span><span class=p>:</span> <span class=mf>0.20</span><span class=p>,</span> <span class=s1>&#39;sar&#39;</span><span class=p>:</span> <span class=mf>0.10</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sideways_market&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;ma&#39;</span><span class=p>:</span> <span class=mf>0.05</span><span class=p>,</span> <span class=s1>&#39;macd&#39;</span><span class=p>:</span> <span class=mf>0.10</span><span class=p>,</span> <span class=s1>&#39;adx&#39;</span><span class=p>:</span> <span class=mf>0.05</span><span class=p>,</span> <span class=s1>&#39;rsi&#39;</span><span class=p>:</span> <span class=mf>0.25</span><span class=p>,</span> <span class=s1>&#39;kdj&#39;</span><span class=p>:</span> <span class=mf>0.20</span><span class=p>,</span> <span class=s1>&#39;obv&#39;</span><span class=p>:</span> <span class=mf>0.15</span><span class=p>,</span> <span class=s1>&#39;bb&#39;</span><span class=p>:</span> <span class=mf>0.15</span><span class=p>,</span> <span class=s1>&#39;sar&#39;</span><span class=p>:</span> <span class=mf>0.05</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_ma_signals</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>close_prices</span><span class=p>,</span> <span class=n>indicators</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算MA指标信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>ma_20</span> <span class=o>=</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;ma_20&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>ma_60</span> <span class=o>=</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;ma_60&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>close_prices</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># MA金叉死叉信号</span>
</span></span><span class=line><span class=cl>        <span class=n>ma_cross</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>ma_20</span> <span class=o>&gt;</span> <span class=n>ma_60</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ma_cross_signal</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>ma_cross</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 价格相对位置信号</span>
</span></span><span class=line><span class=cl>        <span class=n>price_vs_ma20</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>close_prices</span> <span class=o>&gt;</span> <span class=n>ma_20</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>price_vs_ma60</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>close_prices</span> <span class=o>&gt;</span> <span class=n>ma_60</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 综合MA信号</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>signals</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>ma_cross_signal</span><span class=p>[</span><span class=n>i</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+=</span> <span class=n>ma_cross_signal</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*</span> <span class=mi>2</span>  <span class=c1># 金叉死叉权重较高</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>price_vs_ma20</span><span class=p>[</span><span class=n>i</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+=</span> <span class=n>price_vs_ma20</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>price_vs_ma60</span><span class=p>[</span><span class=n>i</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+=</span> <span class=n>price_vs_ma60</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>signals</span><span class=p>,</span> <span class=o>-</span><span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_macd_signals</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>close_prices</span><span class=p>,</span> <span class=n>indicators</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算MACD指标信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>macd</span> <span class=o>=</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;macd&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>macdsignal</span> <span class=o>=</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;macdsignal&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>macdhist</span> <span class=o>=</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;macdhist&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>close_prices</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># MACD金叉死叉</span>
</span></span><span class=line><span class=cl>        <span class=n>macd_cross</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>macd</span> <span class=o>&gt;</span> <span class=n>macdsignal</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>macd_cross_signal</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>macd_cross</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># MACD零轴穿越</span>
</span></span><span class=line><span class=cl>        <span class=n>zero_cross</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>macd</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>zero_cross_signal</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>zero_cross</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># MACD柱状图变化</span>
</span></span><span class=line><span class=cl>        <span class=n>hist_change</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>macdhist</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>signals</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>macd_cross_signal</span><span class=p>[</span><span class=n>i</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+=</span> <span class=n>macd_cross_signal</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>zero_cross_signal</span><span class=p>[</span><span class=n>i</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+=</span> <span class=n>zero_cross_signal</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*</span> <span class=mf>1.5</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>hist_change</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>hist_change</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+=</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-=</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>signals</span><span class=p>,</span> <span class=o>-</span><span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_rsi_signals</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>close_prices</span><span class=p>,</span> <span class=n>indicators</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算RSI指标信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>rsi</span> <span class=o>=</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;rsi&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>close_prices</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># RSI超买超卖信号</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>signals</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>rsi</span><span class=p>[</span><span class=n>i</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>rsi</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>70</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>2</span>  <span class=c1># 超买卖出信号</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>rsi</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>30</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2</span>   <span class=c1># 超卖买入信号</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>rsi</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>60</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mf>0.5</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>rsi</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>40</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># RSI背离检测</span>
</span></span><span class=line><span class=cl>        <span class=n>price_trend</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>close_prices</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>rsi_trend</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>rsi</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>signals</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>price_trend</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>rsi_trend</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                <span class=c1># 顶背离</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>price_trend</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>rsi_trend</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>rsi</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>70</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                <span class=c1># 底背离</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>price_trend</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>rsi_trend</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>rsi</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>30</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>signals</span><span class=p>,</span> <span class=o>-</span><span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_kdj_signals</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>close_prices</span><span class=p>,</span> <span class=n>indicators</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算KDJ指标信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>k</span> <span class=o>=</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;k&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>d</span> <span class=o>=</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;d&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>close_prices</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># KDJ金叉死叉</span>
</span></span><span class=line><span class=cl>        <span class=n>kdj_cross</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>k</span> <span class=o>&gt;</span> <span class=n>d</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>kdj_cross_signal</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>kdj_cross</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># KDJ超买超卖</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>signals</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>k</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>d</span><span class=p>[</span><span class=n>i</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                <span class=c1># 超买超卖信号</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>k</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>80</span> <span class=ow>and</span> <span class=n>d</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>80</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mf>1.5</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>k</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>20</span> <span class=ow>and</span> <span class=n>d</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>20</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mf>1.5</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 金叉死叉信号</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>kdj_cross_signal</span><span class=p>[</span><span class=n>i</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>kdj_cross_signal</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>k</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>70</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                    <span class=k>elif</span> <span class=n>kdj_cross_signal</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>k</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>30</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>signals</span><span class=p>,</span> <span class=o>-</span><span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_adx_signals</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>close_prices</span><span class=p>,</span> <span class=n>indicators</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算ADX指标信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>adx</span> <span class=o>=</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;adx&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>close_prices</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>signals</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>adx</span><span class=p>[</span><span class=n>i</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                <span class=c1># ADX趋势强度信号</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>adx</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>25</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>  <span class=c1># 强趋势</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>adx</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>20</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mf>0.5</span>  <span class=c1># 中等趋势</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>adx</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>15</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mf>0.5</span>  <span class=c1># 无趋势</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># ADX转折点信号</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>adx_change</span> <span class=o>=</span> <span class=n>adx</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>adx</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>adx_change</span> <span class=o>&gt;</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+=</span> <span class=mf>0.5</span>  <span class=c1># ADX上升</span>
</span></span><span class=line><span class=cl>                    <span class=k>elif</span> <span class=n>adx_change</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-=</span> <span class=mf>0.5</span>  <span class=c1># ADX下降</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>signals</span><span class=p>,</span> <span class=o>-</span><span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_obv_signals</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>close_prices</span><span class=p>,</span> <span class=n>indicators</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算OBV指标信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>obv</span> <span class=o>=</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;obv&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>close_prices</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># OBV趋势分析</span>
</span></span><span class=line><span class=cl>        <span class=n>obv_ma</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>SMA</span><span class=p>(</span><span class=n>obv</span><span class=p>,</span> <span class=n>timeperiod</span><span class=o>=</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>signals</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>obv</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>obv_ma</span><span class=p>[</span><span class=n>i</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                <span class=c1># OBV相对位置</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>obv</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>obv_ma</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>  <span class=c1># OBV在均线上方</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>  <span class=c1># OBV在均线下方</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># OBV背离检测</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>i</span> <span class=o>&gt;</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>price_trend</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>close_prices</span><span class=p>[</span><span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>i</span><span class=o>-</span><span class=mi>10</span><span class=p>):</span><span class=n>i</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>                    <span class=n>obv_trend</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>obv</span><span class=p>[</span><span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>i</span><span class=o>-</span><span class=mi>10</span><span class=p>):</span><span class=n>i</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>price_trend</span><span class=p>)</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>obv_trend</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=c1># 价格上涨但OBV下跌（顶背离）</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=n>price_trend</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>obv_trend</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                        <span class=c1># 价格下跌但OBV上涨（底背离）</span>
</span></span><span class=line><span class=cl>                        <span class=k>elif</span> <span class=n>price_trend</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>obv_trend</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>signals</span><span class=p>,</span> <span class=o>-</span><span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_bb_signals</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>close_prices</span><span class=p>,</span> <span class=n>indicators</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算布林带信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>upperband</span> <span class=o>=</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;upperband&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>middleband</span> <span class=o>=</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;middleband&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>lowerband</span> <span class=o>=</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;lowerband&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>close_prices</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>signals</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>close_prices</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=ow>and</span> 
</span></span><span class=line><span class=cl>                <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>upperband</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=ow>and</span> 
</span></span><span class=line><span class=cl>                <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>lowerband</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=ow>and</span> 
</span></span><span class=line><span class=cl>                <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>middleband</span><span class=p>[</span><span class=n>i</span><span class=p>])):</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 布林带突破信号</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>close_prices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>upperband</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>2</span>  <span class=c1># 突破上轨，卖出信号</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>close_prices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>lowerband</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2</span>   <span class=c1># 突破下轨，买入信号</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 布林带相对位置</span>
</span></span><span class=line><span class=cl>                <span class=n>bb_position</span> <span class=o>=</span> <span class=p>(</span><span class=n>close_prices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>lowerband</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>/</span> <span class=p>(</span><span class=n>upperband</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>lowerband</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>bb_position</span> <span class=o>&gt;</span> <span class=mf>0.8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-=</span> <span class=mf>0.5</span>  <span class=c1># 接近上轨</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>bb_position</span> <span class=o>&lt;</span> <span class=mf>0.2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+=</span> <span class=mf>0.5</span>  <span class=c1># 接近下轨</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 布林带宽度变化</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>bb_width</span> <span class=o>=</span> <span class=n>upperband</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>lowerband</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=n>bb_width_prev</span> <span class=o>=</span> <span class=n>upperband</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>lowerband</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>bb_width</span> <span class=o>&gt;</span> <span class=n>bb_width_prev</span> <span class=o>*</span> <span class=mf>1.1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+=</span> <span class=mf>0.3</span>  <span class=c1># 布林带扩张</span>
</span></span><span class=line><span class=cl>                    <span class=k>elif</span> <span class=n>bb_width</span> <span class=o>&lt;</span> <span class=n>bb_width_prev</span> <span class=o>*</span> <span class=mf>0.9</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-=</span> <span class=mf>0.3</span>  <span class=c1># 布林带收缩</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>signals</span><span class=p>,</span> <span class=o>-</span><span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_sar_signals</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>close_prices</span><span class=p>,</span> <span class=n>indicators</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算SAR信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>sar</span> <span class=o>=</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;sar&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>close_prices</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>signals</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>close_prices</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>sar</span><span class=p>[</span><span class=n>i</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                <span class=c1># SAR转向信号</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>close_prices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>sar</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>  <span class=c1># SAR在价格下方，看涨</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>  <span class=c1># SAR在价格上方，看跌</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># SAR距离分析</span>
</span></span><span class=line><span class=cl>                <span class=n>sar_distance</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>close_prices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>sar</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>/</span> <span class=n>close_prices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>sar_distance</span> <span class=o>&lt;</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*=</span> <span class=mf>1.5</span>  <span class=c1># SAR距离很近，信号强烈</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>sar_distance</span> <span class=o>&gt;</span> <span class=mi>5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*=</span> <span class=mf>0.5</span>  <span class=c1># SAR距离很远，信号较弱</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>signals</span><span class=p>,</span> <span class=o>-</span><span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_comprehensive_signals</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>close_prices</span><span class=p>,</span> <span class=n>indicators</span><span class=p>,</span> <span class=n>market_environment</span><span class=o>=</span><span class=s2>&#34;normal&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算综合信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 计算各指标信号</span>
</span></span><span class=line><span class=cl>        <span class=n>ma_signals</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_ma_signals</span><span class=p>(</span><span class=n>close_prices</span><span class=p>,</span> <span class=n>indicators</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>macd_signals</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_macd_signals</span><span class=p>(</span><span class=n>close_prices</span><span class=p>,</span> <span class=n>indicators</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>rsi_signals</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_rsi_signals</span><span class=p>(</span><span class=n>close_prices</span><span class=p>,</span> <span class=n>indicators</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>kdj_signals</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_kdj_signals</span><span class=p>(</span><span class=n>close_prices</span><span class=p>,</span> <span class=n>indicators</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>adx_signals</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_adx_signals</span><span class=p>(</span><span class=n>close_prices</span><span class=p>,</span> <span class=n>indicators</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>obv_signals</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_obv_signals</span><span class=p>(</span><span class=n>close_prices</span><span class=p>,</span> <span class=n>indicators</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>bb_signals</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_bb_signals</span><span class=p>(</span><span class=n>close_prices</span><span class=p>,</span> <span class=n>indicators</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sar_signals</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_sar_signals</span><span class=p>(</span><span class=n>close_prices</span><span class=p>,</span> <span class=n>indicators</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 选择权重</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>market_environment</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>dynamic_weights</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>weights</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>dynamic_weights</span><span class=p>[</span><span class=n>market_environment</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>weights</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>base_weights</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算加权综合信号</span>
</span></span><span class=line><span class=cl>        <span class=n>comprehensive_signals</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>ma_signals</span> <span class=o>*</span> <span class=n>weights</span><span class=p>[</span><span class=s1>&#39;ma&#39;</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=n>macd_signals</span> <span class=o>*</span> <span class=n>weights</span><span class=p>[</span><span class=s1>&#39;macd&#39;</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=n>rsi_signals</span> <span class=o>*</span> <span class=n>weights</span><span class=p>[</span><span class=s1>&#39;rsi&#39;</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=n>kdj_signals</span> <span class=o>*</span> <span class=n>weights</span><span class=p>[</span><span class=s1>&#39;kdj&#39;</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=n>adx_signals</span> <span class=o>*</span> <span class=n>weights</span><span class=p>[</span><span class=s1>&#39;adx&#39;</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=n>obv_signals</span> <span class=o>*</span> <span class=n>weights</span><span class=p>[</span><span class=s1>&#39;obv&#39;</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=n>bb_signals</span> <span class=o>*</span> <span class=n>weights</span><span class=p>[</span><span class=s1>&#39;bb&#39;</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=n>sar_signals</span> <span class=o>*</span> <span class=n>weights</span><span class=p>[</span><span class=s1>&#39;sar&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 创建信号字典</span>
</span></span><span class=line><span class=cl>        <span class=n>signals_dict</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;ma&#39;</span><span class=p>:</span> <span class=n>ma_signals</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;macd&#39;</span><span class=p>:</span> <span class=n>macd_signals</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;rsi&#39;</span><span class=p>:</span> <span class=n>rsi_signals</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;kdj&#39;</span><span class=p>:</span> <span class=n>kdj_signals</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;adx&#39;</span><span class=p>:</span> <span class=n>adx_signals</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;obv&#39;</span><span class=p>:</span> <span class=n>obv_signals</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;bb&#39;</span><span class=p>:</span> <span class=n>bb_signals</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sar&#39;</span><span class=p>:</span> <span class=n>sar_signals</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;comprehensive&#39;</span><span class=p>:</span> <span class=n>comprehensive_signals</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;weights&#39;</span><span class=p>:</span> <span class=n>weights</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>signals_dict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建信号系统</span>
</span></span><span class=line><span class=cl><span class=n>signal_system</span> <span class=o>=</span> <span class=n>MultiIndicatorSignalSystem</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 计算综合信号</span>
</span></span><span class=line><span class=cl><span class=n>signals</span> <span class=o>=</span> <span class=n>signal_system</span><span class=o>.</span><span class=n>calculate_comprehensive_signals</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>close_prices</span><span class=p>,</span> <span class=n>indicators</span><span class=p>,</span> <span class=n>current_environment</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 多指标信号生成完成 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;当前市场环境: </span><span class=si>{</span><span class=n>current_environment</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;使用权重配置: </span><span class=si>{</span><span class=n>signals</span><span class=p>[</span><span class=s1>&#39;weights&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 信号统计分析</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>analyze_signals</span><span class=p>(</span><span class=n>signals</span><span class=p>,</span> <span class=n>dates</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;分析信号统计特征&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>analysis</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>signal_values</span> <span class=ow>in</span> <span class=n>signals</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>name</span> <span class=o>!=</span> <span class=s1>&#39;weights&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>valid_signals</span> <span class=o>=</span> <span class=n>signal_values</span><span class=p>[</span><span class=o>~</span><span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>signal_values</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>valid_signals</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>analysis</span><span class=p>[</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;mean&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>valid_signals</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;std&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>valid_signals</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;max&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>valid_signals</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;min&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>min</span><span class=p>(</span><span class=n>valid_signals</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;buy_signals&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>valid_signals</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;sell_signals&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>valid_signals</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;neutral_signals&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>valid_signals</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>analysis</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>signal_analysis</span> <span class=o>=</span> <span class=n>analyze_signals</span><span class=p>(</span><span class=n>signals</span><span class=p>,</span> <span class=n>dates</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 信号统计分析 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>stats</span> <span class=ow>in</span> <span class=n>signal_analysis</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  平均值: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;mean&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, 标准差: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;std&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  买入信号: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;buy_signals&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>, 卖出信号: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;sell_signals&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>, 中性信号: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;neutral_signals&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=多指标信号可视化与策略回测>多指标信号可视化与策略回测</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 多指标信号可视化系统</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_comprehensive_signal_chart</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>indicators</span><span class=p>,</span> <span class=n>signals</span><span class=p>,</span> <span class=n>dates</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;创建综合信号图表&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>fig</span><span class=p>,</span> <span class=n>axes</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>20</span><span class=p>,</span> <span class=mi>16</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>fig</span><span class=o>.</span><span class=n>suptitle</span><span class=p>(</span><span class=s1>&#39;多指标综合分析信号系统&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>16</span><span class=p>,</span> <span class=n>fontweight</span><span class=o>=</span><span class=s1>&#39;bold&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 价格与MA指标</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;收盘价&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;black&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;ma_20&#39;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;MA20&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;blue&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;ma_60&#39;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;MA60&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 标记MA信号</span>
</span></span><span class=line><span class=cl>    <span class=n>ma_buy_signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>signals</span><span class=p>[</span><span class=s1>&#39;ma&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>,</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ma_sell_signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>signals</span><span class=p>[</span><span class=s1>&#39;ma&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>ma_buy_signals</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;^&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;买入信号&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>ma_sell_signals</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;v&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;卖出信号&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;价格趋势与MA信号&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># MACD指标</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;macd&#39;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;MACD&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;blue&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;macdsignal&#39;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;信号线&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>bar</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;macdhist&#39;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;柱状图&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;gray&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 标记MACD信号</span>
</span></span><span class=line><span class=cl>    <span class=n>macd_buy_signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>signals</span><span class=p>[</span><span class=s1>&#39;macd&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;macd&#39;</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>macd_sell_signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>signals</span><span class=p>[</span><span class=s1>&#39;macd&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;macd&#39;</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>macd_buy_signals</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;^&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>macd_sell_signals</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;v&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;MACD指标与信号&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>y</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;black&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;-&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># RSI指标</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;rsi&#39;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;RSI&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;purple&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>y</span><span class=o>=</span><span class=mi>70</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;超买线&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>y</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;超卖线&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>y</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;gray&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;-&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 标记RSI信号</span>
</span></span><span class=line><span class=cl>    <span class=n>rsi_buy_signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>signals</span><span class=p>[</span><span class=s1>&#39;rsi&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;rsi&#39;</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rsi_sell_signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>signals</span><span class=p>[</span><span class=s1>&#39;rsi&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;rsi&#39;</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>rsi_buy_signals</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;^&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>rsi_sell_signals</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;v&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;RSI指标与信号&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>set_ylim</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># KDJ指标</span>
</span></span><span class=line><span class=cl>    <span class=n>ax4</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ax4</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;k&#39;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;K&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;blue&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax4</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;d&#39;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;D&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax4</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>y</span><span class=o>=</span><span class=mi>80</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax4</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>y</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 标记KDJ信号</span>
</span></span><span class=line><span class=cl>    <span class=n>kdj_buy_signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>signals</span><span class=p>[</span><span class=s1>&#39;kdj&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;k&#39;</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>kdj_sell_signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>signals</span><span class=p>[</span><span class=s1>&#39;kdj&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;k&#39;</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax4</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>kdj_buy_signals</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;^&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax4</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>kdj_sell_signals</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;v&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax4</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;KDJ指标与信号&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax4</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ax4</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax4</span><span class=o>.</span><span class=n>set_ylim</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># OBV指标</span>
</span></span><span class=line><span class=cl>    <span class=n>ax5</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ax5</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;obv&#39;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;OBV&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;orange&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>obv_ma</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>SMA</span><span class=p>(</span><span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;obv&#39;</span><span class=p>],</span> <span class=n>timeperiod</span><span class=o>=</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax5</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>obv_ma</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;OBV MA20&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 标记OBV信号</span>
</span></span><span class=line><span class=cl>    <span class=n>obv_buy_signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>signals</span><span class=p>[</span><span class=s1>&#39;obv&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;obv&#39;</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>obv_sell_signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>signals</span><span class=p>[</span><span class=s1>&#39;obv&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;obv&#39;</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax5</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>obv_buy_signals</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;^&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax5</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>obv_sell_signals</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;v&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax5</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;OBV能量潮与信号&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax5</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ax5</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 布林带</span>
</span></span><span class=line><span class=cl>    <span class=n>ax6</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ax6</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;收盘价&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;black&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax6</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;upperband&#39;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;上轨&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax6</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;middleband&#39;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;中轨&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;blue&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax6</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;lowerband&#39;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;下轨&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax6</span><span class=o>.</span><span class=n>fill_between</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;upperband&#39;</span><span class=p>],</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;lowerband&#39;</span><span class=p>],</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;gray&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 标记布林带信号</span>
</span></span><span class=line><span class=cl>    <span class=n>bb_buy_signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>signals</span><span class=p>[</span><span class=s1>&#39;bb&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>,</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>bb_sell_signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>signals</span><span class=p>[</span><span class=s1>&#39;bb&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax6</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>bb_buy_signals</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;^&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax6</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>bb_sell_signals</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;v&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax6</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;布林带与信号&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax6</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ax6</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># ADX指标</span>
</span></span><span class=line><span class=cl>    <span class=n>ax7</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ax7</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;adx&#39;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;ADX&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;brown&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax7</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>y</span><span class=o>=</span><span class=mi>25</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;强趋势线&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax7</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>y</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;orange&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;趋势线&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax7</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>y</span><span class=o>=</span><span class=mi>15</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;gray&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;弱趋势线&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 标记ADX信号</span>
</span></span><span class=line><span class=cl>    <span class=n>adx_strong_signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>signals</span><span class=p>[</span><span class=s1>&#39;adx&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;adx&#39;</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>adx_weak_signals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>signals</span><span class=p>[</span><span class=s1>&#39;adx&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>,</span> <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;adx&#39;</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax7</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>adx_strong_signals</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;^&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax7</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>adx_weak_signals</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;v&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax7</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;ADX趋势强度与信号&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax7</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ax7</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 综合信号</span>
</span></span><span class=line><span class=cl>    <span class=n>ax8</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ax8</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;comprehensive&#39;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;综合信号&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;purple&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax8</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>y</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;强买入线&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax8</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>y</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;lightgreen&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;买入线&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax8</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>y</span><span class=o>=-</span><span class=mi>1</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;lightcoral&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;卖出线&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax8</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>y</span><span class=o>=-</span><span class=mi>2</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;强卖出线&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax8</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>y</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;black&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;-&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 标记综合信号</span>
</span></span><span class=line><span class=cl>    <span class=n>strong_buy</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>signals</span><span class=p>[</span><span class=s1>&#39;comprehensive&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>2</span><span class=p>,</span> <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;comprehensive&#39;</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>strong_sell</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>signals</span><span class=p>[</span><span class=s1>&#39;comprehensive&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mi>2</span><span class=p>,</span> <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;comprehensive&#39;</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax8</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>strong_buy</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;darkgreen&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;^&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.9</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;强烈买入&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax8</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>strong_sell</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;darkred&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;v&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.9</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;强烈卖出&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax8</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;多指标综合信号&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax8</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ax8</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax8</span><span class=o>.</span><span class=n>set_ylim</span><span class=p>(</span><span class=o>-</span><span class=mf>3.5</span><span class=p>,</span> <span class=mf>3.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建综合图表</span>
</span></span><span class=line><span class=cl><span class=n>create_comprehensive_signal_chart</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>indicators</span><span class=p>,</span> <span class=n>signals</span><span class=p>,</span> <span class=n>dates</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 策略回测系统</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>backtest_multi_indicator_strategy</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>signals</span><span class=p>,</span> <span class=n>initial_capital</span><span class=o>=</span><span class=mi>100000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;多指标策略回测&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>close_prices</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>    <span class=n>dates</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 生成交易信号</span>
</span></span><span class=line><span class=cl>    <span class=n>comprehensive_signals</span> <span class=o>=</span> <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;comprehensive&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 创建交易规则</span>
</span></span><span class=line><span class=cl>    <span class=n>positions</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>close_prices</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>cash</span> <span class=o>=</span> <span class=n>initial_capital</span>
</span></span><span class=line><span class=cl>    <span class=n>holdings</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>portfolio_values</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>trades</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>close_prices</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>current_price</span> <span class=o>=</span> <span class=n>close_prices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>current_signal</span> <span class=o>=</span> <span class=n>comprehensive_signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 买入条件：综合信号 &gt; 1.5 且不在超买状态</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>current_signal</span> <span class=o>&gt;</span> <span class=mf>1.5</span> <span class=ow>and</span> <span class=n>positions</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 计算买入数量</span>
</span></span><span class=line><span class=cl>            <span class=n>buy_amount</span> <span class=o>=</span> <span class=n>cash</span> <span class=o>*</span> <span class=mf>0.95</span>  <span class=c1># 使用95%资金</span>
</span></span><span class=line><span class=cl>            <span class=n>shares_to_buy</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>buy_amount</span> <span class=o>/</span> <span class=n>current_price</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>shares_to_buy</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>holdings</span> <span class=o>=</span> <span class=n>shares_to_buy</span>
</span></span><span class=line><span class=cl>                <span class=n>cash</span> <span class=o>-=</span> <span class=n>shares_to_buy</span> <span class=o>*</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>                <span class=n>positions</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>holdings</span>
</span></span><span class=line><span class=cl>                <span class=n>trades</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;buy&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>current_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;shares&#39;</span><span class=p>:</span> <span class=n>shares_to_buy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;value&#39;</span><span class=p>:</span> <span class=n>shares_to_buy</span> <span class=o>*</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 卖出条件：综合信号 &lt; -1.5 或止损</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>current_signal</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mf>1.5</span> <span class=ow>and</span> <span class=n>positions</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>holdings</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>cash</span> <span class=o>+=</span> <span class=n>holdings</span> <span class=o>*</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>                <span class=n>trades</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;sell&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>current_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;shares&#39;</span><span class=p>:</span> <span class=n>holdings</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;value&#39;</span><span class=p>:</span> <span class=n>holdings</span> <span class=o>*</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>                <span class=n>holdings</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=n>positions</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 保持原有仓位</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>positions</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>positions</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算组合价值</span>
</span></span><span class=line><span class=cl>        <span class=n>portfolio_value</span> <span class=o>=</span> <span class=n>cash</span> <span class=o>+</span> <span class=n>holdings</span> <span class=o>*</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>        <span class=n>portfolio_values</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>portfolio_value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算策略表现</span>
</span></span><span class=line><span class=cl>    <span class=n>strategy_returns</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>portfolio_values</span><span class=p>)</span> <span class=o>/</span> <span class=n>portfolio_values</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>buy_hold_returns</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>close_prices</span><span class=p>[</span><span class=mi>1</span><span class=p>:])</span> <span class=o>/</span> <span class=n>close_prices</span><span class=p>[</span><span class=mi>1</span><span class=p>:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算性能指标</span>
</span></span><span class=line><span class=cl>    <span class=n>total_return</span> <span class=o>=</span> <span class=p>(</span><span class=n>portfolio_values</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>initial_capital</span><span class=p>)</span> <span class=o>/</span> <span class=n>initial_capital</span>
</span></span><span class=line><span class=cl>    <span class=n>buy_hold_return</span> <span class=o>=</span> <span class=p>(</span><span class=n>close_prices</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>close_prices</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=n>close_prices</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>strategy_volatility</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>strategy_returns</span><span class=p>)</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>buy_hold_volatility</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>buy_hold_returns</span><span class=p>)</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算夏普比率</span>
</span></span><span class=line><span class=cl>    <span class=n>risk_free_rate</span> <span class=o>=</span> <span class=mf>0.03</span>
</span></span><span class=line><span class=cl>    <span class=n>strategy_sharpe</span> <span class=o>=</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>strategy_returns</span><span class=p>)</span> <span class=o>*</span> <span class=mi>252</span> <span class=o>-</span> <span class=n>risk_free_rate</span><span class=p>)</span> <span class=o>/</span> <span class=n>strategy_volatility</span>
</span></span><span class=line><span class=cl>    <span class=n>buy_hold_sharpe</span> <span class=o>=</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>buy_hold_returns</span><span class=p>)</span> <span class=o>*</span> <span class=mi>252</span> <span class=o>-</span> <span class=n>risk_free_rate</span><span class=p>)</span> <span class=o>/</span> <span class=n>buy_hold_volatility</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算最大回撤</span>
</span></span><span class=line><span class=cl>    <span class=n>running_max</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>maximum</span><span class=o>.</span><span class=n>accumulate</span><span class=p>(</span><span class=n>portfolio_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>drawdown</span> <span class=o>=</span> <span class=p>(</span><span class=n>portfolio_values</span> <span class=o>-</span> <span class=n>running_max</span><span class=p>)</span> <span class=o>/</span> <span class=n>running_max</span>
</span></span><span class=line><span class=cl>    <span class=n>max_drawdown</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>min</span><span class=p>(</span><span class=n>drawdown</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;total_trades&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>trades</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;total_return&#39;</span><span class=p>:</span> <span class=n>total_return</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;buy_hold_return&#39;</span><span class=p>:</span> <span class=n>buy_hold_return</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;excess_return&#39;</span><span class=p>:</span> <span class=n>total_return</span> <span class=o>-</span> <span class=n>buy_hold_return</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;strategy_volatility&#39;</span><span class=p>:</span> <span class=n>strategy_volatility</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;buy_hold_volatility&#39;</span><span class=p>:</span> <span class=n>buy_hold_volatility</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;strategy_sharpe&#39;</span><span class=p>:</span> <span class=n>strategy_sharpe</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;buy_hold_sharpe&#39;</span><span class=p>:</span> <span class=n>buy_hold_sharpe</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;max_drawdown&#39;</span><span class=p>:</span> <span class=n>max_drawdown</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;portfolio_values&#39;</span><span class=p>:</span> <span class=n>portfolio_values</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;trades&#39;</span><span class=p>:</span> <span class=n>trades</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;dates&#39;</span><span class=p>:</span> <span class=n>dates</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行策略回测</span>
</span></span><span class=line><span class=cl><span class=n>backtest_results</span> <span class=o>=</span> <span class=n>backtest_multi_indicator_strategy</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>signals</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 输出回测结果</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 多指标策略回测结果 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;总交易次数: </span><span class=si>{</span><span class=n>backtest_results</span><span class=p>[</span><span class=s1>&#39;total_trades&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;策略总收益率: </span><span class=si>{</span><span class=n>backtest_results</span><span class=p>[</span><span class=s1>&#39;total_return&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;买入持有收益率: </span><span class=si>{</span><span class=n>backtest_results</span><span class=p>[</span><span class=s1>&#39;buy_hold_return&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;超额收益率: </span><span class=si>{</span><span class=n>backtest_results</span><span class=p>[</span><span class=s1>&#39;excess_return&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;策略波动率: </span><span class=si>{</span><span class=n>backtest_results</span><span class=p>[</span><span class=s1>&#39;strategy_volatility&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;买入持有波动率: </span><span class=si>{</span><span class=n>backtest_results</span><span class=p>[</span><span class=s1>&#39;buy_hold_volatility&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;策略夏普比率: </span><span class=si>{</span><span class=n>backtest_results</span><span class=p>[</span><span class=s1>&#39;strategy_sharpe&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;买入持有夏普比率: </span><span class=si>{</span><span class=n>backtest_results</span><span class=p>[</span><span class=s1>&#39;buy_hold_sharpe&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最大回撤: </span><span class=si>{</span><span class=n>backtest_results</span><span class=p>[</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建回测结果图表</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_backtest_chart</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>backtest_results</span><span class=p>,</span> <span class=n>signals</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;创建回测结果图表&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>fig</span><span class=p>,</span> <span class=n>axes</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span> <span class=mi>12</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>fig</span><span class=o>.</span><span class=n>suptitle</span><span class=p>(</span><span class=s1>&#39;多指标策略回测结果&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>16</span><span class=p>,</span> <span class=n>fontweight</span><span class=o>=</span><span class=s1>&#39;bold&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>dates</span> <span class=o>=</span> <span class=n>backtest_results</span><span class=p>[</span><span class=s1>&#39;dates&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>portfolio_values</span> <span class=o>=</span> <span class=n>backtest_results</span><span class=p>[</span><span class=s1>&#39;portfolio_values&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 组合价值对比</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>portfolio_values</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;多指标策略&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;blue&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算买入持有组合价值</span>
</span></span><span class=line><span class=cl>    <span class=n>initial_capital</span> <span class=o>=</span> <span class=mi>100000</span>
</span></span><span class=line><span class=cl>    <span class=n>buy_hold_values</span> <span class=o>=</span> <span class=n>initial_capital</span> <span class=o>*</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>][</span><span class=mi>1</span><span class=p>:]</span> <span class=o>/</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>buy_hold_values</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;买入持有&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;gray&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;组合价值对比&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;组合价值 (元)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 收益率对比</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>strategy_returns</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>portfolio_values</span><span class=p>)</span> <span class=o>/</span> <span class=n>portfolio_values</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>buy_hold_returns</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>buy_hold_values</span><span class=p>)</span> <span class=o>/</span> <span class=n>buy_hold_values</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>[</span><span class=mi>1</span><span class=p>:],</span> <span class=n>strategy_returns</span><span class=o>*</span><span class=mi>100</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;策略日收益率&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;blue&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>[</span><span class=mi>1</span><span class=p>:],</span> <span class=n>buy_hold_returns</span><span class=o>*</span><span class=mi>100</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;买入持有日收益率&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;gray&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;日收益率对比&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;日收益率 (%)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 回撤分析</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>running_max</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>maximum</span><span class=o>.</span><span class=n>accumulate</span><span class=p>(</span><span class=n>portfolio_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>strategy_drawdown</span> <span class=o>=</span> <span class=p>(</span><span class=n>portfolio_values</span> <span class=o>-</span> <span class=n>running_max</span><span class=p>)</span> <span class=o>/</span> <span class=n>running_max</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>running_max_bh</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>maximum</span><span class=o>.</span><span class=n>accumulate</span><span class=p>(</span><span class=n>buy_hold_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>buy_hold_drawdown</span> <span class=o>=</span> <span class=p>(</span><span class=n>buy_hold_values</span> <span class=o>-</span> <span class=n>running_max_bh</span><span class=p>)</span> <span class=o>/</span> <span class=n>running_max_bh</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>fill_between</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>strategy_drawdown</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;策略回撤&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>fill_between</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>buy_hold_drawdown</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;gray&#39;</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;买入持有回撤&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;回撤对比&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;回撤 (%)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;日期&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建回测图表</span>
</span></span><span class=line><span class=cl><span class=n>create_backtest_chart</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>backtest_results</span><span class=p>,</span> <span class=n>signals</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=高级策略优化与风险控制>高级策略优化与风险控制</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 高级策略优化系统</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AdvancedStrategyOptimizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;高级策略优化器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>optimization_results</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>optimize_signal_thresholds</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>signals</span><span class=p>,</span> <span class=n>threshold_range</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>3.0</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;优化信号阈值&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>best_threshold</span> <span class=o>=</span> <span class=mf>1.5</span>
</span></span><span class=line><span class=cl>        <span class=n>best_sharpe</span> <span class=o>=</span> <span class=o>-</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span>
</span></span><span class=line><span class=cl>        <span class=n>optimization_results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>buy_threshold</span> <span class=ow>in</span> <span class=n>threshold_range</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>sell_threshold</span> <span class=ow>in</span> <span class=n>threshold_range</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 临时修改信号阈值</span>
</span></span><span class=line><span class=cl>                <span class=n>temp_signals</span> <span class=o>=</span> <span class=n>signals</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>temp_signals</span><span class=p>[</span><span class=s1>&#39;comprehensive&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;comprehensive&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>buy_threshold</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;comprehensive&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>signals</span><span class=p>[</span><span class=s1>&#39;comprehensive&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=o>-</span><span class=n>sell_threshold</span><span class=p>,</span> <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;comprehensive&#39;</span><span class=p>],</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 回测</span>
</span></span><span class=line><span class=cl>                <span class=n>results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>quick_backtest</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>temp_signals</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;sharpe&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>best_sharpe</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>best_sharpe</span> <span class=o>=</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;sharpe&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=n>best_threshold</span> <span class=o>=</span> <span class=p>(</span><span class=n>buy_threshold</span><span class=p>,</span> <span class=n>sell_threshold</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>optimization_results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;buy_threshold&#39;</span><span class=p>:</span> <span class=n>buy_threshold</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;sell_threshold&#39;</span><span class=p>:</span> <span class=n>sell_threshold</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;sharpe&#39;</span><span class=p>:</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;sharpe&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;total_return&#39;</span><span class=p>:</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;total_return&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;max_drawdown&#39;</span><span class=p>:</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>best_threshold</span><span class=p>,</span> <span class=n>optimization_results</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>quick_backtest</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>signals</span><span class=p>,</span> <span class=n>initial_capital</span><span class=o>=</span><span class=mi>100000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;快速回测&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>close_prices</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>        <span class=n>comprehensive_signals</span> <span class=o>=</span> <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;comprehensive&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>positions</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>close_prices</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>cash</span> <span class=o>=</span> <span class=n>initial_capital</span>
</span></span><span class=line><span class=cl>        <span class=n>holdings</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=n>portfolio_values</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>close_prices</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>current_price</span> <span class=o>=</span> <span class=n>close_prices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>current_signal</span> <span class=o>=</span> <span class=n>comprehensive_signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 简化交易规则</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_signal</span> <span class=o>&gt;</span> <span class=mf>1.5</span> <span class=ow>and</span> <span class=n>positions</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>shares_to_buy</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>cash</span> <span class=o>*</span> <span class=mf>0.95</span> <span class=o>/</span> <span class=n>current_price</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>shares_to_buy</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>holdings</span> <span class=o>=</span> <span class=n>shares_to_buy</span>
</span></span><span class=line><span class=cl>                    <span class=n>cash</span> <span class=o>-=</span> <span class=n>shares_to_buy</span> <span class=o>*</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>                    <span class=n>positions</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>holdings</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>current_signal</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mf>1.5</span> <span class=ow>and</span> <span class=n>positions</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>holdings</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>cash</span> <span class=o>+=</span> <span class=n>holdings</span> <span class=o>*</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>                    <span class=n>holdings</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                    <span class=n>positions</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>positions</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>positions</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>portfolio_value</span> <span class=o>=</span> <span class=n>cash</span> <span class=o>+</span> <span class=n>holdings</span> <span class=o>*</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>            <span class=n>portfolio_values</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>portfolio_value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算性能指标</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>portfolio_values</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>returns</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>portfolio_values</span><span class=p>)</span> <span class=o>/</span> <span class=n>portfolio_values</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>total_return</span> <span class=o>=</span> <span class=p>(</span><span class=n>portfolio_values</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>initial_capital</span><span class=p>)</span> <span class=o>/</span> <span class=n>initial_capital</span>
</span></span><span class=line><span class=cl>            <span class=n>volatility</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>sharpe</span> <span class=o>=</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span> <span class=o>*</span> <span class=mi>252</span> <span class=o>-</span> <span class=mf>0.03</span><span class=p>)</span> <span class=o>/</span> <span class=n>volatility</span> <span class=k>if</span> <span class=n>volatility</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>running_max</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>maximum</span><span class=o>.</span><span class=n>accumulate</span><span class=p>(</span><span class=n>portfolio_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>drawdown</span> <span class=o>=</span> <span class=p>(</span><span class=n>portfolio_values</span> <span class=o>-</span> <span class=n>running_max</span><span class=p>)</span> <span class=o>/</span> <span class=n>running_max</span>
</span></span><span class=line><span class=cl>            <span class=n>max_drawdown</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>min</span><span class=p>(</span><span class=n>drawdown</span><span class=p>)</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>drawdown</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>total_return</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=n>sharpe</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=n>max_drawdown</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_return&#39;</span><span class=p>:</span> <span class=n>total_return</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sharpe&#39;</span><span class=p>:</span> <span class=n>sharpe</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max_drawdown&#39;</span><span class=p>:</span> <span class=n>max_drawdown</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>implement_dynamic_risk_management</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>signals</span><span class=p>,</span> <span class=n>base_position_size</span><span class=o>=</span><span class=mf>0.1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;实施动态风险管理&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>close_prices</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算市场波动性</span>
</span></span><span class=line><span class=cl>        <span class=n>returns</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>close_prices</span><span class=p>)</span> <span class=o>/</span> <span class=n>close_prices</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>volatility</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算ATR（平均真实波幅）</span>
</span></span><span class=line><span class=cl>        <span class=n>high_prices</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;High&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>        <span class=n>low_prices</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Low&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>        <span class=n>atr</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>ATR</span><span class=p>(</span><span class=n>high_prices</span><span class=p>,</span> <span class=n>low_prices</span><span class=p>,</span> <span class=n>close_prices</span><span class=p>,</span> <span class=n>timeperiod</span><span class=o>=</span><span class=mi>14</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 动态仓位调整</span>
</span></span><span class=line><span class=cl>        <span class=n>position_sizes</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>close_prices</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>stop_losses</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>close_prices</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>close_prices</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>current_price</span> <span class=o>=</span> <span class=n>close_prices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>current_atr</span> <span class=o>=</span> <span class=n>atr</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>atr</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=k>else</span> <span class=n>current_price</span> <span class=o>*</span> <span class=mf>0.02</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 基于波动性的仓位调整</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>volatility</span> <span class=o>&lt;</span> <span class=mf>0.15</span><span class=p>:</span>  <span class=c1># 低波动</span>
</span></span><span class=line><span class=cl>                <span class=n>position_size</span> <span class=o>=</span> <span class=n>base_position_size</span> <span class=o>*</span> <span class=mf>1.5</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>volatility</span> <span class=o>&lt;</span> <span class=mf>0.25</span><span class=p>:</span>  <span class=c1># 中等波动</span>
</span></span><span class=line><span class=cl>                <span class=n>position_size</span> <span class=o>=</span> <span class=n>base_position_size</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>  <span class=c1># 高波动</span>
</span></span><span class=line><span class=cl>                <span class=n>position_size</span> <span class=o>=</span> <span class=n>base_position_size</span> <span class=o>*</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 基于ATR的止损设置</span>
</span></span><span class=line><span class=cl>            <span class=n>stop_loss</span> <span class=o>=</span> <span class=n>current_price</span> <span class=o>-</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>current_atr</span>  <span class=c1># 多头止损</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>position_sizes</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>position_size</span>
</span></span><span class=line><span class=cl>            <span class=n>stop_losses</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>stop_loss</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;position_sizes&#39;</span><span class=p>:</span> <span class=n>position_sizes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;stop_losses&#39;</span><span class=p>:</span> <span class=n>stop_losses</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;volatility&#39;</span><span class=p>:</span> <span class=n>volatility</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_risk_management_system</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>signals</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;创建风险管理系统&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 动态风险管理</span>
</span></span><span class=line><span class=cl>        <span class=n>risk_mgmt</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>implement_dynamic_risk_management</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>signals</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 综合风险评估</span>
</span></span><span class=line><span class=cl>        <span class=n>comprehensive_signals</span> <span class=o>=</span> <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;comprehensive&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>risk_levels</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=n>risk_recommendations</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>])):</span>
</span></span><span class=line><span class=cl>            <span class=n>current_signal</span> <span class=o>=</span> <span class=n>comprehensive_signals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>current_volatility</span> <span class=o>=</span> <span class=n>risk_mgmt</span><span class=p>[</span><span class=s1>&#39;volatility&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 综合风险评分</span>
</span></span><span class=line><span class=cl>            <span class=n>risk_score</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 信号强度风险</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=n>current_signal</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mf>2.5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>risk_score</span> <span class=o>+=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=nb>abs</span><span class=p>(</span><span class=n>current_signal</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mf>1.5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>risk_score</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 波动性风险</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_volatility</span> <span class=o>&gt;</span> <span class=mf>0.3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>risk_score</span> <span class=o>+=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>current_volatility</span> <span class=o>&gt;</span> <span class=mf>0.2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>risk_score</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 市场环境风险</span>
</span></span><span class=line><span class=cl>            <span class=n>price_position</span> <span class=o>=</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Low&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>tail</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>min</span><span class=p>())</span> <span class=o>/</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;High&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>tail</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>max</span><span class=p>()</span> <span class=o>-</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Low&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>tail</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>min</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>price_position</span> <span class=o>&gt;</span> <span class=mf>0.8</span> <span class=ow>or</span> <span class=n>price_position</span> <span class=o>&lt;</span> <span class=mf>0.2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>risk_score</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>risk_levels</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>risk_score</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 生成风险建议</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>risk_score</span> <span class=o>&gt;=</span> <span class=mi>4</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>recommendation</span> <span class=o>=</span> <span class=s2>&#34;高风险 - 建议减仓或观望&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>risk_score</span> <span class=o>&gt;=</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>recommendation</span> <span class=o>=</span> <span class=s2>&#34;中等风险 - 谨慎操作，控制仓位&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>recommendation</span> <span class=o>=</span> <span class=s2>&#34;低风险 - 可以正常操作&#34;</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>risk_recommendations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>recommendation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;risk_levels&#39;</span><span class=p>:</span> <span class=n>risk_levels</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;risk_recommendations&#39;</span><span class=p>:</span> <span class=n>risk_recommendations</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;risk_management&#39;</span><span class=p>:</span> <span class=n>risk_mgmt</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建优化器</span>
</span></span><span class=line><span class=cl><span class=n>optimizer</span> <span class=o>=</span> <span class=n>AdvancedStrategyOptimizer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 优化信号阈值</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 开始信号阈值优化 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>best_thresholds</span><span class=p>,</span> <span class=n>optimization_results</span> <span class=o>=</span> <span class=n>optimizer</span><span class=o>.</span><span class=n>optimize_signal_thresholds</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>signals</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最优阈值设置: 买入=</span><span class=si>{</span><span class=n>best_thresholds</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>, 卖出=</span><span class=si>{</span><span class=n>best_thresholds</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建风险管理系统</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 创建风险管理系统 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>risk_system</span> <span class=o>=</span> <span class=n>optimizer</span><span class=o>.</span><span class=n>create_risk_management_system</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>signals</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 输出当前风险评估</span>
</span></span><span class=line><span class=cl><span class=n>current_risk_level</span> <span class=o>=</span> <span class=n>risk_system</span><span class=p>[</span><span class=s1>&#39;risk_levels&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>current_recommendation</span> <span class=o>=</span> <span class=n>risk_system</span><span class=p>[</span><span class=s1>&#39;risk_recommendations&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>current_position_size</span> <span class=o>=</span> <span class=n>risk_system</span><span class=p>[</span><span class=s1>&#39;risk_management&#39;</span><span class=p>][</span><span class=s1>&#39;position_sizes&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;当前风险等级: </span><span class=si>{</span><span class=n>current_risk_level</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;风险建议: </span><span class=si>{</span><span class=n>current_recommendation</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;建议仓位大小: </span><span class=si>{</span><span class=n>current_position_size</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建风险管理图表</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_risk_management_chart</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>risk_system</span><span class=p>,</span> <span class=n>signals</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;创建风险管理图表&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>fig</span><span class=p>,</span> <span class=n>axes</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>fig</span><span class=o>.</span><span class=n>suptitle</span><span class=p>(</span><span class=s1>&#39;风险管理系统分析&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>16</span><span class=p>,</span> <span class=n>fontweight</span><span class=o>=</span><span class=s1>&#39;bold&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>dates</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 风险等级时序图</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>risk_system</span><span class=p>[</span><span class=s1>&#39;risk_levels&#39;</span><span class=p>],</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;风险等级&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>y</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;darkred&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;高风险线&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>y</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;orange&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;中等风险线&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>fill_between</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>risk_system</span><span class=p>[</span><span class=s1>&#39;risk_levels&#39;</span><span class=p>],</span> <span class=mi>0</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;风险等级时序图&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;风险等级&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 动态仓位建议</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>risk_system</span><span class=p>[</span><span class=s1>&#39;risk_management&#39;</span><span class=p>][</span><span class=s1>&#39;position_sizes&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mi>100</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>             <span class=n>color</span><span class=o>=</span><span class=s1>&#39;blue&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;建议仓位 (%)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>fill_between</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>risk_system</span><span class=p>[</span><span class=s1>&#39;risk_management&#39;</span><span class=p>][</span><span class=s1>&#39;position_sizes&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mi>100</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                     <span class=mi>0</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;blue&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;动态仓位管理&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;仓位大小 (%)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>set_ylim</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 综合信号与风险对比</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;comprehensive&#39;</span><span class=p>],</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;purple&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;综合信号&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3_twin</span> <span class=o>=</span> <span class=n>ax3</span><span class=o>.</span><span class=n>twinx</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3_twin</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>dates</span><span class=p>,</span> <span class=n>risk_system</span><span class=p>[</span><span class=s1>&#39;risk_levels&#39;</span><span class=p>],</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                  <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;风险等级&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;信号强度与风险等级对比&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;综合信号&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;purple&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3_twin</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;风险等级&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>legend</span><span class=p>(</span><span class=n>loc</span><span class=o>=</span><span class=s1>&#39;upper left&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3_twin</span><span class=o>.</span><span class=n>legend</span><span class=p>(</span><span class=n>loc</span><span class=o>=</span><span class=s1>&#39;upper right&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建风险管理图表</span>
</span></span><span class=line><span class=cl><span class=n>create_risk_management_chart</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>risk_system</span><span class=p>,</span> <span class=n>signals</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=多指标策略的实战应用指南>多指标策略的实战应用指南</h3><p>基于上述多指标综合分析系统的构建与实践，我们可以总结出一套完整的实战应用框架。这个框架不仅包含了技术指标的有机整合，更重要的是建立了科学的决策流程和风险管理体系，为投资者提供了系统性的交易指导。</p><p><strong>信号验证机制</strong>是多指标策略成功的关键。在实际应用中，投资者应该建立三层验证体系：第一层是指标类型验证，确保趋势类、震荡类、成交量类、波动性类指标的信号方向一致；第二层是时间框架验证，要求长期、中期、短期三个时间维度的信号达到基本共振；第三层是市场环境验证，根据当前市场状态动态调整信号权重和阈值参数。这种多重验证机制能够有效过滤虚假信号，显著提高交易胜率。</p><p><strong>动态权重调整</strong>策略使系统具备了自适应能力。在不同的市场环境下，各类指标的预测能力存在显著差异。趋势类指标在单边行情中表现优异，但在震荡市场中会产生大量虚假信号；震荡类指标在区间波动中效果显著，但在趋势行情中容易过早发出反转信号。通过实时监测市场波动率、趋势强度、价格位置等关键参数，系统能够智能调整指标权重，确保在各种市场条件下都能保持稳定的预测性能。</p><p><strong>风险控制体系</strong>是策略长期盈利的保障。多指标策略通过多层次风险控制机制，有效管理交易风险：在仓位管理层面，采用基于波动率的动态仓位调整，在高风险时期自动降低仓位，在低风险时期适度提高杠杆；在止损设置层面，结合ATR指标设置动态止损位，既避免了固定止损的僵化性，又确保了风险的可控性；在资金管理层面，通过分散投资、分批建仓等方式，降低单一交易对整体组合的冲击。</p><p><strong>策略优化与迭代</strong>是保持竞争优势的必要手段。金融市场是动态变化的，任何策略都需要持续优化才能适应新的市场环境。投资者应该建立定期的策略评估机制，通过回测分析、实盘验证、参数优化等方法，不断改进策略性能。同时，要关注新兴技术指标和交易理念的发展，适时引入新的分析工具，保持策略的先进性和有效性。</p><p>多指标综合分析策略代表了量化交易的发展方向，它通过科学的系统化方法，将复杂的市场信息转化为可操作的交易信号。这种策略不仅能够提高交易的成功率，更重要的是能够帮助投资者建立正确的交易思维和风险意识，实现长期稳定的盈利目标。随着人工智能和机器学习技术的发展，多指标策略将朝着更加智能化、个性化的方向演进，为投资者提供更加精准和可靠的交易决策支持。</p></div></article><aside class="lg:w-80 xl:w-96"><div class=space-y-8></div></aside></div><nav class="border-t border-gray-200 mt-12 pt-8"><div class="flex justify-between items-center"><a href=/blog/%E6%8A%80%E6%9C%AF%E6%8C%87%E6%A0%87/08-sar%E6%8A%9B%E7%89%A9%E7%BA%BF%E8%BD%AC%E5%90%91%E6%8C%87%E6%A0%87/ class="group flex items-center"><svg class="w-5 h-5 mr-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0 7-7m-7 7h18"/></svg><div><div class="text-sm text-gray-600">上一篇</div><div class="font-medium group-hover:text-primary-600">技术指标第8讲：SAR抛物线转向指标</div></div></a><a href=/blog/content-management-hugo/ class="group flex items-center text-right"><div><div class="text-sm text-gray-600">Next Post</div><div class="font-medium group-hover:text-primary-600">敬请期待</div></div><svg class="w-5 h-5 ml-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0-7 7m7-7H3"/></svg></a></div></nav></div></div><footer class="bg-gray-50 py-12 border-t border-gray-200"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><div class="flex flex-col md:flex-row justify-between space-y-4 md:space-y-0"><div class=flex-1><div class="flex items-center space-x-3 mb-4"><a href=https://sk-quant.github.io/ class=inline-block><img src=/images/logo.svg alt=烧烤量化 class=h-6>
</a><span class="text-xl font-bold text-gray-900">烧烤量化</span></div><div class="flex space-x-3 p-2"><a href=https://linkedin.com/in/yourusername class="text-gray-600 hover:text-gray-900" target=_blank rel="noopener noreferrer"><span class=sr-only>LinkedIn</span>
<img src=/images/social/linkedin.svg alt=LinkedIn class="h-5 w-5">
</a><a href=https://bsky.app/profile/yourblueskyhandle class="text-gray-600 hover:text-gray-900" target=_blank rel="noopener noreferrer"><span class=sr-only>Bluesky</span>
<img src=/images/social/bluesky.svg alt=Bluesky class="h-5 w-5">
</a><a href=https://twitter.com/yourusername class="text-gray-600 hover:text-gray-900" target=_blank rel="noopener noreferrer"><span class=sr-only>Twitter (X)</span>
<img src=/images/social/twitter.svg alt=Twitter class="h-5 w-5">
</a><a href=https://github.com/yourusername class="text-gray-600 hover:text-gray-900" target=_blank rel="noopener noreferrer"><span class=sr-only>GitHub</span>
<img src=/images/social/github.svg alt=GitHub class="h-5 w-5"></a></div></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div></div><div class="mt-12 pt-8 border-t border-gray-200"><div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0"><p class="text-gray-600 text-sm">© 2025 烧烤量化. All rights reserved.</p><a href=https://chaoming.li class="text-sm text-gray-600 hover:text-primary-600" target=_blank rel="noopener noreferrer">Powered by sk-quant</a></div></div></div></footer><script>const mobileMenuButton=document.getElementById("mobile-menu-button");mobileMenuButton&&mobileMenuButton.addEventListener("click",function(){const e=document.getElementById("mobile-menu");e&&e.classList.toggle("hidden")})</script></body></html>