<!doctype html><html lang=zh-cn class=h-full><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-XXXXXXX")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XXXXXXXXXX")</script><title>技术指标第5讲：KDJ随机指标 | 烧烤量化</title>
<meta name=description content="全面解析KDJ随机指标的超买超卖机制，从RSV未成熟随机值到K、D、J三线计算，构建基于随机震荡的精准买卖时机捕捉体系"><meta name=author content="Ryan"><meta name=robots content="index, follow"><meta property="og:title" content="技术指标第5讲：KDJ随机指标 | 烧烤量化"><meta property="og:description" content="全面解析KDJ随机指标的超买超卖机制，从RSV未成熟随机值到K、D、J三线计算，构建基于随机震荡的精准买卖时机捕捉体系"><meta property="og:type" content="article"><meta property="og:url" content="https://sk-quant.github.io/blog/%E6%8A%80%E6%9C%AF%E6%8C%87%E6%A0%87/05-kdj%E9%9A%8F%E6%9C%BA%E6%8C%87%E6%A0%87/"><meta property="og:site_name" content="烧烤量化"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="技术指标第5讲：KDJ随机指标 | 烧烤量化"><meta name=twitter:description content="全面解析KDJ随机指标的超买超卖机制，从RSV未成熟随机值到K、D、J三线计算，构建基于随机震荡的精准买卖时机捕捉体系"><link rel=icon type=image/x-icon href=/images/favicon.ico><link rel=canonical href=https://sk-quant.github.io/blog/%E6%8A%80%E6%9C%AF%E6%8C%87%E6%A0%87/05-kdj%E9%9A%8F%E6%9C%BA%E6%8C%87%E6%A0%87/><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel=stylesheet><link rel=stylesheet href="/css/main.min.0ec21c03b9f63a8c5e37663a4d2dc1608de61fd749fcfef42ffda7dc5bf34cc4.css"></head><body class="min-h-screen flex flex-col"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-XXXXXXX" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class="fixed top-0 left-0 right-0 z-50"><div class=mobile-menu-wrapper><input type=checkbox id=nav-toggle class=nav-toggle><header class="fixed w-full top-0 z-50 bg-white/80 backdrop-blur-sm border-b border-gray-100"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><nav class="flex items-center justify-between h-20"><a href=https://sk-quant.github.io/ class="flex items-center space-x-4"><img src=/images/logo.svg alt=烧烤量化 class=h-12>
<span class="text-3xl font-semibold text-gray-800">烧烤量化</span></a><div class="hidden md:flex items-center space-x-8"><a href=/path class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">学习路线</a><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化基础<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">回测平台</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化进阶<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">综合实战</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化高手<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股指期货</a></div></div></div><a href=/pricing class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">服务套餐</a></div><div class="hidden md:flex items-center space-x-4"><a href=/contact class="inline-flex items-center justify-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div><div class=md:hidden><label for=nav-toggle class="p-2 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-offset-2 transition-colors cursor-pointer"><svg class="w-6 h-6" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></label></div></nav></div><div class="nav-content md:hidden w-full fixed left-0 right-0 top-20 bg-white border-t border-gray-100 shadow-lg"><div class="w-full px-6 py-4"><a href=/path class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">学习路线</a><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化基础</div><div class=pl-4><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block text-gray-700 hover:text-primary-600 py-2">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block text-gray-700 hover:text-primary-600 py-2">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block text-gray-700 hover:text-primary-600 py-2">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block text-gray-700 hover:text-primary-600 py-2">回测平台</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化进阶</div><div class=pl-4><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block text-gray-700 hover:text-primary-600 py-2">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block text-gray-700 hover:text-primary-600 py-2">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block text-gray-700 hover:text-primary-600 py-2">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block text-gray-700 hover:text-primary-600 py-2">综合实战</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化高手</div><div class=pl-4><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block text-gray-700 hover:text-primary-600 py-2">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block text-gray-700 hover:text-primary-600 py-2">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block text-gray-700 hover:text-primary-600 py-2">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block text-gray-700 hover:text-primary-600 py-2">股指期货</a></div></div><a href=/pricing class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">服务套餐</a><div class="pt-4 space-y-4"><a href=/contact class="block text-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div></div></div></header><style>.mobile-menu-wrapper{position:relative}.nav-toggle{display:none}.nav-content{display:none}.nav-toggle:checked~header .nav-content{display:block}</style></div></div><div class=pt-20><div class="container mx-auto px-4 py-12"><div class="flex flex-col lg:flex-row gap-8 mb-12"><article class=flex-1><header class=mb-8><div class=mb-4><a href=/categories/%E6%8A%80%E6%9C%AF%E6%8C%87%E6%A0%87 class="inline-block px-3 py-1 text-sm font-medium text-primary-600 bg-primary-50 rounded-full hover:bg-primary-100 mr-2">技术指标</a></div><h1 class="text-4xl font-bold mb-4">技术指标第5讲：KDJ随机指标</h1><div class="flex flex-col space-y-4"><div class="flex items-center justify-between text-sm text-gray-500"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7A4 4 0 118 7a4 4 0 018 0zm-4 7a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
<span>Ryan</span></div><div class="flex items-center space-x-6"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747.0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746.0-3.332.477-4.5 1.253"/></svg>
<span>14 分钟</span></div><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5A2 2 0 003 7v12a2 2 0 002 2z"/></svg>
<time datetime=2025-09-15>September 15, 2025</time></div></div></div><div class="flex items-center flex-wrap gap-2"><a href=/tags/2025 class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors duration-200">#2025</a></div></div></header><div class=mb-8><img src=/images/blog/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87.jpg alt=技术指标第5讲：KDJ随机指标 class="w-full h-auto rounded-lg" loading=lazy></div><div class="prose prose-lg max-w-none"><div class="bg-gray-50 p-6 rounded-lg mb-8"><h2 class="text-xl font-semibold mb-4">目录</h2><nav id=TableOfContents><ul><li><a href=#kdj随机指标价格动量的震荡标尺>KDJ随机指标：价格动量的震荡标尺</a></li><li><a href=#kdj计算原理从rsv到三线共振>KDJ计算原理：从RSV到三线共振</a><ul><li><a href=#rsv未成熟随机值计算>RSV未成熟随机值计算</a></li><li><a href=#k值与d值的平滑计算>K值与D值的平滑计算</a></li><li><a href=#j值的计算与意义>J值的计算与意义</a></li><li><a href=#kdj指标的多周期优化>KDJ指标的多周期优化</a></li></ul></li><li><a href=#kdj信号识别从金叉死叉到背离分析>KDJ信号识别：从金叉死叉到背离分析</a><ul><li><a href=#kdj交叉信号系统>KDJ交叉信号系统</a></li><li><a href=#kdj超买超卖区域分析>KDJ超买超卖区域分析</a></li><li><a href=#kdj背离分析技术>KDJ背离分析技术</a></li><li><a href=#kdj形态分析>KDJ形态分析</a></li></ul></li><li><a href=#基于talib的kdj指标python实现>基于talib的KDJ指标Python实现</a><ul><li><a href=#环境配置与数据准备>环境配置与数据准备</a></li><li><a href=#kdj指标计算与基础分析>KDJ指标计算与基础分析</a></li><li><a href=#kdj背离识别与分析>KDJ背离识别与分析</a></li><li><a href=#kdj交易策略回测>KDJ交易策略回测</a></li></ul></li></ul></nav></div><h2 id=kdj随机指标价格动量的震荡标尺>KDJ随机指标：价格动量的震荡标尺</h2><p>KDJ随机指标（Stochastic Oscillator）由乔治·莱恩（George Lane）于1950年代提出，是技术分析中最经典的震荡指标之一。该指标通过比较特定周期内收盘价与价格波动范围的关系，量化价格动量的相对位置，为投资者提供超买超卖信号和趋势转折预警。</p><p>KDJ指标的核心思想基于这样一个市场现象：在上升趋势中，价格倾向于收盘于价格区间的高位；在下降趋势中，价格倾向于收盘于价格区间的低位。通过计算当前收盘价在给定周期内价格区间中的相对位置，KDJ指标能够有效识别价格的超买超卖状态，为交易决策提供重要参考。</p><p>KDJ指标的独特价值在于其"敏感性"和"前瞻性"特征。与RSI等相对强弱指标相比，KDJ指标对价格变化更加敏感，能够更快地捕捉市场转折点。同时，KDJ指标的三线结构（K线、D线、J线）提供了多层次的信号确认机制，有效降低了虚假信号的概率。</p><h2 id=kdj计算原理从rsv到三线共振>KDJ计算原理：从RSV到三线共振</h2><h3 id=rsv未成熟随机值计算>RSV未成熟随机值计算</h3><p>KDJ指标的计算始于RSV（Raw Stochastic Value）未成熟随机值的计算。RSV反映了当前收盘价在给定周期内价格区间中的相对位置：</p><p><strong>RSV计算公式</strong>：
RSV = (当前收盘价 - N日内最低价) / (N日内最高价 - N日内最低价) × 100</p><p>其中，N通常取9日，代表分析的时间周期。RSV值的范围在0-100之间，数值越高表明当前价格越接近周期内的高点，数值越低表明当前价格越接近周期的低点。</p><h3 id=k值与d值的平滑计算>K值与D值的平滑计算</h3><p><strong>K值计算</strong>：K值是对RSV的平滑处理，通常采用指数移动平均（EMA）计算：
当日K值 = 2/3 × 前日K值 + 1/3 × 当日RSV</p><p><strong>D值计算</strong>：D值是对K值的进一步平滑处理：
当日D值 = 2/3 × 前日D值 + 1/3 × 当日K值</p><p>K值和D值的初始值通常设为50，这种设置使得指标在初始阶段处于中性位置。</p><h3 id=j值的计算与意义>J值的计算与意义</h3><p><strong>J值计算</strong>：J值是K值与D值的差值放大，计算公式为：
J值 = 3 × K值 - 2 × D值</p><p>J值的引入增加了KDJ指标的敏感性。当J值大于100或小于0时，表明市场处于极端状态，往往预示着趋势即将发生反转。</p><h3 id=kdj指标的多周期优化>KDJ指标的多周期优化</h3><p><strong>超短期KDJ（5日）</strong>：适用于日内交易和超短线操作，对价格变化极其敏感，但信号噪音较大。</p><p><strong>短期KDJ（9日）</strong>：标准参数设置，平衡了敏感性和稳定性，适用于大多数交易场景。</p><p><strong>中期KDJ（14日）</strong>：降低了短期波动的干扰，更适合波段操作和趋势跟踪。</p><p><strong>长期KDJ（21日）</strong>：过滤了大部分短期噪音，主要用于长期趋势分析和投资时机选择。</p><h2 id=kdj信号识别从金叉死叉到背离分析>KDJ信号识别：从金叉死叉到背离分析</h2><h3 id=kdj交叉信号系统>KDJ交叉信号系统</h3><p><strong>黄金交叉</strong>：当K线从下向上突破D线时，形成黄金交叉，通常被视为买入信号。特别是在K值和D值都处于较低水平（如20以下）时，黄金交叉的可靠性更高。</p><p><strong>死亡交叉</strong>：当K线从上向下跌破D线时，形成死亡交叉，通常被视为卖出信号。在K值和D值都处于较高水平（如80以上）时，死亡交叉的预测效果更强。</p><p><strong>J线极端信号</strong>：当J值超过100时，表明市场可能处于超买状态，需要警惕回调风险；当J值低于0时，表明市场可能处于超卖状态，关注反弹机会。</p><h3 id=kdj超买超卖区域分析>KDJ超买超卖区域分析</h3><p><strong>超买区域</strong>：K值和D值同时大于80，表明市场可能过度买入，面临回调压力。但需要注意的是，在强势市场中，KDJ指标可能长期维持在超买区域。</p><p><strong>超卖区域</strong>：K值和D值同时小于20，表明市场可能过度卖出，存在反弹机会。同样，在弱势市场中，KDJ指标可能长期维持在超卖区域。</p><p><strong>中性区域</strong>：K值和D值在20-80之间波动，表明市场处于正常状态，没有明显的超买超卖现象。</p><h3 id=kdj背离分析技术>KDJ背离分析技术</h3><p><strong>顶背离</strong>：价格创新高，但KDJ指标未能同步创新高，暗示上涨动量减弱，可能面临趋势反转。</p><p><strong>底背离</strong>：价格创新低，但KDJ指标未能同步创新低，暗示下跌动量减弱，可能迎来趋势反转。</p><p><strong>多重背离</strong>：多次背离信号的出现通常比单次背离更可靠，为趋势反转提供更强的预警信号。</p><h3 id=kdj形态分析>KDJ形态分析</h3><p><strong>KDJ趋势线</strong>：在KDJ图表上绘制趋势线，当KDJ突破趋势线时，往往预示着价格将出现同向突破。</p><p><strong>KDJ支撑阻力位</strong>：KDJ在某些特定水平（如50、80、20）可能形成支撑或阻力，这些水平的突破具有重要的技术分析意义。</p><p><strong>KDJ价格形态</strong>：KDJ图表上可能出现头肩顶、双底等经典价格形态，这些形态的形成和突破提供交易信号。</p><h2 id=基于talib的kdj指标python实现>基于talib的KDJ指标Python实现</h2><h3 id=环境配置与数据准备>环境配置与数据准备</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>talib</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>yfinance</span> <span class=k>as</span> <span class=nn>yf</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取股票数据</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_stock_data</span><span class=p>(</span><span class=n>symbol</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=s2>&#34;1y&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;获取股票历史数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock</span> <span class=o>=</span> <span class=n>yf</span><span class=o>.</span><span class=n>download</span><span class=p>(</span><span class=n>symbol</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=n>period</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>stock</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取沪深300指数数据</span>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=n>get_stock_data</span><span class=p>(</span><span class=s2>&#34;000300.SS&#34;</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=s2>&#34;1y&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>high_prices</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;High&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl><span class=n>low_prices</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Low&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl><span class=n>close_prices</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;数据获取完成，共</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span><span class=si>}</span><span class=s2>个交易日&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;价格区间: </span><span class=si>{</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>min</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> - </span><span class=si>{</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>max</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建日期索引</span>
</span></span><span class=line><span class=cl><span class=n>dates</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>index</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;数据时间范围: </span><span class=si>{</span><span class=n>dates</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1>&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2> 至 </span><span class=si>{</span><span class=n>dates</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1>&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 基础统计分析</span>
</span></span><span class=line><span class=cl><span class=n>price_range</span> <span class=o>=</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;High&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Low&#39;</span><span class=p>])</span> <span class=o>/</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;Close&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>价格波动统计:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;平均日波动幅度: </span><span class=si>{</span><span class=n>price_range</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最大日波动幅度: </span><span class=si>{</span><span class=n>price_range</span><span class=o>.</span><span class=n>max</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最小日波动幅度: </span><span class=si>{</span><span class=n>price_range</span><span class=o>.</span><span class=n>min</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=kdj指标计算与基础分析>KDJ指标计算与基础分析</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用talib计算KDJ指标（随机指标）</span>
</span></span><span class=line><span class=cl><span class=c1># talib中的STOCH函数计算K值和D值</span>
</span></span><span class=line><span class=cl><span class=n>slowk</span><span class=p>,</span> <span class=n>slowd</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>STOCH</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>high_prices</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>low_prices</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>close_prices</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>fastk_period</span><span class=o>=</span><span class=mi>9</span><span class=p>,</span>   <span class=c1># RSV计算周期</span>
</span></span><span class=line><span class=cl>    <span class=n>slowk_period</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>   <span class=c1># K值平滑周期</span>
</span></span><span class=line><span class=cl>    <span class=n>slowk_matype</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>   <span class=c1># 简单移动平均</span>
</span></span><span class=line><span class=cl>    <span class=n>slowd_period</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>   <span class=c1># D值平滑周期</span>
</span></span><span class=line><span class=cl>    <span class=n>slowd_matype</span><span class=o>=</span><span class=mi>0</span>    <span class=c1># 简单移动平均</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 计算J值</span>
</span></span><span class=line><span class=cl><span class=n>j_values</span> <span class=o>=</span> <span class=mi>3</span> <span class=o>*</span> <span class=n>slowk</span> <span class=o>-</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>slowd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 计算不同周期的KDJ进行对比</span>
</span></span><span class=line><span class=cl><span class=n>fastk</span><span class=p>,</span> <span class=n>fastd</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>STOCHF</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>high_prices</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>low_prices</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>close_prices</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>fastk_period</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span>   <span class=c1># 快速KDJ</span>
</span></span><span class=line><span class=cl>    <span class=n>fastd_period</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>fastd_matype</span><span class=o>=</span><span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建KDJ分析DataFrame</span>
</span></span><span class=line><span class=cl><span class=n>kdj_df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Close&#39;</span><span class=p>:</span> <span class=n>close_prices</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;K&#39;</span><span class=p>:</span> <span class=n>slowk</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;D&#39;</span><span class=p>:</span> <span class=n>slowd</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;J&#39;</span><span class=p>:</span> <span class=n>j_values</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;FastK&#39;</span><span class=p>:</span> <span class=n>fastk</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;FastD&#39;</span><span class=p>:</span> <span class=n>fastd</span>
</span></span><span class=line><span class=cl><span class=p>},</span> <span class=n>index</span><span class=o>=</span><span class=n>dates</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 显示最近10个交易日的KDJ值</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;最近10个交易日KDJ指标值:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>kdj_df</span><span class=o>.</span><span class=n>tail</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span><span class=o>.</span><span class=n>round</span><span class=p>(</span><span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># KDJ信号识别函数</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>identify_kdj_signals</span><span class=p>(</span><span class=n>k_values</span><span class=p>,</span> <span class=n>d_values</span><span class=p>,</span> <span class=n>j_values</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;识别KDJ交易信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>signals</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 交叉信号</span>
</span></span><span class=line><span class=cl>    <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;golden_cross&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>k_values</span> <span class=o>&gt;</span> <span class=n>d_values</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>k_values</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>d_values</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;death_cross&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>k_values</span> <span class=o>&lt;</span> <span class=n>d_values</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>k_values</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>d_values</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 超买超卖信号</span>
</span></span><span class=line><span class=cl>    <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;overbought&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>k_values</span> <span class=o>&gt;</span> <span class=mi>80</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>d_values</span> <span class=o>&gt;</span> <span class=mi>80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;oversold&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>k_values</span> <span class=o>&lt;</span> <span class=mi>20</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>d_values</span> <span class=o>&lt;</span> <span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 进入超买超卖区域</span>
</span></span><span class=line><span class=cl>    <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;enter_overbought&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>k_values</span> <span class=o>&gt;</span> <span class=mi>80</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>k_values</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;enter_oversold&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>k_values</span> <span class=o>&lt;</span> <span class=mi>20</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>k_values</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 离开超买超卖区域</span>
</span></span><span class=line><span class=cl>    <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;exit_overbought&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>k_values</span> <span class=o>&lt;=</span> <span class=mi>80</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>k_values</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;exit_oversold&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>k_values</span> <span class=o>&gt;=</span> <span class=mi>20</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>k_values</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># J值极端信号</span>
</span></span><span class=line><span class=cl>    <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;j_extreme_high&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>j_values</span> <span class=o>&gt;</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>    <span class=n>signals</span><span class=p>[</span><span class=s1>&#39;j_extreme_low&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>j_values</span> <span class=o>&lt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>signals</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 分析KDJ信号</span>
</span></span><span class=line><span class=cl><span class=n>kdj_signals</span> <span class=o>=</span> <span class=n>identify_kdj_signals</span><span class=p>(</span><span class=n>slowk</span><span class=p>,</span> <span class=n>slowd</span><span class=p>,</span> <span class=n>j_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== KDJ信号统计 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;黄金交叉次数: </span><span class=si>{</span><span class=n>kdj_signals</span><span class=p>[</span><span class=s1>&#39;golden_cross&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;死亡交叉次数: </span><span class=si>{</span><span class=n>kdj_signals</span><span class=p>[</span><span class=s1>&#39;death_cross&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;超买信号次数: </span><span class=si>{</span><span class=n>kdj_signals</span><span class=p>[</span><span class=s1>&#39;overbought&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;超卖信号次数: </span><span class=si>{</span><span class=n>kdj_signals</span><span class=p>[</span><span class=s1>&#39;oversold&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;进入超买区域次数: </span><span class=si>{</span><span class=n>kdj_signals</span><span class=p>[</span><span class=s1>&#39;enter_overbought&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;进入超卖区域次数: </span><span class=si>{</span><span class=n>kdj_signals</span><span class=p>[</span><span class=s1>&#39;enter_oversold&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;J值极端高位次数: </span><span class=si>{</span><span class=n>kdj_signals</span><span class=p>[</span><span class=s1>&#39;j_extreme_high&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;J值极端低位次数: </span><span class=si>{</span><span class=n>kdj_signals</span><span class=p>[</span><span class=s1>&#39;j_extreme_low&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 当前KDJ状态分析</span>
</span></span><span class=line><span class=cl><span class=n>current_k</span> <span class=o>=</span> <span class=n>slowk</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>current_d</span> <span class=o>=</span> <span class=n>slowd</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>current_j</span> <span class=o>=</span> <span class=n>j_values</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 当前KDJ状态 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;K值: </span><span class=si>{</span><span class=n>current_k</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;D值: </span><span class=si>{</span><span class=n>current_d</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;J值: </span><span class=si>{</span><span class=n>current_j</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 当前状态判断</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>current_k</span> <span class=o>&gt;</span> <span class=mi>80</span> <span class=ow>and</span> <span class=n>current_d</span> <span class=o>&gt;</span> <span class=mi>80</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>kdj_status</span> <span class=o>=</span> <span class=s2>&#34;超买区域 - 警惕回调风险&#34;</span>
</span></span><span class=line><span class=cl><span class=k>elif</span> <span class=n>current_k</span> <span class=o>&lt;</span> <span class=mi>20</span> <span class=ow>and</span> <span class=n>current_d</span> <span class=o>&lt;</span> <span class=mi>20</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>kdj_status</span> <span class=o>=</span> <span class=s2>&#34;超卖区域 - 关注反弹机会&#34;</span>
</span></span><span class=line><span class=cl><span class=k>elif</span> <span class=n>current_k</span> <span class=o>&gt;</span> <span class=n>current_d</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>kdj_status</span> <span class=o>=</span> <span class=s2>&#34;K&gt;D - 短期偏多&#34;</span>
</span></span><span class=line><span class=cl><span class=k>elif</span> <span class=n>current_k</span> <span class=o>&lt;</span> <span class=n>current_d</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>kdj_status</span> <span class=o>=</span> <span class=s2>&#34;K&lt;D - 短期偏空&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>kdj_status</span> <span class=o>=</span> <span class=s2>&#34;K=D - 中性平衡&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;当前状态: </span><span class=si>{</span><span class=n>kdj_status</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># J值极端分析</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>current_j</span> <span class=o>&gt;</span> <span class=mi>100</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>j_status</span> <span class=o>=</span> <span class=s2>&#34;J值极端高位 - 强烈超买信号&#34;</span>
</span></span><span class=line><span class=cl><span class=k>elif</span> <span class=n>current_j</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>j_status</span> <span class=o>=</span> <span class=s2>&#34;J值极端低位 - 强烈超卖信号&#34;</span>
</span></span><span class=line><span class=cl><span class=k>elif</span> <span class=n>current_j</span> <span class=o>&gt;</span> <span class=mi>80</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>j_status</span> <span class=o>=</span> <span class=s2>&#34;J值偏高 - 注意回调风险&#34;</span>
</span></span><span class=line><span class=cl><span class=k>elif</span> <span class=n>current_j</span> <span class=o>&lt;</span> <span class=mi>20</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>j_status</span> <span class=o>=</span> <span class=s2>&#34;J值偏低 - 关注反弹机会&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>j_status</span> <span class=o>=</span> <span class=s2>&#34;J值正常 - 无极端信号&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;J值状态: </span><span class=si>{</span><span class=n>j_status</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># KDJ区间分析函数</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>analyze_kdj_zones</span><span class=p>(</span><span class=n>k_values</span><span class=p>,</span> <span class=n>d_values</span><span class=p>,</span> <span class=n>zones</span><span class=o>=</span><span class=p>[</span><span class=mi>20</span><span class=p>,</span> <span class=mi>50</span><span class=p>,</span> <span class=mi>80</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;分析KDJ在不同区间的分布&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>zones_analysis</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>zone</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>([</span><span class=s1>&#39;超卖&#39;</span><span class=p>,</span> <span class=s1>&#39;中性偏弱&#39;</span><span class=p>,</span> <span class=s1>&#39;中性偏强&#39;</span><span class=p>,</span> <span class=s1>&#39;超买&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>i</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>mask</span> <span class=o>=</span> <span class=p>(</span><span class=n>k_values</span> <span class=o>&lt;</span> <span class=n>zones</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>d_values</span> <span class=o>&lt;</span> <span class=n>zones</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>i</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>zones</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>mask</span> <span class=o>=</span> <span class=p>(</span><span class=n>k_values</span> <span class=o>&gt;</span> <span class=n>zones</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>d_values</span> <span class=o>&gt;</span> <span class=n>zones</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>mask</span> <span class=o>=</span> <span class=p>((</span><span class=n>k_values</span> <span class=o>&gt;</span> <span class=n>zones</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>k_values</span> <span class=o>&lt;=</span> <span class=n>zones</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>&amp;</span> 
</span></span><span class=line><span class=cl>                   <span class=p>(</span><span class=n>d_values</span> <span class=o>&gt;</span> <span class=n>zones</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>d_values</span> <span class=o>&lt;=</span> <span class=n>zones</span><span class=p>[</span><span class=n>i</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>zones_analysis</span><span class=p>[</span><span class=n>zone</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;count&#39;</span><span class=p>:</span> <span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;percentage&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>k_values</span><span class=p>))</span> <span class=o>*</span> <span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;avg_k&#39;</span><span class=p>:</span> <span class=n>k_values</span><span class=p>[</span><span class=n>mask</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=k>if</span> <span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;avg_d&#39;</span><span class=p>:</span> <span class=n>d_values</span><span class=p>[</span><span class=n>mask</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=k>if</span> <span class=n>mask</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>zones_analysis</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 分析KDJ区间分布</span>
</span></span><span class=line><span class=cl><span class=n>zone_analysis</span> <span class=o>=</span> <span class=n>analyze_kdj_zones</span><span class=p>(</span><span class=n>slowk</span><span class=o>.</span><span class=n>dropna</span><span class=p>(),</span> <span class=n>slowd</span><span class=o>.</span><span class=n>dropna</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== KDJ区间分布分析 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>zone</span><span class=p>,</span> <span class=n>stats</span> <span class=ow>in</span> <span class=n>zone_analysis</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>zone</span><span class=si>}</span><span class=s2>区域: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;count&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>天 (</span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;percentage&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%), &#34;</span>
</span></span><span class=line><span class=cl>          <span class=sa>f</span><span class=s2>&#34;平均K: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;avg_k&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, 平均D: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;avg_d&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># KDJ动量分析函数</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>analyze_kdj_momentum</span><span class=p>(</span><span class=n>k_values</span><span class=p>,</span> <span class=n>d_values</span><span class=p>,</span> <span class=n>j_values</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;分析KDJ动量变化&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># K值变化率</span>
</span></span><span class=line><span class=cl>    <span class=n>k_change</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>gradient</span><span class=p>(</span><span class=n>k_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># K值变化加速度</span>
</span></span><span class=line><span class=cl>    <span class=n>k_acceleration</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>gradient</span><span class=p>(</span><span class=n>k_change</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># K与D的差值</span>
</span></span><span class=line><span class=cl>    <span class=n>kd_spread</span> <span class=o>=</span> <span class=n>k_values</span> <span class=o>-</span> <span class=n>d_values</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># J值波动性</span>
</span></span><span class=line><span class=cl>    <span class=n>j_volatility</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>j_values</span><span class=p>)</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>k_change</span><span class=p>,</span> <span class=n>k_acceleration</span><span class=p>,</span> <span class=n>kd_spread</span><span class=p>,</span> <span class=n>j_volatility</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 分析KDJ动量</span>
</span></span><span class=line><span class=cl><span class=n>k_change</span><span class=p>,</span> <span class=n>k_acceleration</span><span class=p>,</span> <span class=n>kd_spread</span><span class=p>,</span> <span class=n>j_vol</span> <span class=o>=</span> <span class=n>analyze_kdj_momentum</span><span class=p>(</span><span class=n>slowk</span><span class=p>,</span> <span class=n>slowd</span><span class=p>,</span> <span class=n>j_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 当前KDJ动量状态</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 当前KDJ动量状态 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;K值变化率: </span><span class=si>{</span><span class=n>k_change</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=s1>&#39;上升&#39;</span> <span class=k>if</span> <span class=n>k_change</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=s1>&#39;下降&#39;</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;K值加速度: </span><span class=si>{</span><span class=n>k_acceleration</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;K-D差值: </span><span class=si>{</span><span class=n>kd_spread</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=s1>&#39;K&gt;D&#39;</span> <span class=k>if</span> <span class=n>kd_spread</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=s1>&#39;K&lt;D&#39;</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;J值波动性: </span><span class=si>{</span><span class=n>j_vol</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># K-D差值分析</span>
</span></span><span class=line><span class=cl><span class=n>current_kd_spread</span> <span class=o>=</span> <span class=n>kd_spread</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>current_kd_spread</span> <span class=o>&gt;</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>kd_status</span> <span class=o>=</span> <span class=s2>&#34;K显著大于D - 强势信号&#34;</span>
</span></span><span class=line><span class=cl><span class=k>elif</span> <span class=n>current_kd_spread</span> <span class=o>&gt;</span> <span class=mi>5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>kd_status</span> <span class=o>=</span> <span class=s2>&#34;K大于D - 偏多信号&#34;</span>
</span></span><span class=line><span class=cl><span class=k>elif</span> <span class=n>current_kd_spread</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>kd_status</span> <span class=o>=</span> <span class=s2>&#34;K显著小于D - 弱势信号&#34;</span>
</span></span><span class=line><span class=cl><span class=k>elif</span> <span class=n>current_kd_spread</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mi>5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>kd_status</span> <span class=o>=</span> <span class=s2>&#34;K小于D - 偏空信号&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>kd_status</span> <span class=o>=</span> <span class=s2>&#34;K接近D - 平衡状态&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;K-D状态: </span><span class=si>{</span><span class=n>kd_status</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=kdj背离识别与分析>KDJ背离识别与分析</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># KDJ背离识别函数</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>identify_kdj_divergences</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=n>k_values</span><span class=p>,</span> <span class=n>d_values</span><span class=p>,</span> <span class=n>lookback_period</span><span class=o>=</span><span class=mi>15</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;识别KDJ背离信号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>divergences</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>lookback_period</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 检查顶背离（价格创新高，KDJ未创新高）</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>prices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>prices</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>lookback_period</span><span class=p>:</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>max</span><span class=p>()</span> <span class=ow>and</span> 
</span></span><span class=line><span class=cl>            <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>lookback_period</span><span class=p>:</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>max</span><span class=p>()</span> <span class=ow>and</span>
</span></span><span class=line><span class=cl>            <span class=n>d_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>d_values</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>lookback_period</span><span class=p>:</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>max</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>divergences</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;顶背离&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>prices</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;k&#39;</span><span class=p>:</span> <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;d&#39;</span><span class=p>:</span> <span class=n>d_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;description&#39;</span><span class=p>:</span> <span class=s1>&#39;价格上涨但KDJ走弱，可能反转下跌&#39;</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 检查底背离（价格创新低，KDJ未创新低）</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=p>(</span><span class=n>prices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>prices</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>lookback_period</span><span class=p>:</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>min</span><span class=p>()</span> <span class=ow>and</span> 
</span></span><span class=line><span class=cl>              <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>lookback_period</span><span class=p>:</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>min</span><span class=p>()</span> <span class=ow>and</span>
</span></span><span class=line><span class=cl>              <span class=n>d_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>d_values</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>lookback_period</span><span class=p>:</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>min</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>divergences</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;底背离&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>prices</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;k&#39;</span><span class=p>:</span> <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;d&#39;</span><span class=p>:</span> <span class=n>d_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;description&#39;</span><span class=p>:</span> <span class=s1>&#39;价格下跌但KDJ走强，可能反转上涨&#39;</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>divergences</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 识别KDJ背离信号</span>
</span></span><span class=line><span class=cl><span class=n>kdj_divergences</span> <span class=o>=</span> <span class=n>identify_kdj_divergences</span><span class=p>(</span><span class=n>close_prices</span><span class=p>,</span> <span class=n>slowk</span><span class=p>,</span> <span class=n>slowd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== KDJ背离信号分析 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;识别到的背离信号总数: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>kdj_divergences</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 显示最近5次背离</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>kdj_divergences</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;最近5次背离信号:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>div</span> <span class=ow>in</span> <span class=n>kdj_divergences</span><span class=p>[</span><span class=o>-</span><span class=mi>5</span><span class=p>:]:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>div</span><span class=p>[</span><span class=s1>&#39;date&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1>&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>div</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> - &#34;</span>
</span></span><span class=line><span class=cl>              <span class=sa>f</span><span class=s2>&#34;价格: </span><span class=si>{</span><span class=n>div</span><span class=p>[</span><span class=s1>&#39;price&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, K: </span><span class=si>{</span><span class=n>div</span><span class=p>[</span><span class=s1>&#39;k&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, D: </span><span class=si>{</span><span class=n>div</span><span class=p>[</span><span class=s1>&#39;d&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> - </span><span class=si>{</span><span class=n>div</span><span class=p>[</span><span class=s1>&#39;description&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;近期未识别到明显的背离信号&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># KDJ趋势分析函数</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>analyze_kdj_trend</span><span class=p>(</span><span class=n>k_values</span><span class=p>,</span> <span class=n>d_values</span><span class=p>,</span> <span class=n>window</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;分析KDJ趋势&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># K值趋势</span>
</span></span><span class=line><span class=cl>    <span class=n>k_trend</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>k_values</span><span class=p>)</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=mi>1</span> <span class=k>if</span> <span class=n>x</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>x</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=k>else</span> <span class=o>-</span><span class=mi>1</span> <span class=k>if</span> <span class=n>x</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>x</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># D值趋势</span>
</span></span><span class=line><span class=cl>    <span class=n>d_trend</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>d_values</span><span class=p>)</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=mi>1</span> <span class=k>if</span> <span class=n>x</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>x</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=k>else</span> <span class=o>-</span><span class=mi>1</span> <span class=k>if</span> <span class=n>x</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>x</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># K与D的相对趋势</span>
</span></span><span class=line><span class=cl>    <span class=n>relative_trend</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>k_trend</span> <span class=o>==</span> <span class=n>d_trend</span><span class=p>,</span> <span class=n>k_trend</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 趋势强度</span>
</span></span><span class=line><span class=cl>    <span class=n>trend_strength</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>k_trend</span> <span class=o>+</span> <span class=n>d_trend</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>k_trend</span><span class=p>,</span> <span class=n>d_trend</span><span class=p>,</span> <span class=n>relative_trend</span><span class=p>,</span> <span class=n>trend_strength</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 分析KDJ趋势</span>
</span></span><span class=line><span class=cl><span class=n>k_trend</span><span class=p>,</span> <span class=n>d_trend</span><span class=p>,</span> <span class=n>relative_trend</span><span class=p>,</span> <span class=n>trend_strength</span> <span class=o>=</span> <span class=n>analyze_kdj_trend</span><span class=p>(</span><span class=n>slowk</span><span class=p>,</span> <span class=n>slowd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 当前KDJ趋势状态</span>
</span></span><span class=line><span class=cl><span class=n>current_k_trend</span> <span class=o>=</span> <span class=n>k_trend</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>current_d_trend</span> <span class=o>=</span> <span class=n>d_trend</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>current_relative_trend</span> <span class=o>=</span> <span class=n>relative_trend</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>current_trend_strength</span> <span class=o>=</span> <span class=n>trend_strength</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 当前KDJ趋势状态 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>trend_map</span> <span class=o>=</span> <span class=p>{</span><span class=mi>1</span><span class=p>:</span> <span class=s2>&#34;上升&#34;</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span> <span class=s2>&#34;下降&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>:</span> <span class=s2>&#34;横盘&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;K值趋势: </span><span class=si>{</span><span class=n>trend_map</span><span class=p>[</span><span class=n>current_k_trend</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;D值趋势: </span><span class=si>{</span><span class=n>trend_map</span><span class=p>[</span><span class=n>current_d_trend</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;相对趋势: </span><span class=si>{</span><span class=n>trend_map</span><span class=p>[</span><span class=n>current_relative_trend</span><span class=p>]</span> <span class=k>if</span> <span class=n>current_relative_trend</span> <span class=o>!=</span> <span class=mi>0</span> <span class=k>else</span> <span class=s1>&#39;不一致&#39;</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;趋势强度: </span><span class=si>{</span><span class=n>current_trend_strength</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 趋势一致性分析</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>current_relative_trend</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>trend_consensus</span> <span class=o>=</span> <span class=s2>&#34;KDJ同步上升 - 趋势一致看涨&#34;</span>
</span></span><span class=line><span class=cl><span class=k>elif</span> <span class=n>current_relative_trend</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>trend_consensus</span> <span class=o>=</span> <span class=s2>&#34;KDJ同步下降 - 趋势一致看跌&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>trend_consensus</span> <span class=o>=</span> <span class=s2>&#34;KDJ趋势不一致 - 谨慎观望&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;趋势共识: </span><span class=si>{</span><span class=n>trend_consensus</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># KDJ与其他指标组合分析</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>kdj_ma_combination</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=n>k_values</span><span class=p>,</span> <span class=n>d_values</span><span class=p>,</span> <span class=n>ma_period</span><span class=o>=</span><span class=mi>20</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;KDJ与移动平均线组合策略&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>ma</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>SMA</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=n>timeperiod</span><span class=o>=</span><span class=n>ma_period</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 价格相对位置</span>
</span></span><span class=line><span class=cl>    <span class=n>price_vs_ma</span> <span class=o>=</span> <span class=n>prices</span> <span class=o>-</span> <span class=n>ma</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># KDJ位置</span>
</span></span><span class=line><span class=cl>    <span class=n>kdj_bullish</span> <span class=o>=</span> <span class=p>(</span><span class=n>k_values</span> <span class=o>&gt;</span> <span class=n>d_values</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>k_values</span> <span class=o>&gt;</span> <span class=mi>50</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>kdj_bearish</span> <span class=o>=</span> <span class=p>(</span><span class=n>k_values</span> <span class=o>&lt;</span> <span class=n>d_values</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>k_values</span> <span class=o>&lt;</span> <span class=mi>50</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 组合信号</span>
</span></span><span class=line><span class=cl>    <span class=n>bullish_combo</span> <span class=o>=</span> <span class=p>(</span><span class=n>price_vs_ma</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>kdj_bullish</span>
</span></span><span class=line><span class=cl>    <span class=n>bearish_combo</span> <span class=o>=</span> <span class=p>(</span><span class=n>price_vs_ma</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>kdj_bearish</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>bullish_combo</span><span class=p>,</span> <span class=n>bearish_combo</span><span class=p>,</span> <span class=n>ma</span><span class=p>,</span> <span class=n>price_vs_ma</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行组合分析</span>
</span></span><span class=line><span class=cl><span class=n>kdj_ma_bullish</span><span class=p>,</span> <span class=n>kdj_ma_bearish</span><span class=p>,</span> <span class=n>ma_line</span><span class=p>,</span> <span class=n>price_vs_ma</span> <span class=o>=</span> <span class=n>kdj_ma_combination</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>close_prices</span><span class=p>,</span> <span class=n>slowk</span><span class=p>,</span> <span class=n>slowd</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== KDJ+MA组合信号分析 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;看涨组合信号次数: </span><span class=si>{</span><span class=n>kdj_ma_bullish</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;看跌组合信号次数: </span><span class=si>{</span><span class=n>kdj_ma_bearish</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 当前组合状态</span>
</span></span><span class=line><span class=cl><span class=n>current_kdj_ma_bullish</span> <span class=o>=</span> <span class=n>kdj_ma_bullish</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>current_kdj_ma_bearish</span> <span class=o>=</span> <span class=n>kdj_ma_bearish</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>current_price_vs_ma</span> <span class=o>=</span> <span class=n>price_vs_ma</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>current_kdj_ma_bullish</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>combo_signal</span> <span class=o>=</span> <span class=s2>&#34;强烈看涨 - 价格&gt;MA且KDJ金叉强势&#34;</span>
</span></span><span class=line><span class=cl><span class=k>elif</span> <span class=n>current_kdj_ma_bearish</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>combo_signal</span> <span class=o>=</span> <span class=s2>&#34;强烈看跌 - 价格&lt;MA且KDJ死叉弱势&#34;</span>
</span></span><span class=line><span class=cl><span class=k>elif</span> <span class=n>current_price_vs_ma</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>combo_signal</span> <span class=o>=</span> <span class=s2>&#34;价格偏强 - 但KDJ信号不一致&#34;</span>
</span></span><span class=line><span class=cl><span class=k>elif</span> <span class=n>current_price_vs_ma</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>combo_signal</span> <span class=o>=</span> <span class=s2>&#34;价格偏弱 - 但KDJ信号不一致&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>combo_signal</span> <span class=o>=</span> <span class=s2>&#34;中性状态 - 等待明确信号&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;当前组合状态: </span><span class=si>{</span><span class=n>combo_signal</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=kdj交易策略回测>KDJ交易策略回测</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># KDJ交叉交易策略</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>kdj_crossover_strategy</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=n>k_values</span><span class=p>,</span> <span class=n>d_values</span><span class=p>,</span> <span class=n>j_values</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>oversold_threshold</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span> <span class=n>overbought_threshold</span><span class=o>=</span><span class=mi>80</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>holding_period</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>stop_loss_pct</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;KDJ交叉交易策略回测&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>trades</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>positions</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>current_position</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>entry_price</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>entry_date</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>current_price</span> <span class=o>=</span> <span class=n>prices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 黄金交叉买入信号</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>d_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=ow>and</span> 
</span></span><span class=line><span class=cl>            <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>d_values</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=ow>and</span>
</span></span><span class=line><span class=cl>            <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>oversold_threshold</span> <span class=ow>and</span>
</span></span><span class=line><span class=cl>            <span class=n>current_position</span> <span class=o>==</span> <span class=mi>0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>current_position</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>entry_price</span> <span class=o>=</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>            <span class=n>entry_date</span> <span class=o>=</span> <span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>positions</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=s1>&#39;买入&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>current_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;k&#39;</span><span class=p>:</span> <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;d&#39;</span><span class=p>:</span> <span class=n>d_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;j&#39;</span><span class=p>:</span> <span class=n>j_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;position&#39;</span><span class=p>:</span> <span class=n>current_position</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 死亡交叉卖出信号</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=p>(</span><span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>d_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=ow>and</span> 
</span></span><span class=line><span class=cl>              <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>d_values</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=ow>and</span>
</span></span><span class=line><span class=cl>              <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>overbought_threshold</span> <span class=ow>and</span>
</span></span><span class=line><span class=cl>              <span class=n>current_position</span> <span class=o>==</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>exit_price</span> <span class=o>=</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>            <span class=n>return_pct</span> <span class=o>=</span> <span class=p>(</span><span class=n>exit_price</span> <span class=o>-</span> <span class=n>entry_price</span><span class=p>)</span> <span class=o>/</span> <span class=n>entry_price</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>            <span class=n>holding_days</span> <span class=o>=</span> <span class=p>(</span><span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>entry_date</span><span class=p>)</span><span class=o>.</span><span class=n>days</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>trades</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;entry_date&#39;</span><span class=p>:</span> <span class=n>entry_date</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;exit_date&#39;</span><span class=p>:</span> <span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;entry_price&#39;</span><span class=p>:</span> <span class=n>entry_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;exit_price&#39;</span><span class=p>:</span> <span class=n>exit_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;return_pct&#39;</span><span class=p>:</span> <span class=n>return_pct</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;holding_days&#39;</span><span class=p>:</span> <span class=n>holding_days</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;strategy&#39;</span><span class=p>:</span> <span class=s1>&#39;KDJ交叉&#39;</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>current_position</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>positions</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=s1>&#39;卖出&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>current_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;k&#39;</span><span class=p>:</span> <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;d&#39;</span><span class=p>:</span> <span class=n>d_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;j&#39;</span><span class=p>:</span> <span class=n>j_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;position&#39;</span><span class=p>:</span> <span class=n>current_position</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 止损机制</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>current_position</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>stop_loss_price</span> <span class=o>=</span> <span class=n>entry_price</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>stop_loss_pct</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_price</span> <span class=o>&lt;=</span> <span class=n>stop_loss_price</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>exit_price</span> <span class=o>=</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>                <span class=n>return_pct</span> <span class=o>=</span> <span class=p>(</span><span class=n>exit_price</span> <span class=o>-</span> <span class=n>entry_price</span><span class=p>)</span> <span class=o>/</span> <span class=n>entry_price</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>                <span class=n>holding_days</span> <span class=o>=</span> <span class=p>(</span><span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>entry_date</span><span class=p>)</span><span class=o>.</span><span class=n>days</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>trades</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;entry_date&#39;</span><span class=p>:</span> <span class=n>entry_date</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;exit_date&#39;</span><span class=p>:</span> <span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;entry_price&#39;</span><span class=p>:</span> <span class=n>entry_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;exit_price&#39;</span><span class=p>:</span> <span class=n>exit_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;return_pct&#39;</span><span class=p>:</span> <span class=n>return_pct</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;holding_days&#39;</span><span class=p>:</span> <span class=n>holding_days</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;strategy&#39;</span><span class=p>:</span> <span class=s1>&#39;止损出场&#39;</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>current_position</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>positions</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=s1>&#39;止损&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>current_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;k&#39;</span><span class=p>:</span> <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;d&#39;</span><span class=p>:</span> <span class=n>d_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;j&#39;</span><span class=p>:</span> <span class=n>j_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;position&#39;</span><span class=p>:</span> <span class=n>current_position</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 时间止损</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>current_position</span> <span class=o>==</span> <span class=mi>1</span> <span class=ow>and</span> <span class=p>(</span><span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>entry_date</span><span class=p>)</span><span class=o>.</span><span class=n>days</span> <span class=o>&gt;=</span> <span class=n>holding_period</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>exit_price</span> <span class=o>=</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>            <span class=n>return_pct</span> <span class=o>=</span> <span class=p>(</span><span class=n>exit_price</span> <span class=o>-</span> <span class=n>entry_price</span><span class=p>)</span> <span class=o>/</span> <span class=n>entry_price</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>            <span class=n>holding_days</span> <span class=o>=</span> <span class=p>(</span><span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>entry_date</span><span class=p>)</span><span class=o>.</span><span class=n>days</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>trades</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;entry_date&#39;</span><span class=p>:</span> <span class=n>entry_date</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;exit_date&#39;</span><span class=p>:</span> <span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;entry_price&#39;</span><span class=p>:</span> <span class=n>entry_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;exit_price&#39;</span><span class=p>:</span> <span class=n>exit_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;return_pct&#39;</span><span class=p>:</span> <span class=n>return_pct</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;holding_days&#39;</span><span class=p>:</span> <span class=n>holding_days</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;strategy&#39;</span><span class=p>:</span> <span class=s1>&#39;时间出场&#39;</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>current_position</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>positions</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=s1>&#39;时间出场&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>current_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;k&#39;</span><span class=p>:</span> <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;d&#39;</span><span class=p>:</span> <span class=n>d_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;j&#39;</span><span class=p>:</span> <span class=n>j_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;position&#39;</span><span class=p>:</span> <span class=n>current_position</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>trades</span><span class=p>,</span> <span class=n>positions</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行KDJ交叉策略回测</span>
</span></span><span class=line><span class=cl><span class=n>kdj_trades</span><span class=p>,</span> <span class=n>kdj_positions</span> <span class=o>=</span> <span class=n>kdj_crossover_strategy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>close_prices</span><span class=p>,</span> <span class=n>slowk</span><span class=p>,</span> <span class=n>slowd</span><span class=p>,</span> <span class=n>j_values</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== KDJ交叉策略回测结果 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;总交易次数: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>kdj_trades</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>kdj_trades</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 计算策略表现指标</span>
</span></span><span class=line><span class=cl>    <span class=n>returns</span> <span class=o>=</span> <span class=p>[</span><span class=n>trade</span><span class=p>[</span><span class=s1>&#39;return_pct&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>trade</span> <span class=ow>in</span> <span class=n>kdj_trades</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>winning_trades</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>returns</span> <span class=k>if</span> <span class=n>r</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>losing_trades</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>returns</span> <span class=k>if</span> <span class=n>r</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>win_rate</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>winning_trades</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>    <span class=n>avg_return</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>max_return</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>min_return</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>avg_holding_days</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>([</span><span class=n>trade</span><span class=p>[</span><span class=s1>&#39;holding_days&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>trade</span> <span class=ow>in</span> <span class=n>kdj_trades</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;胜率: </span><span class=si>{</span><span class=n>win_rate</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;平均收益率: </span><span class=si>{</span><span class=n>avg_return</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最大单笔收益: </span><span class=si>{</span><span class=n>max_return</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最大单笔亏损: </span><span class=si>{</span><span class=n>min_return</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;平均持仓天数: </span><span class=si>{</span><span class=n>avg_holding_days</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>天&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 按策略类型分析</span>
</span></span><span class=line><span class=cl>    <span class=n>crossover_trades</span> <span class=o>=</span> <span class=p>[</span><span class=n>t</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>kdj_trades</span> <span class=k>if</span> <span class=n>t</span><span class=p>[</span><span class=s1>&#39;strategy&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;KDJ交叉&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>stop_loss_trades</span> <span class=o>=</span> <span class=p>[</span><span class=n>t</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>kdj_trades</span> <span class=k>if</span> <span class=n>t</span><span class=p>[</span><span class=s1>&#39;strategy&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;止损出场&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>time_exit_trades</span> <span class=o>=</span> <span class=p>[</span><span class=n>t</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>kdj_trades</span> <span class=k>if</span> <span class=n>t</span><span class=p>[</span><span class=s1>&#39;strategy&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;时间出场&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>按策略类型分析:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;交叉交易次数: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>crossover_trades</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>crossover_trades</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>crossover_returns</span> <span class=o>=</span> <span class=p>[</span><span class=n>t</span><span class=p>[</span><span class=s1>&#39;return_pct&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>crossover_trades</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;交叉交易平均收益: </span><span class=si>{</span><span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>crossover_returns</span><span class=p>)</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;止损交易次数: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>stop_loss_trades</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;时间止损次数: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>time_exit_trades</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 显示最近5次交易</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>最近5次交易:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>trade</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>kdj_trades</span><span class=p>[</span><span class=o>-</span><span class=mi>5</span><span class=p>:],</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>. </span><span class=si>{</span><span class=n>trade</span><span class=p>[</span><span class=s1>&#39;entry_date&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1>&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2> 买入 - &#34;</span>
</span></span><span class=line><span class=cl>              <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>trade</span><span class=p>[</span><span class=s1>&#39;exit_date&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1>&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2> 卖出 - &#34;</span>
</span></span><span class=line><span class=cl>              <span class=sa>f</span><span class=s2>&#34;收益: </span><span class=si>{</span><span class=n>trade</span><span class=p>[</span><span class=s1>&#39;return_pct&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>% - 持仓: </span><span class=si>{</span><span class=n>trade</span><span class=p>[</span><span class=s1>&#39;holding_days&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>天 - &#34;</span>
</span></span><span class=line><span class=cl>              <span class=sa>f</span><span class=s2>&#34;策略: </span><span class=si>{</span><span class=n>trade</span><span class=p>[</span><span class=s1>&#39;strategy&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;策略未产生任何交易信号&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># KDJ超买超卖反转策略</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>kdj_reversal_strategy</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=n>k_values</span><span class=p>,</span> <span class=n>d_values</span><span class=p>,</span> <span class=n>j_values</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                         <span class=n>extreme_threshold</span><span class=o>=</span><span class=mi>15</span><span class=p>,</span> <span class=n>holding_period</span><span class=o>=</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;KDJ超买超卖反转策略&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>trades</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>positions</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>current_position</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>entry_price</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>entry_date</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>current_price</span> <span class=o>=</span> <span class=n>prices</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 超卖反转买入信号</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>extreme_threshold</span> <span class=ow>and</span> 
</span></span><span class=line><span class=cl>            <span class=n>d_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>extreme_threshold</span> <span class=ow>and</span>
</span></span><span class=line><span class=cl>            <span class=n>j_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>and</span>
</span></span><span class=line><span class=cl>            <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=ow>and</span>  <span class=c1># K值开始回升</span>
</span></span><span class=line><span class=cl>            <span class=n>current_position</span> <span class=o>==</span> <span class=mi>0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>current_position</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>entry_price</span> <span class=o>=</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>            <span class=n>entry_date</span> <span class=o>=</span> <span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>positions</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=s1>&#39;买入&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>current_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;k&#39;</span><span class=p>:</span> <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;d&#39;</span><span class=p>:</span> <span class=n>d_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;j&#39;</span><span class=p>:</span> <span class=n>j_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;position&#39;</span><span class=p>:</span> <span class=n>current_position</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 超买反转卖出信号</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=p>(</span><span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=p>(</span><span class=mi>100</span> <span class=o>-</span> <span class=n>extreme_threshold</span><span class=p>)</span> <span class=ow>and</span> 
</span></span><span class=line><span class=cl>              <span class=n>d_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=p>(</span><span class=mi>100</span> <span class=o>-</span> <span class=n>extreme_threshold</span><span class=p>)</span> <span class=ow>and</span>
</span></span><span class=line><span class=cl>              <span class=n>j_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>100</span> <span class=ow>and</span>
</span></span><span class=line><span class=cl>              <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=ow>and</span>  <span class=c1># K值开始回落</span>
</span></span><span class=line><span class=cl>              <span class=n>current_position</span> <span class=o>==</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>exit_price</span> <span class=o>=</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>            <span class=n>return_pct</span> <span class=o>=</span> <span class=p>(</span><span class=n>exit_price</span> <span class=o>-</span> <span class=n>entry_price</span><span class=p>)</span> <span class=o>/</span> <span class=n>entry_price</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>            <span class=n>holding_days</span> <span class=o>=</span> <span class=p>(</span><span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>entry_date</span><span class=p>)</span><span class=o>.</span><span class=n>days</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>trades</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;entry_date&#39;</span><span class=p>:</span> <span class=n>entry_date</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;exit_date&#39;</span><span class=p>:</span> <span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;entry_price&#39;</span><span class=p>:</span> <span class=n>entry_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;exit_price&#39;</span><span class=p>:</span> <span class=n>exit_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;return_pct&#39;</span><span class=p>:</span> <span class=n>return_pct</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;holding_days&#39;</span><span class=p>:</span> <span class=n>holding_days</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;strategy&#39;</span><span class=p>:</span> <span class=s1>&#39;极端反转&#39;</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>current_position</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>positions</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=s1>&#39;卖出&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>current_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;k&#39;</span><span class=p>:</span> <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;d&#39;</span><span class=p>:</span> <span class=n>d_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;j&#39;</span><span class=p>:</span> <span class=n>j_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;position&#39;</span><span class=p>:</span> <span class=n>current_position</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 时间出场</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>current_position</span> <span class=o>==</span> <span class=mi>1</span> <span class=ow>and</span> <span class=p>(</span><span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>entry_date</span><span class=p>)</span><span class=o>.</span><span class=n>days</span> <span class=o>&gt;=</span> <span class=n>holding_period</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>exit_price</span> <span class=o>=</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>            <span class=n>return_pct</span> <span class=o>=</span> <span class=p>(</span><span class=n>exit_price</span> <span class=o>-</span> <span class=n>entry_price</span><span class=p>)</span> <span class=o>/</span> <span class=n>entry_price</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>            <span class=n>holding_days</span> <span class=o>=</span> <span class=p>(</span><span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>entry_date</span><span class=p>)</span><span class=o>.</span><span class=n>days</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>trades</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;entry_date&#39;</span><span class=p>:</span> <span class=n>entry_date</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;exit_date&#39;</span><span class=p>:</span> <span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;entry_price&#39;</span><span class=p>:</span> <span class=n>entry_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;exit_price&#39;</span><span class=p>:</span> <span class=n>exit_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;return_pct&#39;</span><span class=p>:</span> <span class=n>return_pct</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;holding_days&#39;</span><span class=p>:</span> <span class=n>holding_days</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;strategy&#39;</span><span class=p>:</span> <span class=s1>&#39;时间出场&#39;</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>current_position</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>positions</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>dates</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=s1>&#39;时间出场&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>current_price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;k&#39;</span><span class=p>:</span> <span class=n>k_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;d&#39;</span><span class=p>:</span> <span class=n>d_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;j&#39;</span><span class=p>:</span> <span class=n>j_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;position&#39;</span><span class=p>:</span> <span class=n>current_position</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>trades</span><span class=p>,</span> <span class=n>positions</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行KDJ反转策略回测</span>
</span></span><span class=line><span class=cl><span class=n>kdj_reversal_trades</span><span class=p>,</span> <span class=n>kdj_reversal_positions</span> <span class=o>=</span> <span class=n>kdj_reversal_strategy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>close_prices</span><span class=p>,</span> <span class=n>slowk</span><span class=p>,</span> <span class=n>slowd</span><span class=p>,</span> <span class=n>j_values</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== KDJ反转策略回测结果 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;总交易次数: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>kdj_reversal_trades</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>kdj_reversal_trades</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>reversal_returns</span> <span class=o>=</span> <span class=p>[</span><span class=n>trade</span><span class=p>[</span><span class=s1>&#39;return_pct&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>trade</span> <span class=ow>in</span> <span class=n>kdj_reversal_trades</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>reversal_win_rate</span> <span class=o>=</span> <span class=nb>len</span><span class=p>([</span><span class=n>r</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>reversal_returns</span> <span class=k>if</span> <span class=n>r</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>])</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>reversal_returns</span><span class=p>)</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>    <span class=n>reversal_avg_return</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>reversal_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;反转策略胜率: </span><span class=si>{</span><span class=n>reversal_win_rate</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;反转策略平均收益: </span><span class=si>{</span><span class=n>reversal_avg_return</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;策略对比: </span><span class=si>{</span><span class=s1>&#39;反转策略表现更好&#39;</span> <span class=k>if</span> <span class=n>reversal_avg_return</span> <span class=o>&gt;</span> <span class=n>avg_return</span> <span class=k>else</span> <span class=s1>&#39;交叉策略表现更好&#39;</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;反转策略未产生交易信号&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># KDJ参数优化分析</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>kdj_parameter_optimization</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=n>high_prices</span><span class=p>,</span> <span class=n>low_prices</span><span class=p>,</span> <span class=n>close_prices</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                              <span class=n>k_periods</span><span class=o>=</span><span class=p>[</span><span class=mi>5</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>14</span><span class=p>],</span> <span class=n>d_periods</span><span class=o>=</span><span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>7</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;KDJ参数优化分析&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>optimization_results</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>k_period</span> <span class=ow>in</span> <span class=n>k_periods</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>d_period</span> <span class=ow>in</span> <span class=n>d_periods</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 计算不同参数的KDJ</span>
</span></span><span class=line><span class=cl>            <span class=n>test_k</span><span class=p>,</span> <span class=n>test_d</span> <span class=o>=</span> <span class=n>talib</span><span class=o>.</span><span class=n>STOCH</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>high_prices</span><span class=p>,</span> <span class=n>low_prices</span><span class=p>,</span> <span class=n>close_prices</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>fastk_period</span><span class=o>=</span><span class=n>k_period</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>slowk_period</span><span class=o>=</span><span class=n>d_period</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>slowk_matype</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>slowd_period</span><span class=o>=</span><span class=n>d_period</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>slowd_matype</span><span class=o>=</span><span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 计算信号频率</span>
</span></span><span class=line><span class=cl>            <span class=n>golden_cross</span> <span class=o>=</span> <span class=p>(</span><span class=n>test_k</span> <span class=o>&gt;</span> <span class=n>test_d</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>test_k</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>test_d</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>death_cross</span> <span class=o>=</span> <span class=p>(</span><span class=n>test_k</span> <span class=o>&lt;</span> <span class=n>test_d</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>test_k</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>test_d</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>total_signals</span> <span class=o>=</span> <span class=n>golden_cross</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span> <span class=o>+</span> <span class=n>death_cross</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>optimization_results</span><span class=p>[</span><span class=sa>f</span><span class=s2>&#34;K</span><span class=si>{</span><span class=n>k_period</span><span class=si>}</span><span class=s2>_D</span><span class=si>{</span><span class=n>d_period</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;k_period&#39;</span><span class=p>:</span> <span class=n>k_period</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;d_period&#39;</span><span class=p>:</span> <span class=n>d_period</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;golden_cross&#39;</span><span class=p>:</span> <span class=n>golden_cross</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;death_cross&#39;</span><span class=p>:</span> <span class=n>death_cross</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;total_signals&#39;</span><span class=p>:</span> <span class=n>total_signals</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;signal_frequency&#39;</span><span class=p>:</span> <span class=n>total_signals</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>optimization_results</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行参数优化分析</span>
</span></span><span class=line><span class=cl><span class=n>param_results</span> <span class=o>=</span> <span class=n>kdj_parameter_optimization</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>close_prices</span><span class=p>,</span> <span class=n>high_prices</span><span class=p>,</span> <span class=n>low_prices</span><span class=p>,</span> <span class=n>close_prices</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== KDJ参数优化分析 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;不同参数组合的信号频率:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>param_combo</span><span class=p>,</span> <span class=n>results</span> <span class=ow>in</span> <span class=n>param_results</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>param_combo</span><span class=si>}</span><span class=s2>: 总信号</span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;total_signals&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>次, &#34;</span>
</span></span><span class=line><span class=cl>          <span class=sa>f</span><span class=s2>&#34;信号频率</span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;signal_frequency&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 推荐参数组合</span>
</span></span><span class=line><span class=cl><span class=n>optimal_param</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>param_results</span><span class=o>.</span><span class=n>values</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=nb>abs</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=s1>&#39;signal_frequency&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mi>5</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>推荐参数: K周期</span><span class=si>{</span><span class=n>optimal_param</span><span class=p>[</span><span class=s1>&#39;k_period&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>, D周期</span><span class=si>{</span><span class=n>optimal_param</span><span class=p>[</span><span class=s1>&#39;d_period&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;推荐参数信号频率: </span><span class=si>{</span><span class=n>optimal_param</span><span class=p>[</span><span class=s1>&#39;signal_frequency&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div></div></article><aside class="lg:w-80 xl:w-96"><div class=space-y-8></div></aside></div><nav class="border-t border-gray-200 mt-12 pt-8"><div class="flex justify-between items-center"><a href=/blog/%E6%8A%80%E6%9C%AF%E6%8C%87%E6%A0%87/04-bollinger-bands%E5%B8%83%E6%9E%97%E5%B8%A6/ class="group flex items-center"><svg class="w-5 h-5 mr-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0 7-7m-7 7h18"/></svg><div><div class="text-sm text-gray-600">上一篇</div><div class="font-medium group-hover:text-primary-600">技术指标第4讲：Bollinger Bands布林带</div></div></a><a href=/blog/%E6%8A%80%E6%9C%AF%E6%8C%87%E6%A0%87/06-obv%E8%83%BD%E9%87%8F%E6%BD%AE%E6%8C%87%E6%A0%87/ class="group flex items-center text-right"><div><div class="text-sm text-gray-600">Next Post</div><div class="font-medium group-hover:text-primary-600">技术指标第6讲：OBV能量潮指标</div></div><svg class="w-5 h-5 ml-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0-7 7m7-7H3"/></svg></a></div></nav></div></div><footer class="bg-gray-50 py-12 border-t border-gray-200"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><div class="flex flex-col md:flex-row justify-between space-y-4 md:space-y-0"><div class=flex-1><div class="flex items-center space-x-3 mb-4"><a href=https://sk-quant.github.io/ class=inline-block><img src=/images/logo.svg alt=烧烤量化 class=h-6>
</a><span class="text-xl font-bold text-gray-900">烧烤量化</span></div><div class="flex space-x-3 p-2"><a href=https://linkedin.com/in/yourusername class="text-gray-600 hover:text-gray-900" target=_blank rel="noopener noreferrer"><span class=sr-only>LinkedIn</span>
<img src=/images/social/linkedin.svg alt=LinkedIn class="h-5 w-5">
</a><a href=https://bsky.app/profile/yourblueskyhandle class="text-gray-600 hover:text-gray-900" target=_blank rel="noopener noreferrer"><span class=sr-only>Bluesky</span>
<img src=/images/social/bluesky.svg alt=Bluesky class="h-5 w-5">
</a><a href=https://twitter.com/yourusername class="text-gray-600 hover:text-gray-900" target=_blank rel="noopener noreferrer"><span class=sr-only>Twitter (X)</span>
<img src=/images/social/twitter.svg alt=Twitter class="h-5 w-5">
</a><a href=https://github.com/yourusername class="text-gray-600 hover:text-gray-900" target=_blank rel="noopener noreferrer"><span class=sr-only>GitHub</span>
<img src=/images/social/github.svg alt=GitHub class="h-5 w-5"></a></div></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div></div><div class="mt-12 pt-8 border-t border-gray-200"><div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0"><p class="text-gray-600 text-sm">© 2025 烧烤量化. All rights reserved.</p><a href=https://chaoming.li class="text-sm text-gray-600 hover:text-primary-600" target=_blank rel="noopener noreferrer">Powered by sk-quant</a></div></div></div></footer><script>const mobileMenuButton=document.getElementById("mobile-menu-button");mobileMenuButton&&mobileMenuButton.addEventListener("click",function(){const e=document.getElementById("mobile-menu");e&&e.classList.toggle("hidden")})</script></body></html>