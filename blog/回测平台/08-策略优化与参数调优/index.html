<!doctype html><html lang=zh-cn class=h-full><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-XXXXXXX")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XXXXXXXXXX")</script><title>SuperMind第8讲：策略优化与参数调优 | 烧烤量化</title>
<meta name=description content="学习策略参数优化、超参数调优和策略改进技巧"><meta name=author content="Ryan"><meta name=robots content="index, follow"><meta property="og:title" content="SuperMind第8讲：策略优化与参数调优 | 烧烤量化"><meta property="og:description" content="学习策略参数优化、超参数调优和策略改进技巧"><meta property="og:type" content="article"><meta property="og:url" content="https://sk-quant.github.io/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/08-%E7%AD%96%E7%95%A5%E4%BC%98%E5%8C%96%E4%B8%8E%E5%8F%82%E6%95%B0%E8%B0%83%E4%BC%98/"><meta property="og:site_name" content="烧烤量化"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="SuperMind第8讲：策略优化与参数调优 | 烧烤量化"><meta name=twitter:description content="学习策略参数优化、超参数调优和策略改进技巧"><link rel=icon type=image/x-icon href=/images/favicon.ico><link rel=canonical href=https://sk-quant.github.io/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/08-%E7%AD%96%E7%95%A5%E4%BC%98%E5%8C%96%E4%B8%8E%E5%8F%82%E6%95%B0%E8%B0%83%E4%BC%98/><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel=stylesheet><link rel=stylesheet href="/css/main.min.9a3c970d7feebe1317992d10ced98f226635b831a963ee601e5901734ff0da21.css"></head><body class="min-h-screen flex flex-col"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-XXXXXXX" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class="fixed top-0 left-0 right-0 z-50"><div class=mobile-menu-wrapper><input type=checkbox id=nav-toggle class=nav-toggle><header class="fixed w-full top-0 z-50 bg-white/80 backdrop-blur-sm border-b border-gray-100"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><nav class="flex items-center justify-between h-20"><a href=https://sk-quant.github.io/ class="flex items-center space-x-4"><img src=/images/logo.svg alt=烧烤量化 class=h-12>
<span class="text-3xl font-semibold text-gray-800">烧烤量化</span></a><div class="hidden md:flex items-center space-x-8"><a href=/path class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">学习路线</a><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化基础<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">回测平台</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化进阶<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">综合实战</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化高手<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股指期货</a></div></div></div><a href=/pricing class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">服务套餐</a></div><div class="hidden md:flex items-center space-x-4"><a href=/contact class="inline-flex items-center justify-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div><div class=md:hidden><label for=nav-toggle class="p-2 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-offset-2 transition-colors cursor-pointer"><svg class="w-6 h-6" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></label></div></nav></div><div class="nav-content md:hidden w-full fixed left-0 right-0 top-20 bg-white border-t border-gray-100 shadow-lg"><div class="w-full px-6 py-4"><a href=/path class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">学习路线</a><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化基础</div><div class=pl-4><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block text-gray-700 hover:text-primary-600 py-2">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block text-gray-700 hover:text-primary-600 py-2">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block text-gray-700 hover:text-primary-600 py-2">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block text-gray-700 hover:text-primary-600 py-2">回测平台</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化进阶</div><div class=pl-4><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block text-gray-700 hover:text-primary-600 py-2">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block text-gray-700 hover:text-primary-600 py-2">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block text-gray-700 hover:text-primary-600 py-2">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block text-gray-700 hover:text-primary-600 py-2">综合实战</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化高手</div><div class=pl-4><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block text-gray-700 hover:text-primary-600 py-2">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block text-gray-700 hover:text-primary-600 py-2">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block text-gray-700 hover:text-primary-600 py-2">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block text-gray-700 hover:text-primary-600 py-2">股指期货</a></div></div><a href=/pricing class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">服务套餐</a><div class="pt-4 space-y-4"><a href=/contact class="block text-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div></div></div></header><style>.mobile-menu-wrapper{position:relative}.nav-toggle{display:none}.nav-content{display:none}.nav-toggle:checked~header .nav-content{display:block}</style></div></div><div class=pt-20><div class="container mx-auto px-4 py-12"><div class="flex flex-col lg:flex-row gap-8 mb-12"><article class=flex-1><header class=mb-8><div class=mb-4><a href=/categories/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0 class="inline-block px-3 py-1 text-sm font-medium text-primary-600 bg-primary-50 rounded-full hover:bg-primary-100 mr-2">回测平台</a></div><h1 class="text-4xl font-bold mb-4">SuperMind第8讲：策略优化与参数调优</h1><div class="flex flex-col space-y-4"><div class="flex items-center justify-between text-sm text-gray-500"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7A4 4 0 118 7a4 4 0 018 0zm-4 7a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
<span>Ryan</span></div><div class="flex items-center space-x-6"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747.0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746.0-3.332.477-4.5 1.253"/></svg>
<span>18 分钟</span></div><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5A2 2 0 003 7v12a2 2 0 002 2z"/></svg>
<time datetime=2025-09-28>September 28, 2025</time></div></div></div><div class="flex items-center flex-wrap gap-2"><a href=/tags/2025 class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors duration-200">#2025
</a><a href=/tags/supermind class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors duration-200">#SuperMind</a></div></div></header><div class=mb-8><img src=/images/blog/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0.jpg alt=SuperMind第8讲：策略优化与参数调优 class="w-full h-auto rounded-lg" loading=lazy></div><div class="prose prose-lg max-w-none"><h2 id=学习目标>学习目标</h2><ul><li>掌握策略参数优化的基本原理和方法</li><li>学会网格搜索、随机搜索和贝叶斯优化等调参技巧</li><li>理解过拟合问题及其防范措施</li><li>掌握策略性能改进的实用技巧</li><li>学会多目标优化和帕累托前沿分析</li></ul><div class="bg-gray-50 p-6 rounded-lg mb-8"><h2 class="text-xl font-semibold mb-4">目录</h2><nav id=TableOfContents><ul><li><a href=#学习目标>学习目标</a></li><li><a href=#策略参数优化基础>策略参数优化基础</a><ul><li><a href=#参数优化概述>参数优化概述</a></li><li><a href=#网格搜索优化>网格搜索优化</a></li><li><a href=#随机搜索和贝叶斯优化>随机搜索和贝叶斯优化</a></li></ul></li><li><a href=#过拟合防范与验证>过拟合防范与验证</a><ul><li><a href=#过拟合检测>过拟合检测</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div><h2 id=策略参数优化基础>策略参数优化基础</h2><h3 id=参数优化概述>参数优化概述</h3><p>参数优化是策略开发的关键环节：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>parameter_optimization_overview</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    参数优化概述
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>optimization_concepts</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;优化目标&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;收益最大化&#39;</span><span class=p>:</span> <span class=s1>&#39;提高策略收益率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;风险最小化&#39;</span><span class=p>:</span> <span class=s1>&#39;降低策略波动率和回撤&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;风险调整后收益&#39;</span><span class=p>:</span> <span class=s1>&#39;优化夏普比率、索提诺比率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;多目标优化&#39;</span><span class=p>:</span> <span class=s1>&#39;同时优化多个目标函数&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;参数类型&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;技术指标参数&#39;</span><span class=p>:</span> <span class=s1>&#39;均线周期、标准差倍数等&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;交易参数&#39;</span><span class=p>:</span> <span class=s1>&#39;仓位大小、止损止盈比例&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;过滤参数&#39;</span><span class=p>:</span> <span class=s1>&#39;成交量阈值、波动率阈值&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;时间参数&#39;</span><span class=p>:</span> <span class=s1>&#39;持有期、调仓频率&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;优化方法&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;网格搜索&#39;</span><span class=p>:</span> <span class=s1>&#39;穷举搜索参数空间&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;随机搜索&#39;</span><span class=p>:</span> <span class=s1>&#39;随机采样参数组合&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;贝叶斯优化&#39;</span><span class=p>:</span> <span class=s1>&#39;基于先验和后验的智能搜索&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;遗传算法&#39;</span><span class=p>:</span> <span class=s1>&#39;基于进化的优化方法&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;评估指标&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;收益率&#39;</span><span class=p>:</span> <span class=s1>&#39;年化收益率、总收益率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;风险指标&#39;</span><span class=p>:</span> <span class=s1>&#39;波动率、最大回撤、VaR&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;风险调整收益&#39;</span><span class=p>:</span> <span class=s1>&#39;夏普比率、信息比率、卡尔马比率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;稳定性&#39;</span><span class=p>:</span> <span class=s1>&#39;胜率、盈亏比、连续性&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>optimization_concepts</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>define_optimization_problem</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    定义优化问题
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 参数空间定义</span>
</span></span><span class=line><span class=cl>    <span class=n>parameter_space</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;ma_short&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;int&#39;</span><span class=p>,</span> <span class=s1>&#39;min&#39;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span> <span class=s1>&#39;max&#39;</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span> <span class=s1>&#39;step&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;ma_long&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;int&#39;</span><span class=p>,</span> <span class=s1>&#39;min&#39;</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span> <span class=s1>&#39;max&#39;</span><span class=p>:</span> <span class=mi>60</span><span class=p>,</span> <span class=s1>&#39;step&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;rsi_period&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;int&#39;</span><span class=p>,</span> <span class=s1>&#39;min&#39;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span> <span class=s1>&#39;max&#39;</span><span class=p>:</span> <span class=mi>30</span><span class=p>,</span> <span class=s1>&#39;step&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;rsi_threshold&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;float&#39;</span><span class=p>,</span> <span class=s1>&#39;min&#39;</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span> <span class=s1>&#39;max&#39;</span><span class=p>:</span> <span class=mi>40</span><span class=p>,</span> <span class=s1>&#39;step&#39;</span><span class=p>:</span> <span class=mi>5</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;stop_loss&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;float&#39;</span><span class=p>,</span> <span class=s1>&#39;min&#39;</span><span class=p>:</span> <span class=mf>0.02</span><span class=p>,</span> <span class=s1>&#39;max&#39;</span><span class=p>:</span> <span class=mf>0.10</span><span class=p>,</span> <span class=s1>&#39;step&#39;</span><span class=p>:</span> <span class=mf>0.01</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;take_profit&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;float&#39;</span><span class=p>,</span> <span class=s1>&#39;min&#39;</span><span class=p>:</span> <span class=mf>0.05</span><span class=p>,</span> <span class=s1>&#39;max&#39;</span><span class=p>:</span> <span class=mf>0.20</span><span class=p>,</span> <span class=s1>&#39;step&#39;</span><span class=p>:</span> <span class=mf>0.01</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;position_size&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;float&#39;</span><span class=p>,</span> <span class=s1>&#39;min&#39;</span><span class=p>:</span> <span class=mf>0.1</span><span class=p>,</span> <span class=s1>&#39;max&#39;</span><span class=p>:</span> <span class=mf>0.5</span><span class=p>,</span> <span class=s1>&#39;step&#39;</span><span class=p>:</span> <span class=mf>0.05</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 目标函数定义</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>objective_function</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>strategy_func</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        目标函数
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 运行策略</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=n>strategy_func</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=o>**</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算绩效指标</span>
</span></span><span class=line><span class=cl>        <span class=n>returns</span> <span class=o>=</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 多目标优化</span>
</span></span><span class=line><span class=cl>        <span class=n>objectives</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;return&#39;</span><span class=p>:</span> <span class=n>returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>*</span> <span class=mi>252</span><span class=p>,</span>  <span class=c1># 年化收益率</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sharpe&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>*</span> <span class=mi>252</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)),</span>  <span class=c1># 夏普比率</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max_drawdown&#39;</span><span class=p>:</span> <span class=n>calculate_max_drawdown</span><span class=p>(</span><span class=n>returns</span><span class=p>),</span>  <span class=c1># 最大回撤</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;win_rate&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>returns</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>  <span class=c1># 胜率</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;volatility&#39;</span><span class=p>:</span> <span class=n>returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>  <span class=c1># 年化波动率</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 加权目标函数</span>
</span></span><span class=line><span class=cl>        <span class=n>weights</span> <span class=o>=</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;weights&#39;</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;return&#39;</span><span class=p>:</span> <span class=mf>0.4</span><span class=p>,</span> <span class=s1>&#39;sharpe&#39;</span><span class=p>:</span> <span class=mf>0.3</span><span class=p>,</span> <span class=s1>&#39;max_drawdown&#39;</span><span class=p>:</span> <span class=o>-</span><span class=mf>0.3</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>objective_value</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>weight</span> <span class=ow>in</span> <span class=n>weights</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>objectives</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>objective_value</span> <span class=o>+=</span> <span class=n>weight</span> <span class=o>*</span> <span class=n>objectives</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;objective_value&#39;</span><span class=p>:</span> <span class=n>objective_value</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;metrics&#39;</span><span class=p>:</span> <span class=n>objectives</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;params&#39;</span><span class=p>:</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 约束条件</span>
</span></span><span class=line><span class=cl>    <span class=n>constraints</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;ma_short &lt; ma_long&#39;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>params</span><span class=p>:</span> <span class=n>params</span><span class=p>[</span><span class=s1>&#39;ma_short&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>params</span><span class=p>[</span><span class=s1>&#39;ma_long&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;rsi_threshold &lt; 50&#39;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>params</span><span class=p>:</span> <span class=n>params</span><span class=p>[</span><span class=s1>&#39;rsi_threshold&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>50</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;stop_loss &lt; take_profit&#39;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>params</span><span class=p>:</span> <span class=n>params</span><span class=p>[</span><span class=s1>&#39;stop_loss&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>params</span><span class=p>[</span><span class=s1>&#39;take_profit&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;position_size &lt;= 1&#39;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>params</span><span class=p>:</span> <span class=n>params</span><span class=p>[</span><span class=s1>&#39;position_size&#39;</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=mf>1.0</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>parameter_space</span><span class=p>,</span> <span class=n>objective_function</span><span class=p>,</span> <span class=n>constraints</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_parameter_validation</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    参数验证函数
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>validate_parameters</span><span class=p>(</span><span class=n>params</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        验证参数有效性
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>errors</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 检查参数范围</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>param_name</span><span class=p>,</span> <span class=n>param_value</span> <span class=ow>in</span> <span class=n>params</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>param_name</span> <span class=o>==</span> <span class=s1>&#39;ma_short&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=mi>5</span> <span class=o>&lt;=</span> <span class=n>param_value</span> <span class=o>&lt;=</span> <span class=mi>20</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>errors</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>param_name</span><span class=si>}</span><span class=s2> 应该在5-20之间&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>param_name</span> <span class=o>==</span> <span class=s1>&#39;ma_long&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=mi>20</span> <span class=o>&lt;=</span> <span class=n>param_value</span> <span class=o>&lt;=</span> <span class=mi>60</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>errors</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>param_name</span><span class=si>}</span><span class=s2> 应该在20-60之间&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>param_name</span> <span class=o>==</span> <span class=s1>&#39;stop_loss&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=mf>0.01</span> <span class=o>&lt;=</span> <span class=n>param_value</span> <span class=o>&lt;=</span> <span class=mf>0.20</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>errors</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>param_name</span><span class=si>}</span><span class=s2> 应该在1%-20%之间&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 检查参数逻辑</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;ma_short&#39;</span> <span class=ow>in</span> <span class=n>params</span> <span class=ow>and</span> <span class=s1>&#39;ma_long&#39;</span> <span class=ow>in</span> <span class=n>params</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>params</span><span class=p>[</span><span class=s1>&#39;ma_short&#39;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>params</span><span class=p>[</span><span class=s1>&#39;ma_long&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>errors</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;短期均线周期应该小于长期均线周期&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;stop_loss&#39;</span> <span class=ow>in</span> <span class=n>params</span> <span class=ow>and</span> <span class=s1>&#39;take_profit&#39;</span> <span class=ow>in</span> <span class=n>params</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>params</span><span class=p>[</span><span class=s1>&#39;stop_loss&#39;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>params</span><span class=p>[</span><span class=s1>&#39;take_profit&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>errors</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;止损比例应该小于止盈比例&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=n>errors</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span> <span class=n>errors</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>validate_parameters</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=网格搜索优化>网格搜索优化</h3><p>网格搜索是最基础的优化方法：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>grid_search_optimization</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    网格搜索优化
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>GridSearchOptimizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>parameter_space</span><span class=p>,</span> <span class=n>objective_function</span><span class=p>,</span> <span class=n>constraints</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>parameter_space</span> <span class=o>=</span> <span class=n>parameter_space</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>objective_function</span> <span class=o>=</span> <span class=n>objective_function</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>constraints</span> <span class=o>=</span> <span class=n>constraints</span> <span class=ow>or</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>best_score</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;-inf&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>generate_parameter_grid</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            生成参数网格
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>param_names</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=n>param_values</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>param_name</span><span class=p>,</span> <span class=n>param_config</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameter_space</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=n>param_names</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>param_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;int&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>values</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;min&#39;</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                                 <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;max&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;step&#39;</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                                 <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;step&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;float&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>values</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;min&#39;</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                                     <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;max&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;step&#39;</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                                     <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;step&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>  <span class=c1># categorical</span>
</span></span><span class=line><span class=cl>                    <span class=n>values</span> <span class=o>=</span> <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;values&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>param_values</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>values</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 生成所有组合</span>
</span></span><span class=line><span class=cl>            <span class=kn>import</span> <span class=nn>itertools</span>
</span></span><span class=line><span class=cl>            <span class=n>parameter_combinations</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>itertools</span><span class=o>.</span><span class=n>product</span><span class=p>(</span><span class=o>*</span><span class=n>param_values</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 转换为字典格式</span>
</span></span><span class=line><span class=cl>            <span class=n>parameter_dicts</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>combination</span> <span class=ow>in</span> <span class=n>parameter_combinations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>param_dict</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>param_names</span><span class=p>,</span> <span class=n>combination</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>parameter_dicts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>param_dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>parameter_dicts</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>check_constraints</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>params</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            检查约束条件
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>constraint_name</span><span class=p>,</span> <span class=n>constraint_func</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>constraints</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=ow>not</span> <span class=n>constraint_func</span><span class=p>(</span><span class=n>params</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>optimize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>strategy_func</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            执行优化
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>parameter_combinations</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_parameter_grid</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>total_combinations</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>parameter_combinations</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;开始网格搜索优化，共</span><span class=si>{</span><span class=n>total_combinations</span><span class=si>}</span><span class=s2>个参数组合&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>params</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>parameter_combinations</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># 检查约束</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_constraints</span><span class=p>(</span><span class=n>params</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 评估参数</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>objective_function</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>strategy_func</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=c1># 更新最优解</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;objective_value&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>best_score</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=bp>self</span><span class=o>.</span><span class=n>best_score</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;objective_value&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                        <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>                        
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;参数组合 </span><span class=si>{</span><span class=n>params</span><span class=si>}</span><span class=s2> 评估失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 进度显示</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>%</span> <span class=mi>100</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;进度: </span><span class=si>{</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>total_combinations</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=p>(</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=n>total_combinations</span> <span class=o>*</span> <span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;网格搜索完成，最优参数: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>best_params</span><span class=si>}</span><span class=s2>, 目标值: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>best_score</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;best_params&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;best_score&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>best_score</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;all_results&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;total_evaluations&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>get_top_results</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>n</span><span class=o>=</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            获取前N个结果
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>sorted_results</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                                  <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=s1>&#39;objective_value&#39;</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                                  <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>sorted_results</span><span class=p>[:</span><span class=n>n</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>plot_optimization_results</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>param1</span><span class=p>,</span> <span class=n>param2</span><span class=p>,</span> <span class=n>objective_key</span><span class=o>=</span><span class=s1>&#39;objective_value&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            绘制优化结果热力图
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 提取数据</span>
</span></span><span class=line><span class=cl>            <span class=n>x_values</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=n>y_values</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=n>z_values</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>result</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>param1</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;params&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=n>param2</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;params&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=n>x_values</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;params&#39;</span><span class=p>][</span><span class=n>param1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                    <span class=n>y_values</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;params&#39;</span><span class=p>][</span><span class=n>param2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                    <span class=n>z_values</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=n>objective_key</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 创建网格</span>
</span></span><span class=line><span class=cl>            <span class=n>x_unique</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>x_values</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>            <span class=n>y_unique</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>y_values</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>X</span><span class=p>,</span> <span class=n>Y</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>meshgrid</span><span class=p>(</span><span class=n>x_unique</span><span class=p>,</span> <span class=n>y_unique</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>Z</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros_like</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 填充Z值</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>x_unique</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>j</span><span class=p>,</span> <span class=n>y</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>y_unique</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=p>(</span><span class=n>x_val</span><span class=p>,</span> <span class=n>y_val</span><span class=p>,</span> <span class=n>z_val</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>x_values</span><span class=p>,</span> <span class=n>y_values</span><span class=p>,</span> <span class=n>z_values</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=n>x_val</span> <span class=o>==</span> <span class=n>x</span> <span class=ow>and</span> <span class=n>y_val</span> <span class=o>==</span> <span class=n>y</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=n>Z</span><span class=p>[</span><span class=n>j</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>z_val</span>
</span></span><span class=line><span class=cl>                            <span class=k>break</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 绘制热力图</span>
</span></span><span class=line><span class=cl>            <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>8</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>plt</span><span class=o>.</span><span class=n>contourf</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>Y</span><span class=p>,</span> <span class=n>Z</span><span class=p>,</span> <span class=n>levels</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>plt</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>label</span><span class=o>=</span><span class=n>objective_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>plt</span><span class=o>.</span><span class=n>xlabel</span><span class=p>(</span><span class=n>param1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>plt</span><span class=o>.</span><span class=n>ylabel</span><span class=p>(</span><span class=n>param2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>param1</span><span class=si>}</span><span class=s1> vs </span><span class=si>{</span><span class=n>param2</span><span class=si>}</span><span class=s1> 优化结果&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 标记最优解</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span> <span class=ow>and</span> <span class=n>param1</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span> <span class=ow>and</span> <span class=n>param2</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>plt</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>best_params</span><span class=p>[</span><span class=n>param1</span><span class=p>],</span> <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span><span class=p>[</span><span class=n>param2</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                           <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;*&#39;</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;最优解&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>plt</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>GridSearchOptimizer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>advanced_grid_search_example</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    高级网格搜索示例
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 定义策略函数</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>moving_average_strategy</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>ma_short</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>ma_long</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>stop_loss</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        均线策略
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 计算均线</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;ma_short&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>ma_short</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;ma_long&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>ma_long</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 生成信号</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;signal&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;ma_short&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;ma_long&#39;</span><span class=p>],</span> <span class=s1>&#39;signal&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;ma_short&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;ma_long&#39;</span><span class=p>],</span> <span class=s1>&#39;signal&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算收益</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;signal&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 应用止损</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;cumulative_returns&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>])</span><span class=o>.</span><span class=n>cumprod</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;peak&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;cumulative_returns&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>expanding</span><span class=p>()</span><span class=o>.</span><span class=n>max</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s1>&#39;drawdown&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;cumulative_returns&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;peak&#39;</span><span class=p>])</span> <span class=o>/</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;peak&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 止损逻辑</span>
</span></span><span class=line><span class=cl>        <span class=n>stop_loss_trigger</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;drawdown&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=o>-</span><span class=n>stop_loss</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>stop_loss_trigger</span><span class=p>,</span> <span class=s1>&#39;returns&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 定义参数空间</span>
</span></span><span class=line><span class=cl>    <span class=n>parameter_space</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;ma_short&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;int&#39;</span><span class=p>,</span> <span class=s1>&#39;min&#39;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span> <span class=s1>&#39;max&#39;</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span> <span class=s1>&#39;step&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;ma_long&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;int&#39;</span><span class=p>,</span> <span class=s1>&#39;min&#39;</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span> <span class=s1>&#39;max&#39;</span><span class=p>:</span> <span class=mi>60</span><span class=p>,</span> <span class=s1>&#39;step&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;stop_loss&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;float&#39;</span><span class=p>,</span> <span class=s1>&#39;min&#39;</span><span class=p>:</span> <span class=mf>0.02</span><span class=p>,</span> <span class=s1>&#39;max&#39;</span><span class=p>:</span> <span class=mf>0.10</span><span class=p>,</span> <span class=s1>&#39;step&#39;</span><span class=p>:</span> <span class=mf>0.01</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 定义目标函数</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>objective_function</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>strategy_func</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        目标函数：最大化夏普比率
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 运行策略</span>
</span></span><span class=line><span class=cl>        <span class=n>result_data</span> <span class=o>=</span> <span class=n>strategy_func</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span> <span class=o>**</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>returns</span> <span class=o>=</span> <span class=n>result_data</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;objective_value&#39;</span><span class=p>:</span> <span class=o>-</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span><span class=p>,</span> <span class=s1>&#39;metrics&#39;</span><span class=p>:</span> <span class=p>{},</span> <span class=s1>&#39;params&#39;</span><span class=p>:</span> <span class=n>params</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算指标</span>
</span></span><span class=line><span class=cl>        <span class=n>annual_return</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>*</span> <span class=mi>252</span>
</span></span><span class=line><span class=cl>        <span class=n>annual_volatility</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sharpe_ratio</span> <span class=o>=</span> <span class=n>annual_return</span> <span class=o>/</span> <span class=n>annual_volatility</span> <span class=k>if</span> <span class=n>annual_volatility</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=n>max_drawdown</span> <span class=o>=</span> <span class=n>calculate_max_drawdown</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>win_rate</span> <span class=o>=</span> <span class=p>(</span><span class=n>returns</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 综合目标函数</span>
</span></span><span class=line><span class=cl>        <span class=n>objective_value</span> <span class=o>=</span> <span class=n>sharpe_ratio</span> <span class=o>*</span> <span class=mf>0.6</span> <span class=o>-</span> <span class=nb>abs</span><span class=p>(</span><span class=n>max_drawdown</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.4</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>metrics</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;annual_return&#39;</span><span class=p>:</span> <span class=n>annual_return</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;annual_volatility&#39;</span><span class=p>:</span> <span class=n>annual_volatility</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>:</span> <span class=n>sharpe_ratio</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max_drawdown&#39;</span><span class=p>:</span> <span class=n>max_drawdown</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;win_rate&#39;</span><span class=p>:</span> <span class=n>win_rate</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;objective_value&#39;</span><span class=p>:</span> <span class=n>objective_value</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;metrics&#39;</span><span class=p>:</span> <span class=n>metrics</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;params&#39;</span><span class=p>:</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 约束条件</span>
</span></span><span class=line><span class=cl>    <span class=n>constraints</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;ma_short &lt; ma_long&#39;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>params</span><span class=p>:</span> <span class=n>params</span><span class=p>[</span><span class=s1>&#39;ma_short&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>params</span><span class=p>[</span><span class=s1>&#39;ma_long&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>parameter_space</span><span class=p>,</span> <span class=n>objective_function</span><span class=p>,</span> <span class=n>constraints</span><span class=p>,</span> <span class=n>moving_average_strategy</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>parallel_grid_search</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    并行网格搜索
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>concurrent.futures</span> <span class=kn>import</span> <span class=n>ProcessPoolExecutor</span><span class=p>,</span> <span class=n>as_completed</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>multiprocessing</span> <span class=k>as</span> <span class=nn>mp</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>ParallelGridSearchOptimizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>parameter_space</span><span class=p>,</span> <span class=n>objective_function</span><span class=p>,</span> <span class=n>constraints</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>n_workers</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>parameter_space</span> <span class=o>=</span> <span class=n>parameter_space</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>objective_function</span> <span class=o>=</span> <span class=n>objective_function</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>constraints</span> <span class=o>=</span> <span class=n>constraints</span> <span class=ow>or</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>n_workers</span> <span class=o>=</span> <span class=n>n_workers</span> <span class=ow>or</span> <span class=n>mp</span><span class=o>.</span><span class=n>cpu_count</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>best_score</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;-inf&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>evaluate_parameter_set</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>params_strategy_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            评估参数组合（用于并行执行）
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>params</span><span class=p>,</span> <span class=n>strategy_func</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>kwargs</span> <span class=o>=</span> <span class=n>params_strategy_data</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 检查约束</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>constraint_func</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>constraints</span><span class=o>.</span><span class=n>values</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=ow>not</span> <span class=n>constraint_func</span><span class=p>(</span><span class=n>params</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>objective_function</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>strategy_func</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>optimize_parallel</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>strategy_func</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            并行优化
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=c1># 生成参数组合</span>
</span></span><span class=line><span class=cl>            <span class=n>parameter_combinations</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_parameter_grid</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 准备评估数据</span>
</span></span><span class=line><span class=cl>            <span class=n>evaluation_data</span> <span class=o>=</span> <span class=p>[(</span><span class=n>params</span><span class=p>,</span> <span class=n>strategy_func</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>kwargs</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>                             <span class=k>for</span> <span class=n>params</span> <span class=ow>in</span> <span class=n>parameter_combinations</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;开始并行网格搜索优化，使用</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>n_workers</span><span class=si>}</span><span class=s2>个进程&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 并行评估</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=n>ProcessPoolExecutor</span><span class=p>(</span><span class=n>max_workers</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>n_workers</span><span class=p>)</span> <span class=k>as</span> <span class=n>executor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>futures</span> <span class=o>=</span> <span class=p>[</span><span class=n>executor</span><span class=o>.</span><span class=n>submit</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>evaluate_parameter_set</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>                          <span class=k>for</span> <span class=n>data</span> <span class=ow>in</span> <span class=n>evaluation_data</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>completed</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>future</span> <span class=ow>in</span> <span class=n>as_completed</span><span class=p>(</span><span class=n>futures</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>result</span> <span class=o>=</span> <span class=n>future</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>result</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        
</span></span><span class=line><span class=cl>                        <span class=c1># 更新最优解</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;objective_value&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>best_score</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=bp>self</span><span class=o>.</span><span class=n>best_score</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;objective_value&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                            <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;params&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=n>completed</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>completed</span> <span class=o>%</span> <span class=mi>100</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;进度: </span><span class=si>{</span><span class=n>completed</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>evaluation_data</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;并行优化完成，最优参数: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>best_params</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;best_params&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;best_score&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>best_score</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;all_results&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;total_evaluations&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ParallelGridSearchOptimizer</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=随机搜索和贝叶斯优化>随机搜索和贝叶斯优化</h3><p>更高效的优化方法：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span><span class=lnt>353
</span><span class=lnt>354
</span><span class=lnt>355
</span><span class=lnt>356
</span><span class=lnt>357
</span><span class=lnt>358
</span><span class=lnt>359
</span><span class=lnt>360
</span><span class=lnt>361
</span><span class=lnt>362
</span><span class=lnt>363
</span><span class=lnt>364
</span><span class=lnt>365
</span><span class=lnt>366
</span><span class=lnt>367
</span><span class=lnt>368
</span><span class=lnt>369
</span><span class=lnt>370
</span><span class=lnt>371
</span><span class=lnt>372
</span><span class=lnt>373
</span><span class=lnt>374
</span><span class=lnt>375
</span><span class=lnt>376
</span><span class=lnt>377
</span><span class=lnt>378
</span><span class=lnt>379
</span><span class=lnt>380
</span><span class=lnt>381
</span><span class=lnt>382
</span><span class=lnt>383
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>random_search_optimization</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    随机搜索优化
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>RandomSearchOptimizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>parameter_space</span><span class=p>,</span> <span class=n>objective_function</span><span class=p>,</span> <span class=n>n_trials</span><span class=o>=</span><span class=mi>1000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>parameter_space</span> <span class=o>=</span> <span class=n>parameter_space</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>objective_function</span> <span class=o>=</span> <span class=n>objective_function</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>n_trials</span> <span class=o>=</span> <span class=n>n_trials</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>best_score</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;-inf&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>sample_random_parameters</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            随机采样参数
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>params</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>param_name</span><span class=p>,</span> <span class=n>param_config</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameter_space</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;int&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>params</span><span class=p>[</span><span class=n>param_name</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;min&#39;</span><span class=p>],</span> <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;max&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;float&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>params</span><span class=p>[</span><span class=n>param_name</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;min&#39;</span><span class=p>],</span> <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;max&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;categorical&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>params</span><span class=p>[</span><span class=n>param_name</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;values&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;log_uniform&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>log_min</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;min&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                    <span class=n>log_max</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;max&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                    <span class=n>params</span><span class=p>[</span><span class=n>param_name</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>exp</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=n>log_min</span><span class=p>,</span> <span class=n>log_max</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>optimize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>strategy_func</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            执行随机搜索优化
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;开始随机搜索优化，共</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>n_trials</span><span class=si>}</span><span class=s2>次试验&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>trial</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>n_trials</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># 采样参数</span>
</span></span><span class=line><span class=cl>                <span class=n>params</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>sample_random_parameters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 评估参数</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>objective_function</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>strategy_func</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=c1># 更新最优解</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;objective_value&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>best_score</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=bp>self</span><span class=o>.</span><span class=n>best_score</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;objective_value&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                        <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>                        
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;第</span><span class=si>{</span><span class=n>trial</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>次试验失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 进度显示</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>trial</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>%</span> <span class=mi>100</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;进度: </span><span class=si>{</span><span class=n>trial</span> <span class=o>+</span> <span class=mi>1</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>n_trials</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;当前最优: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>best_params</span><span class=si>}</span><span class=s2>, 得分: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>best_score</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;随机搜索完成，最优参数: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>best_params</span><span class=si>}</span><span class=s2>, 目标值: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>best_score</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;best_params&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;best_score&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>best_score</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;all_results&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;total_trials&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_trials</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>get_convergence_analysis</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            收敛性分析
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 按试验顺序排序</span>
</span></span><span class=line><span class=cl>            <span class=n>sorted_results</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                                  <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>x</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 计算累积最优值</span>
</span></span><span class=line><span class=cl>            <span class=n>cumulative_best</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=n>current_best</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;-inf&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>result</span> <span class=ow>in</span> <span class=n>sorted_results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;objective_value&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>current_best</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>current_best</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;objective_value&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>cumulative_best</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>current_best</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;cumulative_best&#39;</span><span class=p>:</span> <span class=n>cumulative_best</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;convergence_rate&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_convergence_rate</span><span class=p>(</span><span class=n>cumulative_best</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;exploration_efficiency&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=nb>set</span><span class=p>([</span><span class=nb>tuple</span><span class=p>(</span><span class=n>r</span><span class=p>[</span><span class=s1>&#39;params&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>items</span><span class=p>())</span> 
</span></span><span class=line><span class=cl>                                                   <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>]))</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>calculate_convergence_rate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>cumulative_best</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            计算收敛速度
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>cumulative_best</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 计算后50%的改进比例</span>
</span></span><span class=line><span class=cl>            <span class=n>mid_point</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>cumulative_best</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            <span class=n>first_half_improvement</span> <span class=o>=</span> <span class=n>cumulative_best</span><span class=p>[</span><span class=n>mid_point</span><span class=p>]</span> <span class=o>-</span> <span class=n>cumulative_best</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>second_half_improvement</span> <span class=o>=</span> <span class=n>cumulative_best</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>cumulative_best</span><span class=p>[</span><span class=n>mid_point</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>first_half_improvement</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>second_half_improvement</span> <span class=o>/</span> <span class=n>first_half_improvement</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>RandomSearchOptimizer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>bayesian_optimization</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    贝叶斯优化
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>skopt</span> <span class=kn>import</span> <span class=n>gp_minimize</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>skopt.space</span> <span class=kn>import</span> <span class=n>Real</span><span class=p>,</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>Categorical</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>skopt.utils</span> <span class=kn>import</span> <span class=n>use_named_args</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>ImportError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;请安装scikit-optimize: pip install scikit-optimize&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>BayesianOptimizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>parameter_space</span><span class=p>,</span> <span class=n>objective_function</span><span class=p>,</span> <span class=n>n_calls</span><span class=o>=</span><span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>parameter_space</span> <span class=o>=</span> <span class=n>parameter_space</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>objective_function</span> <span class=o>=</span> <span class=n>objective_function</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>n_calls</span> <span class=o>=</span> <span class=n>n_calls</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>results</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>best_score</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;-inf&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>convert_parameter_space</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            转换参数空间为skopt格式
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>dimensions</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>param_name</span><span class=p>,</span> <span class=n>param_config</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameter_space</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;int&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>dim</span> <span class=o>=</span> <span class=n>Integer</span><span class=p>(</span><span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;min&#39;</span><span class=p>],</span> <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;max&#39;</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=n>param_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;float&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>param_config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;prior&#39;</span><span class=p>)</span> <span class=o>==</span> <span class=s1>&#39;log-uniform&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>dim</span> <span class=o>=</span> <span class=n>Real</span><span class=p>(</span><span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;min&#39;</span><span class=p>],</span> <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;max&#39;</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                                 <span class=n>prior</span><span class=o>=</span><span class=s1>&#39;log-uniform&#39;</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=n>param_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>dim</span> <span class=o>=</span> <span class=n>Real</span><span class=p>(</span><span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;min&#39;</span><span class=p>],</span> <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;max&#39;</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=n>param_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;categorical&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>dim</span> <span class=o>=</span> <span class=n>Categorical</span><span class=p>(</span><span class=n>param_config</span><span class=p>[</span><span class=s1>&#39;values&#39;</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=n>param_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>dimensions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>dimensions</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=nd>@use_named_args</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>wrapped_objective</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>**</span><span class=n>params</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            包装目标函数
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>objective_function</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>strategy_func</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># skopt是最小化问题，需要转换</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=o>-</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;objective_value&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>optimize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>strategy_func</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            执行贝叶斯优化
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>strategy_func</span> <span class=o>=</span> <span class=n>strategy_func</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>data</span> <span class=o>=</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>dimensions</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>convert_parameter_space</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;开始贝叶斯优化，共</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>n_calls</span><span class=si>}</span><span class=s2>次评估&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 执行优化</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>results</span> <span class=o>=</span> <span class=n>gp_minimize</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>func</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>wrapped_objective</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>dimensions</span><span class=o>=</span><span class=n>dimensions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>n_calls</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>n_calls</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>n_initial_points</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>  <span class=c1># 初始随机点数量</span>
</span></span><span class=line><span class=cl>                <span class=n>acq_func</span><span class=o>=</span><span class=s1>&#39;EI&#39;</span><span class=p>,</span>  <span class=c1># 获取函数：Expected Improvement</span>
</span></span><span class=line><span class=cl>                <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 提取结果</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>best_score</span> <span class=o>=</span> <span class=o>-</span><span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=o>.</span><span class=n>fun</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 转换参数格式</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>dim</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>dimensions</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>param_name</span> <span class=o>=</span> <span class=n>dim</span><span class=o>.</span><span class=n>name</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span><span class=p>[</span><span class=n>param_name</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=o>.</span><span class=n>x</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;贝叶斯优化完成，最优参数: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>best_params</span><span class=si>}</span><span class=s2>, 目标值: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>best_score</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;best_params&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;best_score&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>best_score</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;optimization_results&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;convergence_plot&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>plot_convergence</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>plot_convergence</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            绘制收敛图
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>plt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=o>.</span><span class=n>func_vals</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>plt</span><span class=o>.</span><span class=n>xlabel</span><span class=p>(</span><span class=s1>&#39;评估次数&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>plt</span><span class=o>.</span><span class=n>ylabel</span><span class=p>(</span><span class=s1>&#39;目标函数值&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s1>&#39;贝叶斯优化收敛过程&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>plt</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>get_optimization_history</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            获取优化历史
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>history</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>func_val</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=o>.</span><span class=n>x_iters</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=o>.</span><span class=n>func_vals</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                <span class=n>param_dict</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>j</span><span class=p>,</span> <span class=n>dim</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>convert_parameter_space</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>                    <span class=n>param_dict</span><span class=p>[</span><span class=n>dim</span><span class=o>.</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=n>params</span><span class=p>[</span><span class=n>j</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>history</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;iteration&#39;</span><span class=p>:</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;params&#39;</span><span class=p>:</span> <span class=n>param_dict</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;objective_value&#39;</span><span class=p>:</span> <span class=o>-</span><span class=n>func_val</span><span class=p>,</span>  <span class=c1># 转换回最大化问题</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;improvement&#39;</span><span class=p>:</span> <span class=o>-</span><span class=n>func_val</span> <span class=o>-</span> <span class=p>(</span><span class=o>-</span><span class=nb>min</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=o>.</span><span class=n>func_vals</span><span class=p>[:</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>]))</span> <span class=k>if</span> <span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>history</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>BayesianOptimizer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>advanced_bayesian_optimization</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    高级贝叶斯优化
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>skopt</span> <span class=kn>import</span> <span class=n>gp_minimize</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>skopt.space</span> <span class=kn>import</span> <span class=n>Real</span><span class=p>,</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>Categorical</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>skopt.utils</span> <span class=kn>import</span> <span class=n>use_named_args</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>skopt.learning</span> <span class=kn>import</span> <span class=n>GaussianProcessRegressor</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>skopt.learning.gaussian_process.kernels</span> <span class=kn>import</span> <span class=n>Matern</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>ImportError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;请安装scikit-optimize: pip install scikit-optimize&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>AdvancedBayesianOptimizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>parameter_space</span><span class=p>,</span> <span class=n>objective_function</span><span class=p>,</span> <span class=n>n_calls</span><span class=o>=</span><span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>parameter_space</span> <span class=o>=</span> <span class=n>parameter_space</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>objective_function</span> <span class=o>=</span> <span class=n>objective_function</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>n_calls</span> <span class=o>=</span> <span class=n>n_calls</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>results</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>best_score</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;-inf&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>surrogate_model</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>create_advanced_surrogate_model</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            创建高级代理模型
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=c1># 使用Matern核函数</span>
</span></span><span class=line><span class=cl>            <span class=n>kernel</span> <span class=o>=</span> <span class=n>Matern</span><span class=p>(</span><span class=n>length_scale</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span> <span class=n>nu</span><span class=o>=</span><span class=mf>2.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 配置高斯过程回归器</span>
</span></span><span class=line><span class=cl>            <span class=n>gpr</span> <span class=o>=</span> <span class=n>GaussianProcessRegressor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>kernel</span><span class=o>=</span><span class=n>kernel</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>alpha</span><span class=o>=</span><span class=mf>1e-6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>normalize_y</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>n_restarts_optimizer</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>gpr</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>optimize_with_custom_acquisition</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>strategy_func</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>acquisition_func</span><span class=o>=</span><span class=s1>&#39;EI&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            使用自定义获取函数优化
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>strategy_func</span> <span class=o>=</span> <span class=n>strategy_func</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>data</span> <span class=o>=</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>dimensions</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>convert_parameter_space</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 创建高级代理模型</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>surrogate_model</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_advanced_surrogate_model</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;开始高级贝叶斯优化，使用</span><span class=si>{</span><span class=n>acquisition_func</span><span class=si>}</span><span class=s2>获取函数&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 执行优化</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>results</span> <span class=o>=</span> <span class=n>gp_minimize</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>func</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>wrapped_objective</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>dimensions</span><span class=o>=</span><span class=n>dimensions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>n_calls</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>n_calls</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>n_initial_points</span><span class=o>=</span><span class=mi>15</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>base_estimator</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>surrogate_model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>acq_func</span><span class=o>=</span><span class=n>acquisition_func</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>acq_optimizer</span><span class=o>=</span><span class=s1>&#39;lbfgs&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 提取结果</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>best_score</span> <span class=o>=</span> <span class=o>-</span><span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=o>.</span><span class=n>fun</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>convert_x_to_params</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=o>.</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;best_params&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;best_score&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>best_score</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;optimization_results&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;surrogate_model&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>surrogate_model</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>get_parameter_importance</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            获取参数重要性
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>surrogate_model</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 计算参数重要性（基于代理模型的特征重要性）</span>
</span></span><span class=line><span class=cl>            <span class=n>dimensions</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>convert_parameter_space</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>importance</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 使用代理模型预测参数敏感性</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>dim</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>dimensions</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>param_name</span> <span class=o>=</span> <span class=n>dim</span><span class=o>.</span><span class=n>name</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 计算参数扰动对目标函数的影响</span>
</span></span><span class=line><span class=cl>                <span class=n>base_params</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>best_params</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 正向扰动</span>
</span></span><span class=line><span class=cl>                <span class=n>perturbed_params</span> <span class=o>=</span> <span class=n>base_params</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>dim</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>dim</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>perturbation</span> <span class=o>=</span> <span class=p>(</span><span class=n>dim</span><span class=o>.</span><span class=n>high</span> <span class=o>-</span> <span class=n>dim</span><span class=o>.</span><span class=n>low</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.1</span>
</span></span><span class=line><span class=cl>                    <span class=n>perturbed_params</span><span class=p>[</span><span class=n>param_name</span><span class=p>]</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>dim</span><span class=o>.</span><span class=n>high</span><span class=p>,</span> <span class=n>base_params</span><span class=p>[</span><span class=n>param_name</span><span class=p>]</span> <span class=o>+</span> <span class=n>perturbation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 评估影响</span>
</span></span><span class=line><span class=cl>                <span class=n>base_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>objective_function</span><span class=p>(</span><span class=n>base_params</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>strategy_func</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>perturbed_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>objective_function</span><span class=p>(</span><span class=n>perturbed_params</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>strategy_func</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>importance</span><span class=p>[</span><span class=n>param_name</span><span class=p>]</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>perturbed_result</span><span class=p>[</span><span class=s1>&#39;objective_value&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>base_result</span><span class=p>[</span><span class=s1>&#39;objective_value&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 归一化重要性</span>
</span></span><span class=line><span class=cl>            <span class=n>total_importance</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>importance</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=n>normalized_importance</span> <span class=o>=</span> <span class=p>{</span><span class=n>k</span><span class=p>:</span> <span class=n>v</span> <span class=o>/</span> <span class=n>total_importance</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>importance</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>normalized_importance</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>suggest_next_parameters</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>n_suggestions</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            建议下一组参数
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>sample_random_parameters</span><span class=p>()</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_suggestions</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 使用代理模型建议参数</span>
</span></span><span class=line><span class=cl>            <span class=n>suggestions</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_suggestions</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># 这里可以实现更复杂的参数建议逻辑</span>
</span></span><span class=line><span class=cl>                <span class=c1># 目前返回随机采样</span>
</span></span><span class=line><span class=cl>                <span class=n>suggestions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sample_random_parameters</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>suggestions</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>AdvancedBayesianOptimizer</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=过拟合防范与验证>过拟合防范与验证</h2><h3 id=过拟合检测>过拟合检测</h3><p>识别和防范过拟合：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span><span class=lnt>353
</span><span class=lnt>354
</span><span class=lnt>355
</span><span class=lnt>356
</span><span class=lnt>357
</span><span class=lnt>358
</span><span class=lnt>359
</span><span class=lnt>360
</span><span class=lnt>361
</span><span class=lnt>362
</span><span class=lnt>363
</span><span class=lnt>364
</span><span class=lnt>365
</span><span class=lnt>366
</span><span class=lnt>367
</span><span class=lnt>368
</span><span class=lnt>369
</span><span class=lnt>370
</span><span class=lnt>371
</span><span class=lnt>372
</span><span class=lnt>373
</span><span class=lnt>374
</span><span class=lnt>375
</span><span class=lnt>376
</span><span class=lnt>377
</span><span class=lnt>378
</span><span class=lnt>379
</span><span class=lnt>380
</span><span class=lnt>381
</span><span class=lnt>382
</span><span class=lnt>383
</span><span class=lnt>384
</span><span class=lnt>385
</span><span class=lnt>386
</span><span class=lnt>387
</span><span class=lnt>388
</span><span class=lnt>389
</span><span class=lnt>390
</span><span class=lnt>391
</span><span class=lnt>392
</span><span class=lnt>393
</span><span class=lnt>394
</span><span class=lnt>395
</span><span class=lnt>396
</span><span class=lnt>397
</span><span class=lnt>398
</span><span class=lnt>399
</span><span class=lnt>400
</span><span class=lnt>401
</span><span class=lnt>402
</span><span class=lnt>403
</span><span class=lnt>404
</span><span class=lnt>405
</span><span class=lnt>406
</span><span class=lnt>407
</span><span class=lnt>408
</span><span class=lnt>409
</span><span class=lnt>410
</span><span class=lnt>411
</span><span class=lnt>412
</span><span class=lnt>413
</span><span class=lnt>414
</span><span class=lnt>415
</span><span class=lnt>416
</span><span class=lnt>417
</span><span class=lnt>418
</span><span class=lnt>419
</span><span class=lnt>420
</span><span class=lnt>421
</span><span class=lnt>422
</span><span class=lnt>423
</span><span class=lnt>424
</span><span class=lnt>425
</span><span class=lnt>426
</span><span class=lnt>427
</span><span class=lnt>428
</span><span class=lnt>429
</span><span class=lnt>430
</span><span class=lnt>431
</span><span class=lnt>432
</span><span class=lnt>433
</span><span class=lnt>434
</span><span class=lnt>435
</span><span class=lnt>436
</span><span class=lnt>437
</span><span class=lnt>438
</span><span class=lnt>439
</span><span class=lnt>440
</span><span class=lnt>441
</span><span class=lnt>442
</span><span class=lnt>443
</span><span class=lnt>444
</span><span class=lnt>445
</span><span class=lnt>446
</span><span class=lnt>447
</span><span class=lnt>448
</span><span class=lnt>449
</span><span class=lnt>450
</span><span class=lnt>451
</span><span class=lnt>452
</span><span class=lnt>453
</span><span class=lnt>454
</span><span class=lnt>455
</span><span class=lnt>456
</span><span class=lnt>457
</span><span class=lnt>458
</span><span class=lnt>459
</span><span class=lnt>460
</span><span class=lnt>461
</span><span class=lnt>462
</span><span class=lnt>463
</span><span class=lnt>464
</span><span class=lnt>465
</span><span class=lnt>466
</span><span class=lnt>467
</span><span class=lnt>468
</span><span class=lnt>469
</span><span class=lnt>470
</span><span class=lnt>471
</span><span class=lnt>472
</span><span class=lnt>473
</span><span class=lnt>474
</span><span class=lnt>475
</span><span class=lnt>476
</span><span class=lnt>477
</span><span class=lnt>478
</span><span class=lnt>479
</span><span class=lnt>480
</span><span class=lnt>481
</span><span class=lnt>482
</span><span class=lnt>483
</span><span class=lnt>484
</span><span class=lnt>485
</span><span class=lnt>486
</span><span class=lnt>487
</span><span class=lnt>488
</span><span class=lnt>489
</span><span class=lnt>490
</span><span class=lnt>491
</span><span class=lnt>492
</span><span class=lnt>493
</span><span class=lnt>494
</span><span class=lnt>495
</span><span class=lnt>496
</span><span class=lnt>497
</span><span class=lnt>498
</span><span class=lnt>499
</span><span class=lnt>500
</span><span class=lnt>501
</span><span class=lnt>502
</span><span class=lnt>503
</span><span class=lnt>504
</span><span class=lnt>505
</span><span class=lnt>506
</span><span class=lnt>507
</span><span class=lnt>508
</span><span class=lnt>509
</span><span class=lnt>510
</span><span class=lnt>511
</span><span class=lnt>512
</span><span class=lnt>513
</span><span class=lnt>514
</span><span class=lnt>515
</span><span class=lnt>516
</span><span class=lnt>517
</span><span class=lnt>518
</span><span class=lnt>519
</span><span class=lnt>520
</span><span class=lnt>521
</span><span class=lnt>522
</span><span class=lnt>523
</span><span class=lnt>524
</span><span class=lnt>525
</span><span class=lnt>526
</span><span class=lnt>527
</span><span class=lnt>528
</span><span class=lnt>529
</span><span class=lnt>530
</span><span class=lnt>531
</span><span class=lnt>532
</span><span class=lnt>533
</span><span class=lnt>534
</span><span class=lnt>535
</span><span class=lnt>536
</span><span class=lnt>537
</span><span class=lnt>538
</span><span class=lnt>539
</span><span class=lnt>540
</span><span class=lnt>541
</span><span class=lnt>542
</span><span class=lnt>543
</span><span class=lnt>544
</span><span class=lnt>545
</span><span class=lnt>546
</span><span class=lnt>547
</span><span class=lnt>548
</span><span class=lnt>549
</span><span class=lnt>550
</span><span class=lnt>551
</span><span class=lnt>552
</span><span class=lnt>553
</span><span class=lnt>554
</span><span class=lnt>555
</span><span class=lnt>556
</span><span class=lnt>557
</span><span class=lnt>558
</span><span class=lnt>559
</span><span class=lnt>560
</span><span class=lnt>561
</span><span class=lnt>562
</span><span class=lnt>563
</span><span class=lnt>564
</span><span class=lnt>565
</span><span class=lnt>566
</span><span class=lnt>567
</span><span class=lnt>568
</span><span class=lnt>569
</span><span class=lnt>570
</span><span class=lnt>571
</span><span class=lnt>572
</span><span class=lnt>573
</span><span class=lnt>574
</span><span class=lnt>575
</span><span class=lnt>576
</span><span class=lnt>577
</span><span class=lnt>578
</span><span class=lnt>579
</span><span class=lnt>580
</span><span class=lnt>581
</span><span class=lnt>582
</span><span class=lnt>583
</span><span class=lnt>584
</span><span class=lnt>585
</span><span class=lnt>586
</span><span class=lnt>587
</span><span class=lnt>588
</span><span class=lnt>589
</span><span class=lnt>590
</span><span class=lnt>591
</span><span class=lnt>592
</span><span class=lnt>593
</span><span class=lnt>594
</span><span class=lnt>595
</span><span class=lnt>596
</span><span class=lnt>597
</span><span class=lnt>598
</span><span class=lnt>599
</span><span class=lnt>600
</span><span class=lnt>601
</span><span class=lnt>602
</span><span class=lnt>603
</span><span class=lnt>604
</span><span class=lnt>605
</span><span class=lnt>606
</span><span class=lnt>607
</span><span class=lnt>608
</span><span class=lnt>609
</span><span class=lnt>610
</span><span class=lnt>611
</span><span class=lnt>612
</span><span class=lnt>613
</span><span class=lnt>614
</span><span class=lnt>615
</span><span class=lnt>616
</span><span class=lnt>617
</span><span class=lnt>618
</span><span class=lnt>619
</span><span class=lnt>620
</span><span class=lnt>621
</span><span class=lnt>622
</span><span class=lnt>623
</span><span class=lnt>624
</span><span class=lnt>625
</span><span class=lnt>626
</span><span class=lnt>627
</span><span class=lnt>628
</span><span class=lnt>629
</span><span class=lnt>630
</span><span class=lnt>631
</span><span class=lnt>632
</span><span class=lnt>633
</span><span class=lnt>634
</span><span class=lnt>635
</span><span class=lnt>636
</span><span class=lnt>637
</span><span class=lnt>638
</span><span class=lnt>639
</span><span class=lnt>640
</span><span class=lnt>641
</span><span class=lnt>642
</span><span class=lnt>643
</span><span class=lnt>644
</span><span class=lnt>645
</span><span class=lnt>646
</span><span class=lnt>647
</span><span class=lnt>648
</span><span class=lnt>649
</span><span class=lnt>650
</span><span class=lnt>651
</span><span class=lnt>652
</span><span class=lnt>653
</span><span class=lnt>654
</span><span class=lnt>655
</span><span class=lnt>656
</span><span class=lnt>657
</span><span class=lnt>658
</span><span class=lnt>659
</span><span class=lnt>660
</span><span class=lnt>661
</span><span class=lnt>662
</span><span class=lnt>663
</span><span class=lnt>664
</span><span class=lnt>665
</span><span class=lnt>666
</span><span class=lnt>667
</span><span class=lnt>668
</span><span class=lnt>669
</span><span class=lnt>670
</span><span class=lnt>671
</span><span class=lnt>672
</span><span class=lnt>673
</span><span class=lnt>674
</span><span class=lnt>675
</span><span class=lnt>676
</span><span class=lnt>677
</span><span class=lnt>678
</span><span class=lnt>679
</span><span class=lnt>680
</span><span class=lnt>681
</span><span class=lnt>682
</span><span class=lnt>683
</span><span class=lnt>684
</span><span class=lnt>685
</span><span class=lnt>686
</span><span class=lnt>687
</span><span class=lnt>688
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>overfitting_detection</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    过拟合检测
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>OverfittingDetector</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>warning_flags</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>detect_overfitting_simple</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>train_results</span><span class=p>,</span> <span class=n>test_results</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            简单过拟合检测
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>detection_results</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 1. 性能差异检测</span>
</span></span><span class=line><span class=cl>            <span class=n>train_sharpe</span> <span class=o>=</span> <span class=n>train_results</span><span class=p>[</span><span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>test_sharpe</span> <span class=o>=</span> <span class=n>test_results</span><span class=p>[</span><span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>sharpe_diff</span> <span class=o>=</span> <span class=n>train_sharpe</span> <span class=o>-</span> <span class=n>test_sharpe</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>detection_results</span><span class=p>[</span><span class=s1>&#39;sharpe_deterioration&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;train_sharpe&#39;</span><span class=p>:</span> <span class=n>train_sharpe</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;test_sharpe&#39;</span><span class=p>:</span> <span class=n>test_sharpe</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;difference&#39;</span><span class=p>:</span> <span class=n>sharpe_diff</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;deterioration_ratio&#39;</span><span class=p>:</span> <span class=n>sharpe_diff</span> <span class=o>/</span> <span class=n>train_sharpe</span> <span class=k>if</span> <span class=n>train_sharpe</span> <span class=o>!=</span> <span class=mi>0</span> <span class=k>else</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;inf&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;warning&#39;</span><span class=p>:</span> <span class=n>sharpe_diff</span> <span class=o>&gt;</span> <span class=mf>0.5</span> <span class=ow>or</span> <span class=p>(</span><span class=n>train_sharpe</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>test_sharpe</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 2. 收益率差异检测</span>
</span></span><span class=line><span class=cl>            <span class=n>train_return</span> <span class=o>=</span> <span class=n>train_results</span><span class=p>[</span><span class=s1>&#39;annual_return&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>test_return</span> <span class=o>=</span> <span class=n>test_results</span><span class=p>[</span><span class=s1>&#39;annual_return&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>return_diff</span> <span class=o>=</span> <span class=n>train_return</span> <span class=o>-</span> <span class=n>test_return</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>detection_results</span><span class=p>[</span><span class=s1>&#39;return_deterioration&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;train_return&#39;</span><span class=p>:</span> <span class=n>train_return</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;test_return&#39;</span><span class=p>:</span> <span class=n>test_return</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;difference&#39;</span><span class=p>:</span> <span class=n>return_diff</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;deterioration_ratio&#39;</span><span class=p>:</span> <span class=n>return_diff</span> <span class=o>/</span> <span class=n>train_return</span> <span class=k>if</span> <span class=n>train_return</span> <span class=o>!=</span> <span class=mi>0</span> <span class=k>else</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;inf&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;warning&#39;</span><span class=p>:</span> <span class=n>return_diff</span> <span class=o>&gt;</span> <span class=mf>0.1</span> <span class=ow>or</span> <span class=p>(</span><span class=n>train_return</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>test_return</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 3. 波动率变化检测</span>
</span></span><span class=line><span class=cl>            <span class=n>train_vol</span> <span class=o>=</span> <span class=n>train_results</span><span class=p>[</span><span class=s1>&#39;volatility&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>test_vol</span> <span class=o>=</span> <span class=n>test_results</span><span class=p>[</span><span class=s1>&#39;volatility&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>vol_ratio</span> <span class=o>=</span> <span class=n>test_vol</span> <span class=o>/</span> <span class=n>train_vol</span> <span class=k>if</span> <span class=n>train_vol</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;inf&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>detection_results</span><span class=p>[</span><span class=s1>&#39;volatility_change&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;train_volatility&#39;</span><span class=p>:</span> <span class=n>train_vol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;test_volatility&#39;</span><span class=p>:</span> <span class=n>test_vol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;ratio&#39;</span><span class=p>:</span> <span class=n>vol_ratio</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;warning&#39;</span><span class=p>:</span> <span class=n>vol_ratio</span> <span class=o>&gt;</span> <span class=mf>2.0</span> <span class=ow>or</span> <span class=n>vol_ratio</span> <span class=o>&lt;</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 4. 最大回撤变化检测</span>
</span></span><span class=line><span class=cl>            <span class=n>train_mdd</span> <span class=o>=</span> <span class=n>train_results</span><span class=p>[</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>test_mdd</span> <span class=o>=</span> <span class=n>test_results</span><span class=p>[</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>mdd_ratio</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>test_mdd</span><span class=p>)</span> <span class=o>/</span> <span class=nb>abs</span><span class=p>(</span><span class=n>train_mdd</span><span class=p>)</span> <span class=k>if</span> <span class=n>train_mdd</span> <span class=o>!=</span> <span class=mi>0</span> <span class=k>else</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;inf&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>detection_results</span><span class=p>[</span><span class=s1>&#39;drawdown_deterioration&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;train_max_drawdown&#39;</span><span class=p>:</span> <span class=n>train_mdd</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;test_max_drawdown&#39;</span><span class=p>:</span> <span class=n>test_mdd</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;ratio&#39;</span><span class=p>:</span> <span class=n>mdd_ratio</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;warning&#39;</span><span class=p>:</span> <span class=n>mdd_ratio</span> <span class=o>&gt;</span> <span class=mf>2.0</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 5. 胜率变化检测</span>
</span></span><span class=line><span class=cl>            <span class=n>train_win_rate</span> <span class=o>=</span> <span class=n>train_results</span><span class=p>[</span><span class=s1>&#39;win_rate&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>test_win_rate</span> <span class=o>=</span> <span class=n>test_results</span><span class=p>[</span><span class=s1>&#39;win_rate&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>win_rate_diff</span> <span class=o>=</span> <span class=n>train_win_rate</span> <span class=o>-</span> <span class=n>test_win_rate</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>detection_results</span><span class=p>[</span><span class=s1>&#39;win_rate_deterioration&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;train_win_rate&#39;</span><span class=p>:</span> <span class=n>train_win_rate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;test_win_rate&#39;</span><span class=p>:</span> <span class=n>test_win_rate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;difference&#39;</span><span class=p>:</span> <span class=n>win_rate_diff</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;warning&#39;</span><span class=p>:</span> <span class=n>win_rate_diff</span> <span class=o>&gt;</span> <span class=mf>0.2</span> <span class=ow>or</span> <span class=p>(</span><span class=n>train_win_rate</span> <span class=o>&gt;</span> <span class=mf>0.5</span> <span class=ow>and</span> <span class=n>test_win_rate</span> <span class=o>&lt;</span> <span class=mf>0.4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 综合评估</span>
</span></span><span class=line><span class=cl>            <span class=n>warnings</span> <span class=o>=</span> <span class=p>[</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;warning&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>result</span> <span class=ow>in</span> <span class=n>detection_results</span><span class=o>.</span><span class=n>values</span><span class=p>()]</span>
</span></span><span class=line><span class=cl>            <span class=n>detection_results</span><span class=p>[</span><span class=s1>&#39;overall_overfitting_risk&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;risk_level&#39;</span><span class=p>:</span> <span class=s1>&#39;high&#39;</span> <span class=k>if</span> <span class=nb>sum</span><span class=p>(</span><span class=n>warnings</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>3</span> <span class=k>else</span> <span class=s1>&#39;medium&#39;</span> <span class=k>if</span> <span class=nb>sum</span><span class=p>(</span><span class=n>warnings</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>2</span> <span class=k>else</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;warning_count&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>warnings</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;warning_details&#39;</span><span class=p>:</span> <span class=p>{</span><span class=n>k</span><span class=p>:</span> <span class=n>v</span><span class=p>[</span><span class=s1>&#39;warning&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>detection_results</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>detection_results</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>detect_overfitting_advanced</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>train_returns</span><span class=p>,</span> <span class=n>test_returns</span><span class=p>,</span> <span class=n>validation_returns</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            高级过拟合检测
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>advanced_results</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 1. 分布相似性检验</span>
</span></span><span class=line><span class=cl>            <span class=kn>from</span> <span class=nn>scipy</span> <span class=kn>import</span> <span class=n>stats</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># Kolmogorov-Smirnov检验</span>
</span></span><span class=line><span class=cl>            <span class=n>ks_statistic</span><span class=p>,</span> <span class=n>ks_pvalue</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ks_2samp</span><span class=p>(</span><span class=n>train_returns</span><span class=p>,</span> <span class=n>test_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>advanced_results</span><span class=p>[</span><span class=s1>&#39;distribution_similarity&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;ks_statistic&#39;</span><span class=p>:</span> <span class=n>ks_statistic</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;ks_pvalue&#39;</span><span class=p>:</span> <span class=n>ks_pvalue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;similar&#39;</span><span class=p>:</span> <span class=n>ks_pvalue</span> <span class=o>&gt;</span> <span class=mf>0.05</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;warning&#39;</span><span class=p>:</span> <span class=n>ks_pvalue</span> <span class=o>&lt;</span> <span class=mf>0.01</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 2. 均值差异检验</span>
</span></span><span class=line><span class=cl>            <span class=n>t_statistic</span><span class=p>,</span> <span class=n>t_pvalue</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>train_returns</span><span class=p>,</span> <span class=n>test_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>advanced_results</span><span class=p>[</span><span class=s1>&#39;mean_difference&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;t_statistic&#39;</span><span class=p>:</span> <span class=n>t_statistic</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;t_pvalue&#39;</span><span class=p>:</span> <span class=n>t_pvalue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;significant_difference&#39;</span><span class=p>:</span> <span class=n>t_pvalue</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;warning&#39;</span><span class=p>:</span> <span class=n>t_pvalue</span> <span class=o>&lt;</span> <span class=mf>0.01</span> <span class=ow>and</span> <span class=nb>abs</span><span class=p>(</span><span class=n>t_statistic</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 3. 方差差异检验</span>
</span></span><span class=line><span class=cl>            <span class=n>f_statistic</span><span class=p>,</span> <span class=n>f_pvalue</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>levene</span><span class=p>(</span><span class=n>train_returns</span><span class=p>,</span> <span class=n>test_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>advanced_results</span><span class=p>[</span><span class=s1>&#39;variance_difference&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;f_statistic&#39;</span><span class=p>:</span> <span class=n>f_statistic</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;f_pvalue&#39;</span><span class=p>:</span> <span class=n>f_pvalue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;significant_difference&#39;</span><span class=p>:</span> <span class=n>f_pvalue</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;warning&#39;</span><span class=p>:</span> <span class=n>f_pvalue</span> <span class=o>&lt;</span> <span class=mf>0.01</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 4. 自相关性检验</span>
</span></span><span class=line><span class=cl>            <span class=kn>from</span> <span class=nn>statsmodels.stats.diagnostic</span> <span class=kn>import</span> <span class=n>acorr_ljungbox</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>train_ljungbox</span> <span class=o>=</span> <span class=n>acorr_ljungbox</span><span class=p>(</span><span class=n>train_returns</span><span class=p>,</span> <span class=n>lags</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>return_df</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>test_ljungbox</span> <span class=o>=</span> <span class=n>acorr_ljungbox</span><span class=p>(</span><span class=n>test_returns</span><span class=p>,</span> <span class=n>lags</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>return_df</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>advanced_results</span><span class=p>[</span><span class=s1>&#39;autocorrelation&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;train_significant_lags&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>train_ljungbox</span><span class=p>[</span><span class=s1>&#39;lb_pvalue&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;test_significant_lags&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>test_ljungbox</span><span class=p>[</span><span class=s1>&#39;lb_pvalue&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;warning&#39;</span><span class=p>:</span> <span class=nb>abs</span><span class=p>((</span><span class=n>train_ljungbox</span><span class=p>[</span><span class=s1>&#39;lb_pvalue&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span> <span class=o>-</span> 
</span></span><span class=line><span class=cl>                               <span class=p>(</span><span class=n>test_ljungbox</span><span class=p>[</span><span class=s1>&#39;lb_pvalue&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>())</span> <span class=o>&gt;</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 5. 稳定性分析（如果有验证集）</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>validation_returns</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 三段一致性检验</span>
</span></span><span class=line><span class=cl>                <span class=n>periods</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;train&#39;</span><span class=p>,</span> <span class=s1>&#39;test&#39;</span><span class=p>,</span> <span class=s1>&#39;validation&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>returns_list</span> <span class=o>=</span> <span class=p>[</span><span class=n>train_returns</span><span class=p>,</span> <span class=n>test_returns</span><span class=p>,</span> <span class=n>validation_returns</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 计算每段的夏普比率</span>
</span></span><span class=line><span class=cl>                <span class=n>sharpe_ratios</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>ret</span> <span class=ow>in</span> <span class=n>returns_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>ret</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>sharpe</span> <span class=o>=</span> <span class=p>(</span><span class=n>ret</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=mf>0.03</span><span class=o>/</span><span class=mi>252</span><span class=p>)</span> <span class=o>/</span> <span class=n>ret</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>sharpe_ratios</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sharpe</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>sharpe_ratios</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 计算稳定性指标</span>
</span></span><span class=line><span class=cl>                <span class=n>sharpe_stability</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>sharpe_ratios</span><span class=p>)</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>sharpe_ratios</span><span class=p>)</span> <span class=k>if</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>sharpe_ratios</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=k>else</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;inf&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>advanced_results</span><span class=p>[</span><span class=s1>&#39;stability_analysis&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;sharpe_ratios&#39;</span><span class=p>:</span> <span class=nb>dict</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>periods</span><span class=p>,</span> <span class=n>sharpe_ratios</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;sharpe_stability&#39;</span><span class=p>:</span> <span class=n>sharpe_stability</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;consistency_score&#39;</span><span class=p>:</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>sharpe_stability</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;warning&#39;</span><span class=p>:</span> <span class=n>sharpe_stability</span> <span class=o>&gt;</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 6. 复杂度惩罚（基于参数数量）</span>
</span></span><span class=line><span class=cl>            <span class=n>advanced_results</span><span class=p>[</span><span class=s1>&#39;complexity_penalty&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;parameter_count&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>train_results</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;params&#39;</span><span class=p>,</span> <span class=p>{})),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;complexity_score&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>train_results</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;params&#39;</span><span class=p>,</span> <span class=p>{}))</span> <span class=o>/</span> <span class=mi>10</span><span class=p>,</span>  <span class=c1># 假设最优参数数量为10</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;penalized_performance&#39;</span><span class=p>:</span> <span class=n>train_results</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>train_results</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;params&#39;</span><span class=p>,</span> <span class=p>{}))</span> <span class=o>/</span> <span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>advanced_results</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>monte_carlo_overfitting_test</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>returns</span><span class=p>,</span> <span class=n>n_simulations</span><span class=o>=</span><span class=mi>1000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            蒙特卡洛过拟合测试
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 计算原始策略的统计量</span>
</span></span><span class=line><span class=cl>            <span class=n>original_sharpe</span> <span class=o>=</span> <span class=p>(</span><span class=n>returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=mf>0.03</span><span class=o>/</span><span class=mi>252</span><span class=p>)</span> <span class=o>/</span> <span class=n>returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>original_return</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>*</span> <span class=mi>252</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 生成随机策略</span>
</span></span><span class=line><span class=cl>            <span class=n>random_sharpes</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=n>random_returns</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_simulations</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># 随机重排收益率</span>
</span></span><span class=line><span class=cl>                <span class=n>shuffled_returns</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>permutation</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 计算随机策略的统计量</span>
</span></span><span class=line><span class=cl>                <span class=n>random_sharpe</span> <span class=o>=</span> <span class=p>(</span><span class=n>shuffled_returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=mf>0.03</span><span class=o>/</span><span class=mi>252</span><span class=p>)</span> <span class=o>/</span> <span class=n>shuffled_returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>random_return</span> <span class=o>=</span> <span class=n>shuffled_returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>*</span> <span class=mi>252</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>random_sharpes</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>random_sharpe</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>random_returns</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>random_return</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 计算p值</span>
</span></span><span class=line><span class=cl>            <span class=n>sharpe_pvalue</span> <span class=o>=</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>random_sharpes</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>original_sharpe</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>return_pvalue</span> <span class=o>=</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>random_returns</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>original_return</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 计算百分位数</span>
</span></span><span class=line><span class=cl>            <span class=n>sharpe_percentile</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>percentileofscore</span><span class=p>(</span><span class=n>random_sharpes</span><span class=p>,</span> <span class=n>original_sharpe</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>return_percentile</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>percentileofscore</span><span class=p>(</span><span class=n>random_returns</span><span class=p>,</span> <span class=n>original_return</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;original_sharpe&#39;</span><span class=p>:</span> <span class=n>original_sharpe</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;original_return&#39;</span><span class=p>:</span> <span class=n>original_return</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;random_sharpes_mean&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>random_sharpes</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;random_returns_mean&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>random_returns</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;sharpe_pvalue&#39;</span><span class=p>:</span> <span class=n>sharpe_pvalue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;return_pvalue&#39;</span><span class=p>:</span> <span class=n>return_pvalue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;sharpe_percentile&#39;</span><span class=p>:</span> <span class=n>sharpe_percentile</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;return_percentile&#39;</span><span class=p>:</span> <span class=n>return_percentile</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;significance&#39;</span><span class=p>:</span> <span class=n>sharpe_pvalue</span> <span class=o>&lt;</span> <span class=mf>0.05</span> <span class=ow>and</span> <span class=n>return_pvalue</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;warning&#39;</span><span class=p>:</span> <span class=n>sharpe_pvalue</span> <span class=o>&gt;</span> <span class=mf>0.1</span> <span class=ow>or</span> <span class=n>return_pvalue</span> <span class=o>&gt;</span> <span class=mf>0.1</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>cross_validation_overfitting_test</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>returns</span><span class=p>,</span> <span class=n>n_splits</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            交叉验证过拟合测试
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=kn>from</span> <span class=nn>sklearn.model_selection</span> <span class=kn>import</span> <span class=n>KFold</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>kf</span> <span class=o>=</span> <span class=n>KFold</span><span class=p>(</span><span class=n>n_splits</span><span class=o>=</span><span class=n>n_splits</span><span class=p>,</span> <span class=n>shuffle</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>fold_results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>fold</span><span class=p>,</span> <span class=p>(</span><span class=n>train_idx</span><span class=p>,</span> <span class=n>test_idx</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>kf</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=n>returns</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                <span class=n>train_returns</span> <span class=o>=</span> <span class=n>returns</span><span class=p>[</span><span class=n>train_idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>test_returns</span> <span class=o>=</span> <span class=n>returns</span><span class=p>[</span><span class=n>test_idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 计算训练集和测试集的统计量</span>
</span></span><span class=line><span class=cl>                <span class=n>train_sharpe</span> <span class=o>=</span> <span class=p>(</span><span class=n>train_returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=mf>0.03</span><span class=o>/</span><span class=mi>252</span><span class=p>)</span> <span class=o>/</span> <span class=n>train_returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>test_sharpe</span> <span class=o>=</span> <span class=p>(</span><span class=n>test_returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=mf>0.03</span><span class=o>/</span><span class=mi>252</span><span class=p>)</span> <span class=o>/</span> <span class=n>test_returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>train_return</span> <span class=o>=</span> <span class=n>train_returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>*</span> <span class=mi>252</span>
</span></span><span class=line><span class=cl>                <span class=n>test_return</span> <span class=o>=</span> <span class=n>test_returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>*</span> <span class=mi>252</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>fold_results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;fold&#39;</span><span class=p>:</span> <span class=n>fold</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;train_sharpe&#39;</span><span class=p>:</span> <span class=n>train_sharpe</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;test_sharpe&#39;</span><span class=p>:</span> <span class=n>test_sharpe</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;sharpe_difference&#39;</span><span class=p>:</span> <span class=n>train_sharpe</span> <span class=o>-</span> <span class=n>test_sharpe</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;train_return&#39;</span><span class=p>:</span> <span class=n>train_return</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;test_return&#39;</span><span class=p>:</span> <span class=n>test_return</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;return_difference&#39;</span><span class=p>:</span> <span class=n>train_return</span> <span class=o>-</span> <span class=n>test_return</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 计算统计量</span>
</span></span><span class=line><span class=cl>            <span class=n>sharpe_differences</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span><span class=p>[</span><span class=s1>&#39;sharpe_difference&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>fold_results</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>return_differences</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span><span class=p>[</span><span class=s1>&#39;return_difference&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>fold_results</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;fold_results&#39;</span><span class=p>:</span> <span class=n>fold_results</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;avg_sharpe_difference&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>sharpe_differences</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;std_sharpe_difference&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>sharpe_differences</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;avg_return_difference&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>return_differences</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;std_return_difference&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>return_differences</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;max_sharpe_difference&#39;</span><span class=p>:</span> <span class=nb>max</span><span class=p>(</span><span class=n>sharpe_differences</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;max_return_difference&#39;</span><span class=p>:</span> <span class=nb>max</span><span class=p>(</span><span class=n>return_differences</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;overfitting_score&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>sharpe_differences</span><span class=p>)</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>return_differences</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;warning&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>sharpe_differences</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mf>0.5</span> <span class=ow>or</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>return_differences</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mf>0.1</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>OverfittingDetector</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>overfitting_prevention</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    过拟合防范措施
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>OverfittingPrevention</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>prevention_methods</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>implement_regularization</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>strategy_params</span><span class=p>,</span> <span class=n>regularization_strength</span><span class=o>=</span><span class=mf>0.1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            正则化
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=c1># L1正则化（Lasso）</span>
</span></span><span class=line><span class=cl>            <span class=n>l1_penalty</span> <span class=o>=</span> <span class=n>regularization_strength</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>strategy_params</span><span class=o>.</span><span class=n>values</span><span class=p>())))</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># L2正则化（Ridge）</span>
</span></span><span class=line><span class=cl>            <span class=n>l2_penalty</span> <span class=o>=</span> <span class=n>regularization_strength</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>strategy_params</span><span class=o>.</span><span class=n>values</span><span class=p>()))</span> <span class=o>**</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># Elastic Net</span>
</span></span><span class=line><span class=cl>            <span class=n>alpha</span> <span class=o>=</span> <span class=mf>0.5</span>  <span class=c1># L1比例</span>
</span></span><span class=line><span class=cl>            <span class=n>elastic_net_penalty</span> <span class=o>=</span> <span class=n>alpha</span> <span class=o>*</span> <span class=n>l1_penalty</span> <span class=o>+</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>alpha</span><span class=p>)</span> <span class=o>*</span> <span class=n>l2_penalty</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;l1_penalty&#39;</span><span class=p>:</span> <span class=n>l1_penalty</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;l2_penalty&#39;</span><span class=p>:</span> <span class=n>l2_penalty</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;elastic_net_penalty&#39;</span><span class=p>:</span> <span class=n>elastic_net_penalty</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;total_penalty&#39;</span><span class=p>:</span> <span class=n>elastic_net_penalty</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;regularized_objective&#39;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>obj</span><span class=p>:</span> <span class=n>obj</span> <span class=o>-</span> <span class=n>elastic_net_penalty</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>implement_early_stopping</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>validation_metric_history</span><span class=p>,</span> <span class=n>patience</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>min_delta</span><span class=o>=</span><span class=mf>0.001</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            早停机制
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>validation_metric_history</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>patience</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 检查最近patience次是否有改进</span>
</span></span><span class=line><span class=cl>            <span class=n>recent_metrics</span> <span class=o>=</span> <span class=n>validation_metric_history</span><span class=p>[</span><span class=o>-</span><span class=n>patience</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>            <span class=n>best_recent</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>recent_metrics</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>best_ever</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>validation_metric_history</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 如果最近patience次都没有超过历史最佳，则停止</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>best_recent</span> <span class=o>&lt;</span> <span class=n>best_ever</span> <span class=o>-</span> <span class=n>min_delta</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>True</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;best_epoch&#39;</span><span class=p>:</span> <span class=n>validation_metric_history</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>best_ever</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;best_metric&#39;</span><span class=p>:</span> <span class=n>best_ever</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;current_epoch&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>validation_metric_history</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;current_metric&#39;</span><span class=p>:</span> <span class=n>validation_metric_history</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;stopping_reason&#39;</span><span class=p>:</span> <span class=s1>&#39;no_improvement&#39;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>implement_parameter_shrinkage</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>optimal_params</span><span class=p>,</span> <span class=n>shrinkage_factor</span><span class=o>=</span><span class=mf>0.9</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            参数收缩
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>shrunk_params</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>param_name</span><span class=p>,</span> <span class=n>param_value</span> <span class=ow>in</span> <span class=n>optimal_params</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=c1># 向默认值收缩</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>param_value</span><span class=p>,</span> <span class=p>(</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                    <span class=n>default_value</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_default_value</span><span class=p>(</span><span class=n>param_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>shrunk_value</span> <span class=o>=</span> <span class=p>(</span><span class=n>shrinkage_factor</span> <span class=o>*</span> <span class=n>param_value</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>                                  <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>shrinkage_factor</span><span class=p>)</span> <span class=o>*</span> <span class=n>default_value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>shrunk_params</span><span class=p>[</span><span class=n>param_name</span><span class=p>]</span> <span class=o>=</span> <span class=nb>type</span><span class=p>(</span><span class=n>param_value</span><span class=p>)(</span><span class=n>shrunk_value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>shrunk_params</span><span class=p>[</span><span class=n>param_name</span><span class=p>]</span> <span class=o>=</span> <span class=n>param_value</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;original_params&#39;</span><span class=p>:</span> <span class=n>optimal_params</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;shrunk_params&#39;</span><span class=p>:</span> <span class=n>shrunk_params</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;shrinkage_factor&#39;</span><span class=p>:</span> <span class=n>shrinkage_factor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;parameter_change&#39;</span><span class=p>:</span> <span class=p>{</span><span class=n>k</span><span class=p>:</span> <span class=n>shrunk_params</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>-</span> <span class=n>optimal_params</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> 
</span></span><span class=line><span class=cl>                                   <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>optimal_params</span> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>optimal_params</span><span class=p>[</span><span class=n>k</span><span class=p>],</span> <span class=p>(</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>))}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>get_default_value</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>param_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            获取参数默认值
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>default_values</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;ma_short&#39;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;ma_long&#39;</span><span class=p>:</span> <span class=mi>30</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;rsi_period&#39;</span><span class=p>:</span> <span class=mi>14</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;rsi_threshold&#39;</span><span class=p>:</span> <span class=mi>30</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;stop_loss&#39;</span><span class=p>:</span> <span class=mf>0.05</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;take_profit&#39;</span><span class=p>:</span> <span class=mf>0.10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;position_size&#39;</span><span class=p>:</span> <span class=mf>0.2</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>default_values</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>param_name</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>implement_ensemble_strategy</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>strategy_results_list</span><span class=p>,</span> <span class=n>ensemble_method</span><span class=o>=</span><span class=s1>&#39;weighted_average&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            集成策略
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>ensemble_method</span> <span class=o>==</span> <span class=s1>&#39;simple_average&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 简单平均</span>
</span></span><span class=line><span class=cl>                <span class=n>ensemble_returns</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>([</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>results</span> <span class=ow>in</span> <span class=n>strategy_results_list</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>ensemble_method</span> <span class=o>==</span> <span class=s1>&#39;weighted_average&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 基于历史表现加权平均</span>
</span></span><span class=line><span class=cl>                <span class=n>weights</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>results</span> <span class=ow>in</span> <span class=n>strategy_results_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 使用夏普比率作为权重</span>
</span></span><span class=line><span class=cl>                    <span class=n>sharpe</span> <span class=o>=</span> <span class=n>results</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 确保权重为正</span>
</span></span><span class=line><span class=cl>                    <span class=n>weight</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>sharpe</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>weights</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>weight</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 归一化权重</span>
</span></span><span class=line><span class=cl>                <span class=n>total_weight</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>weights</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>total_weight</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>weights</span> <span class=o>=</span> <span class=p>[</span><span class=n>w</span> <span class=o>/</span> <span class=n>total_weight</span> <span class=k>for</span> <span class=n>w</span> <span class=ow>in</span> <span class=n>weights</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>weights</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>strategy_results_list</span><span class=p>)]</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>strategy_results_list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 计算加权平均收益</span>
</span></span><span class=line><span class=cl>                <span class=n>ensemble_returns</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>average</span><span class=p>([</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>results</span> <span class=ow>in</span> <span class=n>strategy_results_list</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                                            <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>weights</span><span class=o>=</span><span class=n>weights</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>ensemble_method</span> <span class=o>==</span> <span class=s1>&#39;best_selector&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 选择最佳策略</span>
</span></span><span class=line><span class=cl>                <span class=n>best_idx</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>argmax</span><span class=p>([</span><span class=n>results</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=k>for</span> <span class=n>results</span> <span class=ow>in</span> <span class=n>strategy_results_list</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=n>ensemble_returns</span> <span class=o>=</span> <span class=n>strategy_results_list</span><span class=p>[</span><span class=n>best_idx</span><span class=p>][</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;ensemble_returns&#39;</span><span class=p>:</span> <span class=n>ensemble_returns</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;ensemble_method&#39;</span><span class=p>:</span> <span class=n>ensemble_method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;individual_weights&#39;</span><span class=p>:</span> <span class=n>weights</span> <span class=k>if</span> <span class=n>ensemble_method</span> <span class=o>==</span> <span class=s1>&#39;weighted_average&#39;</span> <span class=k>else</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;diversification_benefit&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_diversification_benefit</span><span class=p>(</span><span class=n>strategy_results_list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>calculate_diversification_benefit</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>strategy_results_list</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            计算多样化收益
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>individual_returns</span> <span class=o>=</span> <span class=p>[</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>results</span> <span class=ow>in</span> <span class=n>strategy_results_list</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 计算平均个体波动率</span>
</span></span><span class=line><span class=cl>            <span class=n>individual_vols</span> <span class=o>=</span> <span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span> <span class=k>for</span> <span class=n>returns</span> <span class=ow>in</span> <span class=n>individual_returns</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>avg_individual_vol</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>individual_vols</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 计算组合波动率</span>
</span></span><span class=line><span class=cl>            <span class=n>portfolio_returns</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>individual_returns</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>portfolio_vol</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>portfolio_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 多样化收益</span>
</span></span><span class=line><span class=cl>            <span class=n>diversification_benefit</span> <span class=o>=</span> <span class=p>(</span><span class=n>avg_individual_vol</span> <span class=o>-</span> <span class=n>portfolio_vol</span><span class=p>)</span> <span class=o>/</span> <span class=n>avg_individual_vol</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>diversification_benefit</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>implement_robust_optimization</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>strategy_func</span><span class=p>,</span> <span class=n>data_list</span><span class=p>,</span> <span class=n>robustness_level</span><span class=o>=</span><span class=mf>0.1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            鲁棒优化
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=c1># 在多个数据集上评估策略</span>
</span></span><span class=line><span class=cl>            <span class=n>all_results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>data</span> <span class=ow>in</span> <span class=n>data_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>results</span> <span class=o>=</span> <span class=n>strategy_func</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>all_results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 计算鲁棒性指标</span>
</span></span><span class=line><span class=cl>            <span class=n>robustness_metrics</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 收益稳定性</span>
</span></span><span class=line><span class=cl>            <span class=n>returns_list</span> <span class=o>=</span> <span class=p>[</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>results</span> <span class=ow>in</span> <span class=n>all_results</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>mean_returns</span> <span class=o>=</span> <span class=p>[</span><span class=n>returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=k>for</span> <span class=n>returns</span> <span class=ow>in</span> <span class=n>returns_list</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>robustness_metrics</span><span class=p>[</span><span class=s1>&#39;return_stability&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>mean_returns</span><span class=p>)</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>mean_returns</span><span class=p>)</span> <span class=k>if</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>mean_returns</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=k>else</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;inf&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 夏普比率稳定性</span>
</span></span><span class=line><span class=cl>            <span class=n>sharpes</span> <span class=o>=</span> <span class=p>[</span><span class=n>results</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=k>for</span> <span class=n>results</span> <span class=ow>in</span> <span class=n>all_results</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>robustness_metrics</span><span class=p>[</span><span class=s1>&#39;sharpe_stability&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>sharpes</span><span class=p>)</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>sharpes</span><span class=p>)</span> <span class=k>if</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>sharpes</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=k>else</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;inf&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 最大回撤稳定性</span>
</span></span><span class=line><span class=cl>            <span class=n>max_drawdowns</span> <span class=o>=</span> <span class=p>[</span><span class=n>results</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=k>for</span> <span class=n>results</span> <span class=ow>in</span> <span class=n>all_results</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>robustness_metrics</span><span class=p>[</span><span class=s1>&#39;drawdown_stability&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>max_drawdowns</span><span class=p>)</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>max_drawdowns</span><span class=p>)</span> <span class=k>if</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>max_drawdowns</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=k>else</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;inf&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 综合鲁棒性评分</span>
</span></span><span class=line><span class=cl>            <span class=n>stability_scores</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>robustness_metrics</span><span class=p>[</span><span class=s1>&#39;return_stability&#39;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>                <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>robustness_metrics</span><span class=p>[</span><span class=s1>&#39;sharpe_stability&#39;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>                <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>robustness_metrics</span><span class=p>[</span><span class=s1>&#39;drawdown_stability&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>robustness_metrics</span><span class=p>[</span><span class=s1>&#39;overall_robustness&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>stability_scores</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;individual_results&#39;</span><span class=p>:</span> <span class=n>all_results</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;robustness_metrics&#39;</span><span class=p>:</span> <span class=n>robustness_metrics</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;robust_objective&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>sharpes</span><span class=p>)</span> <span class=o>*</span> <span class=n>robustness_metrics</span><span class=p>[</span><span class=s1>&#39;overall_robustness&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>implement_bayesian_shrinkage</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>optimal_params</span><span class=p>,</span> <span class=n>prior_mean</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>prior_std</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            贝叶斯收缩
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>prior_mean</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>prior_mean</span> <span class=o>=</span> <span class=p>{</span><span class=n>k</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_default_value</span><span class=p>(</span><span class=n>k</span><span class=p>)</span> <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>optimal_params</span><span class=o>.</span><span class=n>keys</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>prior_std</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>prior_std</span> <span class=o>=</span> <span class=p>{</span><span class=n>k</span><span class=p>:</span> <span class=nb>abs</span><span class=p>(</span><span class=n>v</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.3</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>optimal_params</span><span class=o>.</span><span class=n>items</span><span class=p>()</span> 
</span></span><span class=line><span class=cl>                           <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=p>(</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>))}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 计算后验参数</span>
</span></span><span class=line><span class=cl>            <span class=n>posterior_params</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>param_name</span> <span class=ow>in</span> <span class=n>optimal_params</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>optimal_params</span><span class=p>[</span><span class=n>param_name</span><span class=p>],</span> <span class=p>(</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 似然函数参数</span>
</span></span><span class=line><span class=cl>                    <span class=n>likelihood_mean</span> <span class=o>=</span> <span class=n>optimal_params</span><span class=p>[</span><span class=n>param_name</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=n>likelihood_precision</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=n>prior_std</span><span class=p>[</span><span class=n>param_name</span><span class=p>]</span> <span class=o>**</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=c1># 先验参数</span>
</span></span><span class=line><span class=cl>                    <span class=n>prior_precision</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=n>prior_std</span><span class=p>[</span><span class=n>param_name</span><span class=p>]</span> <span class=o>**</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=c1># 后验参数</span>
</span></span><span class=line><span class=cl>                    <span class=n>posterior_precision</span> <span class=o>=</span> <span class=n>likelihood_precision</span> <span class=o>+</span> <span class=n>prior_precision</span>
</span></span><span class=line><span class=cl>                    <span class=n>posterior_mean</span> <span class=o>=</span> <span class=p>(</span><span class=n>likelihood_precision</span> <span class=o>*</span> <span class=n>likelihood_mean</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>                                    <span class=n>prior_precision</span> <span class=o>*</span> <span class=n>prior_mean</span><span class=p>[</span><span class=n>param_name</span><span class=p>])</span> <span class=o>/</span> <span class=n>posterior_precision</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=n>posterior_params</span><span class=p>[</span><span class=n>param_name</span><span class=p>]</span> <span class=o>=</span> <span class=n>posterior_mean</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>posterior_params</span><span class=p>[</span><span class=n>param_name</span><span class=p>]</span> <span class=o>=</span> <span class=n>optimal_params</span><span class=p>[</span><span class=n>param_name</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;prior_params&#39;</span><span class=p>:</span> <span class=n>prior_mean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;optimal_params&#39;</span><span class=p>:</span> <span class=n>optimal_params</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;posterior_params&#39;</span><span class=p>:</span> <span class=n>posterior_params</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;shrinkage_strength&#39;</span><span class=p>:</span> <span class=p>{</span><span class=n>k</span><span class=p>:</span> <span class=n>prior_precision</span> <span class=o>/</span> <span class=p>(</span><span class=n>prior_precision</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=n>prior_std</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>**</span> <span class=mi>2</span><span class=p>))</span> 
</span></span><span class=line><span class=cl>                                       <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>prior_std</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>OverfittingPrevention</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>multi_objective_optimization</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    多目标优化
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>MultiObjectiveOptimizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>pareto_front</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>objective_history</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>optimize_multiple_objectives</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>strategy_func</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>objectives</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            多目标优化
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=c1># 生成参数组合（这里使用随机采样作为示例）</span>
</span></span><span class=line><span class=cl>            <span class=n>n_samples</span> <span class=o>=</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>            <span class=n>parameter_combinations</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_samples</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>params</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>sample_random_parameters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>parameter_combinations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 评估所有参数组合</span>
</span></span><span class=line><span class=cl>            <span class=n>evaluated_solutions</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>params</span> <span class=ow>in</span> <span class=n>parameter_combinations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 运行策略</span>
</span></span><span class=line><span class=cl>                    <span class=n>results</span> <span class=o>=</span> <span class=n>strategy_func</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=o>**</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=c1># 计算多个目标</span>
</span></span><span class=line><span class=cl>                    <span class=n>objectives_values</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=n>obj_name</span><span class=p>,</span> <span class=n>obj_func</span> <span class=ow>in</span> <span class=n>objectives</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                        <span class=n>objectives_values</span><span class=p>[</span><span class=n>obj_name</span><span class=p>]</span> <span class=o>=</span> <span class=n>obj_func</span><span class=p>(</span><span class=n>results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=n>evaluated_solutions</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                        <span class=s1>&#39;params&#39;</span><span class=p>:</span> <span class=n>params</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s1>&#39;objectives&#39;</span><span class=p>:</span> <span class=n>objectives_values</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s1>&#39;dominated&#39;</span><span class=p>:</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>                    <span class=p>})</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 找出帕累托最优解</span>
</span></span><span class=line><span class=cl>            <span class=n>pareto_solutions</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>find_pareto_front</span><span class=p>(</span><span class=n>evaluated_solutions</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;all_solutions&#39;</span><span class=p>:</span> <span class=n>evaluated_solutions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;pareto_solutions&#39;</span><span class=p>:</span> <span class=n>pareto_solutions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;pareto_front&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>extract_pareto_front</span><span class=p>(</span><span class=n>pareto_solutions</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;hypervolume&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_hypervolume</span><span class=p>(</span><span class=n>pareto_solutions</span><span class=p>,</span> <span class=n>objectives</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>find_pareto_front</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>solutions</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            找出帕累托前沿
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>n_solutions</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>solutions</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_solutions</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_solutions</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>i</span> <span class=o>!=</span> <span class=n>j</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=c1># 检查solution i是否被solution j支配</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>dominates</span><span class=p>(</span><span class=n>solutions</span><span class=p>[</span><span class=n>j</span><span class=p>],</span> <span class=n>solutions</span><span class=p>[</span><span class=n>i</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                            <span class=n>solutions</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=s1>&#39;dominated&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>                            <span class=k>break</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 返回非支配解</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>[</span><span class=n>sol</span> <span class=k>for</span> <span class=n>sol</span> <span class=ow>in</span> <span class=n>solutions</span> <span class=k>if</span> <span class=ow>not</span> <span class=n>sol</span><span class=p>[</span><span class=s1>&#39;dominated&#39;</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>dominates</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>solution_a</span><span class=p>,</span> <span class=n>solution_b</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            检查solution_a是否支配solution_b
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>obj_a</span> <span class=o>=</span> <span class=n>solution_a</span><span class=p>[</span><span class=s1>&#39;objectives&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>obj_b</span> <span class=o>=</span> <span class=n>solution_b</span><span class=p>[</span><span class=s1>&#39;objectives&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># solution_a支配solution_b的条件：</span>
</span></span><span class=line><span class=cl>            <span class=c1># 1. solution_a在所有目标上都不比solution_b差</span>
</span></span><span class=line><span class=cl>            <span class=c1># 2. solution_a在至少一个目标上比solution_b好</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>at_least_one_better</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>obj_name</span> <span class=ow>in</span> <span class=n>obj_a</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>obj_a</span><span class=p>[</span><span class=n>obj_name</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>obj_b</span><span class=p>[</span><span class=n>obj_name</span><span class=p>]:</span>  <span class=c1># 假设是最小化问题</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>obj_a</span><span class=p>[</span><span class=n>obj_name</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>obj_b</span><span class=p>[</span><span class=n>obj_name</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=n>at_least_one_better</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>at_least_one_better</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>extract_pareto_front</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>pareto_solutions</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            提取帕累托前沿数据
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>pareto_front</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>solution</span> <span class=ow>in</span> <span class=n>pareto_solutions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>objectives_values</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>solution</span><span class=p>[</span><span class=s1>&#39;objectives&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=n>pareto_front</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>objectives_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>pareto_front</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>calculate_hypervolume</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>pareto_solutions</span><span class=p>,</span> <span class=n>objectives</span><span class=p>,</span> <span class=n>reference_point</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            计算超体积指标
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>pareto_solutions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 如果没有指定参考点，使用最差值</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reference_point</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>reference_point</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>obj_name</span> <span class=ow>in</span> <span class=n>objectives</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>all_values</span> <span class=o>=</span> <span class=p>[</span><span class=n>sol</span><span class=p>[</span><span class=s1>&#39;objectives&#39;</span><span class=p>][</span><span class=n>obj_name</span><span class=p>]</span> <span class=k>for</span> <span class=n>sol</span> <span class=ow>in</span> <span class=n>pareto_solutions</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=n>reference_point</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>max</span><span class=p>(</span><span class=n>all_values</span><span class=p>)</span> <span class=o>*</span> <span class=mf>1.1</span><span class=p>)</span>  <span class=c1># 稍微扩大</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=kn>from</span> <span class=nn>pymoo.util.misc</span> <span class=kn>import</span> <span class=n>stack</span>
</span></span><span class=line><span class=cl>                <span class=kn>from</span> <span class=nn>pymoo.factory</span> <span class=kn>import</span> <span class=n>get_performance_indicator</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 提取帕累托解的目标值</span>
</span></span><span class=line><span class=cl>                <span class=n>F</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>sol</span><span class=p>[</span><span class=s1>&#39;objectives&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>()</span> <span class=k>for</span> <span class=n>sol</span> <span class=ow>in</span> <span class=n>pareto_solutions</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 计算超体积</span>
</span></span><span class=line><span class=cl>                <span class=n>hv</span> <span class=o>=</span> <span class=n>get_performance_indicator</span><span class=p>(</span><span class=s2>&#34;hv&#34;</span><span class=p>,</span> <span class=n>ref_point</span><span class=o>=</span><span class=n>reference_point</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>hypervolume</span> <span class=o>=</span> <span class=n>hv</span><span class=o>.</span><span class=n>calc</span><span class=p>(</span><span class=n>F</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>hypervolume</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>ImportError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;请安装pymoo以计算超体积: pip install pymoo&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>select_preferred_solution</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>pareto_solutions</span><span class=p>,</span> <span class=n>preferences</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            选择偏好解
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=c1># 简单的加权和方法</span>
</span></span><span class=line><span class=cl>            <span class=n>scores</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>solution</span> <span class=ow>in</span> <span class=n>pareto_solutions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>score</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>obj_name</span><span class=p>,</span> <span class=n>weight</span> <span class=ow>in</span> <span class=n>preferences</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>obj_name</span> <span class=ow>in</span> <span class=n>solution</span><span class=p>[</span><span class=s1>&#39;objectives&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                        <span class=c1># 标准化目标值</span>
</span></span><span class=line><span class=cl>                        <span class=n>obj_values</span> <span class=o>=</span> <span class=p>[</span><span class=n>sol</span><span class=p>[</span><span class=s1>&#39;objectives&#39;</span><span class=p>][</span><span class=n>obj_name</span><span class=p>]</span> <span class=k>for</span> <span class=n>sol</span> <span class=ow>in</span> <span class=n>pareto_solutions</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                        <span class=n>normalized_value</span> <span class=o>=</span> <span class=p>(</span><span class=n>solution</span><span class=p>[</span><span class=s1>&#39;objectives&#39;</span><span class=p>][</span><span class=n>obj_name</span><span class=p>]</span> <span class=o>-</span> <span class=nb>min</span><span class=p>(</span><span class=n>obj_values</span><span class=p>))</span> <span class=o>/</span> <span class=p>(</span><span class=nb>max</span><span class=p>(</span><span class=n>obj_values</span><span class=p>)</span> <span class=o>-</span> <span class=nb>min</span><span class=p>(</span><span class=n>obj_values</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                        <span class=n>score</span> <span class=o>+=</span> <span class=n>weight</span> <span class=o>*</span> <span class=n>normalized_value</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>scores</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>score</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 选择得分最高的解</span>
</span></span><span class=line><span class=cl>            <span class=n>best_idx</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>argmin</span><span class=p>(</span><span class=n>scores</span><span class=p>)</span>  <span class=c1># 假设是最小化</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;preferred_solution&#39;</span><span class=p>:</span> <span class=n>pareto_solutions</span><span class=p>[</span><span class=n>best_idx</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;selection_score&#39;</span><span class=p>:</span> <span class=n>scores</span><span class=p>[</span><span class=n>best_idx</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;all_scores&#39;</span><span class=p>:</span> <span class=n>scores</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>sample_random_parameters</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            随机采样参数
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=c1># 这里应该根据具体的参数空间定义</span>
</span></span><span class=line><span class=cl>            <span class=n>params</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;ma_short&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mi>21</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;ma_long&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>20</span><span class=p>,</span> <span class=mi>61</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;stop_loss&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.02</span><span class=p>,</span> <span class=mf>0.10</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;take_profit&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.05</span><span class=p>,</span> <span class=mf>0.20</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;position_size&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>MultiObjectiveOptimizer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 策略优化示例</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== SuperMind策略优化与参数调优 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;本讲介绍了策略参数优化的方法和技巧&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;请在SuperMind平台上应用这些优化技术&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;注意防范过拟合，确保策略的稳健性&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=总结>总结</h2><p>本讲详细介绍了策略优化与参数调优的核心技术，包括：</p><ol><li><strong>参数优化基础</strong>：优化目标、参数类型、优化方法和评估指标</li><li><strong>网格搜索优化</strong>：基础网格搜索、并行优化和结果可视化</li><li><strong>随机搜索和贝叶斯优化</strong>：更高效的参数搜索方法</li><li><strong>过拟合防范</strong>：检测方法、防范措施和验证技术</li><li><strong>多目标优化</strong>：帕累托前沿分析和偏好解选择</li></ol><p>掌握策略优化技巧是提升策略性能的关键，在下一讲中我们将学习高级回测技巧。</p></div></article><aside class="lg:w-80 xl:w-96"><div class=space-y-8></div></aside></div><nav class="border-t border-gray-200 mt-12 pt-8"><div class="flex justify-between items-center"><a href=/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/07-%E5%9B%9E%E6%B5%8B%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%BB%A9%E6%95%88%E8%AF%84%E4%BC%B0/ class="group flex items-center"><svg class="w-5 h-5 mr-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0 7-7m-7 7h18"/></svg><div><div class="text-sm text-gray-600">上一篇</div><div class="font-medium group-hover:text-primary-600">SuperMind第7讲：回测系统与绩效评估</div></div></a><a href=/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/09-%E9%AB%98%E7%BA%A7%E5%9B%9E%E6%B5%8B%E6%8A%80%E5%B7%A7%E4%B8%8E%E5%AE%9E%E7%9B%98%E5%87%86%E5%A4%87/ class="group flex items-center text-right"><div><div class="text-sm text-gray-600">Next Post</div><div class="font-medium group-hover:text-primary-600">SuperMind第9讲：高级回测技巧与实盘准备</div></div><svg class="w-5 h-5 ml-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0-7 7m7-7H3"/></svg></a></div></nav></div></div><footer class="bg-gray-50 py-12 border-t border-gray-200"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><div class="flex flex-col md:flex-row justify-between space-y-4 md:space-y-0"><div class=flex-1><div class="flex items-center space-x-3 mb-4"><a href=https://sk-quant.github.io/ class=inline-block><img src=/images/logo.svg alt=烧烤量化 class=h-6>
</a><span class="text-xl font-bold text-gray-900">烧烤量化</span></div><div class="flex space-x-3 p-2"></div></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div></div><div class="mt-12 pt-8 border-t border-gray-200"><div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0"><p class="text-gray-600 text-sm">© 2025 烧烤量化. All rights reserved.</p><a href=https://chaoming.li class="text-sm text-gray-600 hover:text-primary-600" target=_blank rel="noopener noreferrer">Powered by sk-quant</a></div></div></div></footer><script>const mobileMenuButton=document.getElementById("mobile-menu-button");mobileMenuButton&&mobileMenuButton.addEventListener("click",function(){const e=document.getElementById("mobile-menu");e&&e.classList.toggle("hidden")})</script></body></html>