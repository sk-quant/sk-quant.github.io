<!doctype html><html lang=zh-cn class=h-full><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-XXXXXXX")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XXXXXXXXXX")</script><title>SuperMind第2讲：金融数据获取与API基础应用 | 烧烤量化</title>
<meta name=description content="深入掌握SuperMind数据接口体系：从基础取数函数到高级数据处理，构建量化策略的数据基础。"><meta name=author content="Ryan"><meta name=robots content="index, follow"><meta property="og:title" content="SuperMind第2讲：金融数据获取与API基础应用 | 烧烤量化"><meta property="og:description" content="深入掌握SuperMind数据接口体系：从基础取数函数到高级数据处理，构建量化策略的数据基础。"><meta property="og:type" content="article"><meta property="og:url" content="https://sk-quant.github.io/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/02-%E9%87%91%E8%9E%8D%E6%95%B0%E6%8D%AE%E8%8E%B7%E5%8F%96%E4%B8%8Eapi%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8/"><meta property="og:site_name" content="烧烤量化"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="SuperMind第2讲：金融数据获取与API基础应用 | 烧烤量化"><meta name=twitter:description content="深入掌握SuperMind数据接口体系：从基础取数函数到高级数据处理，构建量化策略的数据基础。"><link rel=icon type=image/x-icon href=/images/favicon.ico><link rel=canonical href=https://sk-quant.github.io/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/02-%E9%87%91%E8%9E%8D%E6%95%B0%E6%8D%AE%E8%8E%B7%E5%8F%96%E4%B8%8Eapi%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8/><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel=stylesheet><link rel=stylesheet href="/css/main.min.9a3c970d7feebe1317992d10ced98f226635b831a963ee601e5901734ff0da21.css"></head><body class="min-h-screen flex flex-col"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-XXXXXXX" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class="fixed top-0 left-0 right-0 z-50"><div class=mobile-menu-wrapper><input type=checkbox id=nav-toggle class=nav-toggle><header class="fixed w-full top-0 z-50 bg-white/80 backdrop-blur-sm border-b border-gray-100"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><nav class="flex items-center justify-between h-20"><a href=https://sk-quant.github.io/ class="flex items-center space-x-4"><img src=/images/logo.svg alt=烧烤量化 class=h-12>
<span class="text-3xl font-semibold text-gray-800">烧烤量化</span></a><div class="hidden md:flex items-center space-x-8"><a href=/path class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">学习路线</a><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化基础<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">回测平台</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化进阶<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">综合实战</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化高手<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股指期货</a></div></div></div><a href=/pricing class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">服务套餐</a></div><div class="hidden md:flex items-center space-x-4"><a href=/contact class="inline-flex items-center justify-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div><div class=md:hidden><label for=nav-toggle class="p-2 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-offset-2 transition-colors cursor-pointer"><svg class="w-6 h-6" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></label></div></nav></div><div class="nav-content md:hidden w-full fixed left-0 right-0 top-20 bg-white border-t border-gray-100 shadow-lg"><div class="w-full px-6 py-4"><a href=/path class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">学习路线</a><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化基础</div><div class=pl-4><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block text-gray-700 hover:text-primary-600 py-2">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block text-gray-700 hover:text-primary-600 py-2">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block text-gray-700 hover:text-primary-600 py-2">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block text-gray-700 hover:text-primary-600 py-2">回测平台</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化进阶</div><div class=pl-4><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block text-gray-700 hover:text-primary-600 py-2">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block text-gray-700 hover:text-primary-600 py-2">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block text-gray-700 hover:text-primary-600 py-2">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block text-gray-700 hover:text-primary-600 py-2">综合实战</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化高手</div><div class=pl-4><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block text-gray-700 hover:text-primary-600 py-2">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block text-gray-700 hover:text-primary-600 py-2">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block text-gray-700 hover:text-primary-600 py-2">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block text-gray-700 hover:text-primary-600 py-2">股指期货</a></div></div><a href=/pricing class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">服务套餐</a><div class="pt-4 space-y-4"><a href=/contact class="block text-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div></div></div></header><style>.mobile-menu-wrapper{position:relative}.nav-toggle{display:none}.nav-content{display:none}.nav-toggle:checked~header .nav-content{display:block}</style></div></div><div class=pt-20><div class="container mx-auto px-4 py-12"><div class="flex flex-col lg:flex-row gap-8 mb-12"><article class=flex-1><header class=mb-8><div class=mb-4><a href=/categories/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0 class="inline-block px-3 py-1 text-sm font-medium text-primary-600 bg-primary-50 rounded-full hover:bg-primary-100 mr-2">回测平台</a></div><h1 class="text-4xl font-bold mb-4">SuperMind第2讲：金融数据获取与API基础应用</h1><div class="flex flex-col space-y-4"><div class="flex items-center justify-between text-sm text-gray-500"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7A4 4 0 118 7a4 4 0 018 0zm-4 7a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
<span>Ryan</span></div><div class="flex items-center space-x-6"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747.0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746.0-3.332.477-4.5 1.253"/></svg>
<span>15 分钟</span></div><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5A2 2 0 003 7v12a2 2 0 002 2z"/></svg>
<time datetime=2025-09-22>September 22, 2025</time></div></div></div><div class="flex items-center flex-wrap gap-2"><a href=/tags/2025 class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors duration-200">#2025
</a><a href=/tags/supermind class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors duration-200">#SuperMind</a></div></div></header><div class=mb-8><img src=/images/blog/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0.jpg alt=SuperMind第2讲：金融数据获取与API基础应用 class="w-full h-auto rounded-lg" loading=lazy></div><div class="prose prose-lg max-w-none"><div class="bg-gray-50 p-6 rounded-lg mb-8"><h2 class="text-xl font-semibold mb-4">目录</h2><nav id=TableOfContents><ul><li><a href=#supermind数据体系量化策略的基石>SuperMind数据体系：量化策略的基石</a><ul><li><a href=#数据覆盖范围>数据覆盖范围</a></li><li><a href=#数据质量保障>数据质量保障</a></li></ul></li><li><a href=#基础取数函数详解>基础取数函数详解</a><ul><li><a href=#history函数历史数据获取的核心>history()函数：历史数据获取的核心</a></li><li><a href=#get_price函数灵活的价格数据获取>get_price()函数：灵活的价格数据获取</a></li><li><a href=#财务数据获取基本面分析的基础>财务数据获取：基本面分析的基础</a></li></ul></li><li><a href=#数据处理基础从原始数据到交易信号>数据处理基础：从原始数据到交易信号</a><ul><li><a href=#数据清洗与预处理>数据清洗与预处理</a></li><li><a href=#时间序列处理技巧>时间序列处理技巧</a></li></ul></li><li><a href=#数据质量检查与验证>数据质量检查与验证</a><ul><li><a href=#数据完整性检查>数据完整性检查</a></li></ul></li><li><a href=#总结与最佳实践>总结与最佳实践</a><ul><li><a href=#最佳实践建议>最佳实践建议</a></li></ul></li></ul></nav></div><h2 id=supermind数据体系量化策略的基石>SuperMind数据体系：量化策略的基石</h2><p>在量化交易中，数据质量直接决定了策略的上限。SuperMind平台凭借其强大的数据获取能力，为投资者提供了丰富而精准的金融数据服务。深入理解平台的数据体系，是构建成功量化策略的第一步。</p><h3 id=数据覆盖范围>数据覆盖范围</h3><p>SuperMind平台的数据覆盖堪称业内最全，具体体现在以下几个方面：</p><p><strong>时间维度完整</strong>：从2014年至今的完整历史数据，涵盖了近十年的市场变迁，为策略回测提供了充足的历史样本。</p><p><strong>品种覆盖广泛</strong>：包含股票、基金、期货、可转债、外汇等多个品种，满足不同投资策略的需求。</p><p><strong>频率层次丰富</strong>：从tick级别的超高频数据到日线、周线、月线的低频数据，适应各种交易频率的策略开发。</p><p><strong>数据类型多样</strong>：不仅包含基础的行情数据（开高低收量），还提供完整的财务数据、公司公告、宏观经济指标等基本面数据。</p><h3 id=数据质量保障>数据质量保障</h3><p>平台数据的可靠性体现在：</p><p><strong>实时更新机制</strong>：行情数据实时更新，财务数据在公告次日早晨完成更新，确保数据的时效性。</p><p><strong>未复权数据处理</strong>：提供原始未复权数据，避免了复权处理可能带来的价格失真，特别适合需要精确价格信号的策略。</p><p><strong>Level-2深度数据</strong>：基于完整的Level-2数据构建，包含更丰富的市场微观结构信息。</p><h2 id=基础取数函数详解>基础取数函数详解</h2><h3 id=history函数历史数据获取的核心>history()函数：历史数据获取的核心</h3><p><code>history()</code>函数是获取历史数据最常用的函数，其灵活的参数设置可以满足大部分数据获取需求。</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_stock_history</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取股票历史价格数据示例
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 获取平安银行最近20天的日线数据</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=s1>&#39;000001.SZ&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>],</span> <span class=mi>20</span><span class=p>,</span> <span class=s1>&#39;1d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;平安银行最近20天日线数据：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>数据形状:&#34;</span><span class=p>,</span> <span class=n>df</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>列名:&#34;</span><span class=p>,</span> <span class=n>df</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取多只股票的收盘价</span>
</span></span><span class=line><span class=cl>    <span class=n>stocks</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;000001.SZ&#39;</span><span class=p>,</span> <span class=s1>&#39;000002.SZ&#39;</span><span class=p>,</span> <span class=s1>&#39;600000.SH&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>df_multi</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=n>stocks</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>],</span> <span class=mi>30</span><span class=p>,</span> <span class=s1>&#39;1d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>stocks</span><span class=p>)</span><span class=si>}</span><span class=s2>只股票30天收盘价数据预览：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>df_multi</span><span class=o>.</span><span class=n>head</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>df</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_different_frequencies</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取不同频率的数据
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock</span> <span class=o>=</span> <span class=s1>&#39;000001.SZ&#39;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取分钟线数据（最近100根5分钟K线）</span>
</span></span><span class=line><span class=cl>    <span class=n>df_min</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>],</span> <span class=mi>100</span><span class=p>,</span> <span class=s1>&#39;5m&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;5分钟线数据（最近100根）：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;数据形状: </span><span class=si>{</span><span class=n>df_min</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;时间范围: </span><span class=si>{</span><span class=n>df_min</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> 到 </span><span class=si>{</span><span class=n>df_min</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取周线数据（最近26周）</span>
</span></span><span class=line><span class=cl>    <span class=n>df_week</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>],</span> <span class=mi>26</span><span class=p>,</span> <span class=s1>&#39;1w&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>周线数据（最近26周）：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;数据形状: </span><span class=si>{</span><span class=n>df_week</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>df_min</span><span class=p>,</span> <span class=n>df_week</span>
</span></span></code></pre></td></tr></table></div></div></div></div><p><strong>参数详解</strong>：</p><ul><li><strong>security</strong>：股票代码，支持单只股票或股票列表</li><li><strong>fields</strong>：需要获取的字段列表，如[&lsquo;open&rsquo;, &lsquo;high&rsquo;, &rsquo;low&rsquo;, &lsquo;close&rsquo;, &lsquo;volume&rsquo;]</li><li><strong>count</strong>：获取的历史数据条数</li><li><strong>unit</strong>：数据频率，支持'1d&rsquo;（日线）、&lsquo;1m&rsquo;（分钟线）、&lsquo;5m&rsquo;（5分钟线）、&lsquo;1w&rsquo;（周线）等</li></ul><h3 id=get_price函数灵活的价格数据获取>get_price()函数：灵活的价格数据获取</h3><p><code>get_price()</code>函数提供了更灵活的价格数据获取方式，特别适合需要精确时间范围的场景。</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_price_example</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    get_price函数使用示例
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock</span> <span class=o>=</span> <span class=s1>&#39;000001.SZ&#39;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取指定日期范围的数据</span>
</span></span><span class=line><span class=cl>    <span class=n>start_date</span> <span class=o>=</span> <span class=s1>&#39;2023-01-01&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>end_date</span> <span class=o>=</span> <span class=s1>&#39;2023-12-31&#39;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>df</span> <span class=o>=</span> <span class=n>get_price</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=n>start_date</span><span class=o>=</span><span class=n>start_date</span><span class=p>,</span> <span class=n>end_date</span><span class=o>=</span><span class=n>end_date</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                   <span class=n>frequency</span><span class=o>=</span><span class=s1>&#39;daily&#39;</span><span class=p>,</span> <span class=n>fields</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2> 2023年完整数据：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;数据条数: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>df</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;价格范围: </span><span class=si>{</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>min</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> - </span><span class=si>{</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>max</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;前5行数据：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取分钟级数据（注意：分钟数据只能获取最近一段时间的）</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>datetime</span>
</span></span><span class=line><span class=cl>    <span class=n>end_time</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>start_time</span> <span class=o>=</span> <span class=n>end_time</span> <span class=o>-</span> <span class=n>datetime</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>  <span class=c1># 最近5天</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>df_min</span> <span class=o>=</span> <span class=n>get_price</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=n>start_date</span><span class=o>=</span><span class=n>start_time</span><span class=p>,</span> <span class=n>end_date</span><span class=o>=</span><span class=n>end_time</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                       <span class=n>frequency</span><span class=o>=</span><span class=s1>&#39;minute&#39;</span><span class=p>,</span> <span class=n>fields</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>最近5天分钟数据：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;数据条数: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>df_min</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;时间范围: </span><span class=si>{</span><span class=n>df_min</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> 到 </span><span class=si>{</span><span class=n>df_min</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>df</span><span class=p>,</span> <span class=n>df_min</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_adjusted_price</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取复权价格数据
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock</span> <span class=o>=</span> <span class=s1>&#39;000001.SZ&#39;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取前复权价格</span>
</span></span><span class=line><span class=cl>    <span class=n>df_fq</span> <span class=o>=</span> <span class=n>get_price</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=n>start_date</span><span class=o>=</span><span class=s1>&#39;2023-01-01&#39;</span><span class=p>,</span> <span class=n>end_date</span><span class=o>=</span><span class=s1>&#39;2023-12-31&#39;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                      <span class=n>frequency</span><span class=o>=</span><span class=s1>&#39;daily&#39;</span><span class=p>,</span> <span class=n>fields</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>],</span> <span class=n>fq</span><span class=o>=</span><span class=s1>&#39;pre&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取后复权价格</span>
</span></span><span class=line><span class=cl>    <span class=n>df_bq</span> <span class=o>=</span> <span class=n>get_price</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=n>start_date</span><span class=o>=</span><span class=s1>&#39;2023-01-01&#39;</span><span class=p>,</span> <span class=n>end_date</span><span class=o>=</span><span class=s1>&#39;2023-12-31&#39;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                      <span class=n>frequency</span><span class=o>=</span><span class=s1>&#39;daily&#39;</span><span class=p>,</span> <span class=n>fields</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>],</span> <span class=n>fq</span><span class=o>=</span><span class=s1>&#39;post&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 对比不复权、前复权、后复权的价格差异</span>
</span></span><span class=line><span class=cl>    <span class=n>df_no_fq</span> <span class=o>=</span> <span class=n>get_price</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=n>start_date</span><span class=o>=</span><span class=s1>&#39;2023-01-01&#39;</span><span class=p>,</span> <span class=n>end_date</span><span class=o>=</span><span class=s1>&#39;2023-12-31&#39;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                         <span class=n>frequency</span><span class=o>=</span><span class=s1>&#39;daily&#39;</span><span class=p>,</span> <span class=n>fields</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>],</span> <span class=n>fq</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;不同复权方式的价格对比（2023年最后一个交易日）：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;不复权: </span><span class=si>{</span><span class=n>df_no_fq</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;前复权: </span><span class=si>{</span><span class=n>df_fq</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;后复权: </span><span class=si>{</span><span class=n>df_bq</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>df_fq</span><span class=p>,</span> <span class=n>df_bq</span><span class=p>,</span> <span class=n>df_no_fq</span>
</span></span></code></pre></td></tr></table></div></div></div></div><p><strong>关键参数</strong>：</p><ul><li><strong>fq</strong>：复权方式，&lsquo;pre&rsquo;（前复权）、&lsquo;post&rsquo;（后复权）、None（不复权）</li><li><strong>skip_paused</strong>：是否跳过停牌日期</li><li><strong>frequency</strong>：数据频率，支持&rsquo;daily&rsquo;、&lsquo;minute&rsquo;等</li></ul><h3 id=财务数据获取基本面分析的基础>财务数据获取：基本面分析的基础</h3><p>财务数据是基本面分析的核心，SuperMind提供了完整的财务数据获取接口。</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_fundamental_data</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取财务数据示例
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 获取单只股票的财务数据</span>
</span></span><span class=line><span class=cl>    <span class=n>stock</span> <span class=o>=</span> <span class=s1>&#39;000001.SZ&#39;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取估值指标</span>
</span></span><span class=line><span class=cl>    <span class=n>valuation_data</span> <span class=o>=</span> <span class=n>get_fundamentals</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=s1>&#39;valuation&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2> 估值数据：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;市盈率: </span><span class=si>{</span><span class=n>valuation_data</span><span class=p>[</span><span class=s1>&#39;pe_ratio&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;市净率: </span><span class=si>{</span><span class=n>valuation_data</span><span class=p>[</span><span class=s1>&#39;pb_ratio&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;市销率: </span><span class=si>{</span><span class=n>valuation_data</span><span class=p>[</span><span class=s1>&#39;ps_ratio&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;股息率: </span><span class=si>{</span><span class=n>valuation_data</span><span class=p>[</span><span class=s1>&#39;dividend_yield&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取财务指标</span>
</span></span><span class=line><span class=cl>    <span class=n>financial_data</span> <span class=o>=</span> <span class=n>get_fundamentals</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=s1>&#39;financial_indicator&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2> 财务指标：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;ROE: </span><span class=si>{</span><span class=n>financial_data</span><span class=p>[</span><span class=s1>&#39;roe&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;ROA: </span><span class=si>{</span><span class=n>financial_data</span><span class=p>[</span><span class=s1>&#39;roa&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;毛利率: </span><span class=si>{</span><span class=n>financial_data</span><span class=p>[</span><span class=s1>&#39;gross_profit_margin&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;净利率: </span><span class=si>{</span><span class=n>financial_data</span><span class=p>[</span><span class=s1>&#39;net_profit_margin&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取资产负债表数据</span>
</span></span><span class=line><span class=cl>    <span class=n>balance_data</span> <span class=o>=</span> <span class=n>get_fundamentals</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=s1>&#39;balance_sheet&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2> 资产负债数据：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;总资产: </span><span class=si>{</span><span class=n>balance_data</span><span class=p>[</span><span class=s1>&#39;total_assets&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;总负债: </span><span class=si>{</span><span class=n>balance_data</span><span class=p>[</span><span class=s1>&#39;total_liabilities&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;净资产: </span><span class=si>{</span><span class=n>balance_data</span><span class=p>[</span><span class=s1>&#39;total_equity&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>valuation_data</span><span class=p>,</span> <span class=n>financial_data</span><span class=p>,</span> <span class=n>balance_data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_multiple_stocks_fundamentals</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取多只股票的基本面数据并进行对比
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stocks</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;000001.SZ&#39;</span><span class=p>,</span> <span class=s1>&#39;000002.SZ&#39;</span><span class=p>,</span> <span class=s1>&#39;600000.SH&#39;</span><span class=p>,</span> <span class=s1>&#39;600036.SH&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取估值数据</span>
</span></span><span class=line><span class=cl>    <span class=n>df_valuation</span> <span class=o>=</span> <span class=n>get_fundamentals</span><span class=p>(</span><span class=n>stocks</span><span class=p>,</span> <span class=s1>&#39;valuation&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 筛选出PE、PB较低的股票</span>
</span></span><span class=line><span class=cl>    <span class=n>df_filtered</span> <span class=o>=</span> <span class=n>df_valuation</span><span class=p>[(</span><span class=n>df_valuation</span><span class=p>[</span><span class=s1>&#39;pe_ratio&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;</span> 
</span></span><span class=line><span class=cl>                               <span class=p>(</span><span class=n>df_valuation</span><span class=p>[</span><span class=s1>&#39;pe_ratio&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>20</span><span class=p>)</span> <span class=o>&amp;</span> 
</span></span><span class=line><span class=cl>                               <span class=p>(</span><span class=n>df_valuation</span><span class=p>[</span><span class=s1>&#39;pb_ratio&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;低估值股票筛选结果：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>df_filtered</span><span class=p>[[</span><span class=s1>&#39;pe_ratio&#39;</span><span class=p>,</span> <span class=s1>&#39;pb_ratio&#39;</span><span class=p>,</span> <span class=s1>&#39;dividend_yield&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=s1>&#39;pe_ratio&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取成长性指标</span>
</span></span><span class=line><span class=cl>    <span class=n>df_growth</span> <span class=o>=</span> <span class=n>get_fundamentals</span><span class=p>(</span><span class=n>stocks</span><span class=p>,</span> <span class=s1>&#39;growth_indicator&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 综合评分（价值+成长）</span>
</span></span><span class=line><span class=cl>    <span class=n>df_combined</span> <span class=o>=</span> <span class=n>df_valuation</span><span class=o>.</span><span class=n>merge</span><span class=p>(</span><span class=n>df_growth</span><span class=p>,</span> <span class=n>left_index</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>right_index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>df_combined</span><span class=p>[</span><span class=s1>&#39;score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>/</span> <span class=n>df_combined</span><span class=p>[</span><span class=s1>&#39;pe_ratio&#39;</span><span class=p>])</span> <span class=o>*</span> <span class=mf>0.4</span> <span class=o>+</span> \
</span></span><span class=line><span class=cl>                           <span class=n>df_combined</span><span class=p>[</span><span class=s1>&#39;net_profit_growth_rate&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.6</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>价值成长综合评分：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>df_combined</span><span class=p>[[</span><span class=s1>&#39;pe_ratio&#39;</span><span class=p>,</span> <span class=s1>&#39;net_profit_growth_rate&#39;</span><span class=p>,</span> <span class=s1>&#39;score&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=s1>&#39;score&#39;</span><span class=p>,</span> <span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>df_combined</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_sector_fundamentals</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取行业基本面数据
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 获取银行行业所有股票的财务数据</span>
</span></span><span class=line><span class=cl>    <span class=n>bank_stocks</span> <span class=o>=</span> <span class=n>get_industry_stocks</span><span class=p>(</span><span class=s1>&#39;BK0475&#39;</span><span class=p>)</span>  <span class=c1># 银行行业代码</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取关键财务指标</span>
</span></span><span class=line><span class=cl>    <span class=n>df_bank</span> <span class=o>=</span> <span class=n>get_fundamentals</span><span class=p>(</span><span class=n>bank_stocks</span><span class=p>,</span> <span class=s1>&#39;financial_indicator&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算行业平均值</span>
</span></span><span class=line><span class=cl>    <span class=n>industry_avg</span> <span class=o>=</span> <span class=n>df_bank</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;银行业财务指标平均值：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;ROE: </span><span class=si>{</span><span class=n>industry_avg</span><span class=p>[</span><span class=s1>&#39;roe&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;ROA: </span><span class=si>{</span><span class=n>industry_avg</span><span class=p>[</span><span class=s1>&#39;roa&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;不良贷款率: </span><span class=si>{</span><span class=n>industry_avg</span><span class=p>[</span><span class=s1>&#39;npl_ratio&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;拨备覆盖率: </span><span class=si>{</span><span class=n>industry_avg</span><span class=p>[</span><span class=s1>&#39;provision_coverage&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 找出行业内表现优秀的个股</span>
</span></span><span class=line><span class=cl>    <span class=n>top_banks</span> <span class=o>=</span> <span class=n>df_bank</span><span class=p>[</span><span class=n>df_bank</span><span class=p>[</span><span class=s1>&#39;roe&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>industry_avg</span><span class=p>[</span><span class=s1>&#39;roe&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=s1>&#39;roe&#39;</span><span class=p>,</span> <span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>ROE高于行业平均的银行：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>top_banks</span><span class=p>[[</span><span class=s1>&#39;roe&#39;</span><span class=p>,</span> <span class=s1>&#39;roa&#39;</span><span class=p>,</span> <span class=s1>&#39;npl_ratio&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>head</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>df_bank</span><span class=p>,</span> <span class=n>top_banks</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=数据处理基础从原始数据到交易信号>数据处理基础：从原始数据到交易信号</h2><p>获取数据只是第一步，如何有效处理这些数据才是策略成功的关键。</p><h3 id=数据清洗与预处理>数据清洗与预处理</h3><p>真实世界的金融数据往往存在缺失值、异常值等问题，需要仔细处理。</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>data_cleaning_example</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    数据清洗与预处理示例
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取股票数据</span>
</span></span><span class=line><span class=cl>    <span class=n>stock</span> <span class=o>=</span> <span class=s1>&#39;000001.SZ&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>],</span> <span class=mi>100</span><span class=p>,</span> <span class=s1>&#39;1d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;原始数据信息：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;数据形状: </span><span class=si>{</span><span class=n>df</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;缺失值统计:</span><span class=se>\n</span><span class=si>{</span><span class=n>df</span><span class=o>.</span><span class=n>isnull</span><span class=p>()</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 处理缺失值</span>
</span></span><span class=line><span class=cl>    <span class=n>df_clean</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 对于价格数据，使用前向填充</span>
</span></span><span class=line><span class=cl>    <span class=n>price_columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>df_clean</span><span class=p>[</span><span class=n>price_columns</span><span class=p>]</span> <span class=o>=</span> <span class=n>df_clean</span><span class=p>[</span><span class=n>price_columns</span><span class=p>]</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=n>method</span><span class=o>=</span><span class=s1>&#39;ffill&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 对于成交量，使用0填充（停牌日无成交）</span>
</span></span><span class=line><span class=cl>    <span class=n>df_clean</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df_clean</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 处理异常值（如涨跌幅超过±20%）</span>
</span></span><span class=line><span class=cl>    <span class=n>df_clean</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df_clean</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>abnormal_returns</span> <span class=o>=</span> <span class=n>df_clean</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>abs</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mf>0.2</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>发现</span><span class=si>{</span><span class=n>abnormal_returns</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>}</span><span class=s2>个异常收益率数据点&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 可以选择删除异常值或用中位数替换</span>
</span></span><span class=line><span class=cl>    <span class=n>df_clean</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>abnormal_returns</span><span class=p>,</span> <span class=s1>&#39;returns&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span>
</span></span><span class=line><span class=cl>    <span class=n>df_clean</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df_clean</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=n>df_clean</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>median</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 添加技术指标</span>
</span></span><span class=line><span class=cl>    <span class=n>df_clean</span><span class=p>[</span><span class=s1>&#39;ma5&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df_clean</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>df_clean</span><span class=p>[</span><span class=s1>&#39;ma20&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df_clean</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>df_clean</span><span class=p>[</span><span class=s1>&#39;volatility&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df_clean</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>清洗后的数据预览：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>df_clean</span><span class=o>.</span><span class=n>tail</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>df_clean</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_stock_splits</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    处理股票拆分和分红
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock</span> <span class=o>=</span> <span class=s1>&#39;000001.SZ&#39;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取不复权价格（用于实际交易）</span>
</span></span><span class=line><span class=cl>    <span class=n>df_unadj</span> <span class=o>=</span> <span class=n>get_price</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=n>start_date</span><span class=o>=</span><span class=s1>&#39;2023-01-01&#39;</span><span class=p>,</span> <span class=n>end_date</span><span class=o>=</span><span class=s1>&#39;2023-12-31&#39;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                         <span class=n>frequency</span><span class=o>=</span><span class=s1>&#39;daily&#39;</span><span class=p>,</span> <span class=n>fields</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>],</span> <span class=n>fq</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取后复权价格（用于计算收益率）</span>
</span></span><span class=line><span class=cl>    <span class=n>df_adj</span> <span class=o>=</span> <span class=n>get_price</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=n>start_date</span><span class=o>=</span><span class=s1>&#39;2023-01-01&#39;</span><span class=p>,</span> <span class=n>end_date</span><span class=o>=</span><span class=s1>&#39;2023-12-31&#39;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                       <span class=n>frequency</span><span class=o>=</span><span class=s1>&#39;daily&#39;</span><span class=p>,</span> <span class=n>fields</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>],</span> <span class=n>fq</span><span class=o>=</span><span class=s1>&#39;post&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 检测是否有拆分事件（价格突然大幅变化）</span>
</span></span><span class=line><span class=cl>    <span class=n>df_unadj</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df_unadj</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>df_adj</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df_adj</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 找出不复权价格异常变动但复权价格正常的日子</span>
</span></span><span class=line><span class=cl>    <span class=n>large_gap</span> <span class=o>=</span> <span class=n>df_unadj</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>abs</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mf>0.1</span>  <span class=c1># 单日变动超过10%</span>
</span></span><span class=line><span class=cl>    <span class=n>normal_adj</span> <span class=o>=</span> <span class=n>df_adj</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>abs</span><span class=p>()</span> <span class=o>&lt;</span> <span class=mf>0.02</span>  <span class=c1># 复权价格变动小于2%</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>split_days</span> <span class=o>=</span> <span class=n>large_gap</span> <span class=o>&amp;</span> <span class=n>normal_adj</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;检测到</span><span class=si>{</span><span class=n>split_days</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>}</span><span class=s2>个可能的股票拆分事件&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>split_days</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;拆分事件详情：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>date</span> <span class=ow>in</span> <span class=n>split_days</span><span class=p>[</span><span class=n>split_days</span><span class=p>]</span><span class=o>.</span><span class=n>index</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>unadj_return</span> <span class=o>=</span> <span class=n>df_unadj</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>date</span><span class=p>,</span> <span class=s1>&#39;returns&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>adj_return</span> <span class=o>=</span> <span class=n>df_adj</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>date</span><span class=p>,</span> <span class=s1>&#39;returns&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;日期: </span><span class=si>{</span><span class=n>date</span><span class=si>}</span><span class=s2>, 不复权收益率: </span><span class=si>{</span><span class=n>unadj_return</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>, 复权收益率: </span><span class=si>{</span><span class=n>adj_return</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>df_unadj</span><span class=p>,</span> <span class=n>df_adj</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_technical_indicators</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    创建技术指标数据
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock</span> <span class=o>=</span> <span class=s1>&#39;000001.SZ&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>],</span> <span class=mi>60</span><span class=p>,</span> <span class=s1>&#39;1d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 移动平均线</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;ma5&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;ma10&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;ma20&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># MACD指标</span>
</span></span><span class=line><span class=cl>    <span class=n>exp1</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>ewm</span><span class=p>(</span><span class=n>span</span><span class=o>=</span><span class=mi>12</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>exp2</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>ewm</span><span class=p>(</span><span class=n>span</span><span class=o>=</span><span class=mi>26</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>macd</span> <span class=o>=</span> <span class=n>exp1</span> <span class=o>-</span> <span class=n>exp2</span>
</span></span><span class=line><span class=cl>    <span class=n>signal</span> <span class=o>=</span> <span class=n>macd</span><span class=o>.</span><span class=n>ewm</span><span class=p>(</span><span class=n>span</span><span class=o>=</span><span class=mi>9</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>histogram</span> <span class=o>=</span> <span class=n>macd</span> <span class=o>-</span> <span class=n>signal</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;macd&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>macd</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;macd_signal&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>signal</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;macd_histogram&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>histogram</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># RSI指标</span>
</span></span><span class=line><span class=cl>    <span class=n>delta</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>diff</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gain</span> <span class=o>=</span> <span class=p>(</span><span class=n>delta</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>delta</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=mi>14</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>loss</span> <span class=o>=</span> <span class=p>(</span><span class=o>-</span><span class=n>delta</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>delta</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=mi>14</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>rs</span> <span class=o>=</span> <span class=n>gain</span> <span class=o>/</span> <span class=n>loss</span>
</span></span><span class=line><span class=cl>    <span class=n>rsi</span> <span class=o>=</span> <span class=mi>100</span> <span class=o>-</span> <span class=p>(</span><span class=mi>100</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>rs</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;rsi&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>rsi</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 布林带</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;bb_middle&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>bb_std</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;bb_upper&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;bb_middle&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=p>(</span><span class=n>bb_std</span> <span class=o>*</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;bb_lower&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;bb_middle&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=p>(</span><span class=n>bb_std</span> <span class=o>*</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 成交量指标</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;volume_ma&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;volume_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;volume_ma&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;技术指标数据预览：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>df</span><span class=p>[[</span><span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;ma5&#39;</span><span class=p>,</span> <span class=s1>&#39;ma20&#39;</span><span class=p>,</span> <span class=s1>&#39;rsi&#39;</span><span class=p>,</span> <span class=s1>&#39;macd&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>tail</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>df</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_features_for_ml</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    为机器学习创建特征数据
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock</span> <span class=o>=</span> <span class=s1>&#39;000001.SZ&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>],</span> <span class=mi>200</span><span class=p>,</span> <span class=s1>&#39;1d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 价格特征</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;price_change&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;price_range&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;high&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;low&#39;</span><span class=p>])</span> <span class=o>/</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;price_position&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;low&#39;</span><span class=p>])</span> <span class=o>/</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;high&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;low&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 时间特征</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;day_of_week&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>dayofweek</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;month&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>month</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;quarter&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>quarter</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 滞后特征</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>lag</span> <span class=ow>in</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>10</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;price_lag_</span><span class=si>{</span><span class=n>lag</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;price_change&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>lag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 滚动统计特征</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>window</span> <span class=ow>in</span> <span class=p>[</span><span class=mi>5</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;price_mean_</span><span class=si>{</span><span class=n>window</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;price_change&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;price_std_</span><span class=si>{</span><span class=n>window</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;price_change&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;price_skew_</span><span class=si>{</span><span class=n>window</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;price_change&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>skew</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;price_kurt_</span><span class=si>{</span><span class=n>window</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;price_change&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>kurt</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 技术指标特征</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;ma_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>/</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;volume_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 目标变量（未来5日收益率）</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;target&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=o>-</span><span class=mi>5</span><span class=p>)</span> <span class=o>/</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 删除包含缺失值的行</span>
</span></span><span class=line><span class=cl>    <span class=n>df_clean</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;原始数据形状: </span><span class=si>{</span><span class=n>df</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;清洗后数据形状: </span><span class=si>{</span><span class=n>df_clean</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;特征数量: </span><span class=si>{</span><span class=nb>len</span><span class=p>([</span><span class=n>col</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>df_clean</span><span class=o>.</span><span class=n>columns</span> <span class=k>if</span> <span class=n>col</span> <span class=o>!=</span> <span class=s1>&#39;target&#39;</span><span class=p>])</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 显示特征相关性</span>
</span></span><span class=line><span class=cl>    <span class=n>feature_cols</span> <span class=o>=</span> <span class=p>[</span><span class=n>col</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>df_clean</span><span class=o>.</span><span class=n>columns</span> <span class=k>if</span> <span class=n>col</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>,</span> <span class=s1>&#39;target&#39;</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=n>correlation_with_target</span> <span class=o>=</span> <span class=n>df_clean</span><span class=p>[</span><span class=n>feature_cols</span> <span class=o>+</span> <span class=p>[</span><span class=s1>&#39;target&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>corr</span><span class=p>()[</span><span class=s1>&#39;target&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>abs</span><span class=p>()</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>与目标变量相关性最高的10个特征：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>correlation_with_target</span><span class=o>.</span><span class=n>head</span><span class=p>(</span><span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>df_clean</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=时间序列处理技巧>时间序列处理技巧</h3><p>金融时间序列有其特殊性，需要特殊的处理方法。</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>time_series_analysis</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    时间序列分析示例
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock</span> <span class=o>=</span> <span class=s1>&#39;000001.SZ&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>],</span> <span class=mi>100</span><span class=p>,</span> <span class=s1>&#39;1d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算对数收益率（更适合时间序列分析）</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;log_return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 检查平稳性</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>statsmodels.tsa.stattools</span> <span class=kn>import</span> <span class=n>adfuller</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># ADF检验</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>adfuller</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;log_return&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>dropna</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;ADF检验结果：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;ADF统计量: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;p值: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;临界值: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>result</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;序列是平稳的&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;序列是非平稳的&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算滚动相关性</span>
</span></span><span class=line><span class=cl>    <span class=n>benchmark</span> <span class=o>=</span> <span class=s1>&#39;000300.SH&#39;</span>  <span class=c1># 沪深300指数</span>
</span></span><span class=line><span class=cl>    <span class=n>df_bench</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=n>benchmark</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>],</span> <span class=mi>100</span><span class=p>,</span> <span class=s1>&#39;1d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>df_bench</span><span class=p>[</span><span class=s1>&#39;log_return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>df_bench</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=n>df_bench</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 对齐数据</span>
</span></span><span class=line><span class=cl>    <span class=n>df_aligned</span> <span class=o>=</span> <span class=n>df</span><span class=p>[[</span><span class=s1>&#39;log_return&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>df_bench</span><span class=p>[[</span><span class=s1>&#39;log_return&#39;</span><span class=p>]],</span> <span class=n>rsuffix</span><span class=o>=</span><span class=s1>&#39;_bench&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算滚动beta（20天窗口）</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>rolling_beta</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>window</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>x</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>cov</span><span class=p>(</span><span class=n>y</span><span class=p>)</span> <span class=o>/</span> <span class=n>y</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>var</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>df_aligned</span><span class=p>[</span><span class=s1>&#39;beta&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>rolling_beta</span><span class=p>(</span><span class=n>df_aligned</span><span class=p>[</span><span class=s1>&#39;log_return&#39;</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                                      <span class=n>df_aligned</span><span class=p>[</span><span class=s1>&#39;log_return_bench&#39;</span><span class=p>],</span> <span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算滚动alpha</span>
</span></span><span class=line><span class=cl>    <span class=n>df_aligned</span><span class=p>[</span><span class=s1>&#39;alpha&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df_aligned</span><span class=p>[</span><span class=s1>&#39;log_return&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>df_aligned</span><span class=p>[</span><span class=s1>&#39;beta&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=n>df_aligned</span><span class=p>[</span><span class=s1>&#39;log_return_bench&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>最近Beta值: </span><span class=si>{</span><span class=n>df_aligned</span><span class=p>[</span><span class=s1>&#39;beta&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最近Alpha值: </span><span class=si>{</span><span class=n>df_aligned</span><span class=p>[</span><span class=s1>&#39;alpha&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>df_aligned</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>detect_outliers</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    异常值检测
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock</span> <span class=o>=</span> <span class=s1>&#39;000001.SZ&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>],</span> <span class=mi>200</span><span class=p>,</span> <span class=s1>&#39;1d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 方法1：标准差法</span>
</span></span><span class=line><span class=cl>    <span class=n>mean_return</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;return&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>std_return</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;return&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 定义异常值（超过3个标准差）</span>
</span></span><span class=line><span class=cl>    <span class=n>outliers_std</span> <span class=o>=</span> <span class=n>df</span><span class=p>[(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;return&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>mean_return</span><span class=p>)</span><span class=o>.</span><span class=n>abs</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>3</span> <span class=o>*</span> <span class=n>std_return</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;标准差法检测到</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>outliers_std</span><span class=p>)</span><span class=si>}</span><span class=s2>个异常值&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 方法2：IQR法（四分位距）</span>
</span></span><span class=line><span class=cl>    <span class=n>Q1</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;return&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>quantile</span><span class=p>(</span><span class=mf>0.25</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Q3</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;return&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>quantile</span><span class=p>(</span><span class=mf>0.75</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>IQR</span> <span class=o>=</span> <span class=n>Q3</span> <span class=o>-</span> <span class=n>Q1</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>lower_bound</span> <span class=o>=</span> <span class=n>Q1</span> <span class=o>-</span> <span class=mf>1.5</span> <span class=o>*</span> <span class=n>IQR</span>
</span></span><span class=line><span class=cl>    <span class=n>upper_bound</span> <span class=o>=</span> <span class=n>Q3</span> <span class=o>+</span> <span class=mf>1.5</span> <span class=o>*</span> <span class=n>IQR</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>outliers_iqr</span> <span class=o>=</span> <span class=n>df</span><span class=p>[(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;return&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>lower_bound</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;return&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>upper_bound</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;IQR法检测到</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>outliers_iqr</span><span class=p>)</span><span class=si>}</span><span class=s2>个异常值&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 方法3：基于密度的DBSCAN（需要scikit-learn）</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>sklearn.cluster</span> <span class=kn>import</span> <span class=n>DBSCAN</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 准备数据</span>
</span></span><span class=line><span class=cl>        <span class=n>returns</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;return&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span><span class=o>.</span><span class=n>values</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># DBSCAN聚类</span>
</span></span><span class=line><span class=cl>        <span class=n>dbscan</span> <span class=o>=</span> <span class=n>DBSCAN</span><span class=p>(</span><span class=n>eps</span><span class=o>=</span><span class=mf>0.02</span><span class=p>,</span> <span class=n>min_samples</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>clusters</span> <span class=o>=</span> <span class=n>dbscan</span><span class=o>.</span><span class=n>fit_predict</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 异常值被标记为-1</span>
</span></span><span class=line><span class=cl>        <span class=n>outliers_dbscan</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>clusters</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;DBSCAN法检测到</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>outliers_dbscan</span><span class=p>)</span><span class=si>}</span><span class=s2>个异常值&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>ImportError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;scikit-learn未安装，跳过DBSCAN方法&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 显示异常值详情</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>outliers_std</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>标准差法检测到的异常值：&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>outliers_std</span><span class=p>[[</span><span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;return&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>head</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>outliers_std</span><span class=p>,</span> <span class=n>outliers_iqr</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_lagged_features</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    创建滞后特征（用于预测模型）
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock</span> <span class=o>=</span> <span class=s1>&#39;000001.SZ&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>],</span> <span class=mi>50</span><span class=p>,</span> <span class=s1>&#39;1d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算收益率</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;log_return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 创建不同滞后期的特征</span>
</span></span><span class=line><span class=cl>    <span class=n>lags</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>lag</span> <span class=ow>in</span> <span class=n>lags</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 价格滞后特征</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;price_lag_</span><span class=si>{</span><span class=n>lag</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>lag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;return_lag_</span><span class=si>{</span><span class=n>lag</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;return&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>lag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 成交量滞后特征</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;volume_lag_</span><span class=si>{</span><span class=n>lag</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>lag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 移动平均滞后特征</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;ma_lag_</span><span class=si>{</span><span class=n>lag</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>lag</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 创建收益率的滚动统计特征</span>
</span></span><span class=line><span class=cl>    <span class=n>windows</span> <span class=o>=</span> <span class=p>[</span><span class=mi>5</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>window</span> <span class=ow>in</span> <span class=n>windows</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;return_mean_</span><span class=si>{</span><span class=n>window</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;return&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;return_std_</span><span class=si>{</span><span class=n>window</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;return&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>std</span><span class=p>()</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;return_skew_</span><span class=si>{</span><span class=n>window</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;return&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>skew</span><span class=p>()</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;return_kurt_</span><span class=si>{</span><span class=n>window</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;return&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=p>)</span><span class=o>.</span><span class=n>kurt</span><span class=p>()</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 创建技术指标滞后特征</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=p>[</span><span class=s1>&#39;rsi&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>calculate_rsi</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>lag</span> <span class=ow>in</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;rsi_lag_</span><span class=si>{</span><span class=n>lag</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;rsi&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>lag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 删除包含NaN的行</span>
</span></span><span class=line><span class=cl>    <span class=n>df_clean</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;原始数据形状: </span><span class=si>{</span><span class=n>df</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;特征工程后形状: </span><span class=si>{</span><span class=n>df_clean</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;特征数量: </span><span class=si>{</span><span class=nb>len</span><span class=p>([</span><span class=n>col</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>df_clean</span><span class=o>.</span><span class=n>columns</span> <span class=k>if</span> <span class=n>col</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>]])</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 显示特征相关性矩阵</span>
</span></span><span class=line><span class=cl>    <span class=n>feature_cols</span> <span class=o>=</span> <span class=p>[</span><span class=n>col</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>df_clean</span><span class=o>.</span><span class=n>columns</span> <span class=k>if</span> <span class=n>col</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=n>correlation_matrix</span> <span class=o>=</span> <span class=n>df_clean</span><span class=p>[</span><span class=n>feature_cols</span><span class=p>]</span><span class=o>.</span><span class=n>corr</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 找出高度相关的特征对</span>
</span></span><span class=line><span class=cl>    <span class=n>high_corr_pairs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>correlation_matrix</span><span class=o>.</span><span class=n>columns</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>correlation_matrix</span><span class=o>.</span><span class=n>columns</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>corr_value</span> <span class=o>=</span> <span class=n>correlation_matrix</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=n>corr_value</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mf>0.8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>high_corr_pairs</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>correlation_matrix</span><span class=o>.</span><span class=n>columns</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                                      <span class=n>correlation_matrix</span><span class=o>.</span><span class=n>columns</span><span class=p>[</span><span class=n>j</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                                      <span class=n>corr_value</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>高度相关的特征对（|相关系数| &gt; 0.8）: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>high_corr_pairs</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>pair</span> <span class=ow>in</span> <span class=n>high_corr_pairs</span><span class=p>[:</span><span class=mi>5</span><span class=p>]:</span>  <span class=c1># 只显示前5个</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>pair</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> vs </span><span class=si>{</span><span class=n>pair</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>pair</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>df_clean</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_rsi</span><span class=p>(</span><span class=n>prices</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=mi>14</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算RSI指标
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>delta</span> <span class=o>=</span> <span class=n>prices</span><span class=o>.</span><span class=n>diff</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gain</span> <span class=o>=</span> <span class=n>delta</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>delta</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>loss</span> <span class=o>=</span> <span class=o>-</span><span class=n>delta</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>delta</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>avg_gain</span> <span class=o>=</span> <span class=n>gain</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=n>period</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>avg_loss</span> <span class=o>=</span> <span class=n>loss</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=n>window</span><span class=o>=</span><span class=n>period</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>rs</span> <span class=o>=</span> <span class=n>avg_gain</span> <span class=o>/</span> <span class=n>avg_loss</span>
</span></span><span class=line><span class=cl>    <span class=n>rsi</span> <span class=o>=</span> <span class=mi>100</span> <span class=o>-</span> <span class=p>(</span><span class=mi>100</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>rs</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>rsi</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=数据质量检查与验证>数据质量检查与验证</h2><p>确保数据质量是策略成功的基础，建立系统的数据检查机制至关重要。</p><h3 id=数据完整性检查>数据完整性检查</h3><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>data_quality_check</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    数据质量检查函数
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock</span> <span class=o>=</span> <span class=s1>&#39;000001.SZ&#39;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取数据</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>],</span> <span class=mi>200</span><span class=p>,</span> <span class=s1>&#39;1d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 数据质量检查报告 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;股票代码: </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;数据时间范围: </span><span class=si>{</span><span class=n>df</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> 到 </span><span class=si>{</span><span class=n>df</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;数据条数: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>df</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 1. 缺失值检查</span>
</span></span><span class=line><span class=cl>    <span class=n>missing_values</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>isnull</span><span class=p>()</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>1. 缺失值检查:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>missing_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 2. 逻辑一致性检查</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>2. 逻辑一致性检查:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 检查最高价是否大于等于收盘价</span>
</span></span><span class=line><span class=cl>    <span class=n>high_vs_close</span> <span class=o>=</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;high&#39;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>])</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   最高价 &gt;= 收盘价: </span><span class=si>{</span><span class=n>high_vs_close</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 检查最低价是否小于等于收盘价</span>
</span></span><span class=line><span class=cl>    <span class=n>low_vs_close</span> <span class=o>=</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;low&#39;</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>])</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   最低价 &lt;= 收盘价: </span><span class=si>{</span><span class=n>low_vs_close</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 检查开盘价是否在最高价和最低价之间</span>
</span></span><span class=line><span class=cl>    <span class=n>open_in_range</span> <span class=o>=</span> <span class=p>((</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;low&#39;</span><span class=p>])</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;high&#39;</span><span class=p>]))</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   开盘价在高低价范围内: </span><span class=si>{</span><span class=n>open_in_range</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 3. 异常值检查</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>3. 异常值检查:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 价格异常（价格&lt;=0）</span>
</span></span><span class=line><span class=cl>    <span class=n>price_abnormal</span> <span class=o>=</span> <span class=p>(</span><span class=n>df</span><span class=p>[[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>]]</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   价格&lt;=0的数据点: </span><span class=si>{</span><span class=n>price_abnormal</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 涨跌幅异常（超过±20%）</span>
</span></span><span class=line><span class=cl>    <span class=n>returns</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>extreme_returns</span> <span class=o>=</span> <span class=p>(</span><span class=n>returns</span><span class=o>.</span><span class=n>abs</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mf>0.2</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   单日涨跌幅超过±20%: </span><span class=si>{</span><span class=n>extreme_returns</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 成交量异常（成交量=0或异常大）</span>
</span></span><span class=line><span class=cl>    <span class=n>zero_volume</span> <span class=o>=</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>large_volume</span> <span class=o>=</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>quantile</span><span class=p>(</span><span class=mf>0.99</span><span class=p>))</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   成交量为0: </span><span class=si>{</span><span class=n>zero_volume</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   成交量异常大(&gt;99分位数): </span><span class=si>{</span><span class=n>large_volume</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 4. 数据连续性检查</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>4. 数据连续性检查:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 检查日期是否连续</span>
</span></span><span class=line><span class=cl>    <span class=n>expected_days</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>bdate_range</span><span class=p>(</span><span class=n>df</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>df</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>missing_days</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>expected_days</span><span class=p>)</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   缺失交易日: </span><span class=si>{</span><span class=n>missing_days</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 检查是否有长时间停牌（超过10个交易日）</span>
</span></span><span class=line><span class=cl>    <span class=n>volume_zero_periods</span> <span class=o>=</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>consecutive_zeros</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>current_streak</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>is_zero</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>volume_zero_periods</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>is_zero</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>current_streak</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_streak</span> <span class=o>&gt;</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>start_date</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=n>current_streak</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>end_date</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>consecutive_zeros</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>start_date</span><span class=p>,</span> <span class=n>end_date</span><span class=p>,</span> <span class=n>current_streak</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>current_streak</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   长时间停牌(&gt;10天)次数: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>consecutive_zeros</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>consecutive_zeros</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;   长时间停牌详情:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>start</span><span class=p>,</span> <span class=n>end</span><span class=p>,</span> <span class=n>days</span> <span class=ow>in</span> <span class=n>consecutive_zeros</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;     </span><span class=si>{</span><span class=n>start</span><span class=si>}</span><span class=s2> 到 </span><span class=si>{</span><span class=n>end</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>days</span><span class=si>}</span><span class=s2>天&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 5. 统计摘要</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>5. 数据统计摘要:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;价格数据统计:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>df</span><span class=p>[[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>describe</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>成交量数据统计:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>describe</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>df</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>compare_data_sources</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    比较不同数据源的数据
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock</span> <span class=o>=</span> <span class=s1>&#39;000001.SZ&#39;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取不同频率的数据</span>
</span></span><span class=line><span class=cl>    <span class=n>df_daily</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>],</span> <span class=mi>20</span><span class=p>,</span> <span class=s1>&#39;1d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>df_weekly</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>],</span> <span class=mi>4</span><span class=p>,</span> <span class=s1>&#39;1w&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>df_monthly</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>],</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;1M&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 不同频率数据对比 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;日线数据: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>df_daily</span><span class=p>)</span><span class=si>}</span><span class=s2>条&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;周线数据: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>df_weekly</span><span class=p>)</span><span class=si>}</span><span class=s2>条&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;月线数据: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>df_monthly</span><span class=p>)</span><span class=si>}</span><span class=s2>条&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 检查数据一致性（用周线数据验证）</span>
</span></span><span class=line><span class=cl>    <span class=c1># 从日线数据合成周线数据</span>
</span></span><span class=line><span class=cl>    <span class=n>df_daily_resampled</span> <span class=o>=</span> <span class=n>df_daily</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>resample</span><span class=p>(</span><span class=s1>&#39;W&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>last</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>周线数据一致性检查:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;原始周线数据:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>df_weekly</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>从日线合成的周线数据:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>df_daily_resampled</span><span class=p>[</span><span class=o>-</span><span class=mi>4</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算差异</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>df_weekly</span><span class=p>)</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>df_daily_resampled</span><span class=p>[</span><span class=o>-</span><span class=mi>4</span><span class=p>:]):</span>
</span></span><span class=line><span class=cl>        <span class=n>diff</span> <span class=o>=</span> <span class=n>df_weekly</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>df_daily_resampled</span><span class=p>[</span><span class=o>-</span><span class=mi>4</span><span class=p>:]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>差异:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>diff</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最大差异: </span><span class=si>{</span><span class=n>diff</span><span class=o>.</span><span class=n>abs</span><span class=p>()</span><span class=o>.</span><span class=n>max</span><span class=p>()</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>df_daily</span><span class=p>,</span> <span class=n>df_weekly</span><span class=p>,</span> <span class=n>df_monthly</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 综合数据质量评估函数</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>comprehensive_data_check</span><span class=p>(</span><span class=n>stock_list</span><span class=p>,</span> <span class=n>days</span><span class=o>=</span><span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    对多只股票进行综合数据质量评估
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>quality_report</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>stock_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=s1>&#39;=&#39;</span><span class=o>*</span><span class=mi>50</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;正在检查 </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2> 的数据质量...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 获取数据</span>
</span></span><span class=line><span class=cl>            <span class=n>df</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>],</span> <span class=n>days</span><span class=p>,</span> <span class=s1>&#39;1d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 质量检查</span>
</span></span><span class=line><span class=cl>            <span class=n>quality_score</span> <span class=o>=</span> <span class=mi>100</span>  <span class=c1># 初始满分</span>
</span></span><span class=line><span class=cl>            <span class=n>issues</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 检查缺失值</span>
</span></span><span class=line><span class=cl>            <span class=n>missing_pct</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>isnull</span><span class=p>()</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span> <span class=o>/</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>df</span><span class=p>)</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>df</span><span class=o>.</span><span class=n>columns</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>missing_pct</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>quality_score</span> <span class=o>-=</span> <span class=n>missing_pct</span> <span class=o>*</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl>                <span class=n>issues</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;缺失值比例: </span><span class=si>{</span><span class=n>missing_pct</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 检查逻辑一致性</span>
</span></span><span class=line><span class=cl>            <span class=n>logic_issues</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;high&#39;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>])</span><span class=o>.</span><span class=n>all</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=n>logic_issues</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;low&#39;</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>])</span><span class=o>.</span><span class=n>all</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=n>logic_issues</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=p>((</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;low&#39;</span><span class=p>])</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;high&#39;</span><span class=p>]))</span><span class=o>.</span><span class=n>all</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=n>logic_issues</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>quality_score</span> <span class=o>-=</span> <span class=n>logic_issues</span> <span class=o>*</span> <span class=mi>15</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>logic_issues</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>issues</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;逻辑不一致问题: </span><span class=si>{</span><span class=n>logic_issues</span><span class=si>}</span><span class=s2>个&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 检查异常值</span>
</span></span><span class=line><span class=cl>            <span class=n>returns</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>extreme_pct</span> <span class=o>=</span> <span class=p>(</span><span class=n>returns</span><span class=o>.</span><span class=n>abs</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mf>0.1</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>extreme_pct</span> <span class=o>&gt;</span> <span class=mf>0.05</span><span class=p>:</span>  <span class=c1># 超过5%的异常收益率</span>
</span></span><span class=line><span class=cl>                <span class=n>quality_score</span> <span class=o>-=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>                <span class=n>issues</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;异常收益率比例: </span><span class=si>{</span><span class=n>extreme_pct</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 检查成交量异常</span>
</span></span><span class=line><span class=cl>            <span class=n>zero_vol_pct</span> <span class=o>=</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;volume&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>zero_vol_pct</span> <span class=o>&gt;</span> <span class=mf>0.1</span><span class=p>:</span>  <span class=c1># 超过10%的零成交量</span>
</span></span><span class=line><span class=cl>                <span class=n>quality_score</span> <span class=o>-=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>                <span class=n>issues</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;零成交量比例: </span><span class=si>{</span><span class=n>zero_vol_pct</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>quality_report</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;score&#39;</span><span class=p>:</span> <span class=nb>max</span><span class=p>(</span><span class=n>quality_score</span><span class=p>,</span> <span class=mi>0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;issues&#39;</span><span class=p>:</span> <span class=n>issues</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;data_points&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>df</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;date_range&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>df</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> 到 </span><span class=si>{</span><span class=n>df</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;质量评分: </span><span class=si>{</span><span class=n>quality_score</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>/100&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>issues</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;发现的问题:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>issue</span> <span class=ow>in</span> <span class=n>issues</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  - </span><span class=si>{</span><span class=n>issue</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;数据质量良好！&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;数据获取失败: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>quality_report</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;score&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;issues&#39;</span><span class=p>:</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&#34;数据获取失败: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;data_points&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;date_range&#39;</span><span class=p>:</span> <span class=s2>&#34;N/A&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 生成总结报告</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=s1>&#39;=&#39;</span><span class=o>*</span><span class=mi>60</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;数据质量评估总结报告&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=s1>&#39;=&#39;</span><span class=o>*</span><span class=mi>60</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>scores</span> <span class=o>=</span> <span class=p>[</span><span class=n>report</span><span class=p>[</span><span class=s1>&#39;score&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>report</span> <span class=ow>in</span> <span class=n>quality_report</span><span class=o>.</span><span class=n>values</span><span class=p>()]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;平均质量评分: </span><span class=si>{</span><span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>scores</span><span class=p>)</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>/100&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最低评分: </span><span class=si>{</span><span class=nb>min</span><span class=p>(</span><span class=n>scores</span><span class=p>)</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>/100&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最高评分: </span><span class=si>{</span><span class=nb>max</span><span class=p>(</span><span class=n>scores</span><span class=p>)</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>/100&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 按评分排序</span>
</span></span><span class=line><span class=cl>    <span class=n>sorted_stocks</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>quality_report</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=s1>&#39;score&#39;</span><span class=p>],</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>股票数据质量排名:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=n>report</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>sorted_stocks</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>i</span><span class=si>:</span><span class=s2>2d</span><span class=si>}</span><span class=s2>. </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>report</span><span class=p>[</span><span class=s1>&#39;score&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>5.1f</span><span class=si>}</span><span class=s2>/100&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>quality_report</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 单只股票数据质量检查</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;单只股票数据质量检查:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data_quality_check</span><span class=p>(</span><span class=s1>&#39;000001.SZ&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 多只股票综合评估</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>多只股票综合评估:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>stock_list</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;000001.SZ&#39;</span><span class=p>,</span> <span class=s1>&#39;000002.SZ&#39;</span><span class=p>,</span> <span class=s1>&#39;600000.SH&#39;</span><span class=p>,</span> <span class=s1>&#39;600036.SH&#39;</span><span class=p>,</span> <span class=s1>&#39;000858.SZ&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>comprehensive_data_check</span><span class=p>(</span><span class=n>stock_list</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=总结与最佳实践>总结与最佳实践</h2><p>通过本篇的学习，你已经掌握了SuperMind平台数据获取的核心技能：</p><p>✅ <strong>数据体系理解</strong>：了解了SuperMind完整的数据覆盖范围和高质量数据保障机制</p><p>✅ <strong>基础API掌握</strong>：熟练掌握了history()、get_price()、get_fundamentals()等核心数据获取函数</p><p>✅ <strong>数据处理技能</strong>：学会了数据清洗、异常值检测、特征工程等关键数据处理技术</p><p>✅ <strong>质量控制方法</strong>：建立了系统的数据质量检查流程，确保策略开发的数据基础可靠</p><h3 id=最佳实践建议>最佳实践建议</h3><p><strong>1. 数据获取策略</strong></p><ul><li>根据策略需求选择合适的数据频率，避免过度追求高频数据</li><li>使用复权价格进行回测，确保收益率计算准确</li><li>建立数据缓存机制，避免重复获取相同数据</li></ul><p><strong>2. 数据处理原则</strong></p><ul><li>始终进行数据质量检查，不要假设数据是完美的</li><li>处理好缺失值和异常值，它们可能严重影响策略表现</li><li>保留数据处理记录，便于后续分析和调试</li></ul><p><strong>3. 特征工程技巧</strong></p><ul><li>创建有意义的特征，避免过度工程化</li><li>注意特征之间的相关性，避免多重共线性</li><li>考虑特征的经济含义，不仅仅是统计显著性</li></ul><p><strong>4. 性能优化建议</strong></p><ul><li>批量获取数据，减少API调用次数</li><li>使用向量化操作，避免循环处理大数据集</li><li>合理管理内存，及时清理不需要的大型数据对象</li></ul><p>在下一篇教程中，我们将深入学习策略框架与生命周期管理，掌握如何构建更加复杂和实用的量化策略。继续加油，你已经迈出了量化交易的关键一步！</p></div></article><aside class="lg:w-80 xl:w-96"><div class=space-y-8></div></aside></div><nav class="border-t border-gray-200 mt-12 pt-8"><div class="flex justify-between items-center"><a href=/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/01-supermind%E5%B9%B3%E5%8F%B0%E5%85%A5%E9%97%A8%E4%B8%8E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/ class="group flex items-center"><svg class="w-5 h-5 mr-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0 7-7m-7 7h18"/></svg><div><div class="text-sm text-gray-600">上一篇</div><div class="font-medium group-hover:text-primary-600">SuperMind第1讲：量化交易平台入门与环境搭建</div></div></a><a href=/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/03-%E7%AD%96%E7%95%A5%E6%A1%86%E6%9E%B6%E4%B8%8E%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86/ class="group flex items-center text-right"><div><div class="text-sm text-gray-600">Next Post</div><div class="font-medium group-hover:text-primary-600">SuperMind第3讲：策略框架与生命周期管理</div></div><svg class="w-5 h-5 ml-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0-7 7m7-7H3"/></svg></a></div></nav></div></div><footer class="bg-gray-50 py-12 border-t border-gray-200"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><div class="flex flex-col md:flex-row justify-between space-y-4 md:space-y-0"><div class=flex-1><div class="flex items-center space-x-3 mb-4"><a href=https://sk-quant.github.io/ class=inline-block><img src=/images/logo.svg alt=烧烤量化 class=h-6>
</a><span class="text-xl font-bold text-gray-900">烧烤量化</span></div><div class="flex space-x-3 p-2"></div></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div></div><div class="mt-12 pt-8 border-t border-gray-200"><div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0"><p class="text-gray-600 text-sm">© 2025 烧烤量化. All rights reserved.</p><a href=https://chaoming.li class="text-sm text-gray-600 hover:text-primary-600" target=_blank rel="noopener noreferrer">Powered by sk-quant</a></div></div></div></footer><script>const mobileMenuButton=document.getElementById("mobile-menu-button");mobileMenuButton&&mobileMenuButton.addEventListener("click",function(){const e=document.getElementById("mobile-menu");e&&e.classList.toggle("hidden")})</script></body></html>