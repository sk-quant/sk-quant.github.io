<!doctype html><html lang=zh-cn class=h-full><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-XXXXXXX")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XXXXXXXXXX")</script><title>SuperMind第7讲：回测系统与绩效评估 | 烧烤量化</title>
<meta name=description content="学习SuperMind平台回测系统使用和策略绩效评估方法"><meta name=author content="Ryan"><meta name=robots content="index, follow"><meta property="og:title" content="SuperMind第7讲：回测系统与绩效评估 | 烧烤量化"><meta property="og:description" content="学习SuperMind平台回测系统使用和策略绩效评估方法"><meta property="og:type" content="article"><meta property="og:url" content="https://sk-quant.github.io/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/07-%E5%9B%9E%E6%B5%8B%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%BB%A9%E6%95%88%E8%AF%84%E4%BC%B0/"><meta property="og:site_name" content="烧烤量化"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="SuperMind第7讲：回测系统与绩效评估 | 烧烤量化"><meta name=twitter:description content="学习SuperMind平台回测系统使用和策略绩效评估方法"><link rel=icon type=image/x-icon href=/images/favicon.ico><link rel=canonical href=https://sk-quant.github.io/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/07-%E5%9B%9E%E6%B5%8B%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%BB%A9%E6%95%88%E8%AF%84%E4%BC%B0/><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel=stylesheet><link rel=stylesheet href="/css/main.min.9a3c970d7feebe1317992d10ced98f226635b831a963ee601e5901734ff0da21.css"></head><body class="min-h-screen flex flex-col"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-XXXXXXX" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class="fixed top-0 left-0 right-0 z-50"><div class=mobile-menu-wrapper><input type=checkbox id=nav-toggle class=nav-toggle><header class="fixed w-full top-0 z-50 bg-white/80 backdrop-blur-sm border-b border-gray-100"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><nav class="flex items-center justify-between h-20"><a href=https://sk-quant.github.io/ class="flex items-center space-x-4"><img src=/images/logo.svg alt=烧烤量化 class=h-12>
<span class="text-3xl font-semibold text-gray-800">烧烤量化</span></a><div class="hidden md:flex items-center space-x-8"><a href=/path class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">学习路线</a><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化基础<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">回测平台</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化进阶<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">综合实战</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化高手<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股指期货</a></div></div></div><a href=/pricing class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">服务套餐</a></div><div class="hidden md:flex items-center space-x-4"><a href=/contact class="inline-flex items-center justify-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div><div class=md:hidden><label for=nav-toggle class="p-2 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-offset-2 transition-colors cursor-pointer"><svg class="w-6 h-6" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></label></div></nav></div><div class="nav-content md:hidden w-full fixed left-0 right-0 top-20 bg-white border-t border-gray-100 shadow-lg"><div class="w-full px-6 py-4"><a href=/path class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">学习路线</a><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化基础</div><div class=pl-4><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block text-gray-700 hover:text-primary-600 py-2">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block text-gray-700 hover:text-primary-600 py-2">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block text-gray-700 hover:text-primary-600 py-2">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block text-gray-700 hover:text-primary-600 py-2">回测平台</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化进阶</div><div class=pl-4><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block text-gray-700 hover:text-primary-600 py-2">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block text-gray-700 hover:text-primary-600 py-2">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block text-gray-700 hover:text-primary-600 py-2">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block text-gray-700 hover:text-primary-600 py-2">综合实战</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化高手</div><div class=pl-4><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block text-gray-700 hover:text-primary-600 py-2">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block text-gray-700 hover:text-primary-600 py-2">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block text-gray-700 hover:text-primary-600 py-2">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block text-gray-700 hover:text-primary-600 py-2">股指期货</a></div></div><a href=/pricing class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">服务套餐</a><div class="pt-4 space-y-4"><a href=/contact class="block text-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div></div></div></header><style>.mobile-menu-wrapper{position:relative}.nav-toggle{display:none}.nav-content{display:none}.nav-toggle:checked~header .nav-content{display:block}</style></div></div><div class=pt-20><div class="container mx-auto px-4 py-12"><div class="flex flex-col lg:flex-row gap-8 mb-12"><article class=flex-1><header class=mb-8><div class=mb-4><a href=/categories/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0 class="inline-block px-3 py-1 text-sm font-medium text-primary-600 bg-primary-50 rounded-full hover:bg-primary-100 mr-2">回测平台</a></div><h1 class="text-4xl font-bold mb-4">SuperMind第7讲：回测系统与绩效评估</h1><div class="flex flex-col space-y-4"><div class="flex items-center justify-between text-sm text-gray-500"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7A4 4 0 118 7a4 4 0 018 0zm-4 7a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
<span>Ryan</span></div><div class="flex items-center space-x-6"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747.0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746.0-3.332.477-4.5 1.253"/></svg>
<span>18 分钟</span></div><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5A2 2 0 003 7v12a2 2 0 002 2z"/></svg>
<time datetime=2025-09-27>September 27, 2025</time></div></div></div><div class="flex items-center flex-wrap gap-2"><a href=/tags/2025 class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors duration-200">#2025
</a><a href=/tags/supermind class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors duration-200">#SuperMind</a></div></div></header><div class=mb-8><img src=/images/blog/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0.jpg alt=SuperMind第7讲：回测系统与绩效评估 class="w-full h-auto rounded-lg" loading=lazy></div><div class="prose prose-lg max-w-none"><h2 id=学习目标>学习目标</h2><ul><li>掌握SuperMind回测系统的核心功能和参数设置</li><li>学会策略绩效评估指标的计算和分析</li><li>理解回测结果的解读和策略诊断方法</li><li>掌握回测报告的生成和可视化技巧</li></ul><div class="bg-gray-50 p-6 rounded-lg mb-8"><h2 class="text-xl font-semibold mb-4">目录</h2><nav id=TableOfContents><ul><li><a href=#学习目标>学习目标</a></li><li><a href=#supermind回测系统概述>SuperMind回测系统概述</a><ul><li><a href=#回测系统架构>回测系统架构</a></li><li><a href=#回测配置详解>回测配置详解</a></li></ul></li><li><a href=#绩效评估指标>绩效评估指标</a><ul><li><a href=#收益类指标>收益类指标</a></li><li><a href=#风险类指标>风险类指标</a></li><li><a href=#综合绩效指标>综合绩效指标</a></li></ul></li><li><a href=#回测结果分析>回测结果分析</a><ul><li><a href=#结果可视化>结果可视化</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div><h2 id=supermind回测系统概述>SuperMind回测系统概述</h2><h3 id=回测系统架构>回测系统架构</h3><p>SuperMind回测系统是策略验证的核心工具：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>backtest_system_overview</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    回测系统架构概览
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>system_components</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;数据层&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;行情数据&#39;</span><span class=p>:</span> <span class=s1>&#39;股票、基金、期货等价格数据&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;财务数据&#39;</span><span class=p>:</span> <span class=s1>&#39;财务报表、盈利预测等&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;因子数据&#39;</span><span class=p>:</span> <span class=s1>&#39;估值、成长、质量等因子&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;事件数据&#39;</span><span class=p>:</span> <span class=s1>&#39;公告、分红、重组等事件&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;宏观数据&#39;</span><span class=p>:</span> <span class=s1>&#39;经济指标、利率、汇率等&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;引擎层&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;事件驱动引擎&#39;</span><span class=p>:</span> <span class=s1>&#39;基于事件的回测机制&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;时间序列引擎&#39;</span><span class=p>:</span> <span class=s1>&#39;基于时间的回测机制&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;撮合引擎&#39;</span><span class=p>:</span> <span class=s1>&#39;模拟真实交易撮合&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;风控引擎&#39;</span><span class=p>:</span> <span class=s1>&#39;风险控制和限制检查&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;策略层&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;初始化&#39;</span><span class=p>:</span> <span class=s1>&#39;策略参数和状态初始化&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;信号生成&#39;</span><span class=p>:</span> <span class=s1>&#39;交易信号产生逻辑&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;订单管理&#39;</span><span class=p>:</span> <span class=s1>&#39;订单生成和管理&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;仓位管理&#39;</span><span class=p>:</span> <span class=s1>&#39;仓位调整和再平衡&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;绩效层&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;收益计算&#39;</span><span class=p>:</span> <span class=s1>&#39;收益率和净值计算&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;风险评估&#39;</span><span class=p>:</span> <span class=s1>&#39;波动率和最大回撤计算&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;指标计算&#39;</span><span class=p>:</span> <span class=s1>&#39;夏普比率、信息比率等&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;归因分析&#39;</span><span class=p>:</span> <span class=s1>&#39;收益来源分析&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>system_components</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>backtest_parameters</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    回测参数配置
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>parameters</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;时间参数&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;start_date&#39;</span><span class=p>:</span> <span class=s1>&#39;回测开始日期&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;end_date&#39;</span><span class=p>:</span> <span class=s1>&#39;回测结束日期&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;frequency&#39;</span><span class=p>:</span> <span class=s1>&#39;数据频率（日/分钟）&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;benchmark&#39;</span><span class=p>:</span> <span class=s1>&#39;业绩比较基准&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;资金参数&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;initial_capital&#39;</span><span class=p>:</span> <span class=s1>&#39;初始资金&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;commission&#39;</span><span class=p>:</span> <span class=s1>&#39;交易佣金&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;slippage&#39;</span><span class=p>:</span> <span class=s1>&#39;滑点设置&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;min_commission&#39;</span><span class=p>:</span> <span class=s1>&#39;最低佣金&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;交易参数&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;order_price&#39;</span><span class=p>:</span> <span class=s1>&#39;订单价格类型&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;volume_limit&#39;</span><span class=p>:</span> <span class=s1>&#39;成交量限制&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;price_limit&#39;</span><span class=p>:</span> <span class=s1>&#39;涨跌停限制&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;short_selling&#39;</span><span class=p>:</span> <span class=s1>&#39;是否允许卖空&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;风控参数&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max_position_size&#39;</span><span class=p>:</span> <span class=s1>&#39;最大仓位&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max_turnover&#39;</span><span class=p>:</span> <span class=s1>&#39;最大换手率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;stop_loss&#39;</span><span class=p>:</span> <span class=s1>&#39;止损设置&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sector_limit&#39;</span><span class=p>:</span> <span class=s1>&#39;行业限制&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>parameters</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run_backtest</span><span class=p>(</span><span class=n>strategy_func</span><span class=p>,</span> <span class=n>start_date</span><span class=p>,</span> <span class=n>end_date</span><span class=p>,</span> <span class=n>initial_capital</span><span class=o>=</span><span class=mi>1000000</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>benchmark</span><span class=o>=</span><span class=s1>&#39;000300.XSHG&#39;</span><span class=p>,</span> <span class=n>frequency</span><span class=o>=</span><span class=s1>&#39;daily&#39;</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    运行回测
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 设置回测参数</span>
</span></span><span class=line><span class=cl>    <span class=n>backtest_params</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;start_date&#39;</span><span class=p>:</span> <span class=n>start_date</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;end_date&#39;</span><span class=p>:</span> <span class=n>end_date</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;initial_capital&#39;</span><span class=p>:</span> <span class=n>initial_capital</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;benchmark&#39;</span><span class=p>:</span> <span class=n>benchmark</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;frequency&#39;</span><span class=p>:</span> <span class=n>frequency</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;commission&#39;</span><span class=p>:</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;commission&#39;</span><span class=p>,</span> <span class=mf>0.001</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;slippage&#39;</span><span class=p>:</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;slippage&#39;</span><span class=p>,</span> <span class=mf>0.002</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;min_commission&#39;</span><span class=p>:</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;min_commission&#39;</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 运行回测</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=n>backtest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>strategy</span><span class=o>=</span><span class=n>strategy_func</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=o>**</span><span class=n>backtest_params</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>results</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=回测配置详解>回测配置详解</h3><p>详细配置回测参数以获得更真实的结果：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>configure_realistic_backtest</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    配置真实回测参数
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1># 交易费用</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;commission&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;stock&#39;</span><span class=p>:</span> <span class=mf>0.001</span><span class=p>,</span>          <span class=c1># 股票交易佣金 0.1%</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;fund&#39;</span><span class=p>:</span> <span class=mf>0.005</span><span class=p>,</span>           <span class=c1># 基金交易佣金 0.5%</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;futures&#39;</span><span class=p>:</span> <span class=mf>0.0005</span><span class=p>,</span>        <span class=c1># 期货交易佣金 0.05%</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;min_fee&#39;</span><span class=p>:</span> <span class=mi>5</span>             <span class=c1># 最低佣金5元</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 滑点设置</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;slippage&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;fixed&#39;</span><span class=p>:</span> <span class=mf>0.002</span><span class=p>,</span>          <span class=c1># 固定滑点0.2%</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;volume_based&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>    <span class=c1># 基于成交量的滑点</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;volatility_based&#39;</span><span class=p>:</span> <span class=kc>True</span>  <span class=c1># 基于波动率的滑点</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 交易限制</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;trading_limits&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;volume_limit&#39;</span><span class=p>:</span> <span class=mf>0.1</span><span class=p>,</span>     <span class=c1># 日成交量限制10%</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;price_limit&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>     <span class=c1># 考虑涨跌停限制</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;suspend_limit&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>   <span class=c1># 考虑停牌限制</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;st_limit&#39;</span><span class=p>:</span> <span class=kc>True</span>         <span class=c1># ST股票交易限制</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 资金限制</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;capital_limits&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;initial_capital&#39;</span><span class=p>:</span> <span class=mi>1000000</span><span class=p>,</span>  <span class=c1># 初始资金100万</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;margin_ratio&#39;</span><span class=p>:</span> <span class=mf>0.5</span><span class=p>,</span>         <span class=c1># 保证金比例</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max_leverage&#39;</span><span class=p>:</span> <span class=mf>2.0</span><span class=p>,</span>        <span class=c1># 最大杠杆2倍</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;min_cash_ratio&#39;</span><span class=p>:</span> <span class=mf>0.05</span>      <span class=c1># 最低现金比例5%</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 时间设置</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;time_settings&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;start_time&#39;</span><span class=p>:</span> <span class=s1>&#39;09:30&#39;</span><span class=p>,</span>     <span class=c1># 开盘时间</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;end_time&#39;</span><span class=p>:</span> <span class=s1>&#39;15:00&#39;</span><span class=p>,</span>       <span class=c1># 收盘时间</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;lunch_break&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>       <span class=c1># 考虑午休时间</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;holiday_skip&#39;</span><span class=p>:</span> <span class=kc>True</span>       <span class=c1># 跳过节假日</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>config</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>advanced_backtest_config</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    高级回测配置
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>advanced_config</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1># 多线程回测</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;parallel&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;enabled&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;workers&#39;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span>            <span class=c1># 4个工作线程</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;chunk_size&#39;</span><span class=p>:</span> <span class=mi>100</span>        <span class=c1># 每块100只股票</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 内存优化</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;memory_optimization&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;data_chunk_size&#39;</span><span class=p>:</span> <span class=mi>1000</span><span class=p>,</span>  <span class=c1># 数据分块大小</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;cache_enabled&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>    <span class=c1># 启用缓存</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;gc_frequency&#39;</span><span class=p>:</span> <span class=mi>100</span>       <span class=c1># 垃圾回收频率</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 精度设置</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;precision&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;price_precision&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>     <span class=c1># 价格精度3位小数</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;return_precision&#39;</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span>    <span class=c1># 收益率精度6位小数</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;weight_precision&#39;</span><span class=p>:</span> <span class=mi>4</span>     <span class=c1># 权重精度4位小数</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 日志设置</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;logging&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;level&#39;</span><span class=p>:</span> <span class=s1>&#39;INFO&#39;</span><span class=p>,</span>         <span class=c1># 日志级别</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;file_enabled&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>    <span class=c1># 启用文件日志</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;console_enabled&#39;</span><span class=p>:</span> <span class=kc>True</span>  <span class=c1># 启用控制台日志</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>advanced_config</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_custom_backtest_engine</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    创建自定义回测引擎
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>CustomBacktestEngine</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>config</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>config</span> <span class=o>=</span> <span class=n>config</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>data_loader</span> <span class=o>=</span> <span class=n>DataLoader</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>portfolio_manager</span> <span class=o>=</span> <span class=n>PortfolioManager</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>risk_manager</span> <span class=o>=</span> <span class=n>RiskManager</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>performance_analyzer</span> <span class=o>=</span> <span class=n>PerformanceAnalyzer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>strategy_func</span><span class=p>,</span> <span class=n>start_date</span><span class=p>,</span> <span class=n>end_date</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;初始化回测环境&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>strategy</span> <span class=o>=</span> <span class=n>strategy_func</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>start_date</span> <span class=o>=</span> <span class=n>start_date</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>end_date</span> <span class=o>=</span> <span class=n>end_date</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>current_date</span> <span class=o>=</span> <span class=n>start_date</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 加载数据</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>data_loader</span><span class=o>.</span><span class=n>load_data</span><span class=p>(</span><span class=n>start_date</span><span class=p>,</span> <span class=n>end_date</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 初始化组合</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>portfolio_manager</span><span class=o>.</span><span class=n>create_portfolio</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>initial_capital</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;initial_capital&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;运行回测&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 按日期循环</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>date</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>date_range</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>current_date</span> <span class=o>=</span> <span class=n>date</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 执行策略</span>
</span></span><span class=line><span class=cl>                <span class=n>signals</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>strategy</span><span class=p>(</span><span class=n>date</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>data</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 生成订单</span>
</span></span><span class=line><span class=cl>                <span class=n>orders</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_orders</span><span class=p>(</span><span class=n>signals</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 执行订单</span>
</span></span><span class=line><span class=cl>                <span class=n>executed_orders</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>execute_orders</span><span class=p>(</span><span class=n>orders</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 更新组合</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>executed_orders</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>data</span><span class=p>,</span> <span class=n>date</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 记录结果</span>
</span></span><span class=line><span class=cl>                <span class=n>daily_result</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>date</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;portfolio_value&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=o>.</span><span class=n>total_value</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;cash&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=o>.</span><span class=n>cash</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;positions&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=o>.</span><span class=n>positions</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;returns&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=o>.</span><span class=n>daily_return</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>daily_result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>generate_orders</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>signals</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;生成订单&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>orders</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>signal</span> <span class=ow>in</span> <span class=n>signals</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 风险控制检查</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>risk_manager</span><span class=o>.</span><span class=n>check_risk</span><span class=p>(</span><span class=n>signal</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>portfolio</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>order</span> <span class=o>=</span> <span class=n>Order</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>symbol</span><span class=o>=</span><span class=n>signal</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                        <span class=n>quantity</span><span class=o>=</span><span class=n>signal</span><span class=p>[</span><span class=s1>&#39;quantity&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                        <span class=n>order_type</span><span class=o>=</span><span class=n>signal</span><span class=p>[</span><span class=s1>&#39;order_type&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                        <span class=n>price</span><span class=o>=</span><span class=n>signal</span><span class=p>[</span><span class=s1>&#39;price&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>orders</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>order</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>orders</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>execute_orders</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>orders</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;执行订单&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>executed_orders</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>order</span> <span class=ow>in</span> <span class=n>orders</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 模拟撮合</span>
</span></span><span class=line><span class=cl>                <span class=n>executed_order</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>simulate_execution</span><span class=p>(</span><span class=n>order</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>executed_order</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>executed_orders</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>executed_order</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>executed_orders</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>CustomBacktestEngine</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=绩效评估指标>绩效评估指标</h2><h3 id=收益类指标>收益类指标</h3><p>收益是策略评估的核心：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_return_metrics</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>benchmark_returns</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算收益类指标
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 基本收益指标</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;total_return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>returns</span><span class=p>)</span><span class=o>.</span><span class=n>prod</span><span class=p>()</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;annual_return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;total_return&#39;</span><span class=p>])</span> <span class=o>**</span> <span class=p>(</span><span class=mi>252</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>returns</span><span class=p>))</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 日收益率统计</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;mean_daily_return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;std_daily_return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;skewness&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>skew</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;kurtosis&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>kurtosis</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 正收益率比例</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;positive_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>returns</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 最大单日收益和损失</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;max_daily_gain&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>max</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;max_daily_loss&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>min</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 连续盈利/亏损天数</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;max_consecutive_wins&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>calculate_max_consecutive</span><span class=p>(</span><span class=n>returns</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;max_consecutive_losses&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>calculate_max_consecutive</span><span class=p>(</span><span class=n>returns</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 相对收益（如果有基准）</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>benchmark_returns</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>excess_returns</span> <span class=o>=</span> <span class=n>returns</span> <span class=o>-</span> <span class=n>benchmark_returns</span>
</span></span><span class=line><span class=cl>        <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;excess_return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>excess_returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>*</span> <span class=mi>252</span>
</span></span><span class=line><span class=cl>        <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;tracking_error&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>excess_returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;information_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;excess_return&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;tracking_error&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>metrics</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_max_consecutive</span><span class=p>(</span><span class=n>condition_series</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算最大连续次数
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>consecutive_counts</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>current_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>condition</span> <span class=ow>in</span> <span class=n>condition_series</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>current_count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_count</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>consecutive_counts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>current_count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>current_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>current_count</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>consecutive_counts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>current_count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>max</span><span class=p>(</span><span class=n>consecutive_counts</span><span class=p>)</span> <span class=k>if</span> <span class=n>consecutive_counts</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_compound_annual_growth_rate</span><span class=p>(</span><span class=n>prices</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算复合年增长率（CAGR）
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>years</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>prices</span><span class=p>)</span> <span class=o>/</span> <span class=mi>252</span>  <span class=c1># 假设每年252个交易日</span>
</span></span><span class=line><span class=cl>    <span class=n>cagr</span> <span class=o>=</span> <span class=p>(</span><span class=n>prices</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>/</span> <span class=n>prices</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span> <span class=o>**</span> <span class=p>(</span><span class=mi>1</span> <span class=o>/</span> <span class=n>years</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>cagr</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_calendar_year_returns</span><span class=p>(</span><span class=n>returns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算历年收益率
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 按年份分组</span>
</span></span><span class=line><span class=cl>    <span class=n>yearly_returns</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>year</span> <span class=ow>in</span> <span class=n>returns</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>year</span><span class=o>.</span><span class=n>unique</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>year_returns</span> <span class=o>=</span> <span class=n>returns</span><span class=p>[</span><span class=n>returns</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>year</span> <span class=o>==</span> <span class=n>year</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>yearly_return</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>year_returns</span><span class=p>)</span><span class=o>.</span><span class=n>prod</span><span class=p>()</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>yearly_returns</span><span class=p>[</span><span class=n>year</span><span class=p>]</span> <span class=o>=</span> <span class=n>yearly_return</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>yearly_returns</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_rolling_returns</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>window</span><span class=o>=</span><span class=mi>252</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算滚动收益率
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>rolling_returns</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>window</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>period_returns</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>window</span><span class=p>:</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>rolling_return</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>period_returns</span><span class=p>)</span><span class=o>.</span><span class=n>prod</span><span class=p>()</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>rolling_returns</span><span class=p>[</span><span class=n>returns</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]]</span> <span class=o>=</span> <span class=n>rolling_return</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>rolling_returns</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=风险类指标>风险类指标</h3><p>风险评估是策略稳健性的关键：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_risk_metrics</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>confidence_level</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算风险类指标
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 波动率</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;volatility&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;downside_volatility&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>returns</span><span class=p>[</span><span class=n>returns</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 最大回撤</span>
</span></span><span class=line><span class=cl>    <span class=n>cumulative_returns</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>returns</span><span class=p>)</span><span class=o>.</span><span class=n>cumprod</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>peak</span> <span class=o>=</span> <span class=n>cumulative_returns</span><span class=o>.</span><span class=n>expanding</span><span class=p>()</span><span class=o>.</span><span class=n>max</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>drawdown</span> <span class=o>=</span> <span class=p>(</span><span class=n>cumulative_returns</span> <span class=o>-</span> <span class=n>peak</span><span class=p>)</span> <span class=o>/</span> <span class=n>peak</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>drawdown</span><span class=o>.</span><span class=n>min</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;max_drawdown_duration&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>calculate_max_drawdown_duration</span><span class=p>(</span><span class=n>drawdown</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># VaR和CVaR</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;var&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>confidence_level</span> <span class=o>*</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;cvar&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>returns</span><span class=p>[</span><span class=n>returns</span> <span class=o>&lt;=</span> <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;var&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 下行风险指标</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;downside_deviation&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>minimum</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>**</span> <span class=mi>2</span><span class=p>))</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 极端损失概率</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;extreme_loss_prob&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>returns</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mf>0.05</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 风险调整后收益</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;calmar_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>*</span> <span class=mi>252</span><span class=p>)</span> <span class=o>/</span> <span class=nb>abs</span><span class=p>(</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>metrics</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_max_drawdown_duration</span><span class=p>(</span><span class=n>drawdown_series</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算最大回撤持续时间
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>is_drawdown</span> <span class=o>=</span> <span class=n>drawdown_series</span> <span class=o>&lt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>durations</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>current_duration</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>is_dd</span> <span class=ow>in</span> <span class=n>is_drawdown</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>is_dd</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>current_duration</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_duration</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>durations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>current_duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>current_duration</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>current_duration</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>durations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>current_duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>max</span><span class=p>(</span><span class=n>durations</span><span class=p>)</span> <span class=k>if</span> <span class=n>durations</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_various_drawdowns</span><span class=p>(</span><span class=n>returns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算不同类型的回撤
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>cumulative_returns</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>returns</span><span class=p>)</span><span class=o>.</span><span class=n>cumprod</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>peak</span> <span class=o>=</span> <span class=n>cumulative_returns</span><span class=o>.</span><span class=n>expanding</span><span class=p>()</span><span class=o>.</span><span class=n>max</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>drawdown</span> <span class=o>=</span> <span class=p>(</span><span class=n>cumulative_returns</span> <span class=o>-</span> <span class=n>peak</span><span class=p>)</span> <span class=o>/</span> <span class=n>peak</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>drawdowns</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;max_drawdown&#39;</span><span class=p>:</span> <span class=n>drawdown</span><span class=o>.</span><span class=n>min</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;avg_drawdown&#39;</span><span class=p>:</span> <span class=n>drawdown</span><span class=p>[</span><span class=n>drawdown</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;drawdown_std&#39;</span><span class=p>:</span> <span class=n>drawdown</span><span class=p>[</span><span class=n>drawdown</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>std</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;current_drawdown&#39;</span><span class=p>:</span> <span class=n>drawdown</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;drawdown_count&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>drawdown</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;max_drawdown_date&#39;</span><span class=p>:</span> <span class=n>drawdown</span><span class=o>.</span><span class=n>idxmin</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;recovery_periods&#39;</span><span class=p>:</span> <span class=n>calculate_recovery_periods</span><span class=p>(</span><span class=n>drawdown</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>drawdowns</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_recovery_periods</span><span class=p>(</span><span class=n>drawdown_series</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算回撤恢复时间
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>recovery_periods</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>in_drawdown</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=n>drawdown_start</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>date</span><span class=p>,</span> <span class=n>dd</span> <span class=ow>in</span> <span class=n>drawdown_series</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>dd</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>in_drawdown</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 开始回撤</span>
</span></span><span class=line><span class=cl>            <span class=n>in_drawdown</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=n>drawdown_start</span> <span class=o>=</span> <span class=n>date</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>dd</span> <span class=o>==</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>in_drawdown</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 回撤恢复</span>
</span></span><span class=line><span class=cl>            <span class=n>in_drawdown</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>drawdown_start</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>recovery_period</span> <span class=o>=</span> <span class=p>(</span><span class=n>date</span> <span class=o>-</span> <span class=n>drawdown_start</span><span class=p>)</span><span class=o>.</span><span class=n>days</span>
</span></span><span class=line><span class=cl>                <span class=n>recovery_periods</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>recovery_period</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;avg_recovery&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>recovery_periods</span><span class=p>)</span> <span class=k>if</span> <span class=n>recovery_periods</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;max_recovery&#39;</span><span class=p>:</span> <span class=nb>max</span><span class=p>(</span><span class=n>recovery_periods</span><span class=p>)</span> <span class=k>if</span> <span class=n>recovery_periods</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;min_recovery&#39;</span><span class=p>:</span> <span class=nb>min</span><span class=p>(</span><span class=n>recovery_periods</span><span class=p>)</span> <span class=k>if</span> <span class=n>recovery_periods</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;recovery_periods&#39;</span><span class=p>:</span> <span class=n>recovery_periods</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_tail_risk_metrics</span><span class=p>(</span><span class=n>returns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算尾部风险指标
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>tail_metrics</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 极端损失（1%和5%分位数）</span>
</span></span><span class=line><span class=cl>    <span class=n>tail_metrics</span><span class=p>[</span><span class=s1>&#39;extreme_loss_1pct&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>tail_metrics</span><span class=p>[</span><span class=s1>&#39;extreme_loss_5pct&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 极端收益（95%和99%分位数）</span>
</span></span><span class=line><span class=cl>    <span class=n>tail_metrics</span><span class=p>[</span><span class=s1>&#39;extreme_gain_95pct&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=mi>95</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>tail_metrics</span><span class=p>[</span><span class=s1>&#39;extreme_gain_99pct&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=mi>99</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 负收益统计</span>
</span></span><span class=line><span class=cl>    <span class=n>negative_returns</span> <span class=o>=</span> <span class=n>returns</span><span class=p>[</span><span class=n>returns</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>negative_returns</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>tail_metrics</span><span class=p>[</span><span class=s1>&#39;avg_negative_return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>negative_returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>tail_metrics</span><span class=p>[</span><span class=s1>&#39;negative_return_std&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>negative_returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>tail_metrics</span><span class=p>[</span><span class=s1>&#39;worst_return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>negative_returns</span><span class=o>.</span><span class=n>min</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 连续损失统计</span>
</span></span><span class=line><span class=cl>    <span class=n>consecutive_losses</span> <span class=o>=</span> <span class=n>find_consecutive_losses</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>consecutive_losses</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>tail_metrics</span><span class=p>[</span><span class=s1>&#39;max_consecutive_losses&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>consecutive_losses</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>tail_metrics</span><span class=p>[</span><span class=s1>&#39;avg_consecutive_losses&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>consecutive_losses</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>tail_metrics</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>find_consecutive_losses</span><span class=p>(</span><span class=n>returns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    找出连续损失序列
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>consecutive_lengths</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>current_length</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>ret</span> <span class=ow>in</span> <span class=n>returns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>current_length</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>consecutive_lengths</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>current_length</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>current_length</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>current_length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>consecutive_lengths</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>current_length</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>consecutive_lengths</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_conditional_risk_metrics</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>market_returns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算条件风险指标（Beta等）
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>risk_metrics</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算Beta</span>
</span></span><span class=line><span class=cl>    <span class=n>covariance</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>cov</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>market_returns</span><span class=p>)[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>market_variance</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>market_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>risk_metrics</span><span class=p>[</span><span class=s1>&#39;beta&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>covariance</span> <span class=o>/</span> <span class=n>market_variance</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算Alpha</span>
</span></span><span class=line><span class=cl>    <span class=n>risk_free_rate</span> <span class=o>=</span> <span class=mf>0.03</span>  <span class=c1># 假设无风险利率3%</span>
</span></span><span class=line><span class=cl>    <span class=n>excess_returns</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>*</span> <span class=mi>252</span> <span class=o>-</span> <span class=n>risk_free_rate</span>
</span></span><span class=line><span class=cl>    <span class=n>market_excess_return</span> <span class=o>=</span> <span class=n>market_returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>*</span> <span class=mi>252</span> <span class=o>-</span> <span class=n>risk_free_rate</span>
</span></span><span class=line><span class=cl>    <span class=n>risk_metrics</span><span class=p>[</span><span class=s1>&#39;alpha&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>excess_returns</span> <span class=o>-</span> <span class=n>risk_metrics</span><span class=p>[</span><span class=s1>&#39;beta&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=n>market_excess_return</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算相关性</span>
</span></span><span class=line><span class=cl>    <span class=n>risk_metrics</span><span class=p>[</span><span class=s1>&#39;correlation&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>corrcoef</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>market_returns</span><span class=p>)[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算R-squared</span>
</span></span><span class=line><span class=cl>    <span class=n>risk_metrics</span><span class=p>[</span><span class=s1>&#39;r_squared&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>risk_metrics</span><span class=p>[</span><span class=s1>&#39;correlation&#39;</span><span class=p>]</span> <span class=o>**</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算系统性风险比例</span>
</span></span><span class=line><span class=cl>    <span class=n>total_risk</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span> <span class=o>*</span> <span class=mi>252</span>
</span></span><span class=line><span class=cl>    <span class=n>systematic_risk</span> <span class=o>=</span> <span class=n>risk_metrics</span><span class=p>[</span><span class=s1>&#39;beta&#39;</span><span class=p>]</span> <span class=o>**</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>market_returns</span><span class=p>)</span> <span class=o>*</span> <span class=mi>252</span>
</span></span><span class=line><span class=cl>    <span class=n>risk_metrics</span><span class=p>[</span><span class=s1>&#39;systematic_risk_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>systematic_risk</span> <span class=o>/</span> <span class=n>total_risk</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>risk_metrics</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=综合绩效指标>综合绩效指标</h3><p>综合指标结合收益和风险：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_comprehensive_metrics</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>benchmark_returns</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>risk_free_rate</span><span class=o>=</span><span class=mf>0.03</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算综合绩效指标
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 收益指标</span>
</span></span><span class=line><span class=cl>    <span class=n>return_metrics</span> <span class=o>=</span> <span class=n>calculate_return_metrics</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>benchmark_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>return_metrics</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 风险指标</span>
</span></span><span class=line><span class=cl>    <span class=n>risk_metrics</span> <span class=o>=</span> <span class=n>calculate_risk_metrics</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>risk_metrics</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 夏普比率</span>
</span></span><span class=line><span class=cl>    <span class=n>excess_return</span> <span class=o>=</span> <span class=n>return_metrics</span><span class=p>[</span><span class=s1>&#39;annual_return&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>risk_free_rate</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>excess_return</span> <span class=o>/</span> <span class=n>risk_metrics</span><span class=p>[</span><span class=s1>&#39;volatility&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 索提诺比率</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;sortino_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>excess_return</span> <span class=o>/</span> <span class=n>risk_metrics</span><span class=p>[</span><span class=s1>&#39;downside_volatility&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 信息比率（如果有基准）</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>benchmark_returns</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;information_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>return_metrics</span><span class=p>[</span><span class=s1>&#39;information_ratio&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 卡尔马比率</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;calmar_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>excess_return</span> <span class=o>/</span> <span class=nb>abs</span><span class=p>(</span><span class=n>risk_metrics</span><span class=p>[</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 收益风险比</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;return_risk_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>return_metrics</span><span class=p>[</span><span class=s1>&#39;annual_return&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=n>risk_metrics</span><span class=p>[</span><span class=s1>&#39;volatility&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 收益回撤比</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;return_drawdown_ratio&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>return_metrics</span><span class=p>[</span><span class=s1>&#39;annual_return&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=nb>abs</span><span class=p>(</span><span class=n>risk_metrics</span><span class=p>[</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 胜率相关指标</span>
</span></span><span class=line><span class=cl>    <span class=n>win_rate</span> <span class=o>=</span> <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;positive_ratio&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>avg_win</span> <span class=o>=</span> <span class=n>returns</span><span class=p>[</span><span class=n>returns</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>returns</span><span class=p>[</span><span class=n>returns</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>])</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>avg_loss</span> <span class=o>=</span> <span class=n>returns</span><span class=p>[</span><span class=n>returns</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>returns</span><span class=p>[</span><span class=n>returns</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>])</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 盈亏比</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;profit_factor&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>avg_win</span> <span class=o>/</span> <span class=n>avg_loss</span><span class=p>)</span> <span class=k>if</span> <span class=n>avg_loss</span> <span class=o>!=</span> <span class=mi>0</span> <span class=k>else</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;inf&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 期望值</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;expected_return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>win_rate</span> <span class=o>*</span> <span class=n>avg_win</span> <span class=o>+</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>win_rate</span><span class=p>)</span> <span class=o>*</span> <span class=n>avg_loss</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 凯利公式最优仓位</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;expected_return&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>risk_metrics</span><span class=p>[</span><span class=s1>&#39;volatility&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;kelly_criterion&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;expected_return&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=p>(</span><span class=n>risk_metrics</span><span class=p>[</span><span class=s1>&#39;volatility&#39;</span><span class=p>]</span> <span class=o>**</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>metrics</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_performance_attribution</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>factor_returns</span><span class=p>,</span> <span class=n>factor_names</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算绩效归因
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>attribution</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 多因子回归</span>
</span></span><span class=line><span class=cl>    <span class=n>X</span> <span class=o>=</span> <span class=n>sm</span><span class=o>.</span><span class=n>add_constant</span><span class=p>(</span><span class=n>factor_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span> <span class=o>=</span> <span class=n>sm</span><span class=o>.</span><span class=n>OLS</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>X</span><span class=p>)</span><span class=o>.</span><span class=n>fit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 因子贡献</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_contributions</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>factor_name</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>factor_names</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_contributions</span><span class=p>[</span><span class=n>factor_name</span><span class=p>]</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span> <span class=o>*</span> <span class=n>factor_returns</span><span class=o>.</span><span class=n>iloc</span><span class=p>[:,</span> <span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>*</span> <span class=mi>252</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>attribution</span><span class=p>[</span><span class=s1>&#39;factor_contributions&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>factor_contributions</span>
</span></span><span class=line><span class=cl>    <span class=n>attribution</span><span class=p>[</span><span class=s1>&#39;alpha&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=mi>252</span>  <span class=c1># 年化Alpha</span>
</span></span><span class=line><span class=cl>    <span class=n>attribution</span><span class=p>[</span><span class=s1>&#39;r_squared&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>rsquared</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 风格分析</span>
</span></span><span class=line><span class=cl>    <span class=n>style_weights</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=n>total_weight</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>model</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=mi>1</span><span class=p>:]))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>factor_name</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>factor_names</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>style_weights</span><span class=p>[</span><span class=n>factor_name</span><span class=p>]</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>model</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=n>total_weight</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>attribution</span><span class=p>[</span><span class=s1>&#39;style_weights&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>style_weights</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>attribution</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_timing_attribution</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>benchmark_returns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算择时能力
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>timing</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算月度收益率</span>
</span></span><span class=line><span class=cl>    <span class=n>monthly_returns</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>resample</span><span class=p>(</span><span class=s1>&#39;M&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>x</span><span class=p>)</span><span class=o>.</span><span class=n>prod</span><span class=p>()</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>monthly_benchmark</span> <span class=o>=</span> <span class=n>benchmark_returns</span><span class=o>.</span><span class=n>resample</span><span class=p>(</span><span class=s1>&#39;M&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>x</span><span class=p>)</span><span class=o>.</span><span class=n>prod</span><span class=p>()</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算择时指标</span>
</span></span><span class=line><span class=cl>    <span class=n>up_months</span> <span class=o>=</span> <span class=n>monthly_benchmark</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>down_months</span> <span class=o>=</span> <span class=n>monthly_benchmark</span> <span class=o>&lt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>up_months</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>timing</span><span class=p>[</span><span class=s1>&#39;up_capture&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>monthly_returns</span><span class=p>[</span><span class=n>up_months</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>timing</span><span class=p>[</span><span class=s1>&#39;up_average&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>monthly_returns</span><span class=p>[</span><span class=n>up_months</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>down_months</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>timing</span><span class=p>[</span><span class=s1>&#39;down_capture&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>monthly_returns</span><span class=p>[</span><span class=n>down_months</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>timing</span><span class=p>[</span><span class=s1>&#39;down_average&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>monthly_returns</span><span class=p>[</span><span class=n>down_months</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 择时能力评分</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;up_capture&#39;</span> <span class=ow>in</span> <span class=n>timing</span> <span class=ow>and</span> <span class=s1>&#39;down_capture&#39;</span> <span class=ow>in</span> <span class=n>timing</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>timing</span><span class=p>[</span><span class=s1>&#39;timing_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>timing</span><span class=p>[</span><span class=s1>&#39;up_capture&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>timing</span><span class=p>[</span><span class=s1>&#39;down_capture&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>timing</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_performance_summary</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>benchmark_returns</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>strategy_name</span><span class=o>=</span><span class=s2>&#34;策略&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    生成绩效摘要
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 计算所有指标</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span> <span class=o>=</span> <span class=n>calculate_comprehensive_metrics</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>benchmark_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 创建摘要</span>
</span></span><span class=line><span class=cl>    <span class=n>summary</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=si>{</span><span class=n>strategy_name</span><span class=si>}</span><span class=s2> 绩效摘要
</span></span></span><span class=line><span class=cl><span class=s2>    ========================
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    收益指标:
</span></span></span><span class=line><span class=cl><span class=s2>    - 总收益率: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;total_return&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    - 年化收益率: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;annual_return&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    - 日平均收益率: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;mean_daily_return&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.3%</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    风险指标:
</span></span></span><span class=line><span class=cl><span class=s2>    - 年化波动率: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;volatility&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    - 最大回撤: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    - 回撤持续时间: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;max_drawdown_duration&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>天
</span></span></span><span class=line><span class=cl><span class=s2>    - VaR (95%): </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;var&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    风险调整后收益:
</span></span></span><span class=line><span class=cl><span class=s2>    - 夏普比率: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    - 索提诺比率: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;sortino_ratio&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    - 卡尔马比率: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;calmar_ratio&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    交易统计:
</span></span></span><span class=line><span class=cl><span class=s2>    - 胜率: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;positive_ratio&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    - 盈亏比: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;profit_factor&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    - 最大单日收益: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;max_daily_gain&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    - 最大单日损失: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;max_daily_loss&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>benchmark_returns</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>summary</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    相对表现:
</span></span></span><span class=line><span class=cl><span class=s2>    - 年化超额收益: </span><span class=si>{</span><span class=n>metrics</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;excess_return&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    - 信息比率: </span><span class=si>{</span><span class=n>metrics</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;information_ratio&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    - 跟踪误差: </span><span class=si>{</span><span class=n>metrics</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;tracking_error&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>summary</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=回测结果分析>回测结果分析</h2><h3 id=结果可视化>结果可视化</h3><p>可视化帮助理解策略表现：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>plot_backtest_results</span><span class=p>(</span><span class=n>results</span><span class=p>,</span> <span class=n>benchmark_returns</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    绘制回测结果
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>seaborn</span> <span class=k>as</span> <span class=nn>sns</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 设置图形样式</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>style</span><span class=o>.</span><span class=n>use</span><span class=p>(</span><span class=s1>&#39;seaborn-v0_8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sns</span><span class=o>.</span><span class=n>set_palette</span><span class=p>(</span><span class=s2>&#34;husl&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 创建子图</span>
</span></span><span class=line><span class=cl>    <span class=n>fig</span><span class=p>,</span> <span class=n>axes</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>fig</span><span class=o>.</span><span class=n>suptitle</span><span class=p>(</span><span class=s1>&#39;回测结果分析&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 1. 净值曲线</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>cumulative_returns</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>])</span><span class=o>.</span><span class=n>cumprod</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>cumulative_returns</span><span class=o>.</span><span class=n>index</span><span class=p>,</span> <span class=n>cumulative_returns</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;策略&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>benchmark_returns</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>benchmark_cumulative</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>benchmark_returns</span><span class=p>)</span><span class=o>.</span><span class=n>cumprod</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>ax1</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>benchmark_cumulative</span><span class=o>.</span><span class=n>index</span><span class=p>,</span> <span class=n>benchmark_cumulative</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>label</span><span class=o>=</span><span class=s1>&#39;基准&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;累计收益率&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;累计净值&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ax1</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 2. 回撤图</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>drawdown</span> <span class=o>=</span> <span class=n>calculate_drawdown_series</span><span class=p>(</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>fill_between</span><span class=p>(</span><span class=n>drawdown</span><span class=o>.</span><span class=n>index</span><span class=p>,</span> <span class=n>drawdown</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>drawdown</span><span class=o>.</span><span class=n>index</span><span class=p>,</span> <span class=n>drawdown</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;回撤分析&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;回撤幅度&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax2</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 3. 收益分布</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>returns</span> <span class=o>=</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>hist</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>bins</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span> <span class=n>density</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 添加正态分布对比</span>
</span></span><span class=line><span class=cl>    <span class=n>mu</span><span class=p>,</span> <span class=n>sigma</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span> <span class=n>returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=n>returns</span><span class=o>.</span><span class=n>min</span><span class=p>(),</span> <span class=n>returns</span><span class=o>.</span><span class=n>max</span><span class=p>(),</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>pdf</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>mu</span><span class=p>,</span> <span class=n>sigma</span><span class=p>),</span> <span class=s1>&#39;r-&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;正态分布&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;日收益率分布&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;日收益率&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;密度&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ax3</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 4. 月度收益热力图</span>
</span></span><span class=line><span class=cl>    <span class=n>ax4</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>monthly_returns</span> <span class=o>=</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>resample</span><span class=p>(</span><span class=s1>&#39;M&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>x</span><span class=p>)</span><span class=o>.</span><span class=n>prod</span><span class=p>()</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>monthly_data</span> <span class=o>=</span> <span class=n>monthly_returns</span><span class=o>.</span><span class=n>groupby</span><span class=p>([</span><span class=n>monthly_returns</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>year</span><span class=p>,</span> <span class=n>monthly_returns</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>month</span><span class=p>])</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>monthly_matrix</span> <span class=o>=</span> <span class=n>monthly_data</span><span class=o>.</span><span class=n>unstack</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>sns</span><span class=o>.</span><span class=n>heatmap</span><span class=p>(</span><span class=n>monthly_matrix</span><span class=p>,</span> <span class=n>annot</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>fmt</span><span class=o>=</span><span class=s1>&#39;.2%&#39;</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;RdYlGn&#39;</span><span class=p>,</span> <span class=n>center</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>ax</span><span class=o>=</span><span class=n>ax4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax4</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;月度收益率热力图&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax4</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;月份&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax4</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;年份&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>fig</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_performance_dashboard</span><span class=p>(</span><span class=n>results</span><span class=p>,</span> <span class=n>benchmark_returns</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    创建绩效仪表板
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>dashboard</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算所有指标</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span> <span class=o>=</span> <span class=n>calculate_comprehensive_metrics</span><span class=p>(</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>],</span> <span class=n>benchmark_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 关键指标仪表板</span>
</span></span><span class=line><span class=cl>    <span class=n>dashboard</span><span class=p>[</span><span class=s1>&#39;key_metrics&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;总收益率&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;total_return&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;年化收益率&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;annual_return&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;最大回撤&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;夏普比率&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;胜率&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;positive_ratio&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;盈亏比&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;profit_factor&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 月度表现</span>
</span></span><span class=line><span class=cl>    <span class=n>monthly_returns</span> <span class=o>=</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>resample</span><span class=p>(</span><span class=s1>&#39;M&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>x</span><span class=p>)</span><span class=o>.</span><span class=n>prod</span><span class=p>()</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>dashboard</span><span class=p>[</span><span class=s1>&#39;monthly_performance&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;positive_months&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>monthly_returns</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;negative_months&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>monthly_returns</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;best_month&#39;</span><span class=p>:</span> <span class=n>monthly_returns</span><span class=o>.</span><span class=n>max</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;worst_month&#39;</span><span class=p>:</span> <span class=n>monthly_returns</span><span class=o>.</span><span class=n>min</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;avg_monthly_return&#39;</span><span class=p>:</span> <span class=n>monthly_returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 年度表现</span>
</span></span><span class=line><span class=cl>    <span class=n>yearly_returns</span> <span class=o>=</span> <span class=n>calculate_calendar_year_returns</span><span class=p>(</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>dashboard</span><span class=p>[</span><span class=s1>&#39;yearly_performance&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>yearly_returns</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 滚动表现</span>
</span></span><span class=line><span class=cl>    <span class=n>rolling_1y</span> <span class=o>=</span> <span class=n>calculate_rolling_returns</span><span class=p>(</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>],</span> <span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rolling_6m</span> <span class=o>=</span> <span class=n>calculate_rolling_returns</span><span class=p>(</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>],</span> <span class=mi>126</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rolling_3m</span> <span class=o>=</span> <span class=n>calculate_rolling_returns</span><span class=p>(</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>],</span> <span class=mi>63</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>dashboard</span><span class=p>[</span><span class=s1>&#39;rolling_performance&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;1_year&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;avg&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>rolling_1y</span><span class=o>.</span><span class=n>values</span><span class=p>())),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;min&#39;</span><span class=p>:</span> <span class=nb>min</span><span class=p>(</span><span class=n>rolling_1y</span><span class=o>.</span><span class=n>values</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max&#39;</span><span class=p>:</span> <span class=nb>max</span><span class=p>(</span><span class=n>rolling_1y</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;6_month&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;avg&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>rolling_6m</span><span class=o>.</span><span class=n>values</span><span class=p>())),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;min&#39;</span><span class=p>:</span> <span class=nb>min</span><span class=p>(</span><span class=n>rolling_6m</span><span class=o>.</span><span class=n>values</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max&#39;</span><span class=p>:</span> <span class=nb>max</span><span class=p>(</span><span class=n>rolling_6m</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;3_month&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;avg&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>rolling_3m</span><span class=o>.</span><span class=n>values</span><span class=p>())),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;min&#39;</span><span class=p>:</span> <span class=nb>min</span><span class=p>(</span><span class=n>rolling_3m</span><span class=o>.</span><span class=n>values</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max&#39;</span><span class=p>:</span> <span class=nb>max</span><span class=p>(</span><span class=n>rolling_3m</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>dashboard</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>analyze_strategy_stability</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>window</span><span class=o>=</span><span class=mi>60</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    分析策略稳定性
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stability</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 滚动夏普比率</span>
</span></span><span class=line><span class=cl>    <span class=n>rolling_sharpe</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>window</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>returns</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>period_returns</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>window</span><span class=p>:</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>period_returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sharpe</span> <span class=o>=</span> <span class=p>(</span><span class=n>period_returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=mf>0.03</span><span class=o>/</span><span class=mi>252</span><span class=p>)</span> <span class=o>/</span> <span class=n>period_returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>rolling_sharpe</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sharpe</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>stability</span><span class=p>[</span><span class=s1>&#39;rolling_sharpe&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;mean&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>rolling_sharpe</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;std&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>rolling_sharpe</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;min&#39;</span><span class=p>:</span> <span class=nb>min</span><span class=p>(</span><span class=n>rolling_sharpe</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;max&#39;</span><span class=p>:</span> <span class=nb>max</span><span class=p>(</span><span class=n>rolling_sharpe</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 滚动波动率</span>
</span></span><span class=line><span class=cl>    <span class=n>rolling_vol</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>window</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>returns</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>period_returns</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>window</span><span class=p>:</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>vol</span> <span class=o>=</span> <span class=n>period_returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>rolling_vol</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>vol</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>stability</span><span class=p>[</span><span class=s1>&#39;rolling_volatility&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;mean&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>rolling_vol</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;std&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>rolling_vol</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;min&#39;</span><span class=p>:</span> <span class=nb>min</span><span class=p>(</span><span class=n>rolling_vol</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;max&#39;</span><span class=p>:</span> <span class=nb>max</span><span class=p>(</span><span class=n>rolling_vol</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 稳定性评分</span>
</span></span><span class=line><span class=cl>    <span class=n>sharpe_stability</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>stability</span><span class=p>[</span><span class=s1>&#39;rolling_sharpe&#39;</span><span class=p>][</span><span class=s1>&#39;std&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>vol_stability</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>stability</span><span class=p>[</span><span class=s1>&#39;rolling_volatility&#39;</span><span class=p>][</span><span class=s1>&#39;std&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>stability</span><span class=p>[</span><span class=s1>&#39;overall_stability_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>sharpe_stability</span> <span class=o>+</span> <span class=n>vol_stability</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>stability</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>detect_strategy_regime_changes</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>benchmark_returns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    检测策略风格变化
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>sklearn.cluster</span> <span class=kn>import</span> <span class=n>KMeans</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>sklearn.preprocessing</span> <span class=kn>import</span> <span class=n>StandardScaler</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 创建特征</span>
</span></span><span class=line><span class=cl>    <span class=n>features</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;returns&#39;</span><span class=p>:</span> <span class=n>returns</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;benchmark&#39;</span><span class=p>:</span> <span class=n>benchmark_returns</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;relative_performance&#39;</span><span class=p>:</span> <span class=n>returns</span> <span class=o>-</span> <span class=n>benchmark_returns</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;volatility&#39;</span><span class=p>:</span> <span class=n>returns</span><span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>std</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;beta&#39;</span><span class=p>:</span> <span class=n>calculate_rolling_beta</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>benchmark_returns</span><span class=p>,</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 标准化特征</span>
</span></span><span class=line><span class=cl>    <span class=n>scaler</span> <span class=o>=</span> <span class=n>StandardScaler</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>scaled_features</span> <span class=o>=</span> <span class=n>scaler</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>features</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 聚类分析</span>
</span></span><span class=line><span class=cl>    <span class=n>kmeans</span> <span class=o>=</span> <span class=n>KMeans</span><span class=p>(</span><span class=n>n_clusters</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>regimes</span> <span class=o>=</span> <span class=n>kmeans</span><span class=o>.</span><span class=n>fit_predict</span><span class=p>(</span><span class=n>scaled_features</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 分析每个状态</span>
</span></span><span class=line><span class=cl>    <span class=n>regime_analysis</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>regime_mask</span> <span class=o>=</span> <span class=n>regimes</span> <span class=o>==</span> <span class=n>i</span>
</span></span><span class=line><span class=cl>        <span class=n>regime_returns</span> <span class=o>=</span> <span class=n>returns</span><span class=p>[</span><span class=n>regime_mask</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>regime_analysis</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;regime_</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;periods&#39;</span><span class=p>:</span> <span class=n>regime_mask</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;avg_return&#39;</span><span class=p>:</span> <span class=n>regime_returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>*</span> <span class=mi>252</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;volatility&#39;</span><span class=p>:</span> <span class=n>regime_returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>regime_returns</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>*</span> <span class=mi>252</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>regime_returns</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>regime_analysis</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_rolling_beta</span><span class=p>(</span><span class=n>returns</span><span class=p>,</span> <span class=n>benchmark_returns</span><span class=p>,</span> <span class=n>window</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算滚动Beta
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>rolling_beta</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>window</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>returns</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>period_returns</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>window</span><span class=p>:</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>period_benchmark</span> <span class=o>=</span> <span class=n>benchmark_returns</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>window</span><span class=p>:</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>period_returns</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span> <span class=ow>and</span> <span class=n>period_benchmark</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>covariance</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>cov</span><span class=p>(</span><span class=n>period_returns</span><span class=p>,</span> <span class=n>period_benchmark</span><span class=p>)[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>benchmark_variance</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>period_benchmark</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>beta</span> <span class=o>=</span> <span class=n>covariance</span> <span class=o>/</span> <span class=n>benchmark_variance</span>
</span></span><span class=line><span class=cl>            <span class=n>rolling_beta</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>beta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>rolling_beta</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>]</span> <span class=o>*</span> <span class=n>window</span> <span class=o>+</span> <span class=n>rolling_beta</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=n>returns</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_comprehensive_backtest_report</span><span class=p>(</span><span class=n>results</span><span class=p>,</span> <span class=n>benchmark_returns</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>strategy_name</span><span class=o>=</span><span class=s2>&#34;策略&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    生成综合回测报告
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 计算所有指标</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span> <span class=o>=</span> <span class=n>calculate_comprehensive_metrics</span><span class=p>(</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>],</span> <span class=n>benchmark_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 创建报告</span>
</span></span><span class=line><span class=cl>    <span class=n>report</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;strategy_name&#39;</span><span class=p>:</span> <span class=n>strategy_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;backtest_period&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;start_date&#39;</span><span class=p>:</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;end_date&#39;</span><span class=p>:</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>index</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_days&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;trading_days&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>][</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;performance_summary&#39;</span><span class=p>:</span> <span class=n>metrics</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;risk_analysis&#39;</span><span class=p>:</span> <span class=n>calculate_risk_metrics</span><span class=p>(</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;monthly_performance&#39;</span><span class=p>:</span> <span class=n>analyze_monthly_performance</span><span class=p>(</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;yearly_performance&#39;</span><span class=p>:</span> <span class=n>analyze_yearly_performance</span><span class=p>(</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;strategy_stability&#39;</span><span class=p>:</span> <span class=n>analyze_strategy_stability</span><span class=p>(</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>benchmark_returns</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>report</span><span class=p>[</span><span class=s1>&#39;benchmark_comparison&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;excess_returns&#39;</span><span class=p>:</span> <span class=n>calculate_return_metrics</span><span class=p>(</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>],</span> <span class=n>benchmark_returns</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timing_attribution&#39;</span><span class=p>:</span> <span class=n>calculate_timing_attribution</span><span class=p>(</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>],</span> <span class=n>benchmark_returns</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;regime_analysis&#39;</span><span class=p>:</span> <span class=n>detect_strategy_regime_changes</span><span class=p>(</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;returns&#39;</span><span class=p>],</span> <span class=n>benchmark_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>report</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>analyze_monthly_performance</span><span class=p>(</span><span class=n>returns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    分析月度表现
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>monthly_returns</span> <span class=o>=</span> <span class=n>returns</span><span class=o>.</span><span class=n>resample</span><span class=p>(</span><span class=s1>&#39;M&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>x</span><span class=p>)</span><span class=o>.</span><span class=n>prod</span><span class=p>()</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>monthly_stats</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;total_months&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>monthly_returns</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;positive_months&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>monthly_returns</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;negative_months&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>monthly_returns</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;best_month&#39;</span><span class=p>:</span> <span class=n>monthly_returns</span><span class=o>.</span><span class=n>max</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;worst_month&#39;</span><span class=p>:</span> <span class=n>monthly_returns</span><span class=o>.</span><span class=n>min</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;avg_positive_month&#39;</span><span class=p>:</span> <span class=n>monthly_returns</span><span class=p>[</span><span class=n>monthly_returns</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;avg_negative_month&#39;</span><span class=p>:</span> <span class=n>monthly_returns</span><span class=p>[</span><span class=n>monthly_returns</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;monthly_volatility&#39;</span><span class=p>:</span> <span class=n>monthly_returns</span><span class=o>.</span><span class=n>std</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;monthly_skewness&#39;</span><span class=p>:</span> <span class=n>monthly_returns</span><span class=o>.</span><span class=n>skew</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;monthly_kurtosis&#39;</span><span class=p>:</span> <span class=n>monthly_returns</span><span class=o>.</span><span class=n>kurtosis</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>monthly_stats</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>analyze_yearly_performance</span><span class=p>(</span><span class=n>returns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    分析年度表现
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>yearly_returns</span> <span class=o>=</span> <span class=n>calculate_calendar_year_returns</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>yearly_series</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>yearly_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>yearly_stats</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;years&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>yearly_series</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;positive_years&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>yearly_series</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;negative_years&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>yearly_series</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;best_year&#39;</span><span class=p>:</span> <span class=n>yearly_series</span><span class=o>.</span><span class=n>max</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;worst_year&#39;</span><span class=p>:</span> <span class=n>yearly_series</span><span class=o>.</span><span class=n>min</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;avg_return&#39;</span><span class=p>:</span> <span class=n>yearly_series</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;return_std&#39;</span><span class=p>:</span> <span class=n>yearly_series</span><span class=o>.</span><span class=n>std</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;consistency_score&#39;</span><span class=p>:</span> <span class=nb>min</span><span class=p>(</span><span class=n>yearly_series</span><span class=p>)</span> <span class=o>/</span> <span class=n>yearly_series</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=k>if</span> <span class=n>yearly_series</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>!=</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>yearly_stats</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>save_backtest_results</span><span class=p>(</span><span class=n>results</span><span class=p>,</span> <span class=n>filename</span><span class=o>=</span><span class=s2>&#34;backtest_results&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    保存回测结果
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>pickle</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 保存为pickle格式（完整数据）</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>filename</span><span class=si>}</span><span class=s2>.pkl&#34;</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>pickle</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>results</span><span class=p>,</span> <span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 保存为JSON格式（摘要信息）</span>
</span></span><span class=line><span class=cl>    <span class=n>summary</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;total_return&#39;</span><span class=p>:</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;total_return&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;annual_return&#39;</span><span class=p>:</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;annual_return&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;max_drawdown&#39;</span><span class=p>:</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>:</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;volatility&#39;</span><span class=p>:</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;volatility&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;win_rate&#39;</span><span class=p>:</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;win_rate&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>filename</span><span class=si>}</span><span class=s2>_summary.json&#34;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>summary</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;回测结果已保存到 </span><span class=si>{</span><span class=n>filename</span><span class=si>}</span><span class=s2>.pkl 和 </span><span class=si>{</span><span class=n>filename</span><span class=si>}</span><span class=s2>_summary.json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 回测示例</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== SuperMind回测系统与绩效评估 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;本讲介绍了回测系统的使用方法和绩效评估技巧&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;请在SuperMind平台上运行实际回测以验证策略效果&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=总结>总结</h2><p>本讲详细介绍了SuperMind平台回测系统的使用和策略绩效评估方法，包括：</p><ol><li><strong>回测系统架构</strong>：系统组成、参数配置、高级设置</li><li><strong>绩效评估指标</strong>：收益指标、风险指标、综合指标</li><li><strong>结果分析方法</strong>：可视化技巧、稳定性分析、归因分析</li><li><strong>报告生成</strong>：综合报告、月度分析、年度分析</li></ol><p>掌握回测和绩效评估是策略开发的关键环节，在下一讲中我们将学习策略优化技巧。</p></div></article><aside class="lg:w-80 xl:w-96"><div class=space-y-8></div></aside></div><nav class="border-t border-gray-200 mt-12 pt-8"><div class="flex justify-between items-center"><a href=/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/06-%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E7%AD%96%E7%95%A5%E5%BC%80%E5%8F%91/ class="group flex items-center"><svg class="w-5 h-5 mr-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0 7-7m-7 7h18"/></svg><div><div class="text-sm text-gray-600">上一篇</div><div class="font-medium group-hover:text-primary-600">SuperMind第6讲：事件驱动策略开发</div></div></a><a href=/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/08-%E7%AD%96%E7%95%A5%E4%BC%98%E5%8C%96%E4%B8%8E%E5%8F%82%E6%95%B0%E8%B0%83%E4%BC%98/ class="group flex items-center text-right"><div><div class="text-sm text-gray-600">Next Post</div><div class="font-medium group-hover:text-primary-600">SuperMind第8讲：策略优化与参数调优</div></div><svg class="w-5 h-5 ml-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0-7 7m7-7H3"/></svg></a></div></nav></div></div><footer class="bg-gray-50 py-12 border-t border-gray-200"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><div class="flex flex-col md:flex-row justify-between space-y-4 md:space-y-0"><div class=flex-1><div class="flex items-center space-x-3 mb-4"><a href=https://sk-quant.github.io/ class=inline-block><img src=/images/logo.svg alt=烧烤量化 class=h-6>
</a><span class="text-xl font-bold text-gray-900">烧烤量化</span></div><div class="flex space-x-3 p-2"></div></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div></div><div class="mt-12 pt-8 border-t border-gray-200"><div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0"><p class="text-gray-600 text-sm">© 2025 烧烤量化. All rights reserved.</p><a href=https://chaoming.li class="text-sm text-gray-600 hover:text-primary-600" target=_blank rel="noopener noreferrer">Powered by sk-quant</a></div></div></div></footer><script>const mobileMenuButton=document.getElementById("mobile-menu-button");mobileMenuButton&&mobileMenuButton.addEventListener("click",function(){const e=document.getElementById("mobile-menu");e&&e.classList.toggle("hidden")})</script></body></html>