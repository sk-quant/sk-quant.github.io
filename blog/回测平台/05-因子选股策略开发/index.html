<!doctype html><html lang=zh-cn class=h-full><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-XXXXXXX")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XXXXXXXXXX")</script><title>SuperMind第5讲：因子选股策略开发 | 烧烤量化</title>
<meta name=description content="学习在SuperMind平台上开发基于因子的选股策略"><meta name=author content="Ryan"><meta name=robots content="index, follow"><meta property="og:title" content="SuperMind第5讲：因子选股策略开发 | 烧烤量化"><meta property="og:description" content="学习在SuperMind平台上开发基于因子的选股策略"><meta property="og:type" content="article"><meta property="og:url" content="https://sk-quant.github.io/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/05-%E5%9B%A0%E5%AD%90%E9%80%89%E8%82%A1%E7%AD%96%E7%95%A5%E5%BC%80%E5%8F%91/"><meta property="og:site_name" content="烧烤量化"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="SuperMind第5讲：因子选股策略开发 | 烧烤量化"><meta name=twitter:description content="学习在SuperMind平台上开发基于因子的选股策略"><link rel=icon type=image/x-icon href=/images/favicon.ico><link rel=canonical href=https://sk-quant.github.io/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/05-%E5%9B%A0%E5%AD%90%E9%80%89%E8%82%A1%E7%AD%96%E7%95%A5%E5%BC%80%E5%8F%91/><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel=stylesheet><link rel=stylesheet href="/css/main.min.9a3c970d7feebe1317992d10ced98f226635b831a963ee601e5901734ff0da21.css"></head><body class="min-h-screen flex flex-col"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-XXXXXXX" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class="fixed top-0 left-0 right-0 z-50"><div class=mobile-menu-wrapper><input type=checkbox id=nav-toggle class=nav-toggle><header class="fixed w-full top-0 z-50 bg-white/80 backdrop-blur-sm border-b border-gray-100"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><nav class="flex items-center justify-between h-20"><a href=https://sk-quant.github.io/ class="flex items-center space-x-4"><img src=/images/logo.svg alt=烧烤量化 class=h-12>
<span class="text-3xl font-semibold text-gray-800">烧烤量化</span></a><div class="hidden md:flex items-center space-x-8"><a href=/path class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">学习路线</a><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化基础<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">回测平台</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化进阶<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">综合实战</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化高手<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股指期货</a></div></div></div><a href=/pricing class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">服务套餐</a></div><div class="hidden md:flex items-center space-x-4"><a href=/contact class="inline-flex items-center justify-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div><div class=md:hidden><label for=nav-toggle class="p-2 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-offset-2 transition-colors cursor-pointer"><svg class="w-6 h-6" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></label></div></nav></div><div class="nav-content md:hidden w-full fixed left-0 right-0 top-20 bg-white border-t border-gray-100 shadow-lg"><div class="w-full px-6 py-4"><a href=/path class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">学习路线</a><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化基础</div><div class=pl-4><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block text-gray-700 hover:text-primary-600 py-2">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block text-gray-700 hover:text-primary-600 py-2">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block text-gray-700 hover:text-primary-600 py-2">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block text-gray-700 hover:text-primary-600 py-2">回测平台</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化进阶</div><div class=pl-4><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block text-gray-700 hover:text-primary-600 py-2">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block text-gray-700 hover:text-primary-600 py-2">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block text-gray-700 hover:text-primary-600 py-2">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block text-gray-700 hover:text-primary-600 py-2">综合实战</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化高手</div><div class=pl-4><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block text-gray-700 hover:text-primary-600 py-2">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block text-gray-700 hover:text-primary-600 py-2">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block text-gray-700 hover:text-primary-600 py-2">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block text-gray-700 hover:text-primary-600 py-2">股指期货</a></div></div><a href=/pricing class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">服务套餐</a><div class="pt-4 space-y-4"><a href=/contact class="block text-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div></div></div></header><style>.mobile-menu-wrapper{position:relative}.nav-toggle{display:none}.nav-content{display:none}.nav-toggle:checked~header .nav-content{display:block}</style></div></div><div class=pt-20><div class="container mx-auto px-4 py-12"><div class="flex flex-col lg:flex-row gap-8 mb-12"><article class=flex-1><header class=mb-8><div class=mb-4><a href=/categories/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0 class="inline-block px-3 py-1 text-sm font-medium text-primary-600 bg-primary-50 rounded-full hover:bg-primary-100 mr-2">回测平台</a></div><h1 class="text-4xl font-bold mb-4">SuperMind第5讲：因子选股策略开发</h1><div class="flex flex-col space-y-4"><div class="flex items-center justify-between text-sm text-gray-500"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7A4 4 0 118 7a4 4 0 018 0zm-4 7a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
<span>Ryan</span></div><div class="flex items-center space-x-6"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747.0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746.0-3.332.477-4.5 1.253"/></svg>
<span>18 分钟</span></div><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5A2 2 0 003 7v12a2 2 0 002 2z"/></svg>
<time datetime=2025-09-25>September 25, 2025</time></div></div></div><div class="flex items-center flex-wrap gap-2"><a href=/tags/2025 class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors duration-200">#2025
</a><a href=/tags/supermind class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors duration-200">#SuperMind</a></div></div></header><div class=mb-8><img src=/images/blog/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0.jpg alt=SuperMind第5讲：因子选股策略开发 class="w-full h-auto rounded-lg" loading=lazy></div><div class="prose prose-lg max-w-none"><h2 id=学习目标>学习目标</h2><ul><li>理解因子投资的基本概念和理论</li><li>掌握SuperMind平台因子数据的获取和处理</li><li>学会构建单因子和多因子选股策略</li><li>掌握因子有效性检验和策略优化方法</li></ul><div class="bg-gray-50 p-6 rounded-lg mb-8"><h2 class="text-xl font-semibold mb-4">目录</h2><nav id=TableOfContents><ul><li><a href=#学习目标>学习目标</a></li><li><a href=#因子投资基础>因子投资基础</a><ul><li><a href=#因子概念与分类>因子概念与分类</a></li><li><a href=#因子数据处理>因子数据处理</a></li></ul></li><li><a href=#单因子选股策略>单因子选股策略</a><ul><li><a href=#估值因子策略>估值因子策略</a></li><li><a href=#成长因子策略>成长因子策略</a></li></ul></li><li><a href=#多因子选股策略>多因子选股策略</a><ul><li><a href=#因子合成方法>因子合成方法</a></li><li><a href=#经典多因子模型>经典多因子模型</a></li></ul></li><li><a href=#因子有效性检验>因子有效性检验</a><ul><li><a href=#ic分析>IC分析</a></li></ul></li><li><a href=#完整因子选股策略实现>完整因子选股策略实现</a></li><li><a href=#总结>总结</a></li></ul></nav></div><h2 id=因子投资基础>因子投资基础</h2><h3 id=因子概念与分类>因子概念与分类</h3><p>因子是解释股票收益差异的共同特征，是量化投资的核心工具：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>factor_investment_overview</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    因子投资概览
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>factors</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;估值因子&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;PE&#39;</span><span class=p>:</span> <span class=s1>&#39;市盈率 = 股价 / 每股收益&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;PB&#39;</span><span class=p>:</span> <span class=s1>&#39;市净率 = 股价 / 每股净资产&#39;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=s1>&#39;PS&#39;</span><span class=p>:</span> <span class=s1>&#39;市销率 = 股价 / 每股销售收入&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;PCF&#39;</span><span class=p>:</span> <span class=s1>&#39;市现率 = 股价 / 每股现金流&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;PEG&#39;</span><span class=p>:</span> <span class=s1>&#39;市盈率相对盈利增长比率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;EV_EBITDA&#39;</span><span class=p>:</span> <span class=s1>&#39;企业价值倍数&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;成长因子&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Revenue_Growth&#39;</span><span class=p>:</span> <span class=s1>&#39;营收增长率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Profit_Growth&#39;</span><span class=p>:</span> <span class=s1>&#39;利润增长率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;EPS_Growth&#39;</span><span class=p>:</span> <span class=s1>&#39;每股收益增长率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;ROE_Growth&#39;</span><span class=p>:</span> <span class=s1>&#39;净资产收益率增长率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Asset_Growth&#39;</span><span class=p>:</span> <span class=s1>&#39;资产增长率&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;盈利因子&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;ROE&#39;</span><span class=p>:</span> <span class=s1>&#39;净资产收益率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;ROA&#39;</span><span class=p>:</span> <span class=s1>&#39;总资产收益率&#39;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=s1>&#39;ROIC&#39;</span><span class=p>:</span> <span class=s1>&#39;投资资本回报率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Gross_Margin&#39;</span><span class=p>:</span> <span class=s1>&#39;毛利率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Net_Margin&#39;</span><span class=p>:</span> <span class=s1>&#39;净利率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;EBITDA_Margin&#39;</span><span class=p>:</span> <span class=s1>&#39;EBITDA利润率&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;质量因子&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Debt_Equity&#39;</span><span class=p>:</span> <span class=s1>&#39;债务股本比&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Current_Ratio&#39;</span><span class=p>:</span> <span class=s1>&#39;流动比率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Quick_Ratio&#39;</span><span class=p>:</span> <span class=s1>&#39;速动比率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Cash_Ratio&#39;</span><span class=p>:</span> <span class=s1>&#39;现金比率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Asset_Turnover&#39;</span><span class=p>:</span> <span class=s1>&#39;资产周转率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Inventory_Turnover&#39;</span><span class=p>:</span> <span class=s1>&#39;存货周转率&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;技术因子&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Momentum_1M&#39;</span><span class=p>:</span> <span class=s1>&#39;1个月动量&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Momentum_3M&#39;</span><span class=p>:</span> <span class=s1>&#39;3个月动量&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Momentum_6M&#39;</span><span class=p>:</span> <span class=s1>&#39;6个月动量&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Volatility_1M&#39;</span><span class=p>:</span> <span class=s1>&#39;1个月波动率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Turnover_1M&#39;</span><span class=p>:</span> <span class=s1>&#39;1个月换手率&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Max_Drawdown&#39;</span><span class=p>:</span> <span class=s1>&#39;最大回撤&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;规模因子&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Market_Cap&#39;</span><span class=p>:</span> <span class=s1>&#39;总市值&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Free_Float_Cap&#39;</span><span class=p>:</span> <span class=s1>&#39;流通市值&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Total_Assets&#39;</span><span class=p>:</span> <span class=s1>&#39;总资产&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Revenue&#39;</span><span class=p>:</span> <span class=s1>&#39;营业收入&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>factors</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_factor_data</span><span class=p>(</span><span class=n>stock_list</span><span class=p>,</span> <span class=n>date</span><span class=p>,</span> <span class=n>factor_list</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取因子数据
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 使用SuperMind的因子数据接口</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>=</span> <span class=n>query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>pe</span><span class=p>,</span>           <span class=c1># 市盈率</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>pb</span><span class=p>,</span>           <span class=c1># 市净率</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>ps</span><span class=p>,</span>           <span class=c1># 市销率</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>roe</span><span class=p>,</span>          <span class=c1># 净资产收益率</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>roa</span><span class=p>,</span>          <span class=c1># 总资产收益率</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>net_profit_growth_rate</span><span class=p>,</span>  <span class=c1># 净利润增长率</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>revenue_growth_rate</span><span class=p>,</span>     <span class=c1># 营收增长率</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>debt_to_asset_ratio</span><span class=p>,</span>     <span class=c1># 资产负债率</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>current_ratio</span><span class=p>,</span>           <span class=c1># 流动比率</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>total_market_cap</span>         <span class=c1># 总市值</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>in_</span><span class=p>(</span><span class=n>stock_list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取因子数据</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>get_factors</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>date</span><span class=o>=</span><span class=n>date</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>factor_df</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=因子数据处理>因子数据处理</h3><p>因子数据需要进行标准化、中性化等处理：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_factor_data</span><span class=p>(</span><span class=n>factor_df</span><span class=p>,</span> <span class=n>industry_neutral</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>size_neutral</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    因子数据处理
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1. 去极值处理（Winsorize）</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>winsorize_series</span><span class=p>(</span><span class=n>series</span><span class=p>,</span> <span class=n>lower</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>upper</span><span class=o>=</span><span class=mf>0.95</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        去极值处理
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>lower_bound</span> <span class=o>=</span> <span class=n>series</span><span class=o>.</span><span class=n>quantile</span><span class=p>(</span><span class=n>lower</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>upper_bound</span> <span class=o>=</span> <span class=n>series</span><span class=o>.</span><span class=n>quantile</span><span class=p>(</span><span class=n>upper</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>series</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>lower</span><span class=o>=</span><span class=n>lower_bound</span><span class=p>,</span> <span class=n>upper</span><span class=o>=</span><span class=n>upper_bound</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 2. 标准化处理（Z-score）</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>standardize_series</span><span class=p>(</span><span class=n>series</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        标准化处理
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>series</span> <span class=o>-</span> <span class=n>series</span><span class=o>.</span><span class=n>mean</span><span class=p>())</span> <span class=o>/</span> <span class=n>series</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 3. 行业中性化</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>industry_neutralize</span><span class=p>(</span><span class=n>factor_series</span><span class=p>,</span> <span class=n>industry_series</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        行业中性化
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 对每个行业分别标准化</span>
</span></span><span class=line><span class=cl>        <span class=n>neutralized_series</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>factor_series</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>industry</span> <span class=ow>in</span> <span class=n>industry_series</span><span class=o>.</span><span class=n>unique</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>industry_mask</span> <span class=o>=</span> <span class=n>industry_series</span> <span class=o>==</span> <span class=n>industry</span>
</span></span><span class=line><span class=cl>            <span class=n>industry_factor</span> <span class=o>=</span> <span class=n>factor_series</span><span class=p>[</span><span class=n>industry_mask</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>industry_factor</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>neutralized_series</span><span class=p>[</span><span class=n>industry_mask</span><span class=p>]</span> <span class=o>=</span> <span class=n>standardize_series</span><span class=p>(</span><span class=n>industry_factor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>neutralized_series</span><span class=p>[</span><span class=n>industry_mask</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>neutralized_series</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 4. 市值中性化</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>size_neutralize</span><span class=p>(</span><span class=n>factor_series</span><span class=p>,</span> <span class=n>size_series</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        市值中性化（回归残差法）
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 对数化处理</span>
</span></span><span class=line><span class=cl>        <span class=n>log_size</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>size_series</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 线性回归</span>
</span></span><span class=line><span class=cl>        <span class=n>X</span> <span class=o>=</span> <span class=n>sm</span><span class=o>.</span><span class=n>add_constant</span><span class=p>(</span><span class=n>log_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span> <span class=o>=</span> <span class=n>sm</span><span class=o>.</span><span class=n>OLS</span><span class=p>(</span><span class=n>factor_series</span><span class=p>,</span> <span class=n>X</span><span class=p>)</span><span class=o>.</span><span class=n>fit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 取残差</span>
</span></span><span class=line><span class=cl>        <span class=n>residuals</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>resid</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>standardize_series</span><span class=p>(</span><span class=n>residuals</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 处理每个因子</span>
</span></span><span class=line><span class=cl>    <span class=n>processed_df</span> <span class=o>=</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 因子列（假设除了symbol和行业、市值列）</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_columns</span> <span class=o>=</span> <span class=p>[</span><span class=n>col</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>columns</span> 
</span></span><span class=line><span class=cl>                     <span class=k>if</span> <span class=n>col</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>,</span> <span class=s1>&#39;industry&#39;</span><span class=p>,</span> <span class=s1>&#39;total_market_cap&#39;</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>factor_col</span> <span class=ow>in</span> <span class=n>factor_columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 去极值</span>
</span></span><span class=line><span class=cl>        <span class=n>processed_df</span><span class=p>[</span><span class=n>factor_col</span><span class=p>]</span> <span class=o>=</span> <span class=n>winsorize_series</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=n>factor_col</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 行业中性化</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>industry_neutral</span> <span class=ow>and</span> <span class=s1>&#39;industry&#39;</span> <span class=ow>in</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>processed_df</span><span class=p>[</span><span class=n>factor_col</span><span class=p>]</span> <span class=o>=</span> <span class=n>industry_neutralize</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>processed_df</span><span class=p>[</span><span class=n>factor_col</span><span class=p>],</span> <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;industry&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 市值中性化</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>size_neutral</span> <span class=ow>and</span> <span class=s1>&#39;total_market_cap&#39;</span> <span class=ow>in</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>processed_df</span><span class=p>[</span><span class=n>factor_col</span><span class=p>]</span> <span class=o>=</span> <span class=n>size_neutralize</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>processed_df</span><span class=p>[</span><span class=n>factor_col</span><span class=p>],</span> <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;total_market_cap&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 最终标准化</span>
</span></span><span class=line><span class=cl>        <span class=n>processed_df</span><span class=p>[</span><span class=n>factor_col</span><span class=p>]</span> <span class=o>=</span> <span class=n>standardize_series</span><span class=p>(</span><span class=n>processed_df</span><span class=p>[</span><span class=n>factor_col</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>processed_df</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_factor_returns</span><span class=p>(</span><span class=n>factor_df</span><span class=p>,</span> <span class=n>holding_period</span><span class=o>=</span><span class=mi>20</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算因子收益
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 获取未来收益率</span>
</span></span><span class=line><span class=cl>    <span class=n>future_returns</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>symbol</span> <span class=ow>in</span> <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 获取未来holding_period天的收益率</span>
</span></span><span class=line><span class=cl>        <span class=n>future_return</span> <span class=o>=</span> <span class=n>get_future_return</span><span class=p>(</span><span class=n>symbol</span><span class=p>,</span> <span class=n>holding_period</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>future_returns</span><span class=p>[</span><span class=n>symbol</span><span class=p>]</span> <span class=o>=</span> <span class=n>future_return</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 添加到因子数据框</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;future_return&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>future_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>factor_df</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_future_return</span><span class=p>(</span><span class=n>symbol</span><span class=p>,</span> <span class=n>days</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取未来收益率
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 获取当前价格</span>
</span></span><span class=line><span class=cl>    <span class=n>current_price</span> <span class=o>=</span> <span class=n>get_current_price</span><span class=p>(</span><span class=n>symbol</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取未来价格</span>
</span></span><span class=line><span class=cl>    <span class=n>future_price</span> <span class=o>=</span> <span class=n>get_price</span><span class=p>(</span><span class=n>symbol</span><span class=p>,</span> <span class=n>count</span><span class=o>=</span><span class=n>days</span><span class=p>)</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>][</span><span class=s1>&#39;close&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算收益率</span>
</span></span><span class=line><span class=cl>    <span class=n>future_return</span> <span class=o>=</span> <span class=p>(</span><span class=n>future_price</span> <span class=o>-</span> <span class=n>current_price</span><span class=p>)</span> <span class=o>/</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>future_return</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=单因子选股策略>单因子选股策略</h2><h3 id=估值因子策略>估值因子策略</h3><p>估值因子是最常用的选股因子之一：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pe_strategy</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    市盈率选股策略 - 低PE策略
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 获取股票池</span>
</span></span><span class=line><span class=cl>    <span class=n>stock_list</span> <span class=o>=</span> <span class=n>get_stock_list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取因子数据</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>=</span> <span class=n>query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>pe</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>market_cap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>industry</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>in_</span><span class=p>(</span><span class=n>stock_list</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>pe</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span>           <span class=c1># PE为正</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>pe</span> <span class=o>&lt;</span> <span class=mi>50</span><span class=p>,</span>          <span class=c1># PE不太高</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>market_cap</span> <span class=o>&gt;</span> <span class=mi>50</span>   <span class=c1># 市值大于50亿</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>get_factors</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>date</span><span class=o>=</span><span class=n>context</span><span class=o>.</span><span class=n>current_date</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 数据处理</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>process_factor_data</span><span class=p>(</span><span class=n>factor_df</span><span class=p>,</span> <span class=n>industry_neutral</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>size_neutral</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 按PE因子排序（PE越低越好）</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=s1>&#39;pe&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 选择PE最低的20只股票</span>
</span></span><span class=line><span class=cl>    <span class=n>selected_stocks</span> <span class=o>=</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>head</span><span class=p>(</span><span class=mi>20</span><span class=p>)[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>selected_stocks</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pb_strategy</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    市净率选股策略 - 低PB策略
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock_list</span> <span class=o>=</span> <span class=n>get_stock_list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>=</span> <span class=n>query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>pb</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>roe</span><span class=p>,</span>              <span class=c1># 加入ROE过滤</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>debt_to_equity</span>    <span class=c1># 债务水平</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>in_</span><span class=p>(</span><span class=n>stock_list</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>pb</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>pb</span> <span class=o>&lt;</span> <span class=mi>5</span><span class=p>,</span>           <span class=c1># PB不太高</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>roe</span> <span class=o>&gt;</span> <span class=mf>0.1</span><span class=p>,</span>        <span class=c1># ROE大于10%</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>debt_to_equity</span> <span class=o>&lt;</span> <span class=mf>0.7</span>  <span class=c1># 负债率不太高</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>get_factors</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>date</span><span class=o>=</span><span class=n>context</span><span class=o>.</span><span class=n>current_date</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 因子组合：低PB + 高ROE</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;combined_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;pb&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;roe&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 排序选择</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=s1>&#39;combined_score&#39;</span><span class=p>,</span> <span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>selected_stocks</span> <span class=o>=</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>head</span><span class=p>(</span><span class=mi>20</span><span class=p>)[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>selected_stocks</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>dividend_yield_strategy</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    股息率选股策略
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock_list</span> <span class=o>=</span> <span class=n>get_stock_list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>=</span> <span class=n>query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>dividend_yield</span><span class=p>,</span>   <span class=c1># 股息率</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>dividend_payout</span><span class=p>,</span>  <span class=c1># 分红率</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>eps</span><span class=p>,</span>              <span class=c1># 每股收益</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>debt_to_equity</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>in_</span><span class=p>(</span><span class=n>stock_list</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>dividend_yield</span> <span class=o>&gt;</span> <span class=mf>0.03</span><span class=p>,</span>     <span class=c1># 股息率大于3%</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>dividend_payout</span> <span class=o>&lt;</span> <span class=mf>0.8</span><span class=p>,</span>    <span class=c1># 分红率不太高（可持续性）</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>eps</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span>                  <span class=c1># 盈利为正</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>debt_to_equity</span> <span class=o>&lt;</span> <span class=mf>0.6</span>      <span class=c1># 负债率不高</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>get_factors</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>date</span><span class=o>=</span><span class=n>context</span><span class=o>.</span><span class=n>current_date</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 按股息率排序</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=s1>&#39;dividend_yield&#39;</span><span class=p>,</span> <span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>selected_stocks</span> <span class=o>=</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>head</span><span class=p>(</span><span class=mi>15</span><span class=p>)[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>selected_stocks</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=成长因子策略>成长因子策略</h3><p>成长因子关注公司的成长性和盈利能力：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>growth_momentum_strategy</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    成长动量策略
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock_list</span> <span class=o>=</span> <span class=n>get_stock_list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>=</span> <span class=n>query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>revenue_growth_rate</span><span class=p>,</span>     <span class=c1># 营收增长率</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>net_profit_growth_rate</span><span class=p>,</span>  <span class=c1># 净利润增长率</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>roe</span><span class=p>,</span>                     <span class=c1># 净资产收益率</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>roa</span><span class=p>,</span>                     <span class=c1># 总资产收益率</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>gross_margin</span><span class=p>,</span>            <span class=c1># 毛利率</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>market_cap</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>in_</span><span class=p>(</span><span class=n>stock_list</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>revenue_growth_rate</span> <span class=o>&gt;</span> <span class=mf>0.15</span><span class=p>,</span>     <span class=c1># 营收增长&gt;15%</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>net_profit_growth_rate</span> <span class=o>&gt;</span> <span class=mf>0.2</span><span class=p>,</span>   <span class=c1># 净利润增长&gt;20%</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>roe</span> <span class=o>&gt;</span> <span class=mf>0.15</span><span class=p>,</span>                     <span class=c1># ROE&gt;15%</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>gross_margin</span> <span class=o>&gt;</span> <span class=mf>0.2</span><span class=p>,</span>             <span class=c1># 毛利率&gt;20%</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>market_cap</span> <span class=o>&gt;</span> <span class=mi>20</span>                 <span class=c1># 市值&gt;20亿</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>get_factors</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>date</span><span class=o>=</span><span class=n>context</span><span class=o>.</span><span class=n>current_date</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 构建成长综合评分</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;growth_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;revenue_growth_rate&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.3</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;net_profit_growth_rate&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.3</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;roe&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.2</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;roa&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.1</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;gross_margin&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.1</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 排序选择</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=s1>&#39;growth_score&#39;</span><span class=p>,</span> <span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>selected_stocks</span> <span class=o>=</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>head</span><span class=p>(</span><span class=mi>20</span><span class=p>)[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>selected_stocks</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>quality_growth_strategy</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    质量成长策略 - 高质量成长股
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock_list</span> <span class=o>=</span> <span class=n>get_stock_list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>=</span> <span class=n>query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>roe</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>roa</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>debt_to_equity</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>current_ratio</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>asset_turnover</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>revenue_growth_rate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>earnings_stability</span>  <span class=c1># 盈利稳定性</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>in_</span><span class=p>(</span><span class=n>stock_list</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>roe</span> <span class=o>&gt;</span> <span class=mf>0.12</span><span class=p>,</span>              <span class=c1># ROE&gt;12%</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>roa</span> <span class=o>&gt;</span> <span class=mf>0.06</span><span class=p>,</span>              <span class=c1># ROA&gt;6%</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>debt_to_equity</span> <span class=o>&lt;</span> <span class=mf>0.5</span><span class=p>,</span>    <span class=c1># 低负债</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>current_ratio</span> <span class=o>&gt;</span> <span class=mf>1.5</span><span class=p>,</span>     <span class=c1># 流动比率健康</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>revenue_growth_rate</span> <span class=o>&gt;</span> <span class=mf>0.1</span><span class=p>,</span> <span class=c1># 营收增长&gt;10%</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>earnings_stability</span> <span class=o>&gt;</span> <span class=mf>0.8</span>   <span class=c1># 盈利稳定</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>get_factors</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>date</span><span class=o>=</span><span class=n>context</span><span class=o>.</span><span class=n>current_date</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 质量评分</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;quality_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;roe&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.25</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;roa&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.2</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;debt_to_equity&#39;</span><span class=p>])</span> <span class=o>*</span> <span class=mf>0.2</span> <span class=o>+</span>  <span class=c1># 负债率越低越好</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;current_ratio&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.1</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;asset_turnover&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.1</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;earnings_stability&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.15</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 按质量评分排序</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=s1>&#39;quality_score&#39;</span><span class=p>,</span> <span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>selected_stocks</span> <span class=o>=</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>head</span><span class=p>(</span><span class=mi>15</span><span class=p>)[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>selected_stocks</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=多因子选股策略>多因子选股策略</h2><h3 id=因子合成方法>因子合成方法</h3><p>多因子策略需要将多个因子合成为综合评分：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>factor_combination_equal_weight</span><span class=p>(</span><span class=n>factor_df</span><span class=p>,</span> <span class=n>factor_list</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    等权重因子组合
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 标准化因子</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>factor_name</span> <span class=ow>in</span> <span class=n>factor_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>factor_name</span><span class=si>}</span><span class=s1>_zscore&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>standardize_series</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=n>factor_name</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 等权重合成</span>
</span></span><span class=line><span class=cl>    <span class=n>zscore_cols</span> <span class=o>=</span> <span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>f</span><span class=si>}</span><span class=s1>_zscore&#39;</span> <span class=k>for</span> <span class=n>f</span> <span class=ow>in</span> <span class=n>factor_list</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;combined_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>factor_df</span><span class=p>[</span><span class=n>zscore_cols</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>factor_df</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>factor_combination_ic_weight</span><span class=p>(</span><span class=n>factor_df</span><span class=p>,</span> <span class=n>factor_list</span><span class=p>,</span> <span class=n>ic_dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    IC加权因子组合
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>total_ic</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>ic_dict</span><span class=p>[</span><span class=n>f</span><span class=p>])</span> <span class=k>for</span> <span class=n>f</span> <span class=ow>in</span> <span class=n>factor_list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;combined_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>factor_name</span> <span class=ow>in</span> <span class=n>factor_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>weight</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>ic_dict</span><span class=p>[</span><span class=n>factor_name</span><span class=p>])</span> <span class=o>/</span> <span class=n>total_ic</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>factor_name</span><span class=si>}</span><span class=s1>_zscore&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>standardize_series</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=n>factor_name</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;combined_score&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=n>weight</span> <span class=o>*</span> <span class=n>factor_df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>factor_name</span><span class=si>}</span><span class=s1>_zscore&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>factor_df</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>factor_combination_pca</span><span class=p>(</span><span class=n>factor_df</span><span class=p>,</span> <span class=n>factor_list</span><span class=p>,</span> <span class=n>n_components</span><span class=o>=</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    PCA因子组合
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>sklearn.decomposition</span> <span class=kn>import</span> <span class=n>PCA</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>sklearn.preprocessing</span> <span class=kn>import</span> <span class=n>StandardScaler</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 标准化因子</span>
</span></span><span class=line><span class=cl>    <span class=n>scaler</span> <span class=o>=</span> <span class=n>StandardScaler</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_matrix</span> <span class=o>=</span> <span class=n>scaler</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=n>factor_list</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># PCA降维</span>
</span></span><span class=line><span class=cl>    <span class=n>pca</span> <span class=o>=</span> <span class=n>PCA</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=n>n_components</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pca_factors</span> <span class=o>=</span> <span class=n>pca</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>factor_matrix</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 使用第一主成分作为综合因子</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;combined_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pca_factors</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>factor_df</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>factor_combination_machine_learning</span><span class=p>(</span><span class=n>factor_df</span><span class=p>,</span> <span class=n>factor_list</span><span class=p>,</span> <span class=n>target</span><span class=o>=</span><span class=s1>&#39;future_return&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    机器学习因子组合
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>sklearn.ensemble</span> <span class=kn>import</span> <span class=n>RandomForestRegressor</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>sklearn.model_selection</span> <span class=kn>import</span> <span class=n>train_test_split</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 准备数据</span>
</span></span><span class=line><span class=cl>    <span class=n>X</span> <span class=o>=</span> <span class=n>factor_df</span><span class=p>[</span><span class=n>factor_list</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=o>=</span> <span class=n>factor_df</span><span class=p>[</span><span class=n>target</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 分割数据</span>
</span></span><span class=line><span class=cl>    <span class=n>X_train</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>y_test</span> <span class=o>=</span> <span class=n>train_test_split</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>test_size</span><span class=o>=</span><span class=mf>0.3</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 训练模型</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span> <span class=o>=</span> <span class=n>RandomForestRegressor</span><span class=p>(</span><span class=n>n_estimators</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X_train</span><span class=p>,</span> <span class=n>y_train</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 预测综合得分</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;combined_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 特征重要性</span>
</span></span><span class=line><span class=cl>    <span class=n>importance</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>factor_list</span><span class=p>,</span> <span class=n>model</span><span class=o>.</span><span class=n>feature_importances_</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>factor_df</span><span class=p>,</span> <span class=n>importance</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=经典多因子模型>经典多因子模型</h3><p>让我们实现几个经典的多因子选股策略：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fama_french_three_factor</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Fama-French三因子模型策略
</span></span></span><span class=line><span class=cl><span class=s2>    市场因子 + 规模因子 + 价值因子
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock_list</span> <span class=o>=</span> <span class=n>get_stock_list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取因子数据</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>=</span> <span class=n>query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>market_cap</span><span class=p>,</span>      <span class=c1># 规模因子</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>pb</span><span class=p>,</span>              <span class=c1># 价值因子（市净率倒数）</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>beta</span><span class=p>,</span>            <span class=c1># 市场因子暴露</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>momentum_6m</span>      <span class=c1># 动量控制</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>in_</span><span class=p>(</span><span class=n>stock_list</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>market_cap</span> <span class=o>&gt;</span> <span class=mi>10</span><span class=p>,</span>     <span class=c1># 排除太小市值</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>pb</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>beta</span><span class=o>.</span><span class=n>between</span><span class=p>(</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>1.5</span><span class=p>)</span> <span class=c1># 合理的贝塔值</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>get_factors</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>date</span><span class=o>=</span><span class=n>context</span><span class=o>.</span><span class=n>current_date</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 因子处理</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;size_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=n>standardize_series</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;market_cap&#39;</span><span class=p>])</span>  <span class=c1># 小市值得分高</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;value_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>standardize_series</span><span class=p>(</span><span class=mi>1</span> <span class=o>/</span> <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;pb&#39;</span><span class=p>])</span>      <span class=c1># 低PB得分高</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;momentum_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>standardize_series</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;momentum_6m&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 三因子组合（等权重）</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;combined_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;size_score&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.4</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;value_score&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.4</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;momentum_score&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.2</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 排序选择</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=s1>&#39;combined_score&#39;</span><span class=p>,</span> <span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>selected_stocks</span> <span class=o>=</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>head</span><span class=p>(</span><span class=mi>30</span><span class=p>)[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>selected_stocks</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>barra_style_factor_strategy</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Barra风格因子策略
</span></span></span><span class=line><span class=cl><span class=s2>    结合多个风格因子
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock_list</span> <span class=o>=</span> <span class=n>get_stock_list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取Barra风格因子</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>=</span> <span class=n>query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1># 规模因子</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>market_cap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1># 价值因子  </span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>pe</span><span class=p>,</span> <span class=n>factor</span><span class=o>.</span><span class=n>pb</span><span class=p>,</span> <span class=n>factor</span><span class=o>.</span><span class=n>ps</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1># 成长因子</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>revenue_growth_rate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>net_profit_growth_rate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1># 盈利因子</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>roe</span><span class=p>,</span> <span class=n>factor</span><span class=o>.</span><span class=n>roa</span><span class=p>,</span> <span class=n>factor</span><span class=o>.</span><span class=n>gross_margin</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1># 杠杆因子</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>debt_to_equity</span><span class=p>,</span> <span class=n>factor</span><span class=o>.</span><span class=n>current_ratio</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1># 动量因子</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>momentum_1m</span><span class=p>,</span> <span class=n>factor</span><span class=o>.</span><span class=n>momentum_3m</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1># 波动因子</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>volatility_1m</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1># 流动性因子</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>turnover_rate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1># 质量因子</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>earnings_quality</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>in_</span><span class=p>(</span><span class=n>stock_list</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>market_cap</span> <span class=o>&gt;</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>get_factors</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>date</span><span class=o>=</span><span class=n>context</span><span class=o>.</span><span class=n>current_date</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算各风格因子得分</span>
</span></span><span class=line><span class=cl>    <span class=n>style_scores</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 规模因子（小市值偏好）</span>
</span></span><span class=line><span class=cl>    <span class=n>style_scores</span><span class=p>[</span><span class=s1>&#39;size&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=n>standardize_series</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;market_cap&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 价值因子（低估值偏好）</span>
</span></span><span class=line><span class=cl>    <span class=n>value_factors</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;pe&#39;</span><span class=p>,</span> <span class=s1>&#39;pb&#39;</span><span class=p>,</span> <span class=s1>&#39;ps&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>factor_name</span> <span class=ow>in</span> <span class=n>value_factors</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>factor_name</span><span class=si>}</span><span class=s1>_reciprocal&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>factor_df</span><span class=p>[</span><span class=n>factor_name</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>style_scores</span><span class=p>[</span><span class=s1>&#39;value&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>standardize_series</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[[</span><span class=s1>&#39;pe_reciprocal&#39;</span><span class=p>,</span> <span class=s1>&#39;pb_reciprocal&#39;</span><span class=p>,</span> <span class=s1>&#39;ps_reciprocal&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 成长因子（高成长偏好）</span>
</span></span><span class=line><span class=cl>    <span class=n>style_scores</span><span class=p>[</span><span class=s1>&#39;growth&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>standardize_series</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;revenue_growth_rate&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.6</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;net_profit_growth_rate&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.4</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 盈利因子（高盈利偏好）</span>
</span></span><span class=line><span class=cl>    <span class=n>style_scores</span><span class=p>[</span><span class=s1>&#39;profitability&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>standardize_series</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;roe&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.5</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;roa&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.3</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;gross_margin&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.2</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 杠杆因子（低杠杆偏好）</span>
</span></span><span class=line><span class=cl>    <span class=n>style_scores</span><span class=p>[</span><span class=s1>&#39;leverage&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=n>standardize_series</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;debt_to_equity&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 动量因子（动量偏好）</span>
</span></span><span class=line><span class=cl>    <span class=n>style_scores</span><span class=p>[</span><span class=s1>&#39;momentum&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>standardize_series</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;momentum_1m&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.4</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;momentum_3m&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.6</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 波动因子（低波动偏好）</span>
</span></span><span class=line><span class=cl>    <span class=n>style_scores</span><span class=p>[</span><span class=s1>&#39;volatility&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=n>standardize_series</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;volatility_1m&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 流动性因子（适度流动性）</span>
</span></span><span class=line><span class=cl>    <span class=n>style_scores</span><span class=p>[</span><span class=s1>&#39;liquidity&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>standardize_series</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;turnover_rate&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 合并到数据框</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>style</span><span class=p>,</span> <span class=n>scores</span> <span class=ow>in</span> <span class=n>style_scores</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>style</span><span class=si>}</span><span class=s1>_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>scores</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 等权重组合所有风格因子</span>
</span></span><span class=line><span class=cl>    <span class=n>style_score_cols</span> <span class=o>=</span> <span class=p>[</span><span class=n>col</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>columns</span> <span class=k>if</span> <span class=n>col</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s1>&#39;_score&#39;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;combined_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>factor_df</span><span class=p>[</span><span class=n>style_score_cols</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 排序选择</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=s1>&#39;combined_score&#39;</span><span class=p>,</span> <span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>selected_stocks</span> <span class=o>=</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>head</span><span class=p>(</span><span class=mi>50</span><span class=p>)[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>selected_stocks</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>smart_beta_strategy</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Smart Beta策略
</span></span></span><span class=line><span class=cl><span class=s2>    结合传统Beta和因子暴露
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock_list</span> <span class=o>=</span> <span class=n>get_stock_list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取因子数据</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>=</span> <span class=n>query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>beta</span><span class=p>,</span>                    <span class=c1># 市场Beta</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>market_cap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>pe</span><span class=p>,</span> <span class=n>factor</span><span class=o>.</span><span class=n>pb</span><span class=p>,</span>           <span class=c1># 估值因子</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>roe</span><span class=p>,</span> <span class=n>factor</span><span class=o>.</span><span class=n>roa</span><span class=p>,</span>       <span class=c1># 质量因子</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>revenue_growth_rate</span><span class=p>,</span>    <span class=c1># 成长因子</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>volatility_1m</span><span class=p>,</span>           <span class=c1># 低波动</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>dividend_yield</span>           <span class=c1># 红利因子</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>in_</span><span class=p>(</span><span class=n>stock_list</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>beta</span><span class=o>.</span><span class=n>between</span><span class=p>(</span><span class=mf>0.3</span><span class=p>,</span> <span class=mf>1.2</span><span class=p>),</span>  <span class=c1># 合理的Beta范围</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>market_cap</span> <span class=o>&gt;</span> <span class=mi>50</span>            <span class=c1># 大中盘股</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>get_factors</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>date</span><span class=o>=</span><span class=n>context</span><span class=o>.</span><span class=n>current_date</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># Smart Beta组合</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;smart_beta_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=c1># 低Beta（防御性）</span>
</span></span><span class=line><span class=cl>        <span class=o>-</span><span class=n>standardize_series</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;beta&#39;</span><span class=p>])</span> <span class=o>*</span> <span class=mf>0.2</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=c1># 小市值（规模因子）</span>
</span></span><span class=line><span class=cl>        <span class=o>-</span><span class=n>standardize_series</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;market_cap&#39;</span><span class=p>]))</span> <span class=o>*</span> <span class=mf>0.15</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=c1># 低估值（价值因子）</span>
</span></span><span class=line><span class=cl>        <span class=n>standardize_series</span><span class=p>(</span><span class=mi>1</span><span class=o>/</span><span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;pe&#39;</span><span class=p>])</span> <span class=o>*</span> <span class=mf>0.15</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>standardize_series</span><span class=p>(</span><span class=mi>1</span><span class=o>/</span><span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;pb&#39;</span><span class=p>])</span> <span class=o>*</span> <span class=mf>0.15</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=c1># 高质量（质量因子）</span>
</span></span><span class=line><span class=cl>        <span class=n>standardize_series</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;roe&#39;</span><span class=p>])</span> <span class=o>*</span> <span class=mf>0.1</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>standardize_series</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;roa&#39;</span><span class=p>])</span> <span class=o>*</span> <span class=mf>0.1</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=c1># 成长因子</span>
</span></span><span class=line><span class=cl>        <span class=n>standardize_series</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;revenue_growth_rate&#39;</span><span class=p>])</span> <span class=o>*</span> <span class=mf>0.1</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=c1># 低波动</span>
</span></span><span class=line><span class=cl>        <span class=o>-</span><span class=n>standardize_series</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;volatility_1m&#39;</span><span class=p>])</span> <span class=o>*</span> <span class=mf>0.05</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=c1># 红利因子</span>
</span></span><span class=line><span class=cl>        <span class=n>standardize_series</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;dividend_yield&#39;</span><span class=p>])</span> <span class=o>*</span> <span class=mf>0.05</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 排序选择</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=s1>&#39;smart_beta_score&#39;</span><span class=p>,</span> <span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>selected_stocks</span> <span class=o>=</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>head</span><span class=p>(</span><span class=mi>40</span><span class=p>)[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>selected_stocks</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=因子有效性检验>因子有效性检验</h2><h3 id=ic分析>IC分析</h3><p>信息系数（IC）是衡量因子有效性的重要指标：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_ic</span><span class=p>(</span><span class=n>factor_df</span><span class=p>,</span> <span class=n>factor_name</span><span class=p>,</span> <span class=n>target</span><span class=o>=</span><span class=s1>&#39;future_return&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算因子IC（信息系数）
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 计算因子值和未来收益率的秩相关系数</span>
</span></span><span class=line><span class=cl>    <span class=n>ic</span> <span class=o>=</span> <span class=n>factor_df</span><span class=p>[</span><span class=n>factor_name</span><span class=p>]</span><span class=o>.</span><span class=n>corr</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=n>target</span><span class=p>],</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;spearman&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ic</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_rank_ic</span><span class=p>(</span><span class=n>factor_df</span><span class=p>,</span> <span class=n>factor_name</span><span class=p>,</span> <span class=n>target</span><span class=o>=</span><span class=s1>&#39;future_return&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算Rank IC（秩信息系数）
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 计算因子排名和收益率排名的相关系数</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_rank</span> <span class=o>=</span> <span class=n>factor_df</span><span class=p>[</span><span class=n>factor_name</span><span class=p>]</span><span class=o>.</span><span class=n>rank</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>target_rank</span> <span class=o>=</span> <span class=n>factor_df</span><span class=p>[</span><span class=n>target</span><span class=p>]</span><span class=o>.</span><span class=n>rank</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>rank_ic</span> <span class=o>=</span> <span class=n>factor_rank</span><span class=o>.</span><span class=n>corr</span><span class=p>(</span><span class=n>target_rank</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>rank_ic</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ic_analysis</span><span class=p>(</span><span class=n>factor_data</span><span class=p>,</span> <span class=n>factor_name</span><span class=p>,</span> <span class=n>periods</span><span class=o>=</span><span class=mi>12</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    IC分析
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>ic_values</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>rank_ic_values</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>periods</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 获取不同时间段的因子数据</span>
</span></span><span class=line><span class=cl>        <span class=n>period_df</span> <span class=o>=</span> <span class=n>get_factor_data_for_period</span><span class=p>(</span><span class=n>factor_data</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>period_df</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>ic</span> <span class=o>=</span> <span class=n>calculate_ic</span><span class=p>(</span><span class=n>period_df</span><span class=p>,</span> <span class=n>factor_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>rank_ic</span> <span class=o>=</span> <span class=n>calculate_rank_ic</span><span class=p>(</span><span class=n>period_df</span><span class=p>,</span> <span class=n>factor_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>ic_values</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ic</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>rank_ic_values</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>rank_ic</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算统计指标</span>
</span></span><span class=line><span class=cl>    <span class=n>ic_mean</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>ic_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ic_std</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>ic_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ic_ir</span> <span class=o>=</span> <span class=n>ic_mean</span> <span class=o>/</span> <span class=n>ic_std</span> <span class=k>if</span> <span class=n>ic_std</span> <span class=o>!=</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>  <span class=c1># 信息比率</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>rank_ic_mean</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>rank_ic_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rank_ic_std</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>rank_ic_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rank_ic_ir</span> <span class=o>=</span> <span class=n>rank_ic_mean</span> <span class=o>/</span> <span class=n>rank_ic_std</span> <span class=k>if</span> <span class=n>rank_ic_std</span> <span class=o>!=</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;ic_mean&#39;</span><span class=p>:</span> <span class=n>ic_mean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;ic_std&#39;</span><span class=p>:</span> <span class=n>ic_std</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;ic_ir&#39;</span><span class=p>:</span> <span class=n>ic_ir</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;rank_ic_mean&#39;</span><span class=p>:</span> <span class=n>rank_ic_mean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;rank_ic_std&#39;</span><span class=p>:</span> <span class=n>rank_ic_std</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;rank_ic_ir&#39;</span><span class=p>:</span> <span class=n>rank_ic_ir</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;ic_values&#39;</span><span class=p>:</span> <span class=n>ic_values</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;rank_ic_values&#39;</span><span class=p>:</span> <span class=n>rank_ic_values</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>factor_decay_analysis</span><span class=p>(</span><span class=n>factor_df</span><span class=p>,</span> <span class=n>factor_name</span><span class=p>,</span> <span class=n>max_lag</span><span class=o>=</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    因子衰减分析
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>decay_results</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>lag</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>max_lag</span> <span class=o>+</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 计算不同滞后期的IC</span>
</span></span><span class=line><span class=cl>        <span class=n>lagged_target</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;future_return_lag_</span><span class=si>{</span><span class=n>lag</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>lagged_target</span> <span class=ow>in</span> <span class=n>factor_df</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>ic</span> <span class=o>=</span> <span class=n>calculate_ic</span><span class=p>(</span><span class=n>factor_df</span><span class=p>,</span> <span class=n>factor_name</span><span class=p>,</span> <span class=n>lagged_target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>decay_results</span><span class=p>[</span><span class=n>lag</span><span class=p>]</span> <span class=o>=</span> <span class=n>ic</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>decay_results</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>factor_turnover_analysis</span><span class=p>(</span><span class=n>factor_df_list</span><span class=p>,</span> <span class=n>factor_name</span><span class=p>,</span> <span class=n>top_pct</span><span class=o>=</span><span class=mf>0.1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    因子换手率分析
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>turnovers</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>factor_df_list</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 获取相邻两期的因子数据</span>
</span></span><span class=line><span class=cl>        <span class=n>prev_df</span> <span class=o>=</span> <span class=n>factor_df_list</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>curr_df</span> <span class=o>=</span> <span class=n>factor_df_list</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 选择前10%的股票</span>
</span></span><span class=line><span class=cl>        <span class=n>prev_top</span> <span class=o>=</span> <span class=n>prev_df</span><span class=o>.</span><span class=n>nlargest</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>prev_df</span><span class=p>)</span> <span class=o>*</span> <span class=n>top_pct</span><span class=p>),</span> <span class=n>factor_name</span><span class=p>)[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>curr_top</span> <span class=o>=</span> <span class=n>curr_df</span><span class=o>.</span><span class=n>nlargest</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>curr_df</span><span class=p>)</span> <span class=o>*</span> <span class=n>top_pct</span><span class=p>),</span> <span class=n>factor_name</span><span class=p>)[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算换手率</span>
</span></span><span class=line><span class=cl>        <span class=n>common_stocks</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>prev_top</span><span class=p>)</span> <span class=o>&amp;</span> <span class=nb>set</span><span class=p>(</span><span class=n>curr_top</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>turnover</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>common_stocks</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>prev_top</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>turnovers</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>turnover</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>avg_turnover</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>turnovers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>avg_turnover</span><span class=p>,</span> <span class=n>turnovers</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=完整因子选股策略实现>完整因子选股策略实现</h2><p>让我们实现一个完整的因子选股策略：</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    因子选股策略初始化
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 策略参数</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>strategy_name</span> <span class=o>=</span> <span class=s2>&#34;多因子选股策略&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>benchmark</span> <span class=o>=</span> <span class=s1>&#39;000300.XSHG&#39;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 股票池 - 全市场股票，排除ST、新股等</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>stock_pool</span> <span class=o>=</span> <span class=n>get_all_stocks</span><span class=p>(</span><span class=n>exclude_st</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>exclude_new</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 因子参数</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>factor_params</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;holding_period&#39;</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span>           <span class=c1># 持仓周期（天）</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;stock_num&#39;</span><span class=p>:</span> <span class=mi>30</span><span class=p>,</span>               <span class=c1># 选股数量</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;factor_weights&#39;</span><span class=p>:</span> <span class=p>{</span>             <span class=c1># 因子权重</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;value&#39;</span><span class=p>:</span> <span class=mf>0.25</span><span class=p>,</span>              <span class=c1># 价值因子</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;growth&#39;</span><span class=p>:</span> <span class=mf>0.25</span><span class=p>,</span>             <span class=c1># 成长因子</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;quality&#39;</span><span class=p>:</span> <span class=mf>0.25</span><span class=p>,</span>             <span class=c1># 质量因子</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;momentum&#39;</span><span class=p>:</span> <span class=mf>0.15</span><span class=p>,</span>            <span class=c1># 动量因子</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;size&#39;</span><span class=p>:</span> <span class=mf>0.1</span>                  <span class=c1># 规模因子</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 调仓周期</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>rebalance_period</span> <span class=o>=</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>days_since_rebalance</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 记录选股历史</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>selection_history</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;策略初始化完成: </span><span class=si>{</span><span class=n>context</span><span class=o>.</span><span class=n>strategy_name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_data</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    因子选股策略主函数
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>days_since_rebalance</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 检查是否需要调仓</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>context</span><span class=o>.</span><span class=n>days_since_rebalance</span> <span class=o>&gt;=</span> <span class=n>context</span><span class=o>.</span><span class=n>rebalance_period</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 执行选股</span>
</span></span><span class=line><span class=cl>        <span class=n>selected_stocks</span> <span class=o>=</span> <span class=n>select_stocks_by_factors</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 调仓</span>
</span></span><span class=line><span class=cl>        <span class=n>rebalance_portfolio</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>selected_stocks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 重置计数器</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=n>days_since_rebalance</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 记录选股结果</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=n>selection_history</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>get_datetime</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;selected_stocks&#39;</span><span class=p>:</span> <span class=n>selected_stocks</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;stock_num&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>selected_stocks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>select_stocks_by_factors</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    基于因子选股
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>current_date</span> <span class=o>=</span> <span class=n>get_datetime</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>stock_list</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>stock_pool</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取多因子数据</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>=</span> <span class=n>query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1># 价值因子</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>pe</span><span class=p>,</span> <span class=n>factor</span><span class=o>.</span><span class=n>pb</span><span class=p>,</span> <span class=n>factor</span><span class=o>.</span><span class=n>ps</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1># 成长因子</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>revenue_growth_rate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>net_profit_growth_rate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1># 质量因子</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>roe</span><span class=p>,</span> <span class=n>factor</span><span class=o>.</span><span class=n>roa</span><span class=p>,</span> <span class=n>factor</span><span class=o>.</span><span class=n>gross_margin</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>debt_to_equity</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1># 动量因子</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>momentum_1m</span><span class=p>,</span> <span class=n>factor</span><span class=o>.</span><span class=n>momentum_3m</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1># 规模因子</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>market_cap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1># 其他控制变量</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>volatility_1m</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>turnover_rate</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>in_</span><span class=p>(</span><span class=n>stock_list</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=c1># 基础筛选条件</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>pe</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span>                      <span class=c1># PE为正</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>market_cap</span> <span class=o>&gt;</span> <span class=mi>20</span><span class=p>,</span>             <span class=c1># 市值&gt;20亿</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>volatility_1m</span> <span class=o>&lt;</span> <span class=mf>0.5</span><span class=p>,</span>         <span class=c1># 波动率不太高</span>
</span></span><span class=line><span class=cl>        <span class=n>factor</span><span class=o>.</span><span class=n>turnover_rate</span> <span class=o>&gt;</span> <span class=mf>0.01</span>         <span class=c1># 有一定流动性</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>get_factors</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>date</span><span class=o>=</span><span class=n>current_date</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>factor_df</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 因子处理</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_df</span> <span class=o>=</span> <span class=n>process_factor_data</span><span class=p>(</span><span class=n>factor_df</span><span class=p>,</span> <span class=n>industry_neutral</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>size_neutral</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算各因子得分</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_scores</span> <span class=o>=</span> <span class=n>calculate_factor_scores</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>factor_df</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 综合评分</span>
</span></span><span class=line><span class=cl>    <span class=n>combined_scores</span> <span class=o>=</span> <span class=n>combine_factor_scores</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>factor_scores</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 选股</span>
</span></span><span class=line><span class=cl>    <span class=n>selected_stocks</span> <span class=o>=</span> <span class=n>select_top_stocks</span><span class=p>(</span><span class=n>combined_scores</span><span class=p>,</span> <span class=n>context</span><span class=o>.</span><span class=n>factor_params</span><span class=p>[</span><span class=s1>&#39;stock_num&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>selected_stocks</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_factor_scores</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>factor_df</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算各因子得分
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>scores_df</span> <span class=o>=</span> <span class=n>factor_df</span><span class=p>[[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 价值因子得分</span>
</span></span><span class=line><span class=cl>    <span class=n>value_factors</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;pe&#39;</span><span class=p>,</span> <span class=s1>&#39;pb&#39;</span><span class=p>,</span> <span class=s1>&#39;ps&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>factor_name</span> <span class=ow>in</span> <span class=n>value_factors</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>scores_df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>factor_name</span><span class=si>}</span><span class=s1>_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=n>standardize_series</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=n>factor_name</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 价值因子综合得分（低估值得分高）</span>
</span></span><span class=line><span class=cl>    <span class=n>value_score_cols</span> <span class=o>=</span> <span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>f</span><span class=si>}</span><span class=s1>_score&#39;</span> <span class=k>for</span> <span class=n>f</span> <span class=ow>in</span> <span class=n>value_factors</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>scores_df</span><span class=p>[</span><span class=s1>&#39;value_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>scores_df</span><span class=p>[</span><span class=n>value_score_cols</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 成长因子得分</span>
</span></span><span class=line><span class=cl>    <span class=n>scores_df</span><span class=p>[</span><span class=s1>&#39;growth_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>standardize_series</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;revenue_growth_rate&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.6</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;net_profit_growth_rate&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.4</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 质量因子得分</span>
</span></span><span class=line><span class=cl>    <span class=n>quality_factors</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;roe&#39;</span><span class=p>,</span> <span class=s1>&#39;roa&#39;</span><span class=p>,</span> <span class=s1>&#39;gross_margin&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>factor_name</span> <span class=ow>in</span> <span class=n>quality_factors</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>scores_df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>factor_name</span><span class=si>}</span><span class=s1>_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>standardize_series</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=n>factor_name</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>scores_df</span><span class=p>[</span><span class=s1>&#39;quality_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>scores_df</span><span class=p>[</span><span class=s1>&#39;roe_score&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.5</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>scores_df</span><span class=p>[</span><span class=s1>&#39;roa_score&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.3</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>scores_df</span><span class=p>[</span><span class=s1>&#39;gross_margin_score&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.2</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 杠杆因子得分（低杠杆得分高）</span>
</span></span><span class=line><span class=cl>    <span class=n>scores_df</span><span class=p>[</span><span class=s1>&#39;leverage_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=n>standardize_series</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;debt_to_equity&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 动量因子得分</span>
</span></span><span class=line><span class=cl>    <span class=n>momentum_factors</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;momentum_1m&#39;</span><span class=p>,</span> <span class=s1>&#39;momentum_3m&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>factor_name</span> <span class=ow>in</span> <span class=n>momentum_factors</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>scores_df</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>factor_name</span><span class=si>}</span><span class=s1>_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>standardize_series</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=n>factor_name</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>scores_df</span><span class=p>[</span><span class=s1>&#39;momentum_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>scores_df</span><span class=p>[</span><span class=s1>&#39;momentum_1m_score&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.4</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>scores_df</span><span class=p>[</span><span class=s1>&#39;momentum_3m_score&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.6</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 规模因子得分（小市值得分高）</span>
</span></span><span class=line><span class=cl>    <span class=n>scores_df</span><span class=p>[</span><span class=s1>&#39;size_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=n>standardize_series</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>factor_df</span><span class=p>[</span><span class=s1>&#39;market_cap&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>scores_df</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>combine_factor_scores</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>scores_df</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    合成因子得分
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>weights</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>factor_params</span><span class=p>[</span><span class=s1>&#39;factor_weights&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 加权合成</span>
</span></span><span class=line><span class=cl>    <span class=n>scores_df</span><span class=p>[</span><span class=s1>&#39;combined_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>scores_df</span><span class=p>[</span><span class=s1>&#39;value_score&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=n>weights</span><span class=p>[</span><span class=s1>&#39;value&#39;</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>scores_df</span><span class=p>[</span><span class=s1>&#39;growth_score&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=n>weights</span><span class=p>[</span><span class=s1>&#39;growth&#39;</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>scores_df</span><span class=p>[</span><span class=s1>&#39;quality_score&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=n>weights</span><span class=p>[</span><span class=s1>&#39;quality&#39;</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>scores_df</span><span class=p>[</span><span class=s1>&#39;momentum_score&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=n>weights</span><span class=p>[</span><span class=s1>&#39;momentum&#39;</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=n>scores_df</span><span class=p>[</span><span class=s1>&#39;size_score&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=n>weights</span><span class=p>[</span><span class=s1>&#39;size&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>scores_df</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>select_top_stocks</span><span class=p>(</span><span class=n>combined_scores</span><span class=p>,</span> <span class=n>select_num</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    选择得分最高的股票
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 按综合得分排序</span>
</span></span><span class=line><span class=cl>    <span class=n>sorted_stocks</span> <span class=o>=</span> <span class=n>combined_scores</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=s1>&#39;combined_score&#39;</span><span class=p>,</span> <span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 选择前select_num只股票</span>
</span></span><span class=line><span class=cl>    <span class=n>selected_stocks</span> <span class=o>=</span> <span class=n>sorted_stocks</span><span class=o>.</span><span class=n>head</span><span class=p>(</span><span class=n>select_num</span><span class=p>)[</span><span class=s1>&#39;symbol&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>selected_stocks</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rebalance_portfolio</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>target_stocks</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    调仓函数
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>current_date</span> <span class=o>=</span> <span class=n>get_datetime</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取当前持仓</span>
</span></span><span class=line><span class=cl>    <span class=n>current_positions</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>portfolio</span><span class=o>.</span><span class=n>positions</span><span class=o>.</span><span class=n>keys</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算卖出股票</span>
</span></span><span class=line><span class=cl>    <span class=n>sell_stocks</span> <span class=o>=</span> <span class=p>[</span><span class=n>stock</span> <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>current_positions</span> <span class=k>if</span> <span class=n>stock</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>target_stocks</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算买入股票</span>
</span></span><span class=line><span class=cl>    <span class=n>buy_stocks</span> <span class=o>=</span> <span class=p>[</span><span class=n>stock</span> <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>target_stocks</span> <span class=k>if</span> <span class=n>stock</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>current_positions</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 卖出操作</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>sell_stocks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>order_target</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>current_date</span><span class=si>}</span><span class=s2>: 卖出 </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 买入操作</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>target_stocks</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>target_weight</span> <span class=o>=</span> <span class=mf>1.0</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>target_stocks</span><span class=p>)</span>  <span class=c1># 等权重配置</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>buy_stocks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>order_target_percent</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=n>target_weight</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>current_date</span><span class=si>}</span><span class=s2>: 买入 </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2>, 权重: </span><span class=si>{</span><span class=n>target_weight</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>after_trading_end</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    收盘后处理
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 更新策略统计</span>
</span></span><span class=line><span class=cl>    <span class=n>update_strategy_stats</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 打印持仓信息</span>
</span></span><span class=line><span class=cl>    <span class=n>print_portfolio_info</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_strategy_stats</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    更新策略统计
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>total_value</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>portfolio</span><span class=o>.</span><span class=n>total_value</span>
</span></span><span class=line><span class=cl>    <span class=n>cash</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>portfolio</span><span class=o>.</span><span class=n>cash</span>
</span></span><span class=line><span class=cl>    <span class=n>positions_value</span> <span class=o>=</span> <span class=n>total_value</span> <span class=o>-</span> <span class=n>cash</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;账户总值: </span><span class=si>{</span><span class=n>total_value</span><span class=si>:</span><span class=s2>,.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;现金: </span><span class=si>{</span><span class=n>cash</span><span class=si>:</span><span class=s2>,.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;持仓市值: </span><span class=si>{</span><span class=n>positions_value</span><span class=si>:</span><span class=s2>,.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;持仓比例: </span><span class=si>{</span><span class=n>positions_value</span><span class=o>/</span><span class=n>total_value</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;持仓股票数: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>portfolio</span><span class=o>.</span><span class=n>positions</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>print_portfolio_info</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    打印持仓信息
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>当前持仓:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span><span class=p>,</span> <span class=n>position</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>portfolio</span><span class=o>.</span><span class=n>positions</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>position</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>current_price</span> <span class=o>=</span> <span class=n>get_current_data</span><span class=p>(</span><span class=n>stock</span><span class=p>)</span><span class=o>.</span><span class=n>day_limit</span>
</span></span><span class=line><span class=cl>            <span class=n>market_value</span> <span class=o>=</span> <span class=n>position</span> <span class=o>*</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>            <span class=n>weight</span> <span class=o>=</span> <span class=n>market_value</span> <span class=o>/</span> <span class=n>context</span><span class=o>.</span><span class=n>portfolio</span><span class=o>.</span><span class=n>total_value</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>position</span><span class=si>}</span><span class=s2>股, 市值: </span><span class=si>{</span><span class=n>market_value</span><span class=si>:</span><span class=s2>,.2f</span><span class=si>}</span><span class=s2>, 权重: </span><span class=si>{</span><span class=n>weight</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=总结>总结</h2><p>本讲详细介绍了SuperMind平台因子选股策略的开发方法，包括：</p><ol><li><strong>因子投资基础</strong>：因子概念、分类和数据处理</li><li><strong>单因子策略</strong>：估值因子、成长因子、质量因子策略</li><li><strong>多因子策略</strong>：因子合成方法、经典多因子模型</li><li><strong>因子有效性检验</strong>：IC分析、衰减分析、换手率分析</li><li><strong>完整策略实现</strong>：从因子计算到组合构建</li></ol><p>因子选股是量化投资的核心策略类型，在下一讲中我们将学习事件驱动策略的开发。</p></div></article><aside class="lg:w-80 xl:w-96"><div class=space-y-8></div></aside></div><nav class="border-t border-gray-200 mt-12 pt-8"><div class="flex justify-between items-center"><a href=/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/04-%E6%8A%80%E6%9C%AF%E6%8C%87%E6%A0%87%E7%AD%96%E7%95%A5%E5%BC%80%E5%8F%91/ class="group flex items-center"><svg class="w-5 h-5 mr-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0 7-7m-7 7h18"/></svg><div><div class="text-sm text-gray-600">上一篇</div><div class="font-medium group-hover:text-primary-600">SuperMind第4讲：技术指标策略开发</div></div></a><a href=/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/06-%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E7%AD%96%E7%95%A5%E5%BC%80%E5%8F%91/ class="group flex items-center text-right"><div><div class="text-sm text-gray-600">Next Post</div><div class="font-medium group-hover:text-primary-600">SuperMind第6讲：事件驱动策略开发</div></div><svg class="w-5 h-5 ml-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0-7 7m7-7H3"/></svg></a></div></nav></div></div><footer class="bg-gray-50 py-12 border-t border-gray-200"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><div class="flex flex-col md:flex-row justify-between space-y-4 md:space-y-0"><div class=flex-1><div class="flex items-center space-x-3 mb-4"><a href=https://sk-quant.github.io/ class=inline-block><img src=/images/logo.svg alt=烧烤量化 class=h-6>
</a><span class="text-xl font-bold text-gray-900">烧烤量化</span></div><div class="flex space-x-3 p-2"></div></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div></div><div class="mt-12 pt-8 border-t border-gray-200"><div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0"><p class="text-gray-600 text-sm">© 2025 烧烤量化. All rights reserved.</p><a href=https://chaoming.li class="text-sm text-gray-600 hover:text-primary-600" target=_blank rel="noopener noreferrer">Powered by sk-quant</a></div></div></div></footer><script>const mobileMenuButton=document.getElementById("mobile-menu-button");mobileMenuButton&&mobileMenuButton.addEventListener("click",function(){const e=document.getElementById("mobile-menu");e&&e.classList.toggle("hidden")})</script></body></html>