<!doctype html><html lang=zh-cn class=h-full><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-XXXXXXX")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XXXXXXXXXX")</script><title>SuperMind第3讲：策略框架与生命周期管理 | 烧烤量化</title>
<meta name=description content="深入理解SuperMind策略框架：从初始化到执行结束的完整生命周期，掌握策略开发的核心架构模式。"><meta name=author content="Ryan"><meta name=robots content="index, follow"><meta property="og:title" content="SuperMind第3讲：策略框架与生命周期管理 | 烧烤量化"><meta property="og:description" content="深入理解SuperMind策略框架：从初始化到执行结束的完整生命周期，掌握策略开发的核心架构模式。"><meta property="og:type" content="article"><meta property="og:url" content="https://sk-quant.github.io/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/03-%E7%AD%96%E7%95%A5%E6%A1%86%E6%9E%B6%E4%B8%8E%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86/"><meta property="og:site_name" content="烧烤量化"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="SuperMind第3讲：策略框架与生命周期管理 | 烧烤量化"><meta name=twitter:description content="深入理解SuperMind策略框架：从初始化到执行结束的完整生命周期，掌握策略开发的核心架构模式。"><link rel=icon type=image/x-icon href=/images/favicon.ico><link rel=canonical href=https://sk-quant.github.io/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/03-%E7%AD%96%E7%95%A5%E6%A1%86%E6%9E%B6%E4%B8%8E%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86/><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel=stylesheet><link rel=stylesheet href="/css/main.min.9a3c970d7feebe1317992d10ced98f226635b831a963ee601e5901734ff0da21.css"></head><body class="min-h-screen flex flex-col"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-XXXXXXX" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class="fixed top-0 left-0 right-0 z-50"><div class=mobile-menu-wrapper><input type=checkbox id=nav-toggle class=nav-toggle><header class="fixed w-full top-0 z-50 bg-white/80 backdrop-blur-sm border-b border-gray-100"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><nav class="flex items-center justify-between h-20"><a href=https://sk-quant.github.io/ class="flex items-center space-x-4"><img src=/images/logo.svg alt=烧烤量化 class=h-12>
<span class="text-3xl font-semibold text-gray-800">烧烤量化</span></a><div class="hidden md:flex items-center space-x-8"><a href=/path class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">学习路线</a><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化基础<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">回测平台</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化进阶<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">综合实战</a></div></div></div><div class="relative group"><button class="flex items-center text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">
量化高手<svg class="ml-2 w-4 h-4" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button><div class="absolute left-0 mt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out"><div class="py-6 bg-white border border-gray-100 shadow-xl rounded-lg"><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block px-8 py-3 text-sm text-gray-700 hover:bg-gray-50">股指期货</a></div></div></div><a href=/pricing class="text-base text-gray-900 hover:text-primary-600 font-bold transition duration-200">服务套餐</a></div><div class="hidden md:flex items-center space-x-4"><a href=/contact class="inline-flex items-center justify-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div><div class=md:hidden><label for=nav-toggle class="p-2 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-offset-2 transition-colors cursor-pointer"><svg class="w-6 h-6" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></label></div></nav></div><div class="nav-content md:hidden w-full fixed left-0 right-0 top-20 bg-white border-t border-gray-100 shadow-lg"><div class="w-full px-6 py-4"><a href=/path class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">学习路线</a><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化基础</div><div class=pl-4><a href=/categories/%e6%8a%95%e8%b5%84%e7%90%86%e8%ae%ba/ class="block text-gray-700 hover:text-primary-600 py-2">投资理论</a>
<a href=/categories/%e4%bb%a3%e7%a0%81%e5%9f%ba%e7%a1%80/ class="block text-gray-700 hover:text-primary-600 py-2">代码基础</a>
<a href=/categories/%e6%8a%80%e6%9c%af%e6%8c%87%e6%a0%87/ class="block text-gray-700 hover:text-primary-600 py-2">技术指标</a>
<a href=/categories/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0/ class="block text-gray-700 hover:text-primary-600 py-2">回测平台</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化进阶</div><div class=pl-4><a href=/categories/%e7%ad%96%e7%95%a5%e5%88%86%e4%ba%ab/ class="block text-gray-700 hover:text-primary-600 py-2">策略分享</a>
<a href=/categories/%e5%ae%9e%e7%9b%98%e5%b7%a5%e5%85%b7/ class="block text-gray-700 hover:text-primary-600 py-2">实盘工具</a>
<a href=/categories/%e7%83%ad%e7%82%b9%e9%a3%8e%e5%8f%a3/ class="block text-gray-700 hover:text-primary-600 py-2">热点风口</a>
<a href=/categories/%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98/ class="block text-gray-700 hover:text-primary-600 py-2">综合实战</a></div></div><div class=py-2><div class="text-xl text-gray-900 font-bold mb-2">量化高手</div><div class=pl-4><a href=/categories/%e5%8f%af%e8%bd%ac%e5%80%ba/ class="block text-gray-700 hover:text-primary-600 py-2">可转债</a>
<a href=/categories/%e8%9e%8d%e8%b5%84%e8%9e%8d%e5%88%b8/ class="block text-gray-700 hover:text-primary-600 py-2">融资融券</a>
<a href=/categories/%e8%82%a1%e7%a5%a8%e6%9c%9f%e6%9d%83/ class="block text-gray-700 hover:text-primary-600 py-2">股票期权</a>
<a href=/categories/%e8%82%a1%e6%8c%87%e6%9c%9f%e8%b4%a7/ class="block text-gray-700 hover:text-primary-600 py-2">股指期货</a></div></div><a href=/pricing class="block text-xl text-gray-900 hover:text-primary-600 font-bold transition duration-200 py-2">服务套餐</a><div class="pt-4 space-y-4"><a href=/contact class="block text-center px-6 py-3 rounded-lg font-bold transition duration-200 ease-in-out bg-primary-600 text-white hover:bg-primary-700 hover:scale-105">现在加入</a></div></div></div></header><style>.mobile-menu-wrapper{position:relative}.nav-toggle{display:none}.nav-content{display:none}.nav-toggle:checked~header .nav-content{display:block}</style></div></div><div class=pt-20><div class="container mx-auto px-4 py-12"><div class="flex flex-col lg:flex-row gap-8 mb-12"><article class=flex-1><header class=mb-8><div class=mb-4><a href=/categories/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0 class="inline-block px-3 py-1 text-sm font-medium text-primary-600 bg-primary-50 rounded-full hover:bg-primary-100 mr-2">回测平台</a></div><h1 class="text-4xl font-bold mb-4">SuperMind第3讲：策略框架与生命周期管理</h1><div class="flex flex-col space-y-4"><div class="flex items-center justify-between text-sm text-gray-500"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7A4 4 0 118 7a4 4 0 018 0zm-4 7a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
<span>Ryan</span></div><div class="flex items-center space-x-6"><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747.0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746.0-3.332.477-4.5 1.253"/></svg>
<span>18 分钟</span></div><div class="flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5A2 2 0 003 7v12a2 2 0 002 2z"/></svg>
<time datetime=2025-09-23>September 23, 2025</time></div></div></div><div class="flex items-center flex-wrap gap-2"><a href=/tags/2025 class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors duration-200">#2025
</a><a href=/tags/supermind class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition-colors duration-200">#SuperMind</a></div></div></header><div class=mb-8><img src=/images/blog/%e5%9b%9e%e6%b5%8b%e5%b9%b3%e5%8f%b0.jpg alt=SuperMind第3讲：策略框架与生命周期管理 class="w-full h-auto rounded-lg" loading=lazy></div><div class="prose prose-lg max-w-none"><div class="bg-gray-50 p-6 rounded-lg mb-8"><h2 class="text-xl font-semibold mb-4">目录</h2><nav id=TableOfContents><ul><li><a href=#supermind策略框架量化策略的骨架>SuperMind策略框架：量化策略的骨架</a><ul><li><a href=#策略框架的核心价值>策略框架的核心价值</a></li></ul></li><li><a href=#策略生命周期详解>策略生命周期详解</a><ul><li><a href=#初始化阶段策略的出生>初始化阶段：策略的"出生"</a></li><li><a href=#开盘前准备每日策略启动>开盘前准备：每日策略启动</a></li><li><a href=#盘中执行策略的日常工作>盘中执行：策略的"日常工作"</a></li><li><a href=#收盘后处理每日总结与准备>收盘后处理：每日总结与准备</a></li></ul></li><li><a href=#策略终止与清理优雅的生命周期结束>策略终止与清理：优雅的生命周期结束</a><ul><li><a href=#策略终止处理>策略终止处理</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div><h2 id=supermind策略框架量化策略的骨架>SuperMind策略框架：量化策略的骨架</h2><p>在量化交易中，策略框架就像是一座建筑的骨架，它决定了策略的结构、运行方式和扩展能力。SuperMind平台提供了完整而灵活的策略框架，支持从简单的单股票策略到复杂的多因子组合策略。深入理解这个框架，是开发专业级量化策略的关键一步。</p><h3 id=策略框架的核心价值>策略框架的核心价值</h3><p><strong>标准化执行流程</strong>：策略框架为所有策略提供了统一的执行流程，确保策略在不同市场环境下都能按照预期运行。这种标准化大大降低了策略开发的复杂度，让开发者可以专注于策略逻辑本身。</p><p><strong>生命周期管理</strong>：从策略初始化到每日调仓，再到策略终止，框架提供了完整的生命周期管理机制。这种机制确保策略在每个阶段都能正确执行相应的操作，避免遗漏关键环节。</p><p><strong>风险控制集成</strong>：框架内置了风险控制机制，包括仓位控制、止损止盈、异常处理等。这些机制为策略提供了基本的安全保障，防止因程序错误或市场异常导致的重大损失。</p><p><strong>扩展性设计</strong>：良好的框架设计支持策略的灵活扩展，无论是增加新的交易品种、调整策略参数，还是集成新的数据源，都能在框架内顺利完成。</p><h2 id=策略生命周期详解>策略生命周期详解</h2><h3 id=初始化阶段策略的出生>初始化阶段：策略的"出生"</h3><p>初始化阶段是策略生命周期的起点，在这个阶段，策略完成所有必要的准备工作。</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    策略初始化函数 - 策略的&#34;出生证明&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    参数:
</span></span></span><span class=line><span class=cl><span class=s2>        context: 策略上下文对象，存储策略运行状态和所有变量
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 策略初始化开始 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 1. 基础设置 - 定义策略的基本属性</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>strategy_name</span> <span class=o>=</span> <span class=s2>&#34;多因子选股策略&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>author</span> <span class=o>=</span> <span class=s2>&#34;QuantDeveloper&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>version</span> <span class=o>=</span> <span class=s2>&#34;1.0.0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>description</span> <span class=o>=</span> <span class=s2>&#34;基于价值因子和动量因子的多因子选股策略&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 2. 股票池设置 - 定义策略的交易范围</span>
</span></span><span class=line><span class=cl>    <span class=c1># 获取沪深300成分股作为基础股票池</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>stock_universe</span> <span class=o>=</span> <span class=n>get_index_stocks</span><span class=p>(</span><span class=s1>&#39;000300.SH&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;股票池大小: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>stock_universe</span><span class=p>)</span><span class=si>}</span><span class=s2>只股票&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 3. 策略参数配置 - 设置策略运行的关键参数</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>params</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;max_positions&#39;</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span>          <span class=c1># 最大持仓数量</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;position_size&#39;</span><span class=p>:</span> <span class=mf>0.05</span><span class=p>,</span>      <span class=c1># 单只股票最大仓位</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;stop_loss&#39;</span><span class=p>:</span> <span class=mf>0.08</span><span class=p>,</span>          <span class=c1># 止损比例</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;take_profit&#39;</span><span class=p>:</span> <span class=mf>0.20</span><span class=p>,</span>        <span class=c1># 止盈比例</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;rebalance_freq&#39;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>        <span class=c1># 调仓频率（天）</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;lookback_period&#39;</span><span class=p>:</span> <span class=mi>60</span>       <span class=c1># 因子计算回看期</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 4. 因子定义 - 设置策略使用的因子</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>factors</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;value_factor&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;pe_ratio&#39;</span><span class=p>,</span> <span class=s1>&#39;pb_ratio&#39;</span><span class=p>,</span> <span class=s1>&#39;ps_ratio&#39;</span><span class=p>],</span>      <span class=c1># 价值因子</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;momentum_factor&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;return_1m&#39;</span><span class=p>,</span> <span class=s1>&#39;return_3m&#39;</span><span class=p>,</span> <span class=s1>&#39;return_6m&#39;</span><span class=p>],</span> <span class=c1># 动量因子</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;quality_factor&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;roe&#39;</span><span class=p>,</span> <span class=s1>&#39;roa&#39;</span><span class=p>,</span> <span class=s1>&#39;debt_to_equity&#39;</span><span class=p>],</span>       <span class=c1># 质量因子</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;growth_factor&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;revenue_growth&#39;</span><span class=p>,</span> <span class=s1>&#39;profit_growth&#39;</span><span class=p>]</span>      <span class=c1># 成长因子</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 5. 运行状态变量 - 跟踪策略运行状态</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;initialized&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;first_trade_date&#39;</span><span class=p>:</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;total_days&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;rebalance_days&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;current_positions&#39;</span><span class=p>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;order_history&#39;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;performance_metrics&#39;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 6. 技术指标缓存 - 预计算常用技术指标</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>indicators</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 7. 风险控制设置</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>risk_controls</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;max_drawdown&#39;</span><span class=p>:</span> <span class=mf>0.15</span><span class=p>,</span>       <span class=c1># 最大回撤限制</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;max_turnover&#39;</span><span class=p>:</span> <span class=mf>0.50</span><span class=p>,</span>     <span class=c1># 最大换手率</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;sector_limit&#39;</span><span class=p>:</span> <span class=mf>0.30</span><span class=p>,</span>      <span class=c1># 行业集中度限制</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;market_neutral&#39;</span><span class=p>:</span> <span class=kc>True</span>     <span class=c1># 是否市场中性</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 策略初始化完成 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 8. 设置定时器 - 用于定期执行特定函数</span>
</span></span><span class=line><span class=cl>    <span class=n>run_daily</span><span class=p>(</span><span class=n>market_open</span><span class=p>,</span> <span class=n>time</span><span class=o>=</span><span class=s1>&#39;09:30&#39;</span><span class=p>)</span>    <span class=c1># 开盘时执行</span>
</span></span><span class=line><span class=cl>    <span class=n>run_daily</span><span class=p>(</span><span class=n>market_close</span><span class=p>,</span> <span class=n>time</span><span class=o>=</span><span class=s1>&#39;15:00&#39;</span><span class=p>)</span>   <span class=c1># 收盘时执行</span>
</span></span><span class=line><span class=cl>    <span class=n>run_daily</span><span class=p>(</span><span class=n>check_risk</span><span class=p>,</span> <span class=n>time</span><span class=o>=</span><span class=s1>&#39;14:30&#39;</span><span class=p>)</span>     <span class=c1># 风险检查</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 9. 设置事件监听</span>
</span></span><span class=line><span class=cl>    <span class=n>set_option</span><span class=p>(</span><span class=s1>&#39;use_real_price&#39;</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>      <span class=c1># 使用真实价格</span>
</span></span><span class=line><span class=cl>    <span class=n>set_option</span><span class=p>(</span><span class=s1>&#39;order_volume_ratio&#39;</span><span class=p>,</span> <span class=mf>0.25</span><span class=p>)</span>  <span class=c1># 订单成交比例</span>
</span></span><span class=line><span class=cl>    <span class=n>set_slippage</span><span class=p>(</span><span class=n>PriceRelatedSlippage</span><span class=p>(</span><span class=mf>0.002</span><span class=p>))</span>  <span class=c1># 设置滑点</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>context</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>advanced_initialize</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    高级初始化示例 - 多策略组合管理
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 定义多个子策略</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>sub_strategies</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;momentum_strategy&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;weight&#39;</span><span class=p>:</span> <span class=mf>0.4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;universe&#39;</span><span class=p>:</span> <span class=n>get_index_stocks</span><span class=p>(</span><span class=s1>&#39;000905.SH&#39;</span><span class=p>),</span>  <span class=c1># 中证500</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;params&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;lookback&#39;</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span> <span class=s1>&#39;holding_period&#39;</span><span class=p>:</span> <span class=mi>5</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;value_strategy&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;weight&#39;</span><span class=p>:</span> <span class=mf>0.3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;universe&#39;</span><span class=p>:</span> <span class=n>get_index_stocks</span><span class=p>(</span><span class=s1>&#39;000016.SH&#39;</span><span class=p>),</span>   <span class=c1># 上证50</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;params&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;pe_threshold&#39;</span><span class=p>:</span> <span class=mi>15</span><span class=p>,</span> <span class=s1>&#39;pb_threshold&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;quality_strategy&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;weight&#39;</span><span class=p>:</span> <span class=mf>0.3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;universe&#39;</span><span class=p>:</span> <span class=n>get_index_stocks</span><span class=p>(</span><span class=s1>&#39;399006.SZ&#39;</span><span class=p>),</span>   <span class=c1># 创业板指</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;params&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;roe_threshold&#39;</span><span class=p>:</span> <span class=mf>0.15</span><span class=p>,</span> <span class=s1>&#39;debt_ratio_max&#39;</span><span class=p>:</span> <span class=mf>0.5</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 为每个子策略分配独立的仓位管理</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>position_managers</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>strategy_name</span><span class=p>,</span> <span class=n>config</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>sub_strategies</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=n>position_managers</span><span class=p>[</span><span class=n>strategy_name</span><span class=p>]</span> <span class=o>=</span> <span class=n>PositionManager</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>max_weight</span><span class=o>=</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;weight&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>max_positions</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>stop_loss</span><span class=o>=</span><span class=mf>0.10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>take_profit</span><span class=o>=</span><span class=mf>0.25</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 设置策略间相关性监控</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>correlation_monitor</span> <span class=o>=</span> <span class=n>CorrelationMonitor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>window</span><span class=o>=</span><span class=mi>60</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>threshold</span><span class=o>=</span><span class=mf>0.7</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;多策略组合初始化完成&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>context</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PositionManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    仓位管理器 - 专业的仓位管理工具
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>max_weight</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span> <span class=n>max_positions</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span> <span class=n>stop_loss</span><span class=o>=</span><span class=mf>0.08</span><span class=p>,</span> <span class=n>take_profit</span><span class=o>=</span><span class=mf>0.20</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_weight</span> <span class=o>=</span> <span class=n>max_weight</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_positions</span> <span class=o>=</span> <span class=n>max_positions</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>stop_loss</span> <span class=o>=</span> <span class=n>stop_loss</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>take_profit</span> <span class=o>=</span> <span class=n>take_profit</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>positions</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cash_weight</span> <span class=o>=</span> <span class=mf>1.0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_position_size</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>stock</span><span class=p>,</span> <span class=n>current_price</span><span class=p>,</span> <span class=n>confidence_score</span><span class=p>,</span> <span class=n>volatility</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        计算单只股票的目标仓位
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 基于凯利公式计算仓位</span>
</span></span><span class=line><span class=cl>        <span class=n>win_rate</span> <span class=o>=</span> <span class=mf>0.55</span>  <span class=c1># 假设胜率55%</span>
</span></span><span class=line><span class=cl>        <span class=n>avg_win</span> <span class=o>=</span> <span class=mf>0.08</span>   <span class=c1># 平均盈利8%</span>
</span></span><span class=line><span class=cl>        <span class=n>avg_loss</span> <span class=o>=</span> <span class=mf>0.05</span>  <span class=c1># 平均亏损5%</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>kelly_fraction</span> <span class=o>=</span> <span class=p>(</span><span class=n>win_rate</span> <span class=o>*</span> <span class=n>avg_win</span> <span class=o>-</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>win_rate</span><span class=p>)</span> <span class=o>*</span> <span class=n>avg_loss</span><span class=p>)</span> <span class=o>/</span> <span class=n>avg_win</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 根据波动率调整（波动率越高，仓位越小）</span>
</span></span><span class=line><span class=cl>        <span class=n>volatility_adjustment</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=mf>1.0</span><span class=p>,</span> <span class=mf>0.20</span> <span class=o>/</span> <span class=n>volatility</span><span class=p>)</span>  <span class=c1># 目标波动率20%</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 根据置信度调整</span>
</span></span><span class=line><span class=cl>        <span class=n>confidence_adjustment</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=mf>0.5</span><span class=p>,</span> <span class=nb>min</span><span class=p>(</span><span class=mf>1.0</span><span class=p>,</span> <span class=n>confidence_score</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算最终仓位</span>
</span></span><span class=line><span class=cl>        <span class=n>position_size</span> <span class=o>=</span> <span class=n>kelly_fraction</span> <span class=o>*</span> <span class=n>volatility_adjustment</span> <span class=o>*</span> <span class=n>confidence_adjustment</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 应用限制</span>
</span></span><span class=line><span class=cl>        <span class=n>position_size</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>position_size</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_weight</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>position_size</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>update_position</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>stock</span><span class=p>,</span> <span class=n>new_weight</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        更新股票仓位
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>old_weight</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>positions</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>weight_change</span> <span class=o>=</span> <span class=n>new_weight</span> <span class=o>-</span> <span class=n>old_weight</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=n>weight_change</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mf>0.001</span><span class=p>:</span>  <span class=c1># 仓位变化超过0.1%才调整</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>cash_weight</span> <span class=o>-=</span> <span class=n>weight_change</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>positions</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_weight</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;调整 </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2> 仓位: </span><span class=si>{</span><span class=n>old_weight</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2> -&gt; </span><span class=si>{</span><span class=n>new_weight</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_stop_loss_take_profit</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>stock</span><span class=p>,</span> <span class=n>current_price</span><span class=p>,</span> <span class=n>entry_price</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        检查止损止盈
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stock</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>positions</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>positions</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=n>return_pct</span> <span class=o>=</span> <span class=p>(</span><span class=n>current_price</span> <span class=o>-</span> <span class=n>entry_price</span><span class=p>)</span> <span class=o>/</span> <span class=n>entry_price</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>return_pct</span> <span class=o>&lt;=</span> <span class=o>-</span><span class=bp>self</span><span class=o>.</span><span class=n>stop_loss</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s1>&#39;stop_loss&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>return_pct</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>take_profit</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s1>&#39;take_profit&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CorrelationMonitor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    相关性监控器 - 监控策略间相关性
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>window</span><span class=o>=</span><span class=mi>60</span><span class=p>,</span> <span class=n>threshold</span><span class=o>=</span><span class=mf>0.7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>window</span> <span class=o>=</span> <span class=n>window</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>threshold</span> <span class=o>=</span> <span class=n>threshold</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>returns_history</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>update_returns</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>strategy_name</span><span class=p>,</span> <span class=n>returns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        更新策略收益率历史
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>strategy_name</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>returns_history</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>returns_history</span><span class=p>[</span><span class=n>strategy_name</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>returns_history</span><span class=p>[</span><span class=n>strategy_name</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 保持窗口大小</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>returns_history</span><span class=p>[</span><span class=n>strategy_name</span><span class=p>])</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>window</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>returns_history</span><span class=p>[</span><span class=n>strategy_name</span><span class=p>]</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_correlation_risk</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        检查策略间相关性风险
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>returns_history</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=c1># 计算策略间相关性</span>
</span></span><span class=line><span class=cl>        <span class=n>strategies</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>returns_history</span><span class=o>.</span><span class=n>keys</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>high_correlations</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>strategies</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>strategies</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                <span class=n>strategy1</span> <span class=o>=</span> <span class=n>strategies</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>strategy2</span> <span class=o>=</span> <span class=n>strategies</span><span class=p>[</span><span class=n>j</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>returns1</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>returns_history</span><span class=p>[</span><span class=n>strategy1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>returns2</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>returns_history</span><span class=p>[</span><span class=n>strategy2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>returns1</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>window</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>returns2</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>window</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>correlation</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>corrcoef</span><span class=p>(</span><span class=n>returns1</span><span class=p>[</span><span class=o>-</span><span class=bp>self</span><span class=o>.</span><span class=n>window</span><span class=p>:],</span> 
</span></span><span class=line><span class=cl>                                             <span class=n>returns2</span><span class=p>[</span><span class=o>-</span><span class=bp>self</span><span class=o>.</span><span class=n>window</span><span class=p>:])[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=n>correlation</span><span class=p>)</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>threshold</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>high_correlations</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>strategy1</span><span class=p>,</span> <span class=n>strategy2</span><span class=p>,</span> <span class=n>correlation</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>high_correlations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;发现高相关性策略组合:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>s1</span><span class=p>,</span> <span class=n>s2</span><span class=p>,</span> <span class=n>corr</span> <span class=ow>in</span> <span class=n>high_correlations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>s1</span><span class=si>}</span><span class=s2> 与 </span><span class=si>{</span><span class=n>s2</span><span class=si>}</span><span class=s2>: 相关系数 = </span><span class=si>{</span><span class=n>corr</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=开盘前准备每日策略启动>开盘前准备：每日策略启动</h3><p>开盘前阶段是策略每日运行的起点，负责准备当天的交易环境。</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>before_trading_start</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    开盘前准备函数 - 每日策略启动
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    参数:
</span></span></span><span class=line><span class=cl><span class=s2>        context: 策略上下文
</span></span></span><span class=line><span class=cl><span class=s2>        data: 市场数据对象
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>current_date</span> <span class=o>=</span> <span class=n>get_datetime</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 开盘前准备: </span><span class=si>{</span><span class=n>current_date</span><span class=si>}</span><span class=s2> ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 1. 更新运行状态</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;total_days&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_date&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>current_date</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 2. 获取当日市场信息</span>
</span></span><span class=line><span class=cl>    <span class=n>today_info</span> <span class=o>=</span> <span class=n>get_today_info</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;今日市场状态: </span><span class=si>{</span><span class=n>today_info</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 3. 更新股票池（处理新股、退市股）</span>
</span></span><span class=line><span class=cl>    <span class=n>update_universe</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 4. 获取最新市场数据</span>
</span></span><span class=line><span class=cl>    <span class=n>fetch_market_data</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 5. 计算因子得分</span>
</span></span><span class=line><span class=cl>    <span class=n>calculate_factors</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 6. 风险预算评估</span>
</span></span><span class=line><span class=cl>    <span class=n>assess_risk_budget</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 7. 生成交易信号</span>
</span></span><span class=line><span class=cl>    <span class=n>generate_signals</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 开盘前准备完成 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_today_info</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取当日市场信息
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取市场状态</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>[</span><span class=s1>&#39;market_status&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;open&#39;</span>  <span class=c1># 假设市场开放</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>[</span><span class=s1>&#39;is_trading_day&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取前一交易日信息</span>
</span></span><span class=line><span class=cl>    <span class=n>previous_date</span> <span class=o>=</span> <span class=n>get_previous_trading_date</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>[</span><span class=s1>&#39;previous_date&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>previous_date</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取重要公告信息</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>[</span><span class=s1>&#39;important_announcements&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>get_announcements</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取宏观数据发布</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>[</span><span class=s1>&#39;macro_events&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>get_macro_events</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>info</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_universe</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    更新股票池
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;正在更新股票池...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取当前指数成分股</span>
</span></span><span class=line><span class=cl>    <span class=n>current_universe</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>get_index_stocks</span><span class=p>(</span><span class=s1>&#39;000300.SH&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>previous_universe</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>stock_universe</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 找出新增股票</span>
</span></span><span class=line><span class=cl>    <span class=n>new_stocks</span> <span class=o>=</span> <span class=n>current_universe</span> <span class=o>-</span> <span class=n>previous_universe</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>new_stocks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;新增股票: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>new_stocks</span><span class=p>)</span><span class=si>}</span><span class=s2>只&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=nb>list</span><span class=p>(</span><span class=n>new_stocks</span><span class=p>)[:</span><span class=mi>5</span><span class=p>]:</span>  <span class=c1># 只显示前5个</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  - </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 找出删除股票</span>
</span></span><span class=line><span class=cl>    <span class=n>removed_stocks</span> <span class=o>=</span> <span class=n>previous_universe</span> <span class=o>-</span> <span class=n>current_universe</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>removed_stocks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;删除股票: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>removed_stocks</span><span class=p>)</span><span class=si>}</span><span class=s2>只&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=nb>list</span><span class=p>(</span><span class=n>removed_stocks</span><span class=p>)[:</span><span class=mi>5</span><span class=p>]:</span>  <span class=c1># 只显示前5个</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  - </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 更新股票池</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>stock_universe</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>current_universe</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 清理已删除股票的持仓和缓存</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>removed_stocks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;警告: 持仓股票 </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2> 已被移出股票池&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>indicators</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>del</span> <span class=n>context</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fetch_market_data</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取最新市场数据
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;正在获取市场数据...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取股票池的历史数据</span>
</span></span><span class=line><span class=cl>    <span class=n>stock_list</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>stock_universe</span><span class=p>[:</span><span class=mi>100</span><span class=p>]</span>  <span class=c1># 限制数量避免超时</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取价格数据</span>
</span></span><span class=line><span class=cl>    <span class=n>price_data</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=n>stock_list</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>,</span> <span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=s1>&#39;volume&#39;</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                        <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;lookback_period&#39;</span><span class=p>],</span> <span class=s1>&#39;1d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取财务数据</span>
</span></span><span class=line><span class=cl>    <span class=n>fundamental_data</span> <span class=o>=</span> <span class=n>get_fundamentals</span><span class=p>(</span><span class=n>stock_list</span><span class=p>,</span> <span class=s1>&#39;valuation&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取技术指标</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>stock_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>price_data</span><span class=o>.</span><span class=n>index</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>stock_data</span> <span class=o>=</span> <span class=n>price_data</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 计算技术指标</span>
</span></span><span class=line><span class=cl>            <span class=n>indicators</span> <span class=o>=</span> <span class=n>calculate_technical_indicators</span><span class=p>(</span><span class=n>stock_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span> <span class=o>=</span> <span class=n>indicators</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取市场基准数据</span>
</span></span><span class=line><span class=cl>    <span class=n>benchmark_data</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=s1>&#39;000300.SH&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>],</span> <span class=mi>60</span><span class=p>,</span> <span class=s1>&#39;1d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>benchmark_returns</span> <span class=o>=</span> <span class=n>benchmark_data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>pct_change</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;数据获取完成: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>stock_list</span><span class=p>)</span><span class=si>}</span><span class=s2>只股票&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_factors</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算因子得分
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;正在计算因子得分...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取股票池数据</span>
</span></span><span class=line><span class=cl>    <span class=n>stock_list</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>stock_universe</span><span class=p>[:</span><span class=mi>100</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取因子数据</span>
</span></span><span class=line><span class=cl>    <span class=n>factor_data</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>factor_type</span><span class=p>,</span> <span class=n>factor_list</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>factors</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_data</span><span class=p>[</span><span class=n>factor_type</span><span class=p>]</span> <span class=o>=</span> <span class=n>get_fundamentals</span><span class=p>(</span><span class=n>stock_list</span><span class=p>,</span> <span class=n>factor_list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算因子得分</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>factor_scores</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>stock_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stock</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>factor_scores</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>factor_scores</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 价值因子得分（越低越好）</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>factor_data</span><span class=p>[</span><span class=s1>&#39;value_factor&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>index</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>pe_rank</span> <span class=o>=</span> <span class=n>factor_data</span><span class=p>[</span><span class=s1>&#39;value_factor&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>stock</span><span class=p>,</span> <span class=s1>&#39;pe_ratio&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rank</span><span class=p>(</span><span class=n>pct</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>pb_rank</span> <span class=o>=</span> <span class=n>factor_data</span><span class=p>[</span><span class=s1>&#39;value_factor&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>stock</span><span class=p>,</span> <span class=s1>&#39;pb_ratio&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rank</span><span class=p>(</span><span class=n>pct</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>factor_scores</span><span class=p>[</span><span class=n>stock</span><span class=p>][</span><span class=s1>&#39;value_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>pe_rank</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.5</span> <span class=o>+</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>pb_rank</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 动量因子得分（越高越好）</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>indicators</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>momentum_score</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;momentum_score&#39;</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>factor_scores</span><span class=p>[</span><span class=n>stock</span><span class=p>][</span><span class=s1>&#39;momentum_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>momentum_score</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 质量因子得分</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>factor_data</span><span class=p>[</span><span class=s1>&#39;quality_factor&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>index</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>roe_score</span> <span class=o>=</span> <span class=n>factor_data</span><span class=p>[</span><span class=s1>&#39;quality_factor&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>stock</span><span class=p>,</span> <span class=s1>&#39;roe&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>rank</span><span class=p>(</span><span class=n>pct</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>factor_scores</span><span class=p>[</span><span class=n>stock</span><span class=p>][</span><span class=s1>&#39;quality_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>roe_score</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 综合得分</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>factor_scores</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>scores</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>factor_scores</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>scores</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>context</span><span class=o>.</span><span class=n>factor_scores</span><span class=p>[</span><span class=n>stock</span><span class=p>][</span><span class=s1>&#39;total_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>scores</span><span class=o>.</span><span class=n>values</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;因子计算完成&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>assess_risk_budget</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    风险预算评估
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;正在评估风险预算...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算当前组合风险</span>
</span></span><span class=line><span class=cl>    <span class=n>current_positions</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>current_positions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 获取持仓股票的历史收益率</span>
</span></span><span class=line><span class=cl>        <span class=n>position_stocks</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>current_positions</span><span class=o>.</span><span class=n>keys</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>returns_data</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=n>position_stocks</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>],</span> <span class=mi>60</span><span class=p>,</span> <span class=s1>&#39;1d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算组合波动率</span>
</span></span><span class=line><span class=cl>        <span class=n>portfolio_returns</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>date</span> <span class=ow>in</span> <span class=n>returns_data</span><span class=o>.</span><span class=n>index</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>daily_return</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=n>total_weight</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>position_stocks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>returns_data</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>weight</span> <span class=o>=</span> <span class=n>current_positions</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=n>stock_return</span> <span class=o>=</span> <span class=n>returns_data</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>date</span><span class=p>,</span> <span class=n>stock</span><span class=p>]</span> <span class=o>/</span> <span class=n>returns_data</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>date</span><span class=p>,</span> <span class=n>stock</span><span class=p>]</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                    <span class=n>daily_return</span> <span class=o>+=</span> <span class=n>weight</span> <span class=o>*</span> <span class=n>stock_return</span>
</span></span><span class=line><span class=cl>                    <span class=n>total_weight</span> <span class=o>+=</span> <span class=n>weight</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>total_weight</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>portfolio_returns</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>daily_return</span> <span class=o>/</span> <span class=n>total_weight</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算波动率</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>portfolio_returns</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>20</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>portfolio_volatility</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>portfolio_returns</span><span class=p>)</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;portfolio_volatility&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>portfolio_volatility</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;当前组合波动率: </span><span class=si>{</span><span class=n>portfolio_volatility</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 检查是否超过风险预算</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>portfolio_volatility</span> <span class=o>&gt;</span> <span class=n>context</span><span class=o>.</span><span class=n>risk_controls</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_volatility&#39;</span><span class=p>,</span> <span class=mf>0.25</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;警告: 组合波动率超过风险预算！&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;risk_budget_exceeded&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;risk_budget_exceeded&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_signals</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    生成交易信号
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;正在生成交易信号...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取因子得分最高的股票</span>
</span></span><span class=line><span class=cl>    <span class=n>all_scores</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span><span class=p>,</span> <span class=n>scores</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>factor_scores</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;total_score&#39;</span> <span class=ow>in</span> <span class=n>scores</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>all_scores</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span> <span class=o>=</span> <span class=n>scores</span><span class=p>[</span><span class=s1>&#39;total_score&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 排序并选择前N只股票</span>
</span></span><span class=line><span class=cl>    <span class=n>sorted_stocks</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>all_scores</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>top_stocks</span> <span class=o>=</span> <span class=p>[</span><span class=n>stock</span> <span class=k>for</span> <span class=n>stock</span><span class=p>,</span> <span class=n>score</span> <span class=ow>in</span> <span class=n>sorted_stocks</span><span class=p>[:</span><span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;max_positions&#39;</span><span class=p>]]]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 生成买入信号</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>buy_signals</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>top_stocks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stock</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>signal</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;stock&#39;</span><span class=p>:</span> <span class=n>stock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=s1>&#39;buy&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;score&#39;</span><span class=p>:</span> <span class=n>all_scores</span><span class=p>[</span><span class=n>stock</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;confidence&#39;</span><span class=p>:</span> <span class=nb>min</span><span class=p>(</span><span class=mf>1.0</span><span class=p>,</span> <span class=n>all_scores</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span> <span class=o>*</span> <span class=mi>2</span><span class=p>)</span>  <span class=c1># 置信度</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>buy_signals</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 生成卖出信号</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>sell_signals</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stock</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>top_stocks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>signal</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;stock&#39;</span><span class=p>:</span> <span class=n>stock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=s1>&#39;sell&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;reason&#39;</span><span class=p>:</span> <span class=s1>&#39;factor_score_low&#39;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>sell_signals</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;生成买入信号: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>buy_signals</span><span class=p>)</span><span class=si>}</span><span class=s2>个&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;生成卖出信号: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>sell_signals</span><span class=p>)</span><span class=si>}</span><span class=s2>个&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_technical_indicators</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算技术指标
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>indicators</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 简单动量得分</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>60</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>return_1m</span> <span class=o>=</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>20</span><span class=p>])</span> <span class=o>/</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>20</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>return_3m</span> <span class=o>=</span> <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>60</span><span class=p>])</span> <span class=o>/</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>60</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 标准化到0-1区间</span>
</span></span><span class=line><span class=cl>        <span class=n>indicators</span><span class=p>[</span><span class=s1>&#39;momentum_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>tanh</span><span class=p>(</span><span class=n>return_1m</span> <span class=o>*</span> <span class=mi>5</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span> <span class=o>*</span> <span class=mf>0.5</span> <span class=o>+</span> \
</span></span><span class=line><span class=cl>                                      <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>tanh</span><span class=p>(</span><span class=n>return_3m</span> <span class=o>*</span> <span class=mi>2</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span> <span class=o>*</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>indicators</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_previous_trading_date</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取前一交易日
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 这里简化处理，实际需要根据交易日历</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>get_datetime</span><span class=p>()</span> <span class=o>-</span> <span class=n>datetime</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_announcements</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取重要公告
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 简化实现</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_macro_events</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取宏观事件
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 简化实现</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[]</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=盘中执行策略的日常工作>盘中执行：策略的"日常工作"</h3><p>盘中执行阶段是策略的核心工作时段，负责处理交易信号、执行订单和风险管理。</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span><span class=lnt>353
</span><span class=lnt>354
</span><span class=lnt>355
</span><span class=lnt>356
</span><span class=lnt>357
</span><span class=lnt>358
</span><span class=lnt>359
</span><span class=lnt>360
</span><span class=lnt>361
</span><span class=lnt>362
</span><span class=lnt>363
</span><span class=lnt>364
</span><span class=lnt>365
</span><span class=lnt>366
</span><span class=lnt>367
</span><span class=lnt>368
</span><span class=lnt>369
</span><span class=lnt>370
</span><span class=lnt>371
</span><span class=lnt>372
</span><span class=lnt>373
</span><span class=lnt>374
</span><span class=lnt>375
</span><span class=lnt>376
</span><span class=lnt>377
</span><span class=lnt>378
</span><span class=lnt>379
</span><span class=lnt>380
</span><span class=lnt>381
</span><span class=lnt>382
</span><span class=lnt>383
</span><span class=lnt>384
</span><span class=lnt>385
</span><span class=lnt>386
</span><span class=lnt>387
</span><span class=lnt>388
</span><span class=lnt>389
</span><span class=lnt>390
</span><span class=lnt>391
</span><span class=lnt>392
</span><span class=lnt>393
</span><span class=lnt>394
</span><span class=lnt>395
</span><span class=lnt>396
</span><span class=lnt>397
</span><span class=lnt>398
</span><span class=lnt>399
</span><span class=lnt>400
</span><span class=lnt>401
</span><span class=lnt>402
</span><span class=lnt>403
</span><span class=lnt>404
</span><span class=lnt>405
</span><span class=lnt>406
</span><span class=lnt>407
</span><span class=lnt>408
</span><span class=lnt>409
</span><span class=lnt>410
</span><span class=lnt>411
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_data</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    盘中数据处理函数 - 策略的&#34;日常工作&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    参数:
</span></span></span><span class=line><span class=cl><span class=s2>        context: 策略上下文
</span></span></span><span class=line><span class=cl><span class=s2>        data: 实时市场数据
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>current_time</span> <span class=o>=</span> <span class=n>get_datetime</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%H:%M:%S&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 只在交易时间内执行</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>is_trading_time</span><span class=p>(</span><span class=n>current_time</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 1. 更新实时数据</span>
</span></span><span class=line><span class=cl>    <span class=n>update_realtime_data</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 2. 检查持仓风险</span>
</span></span><span class=line><span class=cl>    <span class=n>check_position_risks</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 3. 执行交易信号</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>should_rebalance</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>execute_signals</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 4. 处理紧急信号</span>
</span></span><span class=line><span class=cl>    <span class=n>handle_emergency_signals</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 5. 更新策略状态</span>
</span></span><span class=line><span class=cl>    <span class=n>update_strategy_status</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>is_trading_time</span><span class=p>(</span><span class=n>current_time</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    检查是否为交易时间
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 简化的交易时间检查</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;09:30:00&#39;</span> <span class=o>&lt;=</span> <span class=n>current_time</span> <span class=o>&lt;=</span> <span class=s1>&#39;15:00:00&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_realtime_data</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    更新实时数据
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 获取当前持仓的实时价格</span>
</span></span><span class=line><span class=cl>    <span class=n>current_positions</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>current_positions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>current_price</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span><span class=o>.</span><span class=n>close</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 更新持仓信息</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>stock</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;position_info&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;position_info&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;position_info&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>][</span><span class=s1>&#39;current_price&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>current_price</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;position_info&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>][</span><span class=s1>&#39;last_update&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>get_datetime</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 计算浮动盈亏</span>
</span></span><span class=line><span class=cl>            <span class=n>entry_price</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;position_info&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;entry_price&#39;</span><span class=p>,</span> <span class=n>current_price</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>unrealized_pnl</span> <span class=o>=</span> <span class=p>(</span><span class=n>current_price</span> <span class=o>-</span> <span class=n>entry_price</span><span class=p>)</span> <span class=o>/</span> <span class=n>entry_price</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;position_info&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>][</span><span class=s1>&#39;unrealized_pnl&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>unrealized_pnl</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_position_risks</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    检查持仓风险
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>current_positions</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>position_info</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;position_info&#39;</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>current_positions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>position_info</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>unrealized_pnl</span> <span class=o>=</span> <span class=n>position_info</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;unrealized_pnl&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 检查止损</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>unrealized_pnl</span> <span class=o>&lt;=</span> <span class=o>-</span><span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;stop_loss&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;止损警告: </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2> 亏损 </span><span class=si>{</span><span class=n>unrealized_pnl</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 生成止损信号</span>
</span></span><span class=line><span class=cl>                <span class=n>emergency_signal</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;stock&#39;</span><span class=p>:</span> <span class=n>stock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=s1>&#39;sell&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;reason&#39;</span><span class=p>:</span> <span class=s1>&#39;stop_loss&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;urgency&#39;</span><span class=p>:</span> <span class=s1>&#39;high&#39;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=s1>&#39;emergency_signals&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;emergency_signals&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;emergency_signals&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>emergency_signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 检查止盈</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>unrealized_pnl</span> <span class=o>&gt;=</span> <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;take_profit&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;止盈提醒: </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2> 盈利 </span><span class=si>{</span><span class=n>unrealized_pnl</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 生成止盈信号</span>
</span></span><span class=line><span class=cl>                <span class=n>take_profit_signal</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;stock&#39;</span><span class=p>:</span> <span class=n>stock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=s1>&#39;sell&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;reason&#39;</span><span class=p>:</span> <span class=s1>&#39;take_profit&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;urgency&#39;</span><span class=p>:</span> <span class=s1>&#39;medium&#39;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=s1>&#39;take_profit_signals&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;take_profit_signals&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;take_profit_signals&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>take_profit_signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 检查时间止损</span>
</span></span><span class=line><span class=cl>            <span class=n>holding_days</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;position_info&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;holding_days&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>holding_days</span> <span class=o>&gt;</span> <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_holding_period&#39;</span><span class=p>,</span> <span class=mi>20</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>time_stop_signal</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;stock&#39;</span><span class=p>:</span> <span class=n>stock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=s1>&#39;sell&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;reason&#39;</span><span class=p>:</span> <span class=s1>&#39;time_stop&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;urgency&#39;</span><span class=p>:</span> <span class=s1>&#39;low&#39;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=s1>&#39;time_stop_signals&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;time_stop_signals&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;time_stop_signals&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>time_stop_signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>should_rebalance</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    判断是否需要调仓
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 检查调仓频率</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;total_days&#39;</span><span class=p>]</span> <span class=o>%</span> <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;rebalance_freq&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 检查是否有紧急信号</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;emergency_signals&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 检查风险预算</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;risk_budget_exceeded&#39;</span><span class=p>,</span> <span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>execute_signals</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    执行交易信号
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 开始执行交易信号 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 1. 处理紧急信号（最高优先级）</span>
</span></span><span class=line><span class=cl>    <span class=n>emergency_signals</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;emergency_signals&#39;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>signal</span> <span class=ow>in</span> <span class=n>emergency_signals</span><span class=p>[:]:</span>
</span></span><span class=line><span class=cl>        <span class=n>execute_single_signal</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>emergency_signals</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 2. 处理止盈信号</span>
</span></span><span class=line><span class=cl>    <span class=n>take_profit_signals</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;take_profit_signals&#39;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>signal</span> <span class=ow>in</span> <span class=n>take_profit_signals</span><span class=p>[:]:</span>
</span></span><span class=line><span class=cl>        <span class=n>execute_single_signal</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>take_profit_signals</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 3. 处理时间止损信号</span>
</span></span><span class=line><span class=cl>    <span class=n>time_stop_signals</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;time_stop_signals&#39;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>signal</span> <span class=ow>in</span> <span class=n>time_stop_signals</span><span class=p>[:]:</span>
</span></span><span class=line><span class=cl>        <span class=n>execute_single_signal</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time_stop_signals</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 4. 执行常规调仓信号</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;total_days&#39;</span><span class=p>]</span> <span class=o>%</span> <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;rebalance_freq&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>execute_regular_rebalance</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 交易信号执行完成 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>execute_single_signal</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>signal</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    执行单个交易信号
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stock</span> <span class=o>=</span> <span class=n>signal</span><span class=p>[</span><span class=s1>&#39;stock&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>action</span> <span class=o>=</span> <span class=n>signal</span><span class=p>[</span><span class=s1>&#39;action&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>reason</span> <span class=o>=</span> <span class=n>signal</span><span class=p>[</span><span class=s1>&#39;reason&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>urgency</span> <span class=o>=</span> <span class=n>signal</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;urgency&#39;</span><span class=p>,</span> <span class=s1>&#39;normal&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;执行信号: </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>action</span><span class=si>}</span><span class=s2> (原因: </span><span class=si>{</span><span class=n>reason</span><span class=si>}</span><span class=s2>, 紧急程度: </span><span class=si>{</span><span class=n>urgency</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>action</span> <span class=o>==</span> <span class=s1>&#39;sell&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 卖出信号</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>current_weight</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 执行卖出</span>
</span></span><span class=line><span class=cl>            <span class=n>order_target_percent</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 更新持仓记录</span>
</span></span><span class=line><span class=cl>            <span class=k>del</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 记录交易</span>
</span></span><span class=line><span class=cl>            <span class=n>record_trade</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>stock</span><span class=p>,</span> <span class=s1>&#39;sell&#39;</span><span class=p>,</span> <span class=n>current_weight</span><span class=p>,</span> <span class=n>reason</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  卖出 </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>current_weight</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  警告: 尝试卖出未持仓股票 </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>action</span> <span class=o>==</span> <span class=s1>&#39;buy&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 买入信号</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stock</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 计算目标仓位</span>
</span></span><span class=line><span class=cl>            <span class=n>target_weight</span> <span class=o>=</span> <span class=n>calculate_target_weight</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>stock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 检查仓位限制</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>can_add_position</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>target_weight</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># 执行买入</span>
</span></span><span class=line><span class=cl>                <span class=n>order_target_percent</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=n>target_weight</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 更新持仓记录</span>
</span></span><span class=line><span class=cl>                <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>]</span> <span class=o>=</span> <span class=n>target_weight</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 记录交易</span>
</span></span><span class=line><span class=cl>                <span class=n>record_trade</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>stock</span><span class=p>,</span> <span class=s1>&#39;buy&#39;</span><span class=p>,</span> <span class=n>target_weight</span><span class=p>,</span> <span class=n>reason</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  买入 </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>target_weight</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  跳过 </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2>: 仓位限制&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>execute_regular_rebalance</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    执行常规调仓
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;执行常规调仓...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 1. 卖出不符合条件的股票</span>
</span></span><span class=line><span class=cl>    <span class=n>sell_signals</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>sell_signals</span> <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=s1>&#39;sell_signals&#39;</span><span class=p>)</span> <span class=k>else</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>signal</span> <span class=ow>in</span> <span class=n>sell_signals</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>execute_single_signal</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 2. 买入新股票</span>
</span></span><span class=line><span class=cl>    <span class=n>buy_signals</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>buy_signals</span> <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=s1>&#39;buy_signals&#39;</span><span class=p>)</span> <span class=k>else</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>signal</span> <span class=ow>in</span> <span class=n>buy_signals</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>execute_single_signal</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>signal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 3. 调整现有仓位</span>
</span></span><span class=line><span class=cl>    <span class=n>adjust_existing_positions</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_target_weight</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>stock</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算目标仓位
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 基础仓位大小</span>
</span></span><span class=line><span class=cl>    <span class=n>base_weight</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;position_size&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 根据因子得分调整</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>factor_scores</span> <span class=ow>and</span> <span class=s1>&#39;total_score&#39;</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>factor_scores</span><span class=p>[</span><span class=n>stock</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>score</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>factor_scores</span><span class=p>[</span><span class=n>stock</span><span class=p>][</span><span class=s1>&#39;total_score&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=c1># 得分越高，仓位越大</span>
</span></span><span class=line><span class=cl>        <span class=n>score_adjustment</span> <span class=o>=</span> <span class=mf>0.5</span> <span class=o>+</span> <span class=n>score</span> <span class=o>*</span> <span class=mf>0.5</span>  <span class=c1># 0.5 到 1.0</span>
</span></span><span class=line><span class=cl>        <span class=n>base_weight</span> <span class=o>*=</span> <span class=n>score_adjustment</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 根据波动率调整（可选）</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>indicators</span> <span class=ow>and</span> <span class=s1>&#39;volatility&#39;</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>stock</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>volatility</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>stock</span><span class=p>][</span><span class=s1>&#39;volatility&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=c1># 波动率越高，仓位越小</span>
</span></span><span class=line><span class=cl>        <span class=n>vol_adjustment</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=mf>1.0</span><span class=p>,</span> <span class=mf>0.20</span> <span class=o>/</span> <span class=n>volatility</span><span class=p>)</span>  <span class=c1># 目标波动率20%</span>
</span></span><span class=line><span class=cl>        <span class=n>base_weight</span> <span class=o>*=</span> <span class=n>vol_adjustment</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>min</span><span class=p>(</span><span class=n>base_weight</span><span class=p>,</span> <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;position_size&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>can_add_position</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>target_weight</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    检查是否可以添加新仓位
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>current_positions</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>current_weight</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 检查持仓数量限制</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>current_positions</span> <span class=o>&gt;=</span> <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;max_positions&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 检查总仓位限制</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>current_weight</span> <span class=o>+</span> <span class=n>target_weight</span> <span class=o>&gt;</span> <span class=mf>0.95</span><span class=p>:</span>  <span class=c1># 保留5%现金</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>adjust_existing_positions</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    调整现有仓位
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>current_positions</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span><span class=p>,</span> <span class=n>current_weight</span> <span class=ow>in</span> <span class=n>current_positions</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=c1># 重新计算目标仓位</span>
</span></span><span class=line><span class=cl>        <span class=n>target_weight</span> <span class=o>=</span> <span class=n>calculate_target_weight</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>stock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 如果仓位变化超过阈值，进行调整</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=n>target_weight</span> <span class=o>-</span> <span class=n>current_weight</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mf>0.01</span><span class=p>:</span>  <span class=c1># 1%的阈值</span>
</span></span><span class=line><span class=cl>            <span class=n>order_target_percent</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=n>target_weight</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>]</span> <span class=o>=</span> <span class=n>target_weight</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;调整 </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2> 仓位: </span><span class=si>{</span><span class=n>current_weight</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2> -&gt; </span><span class=si>{</span><span class=n>target_weight</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_emergency_signals</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    处理紧急信号
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 检查市场异常</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>detect_market_anomaly</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;检测到市场异常，启动应急模式&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>emergency_mode</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 检查个股异常</span>
</span></span><span class=line><span class=cl>    <span class=n>abnormal_stocks</span> <span class=o>=</span> <span class=n>detect_stock_anomalies</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>abnormal_stocks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;发现异常股票: </span><span class=si>{</span><span class=n>abnormal_stocks</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>handle_stock_anomalies</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>abnormal_stocks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>detect_market_anomaly</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    检测市场异常
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 检查市场指数是否异常波动</span>
</span></span><span class=line><span class=cl>    <span class=n>market_index</span> <span class=o>=</span> <span class=s1>&#39;000300.SH&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>market_index</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>current_price</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>market_index</span><span class=p>]</span><span class=o>.</span><span class=n>close</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 获取历史数据计算基准</span>
</span></span><span class=line><span class=cl>        <span class=n>hist_data</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=n>market_index</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>],</span> <span class=mi>20</span><span class=p>,</span> <span class=s1>&#39;1d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>mean_price</span> <span class=o>=</span> <span class=n>hist_data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>std_price</span> <span class=o>=</span> <span class=n>hist_data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 检查是否超出3个标准差</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=n>current_price</span> <span class=o>-</span> <span class=n>mean_price</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>3</span> <span class=o>*</span> <span class=n>std_price</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>emergency_mode</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    应急模式：清仓或降低仓位
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;进入应急模式...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 降低所有仓位到原来的一半</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span><span class=p>,</span> <span class=n>weight</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>new_weight</span> <span class=o>=</span> <span class=n>weight</span> <span class=o>*</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>        <span class=n>order_target_percent</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=n>new_weight</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_weight</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;emergency_mode&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>detect_stock_anomalies</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    检测个股异常
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>abnormal_stocks</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>current_price</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span><span class=o>.</span><span class=n>close</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 检查价格是否异常（如涨跌停）</span>
</span></span><span class=line><span class=cl>            <span class=n>hist_data</span> <span class=o>=</span> <span class=n>history</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>],</span> <span class=mi>20</span><span class=p>,</span> <span class=s1>&#39;1d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>hist_data</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>last_close</span> <span class=o>=</span> <span class=n>hist_data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>daily_return</span> <span class=o>=</span> <span class=p>(</span><span class=n>current_price</span> <span class=o>-</span> <span class=n>last_close</span><span class=p>)</span> <span class=o>/</span> <span class=n>last_close</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 检查是否涨跌停</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=n>daily_return</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mf>0.095</span><span class=p>:</span>  <span class=c1># 接近涨跌停</span>
</span></span><span class=line><span class=cl>                    <span class=n>abnormal_stocks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>stock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>abnormal_stocks</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_stock_anomalies</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>abnormal_stocks</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    处理个股异常
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>abnormal_stocks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 对异常股票进行特殊处理</span>
</span></span><span class=line><span class=cl>            <span class=n>current_weight</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 如果仓位较重，适当减仓</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_weight</span> <span class=o>&gt;</span> <span class=mf>0.05</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>new_weight</span> <span class=o>=</span> <span class=n>current_weight</span> <span class=o>*</span> <span class=mf>0.7</span>  <span class=c1># 减到70%</span>
</span></span><span class=line><span class=cl>                <span class=n>order_target_percent</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=n>new_weight</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_weight</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;异常股票处理: </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2> 仓位从 </span><span class=si>{</span><span class=n>current_weight</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2> 减至 </span><span class=si>{</span><span class=n>new_weight</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_strategy_status</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    更新策略状态
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 更新持仓天数</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stock</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;position_info&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;position_info&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>][</span><span class=s1>&#39;holding_days&#39;</span><span class=p>]</span> <span class=o>=</span> \
</span></span><span class=line><span class=cl>                <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;position_info&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;holding_days&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 更新策略统计</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;today_signals&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>buy_signals</span><span class=p>)</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>sell_signals</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;today_trades&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;today_trades&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>record_trade</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>stock</span><span class=p>,</span> <span class=n>action</span><span class=p>,</span> <span class=n>weight</span><span class=p>,</span> <span class=n>reason</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    记录交易
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>trade_record</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>get_datetime</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1> %H:%M:%S&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;stock&#39;</span><span class=p>:</span> <span class=n>stock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=n>action</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;weight&#39;</span><span class=p>:</span> <span class=n>weight</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;reason&#39;</span><span class=p>:</span> <span class=n>reason</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;position_info&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=p>{})</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;current_price&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;order_history&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>trade_record</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;today_trades&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;today_trades&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;交易记录: </span><span class=si>{</span><span class=n>action</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>weight</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2> (原因: </span><span class=si>{</span><span class=n>reason</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=收盘后处理每日总结与准备>收盘后处理：每日总结与准备</h3><p>收盘后处理是策略每日运行的收尾阶段，负责总结当日表现和准备次日交易。</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span><span class=lnt>353
</span><span class=lnt>354
</span><span class=lnt>355
</span><span class=lnt>356
</span><span class=lnt>357
</span><span class=lnt>358
</span><span class=lnt>359
</span><span class=lnt>360
</span><span class=lnt>361
</span><span class=lnt>362
</span><span class=lnt>363
</span><span class=lnt>364
</span><span class=lnt>365
</span><span class=lnt>366
</span><span class=lnt>367
</span><span class=lnt>368
</span><span class=lnt>369
</span><span class=lnt>370
</span><span class=lnt>371
</span><span class=lnt>372
</span><span class=lnt>373
</span><span class=lnt>374
</span><span class=lnt>375
</span><span class=lnt>376
</span><span class=lnt>377
</span><span class=lnt>378
</span><span class=lnt>379
</span><span class=lnt>380
</span><span class=lnt>381
</span><span class=lnt>382
</span><span class=lnt>383
</span><span class=lnt>384
</span><span class=lnt>385
</span><span class=lnt>386
</span><span class=lnt>387
</span><span class=lnt>388
</span><span class=lnt>389
</span><span class=lnt>390
</span><span class=lnt>391
</span><span class=lnt>392
</span><span class=lnt>393
</span><span class=lnt>394
</span><span class=lnt>395
</span><span class=lnt>396
</span><span class=lnt>397
</span><span class=lnt>398
</span><span class=lnt>399
</span><span class=lnt>400
</span><span class=lnt>401
</span><span class=lnt>402
</span><span class=lnt>403
</span><span class=lnt>404
</span><span class=lnt>405
</span><span class=lnt>406
</span><span class=lnt>407
</span><span class=lnt>408
</span><span class=lnt>409
</span><span class=lnt>410
</span><span class=lnt>411
</span><span class=lnt>412
</span><span class=lnt>413
</span><span class=lnt>414
</span><span class=lnt>415
</span><span class=lnt>416
</span><span class=lnt>417
</span><span class=lnt>418
</span><span class=lnt>419
</span><span class=lnt>420
</span><span class=lnt>421
</span><span class=lnt>422
</span><span class=lnt>423
</span><span class=lnt>424
</span><span class=lnt>425
</span><span class=lnt>426
</span><span class=lnt>427
</span><span class=lnt>428
</span><span class=lnt>429
</span><span class=lnt>430
</span><span class=lnt>431
</span><span class=lnt>432
</span><span class=lnt>433
</span><span class=lnt>434
</span><span class=lnt>435
</span><span class=lnt>436
</span><span class=lnt>437
</span><span class=lnt>438
</span><span class=lnt>439
</span><span class=lnt>440
</span><span class=lnt>441
</span><span class=lnt>442
</span><span class=lnt>443
</span><span class=lnt>444
</span><span class=lnt>445
</span><span class=lnt>446
</span><span class=lnt>447
</span><span class=lnt>448
</span><span class=lnt>449
</span><span class=lnt>450
</span><span class=lnt>451
</span><span class=lnt>452
</span><span class=lnt>453
</span><span class=lnt>454
</span><span class=lnt>455
</span><span class=lnt>456
</span><span class=lnt>457
</span><span class=lnt>458
</span><span class=lnt>459
</span><span class=lnt>460
</span><span class=lnt>461
</span><span class=lnt>462
</span><span class=lnt>463
</span><span class=lnt>464
</span><span class=lnt>465
</span><span class=lnt>466
</span><span class=lnt>467
</span><span class=lnt>468
</span><span class=lnt>469
</span><span class=lnt>470
</span><span class=lnt>471
</span><span class=lnt>472
</span><span class=lnt>473
</span><span class=lnt>474
</span><span class=lnt>475
</span><span class=lnt>476
</span><span class=lnt>477
</span><span class=lnt>478
</span><span class=lnt>479
</span><span class=lnt>480
</span><span class=lnt>481
</span><span class=lnt>482
</span><span class=lnt>483
</span><span class=lnt>484
</span><span class=lnt>485
</span><span class=lnt>486
</span><span class=lnt>487
</span><span class=lnt>488
</span><span class=lnt>489
</span><span class=lnt>490
</span><span class=lnt>491
</span><span class=lnt>492
</span><span class=lnt>493
</span><span class=lnt>494
</span><span class=lnt>495
</span><span class=lnt>496
</span><span class=lnt>497
</span><span class=lnt>498
</span><span class=lnt>499
</span><span class=lnt>500
</span><span class=lnt>501
</span><span class=lnt>502
</span><span class=lnt>503
</span><span class=lnt>504
</span><span class=lnt>505
</span><span class=lnt>506
</span><span class=lnt>507
</span><span class=lnt>508
</span><span class=lnt>509
</span><span class=lnt>510
</span><span class=lnt>511
</span><span class=lnt>512
</span><span class=lnt>513
</span><span class=lnt>514
</span><span class=lnt>515
</span><span class=lnt>516
</span><span class=lnt>517
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>after_trading_end</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    收盘后处理函数 - 每日总结与准备
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    参数:
</span></span></span><span class=line><span class=cl><span class=s2>        context: 策略上下文
</span></span></span><span class=line><span class=cl><span class=s2>        data: 市场数据
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>current_date</span> <span class=o>=</span> <span class=n>get_datetime</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 收盘后处理: </span><span class=si>{</span><span class=n>current_date</span><span class=si>}</span><span class=s2> ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 1. 计算当日盈亏</span>
</span></span><span class=line><span class=cl>    <span class=n>calculate_daily_pnl</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 2. 更新绩效指标</span>
</span></span><span class=line><span class=cl>    <span class=n>update_performance_metrics</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 3. 生成交易报告</span>
</span></span><span class=line><span class=cl>    <span class=n>generate_trade_report</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 4. 风险指标计算</span>
</span></span><span class=line><span class=cl>    <span class=n>calculate_risk_metrics</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 5. 策略诊断</span>
</span></span><span class=line><span class=cl>    <span class=n>strategy_diagnostics</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 6. 清理临时数据</span>
</span></span><span class=line><span class=cl>    <span class=n>cleanup_temp_data</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 7. 准备次日数据</span>
</span></span><span class=line><span class=cl>    <span class=n>prepare_next_day</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 收盘后处理完成 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_daily_pnl</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算当日盈亏
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;正在计算当日盈亏...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取前一交易日收盘价</span>
</span></span><span class=line><span class=cl>    <span class=n>previous_date</span> <span class=o>=</span> <span class=n>get_previous_trading_date</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算持仓盈亏</span>
</span></span><span class=line><span class=cl>    <span class=n>total_pnl</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>position_pnl</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span><span class=p>,</span> <span class=n>weight</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 获取当前价格</span>
</span></span><span class=line><span class=cl>            <span class=n>current_data</span> <span class=o>=</span> <span class=n>get_price</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=n>count</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>end_date</span><span class=o>=</span><span class=n>get_datetime</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>current_data</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>current_price</span> <span class=o>=</span> <span class=n>current_data</span><span class=p>[</span><span class=s1>&#39;close&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 获取买入价格</span>
</span></span><span class=line><span class=cl>                <span class=n>entry_price</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;position_info&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;entry_price&#39;</span><span class=p>,</span> <span class=n>current_price</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 计算收益率</span>
</span></span><span class=line><span class=cl>                <span class=n>stock_return</span> <span class=o>=</span> <span class=p>(</span><span class=n>current_price</span> <span class=o>-</span> <span class=n>entry_price</span><span class=p>)</span> <span class=o>/</span> <span class=n>entry_price</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 计算盈亏金额（假设总资金为100万）</span>
</span></span><span class=line><span class=cl>                <span class=n>pnl_amount</span> <span class=o>=</span> <span class=n>weight</span> <span class=o>*</span> <span class=mi>1000000</span> <span class=o>*</span> <span class=n>stock_return</span>
</span></span><span class=line><span class=cl>                <span class=n>total_pnl</span> <span class=o>+=</span> <span class=n>pnl_amount</span>
</span></span><span class=line><span class=cl>                <span class=n>position_pnl</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;return&#39;</span><span class=p>:</span> <span class=n>stock_return</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;amount&#39;</span><span class=p>:</span> <span class=n>pnl_amount</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;weight&#39;</span><span class=p>:</span> <span class=n>weight</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;计算 </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2> 盈亏时出错: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 存储结果</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;daily_pnl&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;total_pnl&#39;</span><span class=p>:</span> <span class=n>total_pnl</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;position_pnl&#39;</span><span class=p>:</span> <span class=n>position_pnl</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>get_datetime</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1>&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;total_weight&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;当日总盈亏: ¥</span><span class=si>{</span><span class=n>total_pnl</span><span class=si>:</span><span class=s2>,.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>total_pnl</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;当日收益率: </span><span class=si>{</span><span class=n>total_pnl</span><span class=o>/</span><span class=mi>1000000</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_performance_metrics</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    更新绩效指标
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;正在更新绩效指标...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取历史绩效数据</span>
</span></span><span class=line><span class=cl>    <span class=n>pnl_history</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;pnl_history&#39;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>    <span class=n>pnl_history</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;daily_pnl&#39;</span><span class=p>][</span><span class=s1>&#39;total_pnl&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 保留最近一年的数据</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>pnl_history</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>252</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>pnl_history</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;pnl_history&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pnl_history</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算关键指标</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>pnl_history</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>20</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 总收益率</span>
</span></span><span class=line><span class=cl>        <span class=n>total_return</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>pnl_history</span><span class=p>)</span> <span class=o>/</span> <span class=mi>1000000</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 日收益率序列</span>
</span></span><span class=line><span class=cl>        <span class=n>daily_returns</span> <span class=o>=</span> <span class=p>[</span><span class=n>pnl</span> <span class=o>/</span> <span class=mi>1000000</span> <span class=k>for</span> <span class=n>pnl</span> <span class=ow>in</span> <span class=n>pnl_history</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 年化收益率</span>
</span></span><span class=line><span class=cl>        <span class=n>annual_return</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>daily_returns</span><span class=p>)</span> <span class=o>*</span> <span class=mi>252</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 年化波动率</span>
</span></span><span class=line><span class=cl>        <span class=n>annual_volatility</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>daily_returns</span><span class=p>)</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 夏普比率（假设无风险利率3%）</span>
</span></span><span class=line><span class=cl>        <span class=n>risk_free_rate</span> <span class=o>=</span> <span class=mf>0.03</span>
</span></span><span class=line><span class=cl>        <span class=n>sharpe_ratio</span> <span class=o>=</span> <span class=p>(</span><span class=n>annual_return</span> <span class=o>-</span> <span class=n>risk_free_rate</span><span class=p>)</span> <span class=o>/</span> <span class=n>annual_volatility</span> <span class=k>if</span> <span class=n>annual_volatility</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 最大回撤</span>
</span></span><span class=line><span class=cl>        <span class=n>cumulative_returns</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>cumsum</span><span class=p>(</span><span class=n>daily_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>running_max</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>maximum</span><span class=o>.</span><span class=n>accumulate</span><span class=p>(</span><span class=n>cumulative_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>drawdown</span> <span class=o>=</span> <span class=n>cumulative_returns</span> <span class=o>-</span> <span class=n>running_max</span>
</span></span><span class=line><span class=cl>        <span class=n>max_drawdown</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>min</span><span class=p>(</span><span class=n>drawdown</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 胜率</span>
</span></span><span class=line><span class=cl>        <span class=n>winning_days</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=mi>1</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>daily_returns</span> <span class=k>if</span> <span class=n>r</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>win_rate</span> <span class=o>=</span> <span class=n>winning_days</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>daily_returns</span><span class=p>)</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>daily_returns</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 更新绩效指标</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;performance_metrics&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_return&#39;</span><span class=p>:</span> <span class=n>total_return</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;annual_return&#39;</span><span class=p>:</span> <span class=n>annual_return</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;annual_volatility&#39;</span><span class=p>:</span> <span class=n>annual_volatility</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>:</span> <span class=n>sharpe_ratio</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max_drawdown&#39;</span><span class=p>:</span> <span class=n>max_drawdown</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;win_rate&#39;</span><span class=p>:</span> <span class=n>win_rate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;current_streak&#39;</span><span class=p>:</span> <span class=n>calculate_streak</span><span class=p>(</span><span class=n>daily_returns</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;calmar_ratio&#39;</span><span class=p>:</span> <span class=n>annual_return</span> <span class=o>/</span> <span class=nb>abs</span><span class=p>(</span><span class=n>max_drawdown</span><span class=p>)</span> <span class=k>if</span> <span class=n>max_drawdown</span> <span class=o>!=</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;年化收益率: </span><span class=si>{</span><span class=n>annual_return</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;年化波动率: </span><span class=si>{</span><span class=n>annual_volatility</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;夏普比率: </span><span class=si>{</span><span class=n>sharpe_ratio</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最大回撤: </span><span class=si>{</span><span class=n>max_drawdown</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;胜率: </span><span class=si>{</span><span class=n>win_rate</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_streak</span><span class=p>(</span><span class=n>returns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算连胜/连败记录
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>returns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;win_streak&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;loss_streak&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;current_streak&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>current_streak</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>win_streak</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>loss_streak</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 从最近开始计算</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=n>returns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>r</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_streak</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>current_streak</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>r</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_streak</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>current_streak</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 计算历史最大连胜和连败</span>
</span></span><span class=line><span class=cl>    <span class=n>temp_streak</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>returns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>r</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>temp_streak</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>temp_streak</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>win_streak</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>win_streak</span><span class=p>,</span> <span class=n>temp_streak</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>r</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>temp_streak</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>temp_streak</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>loss_streak</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>loss_streak</span><span class=p>,</span> <span class=nb>abs</span><span class=p>(</span><span class=n>temp_streak</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>temp_streak</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;win_streak&#39;</span><span class=p>:</span> <span class=n>win_streak</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;loss_streak&#39;</span><span class=p>:</span> <span class=n>loss_streak</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;current_streak&#39;</span><span class=p>:</span> <span class=n>current_streak</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_trade_report</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    生成交易报告
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;正在生成交易报告...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取当日交易记录</span>
</span></span><span class=line><span class=cl>    <span class=n>today_trades</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>trade</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;order_history&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>trade</span><span class=p>[</span><span class=s1>&#39;date&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>get_datetime</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1>&#39;</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>today_trades</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>trade</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>today_trades</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>当日交易报告 (</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>today_trades</span><span class=p>)</span><span class=si>}</span><span class=s2>笔交易):&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>buy_trades</span> <span class=o>=</span> <span class=p>[</span><span class=n>t</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>today_trades</span> <span class=k>if</span> <span class=n>t</span><span class=p>[</span><span class=s1>&#39;action&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;buy&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>sell_trades</span> <span class=o>=</span> <span class=p>[</span><span class=n>t</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>today_trades</span> <span class=k>if</span> <span class=n>t</span><span class=p>[</span><span class=s1>&#39;action&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;sell&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;买入交易: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>buy_trades</span><span class=p>)</span><span class=si>}</span><span class=s2>笔&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>trade</span> <span class=ow>in</span> <span class=n>buy_trades</span><span class=p>[:</span><span class=mi>5</span><span class=p>]:</span>  <span class=c1># 显示前5笔</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>trade</span><span class=p>[</span><span class=s1>&#39;stock&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>trade</span><span class=p>[</span><span class=s1>&#39;weight&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2> (价格: ¥</span><span class=si>{</span><span class=n>trade</span><span class=p>[</span><span class=s1>&#39;price&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;卖出交易: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>sell_trades</span><span class=p>)</span><span class=si>}</span><span class=s2>笔&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>trade</span> <span class=ow>in</span> <span class=n>sell_trades</span><span class=p>[:</span><span class=mi>5</span><span class=p>]:</span>  <span class=c1># 显示前5笔</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>trade</span><span class=p>[</span><span class=s1>&#39;stock&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>trade</span><span class=p>[</span><span class=s1>&#39;weight&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2> (价格: ¥</span><span class=si>{</span><span class=n>trade</span><span class=p>[</span><span class=s1>&#39;price&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算换手率</span>
</span></span><span class=line><span class=cl>        <span class=n>total_turnover</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>trade</span><span class=p>[</span><span class=s1>&#39;weight&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>trade</span> <span class=ow>in</span> <span class=n>today_trades</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;当日换手率: </span><span class=si>{</span><span class=n>total_turnover</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;当日无交易&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_risk_metrics</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    计算风险指标
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;正在计算风险指标...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 获取历史收益率数据</span>
</span></span><span class=line><span class=cl>    <span class=n>pnl_history</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;pnl_history&#39;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>pnl_history</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>20</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>daily_returns</span> <span class=o>=</span> <span class=p>[</span><span class=n>pnl</span> <span class=o>/</span> <span class=mi>1000000</span> <span class=k>for</span> <span class=n>pnl</span> <span class=ow>in</span> <span class=n>pnl_history</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># VaR (Value at Risk) - 95%置信度</span>
</span></span><span class=line><span class=cl>        <span class=n>var_95</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>daily_returns</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># CVaR (Conditional Value at Risk)</span>
</span></span><span class=line><span class=cl>        <span class=n>cvar_95</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>([</span><span class=n>r</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>daily_returns</span> <span class=k>if</span> <span class=n>r</span> <span class=o>&lt;=</span> <span class=n>var_95</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 下行波动率</span>
</span></span><span class=line><span class=cl>        <span class=n>downside_returns</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>daily_returns</span> <span class=k>if</span> <span class=n>r</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>downside_volatility</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>downside_returns</span><span class=p>)</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>)</span> <span class=k>if</span> <span class=n>downside_returns</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 索提诺比率</span>
</span></span><span class=line><span class=cl>        <span class=n>annual_return</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>daily_returns</span><span class=p>)</span> <span class=o>*</span> <span class=mi>252</span>
</span></span><span class=line><span class=cl>        <span class=n>risk_free_rate</span> <span class=o>=</span> <span class=mf>0.03</span>
</span></span><span class=line><span class=cl>        <span class=n>sortino_ratio</span> <span class=o>=</span> <span class=p>(</span><span class=n>annual_return</span> <span class=o>-</span> <span class=n>risk_free_rate</span><span class=p>)</span> <span class=o>/</span> <span class=n>downside_volatility</span> <span class=k>if</span> <span class=n>downside_volatility</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 更新风险指标</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;risk_metrics&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;var_95&#39;</span><span class=p>:</span> <span class=n>var_95</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;cvar_95&#39;</span><span class=p>:</span> <span class=n>cvar_95</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;downside_volatility&#39;</span><span class=p>:</span> <span class=n>downside_volatility</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sortino_ratio&#39;</span><span class=p>:</span> <span class=n>sortino_ratio</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;current_risk_level&#39;</span><span class=p>:</span> <span class=n>assess_current_risk_level</span><span class=p>(</span><span class=n>daily_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;VaR (95%): </span><span class=si>{</span><span class=n>var_95</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;CVaR (95%): </span><span class=si>{</span><span class=n>cvar_95</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;下行波动率: </span><span class=si>{</span><span class=n>downside_volatility</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;索提诺比率: </span><span class=si>{</span><span class=n>sortino_ratio</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>assess_current_risk_level</span><span class=p>(</span><span class=n>daily_returns</span><span class=p>,</span> <span class=n>window</span><span class=o>=</span><span class=mi>20</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    评估当前风险水平
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>daily_returns</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>window</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;low&#39;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>recent_returns</span> <span class=o>=</span> <span class=n>daily_returns</span><span class=p>[</span><span class=o>-</span><span class=n>window</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    <span class=n>recent_volatility</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>recent_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>recent_var</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>recent_returns</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 根据近期表现评估风险水平</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>recent_volatility</span> <span class=o>&gt;</span> <span class=mf>0.05</span> <span class=ow>or</span> <span class=n>recent_var</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mf>0.03</span><span class=p>:</span>  <span class=c1># 高波动或大跌风险</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;high&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>recent_volatility</span> <span class=o>&gt;</span> <span class=mf>0.03</span> <span class=ow>or</span> <span class=n>recent_var</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mf>0.02</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;medium&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;low&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>strategy_diagnostics</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    策略诊断
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;正在执行策略诊断...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>diagnostics</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 1. 持仓集中度检查</span>
</span></span><span class=line><span class=cl>    <span class=n>current_positions</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>current_positions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>weights</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>current_positions</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>max_weight</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>weights</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>avg_weight</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>weights</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>concentration_ratio</span> <span class=o>=</span> <span class=n>max_weight</span> <span class=o>/</span> <span class=n>avg_weight</span> <span class=k>if</span> <span class=n>avg_weight</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>diagnostics</span><span class=p>[</span><span class=s1>&#39;concentration&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max_weight&#39;</span><span class=p>:</span> <span class=n>max_weight</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;avg_weight&#39;</span><span class=p>:</span> <span class=n>avg_weight</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;concentration_ratio&#39;</span><span class=p>:</span> <span class=n>concentration_ratio</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;ok&#39;</span> <span class=k>if</span> <span class=n>concentration_ratio</span> <span class=o>&lt;</span> <span class=mf>3.0</span> <span class=k>else</span> <span class=s1>&#39;warning&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 2. 因子有效性检查</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=s1>&#39;factor_scores&#39;</span><span class=p>)</span> <span class=ow>and</span> <span class=n>context</span><span class=o>.</span><span class=n>factor_scores</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>factor_performance</span> <span class=o>=</span> <span class=n>analyze_factor_performance</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>diagnostics</span><span class=p>[</span><span class=s1>&#39;factor_performance&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>factor_performance</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 3. 交易成本分析</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;order_history&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>trading_costs</span> <span class=o>=</span> <span class=n>analyze_trading_costs</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>diagnostics</span><span class=p>[</span><span class=s1>&#39;trading_costs&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>trading_costs</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 4. 策略稳定性检查</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;pnl_history&#39;</span><span class=p>,</span> <span class=p>[]))</span> <span class=o>&gt;=</span> <span class=mi>60</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>stability_metrics</span> <span class=o>=</span> <span class=n>check_strategy_stability</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>diagnostics</span><span class=p>[</span><span class=s1>&#39;stability&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>stability_metrics</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 存储诊断结果</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;last_diagnostics&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>diagnostics</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 显示诊断结果</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>策略诊断结果:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>category</span><span class=p>,</span> <span class=n>metrics</span> <span class=ow>in</span> <span class=n>diagnostics</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=n>category</span><span class=si>}</span><span class=s2>:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>metrics</span><span class=p>,</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>metrics</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=p>(</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>value</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>value</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>metrics</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>analyze_factor_performance</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    分析因子表现
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 简化实现：检查因子得分的分布</span>
</span></span><span class=line><span class=cl>    <span class=n>all_scores</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span><span class=p>,</span> <span class=n>scores</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>factor_scores</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;total_score&#39;</span> <span class=ow>in</span> <span class=n>scores</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>all_scores</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>scores</span><span class=p>[</span><span class=s1>&#39;total_score&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>all_scores</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;mean_score&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>all_scores</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;std_score&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>all_scores</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;score_range&#39;</span><span class=p>:</span> <span class=p>(</span><span class=nb>min</span><span class=p>(</span><span class=n>all_scores</span><span class=p>),</span> <span class=nb>max</span><span class=p>(</span><span class=n>all_scores</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;effective_factor_ratio&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=mi>1</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>all_scores</span> <span class=k>if</span> <span class=n>s</span> <span class=o>&gt;</span> <span class=mf>0.6</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>all_scores</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;insufficient_data&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>analyze_trading_costs</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    分析交易成本
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>recent_trades</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;order_history&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>20</span><span class=p>:]</span>  <span class=c1># 最近20笔交易</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>recent_trades</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>total_turnover</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>trade</span><span class=p>[</span><span class=s1>&#39;weight&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>trade</span> <span class=ow>in</span> <span class=n>recent_trades</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>avg_trade_size</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>([</span><span class=n>trade</span><span class=p>[</span><span class=s1>&#39;weight&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>trade</span> <span class=ow>in</span> <span class=n>recent_trades</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_turnover_20d&#39;</span><span class=p>:</span> <span class=n>total_turnover</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;avg_trade_size&#39;</span><span class=p>:</span> <span class=n>avg_trade_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;trade_frequency&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent_trades</span><span class=p>)</span> <span class=o>/</span> <span class=mi>20</span>  <span class=c1># 每日交易频率</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;no_recent_trades&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_strategy_stability</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    检查策略稳定性
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>pnl_history</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;pnl_history&#39;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>pnl_history</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>60</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 计算滚动夏普比率</span>
</span></span><span class=line><span class=cl>        <span class=n>rolling_sharpe</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>30</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>pnl_history</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>recent_returns</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span> <span class=o>/</span> <span class=mi>1000000</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>pnl_history</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>30</span><span class=p>:</span><span class=n>i</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent_returns</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>recent_returns</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>sharpe</span> <span class=o>=</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>recent_returns</span><span class=p>)</span> <span class=o>*</span> <span class=mi>252</span> <span class=o>-</span> <span class=mf>0.03</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>recent_returns</span><span class=p>)</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>252</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>rolling_sharpe</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sharpe</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>rolling_sharpe</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sharpe_std</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>rolling_sharpe</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>sharpe_trend</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>polyfit</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rolling_sharpe</span><span class=p>)),</span> <span class=n>rolling_sharpe</span><span class=p>,</span> <span class=mi>1</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;sharpe_stability&#39;</span><span class=p>:</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>sharpe_std</span><span class=p>)</span> <span class=k>if</span> <span class=n>sharpe_std</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;sharpe_trend&#39;</span><span class=p>:</span> <span class=n>sharpe_trend</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;stability_status&#39;</span><span class=p>:</span> <span class=s1>&#39;stable&#39;</span> <span class=k>if</span> <span class=n>sharpe_std</span> <span class=o>&lt;</span> <span class=mf>0.5</span> <span class=k>else</span> <span class=s1>&#39;unstable&#39;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;insufficient_data&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>cleanup_temp_data</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    清理临时数据
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 清理当日交易信号</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=s1>&#39;buy_signals&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=n>buy_signals</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=s1>&#39;sell_signals&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=n>sell_signals</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 清理紧急信号</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;emergency_signals&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;take_profit_signals&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;time_stop_signals&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 清理临时缓存（保留必要的历史数据）</span>
</span></span><span class=line><span class=cl>    <span class=n>max_cache_size</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=nb>list</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>indicators</span><span class=o>.</span><span class=n>keys</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>stock</span><span class=p>])</span> <span class=o>&gt;</span> <span class=n>max_cache_size</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 只保留最近的数据</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>indicators</span><span class=p>[</span><span class=n>stock</span><span class=p>][</span><span class=o>-</span><span class=n>max_cache_size</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;临时数据清理完成&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>prepare_next_day</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    准备次日交易
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;正在准备次日交易...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 1. 预计算次日可能需要的数据</span>
</span></span><span class=line><span class=cl>    <span class=c1># 获取明日预告的重要事件</span>
</span></span><span class=line><span class=cl>    <span class=n>tomorrow_events</span> <span class=o>=</span> <span class=n>get_tomorrow_events</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>tomorrow_events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;明日重要事件: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>tomorrow_events</span><span class=p>)</span><span class=si>}</span><span class=s2>个&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>tomorrow_events</span><span class=p>[:</span><span class=mi>3</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  - </span><span class=si>{</span><span class=n>event</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 2. 检查持仓股票是否有重要公告</span>
</span></span><span class=line><span class=cl>    <span class=n>check_announcements_for_positions</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 3. 更新策略参数（动态调整）</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;total_days&#39;</span><span class=p>]</span> <span class=o>%</span> <span class=mi>20</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>  <span class=c1># 每月调整一次</span>
</span></span><span class=line><span class=cl>        <span class=n>adapt_strategy_parameters</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;次日准备完成&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_tomorrow_events</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取明日事件
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 简化实现</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_announcements_for_positions</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    检查持仓股票公告
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>current_positions</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>current_positions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 获取持仓股票的最新公告</span>
</span></span><span class=line><span class=cl>        <span class=n>announcements</span> <span class=o>=</span> <span class=n>get_announcements</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>current_positions</span><span class=o>.</span><span class=n>keys</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>announcements</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;发现</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>announcements</span><span class=p>)</span><span class=si>}</span><span class=s2>条持仓股票公告&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>announcement</span> <span class=ow>in</span> <span class=n>announcements</span><span class=p>[:</span><span class=mi>3</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  - </span><span class=si>{</span><span class=n>announcement</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>adapt_strategy_parameters</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    自适应调整策略参数
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;正在自适应调整策略参数...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 根据近期表现调整参数</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;pnl_history&#39;</span><span class=p>,</span> <span class=p>[]))</span> <span class=o>&gt;=</span> <span class=mi>60</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>recent_pnl</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;pnl_history&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>20</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>        <span class=n>recent_return</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>recent_pnl</span><span class=p>)</span> <span class=o>/</span> <span class=mi>1000000</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 如果近期表现不佳，降低仓位</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>recent_return</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mf>0.02</span><span class=p>:</span>  <span class=c1># 最近亏损超过2%</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;position_size&#39;</span><span class=p>]</span> <span class=o>*=</span> <span class=mf>0.9</span>  <span class=c1># 降低10%</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;max_positions&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;max_positions&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;近期表现不佳，降低仓位和持仓数量&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 如果近期表现很好，适当增加仓位</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>recent_return</span> <span class=o>&gt;</span> <span class=mf>0.03</span><span class=p>:</span>  <span class=c1># 最近盈利超过3%</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;position_size&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=mf>0.1</span><span class=p>,</span> <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;position_size&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>1.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;近期表现良好，适当增加仓位&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 根据波动率调整止损止盈</span>
</span></span><span class=line><span class=cl>        <span class=n>daily_returns</span> <span class=o>=</span> <span class=p>[</span><span class=n>pnl</span> <span class=o>/</span> <span class=mi>1000000</span> <span class=k>for</span> <span class=n>pnl</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;pnl_history&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>60</span><span class=p>:]]</span>
</span></span><span class=line><span class=cl>        <span class=n>volatility</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>daily_returns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>volatility</span> <span class=o>&gt;</span> <span class=mf>0.02</span><span class=p>:</span>  <span class=c1># 高波动环境</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;stop_loss&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=mf>0.10</span><span class=p>,</span> <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;stop_loss&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>1.2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;take_profit&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=mf>0.15</span><span class=p>,</span> <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;take_profit&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;高波动环境，收紧止损，放宽止盈&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>volatility</span> <span class=o>&lt;</span> <span class=mf>0.01</span><span class=p>:</span>  <span class=c1># 低波动环境</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;stop_loss&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;stop_loss&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;take_profit&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=mf>0.25</span><span class=p>,</span> <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;take_profit&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>1.2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;低波动环境，放宽止损，收紧止盈&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_announcements</span><span class=p>(</span><span class=n>stock_list</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取股票公告
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 简化实现</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_previous_trading_date</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取前一交易日
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>get_datetime</span><span class=p>()</span> <span class=o>-</span> <span class=n>datetime</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=策略终止与清理优雅的生命周期结束>策略终止与清理：优雅的生命周期结束</h2><h3 id=策略终止处理>策略终止处理</h3><p>策略终止是生命周期的重要环节，需要妥善处理所有未完成的业务。</p><div class="not-prose my-8 overflow-hidden rounded-lg bg-gray-900 shadow-lg"><div class="p-4 overflow-x-auto"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>strategy_termination</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>reason</span><span class=o>=</span><span class=s1>&#39;normal&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    策略终止处理 - 优雅的生命周期结束
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    参数:
</span></span></span><span class=line><span class=cl><span class=s2>        context: 策略上下文
</span></span></span><span class=line><span class=cl><span class=s2>        reason: 终止原因
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 策略终止处理: </span><span class=si>{</span><span class=n>reason</span><span class=si>}</span><span class=s2> ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 1. 记录终止原因</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;termination_info&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>get_datetime</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1> %H:%M:%S&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;reason&#39;</span><span class=p>:</span> <span class=n>reason</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;final_positions&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;final_pnl&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;pnl_history&#39;</span><span class=p>,</span> <span class=p>[])[</span><span class=o>-</span><span class=mi>10</span><span class=p>:])</span> <span class=o>/</span> <span class=mi>1000000</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 2. 根据终止原因采取不同措施</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>reason</span> <span class=o>==</span> <span class=s1>&#39;normal&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 正常终止：逐步减仓</span>
</span></span><span class=line><span class=cl>        <span class=n>graceful_exit</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>reason</span> <span class=o>==</span> <span class=s1>&#39;emergency&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 紧急终止：快速清仓</span>
</span></span><span class=line><span class=cl>        <span class=n>emergency_exit</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>reason</span> <span class=o>==</span> <span class=s1>&#39;risk_limit&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 风险限制：立即清仓</span>
</span></span><span class=line><span class=cl>        <span class=n>immediate_exit</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 3. 生成最终报告</span>
</span></span><span class=line><span class=cl>    <span class=n>generate_final_report</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 4. 保存策略数据</span>
</span></span><span class=line><span class=cl>    <span class=n>save_strategy_data</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 5. 清理资源</span>
</span></span><span class=line><span class=cl>    <span class=n>cleanup_resources</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 策略终止处理完成 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>graceful_exit</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    优雅退出：逐步减仓
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;执行优雅退出策略...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>current_positions</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 分3天逐步减仓</span>
</span></span><span class=line><span class=cl>    <span class=n>exit_days</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=n>daily_reduction</span> <span class=o>=</span> <span class=mf>1.0</span> <span class=o>/</span> <span class=n>exit_days</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>day</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>exit_days</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>target_reduction</span> <span class=o>=</span> <span class=n>daily_reduction</span> <span class=o>*</span> <span class=p>(</span><span class=n>day</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>stock</span><span class=p>,</span> <span class=n>current_weight</span> <span class=ow>in</span> <span class=n>current_positions</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>remaining_weight</span> <span class=o>=</span> <span class=n>current_weight</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>target_reduction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 执行减仓</span>
</span></span><span class=line><span class=cl>            <span class=n>order_target_percent</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=n>remaining_weight</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>]</span> <span class=o>=</span> <span class=n>remaining_weight</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;第</span><span class=si>{</span><span class=n>day</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>天: </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2> 减仓至 </span><span class=si>{</span><span class=n>remaining_weight</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 最终清仓</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=nb>list</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>keys</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>        <span class=n>order_target_percent</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>del</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最终清仓: </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>emergency_exit</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    紧急退出：快速清仓
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;执行紧急退出策略...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 在当天收盘前清仓50%</span>
</span></span><span class=line><span class=cl>    <span class=n>current_positions</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span><span class=p>,</span> <span class=n>current_weight</span> <span class=ow>in</span> <span class=n>current_positions</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=c1># 立即减仓50%</span>
</span></span><span class=line><span class=cl>        <span class=n>order_target_percent</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=n>current_weight</span> <span class=o>*</span> <span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>]</span> <span class=o>=</span> <span class=n>current_weight</span> <span class=o>*</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;紧急减仓: </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2> 减至 </span><span class=si>{</span><span class=n>current_weight</span> <span class=o>*</span> <span class=mf>0.5</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 次日开盘清仓剩余部分</span>
</span></span><span class=line><span class=cl>    <span class=c1># 这里需要设置次日执行</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>immediate_exit</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    立即退出：立即清仓
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;执行立即退出策略...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 立即清仓所有持仓</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>stock</span> <span class=ow>in</span> <span class=nb>list</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>keys</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>        <span class=n>order_target_percent</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>del</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>][</span><span class=n>stock</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;立即清仓: </span><span class=si>{</span><span class=n>stock</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_final_report</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    生成最终报告
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;正在生成最终报告...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>final_report</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;strategy_info&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>strategy_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;start_date&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;first_trade_date&#39;</span><span class=p>,</span> <span class=s1>&#39;N/A&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;end_date&#39;</span><span class=p>:</span> <span class=n>get_datetime</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1>&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_days&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;total_days&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_trades&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;order_history&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;performance_summary&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_return&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;performance_metrics&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;total_return&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;annual_return&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;performance_metrics&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;annual_return&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;performance_metrics&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max_drawdown&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;performance_metrics&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;win_rate&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;performance_metrics&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;win_rate&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;risk_analysis&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;var_95&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;risk_metrics&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;var_95&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max_drawdown&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;performance_metrics&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;final_positions&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_positions&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;trading_analysis&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_turnover&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>trade</span><span class=p>[</span><span class=s1>&#39;weight&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>trade</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;order_history&#39;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;avg_trade_size&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>([</span><span class=n>trade</span><span class=p>[</span><span class=s1>&#39;weight&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>trade</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;order_history&#39;</span><span class=p>]])</span> <span class=k>if</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;order_history&#39;</span><span class=p>]</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;most_traded_stocks&#39;</span><span class=p>:</span> <span class=n>get_most_traded_stocks</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 显示最终报告</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;=&#34;</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;策略最终报告&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;策略名称: </span><span class=si>{</span><span class=n>final_report</span><span class=p>[</span><span class=s1>&#39;strategy_info&#39;</span><span class=p>][</span><span class=s1>&#39;name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;运行期间: </span><span class=si>{</span><span class=n>final_report</span><span class=p>[</span><span class=s1>&#39;strategy_info&#39;</span><span class=p>][</span><span class=s1>&#39;start_date&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> - </span><span class=si>{</span><span class=n>final_report</span><span class=p>[</span><span class=s1>&#39;strategy_info&#39;</span><span class=p>][</span><span class=s1>&#39;end_date&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;运行天数: </span><span class=si>{</span><span class=n>final_report</span><span class=p>[</span><span class=s1>&#39;strategy_info&#39;</span><span class=p>][</span><span class=s1>&#39;total_days&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;总交易数: </span><span class=si>{</span><span class=n>final_report</span><span class=p>[</span><span class=s1>&#39;strategy_info&#39;</span><span class=p>][</span><span class=s1>&#39;total_trades&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>绩效指标:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;总收益率: </span><span class=si>{</span><span class=n>final_report</span><span class=p>[</span><span class=s1>&#39;performance_summary&#39;</span><span class=p>][</span><span class=s1>&#39;total_return&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;年化收益率: </span><span class=si>{</span><span class=n>final_report</span><span class=p>[</span><span class=s1>&#39;performance_summary&#39;</span><span class=p>][</span><span class=s1>&#39;annual_return&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;夏普比率: </span><span class=si>{</span><span class=n>final_report</span><span class=p>[</span><span class=s1>&#39;performance_summary&#39;</span><span class=p>][</span><span class=s1>&#39;sharpe_ratio&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最大回撤: </span><span class=si>{</span><span class=n>final_report</span><span class=p>[</span><span class=s1>&#39;performance_summary&#39;</span><span class=p>][</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;胜率: </span><span class=si>{</span><span class=n>final_report</span><span class=p>[</span><span class=s1>&#39;performance_summary&#39;</span><span class=p>][</span><span class=s1>&#39;win_rate&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>风险指标:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;VaR (95%): </span><span class=si>{</span><span class=n>final_report</span><span class=p>[</span><span class=s1>&#39;risk_analysis&#39;</span><span class=p>][</span><span class=s1>&#39;var_95&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最大回撤: </span><span class=si>{</span><span class=n>final_report</span><span class=p>[</span><span class=s1>&#39;risk_analysis&#39;</span><span class=p>][</span><span class=s1>&#39;max_drawdown&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最终持仓数: </span><span class=si>{</span><span class=n>final_report</span><span class=p>[</span><span class=s1>&#39;risk_analysis&#39;</span><span class=p>][</span><span class=s1>&#39;final_positions&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>交易分析:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;总换手率: </span><span class=si>{</span><span class=n>final_report</span><span class=p>[</span><span class=s1>&#39;trading_analysis&#39;</span><span class=p>][</span><span class=s1>&#39;total_turnover&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;平均交易规模: </span><span class=si>{</span><span class=n>final_report</span><span class=p>[</span><span class=s1>&#39;trading_analysis&#39;</span><span class=p>][</span><span class=s1>&#39;avg_trade_size&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=o>.</span><span class=n>final_report</span> <span class=o>=</span> <span class=n>final_report</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_most_traded_stocks</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>top_n</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取交易最频繁的股票
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>trade_counts</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>trade</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;order_history&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>stock</span> <span class=o>=</span> <span class=n>trade</span><span class=p>[</span><span class=s1>&#39;stock&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>trade_counts</span><span class=p>[</span><span class=n>stock</span><span class=p>]</span> <span class=o>=</span> <span class=n>trade_counts</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>stock</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>trade_counts</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)[:</span><span class=n>top_n</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>save_strategy_data</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    保存策略数据
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;正在保存策略数据...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 准备保存的数据</span>
</span></span><span class=line><span class=cl>    <span class=n>save_data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;strategy_info&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>strategy_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;version&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;parameters&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>params</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;factors&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>factors</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;performance_data&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;pnl_history&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;pnl_history&#39;</span><span class=p>,</span> <span class=p>[]),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;order_history&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;order_history&#39;</span><span class=p>,</span> <span class=p>[]),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;performance_metrics&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;performance_metrics&#39;</span><span class=p>,</span> <span class=p>{}),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;risk_metrics&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;risk_metrics&#39;</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;termination_info&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;termination_info&#39;</span><span class=p>,</span> <span class=p>{}),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;final_report&#39;</span><span class=p>:</span> <span class=n>context</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;final_report&#39;</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 保存到文件（简化实现）</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>    <span class=n>filename</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;strategy_data_</span><span class=si>{</span><span class=n>context</span><span class=o>.</span><span class=n>strategy_name</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=n>get_datetime</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y%m</span><span class=si>%d</span><span class=s1>_%H%M%S&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>.json&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 这里应该保存到实际文件系统</span>
</span></span><span class=line><span class=cl>        <span class=c1># with open(filename, &#39;w&#39;) as f:</span>
</span></span><span class=line><span class=cl>        <span class=c1>#     json.dump(save_data, f, indent=2, default=str)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;策略数据已保存（模拟）&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;保存的数据包含 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>save_data</span><span class=p>)</span><span class=si>}</span><span class=s2> 个主要部分&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;保存策略数据时出错: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>cleanup_resources</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    清理资源
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;正在清理资源...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 清理大对象</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=s1>&#39;indicators&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=n>indicators</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=s1>&#39;factor_scores&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>.</span><span class=n>factor_scores</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 清理临时缓存</span>
</span></span><span class=line><span class=cl>    <span class=n>temp_keys</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;buy_signals&#39;</span><span class=p>,</span> <span class=s1>&#39;sell_signals&#39;</span><span class=p>,</span> <span class=s1>&#39;emergency_signals&#39;</span><span class=p>,</span> <span class=s1>&#39;take_profit_signals&#39;</span><span class=p>,</span> <span class=s1>&#39;time_stop_signals&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>temp_keys</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>setattr</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 清理内存中的大数据</span>
</span></span><span class=line><span class=cl>    <span class=n>large_keys</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;pnl_history&#39;</span><span class=p>,</span> <span class=s1>&#39;order_history&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>large_keys</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=n>key</span><span class=p>])</span> <span class=o>&gt;</span> <span class=mi>1000</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 只保留最近的数据</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=n>key</span><span class=p>][</span><span class=o>-</span><span class=mi>1000</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;资源清理完成&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 完整的策略生命周期示例</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>complete_strategy_lifecycle</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    完整的策略生命周期示例
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 策略生命周期完整示例 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 1. 初始化阶段</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>1. 初始化阶段&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span> <span class=o>=</span> <span class=n>initialize</span><span class=p>(</span><span class=n>Context</span><span class=p>())</span>  <span class=c1># 假设Context()是平台提供的</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 2. 模拟多日运行</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>2. 模拟多日运行&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>day</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>--- 第</span><span class=si>{</span><span class=n>day</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>天 ---&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 开盘前准备</span>
</span></span><span class=line><span class=cl>        <span class=n>before_trading_start</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 盘中执行（模拟）</span>
</span></span><span class=line><span class=cl>        <span class=n>handle_data</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 收盘后处理</span>
</span></span><span class=line><span class=cl>        <span class=n>after_trading_end</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 3. 策略终止</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>3. 策略终止&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>strategy_termination</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=s1>&#39;normal&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 策略生命周期示例完成 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 策略框架最佳实践</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>StrategyBestPractices</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    策略框架最佳实践
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>robust_error_handling</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        健壮的错误处理装饰器
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;函数 </span><span class=si>{</span><span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2> 执行出错: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=c1># 记录错误日志</span>
</span></span><span class=line><span class=cl>                <span class=c1># send_alert(f&#34;策略错误: {str(e)}&#34;)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>performance_monitoring</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        性能监控装饰器
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>end_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>execution_time</span> <span class=o>=</span> <span class=n>end_time</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>execution_time</span> <span class=o>&gt;</span> <span class=mf>1.0</span><span class=p>:</span>  <span class=c1># 超过1秒警告</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;函数 </span><span class=si>{</span><span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2> 执行时间: </span><span class=si>{</span><span class=n>execution_time</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>秒&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>validate_inputs</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        输入验证装饰器
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 验证输入参数</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>arg</span> <span class=ow>in</span> <span class=n>args</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>arg</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;函数 </span><span class=si>{</span><span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2> 收到空参数&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=nd>@StrategyBestPractices.robust_error_handling</span>
</span></span><span class=line><span class=cl><span class=nd>@StrategyBestPractices.performance_monitoring</span>
</span></span><span class=line><span class=cl><span class=nd>@StrategyBestPractices.validate_inputs</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>safe_data_processing</span><span class=p>(</span><span class=n>stock_list</span><span class=p>,</span> <span class=n>start_date</span><span class=p>,</span> <span class=n>end_date</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    安全的数据处理函数示例
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 数据处理逻辑</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>process_stock_data</span><span class=p>(</span><span class=n>stock_list</span><span class=p>,</span> <span class=n>start_date</span><span class=p>,</span> <span class=n>end_date</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 运行完整示例</span>
</span></span><span class=line><span class=cl>    <span class=n>complete_strategy_lifecycle</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=总结>总结</h2><p>本讲详细介绍了SuperMind策略框架的核心概念和生命周期管理，包括：</p><ol><li><strong>策略框架核心价值</strong>：标准化结构、生命周期管理、风险控制、数据管理</li><li><strong>策略生命周期</strong>：初始化、开盘前、盘中、收盘后、终止五个阶段</li><li><strong>策略终止处理</strong>：正常终止、异常终止、紧急终止三种模式</li><li><strong>最佳实践</strong>：错误处理、性能监控、输入验证等</li></ol><p>掌握这些概念对于开发稳定、可靠的量化交易策略至关重要。在下一讲中，我们将开始学习具体的策略开发技术。</p></div></article><aside class="lg:w-80 xl:w-96"><div class=space-y-8></div></aside></div><nav class="border-t border-gray-200 mt-12 pt-8"><div class="flex justify-between items-center"><a href=/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/02-%E9%87%91%E8%9E%8D%E6%95%B0%E6%8D%AE%E8%8E%B7%E5%8F%96%E4%B8%8Eapi%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8/ class="group flex items-center"><svg class="w-5 h-5 mr-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0 7-7m-7 7h18"/></svg><div><div class="text-sm text-gray-600">上一篇</div><div class="font-medium group-hover:text-primary-600">SuperMind第2讲：金融数据获取与API基础应用</div></div></a><a href=/blog/%E5%9B%9E%E6%B5%8B%E5%B9%B3%E5%8F%B0/04-%E6%8A%80%E6%9C%AF%E6%8C%87%E6%A0%87%E7%AD%96%E7%95%A5%E5%BC%80%E5%8F%91/ class="group flex items-center text-right"><div><div class="text-sm text-gray-600">Next Post</div><div class="font-medium group-hover:text-primary-600">SuperMind第4讲：技术指标策略开发</div></div><svg class="w-5 h-5 ml-2 text-gray-600 group-hover:text-primary-600" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0-7 7m7-7H3"/></svg></a></div></nav></div></div><footer class="bg-gray-50 py-12 border-t border-gray-200"><div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"><div class="flex flex-col md:flex-row justify-between space-y-4 md:space-y-0"><div class=flex-1><div class="flex items-center space-x-3 mb-4"><a href=https://sk-quant.github.io/ class=inline-block><img src=/images/logo.svg alt=烧烤量化 class=h-6>
</a><span class="text-xl font-bold text-gray-900">烧烤量化</span></div><div class="flex space-x-3 p-2"></div></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div><div class=flex-1><h3 class="text-sm font-semibold uppercase tracking-wider text-gray-900 mb-4"></h3><ul class=space-y-2></ul></div></div><div class="mt-12 pt-8 border-t border-gray-200"><div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0"><p class="text-gray-600 text-sm">© 2025 烧烤量化. All rights reserved.</p><a href=https://chaoming.li class="text-sm text-gray-600 hover:text-primary-600" target=_blank rel="noopener noreferrer">Powered by sk-quant</a></div></div></div></footer><script>const mobileMenuButton=document.getElementById("mobile-menu-button");mobileMenuButton&&mobileMenuButton.addEventListener("click",function(){const e=document.getElementById("mobile-menu");e&&e.classList.toggle("hidden")})</script></body></html>